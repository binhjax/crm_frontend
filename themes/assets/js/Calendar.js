var CalendarCtrl=function(){return{isDashlet:false,dashletId:'',form_name:'form_calendar',currentCls:'',globalInitCalendar:function(calendarCls,async,dashletId,params){this.currentCls=calendarCls;if(!blank(dashletId)){CalendarCtrl.isDashlet=true;CalendarCtrl.dashletId=dashletId;}
if(!async&&!CalendarCtrl.isDashlet){var navTag=SUGAR.util.checkNavigationTag('Calendar');if(navTag){var params=parseQueryString(navTag);CalendarCtrl.reloadFormWithParams(params,CalendarCtrl.form_name);return;}}
var self=this;window.setTimeout(function(){self.initRefInputs();},300);if(calendarCls&&window[calendarCls])
window[calendarCls].initCalendar(params);},initRefInputs:function(){var sel_user=SUGAR.ui.getFormInput('settings_form','user_name_selected');if(sel_user){sel_user.onchange=function(k,v){if(k)CalendarCtrlBase.setUserId(k);}
sel_user.popup_callback='CalendarCtrlBase.popupReturnUser';sel_user.popup_return_multiple=true;}
var sel_res=SUGAR.ui.getFormInput('settings_form','res_name_selected');if(sel_res){sel_res.onchange=function(k,v){if(k)CalendarCtrlBase.setResourceId(k);}
sel_res.popup_callback='CalendarCtrlBase.popupReturnResource';sel_res.popup_return_multiple=true;}},showCalendarBody:function(data,callbackFunc){window.setTimeout('ajaxStatus.hideStatus()',500);if(!data)return;try{$("calendar_body").innerHTML=SUGAR.util.disableInlineScripts(data.responseText);SUGAR.util.evalScript(data.responseText,callbackFunc);}catch(err){console.error(err.message);}},reloadWithParams:function(params,callbackFunc){params.forDashlet=CalendarCtrl.isDashlet;params.dashletId=CalendarCtrl.dashletId;var qstr=encodeQueryString(params);var success=function(data){CalendarCtrl.showCalendarBody(data,callbackFunc);}
SUGAR.util.maskDiv('calendar_body');if(!CalendarCtrl.isDashlet)
SUGAR.util.setNavigationTag(qstr,'Calendar');var postData="module=Calendar&action=asyncCalendarBody&"+qstr;SUGAR.conn.asyncRequest(null,{method:'POST',postData:postData},success);},asyncCalendarBody:function(viewType,targetDate,callbackFunc){return this.reloadWithParams({view_type:viewType,target_date:targetDate},callbackFunc);},reloadFormWithParams:function(params,formName,callbackFunc){var form=document.forms[formName];if(!form)return;var tabsForm=SUGAR.ui.getForm('calendar_tabs');var tabs=SUGAR.ui.getFormInput(tabsForm,'view_type_sel');if(!params)params={};for(var argName in params)
if(isset(params[argName])){if(form.elements[argName])
form.elements[argName].value=params[argName];else{var elt=createElement2('input',{type:'hidden',name:argName,value:params[argName]});form.appendChild(elt);}}
if(!CalendarCtrl.isDashlet){var qstr=encodeQueryString(params);SUGAR.util.setNavigationTag(qstr,'Calendar');}
if(tabs){tabs.setValue(params.view_type,true);}
return this.asyncCalendarBodyWithForm(formName,callbackFunc);},asyncCalendarBodyWithForm:function(formName,callbackFunc){var success=function(data){CalendarCtrl.showCalendarBody(data,callbackFunc);}
SUGAR.util.maskDiv('calendar_body');SUGAR.conn.sendForm(document.forms[formName],null,success);},reload:function(viewType,params){if(viewType=='day'){DayCalendarCtrl.reloadCalendar(params);}else if(viewType=='week'){WeekCalendarCtrl.reloadCalendar(params);}else if(viewType=='month'){MonthCalendarCtrl.reloadCalendar(params);}else if(viewType=='year'){YearCalendarCtrl.reloadCalendar(params);}else if(viewType=='team_day'){TeamDayCalendarCtrl.reloadCalendar(params);}else if(viewType=='team_week'){TeamWeekCalendarCtrl.reloadCalendar(params);}else if(viewType=='resource_day'){ResourceDayCalendarCtrl.reloadCalendar(params);}else if(viewType=='resource_week'){ResourceWeekCalendarCtrl.reloadCalendar(params);}}};}();var CalendarCtrlBase=new function(){this.view_type='';this.timer=null;this.inited=false;this.lastHover=null;this.waitRemoveHover=true;this.addActivity=function(act){if(act&&act.id){this.activity_ids.push(act.id);this.activities[act.id]=act;}}
this.addControl=function(ctl){ctl.cal=this;ctl.setup();SUGAR.ui.registerInput(CalendarCtrl.form_name,ctl);}
this.endHover=function(elt){SUGAR.ui.removeClass(elt,'hover expand');}
this.checkEndHover=function(){if(!this.waitRemoveHover||!this.lastHover)return;this.endHover(this.lastHover);this.lastHover=null;this.waitRemoveHover=false;}
this.ov=function(elt){var activity=SUGAR.dom.ExtNode(elt).closest('.panel-activity');if(activity.length)elt=activity[0];if(this.lastHover==elt){if(this.waitRemoveHover)
this.waitRemoveHover=false;}
else if(this.lastHover){this.endHover(this.lastHover);this.lastHover=null;}
SUGAR.ui.addClass(elt,'hover');setTimeout(function(){if(SUGAR.ui.hasClass(elt,'hover'))
SUGAR.ui.addClass(elt,'expand');},400);}
this.ot=function(elt,timeout){var activity=SUGAR.dom.ExtNode(elt).closest('.panel-activity');if(activity.length)elt=activity[0];if(timeout===undefined)
timeout=300;if(!timeout)
this.endHover(elt);else{this.checkEndHover();this.lastHover=elt;this.waitRemoveHover=true;var self=this;window.setTimeout(function(){self.checkEndHover();},timeout);}}
this.initCalendar=function(params){this.activity_ids=[];this.activities={};if(params){this.start_hour=params.start_hour;this.end_hour=params.end_hour;if(params.activities&&this.addActivity){for(var i=0;i<params.activities.length;i++)
this.addActivity(params.activities[i]);}}
this.form=document.forms[CalendarCtrl.form_name];}
this.initJsCalendar=function(callback){var init_val=this.form.target_date?Calendar.parseDate(this.form.target_date.value,'%Y-%m-%d'):null;var cal_inp=new SUGAR.ui.CalendarInput('',{form:this.form,name:'target_date',date_format:'%Y-%m-%d',attach_target:'select_day',onaccept:callback,target_offset:{top:-1,align:'right'},dateVal:init_val});cal_inp.setup();}
this.reloadCalendar=function(params){CalendarCtrl.reloadFormWithParams(params,CalendarCtrl.form_name);}
this.moveCalendar=function(targetDate){this.reloadCalendar({view_type:this.view_type,target_date:targetDate});}
this.applyMode=function(mode){if(!mode)mode="activities";var baseMode=this.form.view_mode.value;var userType='user';var targetType='user';if(mode=='resources')targetType='resource';var params={view_mode:mode,target_type:targetType};this.reloadCalendar(params);}
this.showMoreList=function(targ){SUGAR.popups.showPopup(targ,'div_more_list');}
this.hideMoreList=function(targ){SUGAR.popups.hidePopup('div_more_list');}
this.toggleFlag=function(settingsForm,name){var elt=settingsForm.elements[name];if(elt){elt.value=elt.value?0:1;this.applySettings(settingsForm);}}
this.applySettings=function(settingsForm){var i,elt,params={},inputs=['display_meetings','display_calls','display_tasks','display_project_tasks','display_events','display_leave','display_bookings'];for(i=0;i<inputs.length;i++){elt=settingsForm.elements[inputs[i]];if(elt){if(elt.length==2&&elt[1].type=='checkbox')
params[inputs[i]]=elt[1].checked?1:0;else if(elt.type=='checkbox')
params[inputs[i]]=elt.checked?1:0;else
params[inputs[i]]=elt.value;}}
this.reloadCalendar(params);}
this.showUserForm=function(targ){SUGAR.popups.showPopup(targ,'div_select_user');}
this.hideUserForm=function(){SUGAR.popups.hidePopup('div_select_user');}
this.setCurrentUser=function(settingsForm){var params={target_type:'user',target_user_type:'user',user_id:'',target_user_id:'',selected_targets:''
};this.reloadCalendar(params);}
this.popupReturnUser=function(popup_data){CalendarCtrlBase.applyUser($('settings_form'),popup_data);}
this.applyUser=function(settingsForm,popupData){if(popupData){if(popupData.selection_list){var uids=[];var pK=popupData.primary_key||'id';for(var k in popupData.selection_list){uids.push(popupData.selection_list[k][pK]);}
if(!uids.length)return;SUGAR.ui.updateForm(settingsForm,{'user_id_selected':uids.join(',')});}}
this.setUserId(settingsForm.user_id_selected&&settingsForm.user_id_selected.value||'');}
this.setUserId=function(userId,targetUserType){var params={target_type:'user',target_user_type:targetUserType||'user',user_id:userId,target_user_id:userId,selected_targets:userId};this.reloadCalendar(params);}
this.showResourceForm=function(targ){SUGAR.popups.showPopup(targ,'div_select_resource');}
this.hideResourceForm=function(){SUGAR.popups.hidePopup('div_select_resource');}
this.popupReturnResource=function(popup_data){set_return(popup_data);CalendarCtrlBase.applyResource($('settings_form'),popup_data);}
this.applyResource=function(settingsForm,popupData){if(popupData){if(popupData.selection_list){var uids=[];var pK=popupData.primary_key||'id';for(var k in popupData.selection_list){uids.push(popupData.selection_list[k][pK]);}
if(!uids.length)return;SUGAR.ui.updateForm(settingsForm,{res_id_selected:uids.join(',')});}}
this.setResourceId(settingsForm.res_id_selected&&settingsForm.res_id_selected.value||'');}
this.setResourceId=function(resourceId){var targetType='resource';var form_calendar=document.forms[CalendarCtrl.form_name];var baseTargetType=form_calendar.target_type.value;var baseTargetId=form_calendar.target_id.value;var params={selected_targets:resourceId,resource_id:resourceId,target_type:targetType};this.reloadCalendar(params);}
this.showProjectForm=function(targ){SUGAR.popups.showPopup(targ,'div_select_project');}
this.hideProjectForm=function(){SUGAR.popups.hidePopup('div_select_project');}
this.applyProject=function(settingsForm){this.setProjectId(settingsForm.project_id_selected.value);}
this.setProjectId=function(projectId,projectType){var targetType="user";var form_calendar=document.forms[CalendarCtrl.form_name];if(!projectId)
projectType='all';var params={target_type:targetType,project_id:projectId,project_type:projectType||'project'
};this.reloadCalendar(params);}
this.showTimesheetForm=function(targ){SUGAR.popups.showPopup(targ,'div_select_timesheet');}
this.hideTimesheetForm=function(){SUGAR.popups.hidePopup('div_select_timesheet');}
this.applyTimesheet=function(filterForm){var id='';var timesheetsRadios=filterForm.select_timesheets;if(timesheetsRadios.length==undefined){id=timesheetsRadios.value;}else{for(var i=0;i<timesheetsRadios.length;i++){if(timesheetsRadios[i].checked){id=timesheetsRadios[i].value;break;}}}
var params={timesheet_id:id};this.reloadCalendar(params);}
this.submitTimesheet=function(id,message){if(id!=null&&id!=''){var _confirm=confirm(message);if(_confirm){document.location.href='index.php?module=Timesheets&action=Save&record='+id+'&submit_timesheet=1';return true;}else{return false;}}}
this.approveHours=function(id,operation,message){if(id!=null&&id!=''){var _confirm=confirm(message);if(_confirm){var appAction='all';if(operation=='reject')appAction='reject-all';document.location.href='index.php?module=Timesheets&action=ApproveHours&record='+id+'&approve_action='+appAction;return true;}else{return false;}}}
this.toggleSelectTargetType=function(viewMode,entry){var divMain=$("div_"+entry);var divLabel=$("div_"+entry+"_label");var view=(viewMode=='all')?"none":"";divMain.style.display=view;divLabel.style.display=view;}
this.addGridEntry=function(settingsForm,type){var params={};if(type=="resource"){var resId=settingsForm.res_id_selected.value;params={grid_res_id:resId};}else{var userId=settingsForm.user_id_selected.value;params={grid_user_id:userId};}
this.reloadCalendar(params);}
this.deleteGridEntry=function(id,type){var params={};if(type=="resource"){params={grid_res_id_del:id};}else{params={grid_user_id_del:id};}
this.reloadCalendar(params);}
this.showEditor=function(elt,module,record,params){if(!params)params={};if(record)params.record=record;return SUGAR.ui.openQuickCreate(module,params,this.afterQuickCreate(this));}
this.afterQuickCreate=function(self){return function(){self.reloadCalendar({view_type:self.view_type});};}
this.getMode=function(){var form=document.forms[CalendarCtrl.form_name];if(form&&form.view_mode)return form.view_mode.value;}
this.showNew=function(elt,user_id,res_id,date,hour,minute,durHour,durMin,is_daylong,user_ids,res_ids){var params={assigned_user_id:user_id,resource_id:res_id,date_start:date,date_is_gmt:1,time_hour_start:hour,time_minute_start:minute,duration_hours:durHour,duration_minutes:durMin,is_daylong:is_daylong,user_ids:user_ids,resource_ids:res_ids},mod='Meetings',mode=this.getMode();if(mode=='projects')return;if(mode=='timesheets'){mod='Booking';params.timesheet_id=document.forms[CalendarCtrl.form_name].timesheet_id.value;}
return this.showEditor(elt,mod,null,params);}
this.getCellPos=function(table,cell){var x,y,skip=0,pos={},rows,cells,allday;rows=table.getElementsByClassName('number-row');for(y=0;y<rows.length;y++){if(SUGAR.ui.hasClass(rows[y],'week-head')){skip++;continue;}
allday=SUGAR.ui.hasClass(rows[y],'all-day');if(allday)skip++;cells=rows[y].getElementsByClassName('hour');for(x=0;x<cells.length;x++){if(cells[x]===cell){pos.is_daylong=allday;pos.col=x;pos.row=y;pos.skip=skip;return pos;}}}}
this.resolveMouseCell=function(px,py,outer){var p=SUGAR.ui.getEltRegion(outer),x,y,skip=0,pos={},rows,cells,allday,rgn,hpos=-1;if(!p||!px)return;if(px<p.left||px>p.right||py<p.top||py>p.bottom)return;rows=outer.getElementsByClassName('number-row');for(y=0;y<rows.length;y++){if(SUGAR.ui.hasClass(rows[y],'week-head')){skip++;continue;}
allday=SUGAR.ui.hasClass(rows[y],'all-day');if(allday)skip++;cells=rows[y].getElementsByClassName('hour');for(x=0;x<cells.length;x++){if(hpos>=0&&x!=hpos)continue;if(!(rgn=SUGAR.ui.getEltRegion(cells[x])))
continue;if(hpos<0){if(rgn.left<=px&&rgn.right>=px)
hpos=x;else
continue;}
if(rgn.top>py)
break;if(rgn.bottom>=py){pos.startTime=
pos.cell=cells[x];pos.is_daylong=allday;pos.col=x;pos.row=y;pos.skip=skip;pos.offsetX=px-rgn.left;pos.offsetY=py-rgn.top;return pos;}}}}
this.resolveMouseRange=function(px,py,rgn,outer){var pos=this.resolveMouseCell(px,py,outer),pos2,pos3,rowh;if(pos&&rgn){if(!pos.is_daylong)
pos2=this.resolveMouseCell(px,py-rgn.y,outer);if(pos2&&pos2.is_daylong)
pos2.row++;if(rgn.rows)
rowh=rgn.rows-1;else{if((pos3=this.resolveMouseCell(px,py-rgn.y+rgn.h,outer)))
rowh=pos3.row-pos2.row;}
if(pos2&&rowh){pos.range=true;pos.row1=pos2.row;pos.row2=pos2.row+rowh;}}
return pos;}
this.getTimeRange=function(pos1,pos2,rows){var time={},top_row,bottom_row,diff;if(!pos1)return;if(pos1.is_daylong){time.is_daylong=1;time.start_hour=this.start_hour;time.start_min=0;time.end_hour=this.end_hour;time.end_min=0;}
else{if(pos2){top_row=Math.min(pos1.row,pos2.row)-pos1.skip;bottom_row=Math.max(pos1.row,pos2.row)-pos1.skip+1;}else if(pos1.range){top_row=pos1.row1-pos1.skip;bottom_row=pos1.row2-pos1.skip;}else{top_row=bottom_row=pos1.row-pos1.skip;if(rows)bottom_row+=rows;else bottom_row++;}
time.is_daylong=0;time.start_hour=Math.floor(this.start_hour+top_row/2);time.start_min=(top_row%2==1)?30:0;time.end_hour=Math.floor(this.start_hour+bottom_row/2);time.end_min=(bottom_row%2==1)?30:0;}
time.dur_total=time.end_hour*60+time.end_min-time.start_hour*60-time.start_min;time.dur_hour=Math.floor(time.dur_total/60);time.dur_min=time.dur_total-time.dur_hour*60;time.date=this.weekDays?this.weekDays[pos1.col]:this.form.target_date.value;return time;}
this.markCellRange=function(table,x1,y1,x2,y2){if(!table)return;var x,y,rows,cells,cell;rows=table.getElementsByClassName('number-row');for(y=0;y<rows.length;y++){cells=rows[y].getElementsByClassName('hour');for(x=0;x<cells.length;x++){cell=cells[x];if(!this.isResponsiveCell(cell))continue;SUGAR.ui.addRemoveClass(cell,'selected',(y1-y)*(y-y2)>=0&&(x1-x)*(x-x2)>=0);SUGAR.ui.removeClass(cell,'active');}}}
this.isResponsiveCell=function(cell){return SUGAR.ui.hasClass(cell,'hour')&&SUGAR.ui.hasClass(cell,'responsive');}
this.extendTo=function(cls,map,map2){var k,i;cls.prototype=this;for(k in this)
cls[k]=this[k];for(i=1;i<arguments.length;i++)
for(k in arguments[i])
cls[k]=arguments[i][k];}};var CalHourGridEvents={mouseDown:function(e,table){this.startCell=e.target;if(!this.isResponsiveCell(this.startCell)){this.startCell=null;return;}
SUGAR.ui.stopEvent(e);this.mouseMove(e,table);},mouseUp:function(e,table){var from,to,endCell,range;if(!this.startCell||!this.endCell){return false;}
from=this.getCellPos(table,this.startCell);to=this.getCellPos(table,this.endCell);endCell=this.endCell;this.startCell=this.endCell=null;this.markCellRange(table);if(!from||!to){return false;}
var target_id=this.form.target_id.value,target_type=this.form.target_type.value,mode=this.getMode(),timesheet_id=this.form.timesheet_id.value;target_user_id='',target_res_id='';if(target_type=='user'){target_user_id=target_id;}else if(target_type=='resource'){target_res_id=target_id;}
if(mode!="projects"){range=this.getTimeRange(from,to);var qcp={assigned_user_id:target_user_id,resource_id:target_res_id,timesheet_id:timesheet_id,date_start:range.date,date_is_gmt:1,time_hour_start:range.start_hour,time_minute_start:range.start_min,duration_hours:range.dur_hour,duration_minutes:range.dur_min,is_daylong:range.is_daylong},m=(mode=='timesheets'?'Booking':'Meetings');this.showEditor(endCell,m,null,qcp);}},mouseMove:function(e,table){var from,to;this.endCell=e.target;if(!this.isResponsiveCell(this.endCell)||!this.startCell){return;}
from=this.getCellPos(table,this.startCell);to=this.getCellPos(table,this.endCell);if(!from||!to)return;if(from.col!=to.col)
to.col=from.col;this.markCellRange(table,from.col,from.row,to.col,to.row);},mouseLeave:function(e,table){if(this.startCell){this.startCell=null;this.endCell=null;this.markCellRange(table);}},dragOver:function(e,outer){var px=e.clientX+window.scrollX,py=e.clientY+window.scrollY,pos;if(this.drag_x==px&&this.drag_y==py)return;this.drag_x=px;this.drag_y=py;if((pos=this.resolveMouseRange(px,py,this.drag_rgn,outer))){if(pos.range)
this.markCellRange(outer,pos.col,pos.row1,pos.col,pos.row2);else
this.markCellRange(outer,pos.col,pos.row,pos.col,pos.row);e.preventDefault();}},drop:function(e,outer){var px=e.clientX+window.scrollX,py=e.clientY+window.scrollY,pos,range,self=this;this.markCellRange(outer);if((pos=this.resolveMouseRange(px,py,this.drag_rgn,outer))){range=this.getTimeRange(pos);if(this.drag_activity_id){var query_params={module:this.activities[this.drag_activity_id].module,record:this.drag_activity_id,date_start:range.date,time_start:range.start_hour+':'+range.start_min,is_daylong:range.is_daylong};var req=new SUGAR.conn.JSONRequest(
'move_calendar_activity',{status_msg:app_string('LBL_LOADING')},query_params);req.fetch(function(){var row=this.getResult();if(row&&row.result=='ok')
self.reloadCalendar();});}}},eventDragStart:function(e,act_id){var mod=this.activities[act_id].module,url='index.php?'+encodeQueryString({module:mod,action:'DetailView',record:act_id}),div=$('div_act_'+act_id),rgn=SUGAR.ui.getEltRegion(div),rows=1,act;if(!div||!rgn)return;this.drag_activity_id=act_id;this.drag_url=url;if((act=this.activities[act_id])){if(act.isDaylong||!act.durationMin)
rows=1;else
rows=Math.ceil((act.durationMin-1)/30);}
this.drag_rgn={x:e.clientX+window.scrollX-rgn.left,y:e.clientY+window.scrollY-rgn.top,w:rgn.width,h:rgn.height,rows:rows};e.dataTransfer.setData('text/plain',url);e.dataTransfer.setData('text/uri-list',url);e.dataTransfer.setData('url',url);e.dataTransfer.dropEffect='move';},eventDragEnd:function(e,act_id){this.drag_activity_id=null;this.drag_url=null;this.drag_rgn=null;this.markCellRange($('calendar-body'));},eventMouseOver:function(e,act_id){this.ov(e.target);},eventMouseOut:function(e,act_id){this.ot(e.target);},eventClick:function(e,act_id){if(e.target.closest('a')){return;}
var mod=this.activities[act_id].module;if(mod&&act_id){this.showEditor(this,mod,act_id);SUGAR.ui.stopEvent(e);}},attachEvents:function(){var table=$('calendar-body'),act_id,div,div_detail;SUGAR.ui.addEventListeners(table,{mousedown:this.mouseDown,mouseup:this.mouseUp,mousemove:this.mouseMove,mouseleave:this.mouseLeave,dragover:this.dragOver,drop:this.drop},this,table);if(this.activity_ids){for(var i=0;i<this.activity_ids.length;i++){act_id=this.activity_ids[i];div=$('div_act_'+act_id);div_detail=$('div_detail_'+act_id);if(div&&this.activities[act_id].canEdit&&!div.draggable){SUGAR.ui.addEventListeners(div,{dragstart:this.eventDragStart,dragend:this.eventDragEnd,mouseover:this.eventMouseOver,mouseout:this.eventMouseOut,click:this.eventClick,dblclick:this.eventDblClick},this,act_id);SUGAR.ui.addEventListeners(div,{dragover:this.dragOver,drop:this.drop},this,table);div.draggable=true;}else if(div&&this.activities[act_id].isViewAble){SUGAR.ui.addEventListeners(div,{mouseover:this.eventMouseOver,mouseout:this.eventMouseOut},this,act_id);}
if(div_detail){SUGAR.ui.addEventListeners(div_detail,{click:function(e){e.stopPropagation();}},this);}}}}}
var DayCalendarCtrl=new function(){var startCell=null;CalendarCtrlBase.extendTo(this,CalHourGridEvents,{view_type:'day',initCalendar:function(acts){CalendarCtrlBase.initCalendar.call(this,acts);this.initJsCalendar(function(){DayCalendarCtrl.moveCalendar(this.getValue());});this.attachEvents();},asyncCalendarBody:function(targetDate,targetId,targetType,teamId){var params={view_type:this.view_type,target_date:targetDate,target_id:targetId,target_type:targetType,target_team_id:teamId};DayCalendarCtrl.reloadCalendar(params);},toggleTaskList:function(isViewList){var div_task_count=$("div_task_count");var div_task_list=$("div_task_list");if(isViewList){div_task_count.style.display="none";div_task_list.style.display="";}else{div_task_count.style.display="";div_task_list.style.display="none";}}});}();var WeekCalendarCtrl=new function(){var dds;var toDayWeekIndex=-1;var firstDate="";var weekDays;var summaryTimeout;CalendarCtrlBase.extendTo(this,CalHourGridEvents,{view_type:'week',displaySummary:function(offset){var target_id='summary_details_'+offset;var divs=document.getElementsByName('summary_details');for(var i in divs){var div=divs[i];try{if(div.id==target_id){div.style.zIndex=1000;div.style.display='';}else{div.style.display='none';}}catch(e){}}
if(this.summaryTimeout){window.clearTimeout(this.summaryTimeout);this.summaryTimeout=null;}},summaryLeaved:function(){this.summaryTimeout=window.setTimeout('WeekCalendarCtrl.displaySummary(-1)',500);},initCalendar:function(acts){CalendarCtrlBase.initCalendar.call(this,acts);this.toDayWeekIndex=parseInt(this.form.today_weekindex.value);this.firstDate=this.form.week_first_date.value;this.weekDays=Array();for(var i=0;i<7;i++){var elt='week_date_'+i;if(this.form[elt])
this.weekDays[i]=this.form[elt].value;}
this.initJsCalendar(function(){WeekCalendarCtrl.moveCalendar(this.getValue());});this.attachEvents();},asyncCalendarBody:function(targetDate,targetId,targetType,teamId){var params={view_type:this.view_type,target_date:targetDate,target_id:targetId,selected_targets:targetId,target_type:targetType,target_team_id:teamId};this.reloadCalendar(params);}});}();var MonthCalendarCtrl=new function(){CalendarCtrlBase.extendTo(this,{view_type:'month',initCalendar:function(){CalendarCtrlBase.initCalendar.call(this);this.initJsCalendar(function(){MonthCalendarCtrl.moveCalendar(this.getValue());});},asyncCalendarBody:function(targetDate,userId,teamId){var params={view_type:this.view_type,target_date:targetDate,target_user_id:userId,target_team_id:teamId};MonthCalendarCtrl.reloadCalendar(params);}});}();var YearCalendarCtrl=new function(){CalendarCtrlBase.extendTo(this,{view_type:'year',initCalendar:function(){CalendarCtrlBase.initCalendar.call(this);this.initJsCalendar(function(){YearCalendarCtrl.moveCalendar(this.getValue());});},asyncCalendarBody:function(targetDate,targetId,targetType,teamId){var params={view_type:this.view_type,target_date:targetDate,target_id:targetId,target_type:targetType,target_team_id:teamId};YearCalendarCtrl.reloadCalendar(params);}});}();var TeamDayCalendarCtrl=new function(){CalendarCtrlBase.extendTo(this,{view_type:'team_day',initCalendar:function(){CalendarCtrlBase.initCalendar.call(this);this.initJsCalendar(function(){CalendarCtrl.asyncCalendarBody('team_day',this.getValue(),TeamDayCalendarCtrl.initCalendar);});},asyncCalendarBody:function(targetDate,teamId){var params={view_type:this.view_type,target_date:targetDate,target_team_id:teamId};TeamDayCalendarCtrl.reloadCalendar(params);},teamOnChange:function(teamId){TeamDayCalendarCtrl.reloadCalendar({target_team_id:teamId});}});}();var TeamWeekCalendarCtrl=new function(){CalendarCtrlBase.extendTo(this,{view_type:'team_week',initCalendar:function(){CalendarCtrlBase.initCalendar.call(this);this.initJsCalendar(function(){TeamWeekCalendarCtrl.moveCalendar(this.getValue());});},teamPopup:function(){var popupdata={'call_back_function':'TeamWeekCalendarCtrl.setTeamReturn','form_name':'form_calendar','field_to_name_array':{'id':'target_team_id','name':'span_team_name'
}};},setTeamReturn:function(popup_reply_data){var form_name=popup_reply_data.form_name;var name_to_value_array=popup_reply_data.name_to_value_array;for(var the_key in name_to_value_array){if(the_key=='toJSON'){}else if(the_key=='target_team_id'){var element=$(the_key);element.value=name_to_value_array[the_key];}else if(the_key=='span_team_name'){var element=$(the_key);element.innerHTML=name_to_value_array[the_key];}}
TeamWeekCalendarCtrl.reloadCalendar();},asyncCalendarBody:function(targetDate,teamId){var params={view_type:this.view_type,target_date:targetDate,target_team_id:teamId};TeamWeekCalendarCtrl.reloadCalendar(params);},teamOnChange:function(teamId){document.forms[CalendarCtrl.form_name].target_team_id.value=teamId;TeamWeekCalendarCtrl.reloadCalendar();}});}();var ResourceDayCalendarCtrl=new function(){CalendarCtrlBase.extendTo(this,{view_type:'resource_day',initCalendar:function(){CalendarCtrlBase.initCalendar.call(this);this.initJsCalendar(function(){ResourceDayCalendarCtrl.moveCalendar(this.getValue());});},asyncCalendarBody:function(targetDate){var params={view_type:this.view_type,target_date:targetDate};ResourceDayCalendarCtrl.reloadCalendar(params);},resTypeOnChange:function(resType){ResourceDayCalendarCtrl.reloadCalendar({target_res_type:resType});}});}();var ResourceWeekCalendarCtrl=new function(){CalendarCtrlBase.extendTo(this,{view_type:'resource_week',initCalendar:function(){CalendarCtrlBase.initCalendar.call(this);this.initJsCalendar(function(){ResourceWeekCalendarCtrl.moveCalendar(this.getValue());});},resTypeOnChange:function(resType){ResourceDayCalendarCtrl.reloadCalendar({target_res_type:resType});},asyncCalendarBody:function(targetDate,teamId){var params={view_type:this.view_type,target_date:targetDate,target_team_id:teamId};ResourceWeekCalendarCtrl.reloadCalendar(params);}});}();var UsersCalendarCtrl=function(){return{ov:function(e){SUGAR.ui.addClass(e,'hover');},ot:function(e){SUGAR.ui.removeClass(e,'hover');}};}();var setPrintLink=function(elt){var printUrl=$('print_url');if(printUrl){if(elt&&(elt=$(elt)))
elt.href=printUrl.value;else{var printLinks=document.getElementsByName('print_link');for(var i in printLinks){printLinks[i].href=printUrl.value;}}}};var CalUserSelect=function(id,params){if(!params)params={};params.icon_key='icon';params.options={width:220,keys:['','select'],values:[{label:mod_string('LBL_ME','Calendar'),icon:'icon-user'},{label:app_string('LBL_FILTER_OWNER_SELECT'),icon:'icon-popup'}]};if(params.all_users){params.options.keys.splice(0,0,'all');params.options.values.splice(0,0,{label:mod_string('LBL_ALL_USERS_BUTTON_LABEL','Calendar'),icon:'icon-users'});}
if(params.user_id=='all')
params.init_value='all';else if(params.user_id&&params.user_name&&params.user_name!='Me'){params.options.keys.splice(1,0,params.user_id);params.options.values.splice(1,0,{label:params.user_name,icon:'icon-user'});params.init_value=params.user_id;}else
params.init_value='';SUGAR.ui.SelectInput.call(this,id,params);};extendClass(CalUserSelect,SUGAR.ui.SelectInput,{userUpdate:function(key,value){this.update(key,value);},update:function(key,value,silent){if(key=='select')
this.showSelectUser();else if(key=='all')
this.cal.setUserId('','all');else
this.cal.setUserId(key);},showSelectUser:function(){var request_data={form_name:this.form.getAttribute('id')||this.form.getAttribute('name'),call_back_function:this.popup_callback||'ui_popup_return',passthru_data:{ui_input_name:this.name||this.id},field_to_name_array:this.field_to_name||{id:'id',label:'name'}},params={module:'Users',request_data:request_data,inline:true};open_popup_window(params);}});var CalResSelect=function(id,params){if(!params)params={};params.icon_key='icon';params.options={width:220,keys:['','select'],values:[{label:mod_string('LBL_RESOURCE_ALL','Calendar'),icon:'theme-icon bean-Resource'},{label:mod_string('LBL_SELECT_RESOURCE','Calendar'),icon:'icon-popup'}]};if(params.res_id&&params.res_name){params.options.keys.splice(1,0,params.res_id);params.options.values.splice(1,0,{label:params.res_name,icon:'theme-icon bean-Resource'});params.init_value=params.res_id;}else
params.init_value='';SUGAR.ui.SelectInput.call(this,id,params);};extendClass(CalResSelect,SUGAR.ui.SelectInput,{userUpdate:function(key,value){this.update(key,value);},update:function(key,value,silent){if(key=='select')
this.showSelectRes();else{this.cal.setResourceId(key||'');}},showSelectRes:function(){var request_data={form_name:this.form.getAttribute('id')||this.form.getAttribute('name'),call_back_function:this.popup_callback||'ui_popup_return',passthru_data:{ui_input_name:this.name||this.id},field_to_name_array:this.field_to_name||{id:'id',label:'name'}},params={module:'Resources',request_data:request_data,inline:true,min_width:700};open_popup_window(params);}});var CalProjectSelect=function(id,params){if(!params)params={};params.icon_key='icon';params.options={width:220,keys:['','select'],values:[{label:mod_string('LBL_PROJECT_ALL','Calendar'),icon:'theme-icon bean-Project'},{label:mod_string('LBL_SELECT_PROJECT','Calendar'),icon:'icon-popup'}]};if(params.proj_id&&params.proj_name){params.options.keys.splice(1,0,params.proj_id);params.options.values.splice(1,0,{label:params.proj_name,icon:'theme-icon bean-Project'});params.init_value=params.proj_id;}else
params.init_value='';SUGAR.ui.SelectInput.call(this,id,params);};extendClass(CalProjectSelect,SUGAR.ui.SelectInput,{userUpdate:function(key,value){this.update(key,value);},update:function(key,value,silent){if(key=='select')
this.showSelectProject();else{this.cal.setProjectId(key||'');}},showSelectProject:function(){var request_data={form_name:this.form.getAttribute('id')||this.form.getAttribute('name'),call_back_function:this.popup_callback||'ui_popup_return',passthru_data:{ui_input_name:this.name||this.id},field_to_name_array:this.field_to_name||{id:'id',label:'name'}},params={module:'Project',request_data:request_data,inline:true,min_width:700};open_popup_window(params);}});var MeetingsEditView=function(){var module='Meetings';var form;var tabs;var popupDialog;return{initEditView:function(){MeetingsEditView.form=SUGAR.ui.getForm('asyncEditView');MeetingsEditView.tabs=SUGAR.ui.getFormInput(MeetingsEditView.form,'form-tabs');if(MeetingsEditView.tabs)
MeetingsEditView.tabs.enableDisableTab('Booking',true);MeetingsEditView.module=MeetingsEditView.form.edit_module.value;if(MeetingsEditView.module=='Meetings'){var duration_inp=SUGAR.ui.getFormInput(MeetingsEditView.form,'duration');if(duration_inp)
duration_inp.all_day_field.onchange=function(evt){MeetingsEditView.toggleDayLong();}
if(MeetingsEditView.form.record.value=='')
MeetingsEditView.toggleDayLong();}
var rel=SUGAR.ui.getFormInput(MeetingsEditView.form,'parent');if(rel){rel.addExtraReturnFields({'account':'_account','account_id':'_account_id'
});SUGAR.ui.attachInputEvent(rel,'onchange',function(k,v){if(v&&v.account_id){var acct=SUGAR.ui.getFormInput(MeetingsEditView.form,'account');if(acct)acct.update(v.account_id,v.account);}});}},show:function(targetElementName,module,activityId,userId,dateStart,timeHourStart,timeMinuteStart,resourceId){this.showDialog({module:module,record:activityId,assigned_user_id:userId,resource_id:resourceId,date_start:dateStart,time_hour_start:timeHourStart,time_minute_start:timeMinuteStart});},showNew:function(targetElement,userId,resourceId,dateStart,timeHourStart,timeMinuteStart,durHour,durMin,is_daylong,user_ids,resource_ids){this.showDialog({assigned_user_id:userId,resource_id:resourceId,date_start:dateStart,date_is_gmt:1,time_hour_start:timeHourStart,time_minute_start:timeMinuteStart,duration_hours:durHour,duration_minutes:durMin,is_daylong:is_daylong,user_ids:user_ids,resource_ids:resource_ids});},showDialog:function(params){var module=params.module||window.defaultEditModule||'Meetings';if(module!='Meetings'&&module!='Calls')return;params.module='Meetings';params.action='activityEditView';params.edit_model=MeetingsEditView.getModel(module);this.setupPopupDialog();function ready(data){MeetingsEditView.initEditView();if(params.resource_id)MeetingsEditView.tabs.enableDisableTab('Call',true);if(MeetingsEditView.form.record.value!=''){MeetingsEditView.tabs.enableDisableTab('Meeting',true);MeetingsEditView.tabs.enableDisableTab('Call',true);}}
this.popupDialog.fetchContent('async.php',{method:'POST',postData:params},ready,true);},getModel:function(module){var model='Meeting';if(module=='Calls')model='Call';return model;},setupPopupDialog:function(){if(!this.popupDialog){this.popupDialog=new SUGAR.ui.Dialog('activityEditView',{width:'661px',resizable:false,draggable:true});this.popupDialog.onshow=function(){MeetingsEditView.toggleButtons(true);var name=document.asyncEditView&&document.asyncEditView.name;if(name&&name.focus&&!name.value)name.focus();}}},setTitle:function(title){if(this.popupDialog)
this.popupDialog.setTitle(title||'');},toggleButtons:function(state){var targetForm=window.document.asyncEditView;if(!targetForm)return;for(i=0;i<targetForm.elements.length;i++){var elt=targetForm.elements[i];if(elt.type=='button'||elt.type=='submit'){targetForm.elements[i].disabled=state?false:true;}}},hide:function(){if(this.popupDialog){this.popupDialog.close();this.popupDialog=null;}},save:function(){var vresult;if(!(vresult=SUGAR.ui.validateForm(MeetingsEditView.form)).status){SUGAR.ui.alertInvalidForm(vresult);return false;}
var success=function(data){var result=null;MeetingsEditView.hide();try{var viewType=window.document.form_calendar.view_type.value;CalendarCtrl.reload(viewType);}catch(err){document.location.reload(true);}};MeetingsEditView.toggleButtons();var resultDiv=this.popupDialog.getContentElement();return SUGAR.ui.sendForm(MeetingsEditView.form,{record_perform:'save'},{no_validate:true,resultDiv:resultDiv,receiveCallback:success},false,false);},duplicate:function(){function ready(){MeetingsEditView.initEditView();}
var resultDiv=this.popupDialog.getContentElement();SUGAR.ui.sendForm(MeetingsEditView.form,{record_perform:'duplicate'},{no_validate:true,resultDiv:resultDiv,receiveCallback:ready},false,false);},deleteActivity:function(){var success=function(data){MeetingsEditView.hide();try{var viewType=window.document.form_calendar.view_type.value;CalendarCtrl.reload(viewType);}catch(err){document.location.reload(true);}};var msgConfirm=SUGAR.language.get('app_strings','NTC_DELETE_CONFIRMATION_MULTIPLE');if(confirm(msgConfirm)==false){return false;}
MeetingsEditView.toggleButtons();var resultDiv=this.popupDialog.getContentElement();SUGAR.ui.sendForm(MeetingsEditView.form,{record_perform:'delete'},{no_validate:true,resultDiv:resultDiv,receiveCallback:success},false,false);},switchTab:function(model){function ready(){MeetingsEditView.initEditView();}
MeetingsEditView.form.edit_model.value=model;var resultDiv=this.popupDialog.getContentElement();SUGAR.ui.sendForm(MeetingsEditView.form,null,{no_validate:true,resultDiv:resultDiv,receiveCallback:ready},false,false);},toggleDayLong:function(){var duration_inp=SUGAR.ui.getFormInput(MeetingsEditView.form,'duration');if(duration_inp){var chkDayLong=duration_inp.getAllDay();var isDisable=(chkDayLong==1);var date_start_inp=SUGAR.ui.getFormInput(MeetingsEditView.form,'date_start');date_start_inp.time_field.disabled=isDisable;duration_inp.time_field.disabled=isDisable;var new_time_start=orig_start_time;var new_duration=orig_duration;if(isDisable){orig_start_time=date_start_inp.getTimeValue();orig_duration=duration_inp.getValue();new_time_start=day_start_time;new_duration=day_duration;}
date_start_inp.setTimeValue(new_time_start,true);duration_inp.setValue(new_duration);}}};}();var HoursEditView=function(){return{initEditView:function(form_id){HoursEditView.form=SUGAR.ui.getForm(form_id);var tab=SUGAR.ui.getFormInput(HoursEditView.form,'form-tabs');if(tab){tab.enableDisableTab('Meeting',true);tab.enableDisableTab('Call',true);tab.enableDisableTab('Booking',true);}
SUGAR.ui.onInitForm(this.form,function(){HoursEditView.initExtra();});},initFilters:function(){var rel=SUGAR.ui.getFormInput(HoursEditView.form,'related');if(rel&&rel instanceof SUGAR.ui.RefInput){rel.addExtraReturnFields({'account_id':'account_id','account':'account','default_booking_category_id':'default_booking_category_id','default_booking_category':'default_booking_category'});rel.addFilter({param:'account',field_name:'account'});rel.addFilter({param:'user_id',field_name:'assigned_user_id'});SUGAR.ui.attachInputEvent(rel,'onchange',function(k,v){var acct=SUGAR.ui.getFormInput(this.form,'account'),cat=SUGAR.ui.getFormInput(this.form,'booking_category');if(acct&&v&&v.account_id)
acct.update(v.account_id,v.account,true);if(cat&&v&&v.default_booking_category_id)
cat.update(v.default_booking_category_id,v.default_booking_category,true);HoursEditView.setTaskRates();});}
else if((rel=SUGAR.ui.getFormInput(HoursEditView.form,'related_id'))){SUGAR.ui.attachInputEvent(rel,'onchange',function(k,v){SUGAR.ui.getFormInput(HoursEditView.form,'account').update(v.account_id,v.account,true);HoursEditView.setTaskRates();});}},initExtra:function(){var input,price_fields=['billing_rate','paid_rate','billing_total','paid_total'];for(var i=0;i<price_fields.length;i++){input=SUGAR.ui.getFormInput(this.form,price_fields[i]);if(input)input.onchange=function(){HoursEditView.updateAmount(this);}}
SUGAR.ui.attachFormInputEvent(this.form,'quantity','onchange',function(){HoursEditView.updateQuantity();});SUGAR.ui.attachFormInputEvent(this.form,'booking_category_id','onchange',function(){HoursEditView.setRates(this.getValue());});SUGAR.ui.attachFormInputEvent(this.form,'assigned_user','onchange',function(){HoursEditView.setTaskRates();});this.initFilters();},show:function(targetElement,activityId,userId,dateStart,timeHourStart,timeMinuteStart,timesheetId){var params={record:activityId,assigned_user_id:userId,timesheet_id:timesheetId,date_is_gmt:1,layout:'Standard'
};function reload(){if(document.form_calendar&&document.form_calendar.view_type&&window.CalendarCtrl)
CalendarCtrl.reload(document.form_calendar.view_type.value);}
SUGAR.ui.openQuickCreate('Booking',params,reload);},showNew:function(targetElement,userId,timesheetId,dateStart,timeHourStart,timeMinuteStart,durHour,durMin,related){var params={assigned_user_id:userId,date_start:dateStart,time_hour_start:timeHourStart,time_minute_start:timeMinuteStart,duration_hours:durHour,duration_minutes:durMin,timesheet_id:timesheetId,date_is_gmt:1};if(isset(related)){params.related_type=related.type;params.related_id=related.id;}
function reload(){if(document.form_calendar&&document.form_calendar.view_type&&window.CalendarCtrl)
CalendarCtrl.reload(document.form_calendar.view_type.value);}
SUGAR.ui.openQuickCreate('Booking',params,reload);},setupPopupDialog:function(){if(!this.popupDialog){this.popupDialog=new SUGAR.ui.Dialog('bookingEditView',{width:'670px',resizable:false,draggable:true});this.popupDialog.onshow=function(){var name=document.asyncEditView?document.asyncEditView.name:null;if(name&&name.focus&&!name.value)name.focus();}}},setTitle:function(title){if(this.popupDialog)
this.popupDialog.setTitle(title||'');},swapAdditional:function(){var content=$('add_content');if(content.style.display=='none'){content.style.display=''
}else{content.style.display='none';}
SUGAR.popups.reposition();},hide:function(){if(this.popupDialog){this.popupDialog.close();this.popupDialog=null;}},save:function(){var success=function(data){var result=null;HoursEditView.hide();try{var viewType=window.document.form_calendar.view_type.value;CalendarCtrl.reload(viewType);}catch(err){var msg=SUGAR.language.get('app_strings','NTC_HOURS_BOOKED');alert(msg);var frm=SUGAR.ui.getForm('DetailForm');if(frm&&frm.module&&frm.module.value=='ProjectTask')
SUGAR.ui.refreshTarget('DetailForm');else
sugarListView.reloadSubpanel('booked_hours');}};var resultDiv=this.popupDialog.getContentElement();return SUGAR.ui.sendForm(HoursEditView.form,{record_perform:'save'},{resultDiv:resultDiv,receiveCallback:success},false,false);},duplicate:function(){function ready(){HoursEditView.initEditView('asyncEditView');}
var resultDiv=this.popupDialog.getContentElement();SUGAR.ui.sendForm(HoursEditView.form,{record_perform:'duplicate'},{no_validate:true,resultDiv:resultDiv,receiveCallback:ready},false,false);},deleteActivity:function(){var success=function(data){HoursEditView.hide();try{var viewType=window.document.form_calendar.view_type.value;CalendarCtrl.reload(viewType);}catch(err){document.location.reload(true);}};var msgConfirm=SUGAR.language.get('app_strings','NTC_DELETE_CONFIRMATION');if(confirm(msgConfirm)==false){return false;}
var resultDiv=this.popupDialog.getContentElement();SUGAR.ui.sendForm(HoursEditView.form,{record_perform:'delete'},{no_validate:true,resultDiv:resultDiv,receiveCallback:success},false,false);},updatedRelatedType:function(fld){fld.form.related_id.value='';fld.form.related_name.value='';HoursEditView.updateAccountEdit();},updateAccountEdit:function(){var form=document.forms.asyncEditView;if(form.related_id.value){form.account_select.style.display='none';form.account_name.readOnly=true;}else{form.account_select.style.display='';form.account_name.readOnly=false;}},updateQuantity:function(){var qty_inp=SUGAR.ui.getFormInput(HoursEditView.form,'quantity');if(!qty_inp)return;var qty=qty_inp.getValue(true)/60;if(!qty)return;var rate1_inp=SUGAR.ui.getFormInput(HoursEditView.form,'billing_rate');var total1_inp=SUGAR.ui.getFormInput(HoursEditView.form,'billing_total');var rate2_inp=SUGAR.ui.getFormInput(HoursEditView.form,'paid_rate');var total2_inp=SUGAR.ui.getFormInput(HoursEditView.form,'paid_total');if(rate1_inp&&total1_inp){total1_inp.setValue(rate1_inp.isBlank()?'':rate1_inp.getValue(true)*qty,true);}
if(rate2_inp&&total2_inp){total2_inp.setValue(rate2_inp.isBlank()?'':rate2_inp.getValue(true)*qty,true);}},updateAmount:function(price_elem){var name=price_elem.name;var qty_inp=SUGAR.ui.getFormInput(HoursEditView.form,'quantity');var amount_inp=SUGAR.ui.getFormInput(HoursEditView.form,name);if(!qty_inp||!amount_inp)return;var id=amount_inp.field.name.split('_');var other,val,newval;var qty=qty_inp.getValue(true)/60;if(!qty)return;val=amount_inp.isBlank()?null:amount_inp.getValue(true);if(id[1]=='rate'){other='total';newval=isset(val)?val*qty:'';}else{other='rate';newval=isset(val)?val/qty:'';}
other=SUGAR.ui.getFormInput(HoursEditView.form,id[0]+'_'+other);if(other)other.setValue(newval,true);},setTaskRates:function(){var ready=function(){var row=this.getResult();if(row.result!='ok')return;var rate=SUGAR.ui.getFormInput(HoursEditView.form,'paid_rate'),cur=SUGAR.ui.getFormInput(HoursEditView.form,'paid_currency_id');if(cur)cur.setValue(row['currency_id'],true);if(rate)rate.setValue(row['hourly_cost']);HoursEditView.updateQuantity();}
if(this.form.related_type.value=='ProjectTask'){var related=SUGAR.ui.getFormInput(this.form,'related'),user=SUGAR.ui.getFormInput(this.form,'assigned_user'),user_id=user?user.getKey():SUGAR.session.user_id,query_params={task_id:related?related.getKey():null,user_id:user_id},req=new SUGAR.conn.JSONRequest('get_user_task_rates',{status_msg:app_string('LBL_SAVING')},query_params);req.fetch(ready);}},setRates:function(category_id){function ready(){var row=this.getResult();if(row.result=='ok'){var cat_fields=['billing_rate','billing_currency_id','paid_rate','paid_currency_id','tax_code_id'];var num_fields={billing_rate:true,paid_rate:true};var name='';var input=null;for(var i=0;i<cat_fields.length;i++){name=cat_fields[i];if(isset(row[name])){input=SUGAR.ui.getFormInput(HoursEditView.form,name);if(input){var val=row[name];if(num_fields[name])
val=parseFloat(val);input.setValue(val);if(typeof(input.handleChanged)=='function')
input.handleChanged();}}}}
return false;}
var query_params={category_id:category_id};var req=new SUGAR.conn.JSONRequest('get_rates_by_cat',{status_msg:app_string('LBL_SAVING')},query_params);req.fetch(ready);}};}();window.sqsAsyncInit=true;