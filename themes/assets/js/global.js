function Get_Cookie(name){var start=document.cookie.indexOf(name+'=');var len=start+name.length+1;if((!start)&&(name!=document.cookie.substring(0,name.length)))return null;if(start==-1)return null;var end=document.cookie.indexOf(';',len);if(end==-1)end=document.cookie.length;if(end==start){return'';}
return decodeURIComponent(document.cookie.substring(len,end).replace(/\+/g,' '));}
function Set_Cookie(name,value,expires,path,domain,secure){var today=new Date();today.setTime(today.getTime());if(expires){expires=expires*1000*60*60*24;}
var expires_date=new Date(today.getTime()+(expires));document.cookie=name+"="+encodeURIComponent(value)+
((expires)?";expires="+expires_date.toGMTString():"")+
((path)?";path="+path:"")+
((domain)?";domain="+domain:"")+
((secure)?";secure":"");}
function Delete_Cookie(name,path,domain){if(Get_Cookie(name))
document.cookie=
name+'='+
((path)?';path='+path:'')+
((domain)?';domain='+domain:'')+
';expires=Thu, 01-Jan-1970 00:00:01 GMT';}
function get_sub_cookies(cookie){var cookies=new Array();var end='';if(cookie&&cookie!=''){end=cookie.indexOf('#')
while(end>-1){var cur=cookie.substring(0,end);cookie=cookie.substring(end+1,cookie.length);var name=cur.substring(0,cur.indexOf('='));var value=cur.substring(cur.indexOf('=')+1,cur.length);cookies[name]=value;end=cookie.indexOf('#')}}
return cookies;}
function subs_to_cookie(cookies){var cookie='';for(var i in cookies){cookie+=i+'='+cookies[i]+'#';}
return cookie;}
var isTouchBrowser=('createTouch'in document);var isIPhone=navigator.userAgent.match(/iPhone|iPod|iPad/);if(!window.console){console={is_stub:true,log:function(){},error:function(){},trace:function(){}};}
function isNode(e){return e instanceof Node;}
function isElement(e){return e instanceof Element;}
function isString(o){return(typeof(o)==='string'||o instanceof String);}
function isNumeric(s){return(typeof(s)==='number')||(typeof(s)==='string'&&(s-0)==s&&s.length);}
function isArray(o){return Array.isArray(o);}
function isObject(o){return(typeof(o)==='object');}
function isPlainObject(o){if(typeof(o)!=='object'||o===null)return false;var key;for(key in o){}
return!key||o.hasOwnProperty(key);}
function isFunction(f){return(typeof(f)==='function');}
function isWindow(o){return!!(o===window||(o&&o.document&&o.location&&o.alert&&o.setInterval));}
function isDocument(o){if(o&&o.nodeType===9)return true;}
if(!window.$){function $(sel){var t=typeof(sel);if(t=='string')return document.getElementById(sel);else if(sel!==null&&t=='object'&&sel.toElement)return sel.toElement();return sel;}}
function resolveVar(path){var ret,i;if(path&&typeof(path)=='string'&&path.match(/^[a-zA-Z0-9_\.]+$/)){ret=window;path=path.split('.');for(i=0;i<path.length&&ret;i++){if(!path[i].length||!path[i]in ret){ret=undefined;break;}
ret=ret[path[i]];}}
return ret;}
function deep_clone(obj){if(!isset(obj)||typeof(obj)!='object')return obj;if(Array.isArray(obj))return obj.map(deep_clone);var clone={};for(var property in obj){if(typeof obj[property]=='object'&&obj[property]!=null)
clone[property]=deep_clone(obj[property]);else
clone[property]=obj[property];}
return clone;}
function isdef(obj){return typeof(obj)!='undefined';}
function isset(obj){return(typeof(obj)!='undefined'&&obj!==null)?true:null;}
function blank(obj){return!isset(obj)||obj=='';}
function get_default(obj,def){return isset(obj)?obj:def;}
function extendObject(base,extend,override,restrict,debug){if(!base||!extend)return;if(!isset(override))override=true;var idx,arg,keys;if(override instanceof Array){keys=override;override=true;}
else{keys=[];if(restrict instanceof Array){for(idx=0;idx<restrict.length;idx++){arg=restrict[idx];if(arg in extend)
keys.push(arg);}}else{for(arg in extend)
if(extend.hasOwnProperty(arg))
keys.push(arg);}}
for(idx=0;idx<keys.length;idx++){arg=keys[idx];if(override===true||!(arg in base))
base[arg]=extend[arg];}
return base;}
function extendClass(subcls,base,custom){if(!base||!subcls)
throw new TypeError("Cannot extend class: not defined");subcls.prototype=Object.create(base.prototype);subcls.prototype.constructor=subcls;subcls.superclass=base.prototype;if(custom)
extendObject(subcls.prototype,custom);return subcls;}
function extendProto(base,subcls,custom,override){if(!base||!subcls)
throw new TypeError("Cannot extend class prototype: not defined");if(!isset(override))override=false;extendObject(base.prototype,subcls.prototype,override);if(custom)extendObject(base.prototype,custom);}
function setAttrs(elt,attrs){if(!attrs)return;for(var idx in attrs)
setAttr(elt,idx,attrs[idx]);}
function setAttr(elt,name,val){if(isObject(val)&&!isFunction(val)&&isset(elt[name]))
setAttrs(elt[name],val);else if(val===null&&elt.removeAttribute)
elt.removeAttribute(name);else if(elt.setAttribute&&elt.hasAttribute&&(elt.hasAttribute(name)||name=='type'||name=='class'||name=='style'||name=='action'||name=='target'))
elt.setAttribute(name,val);else if(val!==undefined)
elt[name]=val;}
function setStyle(elt,name,val){if(isElement(elt))elt.style[name]=val;}
function createElement2(name,attrs,content,parent){var elt=document.createElement(name);setAttrs(elt,attrs);if(isset(content))
AppBase.ui.setElementContent(elt,content);if(isset(parent))
parent.appendChild(elt);return elt;}
function nbsp(count){if(!isset(count))count=1;str='';while(count-->0)str+='\u00a0';return document.createTextNode(str);}
function html_escape(str){return(''+str).replace(/&/gi,'&amp;').replace(/</gi,'&lt;').replace(/>/gi,'&gt;').replace(/'/gi,'&#039;').replace(/"/gi,'&quot;');}
function html_unescape(str){return(''+str).replace(/&lt;/gi,'<').replace(/&gt;/gi,'>').replace(/&#0?39;/gi,'\'').replace(/&quot;/gi,'"').replace(/&amp;/gi,'&');}
function encodeQueryString(params,prefix,joiner){var ret=prefix||'';if(typeof(params)=='string')return ret+params;if(params){var args=[];for(var argName in params){if(!params.hasOwnProperty(argName)||!isset(params[argName]))
continue;var argValue=encodeURIComponent(params[argName]);args.push(encodeURIComponent(argName)+'='+argValue);}
ret+=args.join(joiner||'&');}
return ret;}
function parseQueryString(arg,joiner){var ret={};var params=arg.split(joiner||'&');for(var i=0;i<params.length;i++){var pair=params[i].split('=',2);ret[decodeURIComponent(pair[0])]=decodeURIComponent(pair[1]);}
return ret;}
function identityFn(v){return v;}
function cmpFn(a,b){return a-b;}
function cmpStringFn(a,b){if(typeof(a)==='string')return a.localeCompare(b);return 0;}
function cmpProperty(prop,cmp){return function(a,b){return cmp(a[prop],b[prop]);}}
function trim(s){if(!isset(s))return'';return s.toString().trim();}
function app_string(str){if(window.strings)return window.strings[str]||str;return str;}
function defaultFocus(){var test=$('defaultFocus');if(test)return test.focus();test=document.getElementsByClassName('default-focus');if(test.length)return test[0].focus();}
function viewportSize(){return{width:window.innerWidth,height:window.innerHeight};}
function onLoadPage(fn){AppBase.onDomReady(fn);}
if(!RegExp.escape)(function(){var sREpat='['+'/.*+?|()\\[]{}'.replace(/./g,'\\$&')+']',sRE=new RegExp(sREpat,'g');RegExp.escape=function(text){return text.replace(sRE,'\\$&');}})();if(!Array.flatten)
Array.flatten=function(arr){var ret=[],i=0;for(;i<arr.length;i++){if(Array.isArray(arr[i]))
ret.pushArray(arr[i]);else
ret.push(arr[i]);}
return ret;}
if(!Array.prototype.pushArray)
Array.prototype.pushArray=function(snd){for(var i=0;i<snd.length;i++)
this.push(snd[i]);return this;}
if(!Array.prototype.unique)
Array.prototype.unique=function(cmp){var ret=[],i,j;for(i=0;i<this.length;i++){if(cmp){for(j=0;j<ret.length;j++)
if(cmp(ret[j],this[i]))
break;if(j==ret.length)
ret.push(this[i]);}else{if(i===0||ret.indexOf(this[i])<0)
ret.push(this[i]);}}
return ret;}
if(!Array.prototype.remove)
Array.prototype.remove=function(val){var ret=0;for(var i=0;i<this.length;i++)
if(this[i]===val){this.splice(i--,1);ret++;}
return ret;}
if(!Array.prototype.clear)
Array.prototype.clear=function(val){this.splice(0,this.length);}
if(!Array.prototype.filter)
Array.prototype.filter=function(cmp){var ret=[],i;for(i=0;i<this.length;i++){if(cmp(this[i]))
ret.push(this[i]);}
return ret;}
if(!Array.prototype.map)
Array.prototype.map=function(fn,thisp){var ret=[],i=0;for(i=0;i<this.length;i++)
ret.push(fn.call(thisp,this[i],i,this));return ret;}
if(!Array.prototype.forEach)
Array.prototype.forEach=function(fn,thisp){for(var i=0;i<this.length;i++)
fn.call(thisp,this[i],i,this);}
if(!Array.prototype.indexOf)
Array.prototype.indexOf=function(val){for(var i=0;i<this.length;i++)
if(this[i]===val)return i;return-1;}
if(!Array.prototype.lastIndexOf)
Array.prototype.lastIndexOf=function(val){for(var i=this.length-1;i>=0;i--)
if(this[i]===val)return i;return-1;}
if(!Array.prototype.getIndexes){Array.prototype.getIndexes=function(){var ret=[],i=0;for(;i<this.length;i++)ret.push(i);return ret;}}
if(!Array.prototype.compareTo){Array.prototype.compareTo=function(arr){if(this.length!=arr.length)return false;for(var i=0;i<this.length;i++){if(this[i]!==arr[i])return false;}
return true;}}
if(!Object.assign){Object.assign=function(target,args){var idx,next;target=Object(target);for(idx=1;idx<arguments.length;idx++){next=arguments[idx];if(isset(next))
extendObject(target,next);}
return target;}}
if(!Array.range){Array.range=function(a,b,skip){if(a===undefined){a=0;}
if(b===undefined){b=a;a=0;}
if(skip===undefined){skip=a>b?-1:1;}
var ret=[];if(skip){do{if(skip>0?a>=b:a<=b)break;ret.push(a);a+=skip;}while(1);}
return ret;}}
function modulo(n,m){return((n%m)+m)%m;}
if(!Math.sign){Math.sign=function(v){if(isNaN(v))return NaN;if(v===-0)return-0;else if(v===0)return 0;else if(v>0)return 1;else if(v<0)return-1;return Math.sign(parseFloat(v));}}
if(!String.prototype.startsWith){String.prototype.startsWith=function(search,pos){return this.substr(!pos||pos<0?0:+pos,search.length)===search;}}
function DomState(App){this.dom_ready=false;this.dom_ready_hooks=[];this.dom_loaded=false;this.dom_load_hooks=[];this.onInit(function(){var wrap=App.dom.extNode;wrap(document).on('DOMContentLoaded',this.domReadyHandler.bind(this));wrap(window).on('load',this.domLoadHandler.bind(this));var st=document.readyState,i;if(st=='loaded'||st=='complete'){this.domReadyHandler();if(st=='complete')this.domLoadHandler();}});this.onDomReady=function(hook){this.dom_ready_hooks.push(hook);if(this.dom_ready)hook.call(this);}
this.domReadyHandler=function(){if(this.dom_ready)return;for(var i=0;i<this.dom_ready_hooks.length;i++)
this.dom_ready_hooks[i].call(this);this.dom_ready=true;}
this.onDomLoad=function(hook){this.dom_load_hooks.push(hook);if(this.dom_loaded)hook.call(this);}
this.domLoadHandler=function(){if(this.dom_loaded)return;for(var i=0;i<this.dom_load_hooks.length;i++)
this.dom_load_hooks[i].call(this);this.dom_loaded=true;}}
function AppModule(name,parent){this.module_name=name;this.module_parent=parent||this;this.module_app=this.module_parent.module_app||this;this.module_init=[];this.module_load=[];this.module_requires={};return this;}
AppModule.prototype={onLoad:function(hook){this.module_load.push(hook);if(this.loaded&&!this.module_extending)hook.call(this);return this;},onInit:function(hook){this.module_init.push(hook);if(this.inited&&!this.module_extending)hook.call(this);return this;},init:function(){if(arguments.length>0)
this.extendBase.apply(this,Array.prototype.slice.call(arguments));this.moduleCheckInit();return this;},moduleCheckInit:function(){var k,m,fail;if(this.inited)return;for(k in this.module_requires){if(this.module_requires[k])continue;m=this.module_parent.module(k);if(m&&!m.inited){if(this.module_requires[k]!==false){this.module_requires[k]=false;m.onLoad(this.moduleRequireLoaded.bind(this,k));}
fail=true;}
else if(!m)
fail=true;}
if(fail)return false;this.inited=true;this.moduleRunHooks(this.module_init);this.loaded=true;this.moduleRunHooks(this.module_load);return this;},moduleRunHooks:function(hooks,from){for(i=from||0;i<hooks.length;i++)
hooks[i].call(this);},moduleRequireLoaded:function(name){var m=this.module_app.module(name);if(m&&m.inited){this.module_requires[name]=true;this.moduleCheckInit();}
return this;},onDomReady:function(hook){var nm=this.module_name;this.module_parent.onDomReady(function(){this.module(nm).onInit(hook);});return this;},onDomLoad:function(hook){var nm=this.module_name;this.module_parent.onDomLoad(function(){this.module(nm).onInit(hook);});return this;},extendBase:function(){var ctor,hooks=[],i,ilen=this.module_init.length,llen=this.module_load.length;this.module_extending=true;for(i=0;i<arguments.length;i++){ctor=arguments[i];if(typeof(ctor)=='function'){ctor=ctor.call(this,this.module_app);if(ctor)extendObject(this,ctor);}
else if(ctor)
extendObject(this,ctor);}
delete this.module_extending;if(this.inited)
this.moduleRunHooks(this.module_init,ilen);if(this.loaded)
this.moduleRunHooks(this.module_load,llen);return this;},extendModule:function(name,alias){var m=this.module(name),init;if(m){init=Array.prototype.slice.call(arguments,2);m.onInit(function(){if(init.length)
this.extendBase.apply(this,init);this.moduleInitAlias(alias);});}
return m;},moduleAlias:function(name){return this.moduleInitAlias(name);},moduleExists:function(name){return(name in this&&this[name]instanceof AppModule);},moduleLoaded:function(name){return this.moduleExists(name)&&this[name].inited;},module:function(name){if(!this.moduleExists(name)){if(name in this)
throw new Error('invalid module name: '+name);this[name]=new AppModule(name,this.module_app||this);}
return this[name];},moduleParent:function(){if(this.module_parent!==this)return this.module_parent;},moduleRequires:function(name){var i,m,name,chk;for(i=0;i<arguments.length;i++){name=arguments[i];m=this.module_parent.module(name);chk=(m&&m.inited?true:null);this.module_requires[name]=chk;}
return this;},moduleInitAlias:function(name){var i,m,ihooks=[],lhooks=[];if(this.module_parent.moduleExists(name)){m=this.module_parent[name];if(m!==this){if(!m.inited)ihooks=m.module_init;if(!m.loaded)lhooks=m.module_load;}}
this.module_parent[name]=this;for(i=0;i<ihooks.length;i++)
this.onInit(ihooks[i]);for(i=0;i<lhooks.length;i++)
this.onLoad(lhooks[i]);return this;}};AppBase=new AppModule();AppBase.moduleRequires('base').init(DomState);AppBase.module('browser').init(function(App){var Caps=this;this.onInit(function(){Caps.mac=!!navigator.platform.match(/(Mac|iPhone|iPod|iPad)/i);Caps.windows=navigator.platform.substring(0,3)==='Win';var testElt=document.createElement('_');Caps.eventListenerOptions=false;try{var opts=Object.defineProperty({},'passive',{get:function(){Caps.eventListenerOptions=true;}});window.addEventListener('test',null,opts);window.removeEventListener('test',null,opts);}catch(e){}
Caps.elementClassList=('classList'in Element.prototype);if(Caps.elementClassList){testElt.classList.toggle('test',true);if(!testElt.classList.contains('test')){var _toggle=DOMTokenList.prototype.toggle;DOMTokenList.prototype.toggle=function(token,force){if(force!==undefined&&!this.contains(token)===!force){return force;}}
return _toggle.call(this,token);};}
Caps.selectorMatchMethod=null;var testMethod=['matches','mozMatchesSelector','msMatchesSelector','oMatchesSelector','webkitMatchesSelector'];for(var i=0;i<testMethod.length;i++)
if(testMethod[i]in Element.prototype)
Caps.selectorMatchMethod=testMethod[i];var test=['transform','webkitTransform','mozTransform'];Caps.transformProperty='';for(var i=0;i<test.length;i++){if(testElt.style[test[i]]!==undefined){Caps.transformProperty=test[i];break;}}
var test=['transition','webkitTransition','mozTransition'];Caps.transitionProperty='';for(var i=0;i<test.length;i++){if(testElt.style[test[i]]!==undefined){Caps.transitionProperty=test[i];break;}}
var testPfx=['','webkit','Moz'],animStart='animationstart',animIter='animationiteration',animEnd='animationend',animName='animationName',animFound=null;for(var i=0;i<testPfx.length;i++){if(testPfx[i])animName=testPfx[i]+'AnimationName';if(animName in testElt.style){animFound={supported:true,prefix:testPfx[i],name:animName};break;}}
if(animFound){if(!animFound.prefix||animFound.prefix==='Moz'){animFound.start='animationstart';animFound.iter='animationiteration';animFound.end='animationend';}else{animFound.start=animFound.prefix+'AnimationStart';animFound.iter=animFound.prefix+'AnimationIteration';animFound.end=animFound.prefix+'AnimationEnd';}}
Caps.animation=animFound||{supported:false};Caps.insetSizes={left:0,right:0,top:0,bottom:0};function testInsets(){var div=document.createElement('div'),s=div.style,sizes=Caps.insetSizes;s.paddingLeft='constant(safe-area-inset-left)';s.paddingRight='constant(safe-area-inset-right)';s.paddingTop='constant(safe-area-inset-top)';s.paddingBottom='constant(safe-area-inset-bottom)';document.body.appendChild(div);var cstyle=window.getComputedStyle(div);sizes.left=parseInt(cstyle.paddingLeft,10)||0;sizes.right=parseInt(cstyle.paddingRight,10)||0;sizes.top=parseInt(cstyle.paddingTop,10)||0;sizes.bottom=parseInt(cstyle.paddingBottom,10)||0;document.body.removeChild(div);}
AppBase.onDomReady(testInsets);window.addEventListener('orientationchange',function(){requestAnimationFrame(testInsets);});});});AppBase.module('base').moduleRequires('browser').moduleAlias('event').moduleAlias('dom').init(function(App){var Base=this,Dom=this,Evt=this;Base.dataNamespace='_1crm';Evt.keyAliases={backspace:8,'delete':46,down:40,enter:13,left:37,right:39,space:32,tab:9,up:39};Evt.priorityLevels={debug:20,custom:18,override:12,ext:10,field:8,app:6,layout:4,'default':0};Evt.getPriorityLevel=function(prio){if(typeof(prio)==='string'){if(prio in Evt.priorityLevels)return Evt.priorityLevels[prio];}
else if(typeof(prio)==='number')return prio;return Evt.priorityLevels['default'];}
Evt.compareByPriority=function(a,b){if(a.priority!=b.priority)return b.priority-a.priority;if(a.order!=b.order)return a.order-b.order;}
Dom.splitSelectors=function(type){var ret=[],prefix='',t,ts,p;if(typeof(type)==='string'){ts=type.split(',');for(var i=0;i<ts.length;i++){t=ts[i].trim();if(!t.length)continue;if(t.lastIndexOf('[')>t.lastIndexOf(']')||t.lastIndexOf('(')>t.lastIndexOf(')')){prefix+=t+',';}
else{ret.push(prefix+t);prefix='';}}}
if(prefix.length){console.error("Error parsing event type, unclosed brackets",type);return false;}
return ret;}
Dom.parseSimpleSelector=function(sel){var ret={},p,m,ext;if(typeof(sel)==='string'){while((m=sel.match(/(.*)\[(.*)\](.*)/))){var fs=m[2].split(','),fname,fval;for(var i=0;i<fs.length;i++){fname=fs[i].trim();if(!fname.length)continue;if(!ret.attrs)ret.attrs={};p=fname.indexOf('=');if(p>0){fval=fname.substring(p+1);if(fval==='true')fval=true;ret.attrs[fname.substring(0,p)]=fval;}else{ret.attrs[fname]=true;}}
sel=m[1]+m[3];}
while((m=sel.match(/(.*)([#\.!])([a-zA-Z0-9\-_]*)(.*)/))){ext=m[3].trim();if(ext.length){if(m[2]==='#'){ret.id=ext;}else if(m[2]==='.'){if(ret.className)ret.className+='.'+ext;else ret.className=ext;}
else{ret.priority=ext;}}
sel=m[1]+m[4];}
while((p=sel.lastIndexOf(':'))>=0){if(!ret.params)ret.params={};ext=sel.substring(p+1).trim();sel=sel.substring(0,p);m=ext.match(/(.+)\((.*)\)/);if(m)
ret.params[m[1]]=m[2];else
ret.params[ext]=true;}
if(sel){ret.tagName=sel.trim();return ret;}}}
Dom.splitCssClasses=function(cls){if(typeof(cls)==='string')return cls.split(' ').map(trim).filter(identityFn);else if(Array.isArray(cls))return cls;return[];}
Evt.fixListenerOptions=function(opts,asObject){if(!opts)opts=asObject?{}:false;else{if(typeof(opts)==='object'){if(!asObject&&!App.browser.eventListenerOptions)
opts=opts.capture?true:false;}else if(asObject){opts=opts?{capture:true}:{};}}
return opts;}
Dom.adjustRect=function(bounds,left,top,width,height){bounds.left+=left;bounds.top+=top;bounds.width+=width;bounds.height+=height;bounds.x=bounds.left;bounds.y=bounds.top;bounds.right=bounds.left+bounds.width;bounds.bottom=bounds.top+bounds.height;}
Dom.formatSize=function(size,def_unit){if(isset(size)){var m=(''+size).match(/^(-?[0-9]*\.?[0-9]+|[0-9]+\.[0-9]*)\s*(px|em|ex|pt|%)?$/);if(m){return m[1]+(m[2]||def_unit||'px');}}}
Dom.matchSelector=function(node,sel,scope,extData){if(node instanceof Node){if(typeof(sel)==='string'){if(App.browser.selectorMatchMethod){try{return node[App.browser.selectorMatchMethod](sel);}catch(e){console.error(e);return false;}}}else if(typeof(sel)==='function'){return sel.call(scope,node,extData);}else if(sel instanceof Node){return node===sel;}else if(sel instanceof Dom.ExtNode){return node===sel._node;}else if(sel instanceof Dom.ExtNodeList){return sel.indexOf(node)>=0;}}else if(node instanceof Dom.ExtNode)return node.matches(sel);}
Evt.getEvent=function(evt){if(evt)return Evt.ExtEvent(evt);if(window.event)return Evt.ExtEvent(window.event);}
Evt.setDragData=function(evt,transfer,values,container_elt){var dragData=Evt.globalDragData||{transfer:{},values:{}};if(transfer){for(var k in transfer){if(evt)evt.dataTransfer.setData(k,transfer[k]);dragData.transfer[k]=transfer[k];}}
if(values&&typeof(values)==='object'){extendObject(dragData.values,values);}
if(!dragData.initial_event&&evt)dragData.initial_event=evt;if(evt)dragData.target_elt=Dom.ExtNode(evt.target);if(evt&&evt.type=='dragstart')
dragData.source_elt=dragData.target_elt;if(container_elt)
dragData.container_elt=Dom.ExtNode(container_elt);Evt.globalDragData=dragData;}
Evt.getDragData=function(evt){var gData=Evt.globalDragData,is_self=false;if(!gData){if(evt){gData={initial_event:evt,target_elt:evt.currentTarget,transfer:null,values:{}};if(evt.dataTransfer.types){gData.transfer={};for(var i=0;i<evt.dataTransfer.types.length;i++){var t=evt.dataTransfer.types[i];gData.transfer[t]=evt.dataTransfer.getData(t);}}}}
if(evt&&evt.target&&gData.source_elt){var container=gData.container_elt||gData.source_elt.parentNode;if(container&&container.contains(evt.target))
is_self=true;}
if(gData&&gData.state!=='complete')
gData.self=is_self;Evt.globalDragData=gData;return gData;}
Evt.setDragState=function(evt,state,params){var gData=this.getDragData(evt);if(gData){gData.state=state;gData.state_params=(params=params||{});if(gData.source_elt)
gData.source_elt.emit('dragstate',{value:state,params:params});}}
Evt.clearDragData=function(evt){try{if(evt)evt.dataTransfer.clearData();}catch(e){}
delete Evt.globalDragData;}
Evt.ExtEvent=function(params){if(!(this instanceof Evt.ExtEvent)){var ret=new Evt.ExtEvent();if(isset(params))
ret=ret.initFrom(params);return ret;}
this.capture=null;this.currentTarget=null;this.data=null;this.delayed=false;this.ns='';this.originalEvent=null;this.passive=null;this.priority=null;this.result=null;this.selector=null;this.target=null;this.timeStamp=Date.now();this.type='';this.view=null;this.which=null;this.initFrom(params);return this;};Evt.ExtEvent.initProperties=[
'capture','data','delayed','ns','originalEvent','passive','priority','result','selector','timeStamp'
];Evt.ExtEvent.prototype={initFrom:function(params){if(typeof(params)==='string'){this._setType(params);}
else if(params instanceof Event){this._initFromEvent(params);}
else if(params instanceof Evt.ExtEvent){extendObject(this,params);}
else if(isPlainObject(params)){if(params.event){this._initFromEvent(params.event);delete params.event;}
else if(params.originalEvent){this._initFromEvent(params.originalEvent);delete params.originalEvent;}
if(params.type){this._setType(params.type);delete params.type;}
extendObject(this,params,true,Evt.ExtEvent.initProperties);}
else
return null;return this;},_initFromEvent:function(evt){var k,v;for(k in evt){v=evt[k];if(Evt.ExtEvent.initProperties.indexOf(k)>=0
||typeof(v)==='function'
||k.toUpperCase()===k)
continue;this[k]=v;}
this.originalEvent=evt;if(this.eventPhase===Event.CAPTURING_PHASE)
this.capture=true;this.cmdKey=(this.metaKey&&App.browser.mac)||(this.ctrlKey&&!App.browser.mac);evt.cmdKey=this.cmdKey;this.which=evt.which||(evt.charCode!=null?evt.charCode:evt.keyCode);},_setType:function(type){type=Dom.parseSimpleSelector(type);if(type){if(type.className)
this.ns=type.className;if(type.priority)
this.priority=type.priority;if(type.tagName)
this.type=type.tagName;}},isDefaultPrevented:function(){var e=this.originalEvent;return e.defaultPrevented||this._defaultPrevented;},isImmediatePropagationStopped:function(){return this._immedPropagationStopped;},isPropagationStopped:function(){return this._propagationStopped;},stopPropagation:function(){if(this.delayed){console.error("Cannot stop propagation on delayed event");return;}
var e=this.originalEvent;if(e)e.stopPropagation();this._propagationStopped=true;},stopImmediatePropagation:function(){if(this.delayed){console.error("Cannot stop propagation on delayed event");return;}
this._immedPropagationStopped=true;},preventDefault:function(){if(this.delayed||this.passive){console.error("Cannot prevent default behaviour on delayed or passive event");return;}
var e=this.originalEvent;if(e)e.preventDefault();this._defaultPrevented=true;},stopEvent:function(){if(this.delayed){console.error("Cannot stop delayed event");return;}
this.stopPropagation();this.preventDefault();return false;},makeDelayed:function(){var evt=new Evt.ExtEvent(this);evt.delayed=true;return evt;},position:function(){return{x:this.pageX,y:this.pageY};},inside:function(elt){var pos=this.position();if(!pos)return;var x=pos.x,y=pos.y,region=SUGAR.ui.getEltRegion(elt);return region&&x>=region.left&&x<=region.right&&y>=region.top&&y<=region.bottom;}};Evt.EventListener=function(params){this.attached=false;this.capture=false;this.data=null;this.extEvent=true;this.extTarget=false;this.filter={};this.handler=null;this.ns='';this.passive=false;this.passData=false;this.priority=null;this.scope=null;this.selector=null;this.type='';this.unq=Evt.EventListener.unq++;this.initFrom(params);};Evt.EventListener.unq=0;Evt.EventListener.prototype={initFrom:function(params){if(params instanceof Evt.EventListener){extendObject(this,params);}
else if(isPlainObject(params)){if(params.type){this._setType(params.type);}
this._extendParams(params);}
if((this.throttle||this.debounce||this.delay)&&this.handler!==false&&!this.prevent)
this.passive=true;},_extendParams:function(params){extendObject(this,params,true,['data','extEvent','extTarget','handler','ns','origHandler','passData','priority','scope','selector']);if(params.filter)
this._extendFilter(params.filter);if(isdef(params.self))
this.filter.self=params.self;},_extendFilter:function(params){if(!this.filter)this.filter={};if(isPlainObject(params)){extendObject(this.filter,params,true,['button','className','cmdKey','ctrlKey','key','metaKey','self','shiftKey','tagName','which']);}
this._splitFilter('key');},_splitFilter:function(name){if(!this.filter)return;var f=this.filter[name];if(typeof(f)==='string'){var fs=f.split('|').map(trim).filter(identityFn);this.filter[name]=fs.length?(fs.length===1?fs[0]:fs):null;}},_setType:function(type){type=Dom.parseSimpleSelector(type);if(type){if(type.className)
this.ns=type.className;if(type.priority)
this.priority=type.priority;if(type.tagName)
this.type=type.tagName;if(type.attrs)
this._extendFilter(type.attrs);if(type.params)
this._extendParams(type.params);}},_matchFilter:function(evt){var element=evt?evt.target:null,filter=this.filter;if(!element||!filter){return true;}
if(isset(filter.button)){var b=''+filter.button,mb=evt.buttons||0;if((b==='left'||b==='0')&&!(mb&1))return false;if((b==='right'||b==='2')&&!(mb&2))return false;if((b==='middle'||b==='1')&&!(mb&4))return false;}
if(filter.cmdKey&&!evt.cmdKey){return false;}
if(filter.ctrlKey&&!evt.ctrlKey){return false;}
if(filter.className&&!this._matchClass(element,filter.className)){return false;}
if(filter.key){var key=filter.key,found=false;if(Array.isArray(key)){for(var i=0;i<key.length;i++){var k=key[i];if(k in Evt.keyAliases)k=Evt.keyAliases[k];if(k&&evt.which==k){found=true;break;}}}else{if(key in Evt.keyAliases)key=Evt.keyAliases[key];if(evt.which==key)
found=true;}
if(!found)return false;}
if(filter.metaKey&&!evt.metaKey){return false;}
if(filter.self&&evt.target!==evt.currentTarget){return false;}
if(filter.shiftKey&&!evt.shiftKey){return false;}
if(filter.tagName&&!this._matchTagName(element,filter.tagName)){return false;}
if(isset(filter.which)&&evt.which!=filter.which){return false;}
return true;},_matchClass:function(elt,cls){if(!elt)return;var match=Dom.splitCssClasses(cls);for(var i=0;i<match.length;i++)
if(!elt.classList.contains(match[i]))return false;return true;},_matchSelector:function(evt){var element=evt?evt.target:null;if(!evt)return;if(!element){if(evt.selector?evt.selector!==this.selector:this.selector)return false;return true;}
if(!this.selector)return true;if(element===evt.currentTarget){return false;}
if(Dom.matchSelector(element,this.selector,this,evt)){return true;}
return false;},_matchTagName:function(elt,tag){var eltTag=elt.tagName.toUpperCase();if(typeof(tag)==='string'){tag=tag.toUpperCase();return(eltTag===tag);}
else if(Array.isArray(tag)){for(var i=0;i<tag.length;i++)
if(tag.toUpperCase()===eltTag)return true;return false;}
else{return true;}},_matchNamespace:function(evtNs){if(evtNs){if(!this.ns)return false;var ns=evtNs.split('.').map(trim).filter(identityFn),myNs=this.ns.split('.'),matchNs=[];for(var i=0;i<ns.length;i++){if(!myNs.contains(ns[i]))return false;matchNs.push(ns[i]);}
matchNs.sort();return matchNs.join('.');}
return'';},matchEvent:function(evt,handler,params){if(!evt||!evt.type||(this.type&&this.type!==evt.type))return false;if(handler&&handler!==this.handler&&handler!==this.origHandler)return false;if(isset(evt.capture)&&(this.capture?!evt.capture:evt.capture))return false;if(isset(evt.passive)&&(this.passive?!evt.passive:evt.passive))return false;var level=Evt.getPriorityLevel(this.priority);if(level<Evt.getPriorityLevel(evt.priority))return false;var ret={priority:level,ns:this._matchNamespace(evt.ns),selector:this.selector};if(ret.ns===false)return false;if(!this._matchSelector(evt))return false;if(!this._matchFilter(evt))return false;return ret;},getEventScope:function(evt){if(this.scope)return this.scope;if(!evt)return;if(!this.extTarget)return evt.currentTarget;if(!evt.extCurrentTarget||evt.extCurrentTarget._node!==evt.currentTarget)
evt.extCurrentTarget=Dom.ExtNode(evt.currentTarget);return evt.extCurrentTarget;},callHandler:function(evt,extraParams){var evtArg=evt,args;if(!this.extEvent)evtArg=evt.originalEvent;if(this.passData)extraParams=evt.data;args=[evtArg];if(Array.isArray(extraParams))
args.pushArray(extraParams);else if(extraParams!==undefined)
args.push(extraParams);return this.handler.apply(this.getEventScope(evt),args);},getDelayedHandler:function(evt,extraParams){var delayEvt=evt.makeDelayed(),self=this;return function(){if(self.attached&&self.handler)return self.callHandler(delayEvt,extraParams);}},cancelDelayedHandler:function(){if(this.handlerTimeout)
clearTimeout(this.handlerTimeout);},handleEvent:function(evt,extraParams){var ret;if(!this.attached)return;if(!this.handler){ret=false;}else{var call=true,now=Date.now(),delayEvt;evt.data=this.data;if(this.throttle){this.cancelDelayedHandler();if(this.lastInvoke&&now-this.lastInvoke<this.throttle){this.handlerTimeout=setTimeout(this.getDelayedHandler(evt,extraParams),this.throttle);call=false;}else{this.lastInvoke=now;}}
else if(this.debounce){this.cancelDelayedHandler();this.handlerTimeout=setTimeout(this.getDelayedHandler(evt,extraParams),this.debounce);call=false;}
else if(this.delay){this.handlerTimeout=setTimeout(this.getDelayedHandler(evt,extraParams),this.delay);call=false;}
if(call){ret=this.callHandler(evt,extraParams);}}
if(ret!==undefined){evt.result=ret;}
if(ret===false){evt.stopEvent();evt.stopImmediatePropagation();}
else{if(this.stop)
evt.stopPropagation();if(this.stop_immed)
evt.stopImmediatePropagation();if(this.prevent)
evt.preventDefault();}
if(this.once){return true;}},setAttached:function(flag){if(!isset(flag))flag=true;this.attached=!!flag;}};Evt.EventManager=function(target){if(target instanceof Node)return Dom.ExtNode(target);if(!(this instanceof Evt.EventManager))return new Evt.EventManager(target);this.target=target;}
Evt.EventManager.prototype={$getListeners:function(){if(!this.listeners)
this.listeners=[];return this.listeners;},$addListener:function(listen){listen.setAttached();this.$getListeners().push(listen);},$removeListener:function(listen){listen.setAttached(false);this.$getListeners().remove(listen);},$clearListeners:function(){var listen=this.$getListeners();if(listen){for(var i=0;i<listen.length;i++)
this.$removeListener(listen[i]);}},$findListeners:function(evt,handler,matchParams){var ret=[],src=this.$getListeners(),match;if(src){if(evt instanceof Evt.ExtEvent){for(var i=0;i<src.length;i++){match=src[i].matchEvent(evt,handler,matchParams);if(match){match.order=i;match.listener=src[i];ret.push(match);}}}
else if(Array.isArray(evt)){for(var i=0;i<evt.length;i++)
ret.pushArray(this.$findListeners(evt[i],handler,matchParams));ret=ret.unique();}}
if(ret.length)
ret.sort(Evt.compareByPriority);return ret;},$handleEvent:function(evt,extraParams){evt=Evt.ExtEvent(evt);if(!evt)return;var found=this.$findListeners(evt),prev_ns=evt.ns;evt.result=undefined;if(found.length){for(var i=0;i<found.length;i++){var match=found[i],listen=match.listener;evt.listener=listen;evt.ns=match.ns;evt.selector=match.selector;if(listen.handleEvent(evt,extraParams))
this.$removeListener(listen);if(evt._immedPropagationStopped)
break;}}
return evt.result;},on:function(evt,selector,data,handler,params){var listeners=this.$getListeners(),nl,ret;if(evt instanceof Evt.EventListener){if(!listeners.contains(evt)){this.$addListener(evt);}
return evt;}
else if(Array.isArray(evt)){for(var i=0;i<evt.length;i++)
this.on(evt[i],selector,data,handler,params);}
else if(typeof(evt)==='string'){var types=Dom.splitSelectors(evt);if(types&&types.length){var init={},selType=typeof(selector);if(selType==='function'
&&(typeof(data)==='function'||typeof(handler)==='function'
||data===false||handler===false)){init.selector=selector;}else if(selType==='string'){init.selector=selector;}else if(selector!==null){params=handler;handler=data;data=selector;}
if(isPlainObject(data)){init.data=data;init.handler=handler;}else{init.handler=data;params=handler;}
ret=[];for(var i=0;i<types.length;i++){init.type=types[i];nl=new Evt.EventListener(init);if(nl){if(isPlainObject(params))nl.initFrom(params);this.$addListener(nl);ret.push(nl);}}
if(types.length===1){ret=ret[0];}}}
else if(isPlainObject(evt)){var args;for(var k in evt){this.on(k,evt[k],selector);}}
else{throw new TypeError("First parameter must be a string, array, object, or EventListener");}
return this;},off:function(evt,selector,handler,params){var found;if(evt instanceof Evt.EventListener){this.$removeListener(evt);}
else if(Array.isArray(evt)){for(var i=0;i<evt.length;i++)
this.off(evt[i],selector,handler,params);}
else{if(typeof(evt)==='string'){var types=Dom.splitSelectors(evt);evt=[];if(types&&types.length){var init={type:evt},selType=typeof(selector);if(selType==='function'
&&(typeof(handler)==='function'||handler===false)){init.selector=selector;}else if(selType==='string'){init.selector=selector;}else if(selector!==null){params=handler;handler=selector;}
params=Evt.fixListenerOptions(params,true);init.capture=!!params.capture;init.passive=!!params.passive;for(var i=0;i<types.length;i++){init.type=types[i];nl=new Evt.ExtEvent(init);if(nl)evt.push(nl);}}}
else if(!(evt instanceof Evt.ExtEvent)){throw new TypeError("First parameter must be a string, array, Event or EventListener");}
params={remove:true};found=this.$findListeners(evt,handler,params);for(var i=0;i<found.length;i++)
this.$removeListener(found[i].listener);}
return this;},emit:function(evt,extraParams){this.$handleEvent(evt,extraParams);return this;}};Base.Component=function(params){this.$init(params);}
extendProto(Base.Component,Evt.EventManager,{$getListeners:function(){return this.$getData('_listeners');},$init:function(params){Object.defineProperty(this,'_owner',{value:this,configurable:true});this.$initData('_listeners',[]);if(isPlainObject(params))
extendObject(this,params);},$initData:function(name,val){if(!isset(name))return;if(typeof(name)==='object'){for(var k in name)
this.$initData(k,name[k]);}
else if(this.$getData(name)===undefined){this.$setData(name,val);}},$getData:function(name,no_init){var owner=this._owner,prop=Base.dataNamespace;if(!owner[prop]&&!no_init){if(owner instanceof Node)
owner[prop]={};else
Object.defineProperty(owner,prop,{value:{},enumerable:false,configurable:true});}
if(name===undefined){return owner[prop];}
return owner[prop]?owner[prop][name]:null;},$setData:function(name,value){if(isPlainObject(name)){extendObject(this.$getData(),name);}else if(isset(name)){this.$getData()[name]=value;}},$removeData:function(name){var data=this.$getData(undefined,true),ret=data[name];delete data[name];return ret;},$clearData:function(){var owner=this._owner,prop=Base.dataNamespace;delete owner[prop];},$defineProperty:function(name,desc,value){if(!name)throw new TypeError("Expected string: property name");var mapProp=name;if(typeof(desc)==='string')
mapProp=desc;if(!isPlainObject(desc))desc={};if('prop'in desc){mapProp=desc.prop;delete desc.prop;}
if(value!==undefined){this.$setData(mapProp,value);}
var defDesc={configurable:true,enumerable:true};if(!('get'in desc))
defDesc['get']=function(){return this.$getData(mapProp);}
if(!('set'in desc)){var updated=desc.updated;delete desc.updated;defDesc['set']=function(val){this.$setData(mapProp,val);if(updated)updated.call(this,val,name);}}
extendObject(desc,defDesc,false);Object.defineProperty(this,name,desc);}});Dom.ExtNode=function(params){if(!(this instanceof Dom.ExtNode)){if(params instanceof Dom.ExtNode)return params;else if(params instanceof Dom.ExtNodeList)return params.first();var args=[null].pushArray(arguments),ctor=Dom.ExtNode.bind.apply(Dom.ExtNode,args),ret=new ctor();return ret._node?ret:null;}
Base.Component.call(this);if(params instanceof Node||isWindow(params)){this.$initEl(params);params=arguments[1];}else if(typeof(params)==='string'&&params.length){try{params=document.querySelector(params);}catch(e){console.error(e);return;}
return Dom.ExtNode(params,Array.prototype.slice.call(arguments,1));}else if(params instanceof Dom.ElementSpec){return params.create();}else if(params!==null&&typeof(params)==='object'&&params.toElement){return Dom.ExtNode(params.toElement(),Array.prototype.slice.call(arguments,1));}
if(isPlainObject(params))
this.$init(params);}
extendClass(Dom.ExtNode,Base.Component,{$initEl:function(el){var self=this,oldData=this.$getData();Object.defineProperty(this,'_node',{value:el,configurable:true});Object.defineProperty(this,'_owner',{value:el,configurable:true});if(this.$getData('_default_handler')===undefined){this.$setData('_default_handler',this.$handleEvent.bind(this));}
this.$defineProperty('_default_handler','_default_handler');this.$initData('_handlers',[]);this.$initData('_handler_idx',0);this.$initData(oldData);Object.defineProperty(this,'nodeType',{value:el.nodeType,configurable:true});Object.defineProperty(this,'tagName',{value:el.tagName?el.tagName.toUpperCase():el.tagName,configurable:true});this.$mapEltProperty('parentNode',false);if(this.$getData('_focus_tracked')){this.$defineProperty('focused','_focused');}
if(this.$getData('_hover_tracked')){this.$defineProperty('hovered','_hovered');}},$mapEltProperty:function(name,writable,propName){if(!name)throw new TypeError();if(!isset(writable))writable=true;if(!isset(propName))propName=name;var desc={get:function(){return this._node[propName];},configurable:true,enumerable:true};if(writable){desc.set=function(val){this._node[propName]=val;return this._node[propName];};}
Object.defineProperty(this,name,desc);},$addHandler:function(name,handler,options){if(!this._node)return;var fn,self=this,handlers=this.$getData('_handlers'),idx=this.$getData('_handler_idx');if(this.$findHandler(name,handler,options)!==undefined)return;options=Evt.fixListenerOptions(options);if(!handler){fn=this._default_handler;}else{fn=function(evt,extraParams){var hook=(typeof(handler)==='string'?self[handler].bind(self):handler);var ret;if(hook)ret=hook(evt,extraParams);if(ret!==false)
ret=self._default_handler(evt,extraParams);return ret;}}
this._node.addEventListener(name,fn,options);handlers.push({idx:idx,name:name,fn:fn,origFn:handler,options:options});this.$setData('_handler_idx',++idx);return idx;},$findHandler:function(ident,fn,options){var i,handler,handlers=this.$getData('_handlers');options=Evt.fixListenerOptions(options,true);for(i=0;i<handlers.length;i++){handler=handlers[i];if(handler.idx===ident||(handler.name===ident&&handler.origFn===fn)){if(handler.options.capture===options.capture
&&handler.options.passive===options.passive){return i;}}}},$removeHandler:function(ident,fn,options){var idx=this.$findHandler(ident,fn,options),handler,handlers=this.$getData('_handlers');if(idx!==undefined){handler=handlers[idx];handlers.splice(idx,1);this._node.removeEventListener(handler.name,handler.fn,handler.options);return true;}else{this._node.removeEventListener(ident,fn,options);}},$clearHandlers:function(){var handler,handlers=this.$getData('_handlers');if(handlers){for(var i=0;i<handlers.length;i++){handler=handlers[i];this._node.removeEventListener(handler.name,handler.fn,handler.options);}
this.$setData('_handlers',[]);}},$addListener:function(listen){if(!listen)return;if(listen.type==='focus'||listen.type==='blur'){this.trackFocus();}
else if(listen.type==='mouseenter'||listen.type==='mouseleave'){this.trackHover();}
this.$addHandler(listen.type,null,{capture:listen.capture,passive:listen.passive});Base.Component.prototype.$addListener.call(this,listen);},$handleFocus:function(){this.$setData('_focused',true);},$handleBlur:function(){this.$setData('_focused',false);},trackFocus:function(flag){if(!isset(flag))flag=true;if(flag&&!this.$getData('_focus_tracked')){this.$defineProperty('focused','_focused');this.$addHandler('focus','$handleFocus',{passive:true});this.$addHandler('blur','$handleBlur',{passive:true});this.$setData('_focus_tracked',true);}},$handleMouseEnter:function(){this.$setData('_hovered',true);},$handleMouseLeave:function(){this.$setData('_hovered',false);},trackHover:function(flag){if(flag&&!this.$getData('_hover_tracked')){this.$defineProperty('hovered','_hovered');this.$addHandler('mouseenter','$handleMouseEnter',{passive:true});this.$addHandler('mouseleave','$handleMouseLeave',{passive:true});this.$setData('_hover_tracked',true);}},makeDraggable:function(flag){},makeDragTarget:function(){},get:function(){return this._node;},equals:function(b){if(!(b instanceof Dom.ExtNode))
b=Dom.ExtNode(b);return b&&b.get()===this.get();},clone:function(copyDataAndEvents){var ret=new Dom.ExtNode(this._node.cloneNode(true));if(copyDataAndEvents){var data=deep_clone(this.$getData()),handlers=this.$getData('_handlers');delete data.handlers;ret.$setData(data);if(handlers){for(var i=0;i<handlers.length;i++){ret.$addHandler(handlers[i].name,handlers[i].origFn,handlers[i].options);}}}
return ret;},appendTo:function(elt){if(elt){if(elt instanceof Dom.ExtNode)
elt._node.appendChild(this._node);else if(elt instanceof Dom.ExtNodeList){var fst=elt.get(0);if(fst)(fst.append||fst.appendChild).bind(fst)(this._node);}
else if(elt instanceof Node)
elt.appendChild(this._node);else if(elt.push)
elt.push(this._node);}
return this;},append:function(content){for(var i=0;i<arguments.length;i++){this.$insert(arguments[i]);}
return this;},prependTo:function(elt){if(elt){if(elt instanceof Dom.ExtNode)
elt._node.insertBefore(this._node,elt._node.firstChild);else if(elt instanceof Node)
elt.insertBefore(this._node,elt.firstChild);else if(elt.unshift)
elt.unshift(this._node);}
return this;},prepend:function(content){var first=this._node.firstChild;for(var i=0;i<arguments.length;i++){this.$insert(arguments[i],null,first);}
return this;},after:function(content){this.$insert(content,this.parentNode,this._node.nextSibling);return this;},before:function(content){this.$insert(content,this.parentNode,this._node);return this;},insertAfter:function(elt){if(elt){Dom.ExtNode(elt).after(this._node);}
return this;},insertBefore:function(elt){if(elt){Dom.ExtNode(elt).before(this._node);}
return this;},$insert:function(content,parent,beforeElt){if(!beforeElt)beforeElt=null;if(!parent)parent=this._node;if(parent){if(typeof(content)==='string'){parent.insertBefore(document.createTextNode(content),beforeElt);}else if(typeof(content)==='number'){parent.insertBefore(document.createTextNode(content.toString()),beforeElt);}else if(content instanceof Dom.ExtNode){parent.insertBefore(content.get(),beforeElt);}else if(content instanceof Node){parent.insertBefore(content,beforeElt);}else if(content instanceof Dom.ElementSpec){parent.insertBefore(content.toElement({ns:parent.namespaceURI}),beforeElt);}else if(Array.isArray(content)||content instanceof Dom.ExtNodeList){for(var i=0;i<content.length;i++)
this.$insert(content[i],parent,beforeElt);}}
return this;},detach:function(){if(this._node.parentNode)
this._node.parentNode.removeChild(this._node);var swap=this.$removeData('_swap');if(swap&&swap.parentNode)
swap.parentNode.removeChild(swap);return this;},remove:function(){this.detach();this.$clearHandlers();this.$clearData();return this;},reinit:function(){var el=this._node;this.$clearHandlers();this.$clearData();this.$init();this.$initEl(el);return this;},replace:function(node){if(node instanceof Dom.ExtNode)
node=node.get();if(node&&node.parentNode){node.parentNode.replaceChild(this._node,node);}
return this;},replaceWith:function(node){if(node instanceof Dom.ExtNode)
node=node.get();if(this.parentNode&&node instanceof Node){this.parentNode.replaceChild(node,this._node);}
return this;},swapIn:function(){var swap=this.$removeData('_swap');if(!this.parentNode&&swap&&swap.parentNode){swap.parentNode.replaceChild(this._node,swap);}
return this;},swapOut:function(){var swap=this.$getData('_swap');if(this.parentNode){if(!swap){swap=document.createComment('');this.$setData('_swap',swap);}
this.replaceWith(swap);}
return this;},swapWith:function(elt){if(elt){elt=Dom.ExtNode(elt);if(elt.parentNode){this.swapOut();elt.replaceWith(this);elt.replace(this.$removeData('_swap'));}}
return this;},document:function(){if(isDocument(this._node))return this;if(this._node.ownerDocument)return Dom.ExtNode(this._node.ownerDocument);if(isWindow(this._node))return Dom.ExtNode(this._node.document);},window:function(){if(isDocument(this._node))return Dom.ExtNode(this._node.defaultView);if(this._node.ownerDocument)return Dom.ExtNode(this._node.ownerDocument.defaultView);if(isWindow(this._node))return this;},contains:function(elt){var thisNode=this._node,otherNode=(elt instanceof Dom.ExtNode?elt.get():elt);return thisNode!==otherNode&&thisNode.contains(otherNode);},inDocument:function(doc){if(!(this._node instanceof Node))return false;var eltDoc=this._node.ownerDocument;if(!eltDoc||(doc&&doc!==eltDoc)||!eltDoc.body.contains(this._node))return false;return true;},isElement:function(){return this.nodeType===1;},isWindow:function(){return isWindow(this._node);},text:function(text){if(text===undefined){return this._node.textContent;}else{if(text===null)text='';this._node.textContent=text;}
return this;},html:function(content){if(content===undefined){return this._node.innerHTML;}else{if(content===null)content='';if(typeof(content)==='string')
this._node.innerHTML=content;else
this.content(content);}
return this;},content:function(content){if(content===undefined){return Array.prototype.slice.call(this._node.children);}else{this.empty();this.append(content);}
return this;},empty:function(){var node=this._node;while(node.lastChild)node.removeChild(node.lastChild);return this;},val:function(value){var type;if(this.tagName==='INPUT'||this.tagName==='TEXTAREA'||this.tagName==='SELECT'){type=this._node.getAttribute('type');if(type==='checkbox'||type==='radio'){if(value===undefined){return this.prop('checked');}else{this.prop('checked',!!value);return this;}}}
return this.prop('value',value);},attr:function(name,value){if(isPlainObject(name)){for(var k in name)
this.attr(k,name[k]);}else if(typeof(name)==='string'){if(value===undefined)return this._node.getAttribute(name);else
this._node.setAttribute(name,value);}else{throw new TypeError();}
return this;},removeAttr:function(name){this._node.removeAttribute(name);return this;},prop:function(name,value){if(isPlainObject(name)){for(var k in name)
this.prop(k,name[k]);}else if(typeof(name)==='string'){if(value===undefined)return this._node[name];else
this._node[name]=value;}else{throw new TypeError();}
return this;},removeProp:function(name){try{this._node[name]=undefined;delete this._node[name];}catch(e){console.error(e);}
return this;},addClass:function(cls){var lst=this._node.classList;if(lst&&cls){cls=Dom.splitCssClasses(cls);for(var i=0;i<cls.length;i++)
lst.add(cls[i]);}
return this;},removeClass:function(cls){var lst=this._node.classList;if(lst&&cls){cls=Dom.splitCssClasses(cls);for(var i=0;i<cls.length;i++)
lst.remove(cls[i]);}
return this;},hasClass:function(cls){var lst=this._node.classList;if(lst&&cls){cls=Dom.splitCssClasses(cls);for(var i=0;i<cls.length;i++)
if(!lst.contains(cls[i]))return false;return true;}
return false;},toggleClass:function(cls,force){var lst=this._node.classList;if(lst&&cls){cls=Dom.splitCssClasses(cls);for(var i=0;i<cls.length;i++)
lst.toggle(cls[i],force);}
return this;},css:function(name,value){if(isPlainObject(name)){for(var k in name)
this.css(k,name[k]);}else if(typeof(name)==='string'){if(!this._node.style);else if(value===undefined)return getComputedStyle(this._node).getPropertyValue(name);else if(value===null)
this._node.style.removeProperty(name);else
this._node.style[name]=value;}else if(Array.isArray(name)){var ret=[];for(var i=0;i<name.length;i++)
ret.push(this.css(name[i]));return ret;}else{throw new TypeError();}
return this;},cssSize:function(name,val){if(isPlainObject(name)){for(var k in name)
this.cssSize(k,name[k]);}else if(val===undefined){var ret=parseFloat(this.css(name));if(typeof(ret)!=='number'||isNaN(ret))ret=null;return ret;}else{this.css(name,val===null?val:Dom.formatSize(val));}
return this;},offsetParent:function(){var ret=Dom.ExtNode(this._node.offsetParent);if(ret&&ret.css('position')==='static'){ret=ret.offsetParent();}
if(!ret&&this._node)
ret=Dom.ExtNode(this._node.ownerDocument.documentElement);return ret;},offset:function(val){return this.offsetFrom(this.document(),val);},offsetFrom:function(other,val){if(!other)
other=this.offsetParent();else if(other===true)
other=this;var offset=this.bounds(other),posStyle,pos,newPos;if(val===undefined||val===null){if(!offset)return;return{left:offset.left,top:offset.top};}else if(offset){posStyle=this.css('position');if(posStyle==='static'){this.css('position',(posStyle='relative'));}
pos={left:this.cssSize('left')||0,top:this.cssSize('top')||0};if(typeof(val)==='function'){newPos=val(pos);}else{newPos={left:pos.left,top:pos.top};if('left'in val)
newPos.left+=val.left-offset.left;if('top'in val)
newPos.top+=val.top-offset.top;}
if(isPlainObject(newPos)){if('left'in newPos)
this.cssSize('left',newPos.left);if('top'in newPos)
this.cssSize('top',newPos.top);}}
return this;},position:function(val){if(val===undefined){if(isWindow(this._node)){return{left:0-window.pageXOffset,top:0-window.pageYOffset};}else if(isDocument(this._node)){return{left:0,top:0};}else{return{left:this._node.offsetLeft,top:this._node.offsetTop};}}else{return this.offsetFrom(this.offsetParent(),val);}},bounds:function(relative,scrollRelative){var rect={left:0,top:0,width:0,height:0,bottom:0,right:0},ob;if(relative){if(relative!==true){var relQ=Dom.query(relative);ob=relQ.bounds(true);if(!ob){relative=false;}
else if(scrollRelative){Dom.adjustRect(ob,0-relQ.scrollLeft(),0-relQ.scrollTop(),0,0);}}}
if(!relative)
ob={left:0-window.pageXOffset,top:0-window.pageYOffset};if(isWindow(this._node)){rect.width=window.innerWidth;rect.height=window.innerHeight;}else if(isDocument(this._node)){rect.left=0-window.pageXOffset;rect.top=0-window.pageYOffset;rect.width=this._node.documentElement.clientWidth;rect.height=this._node.documentElement.clientHeight;}else{if(!this._node.ownerDocument)return;extendObject(rect,this._node.getBoundingClientRect(),'left top width height bottom right'.split(' '));}
if(typeof(rect.left)==='number'&&ob)
Dom.adjustRect(rect,0-ob.left,0-ob.top,0,0);rect.x=rect.left;rect.y=rect.top;return rect;},hide:function(){var disp=this.css('display');if(disp&&disp!=='none')
this.$setData('_prev_display',disp);this.css('display','none');return this;},show:function(){var disp=this.$removeData('_prev_display');if(this.css('display')==='none'||this._node.style.display==='none'){if(disp)this.css('display',disp);else{this.css('display',null);if(this.css('display')==='none'){this.css('display','block');}}}
return this;},toggle:function(state){if(state===undefined){state=(this.css('display')==='none');}
if(state)this.show();else this.hide();return this;},scrollLeft:function(val){if(val===undefined||val===null){if(isWindow(this._node))return this._node.pageXOffset;return this._node.scrollLeft;}else{if(isWindow(this._node))
this._node.pageXOffset=val;else
this.node.scrollLeft=val;return this;}},scrollTop:function(val){if(val===undefined||val===null){if(isWindow(this._node))return this._node.pageYOffset;return this._node.scrollTop;}else{if(isWindow(this._node))
this._node.pageYOffset=val;else
this.node.scrollTop=val;return this;}},scrollWidth:function(){if(isWindow(this._node))return this._node.document.clientWidth;else if(isDocument(this._node))return this._node.documentElement.scrollWidth;return this._node.scrollWidth;},scrollHeight:function(){if(isWindow(this._node))return this._node.document.clientHeight;else if(isDocument(this._node))return this._node.documentElement.scrollHeight;return this._node.scrollHeight;},matches:function(sel){return Dom.matchSelector(this._node,sel,this);},find:function(sel){var nodes=new Dom.ExtNodeList();if(!sel){}else if(typeof(sel)==='string'){try{nodes.push(this._node.querySelectorAll(sel));}catch(e){console.error(e,sel);}}else if(typeof(sel)==='function'){nodes=this.find('*').filter(sel);}else if(typeof(sel)===Node||sel instanceof Dom.ExtNode){if(this.contains(sel))
nodes.push(sel);}else if(sel instanceof Dom.ExtNodeList){for(var i=0;i<sel.length;i++){if(this.contains(sel[i]))
nodes.push(sel[i]);}}
return nodes;},findFirst:function(sel){var nodes=new Dom.ExtNodeList();if(sel){if(typeof(sel)==='string'){try{nodes.push(this._node.querySelector(sel));}catch(e){console.error(e);}}else if(typeof(sel)==='function'){nodes.push(this.find('*').first(sel));}else if(typeof(sel)===Node||sel instanceof Dom.ExtNode){if(this.contains(sel))
nodes.push(sel);}else if(sel instanceof Dom.ExtNodeList){for(var i=0;i<sel.length;i++){if(this.contains(sel[i])){nodes.push(sel[i]);break;}}}}
return nodes;},children:function(sel){var nodes=new Dom.ExtNodeList(this._node.children);if(sel)nodes=nodes.filter(sel);return nodes;},parents:function(sel){var ret=new Dom.ExtNodeList();var node=this._node.parentNode;while(node&&node.nodeType===1){if(!sel||Dom.matchSelector(node,sel,this))
ret.push(node);node=node.parentNode;}
return ret;},closest:function(sel){var ret=new Dom.ExtNodeList();var node=this._node;while(node&&node.nodeType===1){if(!sel||Dom.matchSelector(node,sel,this)){ret.push(node);break;}
node=node.parentNode;}
return ret;}});Dom.makeElement=function(name,attrs,props,content){var init,i,el,cidx;if(isPlainObject(name)||name instanceof Dom.ElementSpec)
init=name;else
init=Dom.parseSimpleSelector(name);if(!init||!init.tagName){console.error("Missing element tag name");return null;}
try{if(init.ns)
el=Dom.ExtNode(document.createElementNS(init.ns,init.tagName));else
el=Dom.ExtNode(document.createElement(init.tagName));}catch(e){console.error('Error creating element: '+init.tagName);throw e;}
if(init.id)
el.prop('id',init.id);if(init.className)
el.addClass(init.className.replace(/\./g,' '));if(init.attrs)
el.attr(init.attrs);if(init.props)
el.prop(init.props);if(init.content)
el.content(init.content);if(init.params){if(init.params.checked)el.prop('checked',true);if(init.params.hidden)el.hide();}
cidx=1;if(isPlainObject(attrs)){el.attr(attrs);cidx=2;}
if(isPlainObject(props)){el.prop(props);cidx=3;}
for(i=cidx;i<arguments.length;i++)
el.append(arguments[i]);return el;}
Dom.ElementSpec=function(init,attrs,props,content){if(!(this instanceof Dom.ElementSpec)){if(init instanceof Dom.ElementSpec)return init;var args=[null].pushArray(arguments),ctor=Dom.ElementSpec.bind.apply(Dom.ElementSpec,args);return new ctor();}
if(isPlainObject(init)||init instanceof Dom.ElementSpec)
extendObject(this,init);else if(typeof(init)==='string'){init=Dom.parseSimpleSelector(init);if(init)extendObject(this,init);}
var cidx=1;if(isPlainObject(attrs)){this.attr(attrs);cidx=2;}
if(isPlainObject(props)){this.prop(props);cidx=3;}
for(i=cidx;i<arguments.length;i++)
this.append(arguments[i]);}
Dom.ElementSpec.prototype={attr:function(name,val){if(!name)return;if(!this.attrs){this.attrs={};}
if(isPlainObject(name))
extendObject(this.attrs,name);else if(isset(val))
this.attrs[name]=val;else
delete this.attrs[name];return this;},prop:function(name,val){if(!name)return;if(!this.props){this.props={};}
if(isPlainObject(name))
extendObject(this.props,name);else if(isset(val))
this.props[name]=val;else
delete this.props[name];return this;},append:function(data){if(isset(this.content)){if(!Array.isArray(this.content))
this.content=[this.content];}else
this.content=[];if(Array.isArray(data)){for(var elt in data)
this.append(elt);return;}
this.content.push(data);return this;},create:function(params){var from=this;if(params&&params.ns){from=new Dom.ElementSpec(this);from.ns=params.ns;}
return Dom.makeElement(from);},toElement:function(params){var elt=this.create(params);if(elt)return elt.get();}};Dom.ExtNodeList=function(sel){if(!(this instanceof Dom.ExtNodeList)){if(sel instanceof Dom.ExtNodeList)return sel;return new Dom.ExtNodeList(sel);}
Array.call(this);this.$init(sel);}
Dom.htmlTempElt=document.createElement('div');extendClass(Dom.ExtNodeList,Array,{$init:function(sel){if(typeof(sel)==='string'&&sel.length){if(sel[0]==='<'){var div=Dom.htmlTempElt;div.innerHTML=sel;this.pushArray(div.childNodes);}else{try{this.pushArray(document.querySelectorAll(sel));}catch(e){console.error(e);}}}
else
this.push(sel);},clone:function(dataAndEvents){return this.map(function(node){return Dom.ExtNode(node).clone(dataAndEvents);});},push:function(elt){if(elt instanceof Node||isWindow(elt))
Array.prototype.push.call(this,elt);else if(elt instanceof Dom.ExtNode&&elt._node)
Array.prototype.push.call(this,elt._node);else if(elt&&elt.toElement)
this.push(elt.toElement());else if(Array.isArray(elt)||elt instanceof Dom.ExtNodeList||elt instanceof NodeList||elt instanceof HTMLCollection)
this.pushArray(elt);return this;},pushUnique:function(elt){if(elt instanceof Node||isWindow(elt)){if(this.indexOf(elt)<0)
Array.prototype.push.call(this,elt);}
else if(elt instanceof Dom.ExtNode&&elt._node)
this.pushUnique(elt._node);else if(elt&&elt.toElement)
this.pushUnique(elt.toElement());else
this.pushArrayUnique(elt);return this;},pushArray:function(elts){if(!elts)return;if(elts instanceof NodeList||elts instanceof HTMLCollection)return Array.prototype.pushArray.call(this,elts);else{for(var i=0;i<elts.length;i++)
this.push(elts[i]);}
return this;},pushArrayUnique:function(elts){if(!elts)return;for(var i=0;i<elts.length;i++)
this.pushUnique(elts[i]);return this;},get:function(index){if(!isset(index))return Array.prototype.slice.call(this);return this[index];},ext:function(index){if(!isset(index))return this.map(Dom.ExtNode);if(!(index in this))return null;return Dom.ExtNode(this[index]);},eq:function(index){var ret=new Dom.ExtNodeList();if(index<0)index=this.length+index;ret.push(this[index]);return ret;},visit:function(method,thisp){var node;for(var i=0;i<this.length;i++){node=Dom.ExtNode(this[i]);method.call(thisp||node,node,i,this);}
return this;},applyEach:function(method){var args=Array.prototype.slice.call(arguments,1);if(typeof(method)==='string')
method=Dom.ExtNode.prototype[method];if(method)
for(var i=0;i<this.length;i++){method.apply(Dom.ExtNode(this[i]),args);}
return this;},hasClass:function(cls,all){var ret=null;cls=Dom.splitCssClasses(cls);for(var i=0;i<this.length;i++){ret=Dom.ExtNode(this[i]).hasClass(cls);if(all&&!ret)break;if(!all&&ret)break;}
return ret;},text:function(content){var ret=this;if(content===undefined){ret=[];for(var i=0;i<this.length;i++){ret.push(Dom.ExtNode(this[i]).text());}
ret=ret.join();}else{this.applyEach(Dom.ExtNode.prototype.text,content);}
return ret;},content:function(content){var ret;if(content===undefined){ret=[];for(var i=0;i<this.length;i++){ret.pushArray(Dom.ExtNode(this[i]).content());}}else{this.applyEach(Dom.ExtNode.prototype.content,content);ret=this;}
return ret;},filter:function(sel){var ret=new Dom.ExtNodeList();for(var i=0;i<this.length;i++){if(Dom.matchSelector(this[i],sel,this,i))
ret.push(this[i]);}
return ret;},first:function(sel){var ret=new Dom.ExtNodeList();if(sel!==undefined){for(var i=0;i<this.length;i++){if(Dom.matchSelector(this[i],sel,this,i)){ret.push(this[i]);break;}}}else
ret.push(this[0]);return ret;},find:function(sel){var ret=new Dom.ExtNodeList();for(var i=0;i<this.length;i++){ret.pushArrayUnique(Dom.ExtNode(this[i]).find(sel));}
return ret;},findFirst:function(sel){var ret;for(var i=0;i<this.length;i++){ret=Dom.ExtNode(this[i]).findFirst(sel);if(ret.length)break;}
if(!ret)ret=new Dom.ExtNodeList();return ret;},children:function(sel){var ret=new Dom.ExtNodeList();for(i=0;i<this.length;i++){ret.pushArrayUnique(Dom.ExtNode(this[i]).children(sel));}
return ret;},parents:function(sel){var ret=new Dom.ExtNodeList();for(var i=0;i<this.length;i++){ret.pushArrayUnique(Dom.ExtNode(this[i]).parents(sel));}
return ret;},closest:function(sel){var ret=new Dom.ExtNodeList();for(var i=0;i<this.length;i++){ret.pushArrayUnique(Dom.ExtNode(this[i]).closest(sel));}
return ret;},unique:function(){var ret=new Dom.ExtNodeList();return ret.pushArrayUnique(this);},$makeUnique:function(){for(var i=this.length-1;i>=0;i--){if(this.indexOf(this[i])!==i)
this.splice(i,1);}
return this;}});var nodeListInherit=[
'on','off','emit','append','appendTo','prepend','prependTo','before','after','insertBefore','insertAfter','detach','remove','swapIn','swapOut','replaceWith','removeAttr','removeProp','empty','addClass','removeClass','toggleClass','hide','show'
],mapperAll=function(method){if(typeof(method)==='string')
method=Dom.ExtNode.prototype[method];return function(args){var i,node;for(i=0;i<this.length;i++){node=Dom.ExtNode(this[i]);method.apply(node,arguments);}
return this;}},mapperFirst=function(method,checkIdx,objFirst){if(typeof(method)==='string')
method=Dom.ExtNode.prototype[method];return function(args){var i,node;if(checkIdx===undefined||arguments[checkIdx]===undefined
||(checkIdx==0&&arguments[checkIdx]===null)
||(objFirst&&arguments[0]!==null&&typeof(arguments[0])==='object')){if(this.length){node=Dom.ExtNode(this[0]);return method.apply(node,arguments);}
return;}else{for(i=0;i<this.length;i++){node=Dom.ExtNode(this[i]);method.apply(node,arguments);}}
return this;}};for(var i=0;i<nodeListInherit.length;i++){var method=nodeListInherit[i];Dom.ExtNodeList.prototype[method]=mapperAll(method);}
Dom.ExtNodeList.prototype.attr=mapperFirst('attr',1,true);Dom.ExtNodeList.prototype.bounds=mapperFirst('bounds');Dom.ExtNodeList.prototype.css=mapperFirst('css',1,true);Dom.ExtNodeList.prototype.cssSize=mapperFirst('cssSize',1,true);Dom.ExtNodeList.prototype.html=mapperFirst('html',0);Dom.ExtNodeList.prototype.inDocument=mapperFirst('inDocument');Dom.ExtNodeList.prototype.isElement=mapperFirst('isElement');Dom.ExtNodeList.prototype.offset=mapperFirst('offset',0);Dom.ExtNodeList.prototype.offsetFrom=mapperFirst('offsetFrom',1);Dom.ExtNodeList.prototype.offsetParent=mapperFirst('offsetParent');Dom.ExtNodeList.prototype.position=mapperFirst('position');Dom.ExtNodeList.prototype.prop=mapperFirst('prop',1,true);Dom.ExtNodeList.prototype.scrollLeft=mapperFirst('scrollLeft',0);Dom.ExtNodeList.prototype.scrollTop=mapperFirst('scrollTop',0);Dom.ExtNodeList.prototype.scrollWidth=mapperFirst('scrollWidth');Dom.ExtNodeList.prototype.scrollHeight=mapperFirst('scrollHeight');Dom.ExtNodeList.prototype.toggle=mapperFirst('toggle');Dom.ExtNodeList.prototype.val=mapperFirst('val',0);Dom.elementOrId=function(elt){if(typeof(elt)==='string'&&elt.length)elt=document.getElementById(elt);elt=Dom.ExtNode(elt);if(!elt||(!elt.isElement()&&!elt.isWindow()))return;return elt;}
Dom.query=Dom.ExtNodeList;Dom.queryFirst=function(sel){return Dom.ExtNodeList(Dom.ExtNode(sel));}
Dom.queryId=function(elt){if(typeof(elt)==='string'&&elt.length)elt=document.getElementById(elt);return Dom.query(elt);}
Dom.extNode=Dom.ExtNode;});AppBase.extendModule('base','ui',function(App){var UI=this,wrap=App.dom.extNode,queryId=App.dom.queryId,makeElt=App.dom.makeElement,$window=wrap(window),$document=wrap(document);UI.onInit(function(){$window.on('resize:throttle(50)',this.resizeHandler.bind(this));$window.on('scroll:throttle(50)',this.scrollHandler.bind(this));this.onDomLoad(this.layoutUpdated);});this.layoutUpdated=function(){clearTimeout(UI.layoutTimer);UI.layoutTimer=setTimeout(function(){UI.layoutTimer=null;UI.resizeHandler();UI.scrollHandler();},150);}
this.resizeHandler=function(evt){if(!document.body)return;var sz={w:window.innerWidth,h:window.innerHeight},last=$window.$getData('_last_size');if(evt&&last&&last.w===sz.w&&last.h===sz.h)return;if(!last){last=deep_clone(sz);last.first=true;}
$window.emit('resize-safe',[sz,last]);$window.$setData('_last_size',sz);}
this.addResizeHook=function(callb,scope,data){$window.on('resize-safe',callb,{scope:scope,data:data});}
this.scrollHandler=function(evt){if(!document.body)return;var pos={x:window.pageXOffset,y:window.pageYOffset},last=$window.$getData('_last_scroll');if(evt&&last&&last.x===pos.x&&last.y===pos.y)return;if(!last){last=deep_clone(pos);last.first=true;}
$window.emit('scroll-safe',[pos,last]);$window.$setData('_last_scroll',pos);}
this.addScrollHook=function(callb,scope,data){$window.on('scroll-safe',callb,{scope:scope,data:data});}
this.getViewport=function(margin,modal){var ret=$window.bounds();var insets=App.browser.insetSizes;if(margin===true){if(ret.width<1000)margin=5;else margin=12;}
ret.margin=margin=margin||0;ret.doc_width=$document.scrollWidth()-2*margin;ret.doc_height=$document.scrollHeight()-2*margin;ret.window_width=ret.width;ret.window_height=ret.height;var view_size={width:document.documentElement.clientWidth-insets.left-insets.right,height:document.documentElement.clientHeight-insets.top-insets.bottom};ret.view_width=view_size.width-2*margin;ret.view_height=view_size.height-2*margin;var menuvis=(margin&&!modal)?1:0,offset=(App.themes&&App.themes.topMenuSize)?App.themes.topMenuSize(menuvis):null,header=queryId('tbarDiv').bounds();if(header&&menuvis){var hoffs=header.bottom+margin-ret.y;offset=Math.max(0,isset(offset)?Math.min(offset,hoffs):hoffs);}
ret.offset=offset||0;if(modal&&isIPhone){ret.width=view_size.width-insets.left-insets.right;ret.height=view_size.height-insets.top-insets.bottom;}
ret.y+=ret.offset+insets.top;ret.top+=ret.offset+insets.top;ret.x+=insets.left;ret.left+=insets.left;ret.height-=ret.offset+insets.left-insets.right;ret.body_width=document.body.offsetWidth;ret.body_height=document.body.offsetHeight;UI.adjustRect(ret,margin,margin,-2*margin,-2*margin);return ret;}
this.getEltRegion=function(elt,outer){return queryId(elt).bounds(queryId(outer));}
this.getTransformProperty=function(){return App.browser.transformProperty;}
this.getTransitionProperty=function(){return App.browser.transitionProperty;}
this.addClass=function(elt,className){queryId(elt).addClass(className);}
this.removeClass=function(elt,className){queryId(elt).removeClass(className);}
this.hasClass=function(elt,className){return queryId(elt).hasClass(className);}
this.toggleClass=this.addRemoveClass=function(elt,className,state){var node=queryId(elt);node.toggleClass(className,state);return node.hasClass(className);}
this.setDisplayState=function(elt,value){queryId(elt).toggle(!!value);}
this.addEventListener=function(elt,name,callb,scope,data,options){var opts={scope:scope,data:data,passData:true,extEvent:true,extTarget:false};if(!elt||!callb)return;if(isPlainObject(options)){opts.capture=options.capture;opts.passive=options.passive;}else if(options){opts.capture=true;}
queryId(elt).on(name,callb,opts);return{name:name,listener:callb,options:options,compat:true};}
this.addEventListeners=function(elt,evts,scope,data,options){var ret=[];if(elt&&evts){for(name in evts){ret.push(this.addEventListener(elt,name,evts[name],scope,data,options));}}
return ret;}
this.removeEventListener=function(elt,evt,fn,options){if(elt&&evt){if(fn){options=options?Base.fixListenerOptions(options,true):null;queryId(elt).off(evt,fn,options);}
else if(evt.name)
queryId(elt).off(evt.name,evt.listener,evt.options);}}
this.removeEventListeners=function(elt,evts){if(evts){for(i=0;i<evts.length;i++)
this.removeEventListener(elt,evts[i]);}}
this.stopPropagation=function(evt){if(evt)evt.stopPropagation();}
this.preventDefault=function(evt){if(evt)evt.preventDefault();}
this.stopEvent=function(evt){if(evt){evt.stopPropagation();evt.preventDefault();}
return false;}
this.clearChildNodes=function(elt){queryId(elt).empty();}
this.removeNode=function(elt,fullRemove){if(fullRemove)queryId(elt).remove();else queryId(elt).detach();}
this.inDocument=function(elt,doc){return queryId(elt).inDocument(doc);}
this.isAncestor=function(parent,child){var p=wrap(parent),c=wrap(child);if(!parent||!child)return false;return p.contains(c);}
this.getElementText=function(elt){return queryId(elt).text();}
this.setElementText=function(elt,text){if(text===undefined)text=null;queryId(elt).text(text);}
this.addElementContent=function(elt,content){queryId(elt).append(content);}
this.setElementContent=function(elt,content){if(content===undefined)content=null;queryId(elt).content(content);}
this.setWidth=function(elt,width,def_unit){width=UI.formatSize(width,def_unit);if(width)
elt.style.width=width;}
this.createIcon=function(icon_name,parent){if(icon_name&&icon_name.indexOf('-')<0)icon_name='theme-icon module-'+icon_name;return makeElt({tagName:'div',className:'input-icon '+icon_name,parent:parent}).get();}});AppBase.module('animation').moduleRequires('dom').init(function(App){var fromArray=function(arr){return function(percent,index){return arr[index];}}
var setter=function(name){return function(value){this.animationProps[name]=value;return this;}}
var addStyle=function(animation){if(animation.styleAdded)return;var styleTag=document.createElement("style");var prefix=App.browser.animation.prefix?'-'+App.browser.animation.prefix+'-':'';var text='@'+prefix+'keyframes '+animation.name+' {\n';Object.keys(animation.keyframes).map(parseFloat).sort(function(a,b){return a-b}).forEach(function(percent){text+=percent+'% {\n';Object.keys(animation.keyframes[percent]).forEach(function(key){text+=key+': '+animation.keyframes[percent][key]+';\n';});text+='}\n';});text+='}\n';styleTag.textContent=text;document.head.appendChild(styleTag);animation.styleAdded=true;}
var Animation=function(){this.name='anim'+(Math.random()+'').substring(2);this.keyframes={'0':{},'100':{}};this.animationProps={delay:0,direction:'normal',duration:0,'fill-mode':'none','iteration-count':1,'timing-function':'linear'
};this.styleAdded=false;this.handlers={};}
Animation.prototype.from=function(rules,replace){this.add(0,rules,replace);return this;}
Animation.prototype.to=function(rules,replace){this.add(100,rules,replace);return this;}
Animation.prototype.add=function(percent,rules,replace){var pc=percent==='from'?0:(percent==='to'?100:parseFloat(percent));if(isNaN(pc)||pc<0||pc>100||typeof rules!=='object')return;if(replace||!isset(this.keyframes[pc]))
this.keyframes[pc]=rules;else
Object.assign(this.keyframes[pc],rules);return this;}
Animation.prototype.distribute=function(){var count,create,from,to;var args=Array.prototype.slice.call(arguments);args=args.map(function(arg){var num=parseFloat(arg);if(!isNaN(num))return num;return arg;});var signature=args.map(function(x){return Array.isArray(x)?'array':typeof x;}).join('|');switch(signature){case'number|number|array':
from=args[0];to=args[1];count=args[2].length-1;create=fromArray(args[2]);break;case'array':
from=0;to=100;count=args[0].length-1;create=fromArray(args[0]);break;case'number|number|number|function':
from=args[0];to=args[1];count=args[2];create=args[3];break;case'number|function':
from=0;to=100;count=args[0];create=args[1];break;default:return this;}
count=parseInt(count);if(count<1)return this;if(from<0||from>100||to<0||to>100||from>to)return this;var percent=from;var step=(to-from)/count;for(var i=0;i<=count;i++){this.add(percent,create(percent,i));percent+=step;}
return this;}
Animation.prototype.delay=setter('delay');Animation.prototype.direction=setter('direction');Animation.prototype.duration=function(duration){if(typeof duration==='string')
this.animationProps.duration=duration;else
this.animationProps.duration=duration+'ms';return this;}
Animation.prototype.fillMode=setter('fill-mode');Animation.prototype.iterations=setter('iteration-count');Animation.prototype.timing=setter('timing-function');Animation.prototype.onStart=function(handler){this.handlers.start=handler;return this;}
Animation.prototype.onEnd=function(handler){this.handlers.end=handler;return this;}
Animation.prototype.onIteration=function(handler){this.handlers.iteration=handler;return this;}
Animation.prototype.run=function(node){var self=this;addStyle(this);var nodes=new App.dom.ExtNodeList(node);var css={};Object.keys(this.animationProps).forEach(function(key){css['animation-'+key]=this.animationProps[key];}.bind(this));css['animationName']=this.name;var handleStart=function(evt){var args=Array.prototype.slice.call(arguments);if(typeof self.handlers.start==='function')
self.handlers.start.apply(this,args);}
var handleEnd=function(){var args=Array.prototype.slice.call(arguments);if(typeof self.handlers.end==='function')
self.handlers.end.apply(this,args);}
var handleIteration=function(){var args=Array.prototype.slice.call(arguments);if(typeof self.handlers.iteration==='function')
self.handlers.iteration.apply(this,args);}
nodes.visit(function(node){node.off('animationstart')
node.off('animationend');node.off('animationiteration');node.css(css);var start=handleStart.bind(this);var end=handleEnd.bind(this);var iter=handleIteration.bind(this);node.on('animationstart',start);node.on('animationend',function(ev){end(ev);node.off('animationstart',start);node.off('animationend',end);node.off('animationiteration',iter);});node.on('animationiteration',iter);});}
this.Animation=Animation;});AppBase.module('conn').init(function(App){var Conn=this;this.loaded=true;this.reqCount=0;this.pendingConns={};this.asyncRequest=function(url,params,callback,errback){var req=new HTTPRequest(url||'async.php',params);return req.fetch(callback,errback);}
this.sendForm=function(form,conn_params,callback,errback,custom_values){var req=new HTTPRequest(null,conn_params);req.setUrl(null);if(req.loadForm(form,custom_values)){if(form.name){for(var k in this.pendingConns){if(!this.pendingConns[k].loaded&&this.pendingConns[k].requireForm===form.name)
this.pendingConns[k].abort();}}
if(conn_params&&conn_params.url)
req.setUrl(conn_params.url);else if(!req.getUrl())
req.setUrl('async.php');req.sentForm=form;req.fetch(callback,errback);return req;}}
this.abortAll=function(criteria){Conn.abortingAll=true;var conns=Conn.pendingConns;if(conns){for(var k in conns)
if(conns[k]&&(!criteria||criteria(conns[k])))
conns[k].abort();}
Conn.abortingAll=false;}
this.abortPageRequests=function(){Conn.abortAll(function(c){return!c.global;});}
this.abortRequest=function(id){var conn=Conn.pendingConns[id];if(conn)conn.abort();}
var FormArgs=function(classic){this.classic=classic;if(window.FormData&&!classic)
this.fdata=new FormData();else
this.args=[];}
FormArgs.prototype={append:function(key,value){if(!isset(key))return;value=get_default(value,'');if(this.fdata){if(value.push){for(var v=0;v<value.length;v++)
this.fdata.append(key,value[v]);}else
this.fdata.append(key,value);}else{key=encodeURIComponent(key);if(value.push){for(var v=0;v<value.length;v++)
this.args.push(key+'='+encodeURIComponent(value[v]));}else{this.args.push(key+'='+encodeURIComponent(value));}}},getData:function(){if(this.fdata)return this.fdata;return this.args.join('&');},addFile:function(f){if(this.classic){if(!this.files)this.files=[];this.files.push(f);}else if(f.files&&f.files[0])
this.append(f.name,f.files[0]);},getFiles:function(){return(this.files&&this.files.length)?this.files:null;}}
this.FormArgs=FormArgs;var HTTPRequest=function(url,params){this.url=url||'index.php';this.method='GET';this.args=null;this.postData=null;this.silent=false;this.status_msg=app_string('LBL_LOADING');this.content_type='application/x-www-form-urlencoded';this.timeout=60000;this.max_retries=0;this.async=true;this.request_id=(++Conn.reqCount);if(params){if(params.postData){this.loadPostData(params.postData);delete params.postData;}
extendObject(this,params);}
this.retries=0;this.progressPercent=null;}
HTTPRequest.prototype={setMethod:function(method){this.method=method;},setArgs:function(args){this.args=args;},setPostData:function(data){this.method='POST';this.postData=data;},loadPostData:function(data){if(this.method=='GET')
this.method='POST';if(typeof(data)=='object')
this.setPostData(encodeQueryString(data));else
this.setPostData(data);},setUrl:function(url){this.url=url;},getMethod:function(){return this.method;},getArgs:function(){return this.args;},getPostData:function(){if(!isset(this.postData)||this.postData==='')return null;return this.postData;},getUrl:function(){return this.url;},loadForm:function(form,custom_values){var form=$(form)||document.forms[form];if(!form)return false;var method=(form.getAttribute('method')||'').toUpperCase(),action=form.getAttribute('action'),args=new FormArgs(true);this.loadFormValues(form,args,custom_values);if(method=='GET'||method=='POST')
this.setMethod(method);if(isset(action))
this.setUrl(action);if(this.method=='GET')
this.setArgs(args.getData());else
this.setPostData(args.getData());if(method=='POST')
this.setFiles(args.getFiles());return true;},loadFormValues:function(form,args,custom_values){var skip_custom={};if(!custom_values)
custom_values={};for(var i=0;i<form.elements.length;i++){var elt=form.elements[i],key=get_default(elt.name,''),value;if(!key.length)
continue;if(isset(custom_values[key])){args.append(key,custom_values[key]);skip_custom[key]=1;continue;}
if(((elt.type=='radio'||elt.type=='checkbox')&&!elt.checked)
||(elt.tagName=='BUTTON'||elt.type=='button'||elt.type=='submit'||elt.type=='reset'))
continue;if(elt.type=='file'){if(elt.value)
args.addFile(elt);continue;}
if(elt.type=='select-one'&&elt.selectedIndex<0)
continue;if(elt.type=='select-multiple'){for(var j=0;j<elt.options.length;j++){var opt=elt.options[j];if(opt.selected)
args.append(key,opt.value);}}else{args.append(key,elt.value);}}
for(var key in custom_values){if(!skip_custom[key]){args.append(key,custom_values[key]);}}
return args;},addFile:function(f,params,file_list){if(!this.files)this.files=[];this.files.push({input:f,name:f.name,params:params,files:file_list});},setFiles:function(fs){this.files=[];if(fs){for(var i=0;i<fs.length;i++){this.files.push({input:fs[i],name:fs[i].name});}}},revertFileInputs:function(clear){if(this.files){for(var i=0;i<this.files.length;i++)
this.fileReplaceStub(this.files[i],true,clear);this.files=[];}},fileReplaceStub:function(f,revert,clear){if(!f.input)return;if(revert){if(f.stub.parentNode)
f.stub.parentNode.replaceChild(f.input,f.stub);f.input.name=f.name;if(clear)
f.input.value='';return f.input;}else{var fname=((f.files&&f.files.length)?f.files[0].name:f.input.value),m=fname.match(/([^\/\\]+)$/);if(m)fname=m[1];f.stub=createElement2('div',{className:'input-label'},fname);f.save=createElement2('input',{type:'hidden',name:f.name},null,f.stub);if(f.input.parentNode)
f.input.parentNode.replaceChild(f.stub,f.input);return f.stub;}},fail:function(msg){this.setDuration();this.success=false;this.failure_msg=msg;this.setReadyState(0);this.hideStatus();this.oncomplete();this.onerror.apply(this.callback_scope||this,[null,this]);this.cleanup();},getRequest:function(){var url=this.getUrl();var args=encodeQueryString(this.getArgs());if(args!==''){if(url.lastIndexOf('?')!=-1)
url+='&';else
url+='?';url+=args;}
return url;},setReadyState:function(state){this.readyState=state;this.onreadystatechange(state);},reset:function(){this.resetConnection();},resetConnection:function(){this.conn=null;this.success=null;this.setReadyState(0);this.responseText='';this.responseXML=null;this.status=0;this.statusText='';this.progressPercent=null;},open:function(){this.reset();this.openStart=new Date();var c=new XMLHttpRequest(),method=this.getMethod(),action=this.getRequest(),self=this;try{c.open(method,action,this.async?true:false);}catch(e){return this.fail("error opening connection");}
if(this.async&&isset(c.ontimeout)&&isset(this.timeout)){c.timeout=this.timeout;c.ontimeout=function(){self.ontimeout();}}
if(this.async){c.onreadystatechange=function(){self._onreadystatechange();}
if(this.timeout&&!c.timeout){}
if(c.upload)
c.upload.addEventListener("progress",function(evt){self.uploadProgress(evt)},false);}
if(this.content_type){if(!window.FormData||!(this.postData instanceof FormData))
c.setRequestHeader('Content-Type',this.content_type);}
this.conn=c;if(c.readyState!=1)return this.fail("connection not ready");this.setReadyState(1);return true;},fetchSync:function(){this.async=false;return this.fetch();},fetch:function(callback,errback){this.fetchStart=new Date();if(callback)
this.onresponse=callback;if(errback)
this.onerror=errback;if(this.async&&this.files&&this.files.length)return this.uploadFiles();return this.performFetch();},performFetch:function(){if(!this.silent&&this.status_msg)
this.showStatus(this.status_msg);if(this.open()){Conn.pendingConns[this.request_id]=this;var data=this.getPostData();this.conn.send(data);}
if(!this.async){this._onreadystatechange();if(!this.success){if(this.success===null)return this.fail(this.failure_msg||"unspecified connection failure");return;}
return this.getResult();}
return this;},uploadFiles:function(){var me=this,f,newname,i,j;if(window.FormData){var req,data=new FormData();data.append('user_id',SUGAR.session.user_id);for(i=0;i<this.files.length;i++){newname='file'+i;f=this.files[i];if(!(f.files&&f.files.length)&&!(f.input&&f.input.files&&f.input.files.length))continue;data.append(newname+'_meta',f.name);if(f.params){for(j=0;j<f.params.length;j++)
data.append(newname+'_'+f.params[j].name,f.params[j].value);}
this.fileReplaceStub(f);f.upload_name=newname;if(f.files)
data.append(newname,f.files[0]);else
data.append(newname,f.input.files[0]);}
req=new JSONRequest(null,{url:'upload.php',content_type:'multipart/form-data'},data),req.fetch(function(){me.checkLoad=true;me.completeUpload(this.result);});return;}
if(!this.iframe){if(!this.iframe_id)
this.iframe_id='conn_upload_'+this.request_id;this.iframe=createElement2('iframe',{id:this.iframe_id,name:this.iframe_id,style:{display:'none'}},null,document.body);setAttrs(this.iframe,{display:'block',position:'absolute',right:0,bottom:0,width:'200px',height:'200px'});App.ui.addEventListener(this.iframe,'load',this.completeUpload,this);}
this.upload_form=createElement2('form',{target:this.iframe_id,method:'POST',encoding:'multipart/form-data',action:'upload.php'});createElement2('input',{type:'hidden',name:'user_id',value:SUGAR.session.user_id},null,this.upload_form);createElement2('input',{type:'hidden',name:'setvar',value:'upload_result'},null,this.upload_form);for(i=0;i<this.files.length;i++){newname='file'+i;f=this.files[i];if(!f.input)continue;createElement2('input',{type:'hidden',name:newname+'_meta',value:f.name},null,this.upload_form);if(f.params){for(j=0;j<f.params.length;j++){createElement2('input',{type:'hidden',name:newname+'_'+f.params[j].name,value:f.params[j].value},null,this.upload_form);}}
this.fileReplaceStub(f);f.upload_name=f.input.name=newname;}
this.iframe.appendChild(this.upload_form);this.showStatus(app_string('LBL_UPLOADING'));setTimeout(function(){me.checkLoad=true;me.upload_form.submit();},500);},completeUpload:function(result){if(!this.checkLoad)return;var i,f;this.hideStatus();if(this.iframe){result=this.iframe.contentWindow.upload_result;document.body.removeChild(this.iframe);this.iframe=null;}
if(!result||!result.files){for(i=0;i<this.files.length;i++){this.fileReplaceStub(this.files[i],true);this.files[i].result={error:1};}
return this.fail("File upload failed");}else{var revert=this.force_revert;var clear=this.clear_on_revert;for(i=0;i<this.files.length;i++){f=this.files[i];if(result.errors[f.upload_name]){clear=false;revert=true;}}
if(revert){for(i=0;i<this.files.length;i++){this.fileReplaceStub(this.files[i],true,clear);this.files[i].result={error:1};}}
var addp={},inc_id;for(i=0;i<this.files.length;i++){f=this.files[i];if(result.errors[f.upload_name])return this.fail(result.errors[f.upload_name]);if(!result.files[f.upload_name].id)return this.fail("Missing ID for uploaded file");inc_id='INCOMING~'+result.files[f.upload_name].id;if(f.save)f.save.value=inc_id;addp[f.name]=inc_id;f.result=result.files[f.upload_name];}
if(!this.upload_manual_add)
this.postData+='&'+encodeQueryString(addp);}
if(this.onupload)
this.onupload.apply(this,[this.files]);else
this.performFetch();},cleanup:function(){if(this.conn){this.conn.onreadystatechange=null;this.conn=null;}
this.setReadyState(0);Conn.pendingConns[this.request_id]=false;},pending:function(){return(this.readyState!=0);},setDuration:function(){var now=new Date();if(this.fetchStart)
this.fetchTime=now.getTime()-this.fetchStart.getTime();if(this.openStart)
this.openTime=now.getTime()-this.openStart.getTime();},onreadystatechange:function(state){},_onreadystatechange:function(){if(!this.conn||this.success===false||!this.readyState)return;var state=this.conn.readyState;if(!state){this.setDuration();this.setReadyState(state);this.ontimeout();return;}
if(this.readyState<state)
this.setReadyState(state);if(state<4)return;try{this.status=this.conn.status;this.statusText=this.conn.statusText}catch(e){this.status=0;this.statusText='';}
if(this.status==200){this.responseText=this.conn.responseText;this.responseXML=this.conn.responseXML;if(this.handleResponse()){this.setDuration();this.success=true;this.hideStatus();this.oncomplete();this.onresponse.apply(this.callback_scope||this,[this]);this.cleanup();}}
else if(this.status==401){this.setDuration();window.not_logged_in=true;this.hideStatus();App.asyncLogin.showLoginPopup(this);}else if(this.status==403){this.fail(app_string('NTC_JS_FORBIDDEN'));}else if(this.status==400){this.fail("Bad JSON request (status 400): "+this.conn.responseText);}else if(this.status==0){this.fail('');}else
this.fail("There was a problem with the connection:\n"+this.statusText+" ("+this.status+")");},uploadProgress:function(evt){if(!evt.lengthComputable)
this.progressPercent=-1;else
this.progressPercent=Math.round(evt.loaded*100/evt.total);if(this.onprogress)
this.onprogress();},handleResponse:function(){return true;},getResult:function(){return this;},attemptRetry:function(fail_msg){if(this.retries<this.max_retries){this.retries++;this.fetch();}else
this.fail(fail_msg);},showStatus:function(msg,timeout){this.hideStatus();if(App.moduleLoaded('ui-controls'))return(this.status_id=App.ui.Status.show(msg,timeout));},hideStatus:function(){if(this.status_id)App.ui.Status.remove(this.status_id);this.status_id=null;},abort:function(){if(this.conn){this.conn.abort();this.aborted=true;}
Conn.pendingConns[this.request_id]=false;},getError:function(){return this.failure_msg;},oncomplete:function(){},onresponse:function(){},ontimeout:function(){this.abort();this.aborted=false;this.attemptRetry("connection timed out");},onerror:function(zero,self){if(!this.silent&&self.failure_msg){this.showStatus(self.failure_msg,4000);}}};this.HTTPRequest=HTTPRequest;var JSONRequest=function(action,params,postData){var defaults={method:'POST',content_type:'application/json',action:action,postData:postData};if(!params)params={};extendObject(params,defaults);HTTPRequest.call(this,'json.php',params);this.upload_manual_add=true;}
extendClass(JSONRequest,HTTPRequest,{getUrl:function(){var url=this.url;if(this.action){if(url.lastIndexOf('?')!=-1)
url+='&';else
url+='?';url+='action='+encodeURIComponent(this.action);}
return url;},loadPostData:function(data){this.setPostData(data);},getPostData:function(){if(!isset(this.postData)||this.postData==='')return null;if(typeof(this.postData)==='string'||(window.FormData&&this.postData instanceof FormData))return this.postData;return JSON.stringify(this.postData);},handleResponse:function(){try{this.result=this.responseText.length?JSON.parse(this.responseText):null;}catch(e){console.error(e,this.responseText);return this.fail(e.toString());}
if(!this.result)return this.fail('No result');return true;},fetchJSON:function(callb,errb){return this.fetch(function(){var r=this.getResult();if(this.success&&r){callb.apply(this.callback_scope||this,[r,this]);}else{this.fail(this.failure_msg||'Error decoding response');}},errb);},loadForm:function(form,custom_values){this.json_args=new Conn.JSONArgs();this.json_args.skip_action=true;this.loadFormValues(form,this.json_args,custom_values);this.setPostData(this.json_args.getData());this.setFiles(this.json_args.getFiles());},getResult:function(){return this.result;},reset:function(){this.resetConnection();this.result=undefined;},onupload:function(files){if(files&&this.json_args){for(var i=0;i<files.length;i++){if(files[i].save)
this.json_args.append(files[i].name,files[i].save.value);}
this.setPostData(this.json_args.getData());}
this.performFetch();}});this.JSONRequest=JSONRequest;this.JSONArgs=function(){this.args={};this.skip_action=true;}
this.JSONArgs.prototype={append:function(key,value){if(!isset(key))return;if(key=='action'&&this.skip_action)return;if(key.match(/^[a-zA-Z_][a-zA-Z0-9_]*$/))
this.args[key]=value;},getData:function(){return JSON.stringify(this.args);},addFile:function(f){if(!this.files)this.files=[];this.files.push(f);},getFiles:function(){return(this.files&&this.files.length)?this.files:null;}};this.ProgressChecker=function(hooks){this.hooks=hooks||{};}
this.ProgressChecker.prototype={start:function(start_action,poll_action,interval){var self=this,url;this.start_action=start_action;this.start_time=new Date();this.poll_action=poll_action||start_action;this.interval=interval||300;this.last_poll=null;this.percent=0;this.process='';this.timestamp='';this.completed=false;this.history=[];this.poll_count=0;this.in_progress=true;if(this.hooks.start)this.hooks.start.call(this);if(!this.start_url)
this.start_url=this.hooks.start_url||('json.php?action={ACTION}'+(this.hooks.module?'&module='+this.hooks.module:''));if(!this.poll_url)
this.poll_url=this.hooks.poll_url||('json.php?action={ACTION}&timestamp={TIMESTAMP}&progress_id={PROGRESS_ID}'+(this.hooks.module?'&module='+this.hooks.module:''));url=this.start_url.replace('{ACTION}',this.start_action);if(this.hooks.start_http)
this.run_req=new Conn.HTTPRequest(url,{status_msg:null});else
this.run_req=new Conn.JSONRequest(null,{method:'GET',url:url,status_msg:null});this.run_req.fetch(
function(r){self.run_response(r);},function(){self.error_response(this,true);});if(this.hooks.sync_run)
this.poll(300);},get_duration:function(millis){var ms=(new Date()).getTime()-this.start_time.getTime(),mins,ret='';if(millis)return ms;ms=Math.round(ms/1000);mins=Math.floor(ms/60);if(mins){ret=mins+'m ';ms-=mins*60;}
return ret+ms+'s';},poll:function(wait){var self=this,now=new Date(),callb=function(r){self.poll_response(r);},errb=function(){self.error_response(this);},url=this.poll_url;url=url.replace('{ACTION}',this.poll_action).replace('{TIMESTAMP}',encodeURIComponent(this.timestamp||'')).replace('{PROGRESS_ID}',encodeURIComponent(this.progress_id||''));this.poll_req=new Conn.JSONRequest(null,{method:'GET',url:url,status_msg:null});if(!wait)wait=this.interval||0;if(wait&&this.last_poll)wait=Math.max(0,wait-now.getTime()+this.last_poll.getTime());setTimeout(function(){self.poll_count++;self.last_poll=new Date();self.poll_req.fetch(callb,errb);},wait);},error_response:function(req,initial){this.failure(req.getError());},run_response:function(req){var data;if(this.hooks.sync_run)
this.in_progress=false;if(!this.hooks.start_http&&!this.hooks.sync_run){data=req.getResult();if(data)
this.progress_id=data['progress_id'];if(!this.progress_id){this.failure("Task not started");return;}}
if(this.hooks.start_complete)this.hooks.start_complete.call(this);if(!this.hooks.sync_run)
this.poll(300);},poll_response:function(req){var data,perc,proc;if(!req)return this.failure('lost_conn');data=req.getResult();if(!data)return this.failure(req.getError());this.timestamp=data.timestamp;if(data.history){for(var i=0;i<data.history.length;i++){this.history.push(data.history[i]);if(this.hooks.history)this.hooks.history.call(this,data.history[i]);}}
if(data.finished){this.in_progress=false;this.status=data.status||'success';this.status_msg=data.status_message||'';if(this.status=='success'){this.progress(100);return this.complete();}
else
return this.failure(this.status_msg);}
if(data.current_process){proc=data.current_process;perc=parseFloat(data.current_progress);if(isNaN(perc)||perc>100)perc=100;perc=Math.floor(perc/100*98);}else{perc=0;}
this.progress(perc,proc);if(this.in_progress){this.poll();}else{this.failure(this.hooks.std_failure_msg||'');}},progress:function(perc,current){this.percent=perc;this.process=current;if(this.hooks.progress)this.hooks.progress.call(this,this.percent,this.process);},complete:function(){this.completed=true;if(this.run_req&&this.in_progress)this.run_req.abort();if(this.hooks.complete)this.hooks.complete.call(this,this.status,this.status_msg);},failure:function(msg){this.error_msg=msg||this.hooks.std_failure_msg||'';if(this.hooks.error)this.hooks.error.call(this,this.error_msg);else if(this.hooks.complete)this.hooks.complete.call(this,this.status,this.status_msg);}};});var json_objects={};function call_json_method(module,action,vars,variable_name,callback,options){if(isset(window.not_logged_in))return false;if(!options)options={};var silent=false;if(options.all_silent||options.hide_status_msg)
silent=true;var async=(callback&&!options.sync)?true:false;if(!variable_name)variable_name=module+':'+action;json_objects[variable_name]=null;var args=encodeQueryString({module:module})+'&'+(vars||'');var J=new AppBase.conn.JSONRequest(action,{args:args,async:async,silent:silent});J.oncomplete=function(){json_objects[variable_name]=this.getResult();}
return J.fetch(callback);}
function getXMLHTTPinstance(){return new XMLHttpRequest();}
function http_fetch_sync(url,post_data){var method=isdef(post_data)?'POST':'GET';var req=new AppBase.conn.HTTPRequest(url,{method:method,postData:post_data});return req.fetchSync();}
function http_fetch_async(url,callback,request_id,post_data){var method=isdef(post_data)?'POST':'GET';return AppBase.conn.asyncRequest(url,{method:method,request_id:request_id,postData:post_data},callback);}
var global_xmlhttp=null;AppBase.extendModule('ui','ui-controls',function(App){var UI=this,Dom=App.dom,Query=Dom.query,QueryFirst=Dom.queryFirst,QueryId=Dom.queryId,Wrap=Dom.extNode,MakeElt=Dom.makeElement;UI.loaded=true;UI.conditional_fields=[];UI.PopupManager={modal_stack:[],current_modal:null,open_stack:[],last_opened:null,loading_popup:null,uniqid:0,popupBeforeShow:function(popup){this.checkMobile();if(!popup||popup===this.last_opened){return;}
if(!popup.stacked){while(this.last_opened&&this.last_opened!==this.current_modal){if(this.last_opened===popup)return;var old=this.last_opened;this.last_opened=this.open_stack.pop();old.close();}}
if(this.last_opened)
this.open_stack.push(this.last_opened);this.last_opened=popup;this.attachEvents();},popupBeforeHide:function(popup){if(popup.modal&&!popup.forms_detached){var forms=Wrap(popup.elt).find('form');for(var idx=0;idx<forms.length;idx++){UI.beforeDetachForm(forms[idx]);}
popup.forms_detached=true;}},canceledShow:function(popup){this.popupHidden(popup);},popupShown:function(popup){if(!popup||popup!==this.last_opened){return;}
if(popup.modal&&popup!==this.current_modal){var old=this.current_modal;if(old)
this.modal_stack.push(old);else if(!popup.hide_mask)
this.showModalMask(popup.invis_mask);this.current_modal=popup;if(this.last_opened===old)
this.last_opened=null;if(old)
old.hide();}
if(popup.forms_detached){var forms=Wrap(popup.elt).find('form');for(var idx=0;idx<forms.length;idx++){UI.beforeRestoreForm(forms[idx]);}
popup.forms_detached=false;}},popupHidden:function(popup){if(popup.modal){if(this.last_opened&&this.last_opened.target&&popup.elt&&popup.elt.contains(this.last_opened.target)){this.last_opened.close();}}
if(popup&&popup===this.last_opened)
this.last_opened=this.open_stack.pop();if(popup&&popup===this.current_modal){this.current_modal=this.modal_stack.pop();this.last_opened=this.current_modal;if(this.current_modal&&!this.closing)
this.current_modal.show();}
if(!this.current_modal||this.current_modal.hide_mask)
this.hideModalMask();if(!this.last_opened)
this.removeEvents();},close:function(popup){var r,done;this.closing=true;while(this.last_opened&&!done){if(!popup||this.last_opened===popup||this.last_opened.id===popup){done=true;this.closing=false;}
if(!(r=this.last_opened.close()))
break;}
this.closing=false;return r;},closeAll:function(){var r=true,p=this.last_opened;this.closing=true;while(p){if(!(r=p.close())||this.last_opened===p)
break;p=this.last_opened;}
this.closing=false;return r;},checkPosition:function(evt){if(this.events)this.reposition();},doReposition:function(){this.checkMobile();if(this.current_modal)
this.positionMask();for(var i=0;i<this.open_stack.length;i++)
this.open_stack[i].reposition();if(this.last_opened)
this.last_opened.reposition();},reposition:function(){if(this.reposReq)
cancelAnimationFrame(this.reposReq);this.reposReq=requestAnimationFrame(function(){UI.PopupManager.doReposition();});},getModalMask:function(){if(!this.mask_elt){var mask=this.mask_elt=createElement2('div',{className:'pageMask'});mask.onselectstart=mask.onmousedown=mask.onclick=mask.ontouchmove=mask.ontouchstart=function(e){var tg=e.target,curPop=UI.PopupManager.lastOpened();if(tg!==mask||!curPop||!curPop.modal)return;if(e.type=='touchstart'||e.type=='touchmove')
e.stopPropagation();else
UI.stopEvent(e);}
document.body.appendChild(this.mask_elt);}
return this.mask_elt;},showModalMask:function(invis){if(this.mask_visible)return;var mask=this.getModalMask();if(mask){if(this.mask_timer)
clearTimeout(this.mask_timer);mask.style.display='block';UI.addRemoveClass(mask,'invisible',!!invis);if(isIPhone){mask.style.webkitTransitionDuration=0;}else{mask.style.opacity=0.0;setTimeout(function(){mask.style.opacity=0.5;},0);}
this.mask_visible=true;UI.addClass(document.body,'modal-open');this.positionMask();}},hideModalMask:function(){if(!this.mask_visible)return;var mask=this.getModalMask();if(!isIPhone)mask.style.opacity=0.0;this.mask_timer=setTimeout(function(){mask.style.display='none';},isIPhone?0:500);this.mask_visible=false;UI.removeClass(document.body,'modal-open');},positionMask:function(){if(isIPhone){var m=this.mask_elt;var viewp=UI.getViewport();m.style.position='absolute';m.style.left=0;m.style.top=0;m.style.width=viewp.doc_width+'px';m.style.height=viewp.doc_height+'px';}},setFetchingPopup:function(p){this.fetching_popup=p;if(p&&!p.visible&&p.modal&&!p.hide_mask){this.showModalMask(p.invis_mask);}},setLoadingPopup:function(p){this.fetching_popup=null;this.loading_popup=p;},getLoadingPopup:function(){return this.loading_popup;},initContent:function(p){if(this.loading_popup)
this.loading_popup.initContent(p);},attachEvents:function(){if(this.events)return;var evts={document:{mousemove:this.handleMouseMoveDoc,mousedown:this.handleMouseDownDoc,click:this.handleClickDoc,keydown:this.handleKeyDownDoc,touchstart:this.handleMouseDownDoc,touchend:this.handleClickDoc},window:{mouseleave:this.handleMouseLeaveDoc,scroll:this.handleScrollDoc}};this.events={};for(var target in evts){this.events[target]=UI.addEventListeners(window[target],evts[target],this);}},removeEvents:function(){if(this.events){for(var target in this.events)
UI.removeEventListeners(window[target],this.events[target]);this.events=null;}},uniqueId:function(){return'popup-window-'+(++this.uniqid);},eventInside:function(evt,popup){var tg=evt.target;if(!tg||!popup||!popup.elt)return;return popup.elt.contains(tg);},inRenderedPopup:function(elt){if(elt){for(var i=0;i<this.open_stack.length;i++){if(this.open_stack[i].elt&&this.open_stack[i].elt.contains(elt)){return true;}}}
return false;},handleMouseMoveDoc:function(evt){if(this.now_dragging)return;if(this.last_opened)this.last_opened.handleMouseMoveDoc(evt);},handleMouseDownDoc:function(evt){var button=evt.which||evt.button,inside;if(evt.type!='touchstart'&&button!=1)return;if(evt.type=='touchstart'){if(evt.touches.length!=1)return;this.touchClose=true;}
if(this.last_opened){if(!this.eventInside(evt,this.last_opened)){if(this.last_opened.modal&&evt.type!='touchstart'){evt.preventDefault();return this.last_opened.handleClickDoc(evt);}}}},handleClickDoc:function(evt){var button=evt.which||evt.button;if(evt.type=='touchend'){if(!this.touchClose)return;}else if(button!=1)return;if(this.now_dragging)return;if(!this.eventInside(evt,this.last_opened))return this.last_opened.handleClickDoc(evt);},handleMouseLeaveDoc:function(evt){if(evt.toElement||this.now_dragging)return;if(this.last_opened)this.last_opened.handleMouseLeave(evt);},handleKeyDownDoc:function(evt){if(this.now_dragging)return;if(evt.keyCode==27)this.close();else this.last_opened.handleKeyDown(evt);},handleScrollDoc:function(evt){this.touchClose=false;},nowDragging:function(){return this.now_dragging;},currentModal:function(){return this.current_modal;},lastOpened:function(){return this.last_opened;},checkMobile:function(){var m=false;if(isIPhone||window.innerWidth<700||window.innerHeight<500)
m=true;this.mobile=m;},getMobile:function(){return this.mobile;}};UI.addScrollHook(UI.PopupManager.checkPosition,UI.PopupManager);UI.addResizeHook(UI.PopupManager.checkPosition,UI.PopupManager);UI.DragHandler=function(){}
UI.DragHandler.prototype={makeDragTarget:function(target,tag,opts){UI.addEventListener(target,'selectstart',UI.stopEvent);UI.addEventListener(target,'mousedown',function(evt){this.dragStart(evt,target,tag,opts);},this);UI.addEventListener(target,'touchstart',function(evt){this.dragStart(evt,target,tag,opts);},this);},destroyDragTarget:function(target){},dragStart:function(evt,target,tag,opts){var button=evt.which||evt.button,evts={document:{mousemove:this.drag,touchmove:this.drag,mouseup:this.dragEnd,touchend:this.dragEnd,keydown:this.dragKeyDown,mouseexit:this.dragCancel,touchcancel:this.dragCancel,selectstart:UI.stopEvent},window:{scroll:this.dragScroll}},etarg=evt.target,tname,ename;if((evt.type=='mousedown'&&button!=1)||(evt.type=='touchstart'&&evt.touches.length!=1))return;while(etarg){if(etarg===target||etarg===window)break;if(etarg.tagName=='BUTTON'||UI.hasClass(etarg,'active-icon'))return;etarg=etarg.parentNode;}
if(evt.type=='touchstart'){if(this.disable_touch_drag){UI.stopEvent(evt);return;}else{UI.preventDefault(evt);}}
this.draginfo={startTime:performance.now(),startX:evt.pageX,startY:evt.pageY,scrollStartX:window.pageXOffset,scrollStartY:window.pageYOffset,dragX:0,dragY:0,lastDragX:0,lastDragY:0,dragSpeedX:0,dragSpeedY:0,scrollX:0,scrollY:0,tag:tag,hooks:[]};for(tname in evts)
this.draginfo.hooks[tname]=UI.addEventListeners(window[tname],evts[tname],this);UI.PopupManager.now_dragging=true;var ret=UI.callEvent(this,this.ondragstart,evt,this.draginfo);if(evt.type=='touchstart'&&opts&&opts.touchstart)
opts.touchstart(evt);else if(opts&&opts.mousedown)
opts.mousedown(evt);UI.stopEvent(evt);if(ret===false)
this.dragCancel();},drag:function(evt){var di=this.draginfo;if(!di)return;di.dragX=evt.pageX-di.startX;di.dragY=evt.pageY-di.startY;di.scrolled=false;if(evt.type=='touchmove')
UI.stopEvent(evt);if(di.dragX!==di.lastDragX||di.dragY!==di.lastDragY){UI.callEvent(this,this.ondrag,evt,di);di.dragSpeedX=di.dragX-di.lastDragX;di.dragSpeedY=di.dragY-di.lastDragY;}
di.lastDragX=di.dragX;di.lastDragY=di.dragY;return false;},dragCancel:function(evt){var di=this.draginfo;if(!di)return;di.canceled=true;UI.callEvent(this,this.ondragcancel,evt,di);this.dragEnd(evt);},dragKeyDown:function(evt){if(evt.keyCode==27){UI.stopEvent(evt);this.dragCancel(evt);}},dragScroll:function(evt){var di=this.draginfo,x=di.scrollX,y=di.scrollY;di.scrollX=window.pageXOffset-di.scrollStartX;di.scrollY=window.pageYOffset-di.scrollStartY;di.scrolled={dx:di.scrollX-x,dy:di.scrollY-y};UI.callEvent(this,this.ondrag,evt,di);},dragEnd:function(evt){var button=evt.which||evt.button,di=this.draginfo,target;if(!di||(evt.type=='mouseup'&&button!=1&&button!=3))return;if(!di.canceled&&performance.now()-di.startTime<250&&Math.abs(di.dragX)<5&&Math.abs(di.dragY)<5){this.dragCancel(evt);return;}
var evts=di.hooks;if(evts){for(target in evts)
UI.removeEventListeners(window[target],evts[target]);di.hooks=null;}
UI.PopupManager.now_dragging=false;UI.callEvent(this,this.ondragend,evt,di);this.draginfo=null;}};UI.MultiSlider=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;this.min=0;this.max=1;this.values=[];this.points=[];this.slider_elts=[];this.point_elts=[];if(params)extendObject(this,params);}
UI.MultiSlider.prototype={setup:function(){if(this.set_up)return;if(!this.elt&&this.id)
this.elt=$(this.id);if(!this.elt)return;this.updateDisplay();this.set_up=true;},setRange:function(min,max){this.min=min;this.max=max;},addPoints:function(){for(var i=0;i<arguments.length;i++){if(Array.isArray(arguments[i]))
this.points.pushArray(arguments[i]);else
this.points.push(arguments[i]);}},clearPoints:function(){this.points.clear();},getPoints:function(){return this.points.slice();},addValues:function(){for(var i=0;i<arguments.length;i++){if(Array.isArray(arguments[i]))
this.values.pushArray(arguments[i]);else
this.values.push(arguments[i]);}
this.values.sort(cmpFn);},clearValues:function(){this.values.clear();},getValues:function(){return this.values.slice();},render:function(){if(this.rendered)return;this.elt=MakeElt('div',{'class':'slider-outer '+(this.className||'')}).get();this.rendered=true;return this.elt;},getWidth:function(){var bounds=Wrap(this.elt).bounds(),w;if(!bounds||!(w=bounds.width))return;return w-1;},renderPoints:function(targets){var rng=this.max-this.min,w=this.getWidth(),point;Dom.query(this.point_elts).remove();this.point_elts=[];for(var i=0;i<this.points.length;i++){point=MakeElt('div.slider-point');point.position({left:w*(this.points[i]-this.min)/rng-0.5,top:10});this.point_elts.push(point);}
Wrap(this.elt).prepend(this.point_elts);},updateDisplay:function(){var rng=this.max-this.min,w=this.getWidth(),slider;this.renderPoints();Dom.query(this.slider_elts).remove();this.slider_elts=[];for(var i=0;i<this.values.length;i++){slider=MakeElt('div.slider-indicator.uii.uii-bdown');slider.position({left:w*(this.values[i]-this.min)/rng-9.5,top:-6});this.slider_elts.push(slider);this.makeDragTarget(slider.get(),i);}
Wrap(this.elt).append(this.slider_elts);},getTargetPoints:function(value,index){},ondragstart:function(evt,info){info.targets=this.getTargetPoints(this.values[info.tag],info.tag);if(info.targets){info.targets.sort(cmpFn);if(!info.targets.length)return false;}
info.bounds=Wrap(this.elt).bounds();if(!info.bounds)return false;info.width=info.bounds.width-1;info.range=this.max-this.min;info.startOffs=info.width*(this.values[info.tag]-this.min)/info.range-9.5;this.slider_elts[info.tag].addClass('active');},ondrag:function(evt,info){var w=info.bounds.width-1,xpos=info.startOffs+info.dragX+9.5,nval=xpos/w*info.range+this.min,npos,mdiff,diff=0,closest,i;if(info.targets){for(i=0;i<info.targets.length;i++){diff=Math.abs(info.targets[i]-nval);if(!isset(mdiff)||mdiff>diff){mdiff=diff;closest=info.targets[i];}}
nval=closest;}
if(this.rounded)nval=Math.round(nval);info.nval=nval;npos=info.width*(nval-this.min)/info.range-9.5;this.slider_elts[info.tag].position({left:npos,top:-6});},ondragend:function(evt,info){this.slider_elts[info.tag].removeClass('active');if(isset(info.nval)){if(info.nval!=this.values[info.tag]){this.values[info.tag]=info.nval;this.values.sort(cmpFn);UI.callEvent(this,this.onchange);}
this.updateDisplay();}}};extendProto(UI.MultiSlider,UI.DragHandler);UI.Popup=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;this.target=null;this.target_offset=null;this.target_active_class='active';this.desired_position=null;this.fixed_position=null;this.modal=false;this.inline=false;this.destroy_on_close=false;this.close_on_exit=true;this.close_on_ext_click=true;this.close_delay=500;this.keep_in_viewport=true;this.visible=false;this.hovered=false;this.focused=false;this.change_opacity=!isIPhone;this.prevent_show_timer=null;this.width=null;if(params)extendObject(this,params);if(!this.id)
this.id=UI.PopupManager.uniqueId();}
UI.Popup.prototype={setup:function(){if(this.set_up)return;if(!this.elt&&this.id)
this.elt=$(this.id);if(!this.elt)return;this.set_up=true;},getStartViewport:function(){if(!this.start_viewport)
this.start_viewport=UI.getViewport(this.getOuterMargin(),this.inline||this.modal);return this.start_viewport;},getSize:function(){if(this.elt){return UI.getEltRegion(this.elt);}},setWidth:function(w){this.width=w;if(this.elt)
UI.setWidth(this.elt,w);this.reposition();},setDesiredPosition:function(pos){this.desired_position=pos;},setFixedPosition:function(pos){this.fixed_position=pos;},getOuterMargin:function(){var t=this.target_offset;return get_default(t?t.outer_margin:null,true);},getDesiredPosition:function(){if(this.desired_position)return Object.assign({},this.desired_position);else if(this.target||this.target_offset){var offs=this.target_offset,over=false,above=false,align=null,viewp=UI.getViewport(this.getOuterMargin(),this.inline||this.modal),tg=UI.getEltRegion(this.target,this.getOffsetContainer())||viewp,size=this.getSize(),pos={x:viewp.x,y:viewp.y};if(!tg||!size)return pos;var offs=this.target_offset,over=false,above=false,align=null,evt,out;if(offs){over=offs.over;above=offs.above;align=offs.align;if(offs.from_cursor&&this.mouse_pos){out=UI.getViewport();tg={x:this.mouse_pos.x+out.x,y:this.mouse_pos.y+out.y-(out.offset||0),width:1,height:1};}}else
offs={};if(above){pos.y=viewp.window_height-(over?tg.y+tg.height:tg.y);pos.above=true;}else{pos.y=over?tg.y:tg.y+tg.height;}
if(!align){align='auto';}
if(align=='onleft'){pos.x=tg.x-size.width;}
else if(align=='left'){pos.x=tg.x-size.width+Math.min(size.width,tg.width);}
else if(align=='onright'){pos.x=tg.x+tg.width;}
else if(align=='right'){pos.x=tg.x+tg.width-size.width;}
else if(align=='center'){pos.x=tg.x+(tg.width-size.width)/2;}
else if(align=='auto'){if(tg.x+size.width>viewp.right&&tg.right-size.width>viewp.x)
pos.x=tg.right-size.width;else
pos.x=tg.x;}
else{pos.x=tg.x;}
if(offs.left)
pos.x+=offs.left;if(offs.top)
pos.y+=offs.top;return pos;}},getFixedSize:function(){if(this.fixedSize)return deep_clone(this.fixedSize);},getMaxAutoSize:function(){var sview=this.getStartViewport(),viewp=UI.getViewport(this.getOuterMargin(),this.inline||this.modal),perc=this.max_percent_size||{},max_w=(this.inline||this.modal)?viewp.view_width:viewp.width,max_h=(this.inline||this.modal)?viewp.view_height:viewp.height,max_size=this.max_auto_size,size;if(this.inline&&this.target){var bounds=QueryFirst(this.target).bounds();if(bounds){if(this.target_offset&&this.target_offset.above){var tg_y=bounds.y+(this.target_offset.over?bounds.height:0);if(tg_y>viewp.bottom)tg_y=viewp.bottom;if(tg_y<viewp.y)tg_y=viewp.y;max_h=Math.min(max_h,tg_y-viewp.y);if(max_h<0)max_h=0;}}}
if(viewp.width<1000)perc={};size={width:(perc.width||100)*max_w/100,height:(perc.height||100)*max_h/100};if(max_size){if(max_size.width<size.width)size.width=max_size.width;if(max_size.height<size.height)size.height=max_size.height;}
return size;},applyDimensions:function(){var max_size,viewp=UI.getViewport(this.getOuterMargin(),this.inline||this.modal),fix=this.getFixedSize(),mobile=!!(this.modal&&UI.PopupManager.getMobile()),set_w=null,set_h=null;if(fix){set_w=viewp.width;set_h=viewp.height;}
else if((max_size=this.getMaxAutoSize())){if(max_size.width)
set_w=max_size.width;if(max_size.height)
set_h=max_size.height;}
UI.addRemoveClass(this.elt,'mobile',mobile);UI.addRemoveClass(this.elt,'resizable',!!(this.resizable&&!mobile));if(this.max_width)set_w=this.max_width;if(this.max_height)set_h=this.max_height;this.elt.style.maxWidth=UI.formatSize(set_w);if(this.content_elt&&isNumeric(set_h)){var outer=Wrap(this.elt).bounds(),content=Wrap(this.content_elt).bounds();if(outer&&content)set_h-=outer.height-content.height;this.content_elt.style.maxHeight=UI.formatSize(set_h);this.elt.style.maxHeight=null;}else{this.elt.style.maxHeight=UI.formatSize(set_h);}
if(this.min_width&&!mobile)
this.elt.style.minWidth=UI.formatSize(this.min_width);else this.elt.style.minWidth=null;if(this.min_height&&!mobile)
this.elt.style.minHeight=UI.formatSize(this.min_height);else this.elt.style.minHeight=null;return viewp;},restrictViewport:function(pos,size,viewp){var sview=this.getStartViewport(),viewx=this.modal?sview.x:viewp.x,viewy=this.modal?sview.y:viewp.y,vieww=this.modal?sview.view_width:viewp.width,viewh=this.modal?sview.view_height-viewp.offset:viewp.height;if(pos.x+size.width>viewx+vieww)
pos.x=viewx+vieww-size.width;if(viewx>pos.x)
pos.x=viewx;if(pos.above)
pos.y=viewp.window_height-pos.y-size.height;if(pos.y+size.height>viewy+viewh)
pos.y=viewy+viewh-size.height;if(viewy>pos.y)
pos.y=viewy;if(pos.above)
pos.y=viewp.window_height-pos.y-size.height;},reposition:function(temp_pos){if(!this.elt||!this.visible)return;if(this.target&&!UI.inDocument(this.target)){this.close();return;}
var viewp=this.applyDimensions(),pos,size,c,tprop,sy,lp,above=this.target_offset&&this.target_offset.above;if(temp_pos)
pos=temp_pos;else if(this.fixed_position)
pos=this.fixed_position;else{pos=this.getDesiredPosition();size=this.getSize();if(pos){var keep_in=this.keep_in_viewport;if(keep_in==='dialog'){var dlg=QueryFirst(this.target).closest('.popup-dialog');keep_in=!!dlg.length;}
if(size&&keep_in){this.restrictViewport(pos,size,viewp,above);if(!pos.manual){sy=isIPhone?window.screenY+viewp.margin:viewp.y;if((lp=this.last_pos)
&&lp.width==size.width&&lp.height==size.height
&&lp.sx==viewp.x&&lp.sy==sy
&&lp.sw==viewp.width&&lp.sh==viewp.height){return;}
this.last_pos=lp=Object.assign({},pos);lp.width=size.width;lp.height=size.height;lp.sx=viewp.x;lp.sy=sy;lp.sw=viewp.width;lp.sh=viewp.height;}}}}
if(!pos)
pos={x:0,y:0};if(pos){c=this.getContainer(true);if(c&&c.style.position!='relative'&&c.style.position!='absolute'){var cpos=YDom.getXY(c);pos.x-=cpos[0];pos.y-=cpos[1];}
var pxpos={x:parseFloat(pos.x).toFixed(2)+'px',y:parseFloat(pos.y).toFixed(2)+'px'};if(this.transform_position&&(tprop=UI.getTransformProperty())&&!pos.above){this.elt.style[tprop]='translate3d('+pxpos.x+', '+pxpos.y+', 0)';}else{this.elt.style.left=pxpos.x;if(pos.above){this.elt.style.top=null;this.elt.style.bottom=pxpos.y;}else{this.elt.style.top=pxpos.y;}}}
if(!temp_pos)
UI.callEvent(this,this.onresize,pos,viewp);},cancelShowTimer:function(shown){if(this.showTimer){clearTimeout(this.showTimer);this.showTimer=null;if(!shown){UI.callEvent(this,this.oncancelshow);UI.PopupManager.canceledShow(this);}
return true;}},cancelCloseTimer:function(){if(this.closeTimer){clearTimeout(this.closeTimer);this.closeTimer=null;return true;}},show:function(delay){this.cancelCloseTimer();if(this.prevent_show_timer)return;if(this.visible||(delay&&this.showTimer)){this.reposition();return;}
if(delay){var inp=this;this.showTimer=setTimeout(function(){UI.PopupManager.popupBeforeShow(inp);inp.performShow();},delay);return true;}else{UI.PopupManager.popupBeforeShow(this);return this.performShow();}},performShow:function(){this.setup();this.cancelShowTimer(true);var e=this.elt,tprop=UI.getTransformProperty(),tform,tsprop=UI.getTransitionProperty();if(!e||this.visible)return false;Wrap(e).swapIn();this.last_ext_move=null;this.visible=e.popup_visible=true;this.reposition({x:-2000,y:-2000});if(this.change_opacity)
e.style.opacity=0.0;e.style.position='absolute';e.style.visibility='hidden';UI.setDisplayState(e,true);if(this.zIndex)
e.style.zIndex=this.zIndex;if(tprop&&!this.transform_position&&(tform=this.getDisplayTransform())){if(tprop=='webkitTransform'){e.style.webkitBackfaceVisibility='hidden';}
e.style[tprop]=tform;if(this.target_offset&&this.target_offset.over&&this.target_offset.top){e.style[tprop+'Origin']='center '+(10-this.target_offset.top)+'px';}}
this.reposition();e.style.visibility='visible';if(this.change_opacity||tform)
setTimeout(function(){e.style.opacity=1.0;if(tform)e.style[tprop]='';},0);if(this.target&&this.target_active_class)
UI.addClass(this.target,this.target_active_class);UI.PopupManager.popupShown(this);this.addHooks();if(e.focus&&!this.disable_auto_focus)
e.focus();UI.callEvent(this,this.onshow);return true;},getDisplayTransform:function(){if(isset(this.customDisplayTransform))return this.customDisplayTransform;return'';},hide:function(reason){var e=this.elt,p=this;this.cancelShowTimer();this.hovered=false;this.last_pos=null;if(!e||!this.visible)return;UI.PopupManager.popupBeforeHide(this);this.visible=e.popup_visible=false;if(this.keep_in_document){e.style.display='none';}else if(this.change_opacity){e.style.opacity=0.0;setTimeout(function(){if(!p.visible){Wrap(e).swapOut();}},300);}else{Wrap(e).swapOut();}
if(this.target&&this.target_active_class)
UI.removeClass(this.target,this.target_active_class);UI.PopupManager.popupHidden(this);UI.callEvent(this,this.onhide,reason);},handleMouseEnter:function(evt){this.hovered=true;if(this.close_on_exit)
this.cancelCloseTimer();UI.callEvent(this,this.onmouseover,evt);},handleMouseLeave:function(evt){if(UI.PopupManager.nowDragging())return;this.hovered=false;if(this.close_on_exit)
this.close(this.close_delay,'mouseleave');UI.callEvent(this,this.onmouseout,evt);},handleMouseUp:function(evt){UI.callEvent(this,this.onmouseup,evt);},handleMouseMove:function(evt){if(!this.draginfo&&!UI.PopupManager.nowDragging())
UI.stopPropagation(evt);},handleMouseDown:function(evt){if(this.close_on_ext_click)
UI.stopPropagation(evt);},handleClickDoc:function(evt){if(this.close_on_ext_click||this.close_on_exit){this.close(null,'extclick');if(this.modal)return false;}},handleMouseMoveDoc:function(evt){if(this.close_on_exit){var keep_open=false;if(this.target){var exy=evt.position();keep_open=evt.inside(this.target);if(!keep_open){if(!this.last_ext_move||(this.last_ext_move.x==exy.x&&this.last_ext_move.y==exy.y)){keep_open=true;this.last_ext_move=exy;}}}
if(keep_open)
this.cancelCloseTimer();else
this.close(this.close_delay,'mouseleave');}},handleFocus:function(evt){if(!this.focused){this.focused=true;if(this.close_on_exit)
this.cancelCloseTimer();UI.callEvent(this,this.onfocus,evt);}},handleBlur:function(evt){if(this.focused){this.focused=false;if(this.close_on_exit)
this.close(this.close_delay);UI.callEvent(this,this.onblur,evt);}},handleKeyDown:function(evt){},addHooks:function(){var popup=this,evts={mouseenter:this.handleMouseEnter,mouseleave:this.handleMouseLeave,mousedown:this.handleMouseDown,mousemove:this.handleMouseMove,touchstart:this.handleMouseDown,focus:this.handleFocus,blur:this.handleBlur};for(var evt in evts)
UI.addEventListener(this.elt,evt,evts[evt],this);var target=Wrap(this.target),parents,pelt,ov,i,attach;if(target){parents=target.parents();for(i=0;i<parents.length;i++){if(parents[i]===document.body)break;pelt=parents.ext(i);if((ov=pelt.css('overflow'))==='auto'||ov==='scroll'
||(ov=pelt.css('overflow-x'))==='auto'||ov==='scroll'
||(ov=pelt.css('overflow-y'))==='auto'||ov==='scroll'){pelt.on('scroll',function(){UI.PopupManager.reposition()});}}}},getContainer:function(if_custom){var c;if(this.container)return this.container;if(this.container_id&&(c=$(this.container_id)))return c;return if_custom?null:document.body;},getOffsetContainer:function(if_custom){var contain=Wrap(this.getContainer(if_custom));if(contain.css('position')==='static'){contain=contain.offsetParent();}
return contain.get();},getContentElement:function(){if(!this.content_elt&&this.content_id)
this.content_elt=$(this.content_id);return this.content_elt;},render:function(){this.setup();if(this.rendered)return;this.rendered=true;if(!this.elt){this.elt=createElement2('div',{id:this.id,className:this.className,style:'display: none'});if(this.width)
UI.setWidth(this.elt,this.width);if(isset(this.tabIndex))
this.elt.tabIndex=this.tabIndex;this.renderContent();this.getContainer().appendChild(this.elt);}
return this.elt;},renderContent:function(){var content=this.getContentElement();if(content){if(this.fill_content)UI.addClass(content,'fill');this.elt.appendChild(content);toggleDisplay(content,true);}},canClose:function(){return true;},close:function(delay,reason){this.cancelShowTimer();if(!this.visible||!this.canClose()||(delay&&this.closeTimer))return;if(delay){var inp=this;this.closeTimer=setTimeout(function(){inp.performClose(null,reason);},delay);}else
this.performClose(null,reason);return true;},performClose:function(delay,reason){this.cancelCloseTimer();var self=this;this.hide(reason);if(this.destroy_on_close){setTimeout(function(){if(!self.visible)self.destroy();},500);}else{this.prevent_show_timer=setTimeout(function(){self.prevent_show_timer=null;},200);}
UI.callEvent(this,this.onclose,reason);},destroy:function(){UI.removeNode(this.elt,true);this.elt=null;this.rendered=false;delete this.start_viewport;UI.callEvent(this,this.ondestroy);this.destroyed=true;},initContent:function(params){}};UI.PopupSlidePanel=function(id,params){var defaults={close_on_exit:false,className:'card-outer popup-default panel-outer panel-border panel-default active',target_active_class:'active opened',customDisplayTransform:isIPhone?null:'scaleY(0.4)',disable_auto_focus:true,inline:true,keep_in_viewport:'dialog',hide_mask:true,destroy_on_close:true};if(params){extendObject(defaults,params);if(defaults.ext_class)defaults.className+=' '+defaults.ext_class;}
UI.Popup.call(this,id,defaults);if(this.show_above){this.className+=' panel-round-top';if(this.target_active_class)
this.target_active_class+=' opened-above';}else{this.className+=' panel-round-bottom';}}
extendClass(UI.PopupSlidePanel,UI.Popup);UI.Tooltip=function(id,params){this.text='';this.content=null;this.show_delay=500;if(!params)params={};if(!params.className)params.className='popup-tooltip';if(!params.target_offset)params.target_offset={top:10};UI.Popup.call(this,id,params);this.stacked=true;if(!this.target)
this.target=$(this.target_id);if(this.target){var popup=this;if(!this.pre_triggered)
this.target.onmouseenter=function(){popup.showTooltip();}
this.target.onmouseout=function(){popup.close();}}
if(this.pre_triggered){this.render();this.show(this.show_delay);}}
extendClass(UI.Tooltip,UI.Popup,{showTooltip:function(){this.render();this.show(this.show_delay);},renderContent:function(){this.content_elt=createElement2('span',{className:'tooltip-text'});if(this.content)
this.content_elt.innerHTML=this.content;else
UI.setElementText(this.content_elt,this.text);this.elt.appendChild(this.content_elt);}});UI.Dialog=function(id,params){UI.Popup.call(this,id,{className:'card-outer dialog-outer popup-dialog'});this.resizable=true;this.draggable=true;this.have_title_bar=true;this.have_close_button=true;this.align_center=true;this.transform_position=false;this.max_percent_size={width:80,height:90};this.max_auto_size={width:1000,height:700};this.destroy_on_close=true;this.close_on_exit=false;this.close_on_ext_click=false;this.disable_touch_drag=true;this.modal=true;this.title=null;if(params)extendObject(this,params);}
extendClass(UI.Dialog,UI.Popup,{setTitle:function(title){this.setTitleHtml(title);},setTitleHtml:function(title){if(isset(title))
this.title=title;this.renderTitle();},renderTitle:function(){if(this.title_text_elt){if(isNode(this.title)){this.title_text_elt.innerHTML='';this.title_text_elt.appendChild(this.title);}else if(isset(this.title))
this.title_text_elt.innerHTML=this.title;else
UI.setElementText(this.title_text_elt,this.title_text||'\u00a0');}},setTitleText:function(title){if(isset(title)){this.title_text=title;this.title=null;}
this.renderTitle();},getDesiredPosition:function(){if(this.desired_position)return Object.assign({},this.desired_position);if(!this.align_center)return UI.Dialog.superclass.getDesiredPosition.call(this);var size=this.getSize(),view=UI.getViewport(this.getOuterMargin(),this.inline||this.modal),sview,ret;if(size&&view){ret={x:view.x+Math.max(0,(view.body_width-size.width)/2),y:view.y+Math.max(0,(view.height-size.height)/2)};if(this.modal){sview=this.getStartViewport();ret={x:sview.margin+(view.body_width-size.width)/2,y:sview.y+(sview.view_height-sview.offset-size.height)/2};}
return ret;}},renderContent:function(){var title=this.getTitleBar(),head=this.renderHeader(),foot=this.renderFooter(),bottom=this.getBottomBar();UI.clearChildNodes(this.elt);if(title)
this.elt.appendChild(title);if(head)
this.elt.appendChild(head);UI.Dialog.superclass.renderContent.call(this);if(foot)
this.elt.appendChild(foot);if(bottom)
this.elt.appendChild(bottom);this.setTitleHtml();},renderHeader:function(){return this.header_elt;},renderFooter:function(){return this.footer_elt;},destroy:function(){if(this.have_title_bar){var e=this.getTitleBar();this.destroyDragTarget(e);}
var e=this.getResizeCorner();this.destroyDragTarget(e);UI.Dialog.superclass.destroy.call(this);},fetchContent:function(url,params,callback,autoShow){var conn;if(url instanceof App.conn.HTTPRequest)
conn=url;else
conn=new App.conn.HTTPRequest(url,params);UI.PopupManager.setFetchingPopup(this);var self=this;conn.fetch(function(){self.loadContent(this,callback,autoShow);},function(){self.loadError(this,callback,null,autoShow);});},fetchFormContent:function(form,form_values,conn_params,callback,autoShow){var req=new App.conn.HTTPRequest(null,conn_params);if(req.loadForm(form,form_values))
this.fetchContent(req,null,callback,autoShow);},loadContent:function(data,callback,autoShow){var self=this;this.render();if(data.getResult)
data=data.getResult();if(isset(data.responseText))
data=data.responseText;var text=App.util.disableInlineScripts(data);App.session.setLoadingRequest(data);UI.PopupManager.setLoadingPopup(this);this.setContent(text,true);function done(){if(callback)callback();UI.PopupManager.setLoadingPopup(null);App.session.setLoadingRequest(null);if(autoShow)self.show();else self.reposition();}
if(!this.disable_scripts)
App.util.evalScript(data,done);else
done();},initContent:function(params){var content=this.getContentElement();if(!params)params={};if(!this.ignore_init_title){if(params.title)
this.setTitle(params.title);else if(params.title_text)
this.setTitleText(params.title_text);}
if(params.width)this.setWidth(params.width);if(params.list_id)this.list_id=params.list_id;if(params.form_name){var f=document.forms[params.form_name];if(f)UI.initForm(f);}
if(params.onshow){UI.attachInputEvent(this,'onshow',params.onshow);}
if(params.onclose){UI.attachInputEvent(this,'onclose',params.onclose);}
if(params.content_id)
content.id=params.content_id;UI.addRemoveClass(content,'fill',!!params.fill);UI.callEvent(this,this.oninitcontent);},setContent:function(content,no_repos){var elt=this.getContentElement();if(typeof(content)==='string'){elt.innerHTML=content;}else{UI.setElementContent(elt,content);}
if(!no_repos)
this.reposition();},setFooter:function(text,no_repos){this.getFooterElement().innerHTML=text;if(!no_repos)
this.reposition();},loadError:function(conn,callback,err_str,autoShow){if(!err_str)err_str=app_string('LBL_ASYNC_JS_ERROR');this.loadContent('<p align="center"><small><i>'+err_str+'</i></small></p>',callback,autoShow);},getTitleBar:function(){var t;if(this.have_title_bar){if(!this.title_elt){this.title_text_elt=createElement2('h4');var t=createElement2('div',{className:'dialog-title'},this.title_text_elt);this.title_elt=createElement2('div',{className:'card-header dialog-header tools-row align-top'},t);if(this.have_close_button)
this.title_elt.appendChild(this.getCloseButton());if(this.draggable){this.makeDragTarget(this.title_elt,'title');}}
return this.title_elt;}},getBottomBar:function(){if(!this.bottom_elt){this.status_elt=createElement2('div',{className:'dialog-status text-muted'},null,this.bottom_elt);var e=this.getResizeCorner();this.bottom_elt=createElement2('div',{className:'card-footer dialog-footer tools-row align-bottom'},[this.status_elt,e]);this.makeDragTarget(e,'resize');}
if(this.resizable||this.have_bottom_bar)return this.bottom_elt;},getContentElement:function(){var c=UI.Dialog.superclass.getContentElement.call(this);if(!c)
c=this.content_elt=createElement2('div',{id:this.content_id,className:'card-body dialog-body'});return c;},getFixedSize:function(){if(this.fixedSize)return deep_clone(this.fixedSize);},getContentSize:function(){var sz=this.getFixedSize(),chk;if(!sz){chk=UI.getEltRegion(this.elt);if(chk)
sz={width:chk.width,height:chk.height};else
sz=this.getSize();}
sz.width-=4;sz.height-=42;return sz;},getFooterElement:function(){if(!this.footer_elt){var e;if(this.footer_id&&(e=$(this.footer_id)))
this.footer_elt=e;else
this.footer_elt=createElement2('div',{id:this.content_id,className:'dialog-footer'});}
return this.footer_elt;},getCloseButton:function(){if(!this.close_btn){this.close_btn=createElement2('div',{className:'uii uii-cancel uii-lg active-icon dialog-close'});}
var self=this;this.close_btn.onclick=function(){self.close();}
return this.close_btn;},getResizeCorner:function(){if(!this.resize_elt){this.resize_elt=createElement2('div',{className:'dialog-resizer no-flex'});}
return this.resize_elt;},getDisplayTransform:function(){return'';},setFixedSize:function(size){if(this.elt){if(!this.fixedSize){if(!size)
size=this.getSize();UI.addClass(this.elt,'fixed-size');}
if(size){if(size.width<this.min_width)size.width=this.min_width;if(size.height<this.min_height)size.height=this.min_height;this.elt.style.width=''+(size.width-4)+'px';this.elt.style.height=''+(size.height-4)+'px';}}
this.fixedSize=size;UI.callEvent(this,this.onresize);},ondragstart:function(evt,info){this.close_on_exit=false;info.pos=this.getDesiredPosition();info.size=this.getSize();if(!info.pos)
info.pos=info.size;},ondrag:function(evt,info){if(info.tag=='resize'){var viewp=UI.getViewport(this.getOuterMargin(),this.modal),w=info.size.width,h=info.size.height;if(this.align_center&&!this.desired_position)
factor=2.0;else
factor=1.0;w+=info.dragX*factor;h+=info.dragY*factor;this.setFixedSize({width:Math.min(viewp.width,Math.max(250,w)),height:Math.min(viewp.height,Math.max(76,h))});}else{this.setDesiredPosition({x:info.pos.x+info.dragX,y:info.pos.y+info.dragY,manual:1});}
this.reposition();},ondragend:function(evt,info){}});extendProto(UI.Dialog,UI.DragHandler);UI.MiniDialog=function(id,params){UI.Dialog.call(this,id,{className:'card-outer dialog-outer popup-dialog compact'});this.resizable=false;this.align_center=false;this.close_on_ext_click=true;this.close_on_exit=true;this.modal=false;if(params&&params.modal){this.close_on_exit=false;this.invis_mask=true;}
if(params)extendObject(this,params);}
extendClass(UI.MiniDialog,UI.Dialog,{});UI.PopupMessage=function(id,params){var defaults={modal:true,align_center:true,close_on_exit:false,close_on_ext_click:false,destroy_on_close:true,className:'card-outer dialog-outer popup-default compact popup-message'
};if(params)
extendObject(defaults,params);UI.MiniDialog.call(this,id,defaults);}
extendClass(UI.PopupMessage,UI.MiniDialog,{renderFooter:function(){if(this.show_popup_close){var input=this,foot=this.getFooterElement();this.popup_close_button=new UI.ButtonInput(this.id+'-clsbtn',{icon:'icon-cancel',label:this.close_button_label||app_string('LBL_ADDITIONAL_DETAILS_CLOSE'),onclick:function(evt){input.close();},autofocus:true});foot.appendChild(createElement2('div',{style:'text-align: right'},this.popup_close_button.render()));}
return UI.PopupMessage.superclass.renderFooter.call(this);},performShow:function(){var ret=UI.PopupMessage.superclass.performShow.call(this),self=this;if(this.timeout)
setTimeout(function(){self.close();},this.timeout);var fst=SUGAR.dom.ExtNode(this.elt).findFirst('.autofocus').get(0);if(fst&&fst.focus)fst.focus();return ret;}});UI.Status={uniqid:0,messages:{},order:[],timeouts:{},visible:false,adjust_pos:(isIPhone),show:function(status,timeout){if(!isset(status))return;if(!(status instanceof UI.StatusMessage))
status=new UI.StatusMessage(status);if(!status.id||!this.messages[status.id]){if(!status.id)
status.id='status-msg-'+(++this.uniqid);this.messages[status.id]=status;this.order.push(status.id);}
if(timeout)
this.updateTimeout(status,timeout);this.updateDisplay();return status;},remove:function(status){if(!status)return;if(typeof(status)=='string'&&this.messages[status])
delete this.messages[status];else if(status.id&&this.messages[status.id])
delete this.messages[status.id];this.updateDisplay();},getStatusDiv:function(){if(!this.status_div){this.status_div=createElement2('div',{className:'statusDiv',id:'ajaxStatusDiv'});document.body.appendChild(this.status_div);}
return this.status_div;},updateTimeout:function(status,timeout){if(!status||!status.id||!this.messages[status.id])return;if(this.timeouts[status.id]){clearTimeout(this.timeouts[status.id]);delete this.timeouts[status.id];}
if(timeout)
this.timeouts[status.id]=setTimeout(function(){UI.Status.remove(status.id);},timeout);},cleanup:function(){var ord=[];for(var i=0;i<this.order.length;i++)
if(this.messages[this.order[i]])
ord.push(this.order[i]);this.order=ord;},updateDisplay:function(){var div=this.getStatusDiv();if(!div)return;if(top)div.style.top=''+top+'px';var content=[],seen={};for(var i=0;i<this.order.length;i++){var id=this.order[i];var status=this.messages[id];if(!status)
continue;m=status.getMessage();if(seen[m])continue;content.push(m);seen[m]=1;}
if(content.length){div.innerHTML=html_escape(content.join('\n')).replace(/\n/g,'<br>');toggleDisplay(div,true);this.visible=true;this.reposition();}else{toggleDisplay(div,false);UI.clearChildNodes(div);this.visible=false;}
this.cleanup();},reposition:function(){var div=this.getStatusDiv();if(!div||div.style.display=='none')return;var size=UI.getEltRegion(div),viewp=UI.getViewport(8);if(size&&viewp){if(isIPhone){div.style.position='absolute';div.style.top=viewp.y+'px';div.style.left=((viewp.width-size.width)/2)+viewp.x+'px';}else{div.style.left=((viewp.width-size.width)/2)+'px';div.style.top=''+(viewp.offset||33)+'px';}}},checkPosition:function(){if(this.visible&&this.adjust_pos)this.reposition();}}
UI.addScrollHook(UI.Status.checkPosition,UI.Status);UI.addResizeHook(UI.Status.checkPosition,UI.Status);UI.StatusMessage=function(message,params){this.message=message;var timeout;if(params)
for(var k in params){if(k=='timeout')timeout=params[k];else this[k]=params[k];}};UI.StatusMessage.prototype={show:function(timeout){UI.Status.show(this,timeout);},setMessage:function(msg){this.message=msg;UI.callEvent(this,this.onchange);},getMessage:function(){return this.message;},updateTimeout:function(timeout){UI.Status.updateTimeout(this,timeout);},remove:function(){UI.Status.remove(this);},hide:function(){UI.Status.remove(this);},onchange:function(){UI.Status.updateDisplay();}};UI.SelectOptions=function(params){this.init(params);}
UI.SelectOptions.prototype={clear:function(){this.keys=[];this.values=[];},init:function(params){this.display_name='label';this.add_blank=false;this.dom_name=null;this.dom_module=null;this.language=null;this.limit_keys=null;this.keys=null;this.values=null;this.width=null;if(params)
extendObject(this,params);var keys=[],vals=[];if(this.dom_name){var opts=this.loadOptionsDom(this.dom_name,this.dom_module);if(opts){keys=opts.keys;vals=opts.values;}
if(!params||!params.display_name)this.display_name='_display';}
if(this.limit_keys){if(this.values)vals=this.values;var ks=[],i,v,vs=[];for(i=0;i<keys.length;i++){if(this.limit_keys.indexOf(keys[i])>=0){ks.push(keys[i]);if(Array.isArray(vals))
vs.push(vals[i]);else
vs.push(vals[keys[i]]);}}
keys=ks;vals=vs;}
if(!this.keys)this.keys=deep_clone(keys);if(!this.values)this.values=deep_clone(vals);if(this.add_blank&&this.keys.indexOf('')<0){this.keys.splice(0,0,'');var blank_label=isset(this.blank_label)?this.blank_label:app_string('LBL_NONE');if(Array.isArray(this.values))
this.values.splice(0,0,blank_label);else
this.values['']=blank_label;}},addOption:function(key,value,index){var k=this.getKeyIndex(key);if(k<0){if(isset(index)&&index>=0&&index<this.keys.length){this.keys.splice(index,0,key);}else{index=this.keys.length;this.keys.push(key);}}else
index=k;if(Array.isArray(this.values))
this.values[index]=value;else
this.values[key]=value;return true;},removeOption:function(key){var k=this.getKeyIndex(key);if(k>=0){this.keys.splice(k,1);if(Array.isArray(this.values))
this.values.splice(k,1);else
delete this.values[key];return true;}},replaceOption:function(key,value){if(this.getKeyIndex(key)>=0){this.addOption(key,value);return true;}},getCount:function(){return this.keys&&this.keys.length||0;},getKeys:function(){return this.keys;},getValues:function(keys){if(Array.isArray(this.values)&&(!isset(keys)||keys==this.keys)){return this.values;}
if(!isset(keys))
keys=this.getKeys();var vals=[];if(keys){for(var i=0;i<keys.length;i++)
vals.push(this.getValue(keys[i]));}
return vals;},getKeyIndex:function(key){var k=this.getKeys();if(k)return k.indexOf(key);return-1;},getKey:function(index){var k=this.getKeys();if(k)return k[index];return null;},getValue:function(key){if(Array.isArray(this.values)){var kpos=this.getKeyIndex(key);if(kpos>=0)return this.values[kpos];}else if(this.values)return this.values[key];},getLabel:function(key,display_name){if(!display_name)display_name=this.display_name;var value=this.getValue(key);if(value!==null&&typeof(value)==='object')
value=value[display_name];return isset(value)?''+value:'';},loadOptionsDom:function(dom,module,lang){return UI.getSelectOptions(dom,module,lang||this.language);}};UI.Draggable=function(elt,params){this.elt=Wrap(elt);if(params)extendObject(this,params);if(!this.elt)throw new TypeError('missing draggable element');this.handle=Wrap(this.handle);this.setup();}
UI.Draggable.prototype={setup:function(){this.elt.prop('draggable',!this.handle);if(this.move_cursor)(this.handle||this.elt).css('cursor','move');this.addHooks();},addHooks:function(){this.evts=this.elt.on({dragstart:this.handleDragStart,dragend:this.handleDragEnd,dragstate:this.handleDragState,mouseover:this.handleMouseOver,mouseout:this.handleMouseOut},{scope:this});},getDragTransfer:function(){return this.transfer;},getDragValues:function(){return this.values;},handleMouseOver:function(evt){if(this.handle&&document.contains(this.handle.get())){this.elt.prop('draggable',evt.inside(this.handle));}},handleMouseOut:function(evt){if(this.handle)
this.elt.prop('draggable',false);},handleDragStart:function(evt){if((this.handle&&document.contains(this.handle.get()))&&!evt.inside(this.handle)){evt.preventDefault();return;}
evt.stopPropagation();UI.dragSource=this;evt.originalEvent.dataTransfer.setData('onecrm/draghack','anything');(this.source||UI).setDragData(evt,this.getDragTransfer(),this.getDragValues());UI.callEvent(this,this.onStart,evt);},handleDragEnd:function(evt){if(!UI.dragSource||UI.dragSource!=this){return;}
UI.dragSource=null;var data=UI.getDragData(evt);UI.callEvent(this,this.onEnd,evt,data);if(this.source)this.source.afterDragContent(evt,this,data);},handleDragState:function(evt,state){if(this.source)this.source.dragStateChanged(evt,this,state);UI.callEvent(this,this.onStateChanged,evt,state);},destroy:function(){if(this.evts)this.elt.off(this.evts);this.evts=null;}};UI.DragTarget=function(elt,params){this.elt=Wrap(elt);this.target_events='dragenter, dragover, dragleave, drop';if(params)extendObject(this,params);if(!this.elt)throw new TypeError('missing drag target');this.setup();}
UI.DragTarget.prototype={setup:function(){this.addHooks();},addHooks:function(){this.elt.on(this.target_events,this.handleDragEvent,{scope:this});},beforeDragContent:function(evt,content){},afterDragContent:function(evt,content,data){},dragStateChanged:function(evt,content,state){},checkAccept:function(evt,data){},getDragPosition:function(evt,data){if(evt){var pos=evt.position();if(pos)return pos;}
if(!data)data=UI.getDragData(evt);return data.position;},getDropEffect:function(evt){return this.accept_drop_effect||this.drop_effect||'copy';},getDragData:function(evt){return UI.getDragData(evt);},setDragData:function(evt,transfer,values){if(!values)values={};values.source=this;if(this.source_input)values.source_input=this.source_input;UI.setDragData(evt,transfer,values,this.elt);},acceptDragOver:function(evt,data){var accept=this.checkAccept(evt,data)||false;if(typeof(accept)==='string')
this.accept_drop_effect=accept;else
this.accept_drop_effect=null;return!!accept;},cancelDragOver:function(evt,data){data.over=null;data.over_count=0;data.position=this.getDragPosition(evt);UI.setDragState(evt,null);UI.callEvent(this,this.onLeave,evt,data);},setOver:function(evt,data){data.over=this;data.over_count=1;data.position=this.getDragPosition(evt);UI.callEvent(this,this.onEnter,evt,data);},handleDragEvent:function(evt){var pos,data=this.getDragData(evt);var source=UI.dragSource;var accepted=null;if(this.onAcceptSource){accepted=this.onAcceptSource(evt,data,source);if(accepted==='bubble'){return;}}
if(accepted===null&&this.acceptedSourceTypes){accepted=!!source&&~this.acceptedSourceTypes.indexOf(source.sourceType);}
evt.preventDefault();if(accepted!==null&&!accepted)return;evt.stopPropagation();if(evt.type==='dragover'){if(!data.over){this.setOver(evt,data);}
if(data.over&&(pos=this.getDragPosition(evt,data))){var lastPos=data.position,lastAccept=data.state==='accept',accept=lastAccept;if(!lastPos||lastPos.x!=pos.x||lastPos.y!=pos.y){data.position=pos;accept=this.acceptDragOver(evt,data);if(accept!=lastAccept)
UI.setDragState(evt,accept?(this.drag_ignore?null:'accept'):'reject');if(accept&&!lastAccept)
UI.callEvent(this,this.onAccept,evt,data);else if(!accept&&lastAccept)
UI.callEvent(this,this.onReject,evt,data);UI.callEvent(this,this.onMove,evt,data);}
if(accept){evt.preventDefault();evt.dataTransfer.dropEffect=this.getDropEffect(evt);}}}
else if(evt.type==='dragenter'){if(data.over&&!data.over.elt.equals(this.elt)){data.over.cancelDragOver(evt,data);}
if(!data.over){this.setOver(evt,data);}else{data.over_count++;}}
else if(evt.type==='dragleave'){if(data.over&&data.over.elt.equals(this.elt)&&--data.over_count<=0){this.cancelDragOver(evt,data);}}
else if(evt.type==='drop'){evt.preventDefault();evt.stopPropagation();data.over=null;data.position=this.getDragPosition(evt);if(data.state==='accept'){UI.setDragState(evt,'complete');UI.callEvent(this,this.onDrop,evt,data);}
UI.callEvent(this,this.onLeave,evt,data);}},destroy:function(){this.elt.off(this.target_events);}};UI.SelectList=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;this.options='';this.last_selected_index=null;this.selected_indexes=[];this.disabled_indexes=[];this.hidden_indexes=[];this.current_index=null;this.show_checks=false;this.icon_key=null;this.popup=false;this.flat=false;this.multi_select=false;this.onchange=null;this.oncurrent=null;this.keystate={ctrl:0,shift:0};this.focused=false;this.auto_show_selected=true;this.require_focus=false;this.add_remove_sorted=true;this.options_pad=2;this.options_wrap=false;this.mark_blank=true;this.disable_current=false;if(params)extendObject(this,params);if(this.columns)this.setColumns(this.columns);if(!this.option_height)
this.option_height=this.popup?22:20;this.initOptions();}
UI.SelectList.option_events={click:function(evt){evt.data.scroll.optionClick(this,evt.data,evt);},mouseenter:function(evt){evt.data.scroll.optionEvent(this,evt.data,'over',evt);},mouseleave:function(evt){evt.data.scroll.optionEvent(this,evt.data,'out',evt);},mousedown:function(evt){evt.data.scroll.optionEvent(this,evt.data,'down',evt);UI.stopPropagation(evt);},mouseup:function(evt){evt.data.scroll.optionEvent(this,evt.data,'up',evt);},touchstart:function(evt){evt.data.scroll.optionEvent(this,evt.data,'over',evt);},touchend:function(evt){evt.data.scroll.optionClick(this,evt.data,evt);}};UI.SelectList.prototype={setup:function(){if(this.set_up)return;var input=this;if(!this.popup&&!this.defer_render)
this.render();if(!this.elt)return;if(this.mode_name&&!this.mode_field){this.mode_field=UI.getFormInput(this.form,this.mode_name);var focus=function(evt){input.handleFocus(evt||window.event);},blur=function(evt){input.handleBlur(evt||window.event);};this.mode_field.onfocus=focus;this.mode_field.onblur=blur;this.mode_field.onchange=function(k,v,upd){input.modeUpdated(k);}}
if(!this.tabIndex&&this.elt.tabIndex>0)
this.tabIndex=this.elt.tabIndex;if(!this.field){if(this.name&&this.form)
this.field=this.form.elements[this.name];else if(this.field_id)
this.field=$(this.field_id);}
if(this.add_remove&&this.ref_name){this.ref_input=UI.getFormInput(this.form,this.ref_name);if(this.ref_input){this.ref_input.onchange=function(key,value){this.doTrackView();this.update(null,null,true);input.optionReturn(key,value);}
this.ref_input.popup_return_method='popupReturn';this.ref_input.popupReturn=function(val,count,all,silent){if(!count)return;for(var k in val)
input.optionReturn(val[k].id,val[k]);}}}
if(this.add_remove&&this.sel_name){this.sel_input=UI.getFormInput(this.form,this.sel_name);if(this.sel_input){this.sel_input.onchange=function(key,value){this.update('',this.placeholder,true);input.optionReturn(key,value);}}}
this.placeholder_elt=Wrap(this.elt).findFirst('.input-label').ext(0);if(!this.disable_events)this.addHooks();this.initSelectedKeys();this.updateConditionals();if(!this.popup)
this.handleShow();this.set_up=true;},addHooks:function(){var events={focus:this.handleFocus,blur:this.handleBlur,keydown:this.handleKeyDown,keyup:this.handleKeyUp,keypress:this.handleKeyPress,mousedown:this.handleMouseDown,click:this.handleClick};this.events=UI.addEventListeners(this.elt,events,this);this.initDragTarget();},updateConditionals:function(hide){var keys=this.getSelectedKeys();var callback=function(cf){visible=false;for(var j=0;j<cf.depends_on_value.length;j++){if(~keys.indexOf(cf.depends_on_value[j])){visible=true;break;}}
return visible;}
UI.updateConditionals(this,callback,hide);},initOptions:function(){if(this.options){var opts=UI.getSelectOptions(this.options,null,null,this.add_remove);if(!opts)
console.error('select options not found:',this.options);this.options=opts;}},validate:function(){this.invalid=false;var value=this.getSelectedKeys();if(this.required&&!value.length){this.invalid=true;this.invalidMsg='required';}
this.updateDisplay();return!this.invalid;},getOptions:function(){return this.options;},setOptions:function(opts){this.options=opts;this.initOptions();if(this.rendered)
this.renderOptions();},addOption:function(key,value,index,norender){if(typeof(key)!=='string')return;if(this.keys){if(this.keys.indexOf(key)<0)
this.keys.push(key);}
var o=this.getOptions(),ret,ks;if(o){if(this.add_remove&&!this.options_lookup)
ret=true;else
ret=o.addOption(key,value,index);if(this.add_remove){ks=this.getSelectedKeys();if(ks.indexOf(key)<0){if(isset(index)&&index>=0&&index<ks.length)
ks.splice(index,0,key);else
ks.push(key);this.setSelectedKey(ks,true);}}
if(this.add_remove_sorted)
this.sortOptions();if(this.add_remove&&(this.focused||this.opened))
this.setCurrentIndex(this.getKeyIndex(key));if(this.rendered&&!norender)this.renderOptions();}
return ret;},removeOption:function(key,norender){var sel_ks=this.getSelectedKeys(),ks=this.getKeys();if(this.keys)
this.keys.remove(key);sel_ks.remove(key);if(!this.add_remove||this.options_lookup){this.getOptions().removeOption(key);}
this.setSelectedKey(sel_ks,true);if(isset(this.current_index)&&this.current_index>=ks.length){this.setCurrentIndex(ks.length?ks.length-1:null);}
if(this.rendered&&!norender){this.renderOptions();this.updateDisplay();}},optionReturn:function(key,value){if(key&&value&&this.keys){if(this.keys.indexOf(key)<0){var dname=this.options.display_name||'_display',opt={id:key};opt[dname]=(isObject(value)?(value[dname]||value['_display']):value)+'';if(this.options_lookup&&this.options_lookup.module){opt.icon=this.options_lookup.icon||('theme-icon module-'+this.options_lookup.module);var req=new App.conn.JSONRequest('add_recent',{silent:true,global:true},{module:this.options_lookup.module,record:key,source:'ref'});req.fetch();}
this.addOption(key,opt,null,true);UI.markFormDirty(this);}else{this.setCurrentIndex(this.getKeyIndex(key));}
if(this.rendered){this.renderOptions();this.focus();}}},optionRemove:function(key){if(key&&this.keys){if(this.keys.indexOf(key)>=0){this.removeOption(key,true);UI.markFormDirty(this);}
if(this.rendered){this.renderOptions();this.focus();}}},popupOptionReturn:function(row,count){if(!row)return;var result;for(var i=0;i<count;i++){result=row['ID_'+i];if(result)
this.optionReturn(result.id,result);}},sortOptions:function(){var self=this,opts=this.options,stdKeys,stdIdx,i;if(this.keys){if(this.options_lookup){this.keys.sort(function(a,b){var av=self.getValue(a),bv=self.getValue(b),dn=self.options.display_name||'_display';if(isObject(av))
av=av[dn];if(isObject(bv))
bv=bv[dn];if(!av||!bv||av===bv)return 0;if(av<bv)return-1;return 1;});}else if(opts){stdKeys=opts.getKeys();stdIdx={};for(i=0;i<stdKeys.length;i++){stdIdx[stdKeys[i]]=i;}
this.keys.sort(function(a,b){var ia=stdIdx[a],ib=stdIdx[b];if(ia!==undefined||ib!==undefined){if(ia===undefined)return 1;else if(ib===undefined)return-1;if(ia===ib)return 0;return(ia<ib?-1:1);}
var av=self.getValue(a),bv=self.getValue(b),dn=self.options.display_name||'_display';if(isObject(av))
av=av[dn];if(isObject(bv))
bv=bv[dn];if(!av||!bv||av===bv)return 0;if(av<bv)return-1;return 1;});}}},initSelectedKeys:function(){if(!this.field)return;var val=this.field.value,ks=[];vals=val.split('^,^');if(this.add_remove){this.keys=null;for(var i=0;i<vals.length;i++)
if(this.hasKey(vals[i]))ks.push(vals[i]);this.keys=ks;if(this.add_remove_sorted)
this.sortOptions();}
this.setSelectedKey(vals,true,true);},getSelectedIndex:function(){return this.last_selected_index;},getSelectedIndexes:function(){return this.selected_indexes.slice(0);},getDisabledIndexes:function(){return this.disabled_indexes.slice(0);},getHiddenIndexes:function(){return this.hidden_indexes.slice(0);},getSelectedKey:function(){var k=this.getKeys();return k[this.last_selected_index];},getSelectedValue:function(){var o=this.getOptions();if(o)return o.getValue(this.getSelectedKey());},getSelectedKeys:function(){var k=this.getKeys();var sel=[],idx;for(var i=0;i<this.selected_indexes.length;i++)
sel.push(k[this.selected_indexes[i]]);return sel;},getDisabledKeys:function(){var k=this.getKeys();var sel=[];for(var i=0;i<this.disabled_indexes.length;i++)
sel.push(k[this.disabled_indexes[i]]);return sel;},getKeys:function(options_only){if(this.keys&&!options_only)return this.keys;var o=this.getOptions();if(o)return o.getKeys();return[];},getKeyIndex:function(key){var k=this.getKeys();if(k)return k.indexOf(key);return-1;},hasKey:function(key){return(this.getKeyIndex(key)>=0);},getValues:function(keys){if(!isset(keys))
keys=this.getKeys();var o=this.getOptions();if(o)return o.getValues(keys);return[];},getKey:function(index){var o=this.getOptions();if(o)return o.getKey(index);return null;},getValue:function(key){var o=this.getOptions();if(o)return o.getValue(key);return null;},getOptionLabel:function(key){var o=this.getOptions();if(o)return o.getLabel(key);return'';},getBlankKey:function(){if(isset(this.blank_key))return this.blank_key;var o=this.getOptions();return o&&o.blank_key||'';},getCurrentIndex:function(idx){return this.current_index;},adjustCurrentIndex:function(adj,nowrap,evt){if(!adj)adj=0;if(!isset(this.current_index)){return this.setCurrentIndex(adj==1?0:adj,nowrap);}else if(this.current_index==0&&adj<0){if(!nowrap)return this.setCurrentIndex(null);}else
return this.setCurrentIndex(this.current_index+adj,nowrap,null,evt);},setCurrentIndex:function(idx,nowrap,silent,evt){var old=this.current_index;if(isset(idx)){var k=this.getKeys();if(idx<0){if(!nowrap)
idx=k.length+idx;if(idx<0)
idx=nowrap?0:null;}
if(idx>=k.length){idx=nowrap?k.length-1:null;}}else
idx=null;if(!this.canPositionOver(idx,evt))return false;this.current_index=idx;this.updateOptionsState([old,idx]);if(this.focused||!evt)
this.showCurrent(evt);if(!silent&&old!==idx)
UI.callEvent(this,this.oncurrent,idx,old);},getOptionRow:function(index){return this.body?this.body.childNodes[index]:null;},getOptionCount:function(){return this.getKeys().length;},getRowCount:function(){return this.add_remove?this.getSelectedIndexes().length:this.getKeys().length;},getScrollPosition:function(){return this.body?this.body.scrollTop:0;},getOptionPosition:function(index){var rgn,rel_top,elt,ergn;if(!isset(index)||!this.body||!(elt=this.body.childNodes[index]))return;rgn=UI.getEltRegion(this.body);if(!(ergn=UI.getEltRegion(elt))||!ergn.height)return;ergn.rel_top=ergn.top-rgn.top;ergn.body_top=rgn.top;ergn.body_height=rgn.height;ergn.scroll_top=ergn.rel_top+this.body.scrollTop;ergn.scroll_height=this.body.scrollHeight;return ergn;},getRowData:function(indexes){var keys=this.add_remove?this.getSelectedKeys():this.getKeys();var qkeys;if(isset(indexes)){qkeys=[];for(var i=0;i<indexes.length;i++)
qkeys.push(keys[indexes[i]]);}else
qkeys=keys;var values=this.getValues(qkeys);var selected=this.getSelectedIndexes();var disabled=this.getDisabledIndexes();var hidden=this.getHiddenIndexes();var sel_map={},dis_map={};for(var i=0;i<selected.length;i++)
sel_map[selected[i]]=1;for(var i=0;i<disabled.length;i++)
dis_map[disabled[i]]=1;var ret=[];var sel=0,dis=0;for(var i=0;i<qkeys.length;i++){if(hidden.indexOf(i)>=0)
continue;var key=qkeys[i];var idx=isset(indexes)?indexes[i]:i;sel=!!sel_map[idx];dis=!!dis_map[idx];var status={selected:sel,disabled:dis,current:idx==this.current_index};if(this.mark_blank&&key===this.getBlankKey())
status.blank=true;ret.push({key:key,value:values[i],status:status,index:idx});sel=dis=0;}
return ret;},setColumns:function(cols){if(cols)
this.columns=cols.slice(0);},getColumns:function(){var src=this.columns;var default_column=this.label_key||'label';var o=this.getOptions();if(o&&o.display_name)default_column=o.display_name;if(!src&&o)src=o.columns;var cols=[],maincol;if(this.show_checks)
cols.push({type:'check'});if(src){for(var i=0;i<src.length;i++){var c=src[i];if(typeof(c)=='string')
cols.push({name:c});else
cols.push(c);}}else{if(this.icon_key)
cols.push({name:this.icon_key,type:'icon'});cols.push(maincol={name:default_column});if(this.expand)maincol.expand=this.expand;if(this.expand_property)maincol.expand_property=this.expand_property;}
return cols;},getWidth:function(){if(this.width)return UI.formatSize(this.width);var o=this.getOptions()
if(o&&o.width)return UI.formatSize(o.width);if(this.popup){if(o&&o.maxlen)return UI.formatSize(''+(Math.min(Math.max(o.maxlen,10),20)*0.8)+'em');return'150px';}},render:function(){if(this.rendered)return this.elt;if(!this.elt&&!(this.elt=$(this.id))){var cls=this.className?this.className:(this.popup?'card-outer panel-outer panel-border panel-default panel-round popup-default ':(this.flat?'':'input-field '));if(this.block)cls+=' input-block';if(this.ext_class)cls+=' '+this.ext_class;this.elt=createElement2('div',{id:this.id,className:cls,tabIndex:this.tabIndex});if(this.popup)toggleDisplay(this.elt,false);}
var w=this.getWidth();if(w&&!this.block)this.elt.style.width=w;if(!this.body){this.body=Wrap(this.elt).findFirst('.menu-outer').get(0)||
createElement2('div',{className:'card-body menu-outer input-scroll',style:'width: 100%;'});}
this.elt.appendChild(this.body);this.rendered=true;return this.elt;},autoShowSelected:function(){if(this.rendered)this.showSelected();},focus:function(){if(this.elt)
this.elt.focus();},handleFocus:function(evt){if(!this.focused){this.focused=true;UI.callEvent(this,this.onfocus,evt);this.updateOptionsState();this.updateDisplay();}},handleBlur:function(evt){if(this.focused){this.focused=false;UI.callEvent(this,this.onblur,evt);if(!this.opened)this.setCurrentIndex(null);this.updateOptionsState();this.updateDisplay();}},setPanelHeight:function(immed){if(!this.body)return;if(!immed)setTimeout((function(){this.setPanelHeight(true);}).bind(this),0);var rmax=this.rows,rmin=this.min_rows||0,minh=null,maxh=null,opth=this.getOptionHeight();if(this.add_remove){rmin=Math.max(1,rmin);}
if(rmin&&opth){minh=rmin*opth+this.options_pad*2;}
if(isset(rmax)&&opth){maxh=rmax*opth+this.options_pad*2;}
Wrap(this.body).cssSize('min-height',minh).cssSize('max-height',maxh);},getOptionHeight:function(){if(!this.height_fixed&&this.rendered){var cls=this.elt.className;if(cls!==this.option_height_cls||!this.option_height){var columns=this.getColumns(),row={key:'_hght_',value:'_',status:{},index:-1},snd=Wrap(this.renderOption(row,columns)).prependTo(this.body),fst=Wrap(this.renderOption(row,columns)).prependTo(this.body),topOffs=fst.bounds(this.body,true),sndOffs=snd.bounds(fst);fst.remove();snd.remove();if(topOffs&&topOffs.height){this.options_pad=topOffs?topOffs.top:0;this.option_height=sndOffs?sndOffs.top:0;this.option_height_cls=cls;}
if(this.option_height<14)this.option_height=20;}}
return this.option_height;},handleResize:function(pos,viewp){this.updateDisplay();},handleKeyDown:function(evt){if(evt.keyCode==38)nav=-1;else if(evt.keyCode==40)nav=1;else if(evt.keyCode==37||evt.keyCode==39){UI.callEvent(this,this.onprevnext,evt,evt.keyCode==39);UI.stopEvent(evt);return;}
else nav=0;if(nav){this.adjustCurrentIndex(nav,null,evt);UI.stopEvent(evt);}else if(evt.keyCode==32||((this.popup||this.add_remove||this.keyboard_select)&&evt.keyCode==13)){if(this.add_remove){if(!this.opened&&!this.disabled)
this.showSearch();else
this.hideSearch();}
else if(isset(this.current_index))
this.toggleSelected(this.current_index,null,null,null,evt);UI.stopEvent(evt);}else if(evt.keyCode==8||evt.keyCode==46){if(this.add_remove){var cidx=this.getCurrentIndex(),key;if(isset(cidx)&&this.keys){this.removeOption(this.keys[cidx]);UI.markFormDirty(this);}}
UI.stopEvent(evt);}else if(!this.popup&&evt.keyCode==13){UI.stopEvent(evt);if(this.form)UI.submitForm(this.form);}else if(this.popup&&evt.keyCode==192){UI.stopEvent(evt);var p=App.popups.getCurrent();if(p)p.close_on_exit=false;}else if(evt.keyCode==27){this.cancel(true);UI.stopEvent(evt);}
UI.callEvent(this,this.onkeydown,evt);},handleKeyUp:function(evt){UI.callEvent(this,this.onkeyup,evt);},handleKeyPress:function(evt){if(UI.callEvent(this,this.onkeypress,evt)===false)return;if(evt.charCode){var last=this.keypress_time,cur=new Date().getTime(),pfx=this.keypress_buffer;if(!last||cur-last>400)
pfx='';this.keypress_buffer=pfx+String.fromCharCode(evt.charCode).toLowerCase();this.keypress_time=cur;var key=this.findKeyPrefix(this.keypress_buffer);if(!isset(key)){this.setCurrentIndex(null,0,0,evt);key=this.findKeyPrefix(this.keypress_buffer);}
if(isset(key))
this.setCurrentIndex(this.getKeyIndex(key),0,0,evt);}},findKeyPrefix:function(pfx){var ks,i,l=pfx.length,sel=this.getSelectedKey(),first;if(!l||!(ks=this.getKeys()))return;var curr_idx=this.getCurrentIndex();for(i=0;i<ks.length;i++){if(ks[i]===sel)
continue;var val=this.getOptionLabel(ks[i]);if(val.substring(0,l).toLowerCase()===pfx){var key_idx=this.getKeyIndex(ks[i]);if(key_idx==curr_idx||key_idx<curr_idx)
continue;if(!isset(first))first=ks[i];}}
return first;},handleMouseDown:function(evt){if(this.add_remove){UI.stopPropagation(evt);if(this.opened)return;}
if(!this.focused)
this.focus();UI.callEvent(this,this.onmousedown,evt);},handleClick:function(evt){if(this.add_remove){if(!this.opened&&!this.disabled)
this.showSearch();else
this.hideSearch();evt.stopEvent();}
else if(!this.focused)
this.focus();UI.callEvent(this,this.onclick,evt);},canPositionOver:function(idx,evt){var mpos=evt?{x:evt.clientX||evt.x,y:evt.clientY||evt.y}:null;if(!this.scroll_panel||!isset(idx))return true;return this.scroll_panel.canShowStep(idx,mpos);},showIndex:function(idx){var pos=this.getOptionPosition(idx),top,btm;if(pos){top=(idx==0?0:pos.scroll_top);btm=pos.scroll_top+pos.height;if(idx==this.body.childNodes.length-1)
btm=pos.scroll_height;if(top<this.body.scrollTop)
this.body.scrollTop=top;else if(btm>this.body.scrollTop+pos.body_height){this.body.scrollTop=btm-pos.body_height;}}},showCurrent:function(evt){var mpos=evt?{x:evt.clientX||evt.x,y:evt.clientY||evt.y}:null;this.showIndex(this.current_index,mpos);},showSelected:function(){var idx=this.getSelectedIndexes();if(idx.length)this.showIndex(idx[0]);},handleShow:function(){this.initDragTarget();this.renderOptions();if(this.auto_show_selected)
this.autoShowSelected();},cancel:function(refocus){if(!this.popup)
this.setCurrentIndex(null);UI.callEvent(this,this.oncancel,refocus);},destroy:function(){UI.removeNode(this.elt,true);this.elt=this.field=null;this.rendered=false;this.set_up=false;if(this.scroll_panel)this.scroll_panel.destroy();this.scroll_panel=null;this.opts_table=null;this.visible_rows=null;this.focused=false;UI.callEvent(this,this.ondestroy);},selectCurrent:function(evt){if(isset(this.current_index)){this.setSelected(this.current_index,null,null,evt);return true;}},clearSelected:function(){if(this.keys&&this.keys.length){for(var i=this.keys.length;i>=0;i--)
this.removeOption(this.keys[i]);UI.markFormDirty(this);}},setSelected:function(index,silent,nosource,evt){this.selected_indexes=[];this.last_selected_index=null;this.toggleSelected(index,1,silent,nosource,evt);},toggleSelected:function(index,state,silent,nosource,evt){var disabled=this.getDisabledIndexes();var dis_map={};for(var i=0;i<disabled.length;i++)
dis_map[disabled[i]]=1;if(dis_map[index])return;var oldSel=this.multi_select?this.selected_indexes:this.last_selected_index;if(!isset(state))state=-1;else if(state!==-1)state=state?1:0;if(isset(index)){if(!Array.isArray(index))
index=[index];var keys=this.getKeys();var selPos={},sel=this.getSelectedIndexes();for(var i=0;i<sel.length;i++)
selPos[sel[i]]=i;var idx,remove=[];for(var i=0;i<index.length;i++){idx=index[i];if(idx<0||idx>=keys.length)
continue;if(isset(selPos[idx])){remove.push(selPos[idx]);if(state<1)
delete selPos[idx];else{selPos[idx]=sel.length;this.last_selected_index=idx;sel.push(idx);}}else if(state){selPos[idx]=sel.length;this.last_selected_index=idx;sel.push(idx);}}
remove.sort(cmpFn);for(var i=0;i<remove.length;i++)
sel.splice(remove[i],1);if(!this.multi_select&&sel.length>1)
sel=[sel.pop()];this.selected_indexes=sel;}
if(this.add_remove)this.renderOptions();else this.updateOptionsState();if(!nosource&&this.field){var selKeys=[];if(isset(index)){for(var k=0;k<sel.length;k++){selKeys.push(keys[sel[k]]);}}
this.field.value=selKeys.filter(function(k){return(''+k).length}).join('^,^');}
if(!silent)
UI.callEvent(this,this.onchange,oldSel,evt);this.updateConditionals();},setSelectedKey:function(keys,silent,nosource){var idx=[];if(!Array.isArray(keys))
keys=isset(keys)?[keys]:[];for(var i=0;i<keys.length;i++)
idx.push(this.getKeyIndex(keys[i]));this.setSelected(idx,silent,nosource);},renderOptions:function(){var body=this.body;if(!body)return;UI.clearChildNodes(body);var columns=this.getColumns();var rows=this.getRowData();for(var i=0;i<rows.length;i++){if(this.add_remove&&this.selected_indexes.indexOf(i)<0)
continue;var opt=this.renderOption(rows[i],columns);if(opt)body.appendChild(opt);}
if(!rows.length&&this.placeholder){MakeElt('div.menu-option.static.placeholder',this.placeholder).appendTo(body);}
this.updateDisplay();},cleanOptionValue:function(row){var value=row.value,opts=this.getOptions(),dn=(opts&&opts.display_name)||'label',v;if(typeof(value)!='object')value=''+value;if(typeof(value)=='string'){v={};v[dn]=value;value=v;}
return value;},renderOption:function(row,columns){var value=this.cleanOptionValue(row),extCls=[],dragCfg=this.getDragConfig(),elt,ext_url,display,wrapElt,rowCls,staticRow;for(var k in row.status){if(row.status[k]&&(k!=='selected'||!this.add_remove))
extCls.push(k);}
if(this.disable_current)extCls.push('static');if(!this.options_wrap)extCls.push('single');if(this.options_active)extCls.push('color');extCls=extCls.join(' ');rowCls='menu-option '+extCls;if(value._header){rowCls='menu-header';staticRow=true;}else if(value._separator){rowCls='menu-separator';staticRow=true;}
elt=createElement2('div',{className:rowCls});wrapElt=Wrap(elt).reinit();var optinfo={scroll:this,key:row.key,value:value,index:row.index};elt.optinfo=optinfo;if(staticRow){if(value._header){UI.setElementContent(elt,value.label);}}
else{for(var evt in UI.SelectList.option_events){var handler=(this.events&&isdef(this.events['on'+evt]))?this.events['on'+evt]:UI.SelectList.option_events[evt];if(handler)
wrapElt.on(evt,optinfo,handler);}
for(var ci=0;ci<columns.length;ci++){var cdef=columns[ci];var t=cdef.type;var colcls,lbl,icon;if(t=='check')
colcls='option-check';else if(t=='icon')
colcls='option-icon';else if(t=='color')
colcls='option-icon';else if(cdef.icon)
colcls='with-icon';else
colcls='';var col=createElement2('div',{className:'option-cell input-label '+colcls});if(cdef.width){UI.setWidth(col,cdef.width);Wrap(col).cssSize('flex-basis',cdef.width);}
if(cdef.align)
col.style.textAlign=cdef.align;if(cdef.expand||(cdef.expand_property&&value[cdef.expand_property]))
UI.addClass(col,'rbullet rbullet-right');if(t=='check');else if(t=='icon'){icon='';if(cdef.name=='key')
icon=''+row.key;else if(isset(value)&&typeof(value)=='object')
icon=''+value[cdef.name];if(this.active_icons)icon+=' active';col.appendChild(UI.createIcon(icon));}
else if(t=='color'){icon=''+value[cdef.name||'color'];icon=MakeElt('div.input-icon.input-color-icon',{style:'background-color: '+icon});icon.appendTo(col);}
else{if(cdef.icon){col.appendChild(UI.createIcon(value[cdef.icon]));}
if(value){if(!isset(display))display=value[cdef.name];col.appendChild(document.createTextNode(get_default(value[cdef.name],'')));}}
elt.appendChild(col);}}
if(value){if(dragCfg&&dragCfg.as_source&&(get_default(dragCfg.options_default,true)
||(dragCfg.options_key&&value[dragCfg.options_key]))){new UI.Draggable(elt,{sourceType:'SelectListItem',source:this.drag_target,onStateChanged:function(evt,state){UI.addRemoveClass(elt,'drag-remove',state.value==='accept');},values:{index:row.index,key:row.key,option:value}});}
else if(value.url&&(!dragCfg||!dragCfg.options_key)){ext_url=value.url;if(ext_url.indexOf('://')<0)
ext_url=''+App.session.site_url+ext_url;new UI.Draggable(elt,{sourceType:'SelectListItem',source:this.drag_target,transfer:{'text/plain':display||ext_url,'text/uri-list':ext_url,'url':ext_url},values:{index:row.index,key:row.key,option:value,url:ext_url}});}}
if(this.add_remove){var col=createElement2('div',{className:'option-cell input-label option-remove'});var rem=createElement2('div',{className:'uii uii-remove active-icon'});var self=this;rem.onmousedown=rem.ontouchstart=UI.stopPropagation;rem.onmouseup=function(evt){self.optionEvent(elt,optinfo,'remove',evt);}
col.appendChild(rem);elt.appendChild(col);}
return elt;},updateOptionsState:function(indexes){if(!this.body)return;var std={'selected':1,'current':1,'disabled':1};var done={};var rows=this.getRowData(indexes);for(var i=0;i<rows.length;i++){var row=rows[i];if(done[row.index])continue;done[row.index]=1;var tr=this.body.childNodes[row.index];if(!tr)continue;var cls=[];var parts=tr.className.split(/\s+/);for(var p=0;p<parts.length;p++){var c=parts[p];if(c&&!std[c]){if(c=='active'&&!row.status.current)
continue;cls.push(c);}}
for(var c in std){if(c=='current'&&!this.focused&&this.require_focus&&!this.add_remove)
continue;if(c=='current'&&this.disable_current)
continue;if(c=='selected'&&this.add_remove)
continue;if(row.status[c])
cls.push(c);}
tr.className=cls.join(' ');}},optionClick:function(elt,optinfo,evt){if(this.add_remove){return;}
if(evt.type==='touchend'){UI.preventDefault(evt);if(this.lastOverPos&&Math.abs(this.lastOverPos.x-evt.pageX)+Math.abs(this.lastOverPos.y-evt.pageY)>5)return;}
var undoMeta=null;if(isset(this.metaPressed)&&this.metaPressed==optinfo.index){undoMeta=window.metaKeyPressed;window.metaKeyPressed=true;}
this.toggleSelected(optinfo.index,null,null,null,evt);UI.stopPropagation(evt);if(isset(undoMeta))
window.metaKeyPressed=undoMeta;},optionEvent:function(elt,info,state,evt){if(this.popup){var p=elt;while(p&&p!==window){if(isset(p.popup_visible)&&!p.popup_visible)return;p=p.parentNode;}}
if(state=='over'&&!this.disable_current){if(this.lastOverPos&&this.lastOverPos.x==evt.pageX&&this.lastOverPos.y==evt.pageY)return;this.setCurrentIndex(info.index,0,0,evt);this.metaPressed=null;this.lastOverPos={x:evt.pageX,y:evt.pageY};}
else if(state=='move'){if(evt&&evt.touches.length==1){var c=this.getOptionCount(),i=0,pos,found;for(;i<c;i++){pos=this.getOptionPosition(i);if(evt.pageY>=pos.top&&evt.pageY<=pos.top+pos.height&&evt.pageX>=pos.left&&evt.pageX<=pos.left+pos.width){this.setCurrentIndex(i,0,0,evt);info.index=i;found=1;break;}}
if(!found){this.setCurrentIndex(null,0,0,evt);info.index=null;}}}
else if(this.current_index===info.index){if(state=='out'||state=='down'||state=='up'){var targ=evt.relatedTarget;while(targ&&targ.parentNode){targ=targ.parentNode;if(targ===elt)return;}}
if(state=='out'){this.setCurrentIndex(null,0,0,evt);}
else if(state=='down'){UI.addClass(elt,'active');if(evt&&(evt.which==2||(!evt.which&&evt.button==4)))
this.metaPressed=info.index;}
else if(state=='up'){UI.removeClass(elt,'active');}
else if(state=='remove'){if(this.keys){this.removeOption(info.key);UI.markFormDirty(this);}
if(this.opened)
this.hideSearch();UI.stopEvent(evt);}}},modeUpdated:function(mode){this.updateDisplay();if(mode){if(this.getRowCount())
this.focus();else
this.showSearch();}else{this.clearSelected();}},updateDisplay:function(){if(this.mode_field){UI.setDisplayState(this.elt,!!this.mode_field.getValue());}
if(this.header_text){if(!this.header_elt)this.header_elt=MakeElt('div.input-field-header').prependTo(this.elt);this.header_elt.text(this.header_text);}else{UI.setDisplayState(this.header_elt,false);}
UI.addRemoveClass(this.elt,'active',!!(this.focused||this.opened||this.dragover));if(this.add_remove){UI.addRemoveClass(this.elt,'flat-bottom',!!this.opened);if(this.getRowCount()){UI.setDisplayState(this.body,true);UI.setDisplayState(this.placeholder_elt,false);}else{if(!this.placeholder_elt){this.placeholder_elt=MakeElt('div.input-label').appendTo(this.elt);}
this.placeholder_elt.text(this.placeholder||app_string('LBL_NONE'));UI.setDisplayState(this.body,!!this.full_height);UI.setDisplayState(this.placeholder_elt,!this.full_height);this.placeholder_elt.toggleClass('text-placeholder',!this.focused&&!this.opened);}}
this.setPanelHeight();},initSearcher:function(){var self=this,lookup=this.options_lookup,search_opts={allow_clear:true,disable_recent:true,target:this.elt,target_offset:{top:-1,left:0},form:this.form,options:this.options};if(this.label_key)
search_opts.display_name=this.label_key;if(this.icon_key)
search_opts.icon_key=this.icon_key;if(this.add_remove)
search_opts.popup_return_multiple=true;if(this.add_remove&&lookup){delete search_opts.options;search_opts.disable_recent=lookup.disable_recent;search_opts.module=lookup.module;search_opts.extra_fields=lookup.extra_fields;search_opts.filters=lookup.filters;search_opts.popup_layout=lookup.popup_layout;search_opts.quick_create=lookup.quick_create;search_opts.allow_popup=get_default(lookup.allow_popup,true);search_opts.passthru={ui_input_name:this.name||this.id,ui_return_method:'popupOptionReturn'
};}else{search_opts.search_blank=true;search_opts.matching_only=true;}
this.searcher=new UI.SearchSelect(this.id+'-search',search_opts);this.searcher.onchange=function(k,v,mod,keepOpen){self.optionReturn(k,v);if(keepOpen){this.setSourceKeys(self.getKeys());this.reposition();}
else
self.focus();}
this.searcher.onremove=function(k,v,mod,keepOpen){self.optionRemove(k);if(keepOpen){this.setSourceKeys(self.getKeys());this.reposition();}
else
self.focus();}
this.searcher.onshow=function(){self.opened=true;self.updateDisplay();}
this.searcher.onhide=function(){self.opened=false;self.updateDisplay();}
this.searcher.onclear=function(){self.clearSelected();}
this.searcher.oncancel=function(){self.focus();}
this.searcher.setup();},showSearch:function(query){if(!this.searcher){this.initSearcher();}
this.searcher.render();var w=UI.getEltRegion(this.elt),k=this.getKeys();if(w)
this.searcher.setWidth(Math.max(w.width-24,300)+'px');this.searcher.setSourceKeys(k);this.searcher.showDefault(true);},hideSearch:function(){if(this.searcher)
this.searcher.close();},getDragConfig:function(){return this.drag_config;},setDragConfig:function(cfg){this.drag_config=cfg;this.initDragTarget();},initDragTarget:function(){if(!this.elt)return;var cfg=this.getDragConfig();if(cfg&&cfg.as_source){if(!this.drag_target){this.drag_target=new UI.DragTarget(this.elt,{move_cursor:cfg.move_cursor,source_input:this,beforeDragContent:function(evt,drag){this.drag_index=drag.getDragValues().index;this.drag_row=drag.elt;cfg.beforeDragContent&&cfg.beforeDragContent(evt,drag);}.bind(this),afterDragContent:function(evt,drag,data){delete this.drag_index;delete this.drag_row;cfg.afterDragContent&&cfg.afterDragContent(evt,drag,data);}.bind(this),onMove:function(evt,data){this.setDragPosition(evt,data);cfg.onMove&&cfg.onMove(evt,data);}.bind(this),checkAccept:cfg.checkAccept||function(){},onAccept:cfg.onAccept,onLeave:function(evt,data){this.setDragPosition(evt,data);cfg.onLeave&&cfg.onLeave(evt,data);}.bind(this),onDrop:cfg.onDrop});}}else{if(this.drag_target){this.drag_target.destroy();this.drag_target=null;}}},setDragPosition:function(evt,data){var dragCfg=this.getDragConfig(),lastIndex,lastPos,pos=data.position;if(!dragCfg)return;lastIndex=data.target_index;if(!this.body)return;data.target_index=null;data.after_elt=null;if(pos&&data.state==='accept'){var wrapBody=Wrap(this.body),bodyPos=wrapBody.bounds(),ypos=pos.y-bodyPos.top+wrapBody.scrollTop(),idx=0,prevRow,prevIdx,rowBounds,row,i;for(i=0;i<this.body.childNodes.length;i++){row=this.body.childNodes[i];if(UI.hasClass(row,'drag-indicator')||UI.hasClass(row,'placeholder'))
continue;if(row.offsetTop>=ypos){data.target_index=idx;data.after_elt=row;if(prevRow){rowBounds=Wrap(prevRow).bounds();if(rowBounds.top+rowBounds.height/2>=pos.y){data.target_index=prevIdx;data.after_elt=prevRow;}}
break;}
prevRow=row;prevIdx=idx;idx++;}
if(data.target_index===null)
data.target_index=idx;}
if(data.target_index!==lastIndex){var dragIdx=this.drag_index,tgtIdx=data.target_index;this.drag_ignore=false;if(data.self&&isset(dragIdx)&&
(dragIdx===tgtIdx||dragIdx+1===tgtIdx)){this.drag_ignore=true;}
if(data.target_index!==null&&!this.drag_ignore){Wrap(this.body).find('.menu-option.placeholder').hide();if(!dragCfg.indicator_elt&&get_default(dragCfg.position_target,true)){if(dragCfg.create_indicator_elt){dragCfg.indicator_elt=dragCfg.create_indicator_elt(this);}else{var columns=this.getColumns();var row={key:'_drag_',value:'',status:{},index:-99};var opt=this.renderOption(row,columns);if(opt){UI.addClass(opt,'drag-indicator');dragCfg.indicator_elt=Wrap(opt);}}}
if(dragCfg.indicator_elt){this.body.insertBefore(dragCfg.indicator_elt.get(),data.after_elt||null);}}else if(dragCfg.indicator_elt){dragCfg.indicator_elt.remove();dragCfg.indicator_elt=null;Wrap(this.body).find('.menu-option.placeholder').show();}
requestAnimationFrame(this.updateDisplay.bind(this));}}};UI.SelectInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;this.menu_id=this.id+'-popup';this.show_checks=true;this.close_on_exit=true;this.require_existing=false;this.mark_blank=true;var options;if(params&&params.options){options=params.options;delete params.options;}else
options='';if(params)extendObject(this,params);if(!this.menu){if(options instanceof UI.SelectList){this.menu=options;}
else{this.menu=new UI.SelectList(this.menu_id,{options:options,popup:true,show_checks:this.show_checks,width:this.options_width,className:this.popup_class_name,icon_key:this.icon_key,disabled_indexes:this.disabled_indexes||[],mark_blank:this.mark_blank});}}}
UI.SelectInput.prototype={setup:function(){if(this.set_up)return;if(!this.elt)
this.elt=$(this.id);if(!this.field){if(this.name&&this.form)
this.field=this.form.elements[this.name];else if(this.field_id)
this.field=$(this.field_id);}
if(!this.outer){if(this.outer_id)
this.outer=$(this.outer_id);else
this.outer=this.elt;}
if(this.menu){if(this.elt&&this.elt.tabIndex)
this.menu.tabIndex=this.elt.tabIndex;else if(!this.menu.tabIndex)
this.menu.tabIndex=1;}
if(this.dynamic_module&&!this.module_field){this.module_field=this.form.elements[this.dynamic_module];}
if(!this.altInput&&this.alt_name){this.altInput=UI.getFormInput(this.form,this.alt_name);}
if(!this.elt)return;if(!this.tabIndex&&this.elt.tabIndex>0)
this.tabIndex=this.elt.tabIndex;if(this.field)this.orig_value=this.field.value;this.addHooks();this.updateDisplay();this.set_up=true;this.updateConditionals();},addHooks:function(){var input=this;if(this.elt){UI.addEventListener(this.elt,'selectstart',UI.stopEvent);UI.addEventListener(this.elt,'mousedown',UI.stopPropagation);UI.addEventListener(this.elt,'click',this.handleClick,this);UI.addEventListener(this.elt,'touchstart',UI.preventDefault);UI.addEventListener(this.elt,'touchend',this.handleClick,this);UI.addEventListener(this.elt,'focus',this.handleFocus,this);UI.addEventListener(this.elt,'blur',this.handleBlur,this);UI.addEventListener(this.elt,'keydown',this.handleKeyDown,this);UI.addEventListener(this.elt,'keypress',this.handleKeyPress,this);}
if(this.altInput){this.altInput.onchange=function(){input.update();}}
this.menu.onkeypress=function(evt){input.handleKeyPress(evt);return false;}},getField:function(){return this.field;},getValue:function(){return(this.field?this.field.value:get_default(this.init_value,null));},getOptionValue:function(key){if(!isset(key))key=this.getValue();return this.menu?this.menu.getValue(key):key;},checkAltValue:function(){var v;if(this.altInput&&(v=this.altInput.getValue())){return v;}},setValue:function(key,silent){var v=key;if(this.menu&&!(v=this.menu.getValue(key))){console.error(this.id+' key not defined: '+key);return;}
this.update(key,v,silent);},setOptions:function(opts){if(this.menu)return this.menu.setOptions(opts);},focus:function(){if(this.elt)this.elt.focus();},handleClick:function(evt){if(this.opened){this.hidePopup();}
else if(!this.disabled){this.showDefault();}
UI.stopEvent(evt);},handleFocus:function(evt){if(!this.focused){this.focused=true;UI.callEvent(this,this.onfocus,evt);}
this.updateDisplay();},handleBlur:function(evt){if(this.focused){this.focused=false;UI.callEvent(this,this.onblur,evt);this.updateDisplay();}},handleKeyDown:function(evt){if(evt.keyCode==27){if(this.clear())
UI.stopEvent(evt);}
else if(evt.keyCode==32){UI.stopEvent(evt);if(!this.opened&&!this.disabled)this.showDefault(evt);}
else if(evt.keyCode==13){UI.stopEvent(evt);if(!this.opened&&!this.disabled)this.showDefault(evt);}},handleKeyPress:function(evt){if(evt.charCode&&evt.charCode!=27){if(!this.disabled&&this.opened!=='search'){this.showSearch();}}},findKeyPrefix:function(pfx){var ks,i,l=pfx.length,sel=this.getValue(),first,foundsel;if(!l||!this.menu||!(ks=this.menu.getKeys()))return;for(i=0;i<ks.length;i++){if(ks[i]===sel){foundsel=true;continue;}
var val=this.menu.getOptionLabel(ks[i]);if(val.substring(0,l).toLowerCase()===pfx){if(foundsel)return ks[i];if(!isset(first))first=ks[i];}}
return first;},getTargetOffset:function(target){var btnpos=UI.getEltRegion(target||this.elt);var viewp=UI.getViewport();var top=-this.menu.getSelectedIndex()*this.menu.getOptionHeight()-this.menu.options_pad;top=Math.max(viewp.y-(btnpos?btnpos.top:0)+10,top);return{top:top,left:-19,over:true};},showDefault:function(evt){if((evt&&evt.type=='touchend'&&!this.show_stacked)||(evt&&evt.cmdKey)||this.always_search)
this.showSearch();else
this.showPopup();},showPopup:function(timeout,target,offset){this.selected=this.getValue();if(!this.menu)return;this.menu.setSelectedKey(this.selected,true);this.menu.setCurrentIndex(this.menu.getSelectedIndex(),null,true);var input=this;this.menu.onchange=function(){if(input.popup)
input.popup.close();input.update(this.getSelectedKey(),this.getSelectedValue());input.focus();}
this.menu.oncancel=function(refocus){if(input.popup)
input.popup.close();if(refocus)input.focus();}
var menu_elt=this.menu.render();if(!menu_elt)return;this.menu.setup();document.body.appendChild(menu_elt);var p=new UI.Popup(this.id+'-popup',{elt:menu_elt,target:target||this.elt,target_offset:offset||this.getTargetOffset(target),destroy_on_close:true,close_on_exit:this.close_on_exit,max_width:this.max_width,stacked:this.show_stacked});p.onshow=function(){input.opened=true;input.menu.handleShow();this.reposition();}
p.onhide=function(reason){var canc=input.opened;input.opened=false;input.popup=null;if(canc)
input.menu.cancel(reason==='mouseleave');input.menu.destroy();}
p.onfocus=function(){input.menu.handleFocus();}
p.onblur=function(){input.menu.handleBlur();}
p.onresize=function(pos,viewp){input.menu.handleResize(pos,viewp);}
this.popup=p;p.show();},hidePopup:function(){if(this.popup)this.popup.close();},update:function(key,value,silent){var changed=true;if(this.field){if(this.field.value==key)
changed=false;this.field.value=key;}
if(this.dynamic_module&&this.module_field){var dmod=isObject(value)?value[this.dynamic_module]:null;this.module_field.value=dmod||'';}
this.updateLabel(key,value);if(changed)UI.markFormDirty(this);if(!silent)
UI.callEvent(this,this.onchange,key,value,changed);this.validate();if(!silent&&this.auto_submit&&changed)
UI.submitForm(this.form);this.updateConditionals();},isBlank:function(){var v=this.getValue();if(!isset(v)||v==='')return true;},clear:function(silent,force){var v;if(!this.isBlank()){v=this.getOptionValue('');if(isset(v)||force){this.update('',v,silent);return true;}}},updateConditionals:function(hide){var key=this.getValue();var callback=function(cf){visible=false;for(var j=0;j<cf.depends_on_value.length;j++){if(key==cf.depends_on_value[j]){visible=true;break;}}
return visible;}
UI.updateConditionals(this,callback,hide);this.updateConditionalOptions();},updateConditionalOptions:function(){var conditions,key;for(var i=0;i<UI.conditional_fields.length;i++){var cf=UI.conditional_fields[i];if(cf.name==this.name){if(cf.conditional_options&&cf.conditional_options.length){var depends_on=cf.depends_on;var input=UI.getFormInput(this.form,depends_on);if(input){key=''+input.getValue();conditions=cf.conditional_options;}
break;}}}
if(!conditions)return;var options=null;for(var i=0;i<conditions.length;i++){if(conditions[i][0].indexOf(key)>=0){options=conditions[i][1];break;}}
this.restrictOptions(options);},restrictOptions:function(options){if(!this.menu.all_options){this.menu.all_options={'keys':this.menu.options.keys,'values':this.menu.options.values};}
var all_keys=this.menu.all_options.keys;var all_values=this.menu.all_options.values;var keys=[],values=[];if(options){for(var i=0;i<all_keys.length;i++){if(options.indexOf(all_keys[i])>=0||all_keys[i]==''){keys.push(all_keys[i]);values.push(all_values[i]);}}}else{keys=all_keys;values=all_values;}
this.menu.options.keys=keys;this.menu.options.values=values;this.menu.renderOptions();var val=this.getValue();if(keys.indexOf(val)<0&&val!=''&&val)
this.setValue('');},updateLabel:function(key,value){var lbl_key=this.label_key||'name',slbl_key=this.slabel_key||'symbol',icon_key=this.icon_key||'icon',icon='',slabel='',label='';if(isset(value)&&typeof(value)!='object'){label=''+value;}else if(value){label=value[lbl_key];slabel=value[slbl_key];icon=value[icon_key];}
if(this.icon)icon=this.icon;if(icon_key=='key')icon=''+key;var slb_tg=$(this.id+'-short');if(slb_tg)
UI.setElementText(slb_tg,slabel);var lbl_tg=this.label_elt||$(this.id+'-label');if(lbl_tg)
UI.setElementText(lbl_tg,label);var icon_outer=this.icon_outer||QueryFirst(this.elt).find('.input-field-icon').get(0);if(this.color_icon){icon=value.color;if(icon){UI.clearChildNodes(icon_outer);MakeElt('div.input-icon.input-color-icon').css('background-color',icon).appendTo(icon_outer);}
UI.setDisplayState(icon_outer,!!icon);}
else if(!this.static_icon){var ico=this.icon_elt||$(this.id+'-icon');if(ico&&icon){if(icon.indexOf('-')<0)icon='theme-icon module-'+icon;ico.className='input-icon active '+icon;}
UI.setDisplayState(icon_outer,!!icon);}
this.updateDisplay();},validate:function(){this.invalid=false;var value=this.getValue();if(!isset(value))value='';var have_val=trim(value).length;if(this.checkAltValue()){}else if(this.required&&!have_val){this.invalid=true;this.invalidMsg='required';}else if(have_val&&!this.update_from_popup&&this.require_existing){if(this.menu&&this.menu.getKeyIndex(value)==-1){this.invalid=true;this.invalidMsg='';}}
this.updateDisplay();return!this.invalid;},updateDisplay:function(){UI.setDisplayState(this.elt,!this.checkAltValue());UI.addRemoveClass(this.elt,'disabled',!!(this.disabled&&this.disabled!=='readonly'));UI.addRemoveClass(this.elt,'readonly',!!(this.disabled==='readonly'));UI.addRemoveClass(this.elt,'invalid',!!this.invalid);UI.addRemoveClass(this.elt,'active',!!(this.focused&&!this.opened));UI.addRemoveClass(this.elt,'opened',!!(this.opened&&!this.popup));UI.addRemoveClass(this.elt,'opened-above',!!(this.opened&&!this.popup&&this.show_search_above));var ico=this.icon_elt||$(this.id+'-icon'),lbl=this.label_elt||$(this.id+'-label');if(ico&&!this.no_label)ico.style.display=(trim(ico.className)=='input-icon active')?'none':'inline-block';this.updateTitleText();var blank=this.menu&&this.menu.getBlankKey()||'';UI.addRemoveClass(lbl,'text-placeholder',this.mark_blank&&this.getValue()===blank&&!this.focused);},updateTitleText:function(){var opt=this.getOptionValue(),lbl_key=this.label_key||'name',title_key=this.title_key||'title',label;if(isset(opt)&&typeof(opt)!='object')
label=''+opt;else if(opt)
label=(title_key&&opt[title_key])?opt[title_key]:opt[lbl_key];else
label='';if(this.elt)this.elt.title=label;},render:function(){if(!this.field){this.field=createElement2('input',{type:'hidden',name:this.name,value:this.init_value});}
if(!this.elt){var lbl_style='';if(this.width)lbl_style+='width: '+UI.formatSize(this.width)+';';if(this.max_width)lbl_style+='max_width: '+UI.formatSize(this.max_width)+';';var cls=this.className||('input-field input-field-group rbullet '+(this.ext_class||''));if(this.flat)cls+=' flat';if(this.block)cls+=' input-block';var lblCls='input-label';if(!this.wrap)lblCls+=' single';this.icon_outer=createElement2('div',{className:'input-label input-field-icon'},(this.icon_elt=createElement2('div',{id:this.id+'-icon',className:'input-icon'})));this.elt=createElement2('div',{className:cls,id:this.id,tabIndex:this.tabIndex||0},[this.icon_outer,this.label_elt=createElement2('div',{className:lblCls,id:this.id+'-label'})]);this.setup();}
var key=this.getValue();this.updateLabel(key,this.getOptionValue()||'');return this.elt;},destroy:function(){if(this.popup)this.popup.destroy();this.popup=null;if(this.menu)this.menu.destroy();this.menu=null;UI.removeNode(this.elt,true);this.elt=this.outer=null;this.field=null;},setReadOnly:function(flag){this.setDisabled(get_default(flag,true)?'readonly':flag);},setDisabled:function(disabled){if(!isset(disabled))disabled=1;this.disabled=disabled;if(this.elt)this.elt.disabled=disabled;this.updateDisplay();if(this.disabled&&this.disabled!=='readonly'){if(isset(this.elt.tabIndex)){this.tabIndex=this.elt.tabIndex;this.elt.removeAttribute('tabIndex');}}else if(!isset(this.elt.tabIndex)){this.elt.tabIndex=this.tabIndex||0;}},initSearcher:function(){var self=this;this.searcher=new UI.SearchSelect(this.id+'-search',{target:this.elt,target_offset:{top:-1,left:0,above:this.show_search_above},show_above:this.show_search_above,form:this.form,show_checks:true,disable_recent:true,search_blank:true,mark_blank:this.mark_blank,matching_only:true});this.searcher.onchange=function(k,v,mod,keepOpen){self.update(k,v);self.focus();}
this.searcher.onshow=function(){self.opened='search';self.updateDisplay();}
this.searcher.onhide=function(){self.opened=false;self.updateDisplay();}
this.searcher.oncancel=function(){self.focus();}
this.searcher.setup();},showSearch:function(query){if(!this.searcher){this.initSearcher();}
this.searcher.setOptions(this.menu.options);this.searcher.render();var w=UI.getEltRegion(this.elt);if(w)
this.searcher.setWidth(Math.max(w.width-24,this.search_width||300)+'px');var k=this.getValue();this.searcher.setKey(k);this.searcher.setQuery(query||'');this.searcher.showDefault();}};UI.QuickSelect=function(params){var id=params.id||'quicksel-'+(++UI.QuickSelect.uniq_idx);UI.SelectInput.call(this,id,params);}
UI.QuickSelect.uniq_idx=0;extendClass(UI.QuickSelect,UI.SelectInput,{init:function(key,onchange,oncancel){this.key=key;this.onchange=onchange;this.oncancel=oncancel;this.set_up=false;this.setup();},initSource:function(source,key,onchange,oncancel){this.elt=source;this.init(key,onchange,oncancel);},getValue:function(){return this.key;},update:function(key,value,silent){this.key=key;if(isObject(value)){var lkey=this.label_key||this.menu.options.display_name||'name';value=value[lkey];}
if(this.elt)
UI.setElementText(this.elt,value);UI.SelectInput.prototype.update.call(this,key,value,silent);}});UI.MenuSource=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id||('menu-source-'+(++UI.MenuSource.menu_index));}else
this.id=id;this.menu_id=this.id+'-popup';this.show_checks=false;this.hover_show=false;this.delay=0;this.icon_key=null;this.onchange=null;this.now_selecting=false;this.className='card-outer popup-default panel-outer panel-border panel-default panel-round-bottom active';this.target_active_class='active opened';if(params)extendObject(this,params);if(this.hover_show&&isIPhone)
this.hover_show=false;}
UI.MenuSource.menu_index=0;UI.MenuSource.prototype={setup:function(){var self=this;if(this.set_up)return;if(!this.elt)
this.elt=$(this.id);if(!this.elt)return;UI.addEventListener(this.elt,'selectstart',UI.stopEvent);UI.addEventListener(this.elt,'touchstart',function(evt){if(this.now_selecting)UI.stopEvent(evt);else UI.preventDefault(evt);},this);UI.addEventListener(this.elt,'touchend',this.handleClick,this);if(this.hover_show){UI.addEventListener(this.elt,'mouseenter',function(evt){if(this.now_selecting)return false;var p=UI.PopupManager.last_opened;if(p&&!p.modal&&!p.close_on_exit)return;this.showPopup(this.delay);},this);UI.addEventListener(this.elt,'mouseleave',function(evt){this.cancelShow();},this);}else{UI.addEventListener(this.elt,'mousedown',function(evt){if((evt.which||evt.button)!=1)return;UI.stopPropagation(evt);},this);UI.addEventListener(this.elt,'click',this.handleClick,this);}
UI.addEventListener(this.elt,'keydown',this.handleKeyDown,this);if(!this.dynamic_options)
this.initMenu();this.set_up=true;},initMenu:function(){var options=this.options,selected=null,self=this;if(!this.menu||this.dynamic_options){if(this.dynamic_options){options=this.dynamic_options(this);if('selected'in options)
this.init_value=options.selected;}
if(options instanceof UI.SelectList)
this.menu=options;else{this.menu=new UI.SelectList(this.menu_id,{options:options,no_scroll:true,popup:true,show_checks:this.show_checks,icon_key:this.icon_key,width:this.width,className:this.className,ext_class:this.ext_class});}}
if(this.menu){if(this.elt.tabIndex)
this.menu.tabIndex=this.elt.tabIndex;else if(!this.menu.tabIndex)
this.menu.tabIndex=1;this.menu.touch_opened=this.touch_opened;this.menu.onprevnext=function(evt,dir){self.handlePrevNext(evt,dir);}
this.menu.onchange=function(oldSel,evt){self.handleSelect(this.getSelectedKey(),this.getSelectedValue(),evt);}
this.menu.oncancel=function(){self.handleCancel();}}},handleKeyDown:function(evt){if(evt.keyCode===32)
this.handleClick(evt);},handleClick:function(evt){if(evt.type=='click'&&(evt.which||evt.button)!=1){return null;}
var target=evt.target;if(target&&target.name=='check-all'){return null;}
if(target&&target!=this.elt&&this.only_this_target){return null;}
this.touch_opened=(evt.type=='touchend');this.mouse_pos={x:evt.clientX||evt.x,y:evt.clientY||evt.y};if(this.now_selecting)
this.closePopup();else
this.showPopup();UI.stopEvent(evt);},handlePrevNext:function(evt,dir){var pos=UI.getMenuGroupPos(this.form,this.id),other;if(pos)other=dir?pos.next:pos.prev;if(other)other.showPopup();},focus:function(){if(this.elt)this.elt.focus();},getSelected:function(){return this.init_value||null;},cancelShow:function(){if(this.popup&&this.now_selecting&&this.popup.cancelShowTimer())
this.now_selecting=false;},showPopup:function(timeout){this.selected=this.getSelected();if(this.popup)
this.popup.close();this.initMenu();if(!this.menu)return;this.menu.setSelectedKey(this.selected,true);this.menu.setCurrentIndex(this.menu.getSelectedIndex(),null,true);var menu_elt=this.menu.render();if(!menu_elt)return;this.menu.setup();document.body.appendChild(menu_elt);this.popup=this.createPopup(menu_elt);this.now_selecting=true;this.popup.show(timeout);},getPopupOffset:function(){var ret=this.target_offset;if(!ret&&this.elt&&UI.hasClass(this.elt,'menu-source')){ret={top:-1};}
return ret;},createPopup:function(menu_elt){var popup=new UI.Popup(menu_elt,{target:this.elt,target_offset:this.getPopupOffset(),mouse_pos:this.mouse_pos,customDisplayTransform:isIPhone?null:'scaleY(0.4)',target_active_class:this.target_active_class,destroy_on_close:false});popup.onshow=this.handleShowPopup.bind(this);popup.onclose=popup.oncancelshow=this.handleClosePopup.bind(this);return popup;},hasKey:function(key){return this.menu&&this.menu.hasKey(key);},performActionKey:function(key){var val=this.menu?this.menu.getValue(key):null;if(val)return this.performAction(key,val);},performAction:function(key,action,evt){if(!action)return;if(action.pre_check&&UI.callEvent(this,action.pre_check,key,action,evt)===false)return false;if(action.confirm&&!confirm(action.confirm))return false;if(action.pre_perform)
UI.callEvent(this,action.pre_perform,key,action,evt);if(action.perform)
UI.callEvent(this,action.perform,key,action,evt);else if(action.url){App.util.navigateTo(action.url,evt,{async:get_default(action.async,true)});return false;}
if(action.post_perform)
UI.callEvent(this,action.post_perform,key,action);return true;},handleSelect:function(key,value,evt){this.last_selected=key;this.now_selecting=false;this.closePopup();if(!value)return;if(UI.callEvent(this,this.onchange,key,value)===false)return;this.performAction(key,value,evt);this.now_selecting=false;},handleCancel:function(){this.now_selecting=false;this.closePopup();UI.callEvent(this,this.oncancel);},closePopup:function(){if(this.popup)
this.popup.close();},handleShowPopup:function(){if(this.menu)
this.menu.handleShow();},handleClosePopup:function(){if(this.menu){if(this.now_selecting)
this.menu.cancel();this.menu.destroy();}},render:function(){},setDisabled:function(disabled){if(!isset(disabled))disabled=1;this.disabled=!!disabled;if(this.elt)this.elt.disabled=disabled;},destroy:function(){if(this.popup)this.popup.destroy();this.popup=null;if(this.menu)this.menu.destroy();this.menu=null;UI.removeNode(this.elt,true);this.elt=null;UI.callEvent(this,this.ondestroy);}};UI.RefInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;this.allow_custom=false;this.allow_rename=false;this.allow_clear=true;this.track_view=true;this.name_column='_display';this.invalid=false;this.quick_create=false;if(params)extendObject(this,params);}
UI.RefInput.prototype={setup:function(){if(this.set_up)return;if(!this.outer)
this.outer=$(this.id);if(!this.outer)return;if(!this.elt){this.elt=(
Wrap(this.outer).findFirst('.ref-input').get(0)||
Wrap(this.outer).findFirst('.input-field').get(0));}
if(!this.field){if(this.name&&this.form)
this.field=this.form.elements[this.name];else if(this.field_id)
this.field=$(this.field_id);}
if(!this.key_field){if(this.key_name&&this.form)
this.key_field=this.form.elements[this.key_name];else if(this.key_id)
this.key_field=$(this.key_id);}
if(!this.module_field){if(this.form&&this.module_field_name)
this.module_field=this.form.elements[this.module_field_name];else if(this.module_field_id)
this.module_field=$(this.module_field_id);}
if(!this.elt)return;var elts=this.elt.getElementsByClassName('ref-label');if(elts&&elts.length==1)
this.label_elt=elts[0];elts=this.elt.getElementsByClassName('ref-icon');if(elts&&elts.length==1)
this.icon_elt=elts[0];if(!this.altInput&&this.alt_name){this.altInput=UI.getFormInput(this.form,this.alt_name);}
this.elt.draggable=true;if(this.elt.parentNode&&UI.hasClass(this.elt.parentNode,'input-wrapper'))
this.outer=this.elt.parentNode;this.set_up=true;this.postSetup();},postSetup:function(){if(this.module_field)
this.module=this.module_field.value;if(this.key_field)this.orig_key=this.key_field.value;this.updateLabel();this.updateDisplay();this.addHooks();},addExtraReturnFields:function(fs){if(!this.extra_fields)
this.extra_fields={};for(var k in fs){this.extra_fields[k]=fs[k];}},getExtraReturnFields:function(){return this.extra_fields;},getReturnFields:function(){var fs={id:'id',_display:'_display'},ext=this.extra_fields;if(ext)
for(var k in ext)fs[k]=ext[k];return fs;},getModule:function(){if(this.module_field)return this.module_field.value;return this.module;},setModule:function(mod){if(this.module_field)
this.module_field.value=mod;this.moduleUpdated(mod);},moduleUpdated:function(mod,silent){if(this.module!=mod){this.module=mod;UI.callEvent(this,this.onmoduleupdate,mod);this.update(null,null,silent);}},addHooks:function(){if(this.events)return;var input=this;var source=new UI.Draggable(this.elt,{id:this.id,sourceType:'SelectListItem',onStart:this.handleDragStart.bind(this)});var target=new UI.DragTarget(this.elt,{acceptedSourceTypes:['SelectListItem'],onMove:this.handleDragOver.bind(this),onEnter:this.handleDragEnter.bind(this),onLeave:this.handleDragLeave.bind(this),onDrop:this.handleDrop.bind(this),onAcceptSource:this.onAcceptSource.bind(this),checkAccept:this.checkAccept.bind(this)});this.events=UI.addEventListeners(this.elt,{keydown:this.handleKeyDown,keyup:this.handleKeyUp,keypress:this.handleKeyPress,mouseenter:this.handleMouseEnter,mouseleave:this.handleMouseLeave,mousedown:this.handleMouseDown,click:this.handleClick,focus:this.handleFocus,blur:this.handleBlur},this);if(this.altInput){this.altInput.onchange=function(){input.update();}}},getDragRef:function(){var url='',mod=this.module,key=this.getKey(),val=this.getValue(),ret={};if(mod&&key)url=''+App.session.site_url+'index.php?'+encodeQueryString({module:mod,action:'DetailView',record:key});ret={'text/plain':url,'text/uri-list':url,'text/html':url?MakeElt('a',{href:url},val).html():'','url':url,'1crm.ref-module':mod,'1crm.ref-value':key,'1crm.ref-label':val,'1crm.ref-id':this.id};return ret;},loadDragRef:function(evt){var url,parts,ret,id,p,src;if(!evt)return;if(evt.type==='paste')
src=evt.clipboardData;else
src=evt.dataTransfer;if(!src)return;if((id=src.getData('1crm.ref-id'))){ret={id:id,module:src.getData('1crm.ref-module'),record:src.getData('1crm.ref-value'),value:src.getData('1crm.ref-label')};}else{url=src.getData('text/uri-list')||src.getData('url');if(url&&(p=url.indexOf('?'))>=0){parts=parseQueryString(url.substring(p+1));if(parts&&parts.action=='DetailView'){ret={module:parts.module,record:parts.record};}}}
return ret;},handleDragStart:function(evt){var info=this.getDragRef();for(var k in info)
evt.dataTransfer.setData(k,info[k]);evt.stopPropagation();},checkAccept:function(evt){return true;},handleDragOver:function(evt){if(this.disabled)return;evt.dataTransfer.dropEffect='copy';},handleDragEnter:function(evt){if(this.disabled||evt.target!==evt.currentTarget)return;this.dragover=true;this.updateDisplay();},handleDragLeave:function(evt){if(this.disabled||evt.target!==evt.currentTarget)return;this.dragover=false;this.updateDisplay();},onAcceptSource:function(evt,data,source){if(!source)return true;if(source.sourceType=='SelectListItem')return source.id!=this.id;return null;},handleDrop:function(evt){if(this.disabled)return;evt.stopPropagation();evt.preventDefault();this.dragover=false;var ref=this.loadDragRef(evt);if(!ref||(ref.id&&ref.id==this.id))return;this.updateWithLookup(ref.module,ref.record);},handleCopy:function(evt){var info=this.getDragRef();for(var k in info)
evt.clipboardData.setData(k,info[k]);UI.preventDefault(evt);},handlePaste:function(evt){if(this.disabled)return;UI.stopEvent(evt);var ref=this.loadDragRef(evt);if(ref.id&&ref.id==this.id)return;this.updateWithLookup(ref.module,ref.record);},handleKeyDown:function(evt){var nav;if(evt.keyCode==38)nav=-1;else if(evt.keyCode==40)nav=1;else nav=0;if(nav){if(this.searcher&&this.searcher.visible)
this.searcher.adjustCurrentIndex(nav,null,evt);else
return;UI.stopEvent(evt);}else if(evt.keyCode==13){if(this.searcher&&this.searcher.visible){if(!this.searcher.acceptCurrent(evt))
this.hideSearch();}else if(!this.disabled)
this.showSearch();else
return;UI.stopEvent(evt);}else if(evt.keyCode==8||evt.keyCode==46){if(!this.disabled)this.clear();}else if(evt.keyCode==27){if(this.opened){this.hideSearch(true);this.focus();UI.stopEvent(evt);}else if(!this.disabled){if(this.clear())UI.stopEvent(evt);}}else if(evt.keyCode==32){if(this.focused&&!this.disabled){this.triggerSearch();UI.stopEvent(evt);}}},handleKeyUp:function(evt){if(evt.keyCode&&evt.charCode&&evt.keyCode!=27&&evt.keyCode!=13&&evt.keyCode!=9&&evt.keyCode!=16)
this.updateSearch();},handleKeyPress:function(evt){if(evt.charCode&&evt.charCode!=27){if(!this.disabled&&this.opened!=='search'){this.showSearch();}}},triggerSearch:function(){this.cancelShowSearch();this.savePrevValue();this.showSearch();},handleMouseDown:function(evt){if(!this.disabled&&evt.currentTarget===this.elt)
evt.stopPropagation();},handleClick:function(evt){if(evt.which==1){if(this.opened)
this.hideSearch();else if(!this.disabled)
this.triggerSearch();UI.stopEvent(evt);}},handleMouseEnter:function(evt){this.hovered=true;if(!isIPhone)this.updateDisplay();},handleMouseLeave:function(evt){this.hovered=false;if(!isIPhone)this.updateDisplay();},searchMouseUp:function(evt){},handleFocus:function(evt){this.focused=true;UI.callEvent(this,this.onfocus,evt);this.updateDisplay();},handleBlur:function(evt){if(this.focused){this.focused=false;UI.callEvent(this,this.onblur,evt);this.updateDisplay();}},savePrevValue:function(){this.prev_key=this.getKey();this.prev_value=this.getValue();},updateLabel:function(){var lbl,icon;if(this.label_elt){if(!this.isBlank())
lbl=this.getValue();else
lbl=this.placeholder||app_string('LBL_NONE');UI.setElementText(this.label_elt,lbl);}
if(this.icon_elt){icon=this.icon||(this.module=='Users'?'bean-User':'module-'+this.module);this.icon_elt.className='ref-icon input-icon theme-icon '+icon;if(this.module_field)
UI.setDisplayState(this.icon_elt.parentNode,!!this.getKey());}},updateDisplay:function(){UI.setDisplayState(this.elt,!this.checkAltValue());if(this.checkAltValue()){this.hideSearch();return;}
UI.addRemoveClass(this.label_elt,'text-placeholder',this.isBlank()&&!this.focused&&!this.opened);UI.addRemoveClass(this.elt,'invalid',this.invalid);UI.addRemoveClass(this.elt,'active',!!this.dragover);UI.addRemoveClass(this.elt,'opened',!!this.opened);},setDisabled:function(disabled){if(!isset(disabled))disabled=1;this.disabled=(typeof disabled==='string'?disabled:!!disabled);UI.addRemoveClass(this.elt,'disabled',!!(this.disabled&&this.disabled!=='readonly'));UI.addRemoveClass(this.elt,'readonly',!!(this.disabled==='readonly'));if(this.disabled&&this.disabled!=='readonly'){if(isset(this.elt.tabIndex)){this.tabIndex=this.elt.tabIndex;this.elt.removeAttribute('tabIndex');}}else if(!isset(this.elt.tabIndex)){this.elt.tabIndex=this.tabIndex||0;}
if(this.disabled)this.hideSearch();},setReadOnly:function(flag){this.setDisabled(get_default(flag,true)?'readonly':flag);},focus:function(){if(this.elt)
this.elt.focus();},cancelShowSearch:function(){if(this.searchTimeout){clearTimeout(this.searchTimeout);this.searchTimeout=null;return true;}},cancelHideSearch:function(){if(this.hideSearchTimeout){clearTimeout(this.hideSearchTimeout);this.hideSearchTimeout=null;return true;}},render:function(){var ret;if(!this.rendered){if(!this.key_field){this.key_field=createElement2('input',{type:'hidden',id:this.key_id||'',name:this.key_name||'',value:this.init_key});}
if(!this.field){this.field=createElement2('input',{type:'hidden',id:this.field_id||'',name:this.name||'',value:this.init_value});}
if(!this.elt){var cls='input-field input-field-group rbullet ref-input';var style={};if(this.block)cls+=' input-block';if(this.flat)cls+=' flat';if(this.ext_class)cls+=' '+this.ext_class;else style.width=this.width||'20em';this.elt=createElement2('div',{className:cls,id:this.id,style:style,tabIndex:this.tabIndex||0});if(this.disabled)
this.elt.className+=' disabled';}
var icon_outer=createElement2('div',{className:'input-label input-field-icon'});if(!this.icon_elt){this.icon_elt=createElement2('div',{className:'ref-icon'});}
if(!this.label_elt){this.label_elt=createElement2('div',{className:'input-label ref-label'});}
icon_outer.appendChild(this.icon_elt);this.elt.appendChild(icon_outer);this.elt.appendChild(this.label_elt);this.outer=MakeElt('div.input-wrapper'+(this.block?'.input-block':''),this.key_field,this.module_field,this.field,this.elt).get();this.rendered=true;this.savePrevValue();this.postSetup();}
return this.outer||this.elt;},getKey:function(){if(this.key_field)return this.key_field.value;},getValue:function(){if(this.field)return this.field.value;},getValueDisplay:function(value){if(isset(value)){if(isString(value))return value;return value[this.name_column];}
return'';},isBlank:function(){if(this.allow_custom)return!trim(this.getValue()).length;return!trim(this.getKey()).length;},clear:function(refocus){if(refocus)this.focus();if(!this.isBlank()){this.userUpdate(null,null);return true;}},update:function(key,value,silent,module,passthru){key=get_default(key,'');if(this.union_module&&(!isObject(value)||!value._module))
key='';if(this.key_field)
this.key_field.value=key;if(this.field&&isdef(value)){this.field.value=this.getValueDisplay(value);}
if(this.union_module||module){var mod=(key?value._module:'')||module;if(this.module_field){this.module=mod;this.module_field.value=mod;UI.callEvent(this,this.onmoduleupdate,mod);}}
this.savePrevValue();this.hideSearch();this.updateLabel();if(key!==this.orig_key)UI.markFormDirty(this);if(!silent)
UI.callEvent(this,this.onchange,key,value,passthru||this.getPassthru());this.validate();},userUpdate:function(key,value,nofocus,mod,passthru){if(!this.focused&&!nofocus)
this.focus();this.update(key,value,false,mod,passthru);var do_submit=(this.auto_submit&&(key||this.submit_empty));if(this.track_view)
this.doTrackView();if(do_submit)
UI.submitForm(this.form);},doTrackView:function(){var mod=this.getModule(),rec=this.getKey();if(mod&&rec){var req=new App.conn.JSONRequest('add_recent',{silent:true,global:true},{module:mod,record:rec,source:'ref'});req.fetch();}},rename:function(value,silent){if(this.field&&isdef(value))
this.field.value=this.getValueDisplay(value);this.savePrevValue();this.hideSearch();this.updateLabel();if(!silent)
UI.callEvent(this,this.onrename,value,this.getPassthru());this.validate();},userRename:function(value,nofocus){if(!this.focused&&!nofocus)
this.focus();this.rename(value);if(this.focused)
this.showSearchDelayed(1500);},updateSearch:function(){this.showSearch();},showSearchDelayed:function(delay){this.cancelHideSearch();var input=this;this.searchTimeout=setTimeout(function(){input.showSearch();},delay||1000);},initSearcher:function(){var mod=this.union_module||this.getModule(),self=this;this.searcher=new UI.SearchSelect(this.id+'-search',{module:mod,union_module:this.union_module,dynamic_module:!!this.module_field,modules:this.modules,options:this.options,target:this.elt,target_offset:{top:-1,left:0},extra_fields:this.getExtraReturnFields(),filters:this.getFilters(),passthru:this.getPassthru(),popup_layout:this.popup_layout,popup_callback:this.popup_callback,popup_return_method:this.popup_return_method,popup_return_multiple:this.popup_return_multiple,form:this.form,show_checks:true,allow_popup:true,allow_clear:this.allow_clear,allow_custom:this.allow_custom,allow_rename:this.allow_rename,quick_create:this.quick_create,min_width:this.popup_width});if(this.union_module){this.searcher.icon_key='icon';}
this.searcher.onchange=function(k,v,mod){self.focus();self.userUpdate(k,v,true,mod);}
this.searcher.onrename=function(v){self.userRename(v);}
this.searcher.onmouseup=function(evt){self.searchMouseUp(evt);}
this.searcher.onquickcreate=function(evt,query){self.openQuickCreate(query);}
this.searcher.onshow=function(){self.opened=true;self.updateDisplay();}
this.searcher.onhide=function(){self.opened=false;self.updateDisplay();}
this.searcher.oncancel=function(){self.focus();}
this.searcher.setup();},getSearchQuery:function(){return this.field?this.field.value:null;},showSearch:function(){this.cancelShowSearch();this.cancelHideSearch();var mod=this.union_module||this.getModule(),p=UI.PopupManager.currentModal();if(p&&!UI.isAncestor(p.elt,this.elt))return;if(!this.searcher){this.initSearcher();}else{this.searcher.setModule(mod,true);this.searcher.setFilters(this.getFilters());}
this.searcher.render();var w=UI.getEltRegion(this.elt);if(w)
this.searcher.setWidth(Math.max(w.width-24,this.search_width||300)+'px');var k=this.getKey();this.searcher.setKey(k);if(this.union_module)this.searcher.setDetailModule(this.getModule());this.searcher.showDefault();},hideSearchDelayed:function(delay){this.cancelShowSearch();this.cancelHideSearch();var input=this;this.hideSearchTimeout=setTimeout(function(){input.hideSearch();},delay||100);},hideSearch:function(refocus){this.cancelShowSearch();this.cancelHideSearch();if(this.searcher){var v=this.getValue();if(v!=this.prev_value){if((v!==''&&!this.auto_update)||(v===''&&!this.allow_clear))
this.update(this.prev_key,this.prev_value,true);else
this.userUpdate(null,v,!refocus);}
this.searcher.close();}
if(this.focused&&refocus)
this.elt.focus();},validate:function(){this.invalid=false;if(this.required&&this.isBlank()&&!this.checkAltValue()){this.invalid=true;this.invalidMsg='required';}
else if(this.customValidate)
this.customValidate();this.updateDisplay();return!this.invalid;},checkAltValue:function(){var v;if(this.altInput&&(v=this.altInput.getValue())){return v;}},addFilter:function(filter){if(!this.add_filters)this.add_filters=[];this.add_filters.push(filter);},getFilters:function(){if(Array.isArray(this.add_filters)){var params={},c=0,i,fp,inp,k,v;for(i=0;i<this.add_filters.length;i++){fp=this.add_filters[i];if(!fp.param)continue;if(fp.field_name){inp=UI.getFormInput(this.form,fp.field_name);if(inp){if(inp instanceof UI.RefInput){k=inp.getKey();if(k==='')k=null;}else
k=null;v=inp.getValue();if(isset(k))
params[fp.id_param||fp.param+'_id']=inp.getKey();if(isset(v)&&v!=='')
params[fp.param]=v;else if(!isset(k))
continue;c++;}else if(this.form.elements[fp.field_name]){v=this.form.elements[fp.field_name].value;if(!isset(v)||v==='')
continue;params[fp.param]=v;c++;}else
continue;}
else if(isset(fp.value)){params[fp.param]=fp.value;c++;}}
if(c)return params;}},getPassthru:function(){var p=this.popup_passthru?deep_clone(this.popup_passthru):{};p.ui_input_name=this.name||this.id;return p;},showPopup:function(){var mod=this.union_module||this.getModule(),request_data={form_name:this.form.getAttribute('id')||this.form.getAttribute('name'),call_back_function:this.popup_callback||'ui_popup_return',passthru_data:this.getPassthru(),field_to_name_array:{id:'id',_display:'_display'}},params={module:mod,layout:this.popup_layout,request_data:request_data,inline:true};if(!mod)return;if(this.union_module)
request_data.field_to_name_array['_module']='query_module';var add_fs=this.getExtraReturnFields();if(add_fs){for(i in add_fs){request_data.field_to_name_array[i]=add_fs[i];}}
params.filter=this.getFilters();if(this.popup_return_method)
request_data.passthru_data.ui_return_method=this.popup_return_method;if(this.popup_return_multiple)
params.multiple=true;open_popup_window(params);this.handleBlur();},openQuickCreate:function(query){UI.openQuickCreate(this.module,{name:query,for_ref:1},this.getCreateCallback());},getCreateCallback:function(){var self=this;return function(key,value){self.userUpdate(key,value);}},updateWithLookup:function(module,key,silent,nofocus,passthru){if(!module||module!=this.module)return;if(!key||key==this.getKey())return;var self=this,callback=function(data){var r,k,v;if(!data||!(r=data.getResult()))return;if(r.formatted_rows.length){k=r.formatted_rows[0].id;v=r.formatted_rows[0];}
if(silent)self.update(k,v,silent,undefined,passthru);else self.userUpdate(k,v,nofocus,undefined,passthru);},data={module:module,rows:[key],fields:this.getReturnFields(),filters:this.getFilters()},req=new App.conn.JSONRequest('popup_related_data',{silent:true},data);req.fetch(callback);}};UI.EmailRecipsInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;params.value=params.value||'';if(params)extendObject(this,params);if(!this.recips_array){this.recips_array=this.value.split(';').map(trim).filter(function(e){return e.length>0});}};UI.EmailRecipsInput.prototype={setup:function(){if(this.set_up)return;if(!this.elt)
this.elt=$(this.id);var elts=this.elt.getElementsByClassName('email-recips-input');if(elts&&elts.length==1)
this.input=elts[0];elts=this.elt.getElementsByClassName('email-recips-container');if(elts&&elts.length==1)
this.container=elts[0];this.render();new UI.DragTarget(this.elt,this.getDragConfig());this.updateDisplay();this.set_up=true;},render:function(){this.buttons=[];var self=this;this.setupSearcher();},addRecips:function(rows){var recips=this.getRecipsArray();if(rows){for(var i=0;i<rows.length;i++){var v=rows[i];if(!v)continue;var r={display:((v.first_name||"")+' '+(v.last_name||"")).trim(),email:v.email_matched||''
};recips.push(r);}}
this.setRecipsArray(recips);this.updateDisplay();},getRecipsArray:function(){if(this.recips_array)return this.recips_array;if(!this.input)return[];return this.input.value.split(';').map(trim).filter(function(e){return e.length>0});},setRecipsArray:function(array){this.recips_array=array;if(!this.input)return;this.input.value=array.map(function(e){return typeof e==='string'?'e':e.display+' <'+e.email+'>'}).join('; ');},updateDisplay:function(){if(!this.input||!this.container)return;UI.clearChildNodes(this.container);var self=this,recips_outer=createElement2('div',{className:'buttons-inline'},null,this.container);var recips=this.getRecipsArray();for(var i=0;i<recips.length;i++){(function(i){var recip=recips[i];var r=recip;if(typeof r!=='string')
r=r.display||r.email;var outer=createElement2('div',{className:'input-field input-field-group',title:recip.email});new UI.Draggable(outer,self.getDragConfig(recip,i));createElement2('div',{className:'inline-elt'},outer,recips_outer);if(recip.module){createElement2('div',{className:'input-label input-field-icon'},createElement2('div',{className:'input-icon theme-icon module-'+recip.module},null,outer),outer);}
createElement2('div',{className:'input-label'},r,outer);var removeButton=createElement2('div',{className:'input-label input-remove',style:'cursor:pointer'},'',outer);removeButton.onclick=function(evt){evt.stopPropagation();var recips=self.getRecipsArray();recips.splice(i,1);self.setRecipsArray(recips);self.updateDisplay();};})(i);}
if(this.input_elt){createElement2('div',{className:'inline-elt'},this.input_elt,recips_outer);}
this.buttons.forEach(function(b){self.container.appendChild(b);});},validate:function(){this.invalid=false;if(this.required&&this.isBlank()){this.invalidMsg='required';this.invalid=true;}
return!this.invalid;},isBlank:function(){var recips=this.getRecipsArray();return!recips.length;},focus:function(){if(this.input_elt)
this.input_elt.focus();},updateMulti:function(rows,count){var add=[];for(var i=0;i<count;i++){add.push(rows['ID_'+i]);}
this.addRecips(add);},getFilters:UI.RefInput.prototype.getFilters,setupSearcher:function(){var self=this;this.input_elt=createElement2('div',{className:'input-field input-field-group rbullet',tabIndex:0},[createElement2('div',{className:'input-label input-field-icon lg'},createElement2('div',{className:'uii uii-add'})),createElement2('div',{className:'input-label text-placeholder'},' '+mod_string('LBL_BUTTON_ADD_RECIPIENTS','Emails'))]);var searcher=new UI.SearchSelect(this.id+'-search-Invitees',{module:'EmailRecipients',target:this.elt,target_offset:{top:-1,left:0},search_blank:true,form:this.form,show_checks:true,icon_key:'icon',allow_popup:true,dynamic_module:true,modules:['EmailRecipients','Contacts','Leads','Users'],allow_clear:false,allow_custom:true,display_name:'name_email',allow_rename:false,popup_return_multiple:true,extra_fields:{'email_matched':'email_matched','_display':'name_email','salutation':'salutation','name_email':'name_email'},quick_create:false});searcher.onchange=function(k,v,mod){if(!k){v={email_matched:v.name};}
self.addRecips([v]);}
searcher.onshow=function(){UI.addRemoveClass(self.input_elt,'opened',true);}
searcher.onhide=function(){UI.addRemoveClass(self.input_elt,'opened',false);self.input_elt.focus();}
searcher.disable_show_detail=1;searcher.setup();searcher.passthru={ui_input_name:this.name,ui_return_method:'updateMulti'};UI.addEventListener(this.input_elt,'keydown',function(evt){if(evt.keyCode==32){UI.stopEvent(evt);this.showSearch();};},this);UI.addEventListener(this.input_elt,'click',function(evt){UI.stopEvent(evt);this.showSearch();},this);this.searcher=searcher;},showSearch:function(){this.searcher.setFilters(this.getFilters());this.searcher.render();var w=UI.getEltRegion(this.input_elt);if(w)
this.searcher.setWidth(Math.max(w.width-200,325)+'px');this.searcher.showDefault(true);},onEnter:function(evt,data){if(!data.values||!data.values.source||data.values.source==this)return;this.elt.style.backgroundColor='#eee';},onLeave:function(evt,data){this.elt.style.backgroundColor='';},checkAccept:function(evt,data){return data.values.source!=this;},loadDragRef:function(evt){var url,parts,ret,id,p,src;if(!evt)return;src=evt.dataTransfer;if(!src)return;if((id=src.getData('1crm.ref-id'))){ret={id:id,module:src.getData('1crm.ref-module'),record:src.getData('1crm.ref-value'),value:src.getData('1crm.ref-label')};}else{url=src.getData('text/uri-list')||src.getData('url');if(url&&(p=url.indexOf('?'))>=0){parts=parseQueryString(url.substring(p+1));if(parts&&parts.action=='DetailView'){ret={module:parts.module,record:parts.record};}}}
return ret;},addFromRecord:function(ref){var module=ref.module,key=ref.record;if(!module||!key)return;var self=this,callback=function(data){var r,k,v,recip;if(!data||!(r=data.getResult()))return;if(r.rows.length){var row=r.rows[0];var email=row['email1']||row['email2'];if(!email)return;var name=row['name'];if(name)recip={display:name,email:email};else recip=email;var recips=self.getRecipsArray();recips.push(recip);self.setRecipsArray(recips);self.updateDisplay();}},data={module:module,rows:[key],fields:['_display','email1','email2'],},req=new App.conn.JSONRequest('popup_related_data',{silent:true},data);req.fetch(callback);},onDrop:function(evt,data){var ref=this.loadDragRef(evt);if(ref){this.addFromRecord(ref);return;}
var idx=data.values.idx;var recip=data.values.recip;var source=data.values.source;var recips=source.getRecipsArray();recips.splice(idx,1);source.setRecipsArray(recips);source.updateDisplay();recips=this.getRecipsArray();recips.push(recip);this.setRecipsArray(recips);this.updateDisplay();},getDragConfig:function(recip,idx){return{acceptedSourceTypes:['EmailRecip','SelectListItem'],sourceType:'EmailRecip',checkAccept:this.checkAccept.bind(this),onDrop:this.onDrop.bind(this),onEnter:this.onEnter.bind(this),onLeave:this.onLeave.bind(this),values:!recip?{}:{recip:recip,idx:idx,source:this}};}};UI.hideConditionals=function(names){for(var i=0;i<names.length;i++){var name=names[i];Wrap(document.body).find('.cell-'+name).forEach(function(elt){Wrap(elt).addClass('cond-hidden');UI.removeRowHoles(elt);});}}
UI.removeRowHoles=function(elt){var row=elt.parentNode;var hide=true;var re=/\bcell-.*/;Wrap(row).find(function(elt){return re.test(elt.className);}).forEach(function(el){if(UI.hasClass(el,'cell-'))return;if(!UI.hasClass(el,'cond-hidden')){hide=false;}});row.style.display=hide?'none':'';}
UI.updateConditionals=function(thiz,callback,hide){var form=thiz.form,processed={},chk=[],cf,cls,visible;processed[thiz.name]=true;for(var i=0;i<UI.conditional_fields.length;i++){var cf=UI.conditional_fields[i];if(cf.depends_on==thiz.name){chk.push(cf);}}
if(chk.length){var $body=Wrap(document.body);$body.find('.cell-'+thiz.name).forEach(function(elt){if(elt.style.display=='none'){hide=true;}});for(var i=0;i<chk.length;i++){cf=chk[i];cls='cell-'+cf.name;visible=true;if(cf.depends_on_value&&cf.depends_on_value.length){visible=callback(cf);}
visible&=!hide;$body.find('.'+cls).forEach(function(elt){if(visible){UI.removeClass(elt,'cond-hidden');}else{UI.addClass(elt,'cond-hidden');}
UI.removeRowHoles(elt);});if(!processed[cf.name]){processed[cf.name]=true;var input=UI.getFormInput(form,cf.name);if(input instanceof UI.SelectInput||input instanceof UI.CheckInput)
input.updateConditionals(!visible);}}}};UI.SearchSelect=function(id,params){this.id=id||'searchselect';this.module=null;this.multiple=false;this.searcher=null;this.popup=null;this.mode=null;this.title='';this.key=null;this.width=null;this.onchange=null;this.waiting_result=false;this.search_delay=150;this.search_clear=true;this.quick_create=false;if(params)extendObject(this,params);this.initOptions();}
UI.SearchSelect.prototype={initOptions:function(){var opts,k,v,kv=[],mod;if(this.options){opts=UI.getSelectOptions(this.options);if(!opts)
console.error('select options not found:',this.options);this.options=opts;}
if(!this.recent_options)
this.recent_options=new UI.SelectOptions({display_name:'_display'});if(!this.search_options)
this.search_options=new UI.SelectOptions({display_name:this.display_name||'_display'});if(!this.module_options&&!this.options){opts=App.language.getList('moduleList');for(var i=0;i<opts.keys.length;i++){mod=opts.keys[i];if(!this.modules||this.modules.indexOf(mod)>=0){kv.push({k:mod,v:{_display:opts.values[i],icon:mod}});}}
if(this.modules){kv.sort(function(a,b){return this.modules.indexOf(a.k)-this.modules.indexOf(b.k)}.bind(this));}
k=kv.map(function(e){return e.k});v=kv.map(function(e){return e.v});this.module_options=new UI.SelectOptions({keys:k,values:v,display_name:'_display',icon_key:'icon'});}},setup:function(){if(this.set_up)return;var self=this;this.search_input=new UI.SearchInput(this.id+'-text',{searcher:this,width:200,embedded:true,show_clear:this.search_clear,onkeydown:function(evt){if(evt&&evt.keyCode===9&&evt.shiftKey){UI.stopEvent(evt);self.cancelSearch();}}});this.set_up=true;},render:function(){if(this.rendered)return;var self=this;if(this.flat){this.elt=MakeElt('div',{'class':this.ext_class}).get();}
else if(!this.popup){var params={target:this.target,target_offset:this.target_offset,destroy_on_close:this.destroy_on_close||false,ext_class:this.ext_class,show_above:this.show_above,min_width:this.min_width||250,onmouseover:this.onmouseover,onmouseout:this.onmouseout,onmouseup:this.onmouseup,target_active_class:this.target_active_class||null};if(this.width)
params.width=this.width;this.popup=new UI.PopupSlidePanel(this.id,params);this.popup.onshow=function(){self.visible=true;UI.callEvent(self,self.onshow);}
this.popup.onhide=function(){self.visible=false;UI.callEvent(self,self.onhide);}
this.popup.render();UI.clearChildNodes(this.popup.elt);this.elt=this.popup.elt;}
if(this.search_input){this.search_elt=MakeElt('div.card-header.panel-header').appendTo(this.elt).get();var search_row=MakeElt('div.tools-row.popup-search').appendTo(this.search_elt);search_row.append(this.search_input.render());search_row.append(MakeElt('div.spacer'));this.search_input.setup();this.info_button=MakeElt('div.uii.uii-lg.uii-info.active-icon',{tabindex:0}).appendTo(search_row).on('click, keydown[key=enter|space]',function(evt){self.showDetail();},{stop:true,prevent:true});if(this.allow_clear){this.clear_button=MakeElt('div.uii.uii-lg.uii-remove.active-icon',{tabindex:0}).appendTo(search_row).on('click, keydown[key=enter|space]',function(evt){self.setQuery('');self.close();UI.callEvent(self,self.onclear,evt);UI.callEvent(self,self.onchange,'','',null,null,evt);},{stop:true,prevent:true});}
if(this.allow_popup){this.popup_button=MakeElt('div.uii.uii-lg.uii-extern.active-icon',{tabindex:0}).appendTo(search_row).on('click, keydown[key=enter|space]',function(evt){self.showDialog();},{stop:true,prevent:true});}}
this.return_link=MakeElt('a.tools-link',{href:'#'},MakeElt('span.uii.uii-previous'),nbsp(),app_string('LBL_REF_SELECT_MODULE')).on('click',function(){self.showModules();return false;});this.return_row=MakeElt('div.card-header.panel-subheader',MakeElt('div.tools-row.popup-title.return-link',this.return_link)).appendTo(this.elt);this.detail_close=createElement2('div',{className:'uii uii-cancel active-icon popup-close',style:'display: none'});this.detail_close.onclick=function(){if(self.detail_mode=='search'||self.haveQuery())self.search();else self.showRecent();}
this.filter_elt=createElement2('div',{className:'popup-filter'});this.filter_row=createElement2('div',{className:'card-header panel-subheader',style:'display: none'},this.filter_elt,this.elt);this.title_elt=createElement2('span',null,this.title,this.title_row);this.title_row=createElement2('div',{className:'card-header panel-subheader'},createElement2('div',{className:'tools-row popup-title search-results-title'},[this.title_elt,this.detail_close]),this.elt);if(!this.list_elt){this.list_elt=createElement2('div',{id:this.id+'-list',className:'card-outer card-body panel-body ref-options'});this.elt.appendChild(this.list_elt);}
if(!this.detail_elt){this.detail_elt=createElement2('div',{id:this.id+'-detail',className:'card-body panel-body popup-detail'});this.elt.appendChild(this.detail_elt);}
if(!this.list){this.list=new UI.SelectList(this.list_elt,{options:this.recent_options,no_scroll:true,popup:true,width:'100%',display_name:this.display_name||'_display',icon_key:this.icon_key,show_checks:this.show_checks,rows:get_default(this.max_rows,10)});this.list.setup();this.list.focused=true;this.list.render();this.list.onchange=function(oldSel,evt){var k=this.getSelectedKey();self.rowSelected(k,this.getValue(k),false,evt);};this.list.oncurrent=function(idx){var k;if(isset(idx)){k=this.getKey(idx);self.rowCurrent(k,this.getValue(k));}};}
this.status_elt=MakeElt('div.text-help');this.status_row=MakeElt('div.card-footer.panel-footer.text-right:hidden',{id:this.id+'-status'},this.status_elt).appendTo(this.elt);this.wait_elt=MakeElt('div.card-footer.panel-footer.popup-wait:hidden',{id:this.id+'-wait'},MakeElt('div',null,App.util.waitIcon({small:true}))).appendTo(this.elt);this.rendered=true;return this.elt;},reposition:function(){if(this.popup&&this.popup.visible){requestAnimationFrame(
this.popup.reposition.bind(this.popup));}},focus:function(){this.focusSearch();},setWaitingResult:function(val){var self=this;if(!val){if(this.waiting_result){clearTimeout(this.waiting_result);this.waiting_result=null;}
this.show_waiting=false;}
else{this.waiting_result=val;if(!this.waiting_timer)
this.waiting_timer=setTimeout(this.checkWaiting.bind(this),250);}
this.updateFooter();},checkWaiting:function(){if(this.waiting_result){this.show_waiting=true;this.updateFooter();}},setTitle:function(t){this.title=t;UI.setElementText(this.title_elt,t);toggleDisplay(this.title_row,(isset(t)&&t!=='')?true:false);},setMode:function(mode){this.mode=mode;},setModule:function(module,silent){this.module=module;if(!silent&&this.popup&&this.popup.visible){if(!module)
this.showModules();else if(this.mode=='search')
this.search(true);else if(this.mode=='recent')
this.showRecent();else if(this.mode=='detail')
this.search();}},setFilters:function(fs){this.filters=fs;},setKey:function(k,force_clear){this.key=k;this.force_clear=force_clear;},setCustomValue:function(v){this.custom_value=v;},setDetailModule:function(m){this.detail_module=m;},showDefault:function(reinit){if(reinit){this.setKey('',true);this.setQuery('');this.perform_remove=false;}
if(this.options){if(this.search_blank||this.haveQuery())
this.search();else
this.showOptions();}else if(!this.module&&!this.global_search){this.showModules();return;}else if(!this.haveQuery()&&!this.disable_recent&&!this.perform_remove){this.showRecent();}else{this.search();}
this.focusSearch();},focusSearch:function(){if(this.search_input)
this.search_input.focus();},showOptions:function(){if(!this.options)return;var oldmode=this.mode;this.mode='options';this.setTitle(this.options_title||'');if(oldmode!=='options'){this.list.setOptions(this.options);this.options_inited=true;}
this.list.setSelectedKey(this.key,true);this.highlightCurrent();UI.setDisplayState(this.detail_elt,false);this.setWaitingResult(false);if(this.popup)this.popup.show();this.updateDisplay();},getModuleTitle:function(){if(this.module&&this.module_options){var info=this.module_options.getValue(this.module);if(info)return info._display;}
return this.module;},makeTitle:function(title){var mod_title=this.getModuleTitle();if(title&&mod_title)
title+=' ('+mod_title+')';return title;},showRecent:function(){if(this.disable_recent){if(this.popup)this.popup.hide();return;}
var oldmode=this.mode;this.mode='recent';this.setTitle(this.makeTitle(this.recent_title||app_string('LBL_REF_RECENT_ENTRIES')));if(oldmode!=='recent'){this.recent_options.clear();this.list.setOptions(this.recent_options);}
toggleDisplay(this.detail_elt,false);var self=this,callback=function(data){var rows=self.loadQueryResult(data.getResult());self.setSearchResults(rows);},exclude=this.getExcludeKeys(),data={module:this.module,fields:this.extra_fields,filters:this.filters,exclude_ids:exclude},method=this.list_recent_method||'list_recent',req=new App.conn.JSONRequest(method,{silent:true},data);req.fetch(callback);this.setWaitingResult(req.request_id);this.updateDisplay();if(this.popup)this.popup.show();},getListRowCount:function(){return this.list&&this.list.options&&this.list.options.keys.length;},updateFooter:function(){if(this.show_waiting){UI.setDisplayState(this.wait_elt,true);UI.setDisplayState(this.status_row,false);}else{UI.setDisplayState(this.wait_elt,false);if(this.mode==='detail'||this.mode==='module'){UI.setDisplayState(this.status_row,false);}else{if(this.getListRowCount()){if(this.mode==='recent'||!this.total_count){UI.setDisplayState(this.status_row,false);}else{UI.setElementText(this.status_elt,''+this.total_count+(this.total_count==1?' result':' results'));UI.setDisplayState(this.status_row,true);}}
else if(this.global_search&&!this.module){UI.setElementText(this.status_elt,app_string('LBL_REF_PRESS_TO_SEARCH'));UI.setDisplayState(this.status_row,true);}
else{UI.setElementText(this.status_elt,app_string('LBL_NO_RESULTS'));UI.setDisplayState(this.status_row,true);}}}},setPerformRemove:function(flag,refocus){this.perform_remove=!!get_default(flag,true);this.search();if(refocus)this.focusSearch();},updateFilter:function(){if(this.source_keys){if(!this.filter_add_rem){var self=this;this.filter_add_rem=MakeElt('div.input-button-group');this.filter_add=new UI.CheckInput(this.id+'-filtadd',{name:this.id+'-addrem',input_type:'radio',ext_class:'input-field',label:app_string('LBL_MULTI_ADD_ITEMS'),init_value:1});this.filter_add.onchange=function(){if(this.getValue())self.setPerformRemove(false,true);};this.filter_add_rem.append(this.filter_add.render());this.filter_add.setup();this.filter_rem=new UI.CheckInput(this.id+'-filtrem',{name:this.id+'-addrem',input_type:'radio',ext_class:'input-field',label:app_string('LBL_MULTI_REMOVE_ITEMS')});this.filter_rem.onchange=function(){if(this.getValue())self.setPerformRemove(true,true);};this.filter_add_rem.append(this.filter_rem.render());this.filter_rem.setup();}
if(this.perform_remove){this.filter_add.setValue(false,true);this.filter_rem.setValue(true,true);}
else{this.filter_rem.setValue(false,true);this.filter_add.setValue(true,true);}
UI.setElementContent(this.filter_elt,this.filter_add_rem);return true;}},updateDisplay:function(){UI.setDisplayState(this.return_row,(this.mode!=='module'&&this.dynamic_module&&!this.union_module&&!this.options)?1:0);var show_list=false;if(this.mode==='module'){UI.setDisplayState(this.search_elt,false);UI.setDisplayState(this.detail_elt,false);UI.setDisplayState(this.filter_row,false);UI.setDisplayState(this.list_elt,(show_list=true));}
else if(this.mode==='detail'){UI.setDisplayState(this.search_elt,false);UI.setDisplayState(this.detail_elt,true);UI.setDisplayState(this.detail_close,true);UI.setDisplayState(this.filter_row,false);UI.setDisplayState(this.list_elt,(show_list=false));}
else{UI.setDisplayState(this.search_elt,true);UI.setDisplayState(this.detail_elt,false);UI.setDisplayState(this.detail_close,false);var show_info=!!(this.key&&
(!this.options||(this.options.dom_name&&
this.options.dom_name.substring(0,6)=='model.')));UI.setDisplayState(this.info_button,show_info);UI.setDisplayState(this.filter_row,!!this.updateFilter());UI.setDisplayState(this.list_elt,(show_list=!!this.getListRowCount()));}
UI.setDisplayState(this.clear_button,!!(this.key||this.force_clear));if(show_list)this.list.updateDisplay();this.updateFooter();},showDetail:function(){if(this.disable_show_detail)return this.cancelSearch();this.mode='detail';if(this.key){var self=this,k=this.key,callb=function(body,caption,width,buttons){self.setDetails(k,body,caption,width);};this.setTitle(app_string('LBL_REF_DETAILS'));this.setWaitingResult('detail');App.util.getAdditionalDetails(this.detail_module||this.module,this.key,callb,undefined,'refinput');this.updateDisplay();}
else if(this.custom_value){this.setTitle(app_string('LBL_REF_CUSTOM_ENTRY'));this.detail_elt.innerHTML=html_escape(this.custom_value);this.updateDisplay();if(this.popup)this.popup.show();}},setDetails:function(key,body,caption,width){if(this.key==key&&this.waiting_result==='detail'){this.detail_elt.innerHTML=body;this.setWaitingResult(false);this.updateDisplay();if(this.popup)this.popup.show();}},setSearchResults:function(rows,req_id){if(!this.waiting_result||(isset(req_id)&&req_id!=this.waiting_result))return;this.setWaitingResult(false);var sel_idx=this.initSearchOptions(true);var prefix='';if(rows)
for(var i=0;i<rows.length;i++){prefix='';if(!this.global_search&&(rows[i][1].hasOwnProperty('is_union')&&rows[i][1].hasOwnProperty('_module'))&&rows[i][1].is_union){prefix=rows[i][1]._module+'_';}
this.search_options.addOption(''+prefix+rows[i][0],rows[i][1]);}
this.list.setOptions(this.search_options);this.list.setSelectedKey(this.key,true);this.highlightCurrent(sel_idx);this.updateDisplay();this.reposition();},setOptions:function(opts){this.options=opts;this.initOptions();},renameOptionValue:function(for_result){var lbl=trim(this.query);if(this.allow_rename&&lbl.length&&this.key){if(for_result)return lbl;lbl=app_string('LBL_REF_RENAME_ENTRY')+app_string('LBL_SEPARATOR')+lbl;return{_display:lbl,name:lbl};}},customOptionValue:function(for_result){var lbl=trim(this.query),opts=this.options,i;if(this.allow_custom&&lbl.length){if(opts){for(i=0;i<opts.keys.length;i++){if(opts.values[i]==lbl)return;}}
if(!for_result)lbl=app_string('LBL_REF_CUSTOM_ENTRY')+app_string('LBL_SEPARATOR')+lbl;var ret={name:lbl};ret[this.display_name||'_display']=lbl;return ret;}},quickCreateOptionValue:function(for_result){var lbl=trim(this.query);if(this.quick_create&&lbl.length){if(!for_result)lbl=app_string('LBL_REF_QUICK_CREATE_ENTRY')+app_string('LBL_SEPARATOR')+lbl;return{_display:lbl,name:lbl};}},initSearchOptions:function(clear){var rename=this.renameOptionValue(),cust=this.customOptionValue(),create=this.quickCreateOptionValue(),opts=this.search_options,o=this.options;if(o){if(o.columns)opts.columns=o.columns;}
if(clear){opts.clear();if(rename)opts.addOption('_rename',rename);if(cust)opts.addOption('_custom',cust);if(create)opts.addOption('_create',create);}
return null;},haveQuery:function(){return isset(this.query)&&trim(this.query)!=='';},search:function(clear_results){this.total_count=null;if(!this.module&&!this.options&&!this.global_search){this.showModules();return;}
if(!this.haveQuery()){if(this.search_blank||this.perform_remove);else if(this.disable_recent)return this.cancelSearch();else
return this.showRecent();}
this.mode='search';this.setTitle(this.makeTitle(
this.options?this.options_title:(this.search_title||app_string('LBL_REF_SEARCH_RESULTS'))));this.cancelRunSearch();var sel_idx=this.initSearchOptions(clear_results);this.list.setOptions(this.search_options);if(clear_results){this.list.setSelectedKey(this.key,true);this.highlightCurrent(sel_idx);}
UI.setDisplayState(this.detail_elt,false);UI.setDisplayState(this.list_elt,!!this.search_options.keys.length);if(!this.module&&this.global_search){this.setTitle(null);this.updateDisplay();if(this.popup)this.popup.show();return;}
this.runSearchDelayed(this.search_delay);this.updateFooter();if(this.popup)this.popup.show();},showModules:function(){this.mode='module';this.setTitle(this.module_title||app_string('LBL_REF_SELECT_MODULE'));this.cancelRunSearch();this.list.icon_key='icon';this.list.setOptions(this.module_options);this.list.setSelectedKey(this.module,true);this.updateDisplay();if(this.popup)this.popup.show();},highlightCurrent:function(sel_idx){if(!this.list)return;var keys=this.list.getKeys(),vals,i,s,q=this.query;if(this.mode=='search'){if(!isset(sel_idx)){if(this.search_current_key){for(i=0;i<keys.length;i++){if(keys[i]==this.search_current_key){sel_idx=i;break;}}}}
if(!isset(sel_idx)&&!this.disable_auto_select){if(this.options&&isset(q)&&q!==''){vals=this.list.getValues();for(i=0;i<keys.length;i++){if(keys[i]=='_create'||keys[i]=='_rename'||keys[i]=='_custom')continue;if(isObject(vals[i]))s=vals[i]._display;else s=vals[i];if(s&&s.substring(0,q.length)==q){sel_idx=i;break;}}}
if(!isset(sel_idx)){for(i=0;i<keys.length;i++){sel_idx=i;if(keys[i]!='_create'&&keys[i]!='_rename'&&keys[i]!='_custom')
break;}}}}
this.list.setCurrentIndex(sel_idx,null,true);},cancelRunSearch:function(){if(this.searchTimeout){clearTimeout(this.searchTimeout);this.searchTimeout=null;}
if(this.waiting_result){App.conn.abortRequest(this.waiting_result);this.setWaitingResult(false);}},runSearchDelayed:function(delay){if(delay&&!this.options){var self=this;this.searchTimeout=setTimeout(function(){self.runSearch();},delay);}else
this.runSearch();},loadQueryResult:function(result){var rows=[];this.total_count=null;if(result&&!result.failed){var l=result.formatted_rows,pk=result.primary_key,mdirs=result.module_dirs;this.total_count=result.total_count||result.result_count;for(var i=0;i<l.length;i++){if(mdirs&&l[i].query_source)l[i]._module=mdirs[l[i].query_source];else if(mdirs)l[i]._module=mdirs[0];else l[i]._module=this.module;if(l[i]._module)l[i].icon='theme-icon module-'+l[i]._module;l[i].is_union=result.is_union;rows.push([l[i][pk],l[i]]);}
this.is_union=result.is_union;}
return rows;},setSourceKeys:function(keys){this.source_keys={};if(keys)for(var i=0;i<keys.length;i++){this.source_keys[keys[i]]=1;}
if((this.flat||(this.popup&&this.popup.visible))&&(this.mode==='search'||this.mode==='options'))
this.search();},getIncludeKeys:function(){if(this.perform_remove&&this.source_keys){var ret=[];for(var k in this.source_keys)
ret.push(k);if(!ret.length)ret.push('--');return ret.join(',');}},getExcludeKeys:function(){if(!this.perform_remove&&this.source_keys){var ret=[];for(var k in this.source_keys)
ret.push(k);return ret.join(',');}},filterKeys:function(idx,key,sel,perform_remove){if(sel&&sel[key]){if(!perform_remove)return false;}else if(perform_remove){return false;}
return true;},runSearch:function(){this.searchTimeout=null;if(this.options){var opts=this.options,q=isset(this.query)?trim(this.query).toLowerCase():'',rows=[],i,k,v,lst=[],tail=[],sel=this.source_keys;var filter_keys=(this.filter_keys||this.filterKeys).bind(this);for(i=0;i<opts.keys.length;i++){k=opts.keys[i];if(!filter_keys(i,k,sel,this.perform_remove))
continue;v=opts.getLabel(k).toLowerCase();if(sel&&sel[k]){if(!this.perform_remove)continue;}else if(this.perform_remove){continue;}
if(q.length){if(v.indexOf(q)<0){if(this.search_blank&&!this.matching_only)
tail.push([k,opts.getValue(k)]);continue;}
if(v.substring(0,q.length)!=q){lst.push([k,opts.getValue(k)]);continue;}}
rows.push([k,opts.getValue(k)]);}
rows.pushArray(lst);rows.pushArray(tail);this.total_count=rows.length;this.setWaitingResult(true);this.setSearchResults(rows);return;}
var self=this,callback=function(data){var rows=self.loadQueryResult(data.getResult());self.setSearchResults(rows,data.request_id);},data={module:this.module,bean_name:this.bean_name,filter_text:this.query,fields:this.extra_fields,include_ids:this.getIncludeKeys(),exclude_ids:this.getExcludeKeys()},method=this.quicksearch_method||'quicksearch',req=new App.conn.JSONRequest(method,{silent:true},data);if(this.filters)
req.setArgs(this.filters);req.fetch(callback);this.setWaitingResult(req.request_id);this.updateDisplay();},setQuery:function(prefix){var q=this.query;if(!isset(q))q='';if(!isset(prefix))prefix='';this.query=prefix;if(prefix!==q)
this.search(true);if(this.search_input)
this.search_input.setValue(prefix,true);},cancelSearch:function(){this.close();UI.callEvent(this,this.oncancel);},close:function(){this.search_current_key=null;this.setWaitingResult(false);if(this.popup){this.popup.close();if(this.popup.destroy_on_close){this.popup=null;this.title_elt=this.list_elt=this.detail_elt=this.list=null;}}
if(this.detail_elt)
this.detail_elt.innerHTML='';},setWidth:function(w){this.width=w;if(this.popup)
this.popup.setWidth(w);},adjustCurrentIndex:function(nav,nowrap,evt){if(this.list)
this.list.adjustCurrentIndex(nav,nowrap,evt);},acceptCurrent:function(evt){if(this.list)return this.list.selectCurrent(evt);UI.callEvent(this,this.onaccept,this.search_input.getValue(),evt);},submitSearch:function(q){return UI.callEvent(this,this.onaccept,q);},rowSelected:function(k,v,silent,evt){if(this.mode=='module'){this.setModule(k);UI.setDisplayState(this.list_elt,false);this.list.setOptions(null);this.showDefault();return;}
if(k==='_custom'){k='';v=this.customOptionValue(true);}
else if(k=='_rename'){k=this.key;if(!silent)
UI.callEvent(this,this.onrename,this.renameOptionValue(true),evt);silent=true;}
else if(k==='_create'){this.setKey('');var query=this.getQuery();this.close();UI.callEvent(this,this.onquickcreate,evt,query);return;}else if(this.is_union){var pos=k.indexOf('_');if(~k){k=k.substring(pos+1);}}
this.setKey(k);keepOpen=(this.popup_return_multiple&&evt&&(evt.cmdKey||evt.shiftKey));if(!keepOpen)
this.close();if(!silent){if(this.perform_remove)
UI.callEvent(this,this.onremove,k,v,this.module,keepOpen,evt);else
UI.callEvent(this,this.onchange,k,v,this.module,keepOpen,evt);}
if(keepOpen)
this.focus();},rowCurrent:function(k,v,silent){if(this.mode=='search')
this.search_current_key=k;},isHovered:function(){return(this.popup&&this.popup.hovered);},getModule:function(){return this.module;},getQuery:function(){return this.search_input&&this.search_input.getValue();},showDialog:function(){if(UI.callEvent(this,this.onpopup))return;var self=this,q=this.getQuery(),mod=this.module,request_data={form_name:this.form.getAttribute('id')||this.form.getAttribute('name'),call_back_function:this.popup_callback||'ui_popup_return',passthru_data:this.passthru,field_to_name_array:{id:'id',_display:'_display'}},params={module:mod,layout:this.popup_layout,request_data:request_data,inline:true};if(!mod)return;if(this.union_module)
request_data.field_to_name_array['_module']='query_module';var add_fs=this.extra_fields;if(add_fs){for(i in add_fs){request_data.field_to_name_array[i]=add_fs[i];}}
params.filter=deep_clone(this.filters||{});params.filter.filter_text=trim(q);if(this.popup_return_method)
request_data.passthru_data.ui_return_method=this.popup_return_method;if(this.popup_return_multiple)
params.multiple=true;params.onclose=function(){self.cancelSearch();}
this.setQuery('');open_popup_window(params);this.close();}};UI.SearchInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;this.focused=false;this.show_clear=true;if(params)extendObject(this,params);}
UI.SearchInput.prototype={setup:function(){if(this.set_up)return;if(!this.elt)
this.elt=$(this.id);if(!this.field){if(this.name&&this.form)
this.field=this.form.elements[this.name];else if(this.field_id)
this.field=$(this.field_id);}
if(!this.elt)return;if(!this.clear_button){this.clear_button=Wrap(this.elt).findFirst('.search-clear').get(0);}
if(!this.tabIndex&&this.field&&this.field.tabIndex>0)
this.tabIndex=this.field.tabIndex;this.addHooks();this.updateDisplay();this.set_up=true;},addHooks:function(){var events={mousedown:this.handleMouseDown,mouseenter:this.handleMouseEnter,mouseleave:this.handleMouseLeave,click:this.handleMouseClick,};UI.addEventListeners(this.elt,events,this);var field_events={focus:this.handleFocus,blur:this.handleBlur,mousedown:this.fieldMouseDown,keydown:this.fieldKeyDown,input:this.fieldInput,change:this.handleChanged};UI.addEventListeners(this.field,field_events,this);var clear_events={focus:this.handleFocus,blur:this.handleBlur,mousedown:this.fieldMouseDown,click:this.clearInput};UI.addEventListeners(this.clear_button,clear_events,this);if(this.clear_button){this.clear_button.tabIndex=-1;}},fieldMouseDown:function(evt){UI.stopPropagation(evt);UI.callEvent(this,this.onmousedown,evt);},fieldKeyDown:function(evt){if(evt.keyCode==38)nav=-1;else if(evt.keyCode==40)nav=1;else nav=0;if(nav){if(this.searcher)
this.searcher.adjustCurrentIndex(nav,null,evt);else
this.showSearch();UI.stopEvent(evt);}else if(evt.keyCode==27){if(this.field.value.length){UI.stopEvent(evt);this.clearInput();}else if(this.searcher){UI.stopEvent(evt);this.hideSearch(true);}}else if(evt.keyCode==13){if(this.searcher){var accept=this.searcher.acceptCurrent(evt);if(accept){if(!this.embedded)this.hideSearch();}else if(accept!==false)
this.handleManualSubmit();UI.stopEvent(evt);}}else{var input=this;setTimeout(function(){input.showHideClear();},50);}
UI.callEvent(this,this.onkeydown,evt);UI.stopPropagation(evt);},fieldInput:function(evt){this.updateSearch();},handleMouseDown:function(evt){this.focus();UI.stopEvent(evt);UI.callEvent(this,this.onmousedown,evt);},handleMouseClick:function(evt){UI.callEvent(this,this.onclick,evt);},handleMouseEnter:function(evt){this.hovered=true;this.showHideClear();},handleMouseLeave:function(evt){this.hovered=false;this.showHideClear();},focus:function(){if(this.field)
this.field.focus();},select:function(){if(this.field){this.field.focus();this.field.select();}},handleFocus:function(evt,clear_focused){this.focused=clear_focused?'clear':true;if(this.field&&!clear_focused&&!this.did_clear)
this.focus_value=this.field.value;UI.callEvent(this,this.onfocus,evt);this.updateDisplay();},handleBlur:function(evt){var oldfocus=this.focused;this.focused=false;UI.callEvent(this,this.onblur,evt);if(oldfocus!='clear'&&this.did_clear&&this.getValue()===''){this.checkSubmit()
this.did_clear=false;}
this.updateDisplay();},clear:function(){this.field.value='';this.updateDisplay();},clearInput:function(evt){if(!isset(this.focus_value))
this.focus_value=this.field.value;this.field.value='';if(this.focused)this.did_clear=true;this.focus();UI.callEvent(this,this.onchange,evt);this.updateSearch();if(!this.focused)
this.checkSubmit();this.updateDisplay();},showHideClear:function(){if(this.field&&this.clear_button){UI.setDisplayState(this.clear_button,(this.show_clear&&this.field.value.length&&(this.hovered||this.focused)));if(this.focused=='clear')
this.focus();}},handleManualSubmit:function(){this.field.value=trim(this.field.value);this.checkSubmit(true);this.focus_value=this.field.value;this.updateDisplay();},handleChanged:function(evt){if(this.redirecting)return;this.field.value=trim(this.field.value);UI.callEvent(this,this.onchange,evt);if(this.form){var input=this;setTimeout(function(){input.checkSubmit();},300);}
this.updateDisplay();},checkSubmit:function(force){if(this.redirecting)return;if(force||(this.auto_submit&&this.field&&this.focus_value!==this.field.value)){if(this.searcher){if(this.searcher.submitSearch&&this.searcher.submitSearch(this.field.value))return true;this.hideSearch();}
if(this.form){UI.submitForm(this.form);return true;}}},getValue:function(){return this.field?this.field.value:null;},setValue:function(value){this.field.value=value;this.updateDisplay();},getModule:function(){if(this.module)return this.module;if(this.form&&this.form.module)return this.form.module.value;},getListId:function(){if(this.form&&this.form.list_id)return this.form.list_id.value;},updateSearch:function(){this.showSearch();},cancelShowSearch:function(){if(this.searchTimeout){clearTimeout(this.searchTimeout);this.searchTimeout=null;return true;}},cancelHideSearch:function(){if(this.hideSearchTimeout){clearTimeout(this.hideSearchTimeout);this.hideSearchTimeout=null;return true;}},showSearchDelayed:function(delay){this.cancelHideSearch();var input=this;this.searchTimeout=setTimeout(function(){input.showSearch();},delay||1000);},initSearcher:function(){var mod=this.getModule(),list_id=this.getListId(),self=this;if(!this.quick_view||!mod||!list_id)return false;this.searcher=new UI.SearchSelect(this.id+'-select',{module:mod,target:this.elt,target_offset:{top:-1,left:10},disable_recent:true,search_title:app_string('LBL_SEARCH_QUICK_VIEW'),disable_auto_select:true});this.searcher.onchange=function(k,v,mod){if(isset(self.focus_value))self.setValue(self.focus_value);self.redirecting=true;if(self.form&&self.form.action&&self.form.action.value=='Popup')
sListView.popupReturn(list_id,mod,k);else
sListView.showDetail(list_id,{module:mod,action:'DetailView',record:k});}
this.searcher.onmouseup=function(evt){self.searchMouseUp(evt);}
this.own_search=true;return true;},searchMouseUp:function(evt){if(this.focused==='search')
this.field.focus();},showSearch:function(){if(!this.searcher&&!this.initSearcher())return;if(this.own_search){this.cancelShowSearch();this.cancelHideSearch();this.searcher.render();var w=UI.getEltRegion(this.elt);if(w)
this.searcher.setWidth(Math.max(w.width-14,325)+'px');}
if(!this.disabled)
this.searcher.setQuery(this.getValue());this.searcher.showDefault();},hideSearchDelayed:function(delay){this.cancelShowSearch();this.cancelHideSearch();var input=this;this.hideSearchTimeout=setTimeout(function(){input.hideSearch();},delay||100);},hideSearch:function(refocus){this.cancelShowSearch();this.cancelHideSearch();if(this.searcher){this.searcher.cancelSearch();}
if(this.focused&&this.field&&refocus){this.field.focus();this.field.select();}},render:function(){if(this.rendered)return;if(!this.elt){this.elt=createElement2('div',{className:'input-field input-field-group input-search',id:this.id});if(this.width)UI.setWidth(this.elt,this.width);}else
UI.clearChildNodes(this.elt);createElement2('div',{className:'input-label input-field-icon lg'},createElement2('div',{className:'uii uii-lg uii-search'}),this.elt);this.field=createElement2('input',{className:'input-text',value:this.init_value,placeholder:this.placeholder,autocorrect:'off',autocomplete:'off',tabIndex:this.tabIndex},null,this.elt);this.field.spellcheck=false;this.clear_button=createElement2('div',{style:{display:'none'},className:'uii uii-clear search-clear'},null,this.elt);this.rendered=true;return this.elt;},updateDisplay:function(){this.showHideClear();UI.addRemoveClass(this.elt,'active',!!this.focused);}};UI.TagsInput=function(id,params){var attrs=isObject(params)?params:{};attrs.module='KBArticles';attrs.quick_view=true;attrs.tags=Array.isArray(attrs.tags)?attrs.tags:[];UI.SearchInput.call(this,id,attrs);this.animation=new App.animation.Animation().distribute(20,function(percent){return{opacity:Math.abs((50-percent)/80)+0.375}}).duration(500).timing('ease-out')}
extendClass(UI.TagsInput,UI.SearchInput,{render:function(){if(this.rendered)return;var elt=UI.SearchInput.prototype.render.call(this);UI.removeClass(this.elt,'input-search input-field');UI.addClass(this.field,'flat');Wrap(elt).find('.uii-search.input-field-icon').remove();Wrap(this.clear_button).remove();this.tags_container=createElement2('div',{className:'input-inline input-sm'});this.tags_field=createElement2('input',{type:'hidden',name:this.name,value:this.getJoinedTags()});var outer=createElement2('div',{className:'input-sm '},[this.tags_field,elt,this.tags_container]);this.renderTags();return outer;},getListId:function(){return this.id+'-list-id';},initSearcher:function(){var ret=UI.SearchInput.prototype.initSearcher.call(this);if(this.searcher){this.searcher.bean_name='kb_tags';var setSearchResults=this.searcher.setSearchResults;var self=this;this.searcher.setSearchResults=function(rows,req_id){setSearchResults.call(this,rows,req_id);if(!self.removed_text&&this.search_options.keys.length){var key=this.search_options.keys[0];var best=self.nthMatch(0);if(best!==null){var value=self.getValue();if(best.indexOf(value)===0){self.field.value=best;self.field.setSelectionRange(value.length,best.length);}}}
self.removed_text=false;}
this.searcher.onchange=function(k,v,mod){self.addTag(v._display);self.clear();self.focus();self.hideSearch();}
this.searcher.makeTitle=function(){return'';}}
return ret;},addTag:function(tag){this.addTags([tag]);},addTags:function(tags){var idxs=[];tags.forEach(function(tag){var idx=this.tags.indexOf(tag);if(!~idx){this.tags.push(tag);idx=this.tags.length-1;}
if(!~idxs.indexOf(idx))
idxs.push(idx);}.bind(this));this.tags_field.value=this.getJoinedTags();this.renderTags(idxs);},getJoinedTags:function(){return this.tags.join(', ');},handleBlur:function(evt){this.hideSearch();UI.SearchInput.prototype.handleBlur.call(this,evt);},fieldKeyDown:function(evt){if(evt.keyCode==8||evt.keyCode==46){this.removed_text=true;}
if(evt.keyCode==13){var value;if(isset(this.searcher.search_current_key)){value=this.nthMatch(this.searcher.list.current_index);}
if(!isset(value))
value=this.getValue().trim();var add=this.allow_add;if(!add){add=this.searcher.search_options.values.reduce(
function(prev,val){return(val._display==value?true:prev);},false);}
if(add){var values=value.split(',').map(
function(x){return x.trim();}).filter(
function(x){return x.length>0;});this.clear();this.addTags(values);this.hideSearch();}
return false;}else{var ret=UI.SearchInput.prototype.fieldKeyDown.call(this,evt);return ret;}},nthMatch:function(idx){if(this.searcher&&this.searcher.search_options.keys.length>idx){var key=this.searcher.search_options.keys[idx];return this.searcher.search_options.values.reduce(
function(prev,value){return(value.id==key?value._display:prev);},null);}},renderTags:function(animateIdxs){if(!Array.isArray(animateIdxs))
animateIdxs=[];var self=this;var $elt=Wrap(this.tags_container);$elt.find('.tag').remove();var elements=this.tags.map(function(tag,idx){var label=createElement2('div',{className:'input-label'},tag);var removeButton=createElement2('div',{style:{cursor:'pointer'},className:'input-label input-remove'});var outer=createElement2('div',{className:'input-field input-field-group state-label tag'},[label,removeButton]);removeButton.onclick=function(){self.tags.splice(idx,1);self.renderTags();self.tags_field.value=self.getJoinedTags();self.focus();}
if(~animateIdxs.indexOf(idx)){setTimeout(function(){self.animation.run(outer);},20);}
return outer;});$elt.append(elements);}});UI.CheckInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;this.onchange=null;this.focused=false;if(params)extendObject(this,params);};UI.CheckInput.prototype={setup:function(){if(this.set_up)return;if(!this.elt&&this.id){this.elt=$(this.id);}
if(!this.field){if(this.field_id)
this.field=$(this.field_id);else if(this.name&&this.form){this.field=this.form.elements[this.name];if(this.field&&this.field.length){if(this.field.length==2&&this.field[1].type=='checkbox'){this.off_value=this.field[0].value;this.field=this.field[1];}
else
this.field=null;}}}
if(this.field){this.real_check=(this.field.type=='checkbox'||this.field.type=='radio');this.orig_value=this.getValue();if(!isset(this.off_value))this.off_value=0;}
this.addHooks();this.updateDisplay();this.set_up=true;this.updateConditionals();},addHooks:function(){if(this.real_check){UI.addEventListener(this.field,'change',this.handleChanged,this);UI.addEventListener(this.field,'focus',this.handleFocus,this);UI.addEventListener(this.field,'blur',this.handleBlur,this);}
else if(this.elt){UI.addEventListener(this.elt,'click',this.handleClick,this);UI.addEventListener(this.elt,'keydown',this.handleKeyDown,this);}},render:function(){if(!this.rendered){var hidden=MakeElt('input',{type:'hidden',name:this.name,value:0,id:this.id+'-hidden'});var check=MakeElt('input',{type:this.input_type||'checkbox',name:this.name,value:this.submit_value||1,id:this.id+'-checkbox',tabindex:this.tabIndex});if(this.init_value)check.prop('checked',true);if(this.disabled)check.prop('disabled',true);this.elt=MakeElt('div',{id:this.id,'class':(this.className||('input-check'+(this.ext_class?' '+this.ext_class:'')))});if(!this.no_default&&this.input_type!='radio')
this.elt.append(hidden);this.elt.append(this.field=check.get());var toggle_switch;if(this.add_switch)
toggle_switch=MakeElt('div',{'class':'switch'});this.elt.append(MakeElt('label',{'for':this.id+'-checkbox','class':'input-label'},[' '+(this.label||''),toggle_switch]));this.rendered=true;}
return this.elt;},focus:function(){if(this.real_check&&this.field)this.field.focus();else if(this.elt)this.elt.focus();},getValue:function(){var val=this.orig_value||0;if(this.field){if(this.real_check)
val=this.field.checked?this.field.value:this.off_value;else if(isset(this.submit_value)&&this.field.value===this.submit_value)return 1;else
val=this.field.value;}
if(val==='1'||val==='true')val=1;if(val===''||val==='0')val=0;return val;},setValue:function(v,silent,evt){if(this.real_check&&this.field){this.field.checked=!!v;}else{v=v?(this.submit_value||1):0;if(this.field)this.field.value=v;}
this.afterUpdate(evt,silent);},toggle:function(silent,evt){this.setValue(!this.getValue(),silent,evt);},handleClick:function(evt){this.toggle(false,evt);this.afterUpdate(evt);},handleChanged:function(evt){this.afterUpdate(evt);},afterUpdate:function(evt,silent){var v=this.getValue();if(this.orig_value!==v)UI.markFormDirty(this);this.updateDisplay();if(!silent)UI.callEvent(this,this.onchange,evt,v);this.updateConditionals();if(this.auto_submit)
UI.submitForm(this.form);},handleKeyDown:function(evt){if(evt.keyCode==13){UI.stopEvent(evt);if(this.form)UI.submitForm(this.form);}},handleFocus:function(evt){this.focused=true;this.updateDisplay();UI.callEvent(this,this.onfocus,evt);},handleBlur:function(evt){this.focused=false;this.updateDisplay();UI.callEvent(this,this.onblur,evt);},updateDisplay:function(){if(this.elt){UI.addRemoveClass(this.elt,'checked',this.getValue());UI.addRemoveClass(this.elt,'active',!!this.focused);}},setDisabled:function(disabled){if(!isset(disabled))disabled=1;this.disabled=!!disabled;if(this.elt)this.elt.disabled=this.disabled;if(this.real_check&&this.field)
this.field.disabled=this.disabled;},updateConditionals:function(hide){var value=this.getValue();var callback=function(cf){if(cf.depends_on_value=='0')return!value;if(cf.depends_on_value=='1')return value;return true;}
UI.updateConditionals(this,callback,hide);}};UI.QuickCheck=function(params){var id=params.id||'quickchk-'+(++UI.QuickCheck.uniq_idx);UI.CheckInput.call(this,id,params);}
UI.QuickCheck.uniq_idx=0;extendClass(UI.QuickCheck,UI.CheckInput,{init:function(value,onchange){this.orig_value=value;this.onchange=onchange;this.set_up=false;this.setup();},initSource:function(source,value,onchange,oncancel){this.elt=source;this.init(value,onchange,oncancel);},showPopup:function(timeout,elt){if(elt.firstChild)this.elt=elt.firstChild;if(!this.field)this.field=createElement2('input',{type:'hidden',value:this.getValue()});this.toggle();}});UI.TextInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;this.focused=false;this.invalid=false;this.allow_blank=true;this.show_search=false;if(params)extendObject(this,params);};UI.TextInput.prototype={setup:function(){if(this.set_up)return;if(!this.field){if(this.elt)
this.field=this.elt;else if(this.name&&this.form)
this.field=this.form.elements[this.name];else if(this.field_id)
this.field=$(this.field_id);else if(this.id)
this.field=$(this.id);}
if(!this.elt)
this.elt=this.field;if(this.field)this.orig_value=this.field.value;if(!this.altInput&&this.alt_name){this.altInput=UI.getFormInput(this.form,this.alt_name);}
this.addHooks();this.updateDisplay();this.set_up=true;},addHooks:function(){var input=this;if(this.field){this.field.onfocus=function(evt){return input.handleFocus(evt||window.event);}
this.field.onblur=function(evt){return input.handleBlur(evt||window.event);}
this.field.onchange=function(evt){return input.handleChanged(evt||window.event);}
if('oninput'in this.field)
this.field.oninput=function(evt){return input.handleInput(evt||window.event);}
else
this.field.onpropertychange=function(){return input.handleInputCompat(window.event);}
this.field.onkeydown=function(evt){return input.handleKeyDown(evt||window.event);}
this.field.onkeyup=function(evt){return input.handleKeyUp(evt||window.event);}
this.field.onmousedown=function(evt){return input.handleMouseDown(evt||window.event);}
this.field.onclick=function(evt){return input.handleClick(evt||window.event);}}
if(this.altInput)
this.altInput.onchange=function(){input.clear();}
if(this.format=='password'&&this.check_strength)
this.addStrengthCheck();},addStrengthCheck:function(loaded){var input=this,sz,w,e,ew,next;if(!loaded){App.util.addScriptInclude('include/javascript/zxcvbn.js',function(){input.addStrengthCheck(1);});return;}
if(!this.str_meter&&this.field&&this.field.parentNode){sz=UI.getEltRegion(this.field);if(sz&&(w=sz.width)){this.str_meter=createElement2('div',{style:'vertical-align: top; width: '+w+'px; clear: left; height: 3px; line-height: 3px; margin-top: 1px'});ew=Math.floor((w-8)/5);for(var i=0;i<5;i++){e=createElement2('div',{style:'display: inline-block; vertical-align: top; height: 3px; line-height: 3px; width: '+ew+'px'},null,this.str_meter);e.style.marginLeft=i?'2px':Math.floor((w-ew*5-8)/2)+'px';e.style.backgroundColor='#bbb';}
var next=this.field.nextSibling;if(next&&next.className=='requiredStar')next=next.nextSibling;this.field.parentNode.insertBefore(this.str_meter,next);}}
if(this.str_meter){UI.attachInputEvent(this,'oninput',function(){input.setStrength(zxcvbn(input.getValue()).score);});}},setStrength:function(val){var e,c;this.strength=val;if(this.str_meter){c=val>2?'#5e6':(val==2?'#ec6':'#e66');if(this.getValue().length)val++;for(var i=0;i<5;i++){e=this.str_meter.childNodes[i];e.style.backgroundColor=(i<val)?c:'#bbb';}}},handleFocus:function(evt){this.focused=true;this.last_value=this.getValue();UI.callEvent(this,this.onfocus,evt);},handleBlur:function(evt){this.focused=false;if(this.opened)
this.hideSearchDelayed(100);UI.callEvent(this,this.onblur,evt);},getCurrencyInput:function(){if(!this.currency_input){if(this.currency_id){var cname=this.currency_id.replace(/_id$/,'');this.currency_input=UI.getFormInput(this.form,cname);if(!this.currency_input)
this.currency_input=UI.getFormInput(this.form,this.currency_id);}}
return this.currency_input;},getDecimals:function(){var d,cid;if(this.format=='int'||this.format=='sequence_number'){d=0;}else if(this.format=='currency'){d=2;if((cid=this.getCurrencyInput()))
d=cid.getDecimals();d=get_default(this.decimals,d);}else{d=get_default(this.decimals,0);}
return d;},getNoFormatNumber:function(){return(this.no_format||this.format=='sequence_number');},getNumberFormat:function(){var ret;if(this.numFormat)
ret=this.numFormat;else if(this.format=='int'||this.format=='float'||this.format=='currency'||this.format=='sequence_number'){ret={blankAllowed:this.allow_blank,minimumDecimals:this.min_decimals,decimalPlaces:this.getDecimals(),defaultNumValue:this.default_num_value,restrictPositive:this.restrict_positive,noFormat:this.getNoFormatNumber()};if(this.format=='currency'&&!isset(ret.minimumDecimals))
ret.minimumDecimals=ret.decimalPlaces;}
return ret;},checkNumberInput:function(){var numf=this.getNumberFormat(),v,num,upd;if(numf){num=validateNumberInput(this.field,numf);if(isset(this.min)&&(''+this.min!='')&&num<this.min){num=this.min;upd=1;}
else if(isset(this.max)&&(''+this.max!='')&&num>this.max){num=this.max;upd=1;}
if(upd)
this.field.value=this.no_format?num:stdFormatNumber(num);this.numVal=num;return true;}},handleChanged:function(evt,silent){if(this.checkNumberInput());else if(!this.no_format){if(this.format=='phone')
formatPhoneNumber(this.field);else if(this.format=='url')
formatUrl(this.field);else if(this.format=='email'||this.format=='hostname')
this.field.value=trim(this.field.value);}
var v=this.getValue();if(this.orig_value!==v)UI.markFormDirty(this);if(!silent)
UI.callEvent(this,this.onchange,evt,v);this.validate();},handleInputCompat:function(evt){if(evt.propertyName=='value')
this.handleInput(evt);},handleInput:function(evt){if(this.show_search){if(!this.opened)
this.showSearch();else
this.searcher.setQuery(this.getValue());}
UI.callEvent(this,this.oninput,evt);},handleMouseDown:function(evt){if(this.show_search&&!this.opened)
UI.stopPropagation(evt);},handleClick:function(evt){if(this.show_search){if(this.opened)
this.hideSearch();else{this.showSearch();UI.stopEvent(evt);}}},handleKeyDown:function(evt){var nav;if(evt.keyCode==38)nav=-1;else if(evt.keyCode==40)nav=1;else nav=0;if(nav&&this.show_search&&!this.disabled){if(this.opened)
this.searcher.adjustCurrentIndex(nav,null,evt);else
this.showSearch();UI.stopEvent(evt);}else if(evt.keyCode==13&&!this.disabled){if(this.show_search){if(this.opened){if(!this.searcher.acceptCurrent(evt))
this.hideSearch();}else
this.showSearch();UI.stopEvent(evt);}else{this.handleChanged(evt);if(this.invalid){var summary=UI.validationSummary([{name:this.name,label:this.label,message:this.invalidMsg}]);if(summary)alert(summary);UI.stopEvent(evt);}
else
return UI.callEvent(this,this.onreturn,evt);}}else if(evt.keyCode==27){if(this.show_search&&this.opened){this.hideSearch(true);this.setValue(this.search_value);this.select();UI.stopEvent(evt);}
else if(!this.disabled){if(isset(this.last_value)&&this.last_value!=this.getValue()){this.setValue(this.last_value);this.select();UI.stopEvent(evt);}
else if(!this.isBlank()){this.clear();UI.stopEvent(evt);}}}
return UI.callEvent(this,this.onkeydown,evt);},handleKeyUp:function(evt){return UI.callEvent(this,this.onkeyup,evt);},checkAltValue:function(){var v;if(this.altInput&&(v=this.altInput.getValue())){return v;}},validate:function(){var v=this.getValue();this.invalid=false;if(this.required&&this.isBlank()&&!this.checkAltValue()){this.invalid=true;this.invalidMsg='required';}
else if(this.format=='ascii'&&!v.match(/^[\x20-\x7E]*$/)){this.invalid=true;this.invalidMsg='invalid';}
else if(this.format=='regexp'){var re=new RegExp(this.format_regexp);if(!this.getValue().match(re)){this.invalid=true;this.invalidMsg='invalid';}}
else if(this.format=='email'&&v.length&&!v.match(/^\S+@\S+\.[a-zA-Z]+$/)){this.invalid=true;this.invalidMsg='invalid';}
else if(this.customValidate)
this.customValidate();this.updateDisplay();return!this.invalid;},formatValue:function(input){var numf=this.getNumberFormat(),num;if(numf){num=validateNumber(input,numf);input=this.no_format?num:stdFormatNumber(num);}
return input;},render:function(){if(!this.field){var init_val=this.init_value;if(typeof(init_val)=='number')
init_val=this.formatValue(init_val);var cls=this.className||'input-text';if(this.flat)cls+=' flat';if(this.block)cls+=' input-block';if(this.ext_class)cls+=' '+this.ext_class;var attrs={type:'text',className:cls,id:this.field_id||this.id,name:this.name,value:init_val};var seta=['size','style','readOnly','disabled','placeholder','tabIndex'];for(var i=0;i<seta.length;i++)
if(isset(this[seta[i]]))attrs[seta[i]]=this[seta[i]];this.field=createElement2('input',attrs);if(this.align)this.field.style.textAlign=this.align;this.addHooks();this.updateDisplay();}
return this.field;},focus:function(){if(this.field)this.field.focus();},select:function(){if(this.field){this.field.focus();this.field.select();}},getValue:function(nativeVal){var ret=this.field?this.field.value:'';if(nativeVal){if(ret==='')return 0;if(this.format=='int')
ret=parseInt(stdUnformatNumber(ret),10);else if(this.format=='float'||this.format=='currency')
ret=parseFloat(stdUnformatNumber(ret));}
return ret;},isBlank:function(){return!trim(this.getValue()).length;},isNumeric:function(){return(this.format=='int'||this.format=='sequence_number'||this.format=='float'||this.format=='currency'||this.format=='phone');},setValue:function(val,silent){if(typeof(val)=='number')
val=this.formatValue(val);if(this.field){if(!isset(val))val='';this.field.value=val;this.checkNumberInput();}
this.validate();val=this.getValue();if(this.orig_value!==val)UI.markFormDirty(this);this.last_value=val;if(!silent)
UI.callEvent(this,this.onchange,null,val);},clear:function(){this.setValue('');},updateDisplay:function(){if(this.altInput)
UI.setDisplayState(this.field,this.checkAltValue()?false:true);UI.addRemoveClass(this.field,'invalid',!!this.invalid);UI.addRemoveClass(this.field,'flat-bottom',!!this.opened);UI.addRemoveClass(this.field,'text-number',!!(this.isNumeric()||this.format==='number'));},setSize:function(size){this.size=size;if(this.field)this.field.size=size;},setDisabled:function(disabled){if(!isset(disabled))disabled=1;this.disabled=!!disabled;if(this.field)this.field.disabled=this.disabled;},setReadOnly:function(readonly){if(!isset(readonly))readonly=1;this.readOnly=!!readonly;if(this.field)this.field.readOnly=this.readOnly;},destroy:function(){UI.removeNode(this.elt,true);this.elt=null;},setSearch:function(show,dom_name){this.show_search=show;this.search_dom=dom_name;if(!show)
this.hideSearch();else if(this.searcher)
this.searcher.setOptions(dom_name);},showSearchDelayed:function(delay){this.cancelHideSearch();var input=this;this.searchTimeout=setTimeout(function(){input.showSearch();},delay||this.search_delay||1000);},cancelShowSearch:function(){if(this.searchTimeout){clearTimeout(this.searchTimeout);this.searchTimeout=null;return true;}},cancelHideSearch:function(){if(this.hideSearchTimeout){clearTimeout(this.hideSearchTimeout);this.hideSearchTimeout=null;return true;}},searchReturn:function(key,val,mod){if(isObject(val))val=val._display;this.search_key=key;if(this.key_name&&this.form){var inp=this.form.elements[this.key_name];if(inp)inp.value=key;}
this.setValue(val);this.last_value=this.search_value;},initSearcher:function(){var self=this;this.searcher=new UI.SearchSelect(this.id+'-search',{target:this.elt,target_offset:{top:-1,left:0},search_blank:this.search_blank,options:this.search_dom,disable_recent:true,allow_custom:true});this.searcher.onchange=function(k,v,mod){self.searchReturn(k,v,mod);self.select();}
this.searcher.onshow=function(){self.opened=true;self.updateDisplay();}
this.searcher.onhide=function(){self.opened=false;self.updateDisplay();}
this.searcher.oncancel=function(){self.select();}
this.searcher.onmouseup=function(evt){}},showSearch:function(){this.cancelShowSearch();this.cancelHideSearch();var p=UI.PopupManager.currentModal();if(p&&!UI.isAncestor(p.elt,this.elt))return;if(!this.searcher)
this.initSearcher();this.searcher.render();var w=UI.getEltRegion(this.elt);if(w)
this.searcher.setWidth(Math.max(w.width-24,300)+'px');var v=this.getValue();this.search_value=this.last_value;this.searcher.setKey(v);this.searcher.setQuery(v);this.searcher.showDefault();},hideSearchDelayed:function(delay){this.cancelShowSearch();this.cancelHideSearch();var input=this;this.hideSearchTimeout=setTimeout(function(){input.hideSearch();},delay||100);},hideSearch:function(refocus){this.cancelShowSearch();this.cancelHideSearch();if(this.searcher){var v=this.getValue();this.searcher.close();}
if(this.focused&&refocus){this.focus();this.select();}}};UI.TextAreaInput=function(id,params){UI.TextInput.call(this,id,params);};extendClass(UI.TextAreaInput,UI.TextInput,{handleKeyDown:function(evt){var ret;if(evt.keyCode==13&&evt.shiftKey){this.handleChanged(evt);if(!this.invalid){ret=UI.callEvent(this,this.onreturn,evt);if(isset(ret))return ret;UI.stopEvent(evt);if(this.form)UI.submitForm(this.form);}}
return UI.callEvent(this,this.onkeydown,evt);},render:function(){if(!this.field){var attrs={className:(this.className||'input-text'),id:this.field_id||this.id,name:this.name,value:this.init_value,rows:4,cols:60};var seta=['rows','cols','style','readOnly','disabled','placeholder','tabIndex'];for(var i=0;i<seta.length;i++)
if(isset(this[seta[i]]))attrs[seta[i]]=this[seta[i]];this.field=createElement2('textarea',attrs);this.addHooks();this.updateDisplay();}
return this.field;}});UI.QuickText=function(params){this.id='quicktxt-'+(++UI.QuickText.uniq_idx);if(params)extendObject(this,params);}
UI.QuickText.uniq_idx=0;UI.QuickText.prototype={init:function(value,onchange,oncancel,validate){this.value=value;this.onchange=onchange;this.oncancel=oncancel;if(validate)
this.customValidate=validate;this.set_up=false;this.addHooks();},initSource:function(source,value,onchange,oncancel,validate){this.elt=source;this.init(value,onchange,oncancel,validate);},setup:function(){this.addHooks();},addHooks:function(){if(this.elt){UI.addEventListener(this.elt,'mousedown',UI.stopPropagation);UI.addEventListener(this.elt,'click',this.handleClick,this);}},handleClick:function(evt){this.showPopup();evt.stopEvent();},getTargetOffset:function(){return null;},getContentElement:function(){if(!this.content_elt)
this.content_elt=createElement2('div',{className:'quick-input-content'});return this.content_elt;},showPopup:function(timeout,target,offset){var input=this,content=this.getContentElement(),p=new UI.PopupSlidePanel(this.id,{target:target||this.elt,target_offset:offset||this.getTargetOffset(),destroy_on_close:true,content_elt:content});p.onclose=function(){input.handleClosePopup();}
p.onshow=function(){input.field.select();}
p.render();if(!this.field){if(this.multiline)
this.field=new UI.TextAreaInput(this.field_id||this.id+'-input',{label:this.label});else
this.field=new UI.TextInput(this.field_id||this.id+'-input',{format:this.format,decimals:this.decimals,label:this.label});}
if(!this.multiline)
this.field.setSize(this.size||16);var body=[this.field.render()];var buttons=[];if(this.multiline||this.show_update){if(!this.update_button)
this.update_button=new UI.ButtonInput(
this.update_id||this.id+'-update',{icon:'icon-accept',label:app_string('LBL_UPDATE'),onclick:function(evt){input.handleReturn(evt);}});buttons.push(this.update_button.render());}
if(this.show_reset){if(!this.reset_button)
this.reset_button=new UI.ButtonInput(
this.reset_id||this.id+'-reset',{icon:'icon-cancel',label:app_string('LBL_RESET_BUTTON_LABEL'),onclick:function(evt){input.handleReset(evt);}});buttons.push(this.reset_button.render());}
if(buttons.length)
body.push(createElement2('div',{style:'margin-top: 0.3em'},buttons));UI.setElementContent(content,body);this.field.customValidate=this.customValidate;this.field.onreturn=function(evt){input.handleReturn(evt);return false;}
this.field.setValue(this.value);this.field.validate();this.popup=p;p.show(timeout);this.selecting=true;},handleReturn:function(evt){if(evt)UI.stopEvent(evt);if(this.selecting){this.selecting=false;this.value=this.field.getValue();this.popup.close();UI.callEvent(this,this.onchange);}},handleReset:function(evt){if(this.selecting){this.selecting=false;this.value=null;this.popup.close();if(this.onreset)
UI.callEvent(this,this.onreset);else
UI.callEvent(this,this.onchange,true);}},handleClosePopup:function(){this.popup=null;if(this.selecting){this.selecting=false;UI.callEvent(this,this.oncancel);}},getValue:function(){return this.value;},validate:function(){return true;},destroy:function(){UI.removeNode(this.elt,true);}};UI.HtmlInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;this.onchange=null;this.focused=false;if(params)extendObject(this,params);}
UI.HtmlInput.prototype={setup:function(){if(this.set_up)return;if(!this.elt)
this.elt=$(this.id);if(!this.field&&this.form&&this.name)
this.field=this.form.elements[this.name];var self=this;UI.onInitForm(this.form,function(){self.register();});this.set_up=true;},handleFocus:function(evt,ed){if(!this.focused){this.focused=true;UI.callEvent(this,this.focus,evt,ed);}
this.restorePosition();},handleBlur:function(evt,ed){if(this.focused){this.focused=false;UI.callEvent(this,this.blur,evt,ed);if(ed&&ed.checkDirty())UI.markFormDirty(this);}},handleKeyDown:function(evt,ed){UI.markFormDirty(this);},instanceReady:function(evt,ed){this.ready=true;if(this.autofocus){this.focus();this.autofocus=false;}
this.restoreContent();var p=UI.PopupManager.currentModal();if(p&&p.elt&&this.elt){var chk;for(chk=this.elt;chk.parentNode;chk=chk.parentNode){if(chk===p.elt){p.reposition();break;}}}},focus:function(){if(!this.ready)this.autofocus=1;else{var ed=this.getEditor();if(ed)ed.focus();}},getEditor:function(){if(this.instance)return this.instance;if(this.name)return CKEDITOR.instances[this.name];},insertHtml:function(html){var ed=this.getEditor();if(ed)ed.insertHtml(html);UI.markFormDirty(this);},getValue:function(){var ed=this.getEditor();if(ed)return ed.getData();},setValue:function(val){var ed=this.getEditor();if(ed)ed.setData(val);UI.markFormDirty(this);},updateElement:function(){var ed=this.getEditor();if(ed)ed.updateElement();},saveState:function(){var ed=this.getEditor();ed.focus();if(ed){this.bookmark=ed.getSelection().createBookmarks(true);this.bookmark_html=ed.document.getBody().getHtml();}},restoreContent:function(){var ed=this.getEditor();if(ed&&isset(this.bookmark_html)){ed.document.getBody().setHtml(this.bookmark_html);this.bookmark_html=null;}},restorePosition:function(){var ed=this.getEditor();if(ed&&this.bookmark){ed.getSelection().selectBookmarks(this.bookmark);this.bookmark=null;}},beforeSubmitForm:function(){this.updateElement();},beforeDetachForm:function(){this.saveState();this.updateElement();this.destroy();},beforeRestoreForm:function(){this.register();},register:function(){if(!this.instance&&this.field){CKEDITOR.remove(this.field.name);var cfg=this.ck_config?deep_clone(this.ck_config):{};if(window.CKEDITOR_CONFIG)
cfg.customConfig=window.CKEDITOR_CONFIG;this.instance=CKEDITOR.replace(this.field,cfg);if(this.instance){var self=this;this.instance.on('focus',function(e){self.handleFocus(e,e.editor);});this.instance.on('blur',function(e){self.handleBlur(e,e.editor);});this.instance.on('key',function(e){self.handleKeyDown(e,e.editor);});this.instance.on('instanceReady',function(e){self.instanceReady(e,e.editor);});}}},render:function(){if(!this.field&&this.name){this.field=createElement2('textarea',{name:this.name,value:this.init_value});}
if(!this.elt){this.elt=createElement2('div',{id:this.id},this.field);}
return this.elt;},destroy:function(){var inst=this.getEditor();if(inst)CKEDITOR.remove(inst);this.instance=null;}}
UI.DateTimeInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;this.format='datetime';this.focused=false;this.invalid=false;if(params)extendObject(this,params);};UI.DateTimeInput.prototype={setup:function(){if(this.set_up)return;if(!this.elt)
this.elt=$(this.id);if(!this.elt)return;if(!this.field){if(this.name&&this.form)
this.field=this.form.elements[this.name];else if(this.field_id)
this.field=$(this.field_id);}
if(!this.input){this.input=Wrap(this.elt).findFirst('.datetime-input').get(0);}
if(!this.altInput&&this.alt_name){this.altInput=UI.getFormInput(this.form,this.alt_name);}
this.label_elt=Wrap(this.elt).findFirst('.datetime-label').get(0);UI.CalendarInput.initLanguage();this.loadValue();this.addHooks();this.updateDisplay();if(this.field)this.orig_value=this.field.value;this.set_up=true;},addHooks:function(){if(this.events)return;var self=this;this.events=UI.addEventListeners(this.input,{mousedown:this.handleMouseDown,click:this.handleClick,keydown:this.handleKeyDown,focus:this.handleFocus,blur:this.handleBlur},this);if(this.altInput){this.altInput.onchange=function(){self.handleChanged();}}},showCalendar:function(){var self=this;this.cal_input=new UI.CalendarInput(this.id+'-calendar',{format:this.format,input_field:this,onaccept:function(fdate,date){self.returnDate(fdate,date);},onshow:function(){self.calendarOpened()},onhide:function(){self.calendarClosed()},oncancel:function(){self.focus();}});this.cal_input.setValue(this.getValue(true));this.cal_input.setup();this.cal_input.showPopup();return false;},hideCalendar:function(){if(this.cal_input)this.cal_input.hidePopup();},calendarOpened:function(){this.opened=true;this.updateDisplay();},calendarClosed:function(){this.cal_input=null;this.opened=false;this.updateDisplay();},handleKeyDown:function(evt){if(evt.keyCode==8||evt.keyCode==46){if(!this.disabled)this.clear();UI.stopEvent(evt);}
if(evt.keyCode==27){if(this.opened)this.hideCalendar();else if(!this.isBlank()&&!this.disabled)this.clear();else return;UI.stopEvent(evt);}
if(evt.keyCode==32||evt.keyCode==13){if(!this.opened&&!this.disabled)this.showCalendar();UI.stopEvent(evt);}},handleFocus:function(evt){if(!this.focused){this.focused=true;UI.callEvent(this,this.onfocus,evt);this.updateDisplay();}},handleBlur:function(evt){if(this.focused){this.focused=false;UI.callEvent(this,this.onblur,evt);this.updateDisplay();}},handleMouseDown:function(evt){if(!this.disabled)
evt.stopEvent();},handleClick:function(evt){if(evt.which==1){if(this.opened)
this.hideCalendar();else if(!this.disabled)
this.showCalendar();evt.stopEvent();}},handleChanged:function(evt,silent){v=this.getValue();if(this.orig_value!==v)UI.markFormDirty(this);if(!silent)
UI.callEvent(this,this.onchange,evt,v);this.validate();this.updateDisplay();},returnDate:function(fdate,date){this.setValue(date);this.focus();},clear:function(silent){this.setValue(null,silent);},isBlank:function(){return!trim(this.getValue()).length;},validate:function(){this.invalid=false;if(this.checkAltValue()){}
else if(this.required&&this.isBlank()){this.invalid=true;this.invalidMsg='required';}
else if(this.customValidate)
this.customValidate();this.updateDisplay();return!this.invalid;},focus:function(){if(this.input)this.input.focus();},loadValue:function(){var parsed;if(this.field){if(this.format==='time'){parsed=parseTimeString(this.field.value);}else{parsed=parseDateString(this.field.value);}
this.dateVal=parsed&&parsed.d;}},getValue:function(asNative){if(asNative)return this.dateVal;return this.field?this.field.value:'';},getPrintFormat:function(display){if(this.format==='date')return getDateFormat().print_format;else if(this.format==='time')return getTimeFormat().print_format;else if(this.format==='datetime'){var fmt='{DATE} {TIME}';if(display)fmt=App.language.getListString('relative_time_dom','date_time')||fmt;fmt=fmt.replace('{DATE}',getDateFormat().print_format).replace('{TIME}',getTimeFormat().print_format);return fmt;}},setValue:function(date,silent){if(date instanceof Date){this.dateVal=date;date=date.print(this.getPrintFormat());}
else{var n=parseDateString(date);if(n){this.dateVal=n.d;date=n.display;}else{this.dateVal=null;date='';}}
if(this.field)
this.field.value=date;this.updateDisplay();this.handleChanged(null,silent);},checkAltValue:function(){var v;if(this.altInput&&(v=this.altInput.getValue())){return v;}},updateDisplay:function(){UI.addRemoveClass(this.input,'active',!!(this.focused&&!this.opened));UI.addRemoveClass(this.input,'opened',!!this.opened);UI.addRemoveClass(this.input,'invalid',!!this.invalid);UI.addRemoveClass(this.input,'disabled',!!(this.disabled&&this.disabled!=='readonly'));UI.addRemoveClass(this.input,'readonly',!!(this.disabled==='readonly'));if(this.label_elt){var val=this.getValue(true);if(val)
val=val.print(this.getPrintFormat(true));else
val='';UI.setElementText(this.label_elt,val?val:this.placeholder);UI.addRemoveClass(this.label_elt,'text-placeholder',!val.length&&!this.focused&&!this.opened);}
if(this.altInput)
UI.setDisplayState(this.input,!this.checkAltValue());},setReadOnly:function(flag){this.setDisabled(get_default(flag,true)?'readonly':flag);},setDisabled:function(disabled){if(!isset(disabled))disabled=1;this.disabled=disabled;if(disabled)this.hideCalendar();this.updateDisplay();if(this.disabled&&this.disabled!=='readonly'){if(isset(this.input.tabIndex)){this.tabIndex=this.input.tabIndex;this.input.removeAttribute('tabIndex');}}else if(!isset(this.input.tabIndex)){this.input.tabIndex=this.tabIndex||0;}},render:function(){if(!this.rendered){if(!this.field){this.field=MakeElt('input',{type:'hidden',name:this.name,id:this.field_id||this.id+'-hidden',value:this.init_value}).get();}
var cls='input-field input-field-group rbullet datetime-input';if(this.flat)cls+=' flat';if(this.block)cls+=' input-block';if(this.ext_class)cls+=' '+this.ext_class;var style=(this.no_min_width||this.block)?'':'min-width: 10em';var input=MakeElt('div',{'class':cls,id:this.id+'-input',style:style,tabindex:this.tabIndex||0});this.input=input.get();input.append(MakeElt('div.input-label.input-field-icon.lg').append(MakeElt('div.uii.uii-lg.'+(this.format==='time'?'uii-time':'uii-date'))));if(!this.label_elt)
this.label_elt=MakeElt('span.input-label.datetime-label.text-number').get();input.append(this.label_elt);this.elt=MakeElt('div.input-wrapper'+(this.block?'.input-block':''),{id:this.id}).append(this.field).append(input).get();if(!this.placeholder)
this.placeholder='('+app_string('NTC_NO_ITEMS_DISPLAY')+')';this.rendered=true;}
return this.elt;}};UI.RelativeTimeInput=function(id,params){this.id=id;if(params)extendObject(this,params);};UI.RelativeTimeInput.prototype={setup:function(){if(this.set_up)return;var self=this;this.type_input=UI.getFormInput(this.form,this.name+'_type');this.count_input=UI.getFormInput(this.form,this.name+'_count');this.time_input=UI.getFormInput(this.form,this.name+'_time');if(this.type_input&&this.count_input){this.type_input.onchange=function(k,v){self.updateDisplay();if(k=='days_of'&&!self.count_input.getValue())
self.count_input.focus();else if(self.time_input&&!self.time_input.getValue())
self.time_input.focus();}}
this.updateDisplay();this.set_up=true;},updateDisplay:function(){var k=this.type_input.getValue();if(this.count_input){this.count_input.setDisabled(k=='days_of'?false:true);UI.setDisplayState(this.count_input.elt,!this.count_input.disabled);}
if(this.time_input)
this.time_input.setDisabled(k?false:true);}};UI.CalendarInput=function(id,params){UI.CalendarInput.initLanguage();this.id=id;this.auto_close=true;this.format='date';this.mode='date';if(params)extendObject(this,params);if(this.format==='time')
this.mode='time';}
UI.CalendarInput.initLanguage=function(reload){if(!this.lang_inited||reload){Calendar._DN=app_list_strings('weekdays_long_dom');Calendar._SDN=app_list_strings('weekdays_dom');var mnsl=app_list_strings('months_long_dom');var mns=app_list_strings('months_dom');Calendar._MN=[];Calendar._SMN=[]
for(var i=1;i<=12;i++){Calendar._MN.push(mnsl[i]);Calendar._SMN.push(mns[i]);}
Calendar._TT={SEL_DATE:app_string('LNK_SELECT_DATE'),PREV_YEAR:app_string('LBL_PREVIOUS_YEAR'),PREV_MONTH:app_string('LBL_PREVIOUS_MONTH'),TODAY:app_string('LBL_CALENDAR_TODAY'),GO_TODAY:app_string('LBL_CALENDAR_TODAY'),NEXT_MONTH:app_string('LBL_NEXT_MONTH'),NEXT_YEAR:app_string('LBL_NEXT_YEAR'),WK:app_string('LBL_WEEK_COL_HEADER'),DAY_FIRST:app_string('LBL_CHANGE_FIRST').replace('{NAME}','%s'),PART_TODAY:app_string('LBL_TODAY_SUFFIX')}}}
UI.CalendarInput.prototype={getCalendarOptions:function(){var opts=this.calendar_options?deep_clone(this.calendar_options):{};if(this.date_format)
opts.dateFormat=this.date_format;return opts;},setup:function(){if(this.set_up)return;if(!this.calendar)
this.calendar=new Calendar(this.getCalendarOptions());if(this.attach_target){var attach=$(this.attach_target),self=this;if(attach)attach.onclick=function(evt){self.showPopup();UI.stopEvent(evt);}
if(!this.target)this.target=attach;}
if(!this.input_field){if(this.form&&this.name){this.input_field=UI.getFormInput(this.form,this.name);if(!this.input_field)
this.input_field=this.form.elements[this.name];}}
if(!this.target&&this.input_field){if(this.input_field.elt)
this.target=this.input_field.elt;else if(isNode(this.input_field))
this.target=this.input_field;}
if(!this.search_input){var self=this;this.search_input=new UI.SearchInput(this.id+'-text',{searcher:this,width:200,show_clear:false,onkeydown:function(evt){if(evt&&evt.keyCode===9&&evt.shiftKey){UI.stopEvent(evt);self.cancelSearch();}}});}
this.set_up=true;},getTargetOffset:function(){return this.target_offset||{top:-1};},getDisplayTransform:function(){return this.display_transform||'scaleY(0.4)';},getContentElement:function(){return this.body_elt&&this.body_elt.get();},focus:function(){if(this.search_input)this.search_input.select();this.updateDisplay();},getFormat:function(fmt){if(!fmt)fmt=this.format;if(fmt==='date'){return this.date_format||getDateFormat().print_format;}else if(fmt==='time'){return this.time_format||getTimeFormat().print_format;}else if(fmt==='datetime'){return this.getFormat('date')+' '+this.getFormat('time');}},getValue:function(asNative){var d;if(this.format==='time')
d=this.timeVal;else
d=this.dateVal;if(d&&this.format==='datetime'){if(this.timeVal)
d.setHours(this.timeVal.getHours(),this.timeVal.getMinutes(),0);else
d=null;}
if(asNative)return d;if(!d)return'';var fmt=this.getFormat();return fmt?d.print(fmt):'';},setValue:function(date){if(date instanceof Date){if(this.format==='datetime'||this.format==='date')
this.dateVal=date;if(this.format==='datetime'||this.format==='time')
this.timeVal=date;}},returnStatus:function(stat,is_default){UI.callEvent(this,this.onstatus,stat,is_default);},returnBlank:function(){this.dateVal=null;this.timeVal=null;UI.callEvent(this,this.onaccept,null,null);if(this.auto_close&&this.popup)
this.popup.close();},returnDate:function(fdate,date,accept){this.dateVal=date;if(this.format==='date')
UI.callEvent(this,this.onchange,fdate,date);if(accept)
this.acceptCurrent();else{this.initSearchQuery();this.focus();}},returnTime:function(ftime,date,accept){this.timeVal=date;if(this.format==='datetime'||this.format==='time')
UI.callEvent(this,this.onchange,this.getValue(),this.getValue(true));if(accept)
this.acceptCurrent();else{this.initSearchQuery();this.updateDisplay();}},renderCalendar:function(){if(!this.rendered_cal){var self=this;this.calendar.hide_status=this.hide_status;this.calendar.onstatus=function(cal,stat,def){self.returnStatus(stat,def);}
this.calendar.onselect=function(cal,fdate,date){self.returnDate(fdate,date);}
this.calendar.onchange=function(cal,fdate,date){self.returnDate(fdate,date,true);}
if(this.dateVal)
this.calendar.setDate(this.dateVal);if(!this.calendar.getElement())
this.calendar.render();this.rendered_cal=true;}
return this.calendar.getElement();},renderTimeEditor:function(){if(!this.rendered_time){var editor=new UI.TimeEditor();editor.onchange=this.returnTime.bind(this);if(this.timeVal)
editor.setValue(this.timeVal,true);editor.render();editor.setup();this.time_editor=editor;this.rendered_time=true;}
return this.time_editor.getElement();},render:function(){if(!this.rendered){var search_row=MakeElt('div.tools-row.popup-search').append(this.search_input.render()).append(MakeElt('div.spacer')),return_label=MakeElt('span'),return_link=MakeElt('a.tools-link',{href:'#'}).append(MakeElt('span.uii.uii-previous')).append(nbsp()).append(return_label).on('click:stop:prevent',function(){this.setMode('date');},{scope:this}),return_row=MakeElt('div.card-header.panel-subheader:hidden').append(MakeElt('div.tools-row.popup-title',null,return_link)),head=MakeElt('div.card-header.panel-header').append(search_row),body=MakeElt('div.card-body.panel-body');this.return_label=return_label;this.return_row=return_row;if(this.mode==='date')
body.append(this.renderCalendar());else if(this.mode==='time')
body.append(this.renderTimeEditor());this.body_elt=body;this.clear_button=MakeElt('div.uii.uii-lg.uii-remove.active-icon',{tabindex:0}).appendTo(search_row).on('click, keydown[key=enter|space]',function(evt){this.returnBlank();this.hidePopup();},{stop:true,prevent:true,scope:this});this.time_button=MakeElt('div.uii.uii-lg.uii-time.active-icon:hidden',{tabindex:0}).appendTo(search_row).on('click, keydown[key=enter|space]',function(evt){if(this.dateVal)this.setMode('time');},{stop:true,prevent:true,scope:this});this.accept_button=MakeElt('div.uii.uii-lg.uii-accept.active-icon:hidden',{tabindex:0}).appendTo(search_row).on('click, keydown[key=enter|space]',function(evt){this.acceptCurrent(evt);},{stop:true,prevent:true,scope:this});var content=MakeElt('div.card-outer.panel-outer.panel-default',null,[head,return_row,body]);this.search_input.setup();this.elt=content.get();this.rendered=true;this.updateDisplay();}
return this.elt;},updateDisplay:function(){var show_time=this.format==='datetime'&&this.mode==='date',show_accept=this.format==='date'||this.format==='time'||(this.format==='datetime'&&this.mode==='time');this.time_button.toggle(show_time);this.time_button.toggleClass('disabled',!this.dateVal);this.accept_button.toggle(show_accept);this.accept_button.toggleClass('disabled',(this.format!=='time'&&!this.dateVal)||(this.mode==='time'&&!this.timeVal));if(this.mode==='time'&&this.format==='datetime'&&this.dateVal){var pfx=App.language.getListString('date_filter_operators_dom','on_date')||'';this.return_label.text(pfx+' '+this.dateVal.print(getDateFormat().print_format));this.return_row.show();}else{this.return_row.hide();}
if(this.mode==='time')
this.time_editor.updateDisplay();else
this.calendar.clearHighlight();},clearSearch:function(){if(this.search_input)this.search_input.clear();},setQuery:function(q){if(this.mode==='date'){var parsed=parseDateString(q);if(parsed)
this.dateVal=parsed.d;else
this.dateVal=null;this.calendar.setDate(this.dateVal);this.updateDisplay();}
else if(this.mode==='time'){var parsed=parseTimeString(q);if(parsed)
this.timeVal=parsed.d;else
this.timeVal=null;this.time_editor.setValue(this.timeVal,true);this.updateDisplay();}},adjustCurrentIndex:function(offs,nowrap,evt){if(offs){if(this.mode==='date'){var type='day';if(evt&&evt.shiftKey)type='month';else if(evt&&(evt.ctrlKey||evt.cmdKey))type='week';this.calendar.nav(-offs,type);}
else if(this.mode==='time'){var type='hour';if(evt&&evt.shiftKey)type='minute';else if(evt&&(evt.ctrlKey||evt.cmdKey))type='meridiem';this.time_editor.adjustPartIndex(type,-offs);}}},showDefault:function(){},acceptCurrent:function(evt){if(this.format==='datetime'){if(this.mode==='date'){this.setMode('time');return false;}}
var fval=this.getValue(),val;if(!fval)return false;val=this.getValue(true);UI.callEvent(this,this.onaccept,fval,val,evt);if(this.auto_close&&this.popup)
this.popup.close();return false;},cancelSearch:function(){this.hidePopup();UI.callEvent(this,this.oncancel);},initSearchQuery:function(){var q='';if(this.mode==='date')
q=this.dateVal?this.dateVal.print(getDateFormat().print_format):'';else if(this.mode==='time')
q=this.timeVal?this.timeVal.print(getTimeFormat().print_format):'';if(this.search_input)
this.search_input.setValue(q,true);},setMode:function(mode){this.mode=mode;if(this.mode==='time'){this.body_elt.content(this.renderTimeEditor());if(this.timeVal)
this.time_editor.setValue(this.timeVal,true);}else{this.body_elt.content(this.renderCalendar());}
this.initSearchQuery();this.updateDisplay();this.search_input.select();},showPopup:function(){if(!this.popup){var self=this,cal=this.calendar;this.popup=new UI.PopupSlidePanel(this.id+'popup',{content_elt:this.render(),container:this.container,target:this.target||this.inputField,target_offset:this.getTargetOffset(),tabIndex:1,destroy_on_close:true,customDisplayTransform:this.getDisplayTransform()});if(this.attach_target)this.popup.target_active_class='active opened';this.initSearchQuery();this.popup.setWidth(this.width||300);this.popup.keyDown=function(evt){return cal.keyDown(evt);}
this.popup.onshow=function(){self.visible=true;UI.callEvent(self,self.onshow);self.search_input.select();}
this.popup.onhide=function(){self.visible=false;UI.callEvent(self,self.onhide);}}
this.popup.render();this.popup.show();this.updateDisplay();},hidePopup:function(){if(this.popup)this.popup.close();}};UI.WheelThrottle=function(delay,max_steps,delta_cap){this.delay=delay||200;this.max_steps=max_steps||3;this.delta_cap=delta_cap||20;}
UI.WheelThrottle.prototype={adjustEvent:function(evt){var now=performance.now();evt.deltaX=this.adjustDelta(evt.deltaX);evt.deltaY=this.adjustDelta(evt.deltaY);evt.deltaZ=this.adjustDelta(evt.deltaZ);if(this.lastEvent&&this.delay&&now-this.lastEvent<this.delay){evt.wheelSkip=true;}else
this.lastEvent=now;},adjustDelta:function(delta){var ds;if(!delta)return 0;if(Math.abs(delta)>this.delta_cap)
delta=this.delta_cap*Math.sign(delta);ds=Math.round(this.max_steps*delta/this.delta_cap);if(delta&&!ds)ds=Math.sign(delta);return ds;}};UI.TimeEditor=function(){this.part_height=36;this.part_gap=10;this.show_meridiem=getTimeFormat().meridiem;this.wheelThrottle=new UI.WheelThrottle();}
UI.TimeEditor.prototype={getElement:function(){if(this.elt)return this.elt.get();},setup:function(){var hr_labels,pad=function(val){val=''+val;if(val.length==1)val='0'+val;return val;};this.hour_options={values:Array.range(24),looped:true};this.minute_options={values:Array.range(60),looped:true};this.meridiem_options={values:['am','pm'],labels:['AM','PM']};if(this.show_meridiem){hr_labels=[12];hr_labels.pushArray(Array.range(1,13));hr_labels.pushArray(Array.range(1,12));}
else{hr_labels=this.hour_options.values.map(pad);}
this.hour_options.labels=hr_labels;this.minute_options.labels=this.minute_options.values.map(pad);if(this.init_value)
this.setIndexes(this.init_value);},render:function(){if(!this.rendered){this.elt=MakeElt('div.row.time-edit-outer');this.renderPart('hour');this.renderPart('minute');if(this.show_meridiem)
this.renderPart('meridiem');this.rendered_time=true;this.updateDisplay();}
return this.elt;},renderPart:function(name){var elt=MakeElt('div.column.time-edit-part.'+name+'-part').appendTo(this.elt).on('wheel',{part_name:name},this.handleWheel,{scope:this}).on('click',{part_name:name},this.handleClick,{scope:this});this[name+'_part']=elt;this[name+'_window']=MakeElt('div.time-edit-window').appendTo(elt);this.makeDragTarget(elt,name);},handleClick:function(evt){evt.stopEvent();var name=evt.data.part_name,bounds=this[name+'_part'].bounds(),offs;if(evt.pageY<bounds.y+bounds.height/3){offs=-1;}
else if(evt.pageY>bounds.y+bounds.height*2/3){offs=1;}
if(offs)
this.adjustPartIndex(name,offs);},updateDisplay:function(){this.updateDisplayPart('hour');this.updateDisplayPart('minute');if(this.show_meridiem)
this.updateDisplayPart('meridiem');},getPartOptions:function(name){return this[name+'_options'];},getPartScroll:function(name){return this[name+'_scroll']||0;},getPartIndex:function(name){return this[name+'_index']||0;},getPartFocus:function(name){var current=this.getPartIndex(name),hgt=this.part_height,gap=this.part_gap,full=hgt+gap,voffs=this.getPartScroll(name),vidx=voffs/full,top=hgt*0.5-gap;vidx=-(vidx<0?Math.ceil(vidx):Math.floor(vidx));voffs+=vidx*full;while(voffs>top){voffs-=full;vidx--;}
while(voffs+full<=top){voffs+=full;vidx++;}
return{index:current+vidx,voffs:voffs};},getPartScrollIndex:function(name,index){var hgt=this.part_height,gap=this.part_gap,full=hgt+gap;return full*-index;},fixOptionsOffset:function(opts,offs,inrange){if(!opts||!opts.values.length||!isset(offs))return null;if(opts.looped){return modulo(offs,opts.values.length);}else{if(inrange){if(offs<0)return 0;if(offs>=opts.values.length)return opts.values.length-1;}else if(offs<0||offs>=opts.values.length)return null;return offs||0;}},updateDisplayPart:function(name){if(!this.label_elts)this.label_elts={};if(!this.label_elts[name])this.label_elts[name]=[];var lbls=this.label_elts[name],elt=this[name+'_part'],vwindow=elt.findFirst('.time-edit-window'),options=this.getPartOptions(name),focus=this.getPartFocus(name),hgt=this.part_height,gap=this.part_gap,full=hgt+gap,top=focus.voffs+hgt-gap/2,vidx=focus.index,fidx,current=this.fixOptionsOffset(options,vidx),lidx=0;elt.cssSize('height',hgt*3);vwindow.cssSize('height',hgt).cssSize('top',hgt);while(top+full>0){vidx--;top-=full;}
while(top<hgt*3){fidx=this.fixOptionsOffset(options,vidx);if(fidx!==null){if(lidx===lbls.length)lbls[lidx]=MakeElt('div.time-edit-label').appendTo(elt);lbls[lidx].text(options.labels[fidx]).cssSize('font-size',hgt*0.4).cssSize('height',full).cssSize('line-height',full).cssSize('top',top).toggleClass('current',current===fidx).show();lidx++;}
top+=full;vidx++;}
for(lidx;lidx<lbls.length;lidx++)
lbls[lidx].hide();},setPartIndex:function(name,index,evt,silent){var options=this.getPartOptions(name),old_index=this.getPartIndex(name),index=this.fixOptionsOffset(options,index,true),scroll_pos=this.getPartScroll(name),pos1=this.getPartScrollIndex(name,old_index),pos2=this.getPartScrollIndex(name,index),diff=pos1-pos2,total_h;if(name==='meridiem'&&diff){var hr=this.hour_index;if(index&&hr<12)hr+=12;else if(!index&&hr>=12)hr-=12;this.hour_index=hr;}
this[name+'_index']=index;if(name==='hour'&&diff&&this.show_meridiem){if(index>=12)this.setPartIndex('meridiem',1,evt,true);else this.setPartIndex('meridiem',0,evt,true);}
if(options&&options.looped){total_h=options.values.length*(this.part_height+this.part_gap);if(Math.abs(diff)>total_h/2){if(diff>0)
diff-=total_h;else
diff+=total_h;}}
this[name+'_scroll']=diff+scroll_pos;this.nextStepScroll(name,true);if(!silent)
this.handleChanged(evt);},adjustPartIndex:function(name,offset,evt,silent){this.setPartIndex(name,this.getPartIndex(name)+offset,evt,silent);},getValue:function(nativeDate){var hr=this.hour_index,min=this.minute_index,merid=this.meridiem_index||0;if(!isset(hr)||!isset(min))return null;var dt=new Date();dt.setHours(hr,min);if(nativeDate)return dt;return dt.print(getTimeFormat().print_format);},setIndexes:function(val){var hrs=val.getHours(),mins=val.getMinutes(),merid=0;if(hrs>=12)
merid=1;this.setPartIndex('hour',hrs,null,true);this.setPartIndex('minute',mins,null,true);this.setPartIndex('meridiem',merid,null,true);},setValue:function(val,quiet){if(typeof(val)==='string'){var parsed=parseTimeString(val);if(parsed)
val=parsed.d;}
if(val instanceof Date){this.setIndexes(val);if(!quiet)
this.handleChanged();this.init_value=val;}},handleChanged:function(evt){if(!this.meridiem_index)this.meridiem_index=0;if(!this.hour_index)this.hour_index=0;if(!this.minute_index)this.minute_index=0;UI.callEvent(this,this.onchange,this.getValue(),this.getValue(true));},handleWheel:function(evt){if(!evt.data)return;this.wheelThrottle.adjustEvent(evt);var delta=evt.deltaY,part_name=evt.data.part_name;if(!evt.wheelSkip){while(this.adjustPartIndex(part_name,delta,evt)===false&&delta){delta-=Math.sign(delta);}}
UI.stopEvent(evt);},nextStepScroll:function(name,initial){var self=this,focus,index,pos1,pos2;if(this[name+'_scroll_req']){cancelAnimationFrame(this[name+'_scroll_req']);this[name+'_scroll_req']=null;}
if(name){if(initial){this[name+'_scroll_start']=this.getPartScroll(name);this[name+'_scroll_time']=performance.now();}
this[name+'_scroll_req']=requestAnimationFrame(
function(time){self.stepScroll(name,time);});}},stepScroll:function(name,time){var pos=this[name+'_scroll_start'],start=this[name+'_scroll_time'],next;if(pos){next=pos*(1-Math.min(1,(time-start)/150));this[name+'_scroll']=next;this.updateDisplayPart(name);if(next)this.nextStepScroll(name);}},ondragstart:function(evt,info){info.scroll_start=this.getPartScroll(info.tag);this.nextStepScroll(false);},ondrag:function(evt,info){var pos=info.scroll_start+info.dragY;this[info.tag+'_scroll']=pos;this.updateDisplayPart(info.tag);},ondragend:function(evt,info){if(info.canceled){this[info.tag+'_scroll']=info.scroll_start;this.updateDisplayPart(info.tag);return;}
var focus=this.getPartFocus(info.tag);if(focus){this.setPartIndex(info.tag,focus.index,evt);}}};extendProto(UI.TimeEditor,UI.DragHandler);UI.DurationInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;this.time_id=this.id+'-time';this.onchange=null;this.focused=false;this.invalid=false;if(params)extendObject(this,params);};UI.DurationInput.prototype={setup:function(){if(this.set_up)return;if(!this.field){if(this.elt)
this.field=this.elt;else if(this.name&&this.form)
this.field=this.form.elements[this.name];else if(this.field_id)
this.field=$(this.field_id);else if(this.id)
this.field=$(this.id);}
if(!this.time_field){this.time_field=$(this.time_id);}
if(!this.all_day_field&&this.all_day_name){this.all_day_field=UI.getFormInput(this.form,this.all_day_name);}
if(!this.elt)
this.elt=this.field;if(this.field)this.orig_value=this.field.value;this.addHooks();this.updateDisplay();this.set_up=true;},addHooks:function(){var input=this;if(this.time_field){this.time_field.onfocus=function(evt){return input.handleFocus(evt||window.event);}
this.time_field.onblur=function(evt){return input.handleBlur(evt||window.event);}
this.time_field.onkeydown=function(evt){input.fieldKeyDown(evt||window.event);}
this.time_field.onchange=function(evt){return input.handleChanged(evt||window.event);}}
if(this.all_day_field){this.all_day_field.onchange=function(evt,val){return input.handleAllDay(evt,val);}}},fieldKeyDown:function(evt){if(evt.keyCode==27){this.clear();UI.stopEvent(evt);}},handleFocus:function(evt){if(!this.focused){this.focused=true;UI.callEvent(this,this.onfocus,evt);}},handleBlur:function(evt){if(this.focused){this.focused=false;UI.callEvent(this,this.onblur,evt);}},handleAllDay:function(evt,val){this.handleChanged(evt);if(!val)
this.focus();},handleChanged:function(evt){var v,result;if(this.field&&this.time_field){var all_day=this.getAllDay();if(all_day)
this.field.value=this.time_field.value='';else{result=this.format();if(result){this.field.value=result.total_minutes;this.time_field.value=result.hours+this.hours_abbrev+' '+result.minutes+this.mins_abbrev;}else{this.field.value=this.time_field.value='';}}}
v=this.getValue();if(this.orig_value!==v)UI.markFormDirty(this);UI.callEvent(this,this.onchange,evt,v);this.validate();},setValue:function(value,silent,evt){var hrs,mins;if(!isset(value)||value===''){if(this.time_field)
this.time_field.value='';}else{value=Math.round(parseFloat(value));if(isNaN(value)||value<0)value=0;if(this.time_field){hrs=Math.floor(value/60);mins=value-hrs*60;this.time_field.value=hrs+this.hours_abbrev+' '+mins+this.mins_abbrev;}}
if(this.field)this.field.value=value;if(this.orig_value!==''+value)UI.markFormDirty(this);this.validate();if(!silent)
UI.callEvent(this,this.onchange,evt,value);},clear:function(){if(this.field)this.field.value='';if(this.time_field)this.time_field.value='';},format:function(){var hr,min,temp,val=trim(this.getDisplayValue()),pos=-1,pat=new RegExp(
'(.*?)\\s*(:|'+RegExp.escape(this.hours_abbrev)+
'|'+RegExp.escape(this.mins_abbrev)+')\\s*(.*)'),m=val.match(pat);if(!val.length)return null;if(m){temp=parseFloat(stdUnformatNumber(m[1]));if(m[2]==':'||m[2]==this.hours_abbrev){hr=temp;min=parseFloat(stdUnformatNumber(m[3]));}else
min=temp;}else{temp=parseFloat(stdUnformatNumber(val));if(!val.match(/^\d+$/)||(temp>0&&temp<10))
hr=temp;else
min=temp;}
if(isNaN(hr)||hr<0)hr=0;if(isNaN(min)||min<0)min=0;else min=Math.round(min);var hr_floor=Math.floor(hr);min+=Math.round((hr-hr_floor)*60);hr=hr_floor;if(min>=60){hr+=Math.floor(min/60);min=min%60;}
var total_min=hr*60+min;min=(min<10)?'0'+min:min;var inp={hours:hr,minutes:min,total_minutes:total_min};return inp;},isBlank:function(){var v=this.getValue(true);return!isset(v)||v==0;},validate:function(){this.invalid=false;var all_day=this.getAllDay();if(!all_day&&this.required&&this.isBlank()){this.invalid=true;this.invalidMsg='required';}
else if(this.customValidate)
this.customValidate();this.updateDisplay();return!this.invalid;},focus:function(){if(this.getAllDay())
this.all_day_field.focus();else if(this.time_field){this.time_field.focus();this.time_field.select();}},getValue:function(nativeVal){var ret=this.field?this.field.value:'';if(nativeVal){ret=(ret==='')?null:parseFloat(ret||0);}
return ret;},getDisplayValue:function(){return this.time_field?this.time_field.value:'';},getAllDay:function(){return this.all_day_field&&this.all_day_field.getValue();},updateDisplay:function(){UI.addRemoveClass(this.time_field,'invalid',this.invalid);if(this.time_field)
this.time_field.disabled=(this.all_day_field&&this.all_day_field.getValue());}};UI.DateRangeInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;this.focused=false;if(params)extendObject(this,params);}
UI.DateRangeInput.prototype={setup:function(){if(this.set_up)return;if(!this.elt)
this.elt=$(this.id);var basename=this.name||'';if(this.form&&basename){if(!this.field)
this.field=this.form.elements[basename];}
if(!this.elt)return;UI.CalendarInput.initLanguage();this.label_elt=this.elt.firstChild;if(!isset(this.elt.tabIndex)||this.elt.tabIndex<0)this.elt.tabIndex=0;this.addHooks();if(this.compat)this.updateLabelCompat();this.updateDisplay();this.set_up=true;},reset:function(){this.stage='';this.from_mode=this.to_mode=this.result=this.from_op=null;},showPopup:function(){this.popup_count=(this.popup_count||0)+1;var input=this,w=Math.max(275,this.elt.offsetWidth),p=new UI.PopupSlidePanel(this.id+'-popup'+this.popup_count,{width:w,target:this.elt,target_offset:{top:-1}});p.onshow=function(){input.opened=true;input.updateDisplay();}
p.onhide=function(){input.popup=null;input.opened=false;input.updateDisplay();}
p.render();this.popup=p;this.renderPopupContent();p.show();},hidePopup:function(){if(this.popup)this.popup.hide();},focus:function(){if(this.elt)this.elt.focus();},addHooks:function(){UI.addEventListener(this.elt,'focus',this.handleFocus,this);UI.addEventListener(this.elt,'blur',this.handleBlur,this);UI.addEventListener(this.elt,'click',this.handleClick,this);UI.addEventListener(this.elt,'keypress',this.handleKeyPress,this);},handleFocus:function(){this.focused=true;this.updateDisplay();},handleBlur:function(){this.focused=false;this.updateDisplay();},handleKeyPress:function(evt){if(evt.charCode==32){UI.preventDefault(evt);this.handleClick();}},handleClick:function(evt){if(this.loading||this.disabled)return;if(this.opened)this.hidePopup();else{this.reset();this.showPopup();}
evt.stopEvent();},checkSubmit:function(op_changed){if(this.auto_submit){if(op_changed){var ptype=this.getOperatorParamType();if(ptype=='date'&&!this.date_field.getValue())return;else if(ptype=='period'&&!this.period_field.getValue())return;}
UI.submitForm(this.form);}},getLabels:function(){if(!this.opt_labels){var dom=App.language.getList('date_range_operators_dom'),i,v,rdom=App.language.getList('relative_time_dom'),copy_rel=['today','tomorrow','yesterday','now'],nodots=['any','empty','not_empty','plus','minus','previous','next'],lbls={'done':app_string('LBL_DONE_BUTTON_LABEL')};if(this.compat){nodots.remove('previous');nodots.remove('next');}
if(rdom){for(i=0;i<rdom.keys.length;i++){if(copy_rel.indexOf(rdom.keys[i])>=0)
lbls[rdom.keys[i]]=rdom.values[i];}}
if(dom){for(i=0;i<dom.keys.length;i++){v=dom.values[i];if(nodots.indexOf(dom.keys[i])<0&&copy_rel.indexOf(dom.keys[i])<0)v+='…';lbls[dom.keys[i]]=v;}}
this.opt_labels=lbls;}
return this.opt_labels;},getPeriods:function(sing){var opts={keys:['day','week','month','quarter','year','fiscalquarter','fiscalyear'],values:[],add_blank:false},i=0,k,p,dom=App.language.getList(sing?'interval_unit_dom':'interval_units_dom');if(this.compat)
opts.keys.pushArray(['days_7','days_14','days_30','days_60','days_90','days_180']);if(dom)for(;i<opts.keys.length;i++){k=opts.keys[i];if(k.substring(0,5)=='days_'){opts.values[i]=k.substring(5)+' '+App.language.getListString('interval_units_dom','days');}else{p=dom.keys.indexOf(k+'s');opts.values[i]=(p>=0)?dom.values[p]:k;}}
return opts;},getWithinTypes:function(){var opts={values:[],add_blank:false},i=0,ls=this.getLabels();if(this.stage=='offset_custom')
opts.keys=['plus','minus'];else
opts.keys=['','next','previous'];for(;i<opts.keys.length;i++)
opts.values[i]=ls[opts.keys[i]||'range'];return opts;},getPopupTitle:function(){var label=null,lbls=this.getLabels();if(this.show_field_name)
label=this.label;if(this.stage&&lbls[this.stage])
label=lbls[this.stage];if(this.to_mode&&lbls[this.to_mode])
label=lbls[this.to_mode];else if(this.from_mode&&lbls[this.from_mode])
label=lbls[this.from_mode];return label;},getBackButton:function(){var back,s=this.stage,input=this;if(s=='to_opts'||(this.from_op&&s!='from_opts'))
back='from_opts';else if(s)
back='';if(isset(back)){if(!this.back_button){this.back_button=MakeElt('a.tools-link',{href:'#',style:'margin-right: 8px'},[MakeElt('span.uii.uii-previous'),nbsp(),app_string('LBL_BACK')]);}
this.back_button.on('click',function(){input.goBack(back);return false;});return this.back_button;}},renderPopupContent:function(){if(!this.popup)return;var title_row=MakeElt('div.tools-row.popup-title'),title=MakeElt('div.card-header.panel-subheader').append(title_row),title_text=this.getPopupTitle(),opts=this.getMenuOptions(),stat=this.renderStatus(),btn=this.getBackButton(),content=Wrap(this.popup.elt);UI.clearChildNodes(content);if(btn)title_row.prepend(btn);if(title_text){title_row.append(MakeElt('span.text-right').text(title_text));title.appendTo(content);}
if(this.stage=='from'||this.stage=='to'){content.append(this.renderCalendar());this.cal_input.focus();}
if(this.stage=='from_field'||this.stage=='to_field'){content.append(this.renderFieldList());}
if(stat)
content.append(stat);if(this.stage=='within'||this.stage=='offset_custom'){content.append(this.renderWithin());this.within_inp.focus();}
if(opts)
content.append(this.renderMenu(opts,this.getMenuSelected()));return content.get();},renderStatus:function(){if(!this.result||(this.stage!='from_opts'&&this.stage!='to_opts'&&this.stage!='within'))return;var stat=this.getStatusElt().text(this.result.text).show(),outer=MakeElt('div.card-header.panel-subheader').append(stat);return outer;},getMenuOptions:function(){var keys,lbls=this.getLabels(),dom;if(!this.stage){if(this.compat){keys=[
'any','before','after','date','not_date','between','empty','not_empty','yesterday','today','tomorrow','previous','current','next'];}
else{keys=[
'any','from','from_field','before','after','empty','not_empty','offset','within','current','month'
];}}
else if(this.stage=='before'||this.stage=='after')
keys=['from','from_field','today','start','end','offset_custom'];else if(this.stage=='offset'||this.stage=='to_offset')
keys=['start','end','offset_custom'];else if(this.stage=='start'||this.stage=='end'||this.stage=='current'||this.stage=='previous'||this.stage=='next')return this.getPeriods(true);else if(this.stage=='month'){keys=[];lbls=[];dom=App.language.getList('months_long_dom');for(i=1;i<=12;i++){keys.push(i);lbls.push(dom.values[i]);}}
else if(this.stage=='from_opts'){keys=['done','to','to_field','to_start','to_end','within','to_offset_custom'];if(this.from_mode)keys.remove('within');}
else if(this.stage=='to_opts'){keys=['done'];}
if(keys)return{keys:keys,values:lbls};},getMenuSelected:function(){var filter=this.filter||{operator:'any'},sel;if(!this.stage){sel=filter.operator;if(filter.negate)sel='not_'+sel;}
return sel;},renderMenu:function(options,key){var input=this,outer=MakeElt('div.card-outer.card-body.popup-body.filter-options');if(!this.menu){this.menu=new UI.SelectList(this.id+'-menu',{no_scroll:true,flat:true,blank_key:'any',require_focus:false});this.menu.render();this.menu.setup();this.menu.onchange=function(){input.returnMenu(this.getSelectedKey());}}
this.menu.setOptions(options);this.menu.setSelectedKey(key,true);this.menu.setCurrentIndex(null);outer.append(this.menu.elt);return outer;},renderCalendar:function(){var input=this;if(!this.cal_input){this.cal_input=new UI.CalendarInput(this.id+'-calendar',{format:'date'});this.cal_input.onaccept=function(fdate,date){input.returnDate(fdate,date);};this.cal_input.setup();this.cal_input.render();}
if(this.stage=='from')
this.cal_input.setValue(this.from_date);else if(this.stage=='to')
this.cal_input.setValue(this.to_date?this.to_date:this.from_date);else
this.cal_input.setValue(null);this.cal_input.initSearchQuery();this.cal_input.updateDisplay();return this.cal_input.render();},getStatusElt:function(){if(!this.status_elt)
this.status_elt=MakeElt('span.input-label.status-label');return this.status_elt;},renderFieldList:function(){var outer=MakeElt('div.card-outer.card-body.popup-body.filter-options'),input=this;if(!this.field_sel){this.field_sel=new UI.SelectList(this.id+'field',{options:this.fields_list,flat:true,no_scroll:true,show_checks:true,require_focus:false});this.field_sel.render();this.field_sel.setup();this.field_sel.onchange=function(){input.returnField(this.getSelectedKey());}}
this.field_sel.setSelectedKey(this.stage=='from_field'?this.from_field:this.to_field,true);this.field_sel.setCurrentIndex(null);outer.append(this.field_sel.elt);return outer;},renderWithin:function(){var input=this,outer=MakeElt('div.card-body.panel-body.panel-pad-body'),tout=MakeElt('div',{style:'margin-bottom: 5px'});if(!this.within_inp){this.within_type=new UI.SelectInput(this.id+'wtype',{options:this.getWithinTypes(),show_stacked:true,mark_blank:false});this.within_type.setup();this.within_type.render();this.within_inp=new UI.TextInput(this.id+'within',{format:'int',restrict_positive:true,size:5,init_value:2});this.within_inp.onreturn=function(){input.returnWithin();}
this.within_inp.setup();this.within_inp.render();this.within_sel=new UI.SelectInput(this.id+'period',{options:this.getPeriods(),init_value:'week',show_stacked:true});this.within_sel.setup();this.within_sel.render();this.within_ok=new UI.ButtonInput(this.id+'within-ok',{icon:'icon-accept',label:app_string('LBL_DONE_BUTTON_LABEL')});this.within_ok.onclick=function(){input.returnWithin();}
this.within_ok.setup();this.within_ok.render();}
this.within_type.setValue(this.stage=='offset_custom'?'plus':'',true);tout.append(this.within_type.elt);outer.append([tout,this.within_inp.field,nbsp(),this.within_sel.elt,nbsp(),this.within_ok.elt]);return outer;},showCalendarStatus:function(status,def){if(this.stage!='from'&&this.stage!='to')return;def=!!def;toggleDisplay(this.date_input.elt,def);toggleDisplay(this.status_elt,!def);UI.setElementText(this.status_elt,status);},returnMenu:function(key){var op,next;if(key=='not_empty'){op={operator:'empty',negate:true};}else if(key=='op'||key=='empty'||key=='any'){op={operator:key};}else if(key=='date'||key=='not_date'||key=='between'){this.from_mode=key;this.changeStage('from');}else if(key=='previous'||key=='next'){this.changeStage(key);}else if(this.stage=='start'||this.stage=='end'||this.stage=='current'||this.stage=='previous'||this.stage=='next'){if(this.stage=='current'&&key=='day')
op={operator:'special',value:'today'};else
op={operator:this.stage,period:key};if(op.period&&op.period.substring(0,5)=='days_'){op.count=parseInt(op.period.substring(5),10);op.period='day';}
if(this.from_op)
op={operator:'range',start:this.from_op,end:op};else if(this.from_mode)
op={operator:this.from_mode,value:op};else if((this.stage!='current'||key=='day')&&!this.compat){this.from_op=op;next='from_opts';}}else if(key=='from'||key=='to'||key=='from_opts'||key=='to_opts'
||key=='month'||key=='year'||key=='offset'||key=='within'
||key=='start'||key=='end'||key=='current'||key=='offset_custom'){this.changeStage(key);}else if(key=='to_start'||key=='to_end'||key=='to_offset_custom'){this.changeStage(key.substring(3));if(key=='to_offset_custom')this.to_mode=true;}else if(key=='from_field'||key=='to_field'){this.fetchFieldList(key);}else if(key=='before'||key=='after'){if(this.from_op)
this.to_mode=key;else
this.from_mode=key;if(this.compat)
this.changeStage('from');else
this.changeStage(key);}else if(this.stage=='month'&&key){op={operator:'month',value:key};}else if(key=='today'||key=='tomorrow'||key=='yesterday'){op={operator:'special',value:key};if(this.compat);else if(this.from_op)
op={operator:'range',start:this.from_op,end:op};else if(this.from_mode)
op={operator:this.from_mode,value:op};else{this.from_op=op;next='from_opts';}}else if(key=='done')
this.hidePopup();if(op)
this.updateFilter(op,next);},returnDate:function(fdate,date){var op={operator:'date',value:date.print('%Y-%m-%d')},next;if(this.stage=='from'){this.from_date=date;next=this.from_mode?null:'from_opts';if(this.from_mode==='date'||this.from_mode==='not_date')
this.from_op={operator:this.from_mode,value:op.value};else if(this.from_mode==='between'){this.from_op={operator:'date',value:op.value};next='to';}
else
this.from_op=this.from_mode?{operator:this.from_mode,value:op}:op;if(date)this.updateFilter(this.from_op,next);}
else if(this.stage=='to'){this.to_date=date;if(date)this.updateFilter({operator:'range','start':this.from_op,'end':op});}
if(this.date_input)
this.date_input.setValue(date,true);},returnField:function(field){var op={operator:'field',value:field},next;if(this.stage=='from_field'){this.from_field=field;this.from_op=this.from_mode?{operator:this.from_mode,value:op}:op;next=this.from_mode?null:'from_opts';this.updateFilter(this.from_op,next);}
else if(this.stage=='to_field'){this.to_field=field;this.updateFilter({operator:'range','start':this.from_op,'end':op});}},returnWithin:function(){var count=this.within_inp.getValue(true),period=this.within_sel.getValue(),type=this.within_type.getValue(),offs=(this.stage=='offset_custom'),op={operator:offs?'offset':(type?type:'within'),count:count,period:period,value:this.from_op};if(offs&&count&&period){if(type=='minus')op.count=-op.count;if(this.to_mode){op.value=this.to_op;op={operator:'range',start:this.from_op,end:op};this.updateFilter(op);}else{if(this.from_mode)op={operator:this.from_mode,value:op};this.from_op=op;this.updateFilter(op,this.from_mode?null:'from_opts');}}
else if(count&&period)
this.updateFilter(op);},updateFilter:function(filter,stage){var input=this,params,req;this.hidePopup();if(!stage)this.focus();this.setLoading(true);this.do_confirm=!!stage;this.stage=stage;this.filter=filter;params={context:this.context,filter:filter,bean_name:this.bean_name,field_name:this.base_name||this.name};req=new App.conn.JSONRequest('compact_date_filter',{status_msg:null},params);req.fetch(function(result){var data=result.getResult();input.returnCompact(data);});},fetchFieldList:function(stage){var input=this,params,req;if(this.fields_list)return this.changeStage(stage);this.stage=stage;this.hidePopup();this.setLoading(true);params={module:this.module,model:this.bean_name,form_name:this.form_name,link_name:'',link_alias:'',context:this.context};req=new App.conn.JSONRequest('get_list_fields',{status_msg:null},params);req.fetch(function(result){var data=result.getResult();input.returnFieldList(data);});},setLoading:function(state){state=!!state;this.loading=state;toggleDisplay(this.label_elt,!state);if(state&&!this.wait_icon){this.wait_icon=App.util.waitIcon();this.elt.appendChild(this.wait_icon);}
toggleDisplay(this.wait_icon,state);},changeStage:function(stage){this.stage=stage;if(this.popup){this.renderPopupContent();this.popup.reposition();}},goBack:function(to){if(!to)this.reset();this.changeStage(to);},returnCompact:function(data){this.setLoading(false);if(!data||!data.result){console.error('Error parsing date range',data);this.invalid=true;this.updateDisplay();return;}
this.result=data.result;this.parsed=this.result.filter;if(this.compat){this.setValueCompat(this.parsed);}else{this.setValue(this.result.encoded);UI.setElementText(this.label_elt,this.result.text);}
if(this.do_confirm){this.do_confirm=false;this.showPopup();}},returnFieldList:function(data){var fs,i,k,opts={keys:[],values:[]};this.setLoading(false);if(!data||!data.result){this.invalid=true;this.updateDisplay();return;}
fs=this.fields_result=data.result;for(i=0;i<fs.length;i++){if(fs[i].type=='date'||fs[i].type=='datetime'){k=fs[i].name||fs[i].field_name;if(k==this.base_name)continue;opts.keys.push(k);opts.values.push(fs[i].label);}}
this.fields_list=opts;this.showPopup();},getValue:function(){if(this.compat){return this.form.elements[this.name+'-operator'].value;}
if(this.field)return this.field.value;},setValue:function(val){if(this.field)this.field.value=val;},setValueCompat:function(val){if(!val)val={};var fop='any',fval='',fend='',fperiod='',inp_op=this.form.elements[this.name+'-operator'],inp_val=this.form.elements[this.name],inp_end=this.form.elements[this.name+'-end'],inp_period=this.form.elements[this.name+'-period'];if(!val.operator||val.operator==='any'){fop='';}
else if(val.operator==='empty'){fop=val.operator;if(val.negate)fop='not_'+fop;}
else if(val.operator==='date'){fop='on_date';if(val.negate)fop='not_'+fop;fval=val.value;}
else if(val.operator==='special'){fop=val.value;}
else if(val.operator==='before'||val.operator==='after'){fop=val.operator+'_date';fval=val.value.value;}
else if(val.operator==='range'){fop='between_dates';fval=val.start.value;fend=val.end.value;}
else if(val.operator==='current'||val.operator==='previous'||val.operator==='next'){fop='period_'+(val.operator==='previous'?'prev':val.operator);fperiod=(''+val.period).replace('fiscal','fiscal_');if(fperiod==='day'&&val.count&&val.count!=1)
fperiod='days_'+val.count;}
if(fval)
fval=parseDateString(fval).d.print(getDateFormat().print_format);if(fend)
fend=parseDateString(fend).d.print(getDateFormat().print_format);inp_op.value=fop;inp_val.value=fval;inp_end.value=fend;inp_period.value=fperiod;this.updateLabelCompat();},updateLabelCompat:function(val){var inp_op=this.form.elements[this.name+'-operator'],inp_val=this.form.elements[this.name],inp_end=this.form.elements[this.name+'-end'],inp_period=this.form.elements[this.name+'-period'],pfx,lbl='',dom='date_range_operators_dom';op=inp_op.value;if(!op||op==='any')
lbl=App.language.getListString(dom,'any');else if(op==='empty'||op==='not_empty')
lbl=App.language.getListString(dom,op);else if(op==='today'||op==='tomorrow'||op==='yesterday')
lbl=App.language.getListString('date_filter_operators_dom',op);else if(op==='on_date'||op==='not_on_date'){lbl=inp_val.value;if(op==='not_on_date'){pfx=App.language.getListString(dom,'not');lbl=[MakeElt('span.text-muted.small',pfx+app_string('LBL_SEPARATOR')),lbl];}}
else if(op==='between_dates'){pfx=App.language.getListString(dom,'from_pfx');var end=App.language.getListString('date_range_embed_dom','to');lbl=[MakeElt('span.text-muted.small',pfx+app_string('LBL_SEPARATOR')),inp_val.value,MakeElt('span.text-muted.small',' '+end+app_string('LBL_SEPARATOR')),inp_end.value];}
else if(op==='before_date'||op==='after_date'){pfx=App.language.getListString(dom,op==='before_date'?'before_pfx':'after_pfx');lbl=[MakeElt('span.text-muted.small',pfx+app_string('LBL_SEPARATOR')),inp_val.value];}
else if(op==='period_current'||op==='period_next'||op==='period_prev'){pfx=op.replace('period_','');if(pfx=='prev')pfx='previous';pfx=App.language.getListString(dom,pfx);var pd=inp_period.value.replace('fiscal_','fiscal');if(pd.substring(0,5)==='days_'){lbl=pd.substring(5)+' '+App.language.getListString('interval_units_dom','days');}else{lbl=App.language.getListString('interval_unit_dom',pd+'s');}
lbl=[MakeElt('span.text-muted.small',pfx+app_string('LBL_SEPARATOR')),lbl];}
UI.setElementContent(this.label_elt,lbl);},updateDisplay:function(){var val=this.getValue(),ph=!val||val==='any';UI.addRemoveClass(this.elt,'active',!!(this.focused&&!this.opened));UI.addRemoveClass(this.elt,'opened',!!this.opened);UI.addRemoveClass(this.elt,'invalid',!!this.invalid);UI.addRemoveClass(this.label_elt,'text-placeholder',!this.focused&&!this.opened&&ph);}};UI.TextFilterInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;this.invalid=false;if(params)extendObject(this,params);}
UI.TextFilterInput.prototype={setup:function(){if(this.set_up)return;if(!this.elt)
this.elt=$(this.id);if(!this.elt)return;var basename=this.name;if(this.form&&basename){if(!this.value_field)
this.value_field=this.form.elements[basename];if(!this.operator_field)
this.operator_field=this.form.elements[basename+'-operator'];if(!this.input_elt)
this.input_elt=Wrap(this.elt).findFirst('.input-field').get(0);}
this.addHooks();this.updateDisplay();this.set_up=true;},addHooks:function(){if(!this.input_elt)return;Wrap(this.input_elt).on('mousedown','.input-label',function(evt){evt.preventDefault();}).on('mousedown',this.handleMouseDown,{scope:this}).on('click',this.handleClick,{scope:this}).on('keydown',this.handleKeyDown,{scope:this}).on('focus',this.handleFocus,{scope:this}).on('blur',this.handleBlur,{scope:this});},getOperator:function(){return this.operator_field&&this.operator_field.value;},getFilterValue:function(){var val=trim(this.value_field&&this.value_field.value);if(!val.length)val=null;return val;},focus:function(){this.input_elt.focus();},handleKeyDown:function(evt){var nav;if(evt.keyCode==38)nav=-1;else if(evt.keyCode==40)nav=1;else nav=0;if(nav){if(this.opened&&this.mode==='operator')
this.operator_sel.adjustCurrentIndex(nav,null,evt);else if(!this.disabled)
this.showPopup();UI.stopEvent(evt);}else if(evt.keyCode==13){if(this.opened){this.acceptInput();}else if(!this.disabled)
this.showPopup();UI.stopEvent(evt);}else if(evt.keyCode==8||evt.keyCode==46){if(!this.disabled)this.clear();}else if(evt.keyCode==27){if(this.opened){this.hidePopup();this.focus();UI.stopEvent(evt);}else if(!this.disabled){if(this.clear())UI.stopEvent(evt);}}else if(evt.keyCode==32){if(!this.opened&&!this.disabled){this.showPopup();UI.stopEvent(evt);}}},handleMouseDown:function(evt){if(!this.disabled){if(evt.currentTarget===this.input_elt)
evt.stopPropagation();}},handleClick:function(evt){if(evt.which==1){if(this.opened)
this.hidePopup();else if(!this.disabled)
this.showPopup();UI.stopEvent(evt);}},handleFocus:function(evt){this.focused=true;this.updateDisplay();},handleBlur:function(evt){this.focused=false;this.updateDisplay();},switchMode:function(mode,repos){var op=this.operator_next;this.mode=mode;this.return_row.toggle(mode==='values');this.value_div.toggle(mode==='values');this.list_div.toggle(mode==='operator');this.value_label.text(this.operatorLabel(op));if(repos){if(mode==='values')
this.value_input.select();else
this.input_elt.focus();this.popup.reposition();}},returnValue:function(name,val){if(name==='operator'){if(val&&val!=='empty'&&val!=='not_empty'){this.operator_next=val;this.switchMode('values',true);}else{this.operator_field.value=val||'';this.value_field.value='';this.hidePopup();this.updateDisplay();this.focus();}}
else if(name==='value'){this.value_next=val;}},acceptInput:function(){var op=this.operator_next;if(this.opened){if(this.mode==='operator')
this.operator_sel.selectCurrent();else{if(op&&op!=='empty'&&op!=='not_empty'){if(!trim(this.value_next).length)return this.returnValue('operator','');}else{this.value_next='';}
this.operator_field.value=op;this.value_field.value=get_default(this.value_next,'');this.hidePopup();this.updateDisplay();this.focus();}}},clear:function(){var ret=this.operator_field.value;this.operator_field.value='';this.value_field.value='';if(this.opened){this.hidePopup();this.focus();}
this.updateDisplay();return ret;},operatorLabel:function(op){if(op===undefined)op=this.getOperator();return App.language.getListString('text_filter_operators_dom',op,'app')||'';},getPopupContent:function(){var self=this;if(!this.operator_sel){this.operator_sel=new UI.SelectList(this.id+'-selop',{options:'text_filter_operators_dom',flat:true});this.operator_sel.render();this.operator_sel.onchange=function(){self.returnValue('operator',this.getSelectedKey());}}
if(!this.value_input){this.value_input=new UI.TextInput(this.id+'-nval',{tabIndex:0,init_value:this.value_field.value});this.value_input.render();this.value_input.onchange=function(){self.returnValue('value',this.getValue());}
this.value_input.onreturn=function(){self.acceptInput();}}
if(!this.value_label){this.value_label=MakeElt('h5.form-label.no-margin');this.tools_row=MakeElt('div.row.tools-row').append(this.value_label).append(MakeElt('div.uii.uii-lg.active-icon.uii-remove',{tabindex:0}).on('click, keydown[key=enter|space]',function(){self.clear();})).append(MakeElt('div.uii.uii-lg.active-icon.uii-accept',{tabindex:0}).on('click, keydown[key=enter|space]',function(){self.acceptInput();}));}
var return_link=MakeElt('a.tools-link',{href:'#'},MakeElt('span.uii.uii-previous'),nbsp(),app_string('LBL_FILTER_SELECT_OPERATOR')).on('click',function(){self.switchMode('operator',true);return false;});this.return_row=MakeElt('div.card-header.panel-subheader').append(MakeElt('div.tools-row.popup-title',return_link));this.list_div=MakeElt('div.card-body.panel-body').append(this.operator_sel.elt);this.value_div=MakeElt('div.card-body.panel-body.panel-pad-body').append(this.tools_row).append(MakeElt('div.row.form-row').append(MakeElt('div.column.form-cell').append(
MakeElt('div.form-entry').append(
MakeElt('div.form-value').append(this.value_input.field)))));return[this.return_row,this.list_div,this.value_div];},showPopup:function(){var self=this,content=this.getPopupContent(),op=this.getOperator(),p=new UI.PopupSlidePanel(this.id+'-popup',{target:this.input_elt,target_offset:{top:-1},destroy_on_close:true,min_width:200});p.onshow=function(){self.opened=true;self.updateDisplay();if(self.mode==='values')
self.value_input.select();else
self.input_elt.focus();}
p.onclose=function(){self.opened=false;self.popup=null;self.updateDisplay();}
p.render();Wrap(p.elt).content(content);this.operator_sel.setup();this.operator_sel.setSelectedKey(this.operator_next=op,true);this.value_input.setup();this.value_input.setValue(this.value_next=this.getFilterValue(),true);this.popup=p;if(op&&op!=='empty'&&op!=='not_empty')
this.switchMode('values');else
this.switchMode('operator');p.show();},hidePopup:function(){if(this.popup)this.popup.close();},updateLabel:function(){var op=this.getOperator(),opers,val,lbl,label_elt=Wrap(this.elt).findFirst('.input-label').ext(0);if(label_elt){label_elt.empty();lbl=op==='eq'?'':this.operatorLabel(op);if(op&&op!=='empty'&&op!=='not_empty'){val=trim(this.getFilterValue());if(!val.length)
lbl=this.operatorLabel(op='');else if(lbl){label_elt.append(MakeElt('span.text-muted.small',lbl+app_string('LBL_SEPARATOR')));lbl=val;}else
lbl=val;}
if(lbl.length)
label_elt.append(lbl);label_elt.toggleClass('text-placeholder',!op);}},updateDisplay:function(){UI.addRemoveClass(this.input_elt,'active',!!(this.focused||this.opened));UI.addRemoveClass(this.input_elt,'opened',!!this.opened);UI.addRemoveClass(this.input_elt,'invalid',this.invalid);this.updateLabel();}};UI.SelectFilterInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;this.focused=false;this.invalid=false;this.menu_id=this.id+'-popup';this.mark_blank=true;var options;if(params&&params.options){options=params.options;}else
options='';if(params)extendObject(this,params);if(!this.menu){this.menu=new UI.SelectList(this.menu_id,{options:options,popup:true,show_checks:this.show_checks,width:this.options_width,className:this.popup_class_name,icon_key:this.icon_key,disabled_indexes:this.disabled_indexes||[],mark_blank:this.mark_blank});}};UI.SelectFilterInput.prototype={setup:function(){if(this.set_up)return;if(!this.elt)
this.elt=$(this.id);if(!this.elt)return;if(!this.input_elt)
this.input_elt=Wrap(this.elt).findFirst('.input-field').get(0);var basename=this.name?this.name.replace(/-filter$/,''):'';var baseid=this.id.replace(/-filter$/,'');if(this.form&&basename){if(!this.field)
this.field=this.form.elements[basename];if(!this.operator_field)
this.operator_field=this.form.elements[basename+'-operator'];}
this.addHooks();this.updateDisplay();this.set_up=true;if(this.getOperatorParamType()=='multi_select')
setTimeout(this.reRenderField.bind(this),50);},addHooks:function(){if(this.events)return;var input=this;this.events=UI.addEventListeners(this.elt,{keydown:this.handleKeyDown,keyup:this.handleKeyUp,mousedown:this.handleMouseDown,click:this.handleClick,focus:this.handleFocus,blur:this.handleBlur},this);},handleMouseDown:function(evt){if(!this.disabled&&evt.currentTarget===this.elt)
evt.stopPropagation();},handleClick:function(evt){if(evt.which==1){if(this.opened)
this.hideSearch();else if(!this.disabled)
this.showSearch();UI.stopEvent(evt);}},getOperator:function(){return this.operator_field&&this.operator_field.value||'';},getOperatorParamType:function(){var oper=this.getOperator();if(!oper||oper==='empty'||oper==='not_empty')return'';if(oper==='any_of'||oper==='not_any_of')return'multi_select';return'select';},reRenderField:function(){var ptype=this.getOperatorParamType(),op=this.getOperator(),render=false,multi=false,wrapper=this.input_elt&&Wrap(this.input_elt).closest('.input-wrapper').get(0),value_field;if(!wrapper)return;if(ptype==='multi_select'&&!this.multi_sel){render=true;multi=true;}else if(ptype!=='multi_select'&&this.multi_sel){render=true;}
if(render){var params=this.initRenderParams(multi);UI.clearChildNodes(this.input_elt);if(multi){this.multi_sel=new UI.SelectList(this.input_elt,params);UI.addClass(this.input_elt,'select-input');this.multi_sel.render();this.multi_sel.setup();}else{this.multi_sel.destroy();this.multi_sel=null;MakeElt('div.input-label.filter-label').appendTo(this.input_elt);this.input_elt.style.width=null;}
UI.setElementContent(wrapper,[
this.operator_field,this.field,this.input_elt,]);this.addHooks(true);}
if(this.multi_sel){this.multi_sel.header_text=this.getOperator()==='not_any_of'?this.translateOperator('not_any_of'):'';this.multi_sel.updateDisplay();}},initRenderParams:function(multi){var params={},i,width,val;params.options=this.getBaseOptions(multi);val=(params.field?params.field.value:this.init_value)||'';if(!multi&&(i=val.indexOf('^,^'))>=0){val=val.substring(0,i);}
if(params.field)params.field.value=val;else params.init_value=val;if(multi){params.add_remove=true;params.disable_current=true;params.disable_events=true;params.field=this.field;params.multi_select=true;params.name=this.name;params.rows=this.display_rows||4;if(params.options&&params.options.maxlen){width=params.options.maxlen;}else{width=28;}
width=(width+5.5)*0.5;params.width=Math.round(width*100)/100+'em';}else{params.show_checks=true;}
return params;},getBaseOptions:function(for_multi){return this.menu.getOptions();},handleFocus:function(){this.focused=true;this.updateDisplay();},handleBlur:function(){this.focused=false;this.updateDisplay();},focus:function(){this.input_elt.focus();},initSearcher:function(){var self=this,search_opts={allow_clear:true,disable_recent:true,target:this.elt,target_offset:{top:-1,left:0},form:this.form,options:this.menu.getOptions(),search_blank:true,matching_only:true};this.searcher=new UI.SearchSelectFilter(this.id+'-search',search_opts);this.searcher.onchange=function(k,v,oper,keepOpen){if(self.operator_field!==oper){self.field.value='';self.operator_field.value=oper;self.value_updated=true;}
self.reRenderField(keepOpen);if(self.multi_sel){self.multi_sel.addOption(k,v);self.value_updated=true;if(keepOpen){this.setSourceKeys(self.multi_sel.getKeys());this.reposition();}else if(!self.checkAutoSubmit()){self.focus();}
self.updateDisplay();}
else{self.field.value=k;self.value_updated=true;if(!self.checkAutoSubmit())
self.focus();self.updateDisplay();}}
this.searcher.onremove=function(k,v,oper,keepOpen){if(self.operator_field!==oper){self.field.value='';self.operator_field.value=oper;self.value_updated=true;}
if(self.multi_sel){self.multi_sel.removeOption(k);self.value_updated=true;if(keepOpen){this.setSourceKeys(self.multi_sel.getKeys());this.reposition();}else if(!self.checkAutoSubmit()){self.focus();}}else{self.focus();}
self.updateDisplay();}
this.searcher.onshow=function(){self.opened=true;self.updateDisplay();}
this.searcher.onhide=function(){self.opened=false;self.updateDisplay();self.checkAutoSubmit();}
this.searcher.onclear=function(){self.operator_field.value='';self.field.value='';self.value_updated=true;self.reRenderField();self.checkAutoSubmit();}
this.searcher.oncancel=function(){self.focus();}
this.searcher.setup();},checkAutoSubmit:function(){if(this.auto_submit&&this.value_updated){UI.submitForm(this.form);return true;}},showSearch:function(query){if(!this.searcher){this.initSearcher();}
this.searcher.render();var w=UI.getEltRegion(this.elt);if(w)
this.searcher.setWidth(Math.max(w.width-24,300)+'px');this.searcher.setOperator(this.getOperator()||'eq');this.searcher.setSourceKeys(this.multi_sel?this.multi_sel.getKeys():[]);this.searcher.setKey(this.field.value);this.searcher.showDefault(true);},hideSearch:function(){if(this.searcher)
this.searcher.close();},translateOperator:function(op){return App.language.getListString('select_filter_operators_dom',op);},updateLabel:function(){if(this.getOperatorParamType()==='multi_select')return;var label_elt=Wrap(this.input_elt).findFirst('.input-label').ext(0),label_key=this.label_key||'name',op=this.getOperator(),val,txt,ph=!op;if(!label_elt)return;if(this.getOperatorParamType()===''){label_elt.text(this.translateOperator(op));}else{var lbl_key=this.label_key||'name';val=this.menu.options.getValue(this.field.value);if(val&&typeof(val)==='object')val=val[label_key];txt=val||'';label_elt.empty();if(op!=='eq')
label_elt.append(MakeElt('span.text-muted.small',this.translateOperator(op)+app_string('LBL_SEPARATOR')));label_elt.append(txt);}
label_elt.toggleClass('text-placeholder',ph);},updateDisplay:function(){UI.addRemoveClass(this.input_elt,'active',!!(this.focused||this.opened));UI.addRemoveClass(this.input_elt,'invalid',this.invalid);UI.addRemoveClass(this.input_elt,'opened',!!(this.opened&&!this.multi_sel));UI.addRemoveClass(this.input_elt,'flat-bottom',!!(this.opened&&this.multi_sel));this.updateLabel();}};UI.SearchSelectFilter=function(id,params){UI.SearchSelect.call(this,id,params);}
extendClass(UI.SearchSelectFilter,UI.SearchSelect,{render:function(){UI.SearchSelect.prototype.render.call(this);},showModules:function(){this.showOperator();},showDefault:function(evt){if(~['any_of','not_any_of','eq','not_eq'].indexOf(this.operator))
UI.SearchSelect.prototype.showDefault.call(this,evt);else
this.showOperator();this.focusSearch();},setOperator:function(op){if(op!==this.operator)
this.perform_remove=false;this.operator=op;},showOperator:function(){this.mode='operator';this.setTitle(this.module_title||app_string('LBL_FILTER_SELECT_OPERATOR'));this.list.icon_key=null;this.list.setOptions('select_filter_operators_dom');this.list.setSelectedKey(this.operator,true);this.updateDisplay();if(this.popup)this.popup.show();},translateOperator:function(){return App.language.getListString('select_filter_operators_dom',this.operator);},isMultiSelect:function(){return(this.operator==='any_of'||this.operator==='not_any_of');},rowSelected:function(k,v,silent,evt){if(this.mode=='operator'){this.setOperator(k);if(!k||k==='empty'||k==='not_empty'){UI.callEvent(this,this.onchange,'','',this.operator,false,evt);this.close();}else{UI.setDisplayState(this.list_elt,false);this.showDefault(evt);}
return;}
this.setKey(k);keepOpen=(this.isMultiSelect()&&evt&&(evt.cmdKey||evt.shiftKey));if(!keepOpen)
this.close();if(!silent){if(this.perform_remove)
UI.callEvent(this,this.onremove,k,v,this.operator,keepOpen,evt);else
UI.callEvent(this,this.onchange,k,v,this.operator,keepOpen,evt);}
if(keepOpen)
this.focus();},updateFilter:function(){if((this.mode==='options'||this.mode==='search')&&this.isMultiSelect())return UI.SearchSelect.prototype.updateFilter.call(this);},updateDisplay:function(){UI.SearchSelect.prototype.updateDisplay.call(this);if(this.mode==='operator'){UI.setDisplayState(this.return_row,false);UI.setDisplayState(this.search_elt,false);}else{this.return_link.content([MakeElt('span.uii.uii-previous'),nbsp(),app_string('LBL_FILTER_SELECT_OPERATOR')+
' ('+this.translateOperator()+')']);UI.setDisplayState(this.return_row,true);}}});UI.NumberFilterInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;this.format='float';this.decimals=2;this.invalid=false;if(params)extendObject(this,params);}
UI.NumberFilterInput.prototype={setup:function(){if(this.set_up)return;if(!this.elt)
this.elt=$(this.id);if(!this.elt)return;var basename=this.name;if(this.form&&basename){if(!this.number_field)
this.number_field=this.form.elements[basename];if(!this.end_field)
this.end_field=this.form.elements[basename+'-end'];if(!this.operator_field)
this.operator_field=this.form.elements[basename+'-operator'];if(!this.input_elt)
this.input_elt=Wrap(this.elt).findFirst('.input-field').get(0);}
this.addHooks();this.updateDisplay();this.set_up=true;},addHooks:function(){if(!this.input_elt)return;Wrap(this.input_elt).on('mousedown','.input-label',function(evt){evt.preventDefault();}).on('mousedown',this.handleMouseDown,{scope:this}).on('click',this.handleClick,{scope:this}).on('keydown',this.handleKeyDown,{scope:this}).on('focus',this.handleFocus,{scope:this}).on('blur',this.handleBlur,{scope:this});},getOperator:function(){return this.operator_field&&this.operator_field.value;},getFilterValue:function(){var val=trim(this.number_field&&this.number_field.value);if(!val.length)val=null;return val;},getFilterEnd:function(){var val=trim(this.end_field&&this.end_field.value);if(!val.length)val=null;return val;},focus:function(){this.input_elt.focus();},handleKeyDown:function(evt){var nav;if(evt.keyCode==38)nav=-1;else if(evt.keyCode==40)nav=1;else nav=0;if(nav){if(this.opened&&this.mode==='operator')
this.operator_sel.adjustCurrentIndex(nav,null,evt);else if(!this.disabled)
this.showPopup();UI.stopEvent(evt);}else if(evt.keyCode==13){if(this.opened){this.acceptInput();}else if(!this.disabled)
this.showPopup();UI.stopEvent(evt);}else if(evt.keyCode==8||evt.keyCode==46){if(!this.disabled)this.clear();}else if(evt.keyCode==27){if(this.opened){this.hidePopup();this.focus();UI.stopEvent(evt);}else if(!this.disabled){if(this.clear())UI.stopEvent(evt);}}else if(evt.keyCode==32){if(!this.opened&&!this.disabled){this.showPopup();UI.stopEvent(evt);}}},handleMouseDown:function(evt){if(!this.disabled){if(evt.currentTarget===this.input_elt)
evt.stopPropagation();}},handleClick:function(evt){if(evt.which==1){if(this.opened)
this.hidePopup();else if(!this.disabled)
this.showPopup();UI.stopEvent(evt);}},handleFocus:function(evt){this.focused=true;this.updateDisplay();},handleBlur:function(evt){this.focused=false;this.updateDisplay();},switchMode:function(mode,repos){var op=this.operator_next;this.mode=mode;this.return_row.toggle(mode==='values');this.value_div.toggle(mode==='values');this.list_div.toggle(mode==='operator');this.value_label.text(this.operatorLabel(op));this.end_row.toggle(op==='between');if(repos){if(mode==='values'){this.number_input.field.placeholder=
'('+App.language.getListString('filter_properties_dom',(op==='between'?'min':'value'),'app')+')';this.number_input.select();}else
this.input_elt.focus();this.popup.reposition();}},returnValue:function(name,val){if(name==='operator'){if(val&&val!=='empty'&&val!=='not_empty'){this.operator_next=val;this.switchMode('values',true);}else{this.operator_field.value=val||'';this.number_field.value='';this.end_field.value='';this.hidePopup();this.updateDisplay();this.focus();}}
else if(name==='number'){this.number_next=val;}
else if(name==='end'){this.end_next=val;}},acceptInput:function(){var op=this.operator_next;if(this.opened){if(this.mode==='operator')
this.operator_sel.selectCurrent();else{if(op&&op!=='empty'&&op!=='not_empty'){if(!trim(this.number_next).length&&(op!=='between'||!trim(this.number_end).length))return this.returnValue('operator','');}else{this.number_next='';this.end_next='';}
this.operator_field.value=op;this.number_field.value=get_default(this.number_next,'');this.end_field.value=get_default(this.end_next,'');this.hidePopup();this.updateDisplay();this.focus();}}},clear:function(){var ret=this.operator_field.value;this.operator_field.value='';this.number_field.value='';this.end_field.value='';if(this.opened){this.hidePopup();this.focus();}
this.updateDisplay();return ret;},operatorLabel:function(op){if(op===undefined)op=this.getOperator();return App.language.getListString('number_filter_operators_dom',op,'app')||'';},getPopupContent:function(){var self=this;if(!this.operator_sel){this.operator_sel=new UI.SelectList(this.id+'-selop',{options:'number_filter_operators_dom',flat:true});this.operator_sel.render();this.operator_sel.onchange=function(){self.returnValue('operator',this.getSelectedKey());}}
if(!this.number_input){this.number_input=new UI.TextInput(this.id+'-nval',{format:this.format,min_decimals:0,decimals:this.decimals,tabIndex:0,init_value:this.number_field.value});this.number_input.render();this.number_input.onchange=function(){self.returnValue('number',this.getValue());}
this.number_input.onreturn=function(){self.acceptInput();}}
if(!this.end_input){this.end_input=new UI.TextInput(this.id+'-eval',{format:this.format,min_decimals:0,decimals:this.decimals,tabIndex:0,init_value:this.end_field.value,placeholder:'('+App.language.getListString('filter_properties_dom','max','app')+')'});this.end_input.render();this.end_input.onchange=function(){self.returnValue('end',this.getValue());}
this.end_input.onreturn=function(){self.acceptInput();}}
if(!this.value_label){this.value_label=MakeElt('h5.form-label.no-margin');this.tools_row=MakeElt('div.row.tools-row').append(this.value_label).append(MakeElt('div.uii.uii-lg.active-icon.uii-remove',{tabindex:0}).on('click, keydown[key=enter|space]',function(){self.clear();})).append(MakeElt('div.uii.uii-lg.active-icon.uii-accept',{tabindex:0}).on('click, keydown[key=enter|space]',function(){self.acceptInput();}));}
var return_link=MakeElt('a.tools-link',{href:'#'},MakeElt('span.uii.uii-previous'),nbsp(),app_string('LBL_FILTER_SELECT_OPERATOR')).on('click',function(){self.switchMode('operator',true);return false;});this.return_row=MakeElt('div.card-header.panel-subheader').append(MakeElt('div.tools-row.popup-title',return_link));this.list_div=MakeElt('div.card-body.panel-body').append(this.operator_sel.elt);this.value_div=MakeElt('div.card-body.panel-body.panel-pad-body').append(this.tools_row).append(MakeElt('div.row.form-row').append(MakeElt('div.column.form-cell').append(
MakeElt('div.form-entry').append(
MakeElt('div.form-value').append(this.number_input.field))))).append(this.end_row=MakeElt('div.row.form-row').append(MakeElt('div.column.form-cell').append(
MakeElt('div.form-entry').append(
MakeElt('div.form-value').append(this.end_input.field)))));return[this.return_row,this.list_div,this.value_div];},showPopup:function(){var self=this,op=this.getOperator(),content=this.getPopupContent(),p=new UI.PopupSlidePanel(this.id+'-popup',{target:this.input_elt,target_offset:{top:-1},destroy_on_close:true,min_width:200});p.onshow=function(){self.opened=true;self.updateDisplay();if(self.mode==='values')
self.number_input.select();else
self.input_elt.focus();}
p.onclose=function(){self.opened=false;self.popup=null;self.updateDisplay();}
p.render();Wrap(p.elt).content(content);this.operator_sel.setup();this.operator_sel.setSelectedKey(this.operator_next=op,true);this.number_input.setup();this.number_input.setValue(this.number_next=this.getFilterValue(),true);this.end_input.setup();this.end_input.setValue(this.end_next=this.getFilterEnd(),true);this.popup=p;if(op&&op!=='empty'&&op!=='not_empty')
this.switchMode('values');else
this.switchMode('operator');p.show();},hidePopup:function(){if(this.popup)this.popup.close();},updateLabel:function(){var op=this.getOperator(),opers,val,lbl,label_elt=Wrap(this.elt).findFirst('.input-label').ext(0);if(label_elt){label_elt.empty();lbl=op==='eq'?'':this.operatorLabel(op);if(op&&op!=='empty'&&op!=='not_empty'){val=this.getFilterValue();if(isset(val))
val=stdFormatNumber(val);else
val=app_string('LBL_ANY');if(lbl)
label_elt.append(MakeElt('span.text-muted.small',lbl+app_string('LBL_SEPARATOR')));lbl=val;if(op==='between'){label_elt.append(lbl);val=this.getFilterEnd();if(isset(val))
val=stdFormatNumber(val);else
val=app_string('LBL_ANY');label_elt.append(MakeElt('span.text-muted.small',app_string('LBL_FILTER_VALUE_AND')));lbl=val;}}
label_elt.append(lbl);label_elt.toggleClass('text-placeholder',!op);}},updateDisplay:function(){UI.addRemoveClass(this.input_elt,'active',!!(this.focused||this.opened));UI.addRemoveClass(this.input_elt,'opened',!!this.opened);UI.addRemoveClass(this.input_elt,'invalid',this.invalid);this.updateLabel();}};UI.AlphabetInput=function(id,params){this.id=id;this.onchange=null;this.focused=false;if(params)extendObject(this,params);};UI.AlphabetInput.prototype={setup:function(){if(this.set_up)return;if(!this.field){if(this.name&&this.form)
this.field=this.form.elements[this.name];else if(this.field_id)
this.field=$(this.field_id);}
this.addHooks();this.set_up=true;},addHooks:function(){if(this.id){var ed=this;var letter;var letter_id='';var letter_elem=null;for(optionCounter=65;optionCounter<91;optionCounter++){letter=String.fromCharCode(optionCounter);letter_id=this.id+'-'+letter;letter_elem=$(letter_id);if(letter_elem)
letter_elem.onclick=function(evt){return ed.handleClick(evt||window.event,this.innerHTML);};}}},render:function(){},getValue:function(){return(this.field)?this.field.value:'';},handleClick:function(evt,value){var val;if(this.field)
this.field.value=val=value;UI.callEvent(this,this.onchange,evt,val);if(this.auto_submit)
UI.submitForm(this.form);return false;}};UI.ScrollPanel=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;this.pos=0;this.pos_top=0;this.step=10;this.steps=0;if(params)extendObject(this,params);}
UI.ScrollPanel.prototype={setup:function(){if(this.set_up)return;if(!this.elt&&this.id)
this.elt=$(this.id);if(this.elt&&!this.content){if(this.content_id)
this.content=$(this.content_id);else if(UI.hasClass(this.elt.firstChild,'scroll-content'))
this.content=this.elt.firstChild;}
this.set_up=true;},render:function(){var scroll=this;var outer=this.elt;if(!outer){var extcls=this.ext_class||'';outer=this.elt=createElement2('div',{id:this.id,className:'input-scroll '+extcls});}
var stop_event=function(evt){UI.stopEvent(evt);}
var handle_click=function(evt){scroll.handleClick(evt);stop_event(evt);}
UI.addEventListener(outer,'mousedown',function(evt){handle_click(evt);scroll.scrollContent('bar',evt);},this);UI.addEventListener(outer,'selectstart',stop_event,this);var inner=this.content;if(!inner){inner=this.content=createElement2('div',{className:'scroll-content'});outer.appendChild(inner);}
var onclick=function(evt){handle_click(evt);scroll.scrollContent(this.act,evt);}
for(var i=0;i<outer.childNodes.length;i++){var node=outer.childNodes[i];if(node!==inner){if(UI.hasClass(node,'up')&&!this.up_button)
this.up_button=node;else if(UI.hasClass(node,'down')&&!this.down_button)
this.down_button=node;else if(UI.hasClass(node,'pos')&&!this.pos_button)
this.pos_button=node;else{outer.removeChild(node);i--;}}}
if(!this.up_button){this.up_button=createElement2('div',{className:'scroll-button up'});this.up_button.appendChild(createElement2('div',{className:'input-icon'}));outer.appendChild(this.up_button);}
this.up_button.act='up';UI.addEventListener(this.up_button,'click',onclick,this.up_button);UI.addEventListener(this.up_button,'mousedown',handle_click,this.up_button);UI.addEventListener(this.up_button,'selectstart',stop_event,this.up_button);if(!this.down_button){this.down_button=createElement2('div',{className:'scroll-button down'});this.down_button.appendChild(createElement2('div',{className:'input-icon'}));outer.appendChild(this.down_button);}
this.down_button.act='down';UI.addEventListener(this.down_button,'click',onclick,this.down_button);UI.addEventListener(this.down_button,'mousedown',handle_click,this.down_button);UI.addEventListener(this.down_button,'selectstart',stop_event,this.down_button);if(!this.pos_button){this.pos_button=createElement2('div',{className:'scroll-button pos'});this.pos_button.appendChild(createElement2('div',{className:'input-icon'}));outer.appendChild(this.pos_button);}
this.makeDragTarget(this.pos_button,null,{mousedown:handle_click});return outer;},handleClick:function(evt){UI.callEvent(this,this.onclick,evt);},destroy:function(){this.destroyDragTarget(this.pos_button);this.elt=null;this.inner=null;this.up_button=this.down_button=this.pos_button=null;},getMax:function(){return(this.steps-1)*this.step;},getDisplayAdjustedStep:function(step,mpos,check){if(!isset(this.pos)||!mpos||!isset(mpos.y))return step;var rgn=UI.getEltRegion(this.elt),elth=rgn.height,yoffs=mpos.y+window.pageYOffset-rgn.y,over=Math.floor((yoffs+this.pos)/this.step),rstep;if(yoffs>0&&yoffs<elth&&step!=over){if(step<over){step=Math.round((this.pos-(over-step)*this.step)/this.step);rstep=Math.max(0,step);}
else if(step>over){step=Math.round((this.pos+elth-(over-step+1)*this.step)/this.step);rstep=Math.min(this.steps+Math.round(elth/this.step)-2,step);}}
if(isset(rstep)){if(check&&rstep!=step)return null;step=rstep;}
return step;},canShowStep:function(step,mpos){if(!mpos)return true;step=this.getDisplayAdjustedStep(step,mpos,true);return isset(step);},showStep:function(step,mpos){if(!this.elt)return;var elth=this.elt.clientHeight||parseFloat(this.elt.style.height);if(mpos)
step=this.getDisplayAdjustedStep(step,mpos);var showtop=step*this.step,showbottom=showtop+this.step,pos_t=this.pos,pos_b=pos_t+elth;if(!elth)return;if(pos_t>showtop){if(pos_b>=showbottom)
pos_t=showtop;}else if(pos_b<showbottom)
pos_t=showbottom-elth;if(pos_t!=this.pos)
this.scrollContent(pos_t);},setHeight:function(ht){if(this.elt)this.elt.style.height=(ht||0)+'px';},setSteps:function(steps,offset){this.steps=steps;if(isset(offset))
this.showStep(offset);this.scrollContent();},scrollContent:function(dir,evt){if(!this.elt)return;var step_mult=1,elth=this.elt.clientHeight||parseFloat(this.elt.style.height),pos=this.pos,max=this.getMax();if(dir=='bar'){if(!this.pos_button)return;var btnpos=UI.getEltRegion(this.pos_button),xy=YEvent.getXY(evt);if(!btnpos)return;if(xy[1]<btnpos.top)dir='up';else dir='down';step_mult=3;}
if(dir=='down'){if(pos%this.step>3)
pos+=this.step*step_mult-(pos%this.step);else
pos+=this.step*step_mult+(pos%this.step);}
else if(dir=='up'){if(pos%this.step>3)
pos-=(pos%this.step*step_mult);else
pos-=this.step*step_mult+(pos%this.step);}
else if(isset(dir)){pos=dir;}
if(pos<0)pos=0;else if(pos>max)pos=max;if(max<=0){pos=0;UI.addClass(this.elt,'disabled');}else{UI.removeClass(this.elt,'disabled');this.pos_h=Math.round(Math.max(13,elth/(max+elth)*(elth-32)));this.pos_h=Math.min(this.pos_h,200);this.pos_top=Math.round((elth-34-this.pos_h)*pos/max);if(this.pos_button){this.pos_button.style.height=''+this.pos_h+'px';this.pos_button.firstChild.style.top=''+Math.round((this.pos_h-15)/2)+'px';this.pos_button.style.top=''+(this.pos_top+16)+'px';}}
this.pos=pos;var tprop=this.getTransformProperty();if(tprop){if(pos||this.content.style[tprop]){if(isIPhone)
this.content.style[tprop]='translate3d(0, '+(-pos)+'px, 0)';else{if(tprop=='webkitTransform'){this.content.style.webkitTransformStyle='preserve-3d';}
this.content.style[tprop]='translateY('+(-pos)+'px)';}}}
else
this.content.style.top=''+(-pos)+'px';},getTransformProperty:function(){var tprop=UI.getTransformProperty();if(!isIPhone)tprop=null;return tprop;},getPosition:function(){if(!this.content)return;var rgn=UI.getEltRegion(this.content);rgn.rel_top=this.pos;if(this.getTransformProperty())
rgn.top-=this.pos;return rgn;},ondragstart:function(evt,info){UI.addClass(this.pos_button,'active');info.pos_top=this.pos_top;},ondragend:function(evt,info){UI.removeClass(this.pos_button,'active');},ondrag:function(evt,info){var max=this.getMax();var pos_top=info.pos_top+info.dragY;var pos=Math.round(pos_top*max/(this.elt.clientHeight-32-this.pos_h));this.pos=pos;this.scrollContent();}};extendProto(UI.ScrollPanel,UI.DragHandler);UI.CurrencySelect=function(id,params){this.bean_name='Currency';this.module='Currencies';if(!params)params={};if(!params.options)params.options={dom_name:'model.Currency'};opts=UI.getSelectOptions(params.options);if(!opts)
console.error('currency options not found:',params.options);params.options=opts;UI.RefInput.call(this,id,params);};extendClass(UI.CurrencySelect,UI.RefInput,{setup:function(){if(this.set_up)return;UI.RefInput.prototype.setup.call(this);if(!this.rate_input){if(this.form&&this.exchange_rate){this.rate_input=UI.getFormInput(this.form,this.exchange_rate);if(!this.rate_input){var f=this.form.elements[this.exchange_rate];var h=new UI.HiddenInput(f||this.id+'-rate',{name:this.exchange_rate});if(this.elt.parentNode)
this.elt.parentNode.insertBefore(h.render(),this.elt);this.rate_input=h;}}}
var self=this;UI.onInitForm(this.form,this.postInit.bind(this));UI.attachInputEvent(this.rate_input,'onchange',function(val){var rate=self.getRate(true);UI.callEvent(self,self.onrateupdate,self.old_rate,rate);self.old_rate=rate;});},postInit:function(){var cid=this.getKey(),rate;if(cid&&this.rate_input){if(!this.rate_input.getValue()){rate=this.old_rate=this.getStandardRate(cid);this.setRate(rate,true);}else{this.old_rate=this.getRate(true);}}},getOptionValue:function(currency_id){if(currency_id===undefined)currency_id=this.getKey();return this.options&&this.options.getValue(currency_id);},getDecimals:function(currency_id){var v=this.getOptionValue(currency_id);return v?parseInt(v.decimal_places,10):2;},getShortName:function(currency_id,add_rate){var v=this.getOptionValue(currency_id),ret=v?v.iso4217:'';if(add_rate&&ret)ret+=' : '+this.getSymbol(currency_id);return ret;},getSymbol:function(currency_id){var v=this.getOptionValue(currency_id);return v?v.symbol:'';},getSymbolAfter:function(currency_id){var v=this.getOptionValue(currency_id);return v?v.symbol_place_after:'';},getRate:function(nativeVal,currency_id){var rate=1.0;if(isset(currency_id)&&currency_id!=this.getKey())
rate=this.getStandardRate(currency_id);else if(this.rate_input)
rate=stdUnformatNumber(this.rate_input.getValue());if(nativeVal){rate=parseFloat(rate);if(isNaN(rate))rate=1.0;}
return rate;},getStandardRate:function(currency_id){var rate,v=this.getOptionValue(currency_id);if(v)rate=parseFloat(v.conversion_rate);return rate||1.0;},setRate:function(val,silent){var oldrate=this.old_rate||this.getRate(true);var curid=this.getKey();if(!curid||curid==='-99'||!val)
val=1.0;if(this.rate_input)
this.rate_input.setValue(stdFormatNumber(val,5,5),silent);val=this.getRate(true);if(!this.rate_input&&!silent)
UI.callEvent(this,this.onrateupdate,oldrate,val);this.old_rate=val;},haveCustomRate:function(rate){if(!rate)rate=this.getRate(true);return(rate!=this.getStandardRate());},update:function(key,value,silent,module,rate){if(!key){key='-99';value=this.getOptionValue(key);}
UI.RefInput.prototype.update.call(this,key,value,silent);var rate=get_default(rate,value?value.conversion_rate:null);this.setRate(rate,silent);},setValueAndRate:function(key,rate,silent){var value=this.getOptionValue(key||'-99');this.update(key,value,silent,this.module,rate);},setValue:function(cid,silent){this.setValueAndRate(cid,undefined,silent);},formatAmount:function(amt){if(!isset(amt))return'';var decs=this.getDecimals();var ret=stdFormatNumber(parseFloat(amt).toFixed(decs));return this.getSymbol()+' '+ret;}});UI.OwnerSelect=function(id,params){UI.SelectInput.call(this,id,params);};extendClass(UI.OwnerSelect,UI.SelectInput,{userUpdateMulti:function(row,count){if(count==1){this.update(row.ID_0.id,row.ID_0);}else{var idx=-1,keys=this.menu.getKeys();for(var i=0;i<keys.length;i++){if(keys[i].match(/#/)){idx=i;break;}}
var ids=[],title=[];for(var i=0;i<count;i++){var key=row['ID_'+i].id;ids.push(key);title.push(row['ID_'+i].label);}
value={label:app_string('LBL_OWNER_MULTIPLE_USERS')+' ('+count+')',icon:'icon-user',title:title.join(', ')};var key=ids.join('#');if(idx<0)
this.menu.addOption(key,value);else{var values=this.menu.getValues();keys[idx]=key;values[idx]=value;}
UI.SelectInput.prototype.update.call(this,key,value);}},userUpdate:function(key,value){this.update(key,value);},update:function(key,value,silent){if(key=='select')
this.showSelectUser();else{if(isString(value))
value={label:value};if(!value.icon)value.icon='icon-user';if(!this.menu.hasKey(key))
this.menu.addOption(key,value);UI.SelectInput.prototype.update.call(this,key,value,silent);}},showSelectUser:function(){var request_data={form_name:this.form.getAttribute('id')||this.form.getAttribute('name'),call_back_function:this.popup_callback||'ui_popup_return_owner',passthru_data:{ui_input_name:this.name||this.id},field_to_name_array:this.field_to_name||{id:'id',label:'name'}},params={module:'Users',request_data:request_data,inline:true,multiple:true};open_popup_window(params);}});UI.TabGroup=function(id,params){this.id=id;this.tabs=[];this.current_tab=null;this.hover_tab=null;this.focus_tab=null;this.base_zindex=1;this.manage_sections={};this.wrapped_idx=[];if(params)
extendObject(this,params);};UI.TabGroup.all_active=[];UI.TabGroup.resizeHandler=function(){var check=UI.TabGroup.all_active,seen=[];for(var i=0;i<check.length;i++){if(check[i].id&&check[i].elt&&UI.inDocument(check[i].elt)){seen.push(check[i]);check[i].updateDisplay();}}
UI.TabGroup.all_active=seen;}
UI.TabGroup.prototype={focus:function(){if(!isset(this.focus_tab))
this.focus_tab=this.active_tab;var t=this.getTab(this.focus_tab,true);if(t&&t.elt)
t.elt.focus();},getPosition:function(name){for(var i=0;i<this.tabs.length;i++)
if(this.tabs[i].name==name)return i;},loadTabs:function(tabs){if(Array.isArray(tabs))
this.tabs=tabs;var i,t;for(i=0;i<this.tabs.length;i++){t=this.tabs[i];if(!isset(t)||typeof(t)!='object'){this.tabs.splice(i,1);i--;continue;}
if(t.separator)continue;if(!t.elt){if(t.id)
t.elt=$(t.id);else if(t.name)
t.elt=$(this.id+'-tab-'+t.name);}
if(!t.outer_elt){if(t.outer_id)
t.outer_elt=$(t.outer_id);else if(t.name)
t.outer_elt=$(this.id+'-tabouter-'+t.name);}}},setup:function(){if(this.set_up)return;if(!this.elt)
this.elt=$(this.id);if(!this.field){if(this.name&&this.form)
this.field=this.form.elements[this.name];else if(this.field_id)
this.field=$(this.field_id);}
this.loadTabs();this.addHooks();if(this.field&&!isset(this.current_tab))
this.setValue(this.field.value,true,true);this.set_up=true;this.showHideSections();this.updateDisplay();UI.TabGroup.all_active.push(this);if(App.le)
App.le.registerTabGroup(this);},handleClick:function(evt){var tab=evt&&evt.data&&evt.data.tab;this.setValue(tab&&tab.name);UI.stopEvent(evt);},handleFocus:function(evt){var tab=evt&&evt.data&&evt.data.tab;this.setFocus(tab&&tab.name);},handleBlur:function(evt){this.setFocus(null);},handleMouseEnter:function(evt){var tab=evt&&evt.data&&evt.data.tab;this.setHover(tab&&tab.name);},handleMouseLeave:function(evt){this.setHover(null);},addHooks:function(){var i,t;for(i=0;i<this.tabs.length;i++){t=this.tabs[i];if(t.hidden||t.separator||t.disabled)continue;Wrap(t.elt).on({'mouseenter':this.handleMouseEnter,'mouseleave':this.handleMouseLeave,'click, keydown[key=enter|space]':this.handleClick,'focus':this.handleFocus,'blur':this.handleBlur},{scope:this,data:{tab:t}});}
if(this.elt)this.elt.onmousedown=function(){return false;}},setHover:function(name){var t=this.getTab(name,true);if(t)
this.hover_tab=name;else
this.hover_tab=this.focus_tab;this.updateDisplay();},setFocus:function(name){var t=this.getTab(name,true);if(t)
this.focus_tab=this.hover_tab=name;else
this.focus_tab=this.hover_tab=null;this.updateDisplay();},getValue:function(){if(this.field)return this.field.value;return this.current_tab;},setValue:function(name,silent,no_redraw){var t=this.getTab(name,true);if(t){if(!t.disable_select){this.current_tab=name;if(this.field)
this.field.value=this.current_tab;if(!no_redraw){this.updateDisplay();this.showHideSections();}}
if(!silent){if(t.perform)
UI.callEvent(this,t.perform,t);UI.callEvent(this,this.onchange,t);}}},showHideTab:function(name,state){var idx=this.getPosition(name);if(!isset(state))state=-1;if(isset(idx)){if(state===-1)
this.tabs[i].hidden=!this.tabs[i].hidden;else
this.tabs[i].hidden=state?1:0;if(this.tabs[i].hidden){if(this.focus_tab==name)
this.focus_tab=null;if(this.hover_tab==name)
this.hover_tab=null;if(this.current_tab==name)
this.setValue(null);}
this.updateDisplay();}},enableDisableTab:function(name,state){var t,idx=this.getPosition(name);if(!isset(state))state=-1;if(isset(idx))
t=this.tabs[idx];if(t&&!t.separator){if(state===-1)
t.disabled=!t.disabled;else
t.disabled=state?1:0;if(t.disabled){if(this.focus_tab==name)
this.focus_tab=null;if(this.hover_tab==name)
this.hover_tab=null;if(this.current_tab==name)
this.setValue(null);}
if(!t.hidden)
this.updateDisplay();}},getTab:function(name,selectable){var t,idx=name?this.getPosition(name):null;if(isset(idx))
t=this.tabs[idx];if(t&&(!selectable||(!t.hidden&&!t.separator&&!t.disabled)))return t;},setLabel:function(name,label){var idx=this.getPosition(name),elt=this.findIdxLabel(idx);if(this.tabs[idx]){this.tabs[idx].label=label;if(elt){UI.setElementText(elt,label);}}},findIdxIcon:function(idx,clsName){var es,i,cls;if(this.tabs[idx]&&this.tabs[idx].outer_elt){es=this.tabs[idx].outer_elt.getElementsByClassName('input-icon');if(es){if(!clsName)return es[0];cls=es[0].className;cls=cls.replace(/(\b(tab-icon|input-icon|left)\b\s*)*/,'');return cls;}}},findIdxLabel:function(idx){var es;if(this.tabs[idx]&&this.tabs[idx].outer_elt){es=this.tabs[idx].outer_elt.getElementsByClassName('input-label');if(es)return es[0];}},render:function(){},renderTab:function(name,label,icon,className){var out=createElement2('div',{id:this.id+'-tabouter-'+name,className:'tab-outer normal '+get_default(className,'')}),btn=createElement2('div',{id:this.id+'-tab-'+name,className:'tab-button',type:'button'}),span=createElement2('span',{className:'input-label tab-label'});if(icon){if(icon.indexOf('uii')<0&&icon.indexOf('input-icon')<0)icon='input-icon '+icon;btn.appendChild(createElement2('div',{className:'tab-icon '+icon}));}
if(label){UI.setElementText(span,label);btn.appendChild(span);}
out.appendChild(btn);return out;},destroy:function(){for(var i=0;i<this.tabs.length;i++){UI.removeNode(this.tabs[i].elt,true);this.tabs[i].elt=this.tabs[i].outer_elt=null;}},getVisibleTabs:function(){var ret=[],i,t,rt,sep=false;for(i=0;i<this.tabs.length;i++){t=this.tabs[i];if(t.hidden)
continue;if(t.separator){sep=true;if(ret.length)
ret[ret.length-1].pre_sep=true;continue;}
rt={index:i,name:t.name,pre_sep:false,post_sep:sep};rt.current=(t.name==this.current_tab);rt.hover=(t.name==this.hover_tab);rt.focus=(t.name==this.focus_tab);rt.disabled=!!t.disabled;ret.push(rt);sep=false;}
if(ret.length){ret[0].first=true;ret[ret.length-1].last=true;}
return ret;},updateDisplay:function(){var i,j,t,hset,ts=this.getVisibleTabs(),nowrap=UI.hasClass(this.elt,'nowrap'),outer=Wrap(this.elt),bounds=outer.bounds(),tab,tbound,invis,current,testidx=[],extidx=[];if(!bounds)return;for(i=0;i<ts.length;i++){t=this.tabs[ts[i].index];tab=Wrap(t.outer_elt);if(tab){if(!nowrap&&!hset&&t.outer_elt.offsetHeight){this.elt.style.height=''+t.outer_elt.offsetHeight+'px';hset=true;}
invis=false;if(ts[i].current){tab.css('z-index',this.base_zindex+ts.length);current=ts[i].index;}
else
tab.css('z-index',this.base_zindex+ts.length-i-1);tab.show();tab.toggleClass('current',ts[i].current);tab.toggleClass('active',ts[i].focus);tab.toggleClass('hover',ts[i].hover);tab.toggleClass('disabled',ts[i].disabled);tab.toggleClass('presep',ts[i].pre_sep);tab.toggleClass('postsep',ts[i].post_sep);if(nowrap&&(tbound=tab.bounds(outer))){if(tbound.right>bounds.width-5){if(testidx.length){for(j=0;j<testidx.length;j++)
Wrap(this.tabs[testidx[j]].outer_elt).css('visibility','hidden');extidx.pushArray(testidx);testidx.clear();}
invis=true;}else if(tbound.right>bounds.width-50){testidx.push(ts[i].index);}}
if(invis){extidx.push(ts[i].index);tab.css('visibility','hidden');}else{tab.css('visibility','visible');}}}
if(isset(current)&&extidx.indexOf(current)>=0){var wrapCur=Wrap(this.tabs[current].outer_elt);testidx.clear();for(i=0;this.tabs[ts[i].index].outer_elt&&ts[i].index!=current;i++){testidx.push(ts[i].index);}
for(i=testidx.length-1;i>=0;i--){Wrap(this.tabs[testidx[i]].outer_elt).hide();extidx.unshift(testidx[i]);if(wrapCur.bounds(outer).right<=bounds.width-50){wrapCur.css('visibility','visible');extidx.remove(current);break;}}}
if(!extidx.compareTo(this.wrapped_idx)){this.wrapped_idx=extidx;this.updateWrapMenu();}},showHideSections:function(){if(this.manage_sections){var s,info,hide,i;for(s in this.manage_sections){info=this.manage_sections[s];hide=true;if(Array.isArray(info)){for(i=0;i<info.length;i++)
if(info[i]===this.current_tab){hide=false;break;}}
UI.addRemoveClass(s,'hidden',hide);}}
UI.layoutUpdated();},getWrapTab:function(){if(!this.wrap_tab||!UI.inDocument(this.wrap_tab)){this.wrap_tab=this.renderTab('wrap-tab','','uii uii-odots','tab-wrap');this.wrap_tab.style.display='none';if(this.elt)this.elt.firstChild.appendChild(this.wrap_tab);}
return this.wrap_tab;},updateWrapMenu:function(){var idx=this.wrapped_idx,tab,lbl,text,icon,opts={keys:[],values:[]},self=this;for(var i=0;i<idx.length;i++){tab=this.tabs[idx[i]];if(!tab)continue;icon=null;if(isset(tab.label))text=tab.label;else{lbl=this.findIdxLabel(idx[i]);if(lbl)
text=UI.getElementText(lbl);else
text=null;}
if(isset(tab.icon))icon=tab.icon;else
icon=this.findIdxIcon(idx[i],true);opts.keys.push(idx[i]);opts.values.push({icon:icon,label:text,name:tab.name,perform:function(idx,t){self.setValue(t.name);}});}
if(!opts.keys.length)return this.hideWrapMenu();tab=this.getWrapTab();if(tab){if(!this.wrap_menu)this.wrap_menu=UI.registerMenuSource(tab,{icon_key:'icon',target_offset:{top:-1}},this.form);this.wrap_menu.menu.setOptions(new UI.SelectOptions(opts));UI.setDisplayState(this.wrap_tab,true);}},hideWrapMenu:function(){if(this.wrap_tab)
UI.setDisplayState(this.wrap_tab,false);}}
UI.addResizeHook(UI.TabGroup.resizeHandler);UI.ButtonInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;if(params)extendObject(this,params);}
UI.ButtonInput.prototype={setup:function(){if(this.set_up)return;if(!this.elt){if(!(this.elt=$(this.id)))return;}
this.addHooks();this.set_up=true;},addHooks:function(){UI.addEventListener(this.elt,'click',this.handleClick,this);},handleClick:function(evt){UI.stopPropagation(evt);UI.callEvent(this,this.onclick,evt);},focus:function(){if(this.elt)this.elt.focus();},render:function(){if(!this.elt){var body=[];if(this.icon)
body.push(createElement2('div',{className:'input-icon left '+this.icon}));if(this.label)
body.push(createElement2('span',{className:'input-label'},this.label));this.elt=createElement2('button',{type:this.button_type||'button',className:this.className||'input-button',disabled:this.disabled,value:this.value,tabIndex:this.tabIndex||0,title:this.title},body);if(this.autofocus)UI.addClass(this.elt,'autofocus');if(this.style)setAttr(this.elt,'style',this.style);this.setup();}
return this.elt;},destroy:function(){UI.removeNode(this.elt,true);this.elt=null;}};UI.AddressInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;if(params)extendObject(this,params);if(!this.parts)
this.parts={};}
UI.AddressInput.prototype={setup:function(){if(this.set_up)return;if(!this.elt){if(!(this.elt=$(this.id)))return;}
if(!this.copy_elt)
this.copy_elt=$(this.id+'-copy');if(this.copy_elt&&this.copy_to&&!this.menu){var opts={keys:[],values:[]},self=this;if(this.copy_to_rel_contacts){opts.keys.push('');opts.values.push({label:app_string('LBL_NONE'),perform:function(){self.updateCopyTo('','');}});}
for(var i=0;i<this.copy_to.length;i++){var inp=UI.getFormInput(this.form,this.copy_to[i]),copy_from=this.name;if(inp){opts.keys.push(inp.name);(function(sel_id,input,from,copy_rel){opts.values.push({label:inp.getLabel(),perform:function(){if(copy_rel){self.updateCopyTo('','');}input.copyFrom(from);}});})(self.id,inp,copy_from,this.copy_to_rel_contacts)}}
if(this.copy_to_rel_contacts){var copy_targets={primary:'LBL_ADDRESS_COPY_CONTACTS_PRIMARY',alt:'LBL_ADDRESS_COPY_CONTACTS_OTHER',both:'LBL_ADDRESS_COPY_CONTACTS_BOTH'};createElement2('input',{type:'hidden',name:'copy_'+copy_from,id:self.id+'-copy_target'},null,this.form);for(var target in copy_targets){opts.keys.push(target);var lbl=app_string(copy_targets[target]);(function(sel_id,copy_target,label){opts.values.push({label:label,perform:function(){self.updateCopyTo(label,copy_target);if(this.copy_status_id)UI.hideStatus(this.copy_status_id);this.copy_status_id=UI.showStatus(app_string('LBL_ADDRESS_COPY_USER_MSG'),3000);}});})(self.id,target,lbl)}
opts.width='25em';}
this.menu=new UI.MenuSource(this.copy_elt,{options:opts,form:this.form});this.menu.setup();}
if(this.parts&&this.parts['address_country']&&this.parts['address_state']){var inp_c=UI.getFormInput(this.form,this.parts['address_country']),inp_s=UI.getFormInput(this.form,this.parts['address_state']),cname,ccode,self=this;if(inp_c&&inp_s&&inp_c.search_dom=='country_codes'){inp_c.onchange=function(){var ccode=self.lookupCountryCode(this.getValue()),opts=self.popStates(ccode,inp_s),scode;if(opts){scode=self.lookupStateCode(ccode,inp_s.getValue());if(!scode)inp_s.setValue('');}}
inp_c.search_delay=100;inp_c.search_blank=true;ccode=this.lookupCountryCode(inp_c.getValue());this.loadStates(function(){self.popStates(ccode,inp_s);});if(ccode)
inp_s.setSearch(true,'states-'+ccode);}}
this.set_up=true;},popStates:function(code,state_input){var lst;if(code&&UI.country_states&&UI.country_states[code]){lst='states-'+code;App.language.addList(lst,UI.country_states[code]);if(state_input){state_input.search_delay=100;state_input.search_blank=true;state_input.setSearch(true,lst);}
return lst;}else if(state_input){state_input.setSearch(false);}},lookupCountryCode:function(cname){var opts,i;cname=(cname||'').toLowerCase().trim();if(cname.length){opts=App.language.getList('country_codes','app');if(opts){for(i=0;i<opts.values.length;i++){if(opts.values[i].toLowerCase()==cname)return opts.keys[i];}}}},lookupStateCode:function(ccode,sname){var opts,i;if(!UI.country_states||!UI.country_states[ccode])return;sname=(sname||'').toLowerCase().trim();if(sname.length){opts=UI.country_states[ccode];for(i=0;i<opts.values.length;i++){if(opts.values[i].toLowerCase()==sname)return opts.keys[i];}}},updateCopyTo:function(label,value){var msg=Dom.queryId(this.id+'-message').text(label).toggle(!!label);Dom.queryId(this.id+'-copy_target').val(value);},getLabel:function(){return this.label;},getFields:function(){var ret={};for(var k in this.parts)
ret[k]=UI.getFormInput(this.form,this.parts[k]);return ret;},copyFrom:function(other){var other=UI.getFormInput(this.form,other);if(other){var other_fs=other.getFields(),my_fs=this.getFields();var refs={},rest={};for(var k in other_fs){if(my_fs[k]){if(my_fs[k]instanceof UI.RefInput)refs[k]=my_fs[k];else rest[k]=my_fs[k]}}
for(var k in refs)
refs[k].update(other_fs[k].getKey(),other_fs[k].getValue());for(var k in rest)
rest[k].setValue(other_fs[k].getValue());}},loadStates:function(callb){if(isset(UI.country_states)){if(callb)callb();return;}
if(UI.loading_country_states){if(callb)UI.loading_country_states.push(callb);return;}
var req=new App.conn.JSONRequest('get_country_states',{silent:true});UI.loading_country_states=[];if(callb)UI.loading_country_states.push(callb);req.fetch(function(ret){UI.country_states=ret.getResult();if(UI.loading_country_states){for(i=0;i<UI.loading_country_states.length;i++)
UI.loading_country_states[i]();}
UI.loading_country_states=false;});}};UI.QuickElt=function(id,params){if(isElement(id)){this.value_elt=id;this.id=this.value_elt.id;}else
this.id=id;this.elt=null;if(params)extendObject(this,params);}
UI.QuickElt.prototype={setup:function(){if(this.set_up)return;if(!this.value_elt){if(!(this.value_elt=$(this.id)))return;}
var val='';if(this.type=='enum'||this.type=='status'){var opts={'keys':this.options.keys,'values':this.options.values};var select_opts=new UI.SelectOptions(opts);this.elt=new UI.QuickSelect({'options':select_opts,'default':this.default_val,'elt':this.value_elt});val=this.selected;}else if(this.type=='bool'){this.elt=new UI.QuickCheck({});val=this.value;}else{this.elt=new UI.QuickText({show_reset:this.show_reset});val=get_default(this.value,'');}
this.init(this.callback,val);this.set_up=true;},init:function(need_callback,value){if(this.initialized)return;var callback=null;if(need_callback){function ready(){var row=this.getResult();if(row.result=='ok'){var frm=row.list_id+'-ListUpdate';var conn_params={};conn_params.resultDiv=''+row.list_id+'-outer';return UI.sendForm(frm,{"record_perform":"subpanel_render"},conn_params);}
return false;}
callback=ready;}
var params=this;var method=this.callback_method||'save_quick_edit_result';this.elt.init(value,function(reset){var query_params={module:params.module,record:params.record,link_name:params.link_name,target_id:params.target_id,list_id:params.list_id,field:params.field,field_value:this.getValue(),reset:reset?true:false};var req=new App.conn.JSONRequest(method,{status_msg:app_string('LBL_SAVING')},query_params);req.fetch(callback);});this.initialized=true;},show:function(){this.elt.showPopup(null,this.value_elt);if((this.type!='enum'||this.type=='status')&&this.type!='bool'){this.elt.field.format=this.type;if(this.type=='float'||this.type=='double')
this.elt.field.decimals=2;}}};UI.HiddenInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;if(params)extendObject(this,params);}
UI.HiddenInput.findOrInsert=function(form,name,default_id){if(!form||!name)return;var input=UI.getFormInput(form,default_id||name);if(!input){var f=form.elements[name];input=new UI.HiddenInput(f||default_id||name+'-input',{form:form,name:name});var elt=input.render();UI.registerInput(form,input);if(!elt.parentNode)
form.appendChild(elt);}
return input;}
UI.HiddenInput.prototype={setup:function(){if(this.set_up)return;if(!this.elt){if(this.form&&this.name&&(this.elt=this.form.elements[this.name]));else if(!(this.elt=$(this.id)))return;}
this.set_up=true;},getValue:function(){return this.elt?this.elt.value:'';},setValue:function(val,silent){if(this.elt)this.elt.value=val;if(!silent)
UI.callEvent(this,this.onchange,val);},render:function(){if(!this.elt){this.elt=createElement2('input',{id:this.id,name:this.name,type:'hidden',value:this.init_value||''});if(this.form&&this.name)this.form.appendChild(this.elt);this.setup();}
return this.elt;}};UI.FileInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;if(params)extendObject(this,params);}
UI.FileInput.prototype={setup:function(){if(this.set_up)return;if(!this.elt){if(this.form&&this.name&&(this.elt=this.form.elements[this.name]));else if(!(this.elt=$(this.id)))return;}
this.clear_btn=UI.getFormInput(this.form,this.name+'_clear');this.dupe_btn=UI.getFormInput(this.form,this.name+'_dupe');this.addHooks();this.set_up=true;},addHooks:function(){var self=this;UI.addEventListener(this.elt,'change',this.handleChanged,this);if(this.dupe_btn){UI.attachInputEvent(this.dupe_btn,'onchange',function(){self.handleDupeChange()});}
if(this.clear_btn){UI.attachInputEvent(this.clear_btn,'onchange',function(){self.handleClearChange()});}},handleChanged:function(evt){UI.markFormDirty(this);UI.callEvent(this,this.onchange,evt);},handleDupeChange:function(evt){var disable=this.dupe_btn?this.dupe_btn.getValue():0;this.elt.disabled=this.disabled||disable;UI.callEvent(this,this.ondupechange,evt);},handleClearChange:function(evt){var disable=this.clear_btn?this.clear_btn.getValue():0;this.elt.disabled=this.disabled||disable;UI.callEvent(this,this.onclearchange,evt);},focus:function(){if(this.elt)this.elt.focus();},getValue:function(){return this.elt?this.elt.value:'';},setValue:function(file,silent){if(this.elt)this.elt.value=file;if(!silent)UI.callEvent(this,this.onchange);},render:function(){if(!this.elt){this.elt=createElement2('input',{id:this.id,name:this.name,type:'file',className:'input-field input-file'});if(this.form&&this.name)this.form.appendChild(this.elt);this.setup();}
return this.elt;},validate:function(){this.invalid=false;var value=this.getValue();if(this.required&&!trim(value).length){this.invalid=true;this.invalidMsg='required';}
this.updateDisplay();return!this.invalid;},updateDisplay:function(){UI.addRemoveClass(this.elt,'invalid',!!this.invalid);}};UI.RelatedSelectInput=function(id,params){UI.RefInput.call(this,id,params);}
extendClass(UI.RelatedSelectInput,UI.RefInput,{update:function(key,val,silent){if(val){if(!isObject(val))val={id:key,_display:val};val.module=this.getModule();if(this.list_name){var input=UI.getFormInput(this.form,this.list_name);if(input)input.insertRow(val);}}}});UI.EmailFromSelect=function(id,params){UI.SelectInput.call(this,id,params);}
extendClass(UI.EmailFromSelect,UI.SelectInput,{onchange:function(key,val){var e=$(this.id.replace(/-input$/,'-custom'));if(val&&val.custom){UI.setDisplayState(e,true);}else{var from=UI.getFormInput(this.form,'from_name'),addr=UI.getFormInput(this.form,'from_addr');if(from)from.setValue(val?val.from:'');if(addr)addr.setValue(val?val.email:'');UI.setDisplayState(e,false);}}});UI.InviteesList=function(id,params){this.id=id;if(params)extendObject(this,params);}
UI.InviteesList.prototype={setup:function(){if(this.set_up)return;this.outer=$(this.form.id+'-'+this.name);this.set_up=true;this.field=this.form.elements[this.name];this.type_field=this.form.elements[this.type_name];this.add_input=UI.getFormInput(this.form,'add_'+this.name);this.rems=[];this.count=0;if(this.outer&&this.field&&this.type_field){var vals=this.getValues(),self=this;this.count=vals.ids.length;this.addButtons();if(this.add_input){this.add_input.onchange=function(k,v){if(v){self.addRow(v);this.clear();}}}}},getValues:function(){return{ids:this.field.value.split(';'),types:this.type_field.value.split(';')};},setValues:function(v){this.field.value=v.ids.join(';');this.type_field.value=v.types.join(';');this.count=v.ids.length;},addButtons:function(){var self=this,i,rem;for(var i=0;i<this.rems.length;i++)
UI.removeNode(this.rems[i]);this.rems=[];for(var i=0;i<this.count;i++){if(!this.outer.childNodes[i])break;rem=createElement2('div',{className:'input-icon icon-delete active-icon',style:{float:'right'},onclick:function(evt){self.removeRow(this.idx);}});rem.idx=i;this.outer.childNodes[i].appendChild(rem);this.rems.push(rem);}},addRow:function(v){var div=createElement2('div',null,null,this.outer),vals=this.getValues();div.appendChild(UI.createIcon(v._module));div.appendChild(document.createTextNode(' '+v._display));vals.ids.push(v.id);vals.types.push(v._module);this.setValues(vals);this.addButtons();},removeRow:function(idx){this.outer.removeChild(this.outer.childNodes[idx]);var vals=this.getValues();vals.ids.splice(idx,1);vals.types.splice(idx,1);this.setValues(vals);this.addButtons();}};UI.SystemMessage=function(){this.num=UI.SystemMessage.num++;}
UI.SystemMessage.num=0;UI.SystemMessage.show=function(record,mark_seen){var s=new UI.SystemMessage();s.showMessage(record,mark_seen);}
UI.SystemMessage.showList=function(records,mark_seen){if(records&&records.length){var record=records.shift();var s=new UI.SystemMessage();s.showMessage(record,mark_seen,records);}}
UI.SystemMessage.prototype={showMessage:function(record,mark_seen,remain){var query_params={module:'SystemMessages',record:record,mark_seen:get_default(mark_seen,1)};var req=new App.conn.JSONRequest('fetch_system_message',{},query_params);var num=this.num;req.fetch(function(ret){var json;if(ret&&(json=ret.getResult())&&json.status=='ok'){var title='<div class="input-icon theme-icon module-SystemMessages"></div>&nbsp;<span>'
+html_escape(json.result.name)+'</span>';var dlg=new UI.Dialog('sysmsg-'+num,{destroy_on_close:true,min_width:500,min_height:400,title:title});dlg.render();var content=dlg.getContentElement();UI.addClass(content,'panel-outer panel-default panel-border');var div=createElement2('div',{className:'panel-body',style:'padding: 1em 2em'},null,content);div.innerHTML=json.result.body;dlg.onclose=function(){UI.SystemMessage.showList(remain);}
dlg.show();}});}}
UI.Lightbox=function(){this.num=UI.Lightbox.num++;}
UI.Lightbox.num=0;UI.Lightbox.show=function(img,title){var l=new UI.Lightbox();l.showImage(img,title);return l;}
UI.Lightbox.showInput=function(input,file,clear){var l=new UI.Lightbox();l.showImageInput(input,file,clear);return l;}
UI.Lightbox.prototype={showImageInput:function(input,file,clear){this.input=input;this.show_clear=clear;if(file)
this.uploadImage(file,input.label);else
this.showImage(input.path,input.label);},showImage:function(img,title,clear){var t=this,i=(t.image=new Image());t.title=title;t.image_w=t.image_h=null;t.loaded=t.errored=false;i.onload=function(){t.handleLoad();}
i.onerror=function(){t.handleError();}
t.showPopup();if(img)
setTimeout(function(){i.src=img;},0);else
this.handleError();},initDialog:function(){var t=this,content;this.dlg=new UI.Dialog('lightbox-'+this.num,{destroy_on_close:true,min_width:500,min_height:100,tabIndex:0,fill_content:true,onshow:function(){t.visible=true;},onhide:function(){t.visible=false;t.loaded=false;t.image=null;},onclose:function(){t.handleClose();},onresize:function(){t.handleResize();}});this.dlg.render();content=this.dlg.getContentElement();content.style.textAlign='center';this.outer=MakeElt('div.card-outer.panel-outer.panel-default.expand').appendTo(content);if(this.input&&this.input.model&&this.input.field_name){this.edit=MakeElt('div.card-header.panel-subheader.tools-row').appendTo(this.outer);this.renderEdit();}
this.inner=MakeElt('div.card-body.panel-body.panel-pad-body').appendTo(this.outer);},renderEdit:function(){var self=this;if(!this.file){this.file=new UI.FileInput(null,{name:'file'});this.file.onchange=function(){self.uploadImage();}
this.edit.append(MakeElt('div',this.file.render()));}
if(!this.buttons){this.buttons=MakeElt('div').appendTo(this.edit);if(this.show_clear){this.clear_button=new UI.ButtonInput(null,{label:app_string('LBL_IMAGE_CLEAR'),icon:'icon-delete'});this.clear_button.onclick=function(){self.clearImage();}
this.buttons.append(this.clear_button.render());}}},showPopup:function(){if(!this.dlg)this.initDialog();this.dlg.setTitleText(this.title||app_string('LBL_IMAGE'));this.updateImage();if(!this.visible)
this.dlg.show();else
this.dlg.reposition();},close:function(){if(this.dlg)this.dlg.close();},uploadImage:function(file,title){if(isset(title))this.title=title;if(!this.visible)this.showPopup();var req=new App.conn.HTTPRequest(),self=this,attrs=[{name:'model',value:this.input.model},{name:'field',value:this.input.field_name}];req.onupload=function(files){var result;if(files&&files[0]&&files[0].result&&files[0].result.is_image){result=files[0].result;self.upload_result=result;if(self.close_on_upload)
self.dlg.close();else
self.showImage(result.path,self.title);}}
req.addFile(this.file.elt,attrs,file?[file]:null);req.force_revert=req.clear_on_revert=true;req.uploadFiles();},acceptUpload:function(){var u=this.upload_result;if(u&&this.input)this.input.setValue('INCOMING~'+u.id,u.path,u.thumbnail);this.close();},clearImage:function(){if(this.input)this.input.clear();this.close();},updateImage:function(){if(!this.dlg)return;var t=this,href,lnk,b1,b2;UI.clearChildNodes(this.inner);if(this.loaded){href=this.image.src;if(href&&href.indexOf('download.php')>=0)href+="&inline=1";this.inner.html("<div style=\"height: 22px; line-height: 22px\"><div class='input-icon icon-tlink'></div>&nbsp;<a href='"+href+"' target='_blank' class='tabDetailViewDFLink'>"+app_string('LNK_OPEN_IN_NEW_WINDOW')+"</a></div>");this.inner.append(lnk=MakeElt('a',{href:href,target:'_blank'},this.image));if(this.upload_result&&this.upload_result.path){UI.clearChildNodes(this.buttons);b1=new UI.ButtonInput(null,{label:app_string('LBL_ACCEPT_BUTTON_LABEL'),icon:'icon-accept'}),b1.onclick=function(){t.acceptUpload();}
b2=new UI.ButtonInput(null,{label:app_string('LBL_CANCEL_BUTTON_LABEL'),icon:'icon-cancel'});b2.onclick=function(){t.close();}
this.buttons.append(b1.render());this.buttons.append(nbsp());this.buttons.append(b2.render());}}else if(this.errored){}else{this.inner.append(App.util.waitIcon());}
this.dlg.reposition();},handleLoad:function(){this.image_w=this.image.width;this.image_h=this.image.height;if(!this.image_w||!this.image_h)
this.errored=true;else
this.loaded=true;this.handleResize();this.updateImage();},handleError:function(){this.errored=true;this.updateImage();},handleResize:function(){var w=this.image_w,h=this.image_h,outer=UI.getViewport(),s;if(this.dlg&&this.dlg.getFixedSize()){outer=this.dlg.getContentSize();outer.height-=22;}else{outer.width-=100;outer.height-=150;}
if(w&&h&&(w>outer.width||h>outer.height)){this.image.width=Math.min(outer.width,w);this.image.height=h=Math.round(h*this.image.width/w);if(h>outer.height){this.image.height=outer.height;this.image.width=Math.round(this.image.width*outer.height/h);}}},handleClose:function(){if(this.input)this.input.focus();UI.callEvent(this,this.onclose);}};UI.ImageInput=function(id,params){if(isElement(id)){this.elt=id;this.id=this.elt.id;}else
this.id=id;this.width=80;this.height=80;this.drag_focus=0;if(params)extendObject(this,params);}
UI.ImageInput.prototype={setup:function(){if(this.set_up)return;if(!this.elt){if(!(this.elt=$(this.id)))return;}
if(this.name&&this.form){this.field=this.form.elements[this.name];this.clear_field=this.form.elements[this.name+'_clear'];}
else if(this.field_id)
this.field=$(this.field_id);this.inner=this.elt.firstChild;this.hover=createElement2('div',{className:'input-icon icon-popup image-popup-icon'});if(this.inner){this.img=this.inner.firstChild;this.inner.appendChild(this.hover);}
this.positionImage();this.addHooks();this.set_up=true;},positionImage:function(){var h1,h2;if(this.img&&this.inner&&this.img.height){h1=this.img.height;h2=parseInt(this.inner.style.height,10);if(h1&&h2)
this.img.style.marginTop=''+Math.max(0,Math.floor((h2-h1)/2))+'px';}},addHooks:function(){UI.addEventListener(this.elt,'focus',this.handleFocus,this);UI.addEventListener(this.elt,'blur',this.handleBlur,this);UI.addEventListener(this.elt,'keypress',this.keyPress,this);UI.addEventListener(this.elt,'dragenter',this.dragEnter,this);UI.addEventListener(this.elt,'dragleave',this.dragLeave,this);UI.addEventListener(this.elt,'drop',this.dragDrop,this);UI.addEventListener(this.inner,'click',this.handleClick,this);},focus:function(){if(this.elt)this.elt.focus();},handleFocus:function(evt){this.focused=1;this.updateDisplay();},handleBlur:function(evt){this.focused=0;this.updateDisplay();},handleClick:function(evt){if(!this.disabled)this.showPopup();},keyPress:function(evt){if(evt&&evt.charCode==32){if(!this.disabled)this.showPopup();UI.stopEvent(evt);}},showPopup:function(params){UI.Lightbox.showInput(this,(params&&params.file),(this.clear_field&&this.path!=this.clear_path));},setValue:function(value,path,thumb,silent){if(this.field)this.field.value=value;if(this.img&&this.img.parentNode)UI.removeNode(this.img);this.img=new Image();this.path=path;this.thumb=thumb;var self=this,tpath=thumb||path,clearWait=function(){if(self.wait&&self.wait.parentNode)UI.removeNode(self.wait);},posWait=function(){self.wait.style.marginTop=''+Math.floor((self.height-self.wait.offsetHeight)/2)+'px';}
if(!this.wait)
this.wait=App.util.waitIcon();this.img.onload=function(){var w=this.width,h=this.height,rx,ry,r;if(w>self.width||h>self.height){rx=self.width/w;ry=self.height/h;r=Math.min(rx,ry);this.width=(w=Math.round(w*r));this.height=(h=Math.round(h*r));}
clearWait();self.positionImage();self.inner.appendChild(this);}
this.img.onerror=clearWait;if(tpath){this.inner.appendChild(this.wait);this.img.src=tpath;posWait();}
if(!silent)UI.callEvent(this,this.onchange);UI.markFormDirty(this);},clear:function(silent){if(this.clear_field)this.clear_field.value='1';this.setValue('',this.clear_path,this.clear_thumb,silent);},render:function(){if(!this.elt){this.elt=createElement2('div',{className:'image-input',id:this.id});this.field=createElement2('input',{type:'hidden',name:this.name},null,this.elt);this.clear_field=createElement2('input',{type:'hidden',name:this.name+'_clear'},null,this.elt);this.inner=createElement2('div',{className:'image-inner'},null,this.elt);this.inner.style.width=''+this.width+'px';this.inner.style.height=''+this.height+'px';this.setup();}
return this.elt;},updateDisplay:function(){UI.addRemoveClass(this.elt,'active',(this.focused||this.drag_focus)&&!this.disabled);},destroy:function(){UI.removeNode(this.elt,true);this.elt=null;},dragEnter:function(evt){this.drag_focus++;this.updateDisplay();},dragLeave:function(evt){this.drag_focus=Math.max(0,this.drag_focus-1);this.updateDisplay();},dragDrop:function(evt){if(evt&&evt.dataTransfer.files){this.showPopup({file:evt.dataTransfer.files[0]});UI.stopEvent(evt);this.drag_focus=0;}}};UI.attachTeamsUpdate=function(form,fields){var list=UI.getFormInput(form,'teams');if(!list)return;if(!isset(fields))
fields=['assigned_user'];if(fields)
for(var i=0;i<fields.length;i++)
UI.attachFormInputEvent(form,fields[i],'onchange',function(){UI.updateTeamsList(form);});}
UI.updateTeamsList=function(form,form_values,done){UI.fetchUpdatedTeams(form,form_values,function(teams){var list=UI.getFormInput(form,'teams');UI.addRemoveTeams(list,teams);if(done)done();});}
UI.addRemoveTeams=function(list,teams,rev){if(!list||!teams)return;var idx,t;if(!rev&&list.prev_update)
UI.addRemoveTeams(list,list.prev_update,true);if(rev){t=teams.add;teams.add=teams.remove;teams.remove=t;}
if(teams.add){for(idx=0;idx<teams.add.length;idx++){t=teams.add[idx];t.icon='theme-icon module-SecurityGroups';list.addOption(t.id,t,null,true);}}
if(teams.remove){for(idx=0;idx<teams.remove.length;idx++){list.removeOption(teams.remove[idx].id);}}
list.prev_update=teams;}
UI.fetchUpdatedTeams=function(form,form_values,callback){var req=new App.conn.JSONRequest('get_updated_teams'),elt,id;if(!form_values)form_values={};form=UI.getForm(form);if(form){for(id in form.elements){elt=form.elements[id];if(elt.name&&(elt.name=='module'||elt.name=='record'||elt.name.match(/_id$/))&&!isset(form_values[elt.name]))
form_values[elt.name]=elt.value;}}
req.setPostData(form_values);req.fetch(function(ret){var json;if(ret&&(json=ret.getResult())&&json.teams){callback(json.teams);}});};UI.select_options={};UI.all_forms=[];UI.form_inits={};UI.getForm=function(form){if(form&&form.tagName==='FORM')return form;if(typeof(form)=='string'){if(document.forms[form])
form=document.forms[form];else
form=$(form);if(form)return form;}
return false;}
UI.getFormId=function(form){form=this.getForm(form);if(form&&!isString(form))form=form.id;return form?form:null;}
UI.registerSelectOptions=function(name,options){if(options instanceof UI.SelectOptions)
this.select_options[name]=options;else
this.select_options[name]=new UI.SelectOptions(options);}
UI.getSelectOptions=function(dom,module,lang,dupe){var opts;if(dom){if(dom instanceof UI.SelectOptions)
opts=dom;else if(isString(dom)){if(!module&&UI.select_options[dom])
opts=UI.select_options[dom];else if(dom.substring(0,6)=='model.')
opts=App.modelCache.getModelData(dom.substring(6));else{opts=App.language.getList(dom,module,lang);if(opts){opts=new UI.SelectOptions(opts.getOptions());dupe=false;}}}
else if(isPlainObject(dom)){opts=new UI.SelectOptions(dom);dupe=false;}}
if(opts){if(dupe)opts=deep_clone(opts);if(!opts.keys)opts.keys=[];if(!opts.values)opts.values=[];}
return opts;}
UI.global_menus={};UI.menu_groups={};UI.registerMenuSource=function(elt,params,form,group){var m=new UI.MenuSource(elt,params);if(m.id){form=this.getForm(form);if(form){m.form=form;if(!form._regMenus)form._regMenus={};form._regMenus[m.id]=m;}else{UI.global_menus[m.id]=m;}
if(group){if(!this.menu_groups[group])this.registerMenuGroup(group,form,[m.id]);else this.menu_groups[group].entries.push(m.id);}}
m.setup();return m;}
UI.getMenuSource=function(form,name){form=this.getForm(form);if(form&&form._regMenus)return form._regMenus[name];else
return UI.global_menus[name];}
UI.registerMenuGroup=function(grpid,form,entries){form=this.getFormId(form);this.menu_groups[grpid]={form:form,entries:entries};}
UI.getMenuGroupPos=function(form,name){var ret,grp,i,j,c;form=this.getFormId(form);for(i in this.menu_groups){grp=this.menu_groups[i];if(grp.form!=form)continue;for(j=0;j<grp.entries.length;j++){if(grp.entries[j]===name){ret={group:i,pos:j};c=grp.entries.length;if(c>1){ret.prev=this.getMenuSource(grp.form,grp.entries[j>0?j-1:c-1]);ret.next=this.getMenuSource(grp.form,grp.entries[j<c-1?j+1:0]);}
return ret;}}}}
UI.registerInputs=function(form,inputs){var i,inp,reg,c=0,setup=[];form=this.getForm(form);if(form&&inputs&&inputs.length){if(!form._regInputs){form._regInputs={};form._regNames=[];}
for(i=0;i<inputs.length;i++){inp=inputs[i];reg=inp.name||inp.id;if(!reg)
continue;form._regInputs[reg]=inp;form._regNames.push(reg);inp.form=form;c++;}
if(form._inited||form._initing){for(i=0;i<inputs.length;i++){inputs[i].setup&&inputs[i].setup();}}}
return c;}
UI.registerInput=function(form,input){var c=UI.registerInputs(form,[input]);return c?input:false;}
UI.unregisterInputs=function(form,inputs){var c=0;if(inputs&&inputs.length){for(var i=0;i<inputs.length;i++){if(UI.unregisterInput(form,inputs[i]))c++;}}
return c;}
UI.unregisterInput=function(form,input){form=this.getForm(form);if(input&&!isString(input))
input=input.name||input.id;if(form&&input&&form._regInputs&&form._regInputs[input]&&form._regNames){delete form._regInputs[input];form._regNames.remove(input);return true;}
return false;}
UI.getFormInput=function(form,id){form=this.getForm(form);if(form&&form._regInputs)return get_default(form._regInputs[id],null);}
UI.getFormInputs=function(form){form=this.getForm(form);return form?form._regInputs:null;}
UI.getFormInputNames=function(form){form=this.getForm(form);return form&&form._regNames||[];}
UI.focusInput=function(form,id){var input=this.getFormInput(form,id);if(input&&input.focus)input.focus();}
UI.getFormInputProperty=function(form,id,name){var elt=this.getFormInput(form,id);if(elt)return elt[name];}
UI.setFormInputProperty=function(form,id,name,value){var elt=this.getFormInput(form,id);if(elt)elt[name]=value;}
UI.setFormInputValue=function(form,id,value){var form=this.getForm(form),elt=this.getFormInput(form,id);if(elt&&elt.setValue)elt.setValue(value);else if(!elt&&form&&form.elements[id])form.elements[id].value=value;}
UI.setFormInputValues=function(form,value_map){if(!value_map)return;var form=this.getForm(form),elt,key,value,id_name;for(var id in value_map){elt=this.getFormInput(form,id);value=get_default(value_map[id],'');if(elt instanceof UI.RefInput){id_name=elt.key_name;if(id_name&&id_name in value_map){key=get_default(value_map[id_name],'');elt.update(key,value);}}
else if(elt&&elt.setValue)elt.setValue(value);else if(!elt&&form&&form.elements[id])form.elements[id].value=value;}}
UI.initForm=function(form,inputs,postInit,focus){form=UI.getForm(form);if(!form)return;form._initing=true;if(inputs)
UI.registerInputs(form,inputs);UI.checkFormInits(form);var allInputs=UI.getFormInputs(form);if(allInputs){for(var k in allInputs){allInputs[k].form=form;if(allInputs[k].setup)
allInputs[k].setup();}}
if(postInit)
UI.onInitForm(form,postInit);form._inited=true;form._initing=false;UI.tidyForms();UI.all_forms.push(form);if(form._postInit)
UI.callEvent(form,form._postInit,form);}
UI.focusForm=function(form,controls,handler){var p=UI.PopupManager.getLoadingPopup();if(p){if(isIPhone)return;UI.attachInputEvent(p,'onshow',function(){UI.focusForm(form,controls,handler);});return;}
form=UI.getForm(form);var doFocus=function(cs,reqd,blank){if(!cs)return;var i,c;for(i=0;i<cs.length;i++){c=UI.getFormInput(form,cs[i]);if(c&&c.focus&&(!reqd||c.required)){if(blank){if(c.isBlank){if(!c.isBlank())continue;}else if(c.getValue){if(c.getValue())continue;}}
try{c.focus();}catch(e){console.error(e);}
return true;}}}
if(handler){p=UI.callEvent(form,handler,form);if(p!==false)return true;}
var ns=UI.getFormInputNames(form);return doFocus(controls)||
doFocus(ns,true,true)||
doFocus(ns,false,true)||
doFocus(ns)||
(form.focus&&form.focus());}
UI.tidyForms=function(){var remain=[];for(var i=0;i<UI.all_forms.length;i++){if(!UI.inDocument(UI.all_forms[i])&&!UI.PopupManager.inRenderedPopup(UI.all_forms[i]))
UI.destroyForm(UI.all_forms[i]);else
remain.push(UI.all_forms[i]);}
UI.all_forms=remain;}
UI.destroyForm=function(form){form=UI.getForm(form);var inputs=UI.getFormInputs(form),inp;if(inputs){for(var k in inputs){inp=inputs[k];if(inp.form===form){if(inp.destroy)inp.destroy();delete inp.elt;delete inp.field;delete inp.form;}}}
if(isset(form._regInputs))delete form._regInputs;if(isset(form._regMenus))delete form._regMenus;if(form._destroy)
UI.callEvent(form,form._destroy,form);}
UI.checkFormInits=function(form){var form_id=form.id||form.name;if(form_id&&UI.form_inits[form_id]){if(form._postInit)
form._postInit.pushArray(UI.form_inits[form_id]);else
form._postInit=UI.form_inits[form_id];delete UI.form_inits[form_id];}}
UI.onInitForm=function(form_name,handler){if(!handler)return false;var form=UI.getForm(form_name);if(!form){if(typeof(form_name)=='string'){if(!UI.form_inits[form_name])
UI.form_inits[form_name]=[];UI.form_inits[form_name].push(handler);return true;}
return false;}
UI.checkFormInits(form);if(form._inited)
UI.callEvent(form,handler,form);else if(form._postInit)
form._postInit.push(handler);else
form._postInit=[handler];return true;}
UI.onDestroyForm=function(form_name,handler){var form=UI.getForm(form_name);UI.attachInputEvent(form,'_destroy',handler);}
UI.validateForm=function(form){var valid=true,allInputs=UI.getFormInputs(form),lbl,messages=[];if(allInputs){for(var k in allInputs){if(allInputs[k].validate){try{if(!allInputs[k].validate()){valid=false;lbl=allInputs[k].getLabel?allInputs[k].getLabel():allInputs[k].label;messages.push({name:k,label:lbl,message:allInputs[k].invalidMsg});}}catch(e){valid=false;console.error('error validating '+k,e);}}}}
return{status:valid,messages:messages};}
UI.validationSummary=function(rows){var missing=[],invalid=[],other=[],ret=[],show,i;if(rows){for(i=0;i<rows.length;i++){show=rows[i].label||rows[i].name;if(rows[i].message==='required')
missing.push(show);else if(rows[i].message==='invalid'||!rows[i].message)
invalid.push(show);else
other.push(''+show+': '+rows[i].message);}}
if(missing.length)
ret.push(app_string('ERR_MISSING_REQUIRED_FIELDS')+': '+missing.join(', '));if(invalid.length)
ret.push(app_string('ERR_INVALID_VALUE')+': '+invalid.join(', '));ret.pushArray(other);return ret.join("\n");}
UI.alertInvalidForm=function(vresult){alert(UI.validationSummary(vresult.messages));}
UI.submitForm=function(form){var elt,i=0;form=UI.getForm(form);if(form){for(;i<form.elements.length;i++){elt=form.elements[i];if(elt.type==='submit'&&elt.click)return elt.click();}
if(form.onsubmit&&form.onsubmit()===false)return false;return form.submit();}}
UI.updateForm=function(form,field_params){var restore={},v,i,field;form=UI.getForm(form);if(!form)return null;if(field_params){for(var k in field_params){v=field_params[k];field=form.elements[k];if(field&&field.length){var arest=[];for(i=0;i<field.length;i++)
arest.push(field[i].value);restore[k]=arest;for(i=field.length-1;i>0;i--)
UI.removeNode(field[i]);field=field[0];}else if(field){restore[k]=field.value;}else{restore[k]=null;}
if(!isset(v)){if(field)UI.removeNode(field);delete field;}
else if(Array.isArray(v)){if(field)UI.removeNode(field);delete field;for(i=0;i<v.length;i++){field=createElement2('input',{name:k,type:'hidden',value:v[i]});form.appendChild(field);}}
else{if(!field){field=createElement2('input',{name:k,type:'hidden',value:v});form.appendChild(field);}
field.value=v;}}}
return restore;}
UI.cancelEdit=function(form,evt){form=UI.getForm(form);if(!form)return false;if(form.in_popup&&form.in_popup.value){App.popups.close();return false;}
UI.clearCall();if(form.return_url&&form.return_url.value){App.util.navigateTo(form.return_url.value,evt,{ignoredirty:true});}
else if(form.return_module&&form.return_module.value){var ret_mod=form.return_module.value,ret_act,ret_rec,ret_lay;if(form.return_action)ret_act=form.return_action.value;if(form.return_record)ret_rec=form.return_record.value;if(form.return_layout)ret_lay=form.return_layout.value;if(!ret_act||(ret_act=='DetailView'&&!ret_rec))ret_act='index';App.util.navigateTo({module:ret_mod,action:ret_act,record:ret_rec,layout:ret_lay},evt,{ignoredirty:true});}
else if(form.module&&form.module.value){UI.returnToList(form);}
return false;}
UI.returnToList=function(form,evt){form=UI.getForm(form);if(!form)return false;if(form.module&&form.module.value){App.util.navigateTo({module:form.module.value,action:'index'},evt,{ignoredirty:true});}}
UI.createDuplicateFrom=function(form,target_module,target_id,link_name,param_name){form=UI.getForm(form);if(!form)return false;var mod=form.module.value,act=form.action.value,layout=form.layout.value,rec_id=form.record.value,action=target_id?'Duplicate':'EditView',url='index.php?module='+target_module+'&action='+action+'&record='+target_id+
'&return_module='+mod+'&return_action='+act+'&return_record='+rec_id+'&return_layout='+layout;if(link_name)
url+='&return_panel='+link_name;if(param_name)
url+='&'+param_name+'='+rec_id;App.util.navigateTo(url);}
UI.applyFormInputsHook=function(form,method){form=UI.getForm(form);var allInputs=UI.getFormInputs(form);if(allInputs){for(var k in allInputs){if(allInputs[k][method]){try{var result=allInputs[k][method](form);if(typeof(result)!='undefined'&&!result)return false;}catch(e){console.error('error in '+method+' '+k,e);return false;}}}}
return true;}
UI.beforeDetachForm=function(form){return UI.applyFormInputsHook(form,'beforeDetachForm');}
UI.beforeRestoreForm=function(form){return UI.applyFormInputsHook(form,'beforeRestoreForm');}
UI.beforeSubmitForm=function(form){return UI.applyFormInputsHook(form,'beforeSubmitForm');}
var preUpload=function(form,complete){var req=new App.conn.HTTPRequest();var hasFiles=false;req.onupload=function(files){var result;complete();}
for(var i=0;i<form.elements.length;i++){var elt=form.elements[i];if(elt.type=='file'&&elt.value){req.addFile(elt,{},null);hasFiles=true;}}
if(hasFiles){req.uploadFiles();}else{complete();}};UI.sendForm=function(form,field_params,conn_params,target,from_popup){var result,restore,restore_params,vresult,req;form=UI.getForm(form);if(!form)return null;if(!conn_params)conn_params={};if(field_params&&isObject(field_params)){if(!field_params.format)
field_params.format='html';}
if(SUGAR.session.request_method=='POST'){if(!target&&!conn_params.receiveCallback&&get_default(conn_params.resultDiv,'content-main')=='content-main'){target=true;}}
if(target){restore_params=UI.updateForm(form,field_params);restore={action:form.getAttribute('action'),target:form.getAttribute('target')};if(conn_params.url)
form.action=conn_params.url;else if(form.getAttribute('method')=='POST')
form.action='index.php';if(target===true)target='_self';form.target=target;}
vresult=UI.checkForm(form,conn_params.no_validate);if(isdef(vresult))return vresult;if(target){var complete=function(){if(Get_Cookie('ANDROID_APP'))
form.target='_self';form.submit();setTimeout(function(){setAttrs(form,restore);UI.updateForm(form,restore_params);},0);};preUpload(form,complete);return false;}else{App.session.setLoadingState(null,null,true);}
if(!conn_params.status_msg){var perform;if(field_params&&field_params.record_perform)
perform=field_params.record_perform;else if(form.elements.record_perform)
perform=form.elements.record_perform.value;else if(form.elements.list_layout_perform)
perform=form.elements.list_layout_perform.value;if(perform=='save'){conn_params.status_msg=app_string('LBL_SAVING');}
else if(perform=='validate'){conn_params.status_msg=app_string('LBL_VALIDATING');}}
if(from_popup){if(!conn_params.popupDialog)
conn_params.popupDialog=window.popup_dialog||App.popups.getCurrent();if(field_params&&field_params.reload_after)
conn_params.reloadAfter=1;if(field_params&&field_params.close_popup)
conn_params.closePopup=1;}
if(!isset(conn_params.resultDiv)){if(conn_params.popupDialog)
conn_params.resultDiv=conn_params.popupDialog.getContentElement();else
conn_params.resultDiv='content-main';}
if(conn_params.resultDiv&&!conn_params.disableMask)
conn_params.maskId=App.util.maskDiv(conn_params.resultDiv);form._sending=true;req=App.conn.sendForm(form,conn_params,UI.receiveForm,UI.failForm,field_params);App.session.setLoadingRequest(req);return false;}
UI.arrangeDetailTabs=function(module,id){var dlg=new SUGAR.ui.Dialog('arrangeDetailTabs');var vars={postData:{module:'NewStudio',action:'index',wizard:'ArrangeTabs',record:id,layout_module:module}};dlg.fetchContent('async.php',vars,null,true);};UI.checkForm=function(form,no_validate){var result;form=UI.getForm(form);if(!no_validate&&!(result=UI.validateForm(form)).status){UI.alertInvalidForm(result);return false;}
result=UI.beforeSubmitForm(form);if(isdef(result)&&!result)return false;UI.clearCall();UI.markFormDirty(form,false);}
UI.failForm=function(result,conn){if(this.sentForm)this.sentForm._sending=false;App.session.setLoadingRequest(null);if(this.maskId){App.util.hideMask(this.maskId);}
if(conn&&conn.failure_msg)
UI.Status.show(conn.failure_msg,4000);}
UI.receiveForm=function(result){var req=this;var done=function(){App.session.setLoadingRequest(null);}
if(req.sentForm)req.sentForm._sending=false;if(result){var div,body=req.responseText,cb_ret,doScroll,noDisplay=body.indexOf('<script nodisplay>')>=0;if(req.resultDiv)div=$(req.resultDiv);if(div&&!noDisplay){div.innerHTML=App.util.disableInlineScripts(body);doScroll=!req.noScrollTo}
App.util.evalScript(body,function(){if(req.receiveCallback)
cb_ret=req.receiveCallback(result);if(req.popupDialog&&(req.closePopup||req.reloadAfter||noDisplay)&&!cb_ret){req.popupDialog.close();doScroll=false;}
if(req.reloadAfter&&!cb_ret){setTimeout("document.location.reload(true)",200);doScroll=false;}
if(doScroll)
App.util.scrollToElement(div);done();});}
else{console.error('retrieve failed');if(req.maskId){App.util.hideMask(req.maskId);}
done();}}
UI.FormRender=function(params){this.style='';this.card=false;this.tagName='form';if(params)extendObject(this,params);this.render();}
UI.FormRender.prototype={render:function(){if(!this.elt){var cls='form-outer'+(this.card?' card-outer':'');if(this.style)cls+=' '+this.style;if(this.ext_class)cls+=' '+this.ext_class;this.elt=MakeElt(this.tagName,{id:this.id,'class':cls});}
if(!this.body){this.body=MakeElt('div.form-body'+(this.card?'.card-body':'')).appendTo(this.elt);}
return this.elt;},addButtons:function(buttons,params){if(!params)params={};if(!isset(params.card))params.card=this.card;if(!isset(params.form)&&this.tagName==='form')params.form=this.elt.get();params.buttons=buttons;var sect=new UI.FormButtons(params);this.elt.append(sect.elt);return sect;},addSection:function(params){var sect=new UI.FormSection(params);this.body.append(sect.elt);return sect;}};UI.FormSection=function(params){if(params instanceof UI.FormSection)return params;this.columns=1;var fields;if(params){fields=params.fields;delete params.fields;extendObject(this,params);}
this.render();if(fields){this.addFields(fields);}}
UI.FormSection.prototype={render:function(){if(!this.elt){this.elt=MakeElt('div.form-section');}},addRow:function(params){return MakeElt('div.row.form-row').appendTo(this.elt);},renderEntry:function(params){if(!params)params={};var cell,entry;cell=MakeElt('div.column.form-cell');entry=MakeElt('div.form-entry').appendTo(cell);if(params.label){entry.append(MakeElt('div.form-label').html(params.label));}
if(params.value){entry.append(MakeElt('div.form-value').html(params.value));}
return cell;},addFields:function(fields){var col=0;var row,field,cell,cpar,entry;for(var i=0;i<fields.length;i++){field=fields[i];cpar={label:field.label,value:field.value};if(field.input){if(!('label'in field))
cpar.label=field.input.label;cpar.value=field.input.render();field.input.setup();}
else if(field.render){cpar.value=field.render();field.setup();}
cell=this.renderEntry(cpar);if(!row)
row=this.addRow();row.append(cell);if(++col>=this.columns)
row=null;}}};UI.FormButtons=function(params){if(params instanceof UI.FormButtons)return params;var buttons,columns;if(params){buttons=params.buttons;delete params.buttons;columns=params.columns;delete params.columns;extendObject(this,params);}
this.render();if(columns){this.addColumns(columns);}
else if(buttons){this.addButtons(buttons);}}
UI.FormButtons.prototype={render:function(){if(!this.elt){this.elt=MakeElt(
'div.form-buttons'+(this.card?(this.footer?'.card-footer':'.card-header'):''));}
this.addRow();},addRow:function(params){this.row=MakeElt('div.row.buttons-row').appendTo(this.elt);return this.row;},addColumns:function(params){if(Array.isArray(params)){for(var idx=0;idx<params.length;idx++)
this.addColumn(params[idx]);}},addColumn:function(params){if(!params)params={};var align=params.align||this.align||'left',cls=params.className||'column buttons-inline align-'+align;elt=MakeElt('div',{'class':cls}).appendTo(this.row);if(params.buttons){this.addButtons(params.buttons,{column:elt});}
return elt;},addButtons:function(buttons,params){if(!params)params={};var column=params.column||this.addColumn({align:params.align});if(Array.isArray(buttons)){for(var idx=0;idx<buttons.length;idx++){var btn=this.renderButton(buttons[idx]);MakeElt('div.inline-elt',btn).appendTo(column);}}},renderButton:function(params){var btn;if(params instanceof UI.ButtonInput)
btn=params;else
btn=new UI.ButtonInput(null,params);if(this.form)UI.registerInput(this.form,btn);return btn.render();},makeIcon:function(name){if(~name.indexOf('uii'))return MakeElt('span',{'class':name});else return MakeElt('div',{'class':'input-icon '+name});}};UI.callEvent=function(elt,handler){if(arguments.length>2){var args=Array.prototype.slice.call(arguments,2);return UI.applyEvent(elt,handler,args);}else
return UI.applyEvent(elt,handler);}
UI.applyEvent=function(elt,handler,args){if(!handler)return;if(!args)args=[];if(isString(handler)){var f=resolveVar(handler);if(!f)
f=new Function(handler);return f.apply(elt,args);}else if(Array.isArray(handler)){var ret;for(var i=0;i<handler.length;i++)
ret=UI.applyEvent(elt,handler[i],args);return ret;}else if(handler.apply)return handler.apply(elt,args);}
UI.attachFormInputEvent=function(form,id,evt_name,handler){var ctl=UI.getFormInput(form,id);if(ctl)return UI.attachInputEvent(ctl,evt_name,handler);}
UI.attachInputEvent=function(input,evt_name,handler){if(typeof(input)!='object'||!input||!handler)return false;if(Array.isArray(handler)){var ret=true,i;for(i=0;i<handler.length;i++)
ret|=UI.attachInputEvent(input,evt_name,handler[i]);return ret;}
else if(input[evt_name]&&input[evt_name].push)
input[evt_name].push(handler);else if(input[evt_name])
input[evt_name]=[input[evt_name],handler];else
input[evt_name]=[handler];return true;}
UI.changeLayout=function(form,layout){return UI.sendForm(form,{layout:layout,format:'html'});}
UI.copyAddress=function(form,from_addr,to_addr){var inp=UI.getFormInput(form,to_addr);if(inp)inp.copyFrom(from_addr);}
UI.openQuickCreate=function(module,params,callback){var c=0;for(;UI.getForm('QuickCreateForm_'+c);c++){}
var query='mgr_type=quick_create&record_perform=edit&qc_count='+c+'&';query=encodeQueryString(params,query);if(module=='Booking'&&isset(params.return_module))
query+='&related_type='+params.return_module;App.session.quick_create_callback=callback;return UI.openEditPopup(module,query);}
UI.openCallLogging=function(params){var query='mgr_type=call_logging&record_perform=edit&';query=encodeQueryString(params,query);return UI.openEditPopup('Calls',query);}
UI.openEditPopup=function(module,query,record){var options={module:module,action:'EditView',inline:true,query_string:query,width:module=='Emails'?850:750,min_height:100};if(record)options.filter={record:record};return open_popup_window(options);}
UI.saveQuickCreate=function(form,view_after,params){function ready(result){var popup_elt=result.popupDialog.elt;popup_elt.visibility='hidden';result.popupDialog.loadContent(result.responseText,function(){if(App.session.quick_create_result){App.popups.close();if(App.session.quick_create_callback){App.session.quick_create_callback(App.session.quick_create_record,App.session.quick_create_name);App.session.quick_create_callback=null;}else if(!view_after)
UI.refreshTarget(params.target_name,params.target_id);delete App.session.quick_create_result;}else{popup_elt.style.visibility='normal';}},false);return true;}
try{return UI.sendForm(form,{record_perform:"save",go_to_view:view_after},{receiveCallback:ready},false,true);}catch(e){console.error(e);return false;}}
UI.authorizeCard=function(form){var ready=function(result){}
try{return UI.sendForm(form,{record_perform:"save"},{receiveCallback:ready},false,true);}catch(e){console.error(e);return false;}}
UI.refreshTarget=function(target_name,target_id,callback){if(target_name=='subpanel'){var frm=target_id+'-ListUpdate';var conn_params={resultDiv:''+target_id+'-outer',receiveCallback:callback};return!UI.sendForm(frm,{"record_perform":"subpanel_render"},conn_params);}else if(target_name=='subpanel_by_name'){var ids;if(!Array.isArray(target_id))
ids=target_id.split(',');else
ids=target_id;for(var i=0;i<ids.length;i++)
sugarListView.reloadSubpanel(ids[i]);}else if(target_name=='listview'){sListView.navigate(target_id);}else if(target_name=='DetailForm'){var frm=UI.getForm('DetailForm');if(frm&&frm.action.value=='DetailView'&&(!frm.record_perform||frm.record_perform.value=='view'||frm.record_perform.value=='edit')){var conn_params={resultDiv:'content-main',receiveCallback:callback};return!UI.sendForm(frm,{},conn_params);}}
return false;}
UI.loadFullForm=function(form,params){var field_params={record_perform:'edit','mgr_type':'',action:'EditView',in_popup:0};if(!form[params.primary_name]||!form[params.primary_name].value)
field_params[params.primary_name]=params.primary_value;if(params.hasOwnProperty('module'))
field_params.module=params.module;if(params.target_layout!='')
field_params.layout=params.target_layout;else if(!params.target_layout)
field_params.layout='';if(params.return_record){field_params.return_record=params.return_record;field_params.return_module=params.return_module;field_params.return_action=params.return_action||'DetailView';}
function ready(){App.popups.close();}
try{return UI.sendForm(form,field_params,{no_validate:true,receiveCallback:ready},true);}catch(e){console.error(e);return false;}}
UI.clearCall=function(){clearTimeout(UI.call_out_timer);UI.call_out_timer=null;UI.call_out_timer=null;UI.call_button_label=null;};UI.makeCall=function(form,type,button,edit){var number='';var number_inp=UI.getFormInput(form,'phone_number');if(number_inp){number=number_inp.getValue();}else if(document.DetailForm.phone_number){number=document.DetailForm.phone_number.value;}
if(this.call_out_timer){clearTimeout(this.call_out_timer);var b=document.getElementById(button.id+'-label');if(b&&this.call_button_label){b.innerText=this.call_button_label;}
this.call_out_timer=null;this.call_button_label=null;var delta=(new Date()).getTime()-this.call_start_time.getTime();if(!edit){var dt=this.call_start_time;var startText=dt.print(getDateFormat().print_format)+' '+dt.print(getTimeFormat().print_format);if(confirm(app_string('LBL_CALL_OUT_CONFIRM')))
UI.sendForm(form,{"record_perform":"save","status":"Held","date_start":startText,"duration":(delta/60000).toFixed(0)},null);}else{var status_sel=UI.getFormInput(form,'status');if(status_sel)
status_sel.setValue('Held');var duration_input=UI.getFormInput(form,'duration');if(duration_input)
duration_input.setValue((delta/60000).toFixed(0));var date_input=UI.getFormInput(form,'date_start');if(date_input)
date_input.setValue(this.call_start_time);}}else if(number.match(/^[+0]/)){var status_sel=UI.getFormInput(form,'status');if(status_sel)
status_sel.setValue('Held');this.call_start_time=new Date();clearTimeout(this.call_out_timer);var b=document.getElementById(button.id+'-label');if(b){this.call_button_label=b.innerText;}
var self=this;var callTimer=function(){if(button){var b=document.getElementById(button.id+'-label');if(b){var delta=((new Date()).getTime()-self.call_start_time.getTime())/1000;var hours=''+parseInt(delta/3600);var minutes=''+parseInt(delta%3600/60);var seconds=''+parseInt(delta%60);if(seconds.length<2)
seconds='0'+seconds;var text=minutes+':'+seconds;if(hours>0){if(minutes.length<2)
text='0'+text;text=hours+':'+text;}
b.innerText='['+text+']';}}
self.call_out_timer=setTimeout(callTimer,1000);};this.call_out_timer=setTimeout(callTimer,300);if(type=='tel'){return App.util.loadUrl('tel:'+number.replace(/[ \(\)\-\.]/g,''),false);}else if(type=='skypeout'){return App.util.loadUrl('skype:'+number.replace(/[ \(\)\-\.]/g,''),false);}else if(type=='ringcentral'){return RingCentral.initiateCall(number);}else if(type=='cti'){App.conn.asyncRequest('cti/placeCall.php?phoneNr='+encodeURIComponent(number));return true;}else{return false;}}else{alert(app_string('ERR_WRONG_PHONE_NUMBER'));}}
UI.quickEdit=function(params,evt){var edit_elt=new UI.QuickElt(params.id,params);edit_elt.setup();edit_elt.show();if(evt)UI.stopEvent(evt);}
UI.setupEmailParentsMenu=function(form_id,target_id,options,record_id){UI.registerMenuSource(target_id,{icon_key:'icon'},form_id);var menu_button=UI.getMenuSource(form_id,target_id);if(!menu_button||!menu_button.menu)return;UI.attachInputEvent(menu_button,'onchange',function(k){var url='index.php?module='+k+'&action=EditView&return_module=Emails&return_action=index&return_record='+record_id+'&return_layout=Standard&return_panel='+k.toLowerCase()+'&email_id='+record_id;return App.util.navigateTo(url)});menu_button.menu.setOptions(new UI.SelectOptions(options));}
UI.isPrimaryForm=function(form){var parent;form=UI.getForm(form);if(!form)return;if(UI.inDocument(form)&&form.getAttribute('name')=='DetailForm'){parent=form.parentNode;while(parent&&parent!==window){if(parent.id=='content-main')return true;parent=parent.parentNode;}}}
UI.markFormDirty=function(elt,flag){if(!elt||elt.ignore_dirty)return;var form=UI.getForm(elt.form||elt),oldf,t,parent,primary;if(!form||form._sending)return;oldf=form._dirty;form._dirty=get_default(flag,true);if(form._dirty!=oldf&&form._postDirty)
UI.callEvent(form,form._postDirty,form,form._dirty);if(UI.isPrimaryForm(form)){t=App.util.getPageTitle()||'';if(t.match(/^\* /)){if(!form._dirty)App.util.setPageTitle(t.substring(2));}else if(form._dirty){App.util.setPageTitle('* '+t);}}}
UI.checkFormDirty=function(form){var form=UI.getForm(form);if(form)return form._dirty;}
UI.addToFavorites=function(elt,module,record_id){if(!UI.hasClass(elt,'checked')){UI.addClass(elt,'checked');elt.title=app_string('LBL_REMOVE_FROM_FAVORITES','Favorites');}else{UI.removeClass(elt,'checked');elt.title=app_string('LBL_ADD_TO_FAVORITES','Favorites');}
if(module&&record_id){var query_params={record_module:module,record_id:record_id,module:'Favorites'};var req=new App.conn.JSONRequest('add_to_favorites',{silent:true},query_params);req.fetch(function(){});return true;}else{return false;}}
UI.arrangeSubpanels=function(module,id){var tabs=UI.getFormInput('DetailForm','layout_tab');open_popup_window({module:'NewStudio',action:'index',filter:{wizard:'ArrangeSubpanels',edit_module:module,tab:tabs?tabs.getValue():'Standard',record_id:id},inline:true});}
UI.layoutTabUpdated=function(tabs){if(!tabs)return;var tab=tabs.getValue(),query;var theTab=tabs.getTab(tab);if(!theTab.editing)
sugarListView.loadSubpanels(tabs.form);var state=App.session.getState();if(state&&state.query){var m=state.query.match(/^(.*?&layout_tab=)([^&]*)(.*)$/);if(m)query=m[1]+encodeURIComponent(tab)+m[3];else query=state.query+'&layout_tab='+encodeURIComponent(tab);App.session.replaceState(query,state.context,state.vars);}}
UI.toggleExpandList=function(id,link){var elt=$(id),new_state;if(elt){new_state=!UI.hasClass(elt,'compact');UI.addRemoveClass(elt,'compact',new_state);if(link)
UI.setElementText(link,app_string(new_state?'LBL_LIST_SHOW_MORE':'LBL_LIST_SHOW_LESS'));}}
UI.initConditionalFields=function(conditional){this.conditional_fields=conditional;};UI.showStatus=function(msg,timeout){return UI.Status.show(msg,timeout);};UI.hideStatus=function(s){return UI.Status.remove(s);};UI.record_link_idx=0;UI.makeRecordLink=function(module,id,name,no_popup,context){var params={module:module,action:'DetailView',record:id},ret;if(!id)return MakeElt('span',name);ret=MakeElt('a.tabDetailViewDFLink',{href:encodeQueryString(params,'index.php?')},name).on('click',SUGAR.util.handleLink);if(!no_popup){var info_id='record-link-'+(UI.record_link_idx++);ret.prop('id',info_id);if(!isset(context))context='view';ret.on('mouseout, mousedown',function(){SUGAR.util.clearAdditionalDetailsCall();}).on('mouseover',function(){return SUGAR.util.getAdditionalDetails(module,id,info_id,null,context,750);});}
return ret;};});AppBase.module('popups').moduleRequires('ui-controls').init({known:{},reposition:function(){SUGAR.ui.PopupManager.reposition();},close:function(popup){return SUGAR.ui.PopupManager.close(popup);},getCurrent:function(){return SUGAR.ui.PopupManager.last_opened;},openUrl:function(url,conn_params,dlg_params,hooks){var d=new SUGAR.ui.Dialog(null,dlg_params);if(hooks&&hooks.show)
d.onshow=hooks.show;if(hooks&&hooks.close)
d.onclose=hooks.close;d.render();d.fetchContent(url,conn_params,null,true);popup_dialog=d;return d;},openForm:function(form,form_values,conn_params,dlg_params){var d=new SUGAR.ui.Dialog(null,dlg_params);d.render();d.fetchFormContent(form,form_values,conn_params,null,true);popup_dialog=d;return d;},getKnown:function(popup){var p=this.known[popup];if(!p)return;if(!p.elt||!SUGAR.ui.inDocument(p.elt)){this.known[popup]=null;return;}
return p;},showPopup:function(tg,popup,offset,delay,hooks,popup_params){if(!(popup instanceof SUGAR.ui.Popup)){popup=$(popup);if(!popup)return;var p;if(popup.id&&(p=this.getKnown(popup.id))){popup=p;popup.target=tg;popup.target_offset=offset;if(hooks&&hooks.show)
popup.onshow=hooks.show;}
else{var params={target:tg,target_offset:offset,destroy_on_close:false};if(popup&&SUGAR.ui.inDocument(popup)){params.keep_in_document=true;}
if(popup_params)extendObject(params,popup_params);popup=new SUGAR.ui.Popup(popup,params);if(hooks&&hooks.show)
popup.onshow=hooks.show;this.known[popup.id]=popup;if(!popup.elt.id)
popup.elt.id=popup.id;}}
else{if(tg)
popup.target=tg;if(offset)
popup.target_offset=offset;if(hooks&&hooks.show)
popup.onshow=hooks.show;}
popup.show(delay);},hidePopup:function(popup){SUGAR.popups.close(popup);},attachPopup:function(tg,popup,params){if(!params)params={};var show=function(){if(!params.require_click){var p=SUGAR.ui.PopupManager.last_opened;if(p&&!p.modal&&!p.close_on_exit)return;}
SUGAR.popups.showPopup(tg,popup,params.offset,params.delay,params.hooks);return false;}
tg=$(tg);if(!tg)return false;if(isIPhone)
params.require_click=true;if(params.require_click){params.delay=0;$(tg).onclick=show;}else
$(tg).onmouseenter=show;return true;},hiliteItem:function(menuItem,changeClass){if(changeClass)
SUGAR.ui.addClass(menuItem,'hilite');},unhiliteItem:function(menuItem){SUGAR.ui.removeClass(menuItem,'hilite');},quickShow:function(content,title,target,params){if(!params)params={};if(!title){params.have_title_bar=false;params.draggable=false;}else
params.title=title;if(target)
params.target=target;var d=new SUGAR.ui.MiniDialog(null,params);if(isNode(content))
d.content_elt=content;else if(isset(content))
d.setContent(content);d.render()&&d.show();return d;},tooltip:function(param,target){var params;if(typeof(param)=='object')
params=deep_clone(param);else
params={content:param};if(!isset(params.destroy_on_close))
params.destroy_on_close=true;if(target)
params.target=target;params.pre_triggered=true;var t=new SUGAR.ui.Tooltip(null,params);},initContent:function(params){SUGAR.ui.PopupManager.initContent(params);},setTitle:function(title){var c=SUGAR.popups.getCurrent();if(c&&c.setTitle)c.setTitle(title);},setTitleHtml:function(title){var c=SUGAR.popups.getCurrent();if(c&&c.setTitleHtml)c.setTitleHtml(title);},showMessage:function(text,title,options){if(title&&typeof(title)!=='string'){options=title;title=null;}
if(!options)options={};var id=options.id||options.name,UI=SUGAR.ui,title_text=options.title||title,have_title=title_text||options.title_html||options.have_title_bar,dlg=new UI.PopupMessage(id,{have_title_bar:have_title,invis_mask:!options.show_mask,onclose:options.onclose,show_popup_close:options.close_button,timeout:options.timeout,title:options.title_html,title_text:title_text,width:options.width||600}),content=options.content,onaccept=function(){dlg.close();if(options.onaccept)options.onaccept(this);else if(options.url){SUGAR.util.navigateTo(options.url);}},oncancel=function(){dlg.close();if(options.oncancel)options.oncancel(this);},form,value,label;if(!content){form=new UI.FormRender({card:true,style:'default-form'});content=form.render();value=get_default(
options.html,html_escape(trim(text)).replace(/\r?\n/g,'<br>'));value='<div class="message-content">'+value+'</div>';if(options.icon)
value='<div class="no-flex message-icon">'+
'<span class="uii uii-lg '+options.icon+'"></span></div>'+
value;value='<div class="tools-row align-top message-outer">'+value+'</div>';form.addSection({fields:[{value:value}]});buttons=options.buttons||[];if(options.cancel_button){label=options.cancel_button_label||app_string('LBL_CANCEL_BUTTON_LABEL');buttons.push({label:label,name:'cancel',icon:'icon-cancel',onclick:oncancel});}
if(get_default(options.ok_button,!options.close_button)){label=app_string(options.url?'LBL_OPEN_BUTTON_LABEL':'LBL_OK_BUTTON_LABEL');label=options.ok_button_label||label;buttons.push({label:label,name:'accept',icon:'icon-accept',onclick:onaccept,autofocus:true});}
if(buttons)
form.addButtons(buttons,{footer:true,align:'right'});}
dlg.render();dlg.setContent(content);dlg.show(options.delay);return dlg;}});get_close_popup=function(){return SUGAR.popups.close;}
ui_popup_return=function(result){if(!result)return;var input=SUGAR.ui.getFormInput(result.form_name,result.passthru_data.ui_input_name),row,count;if(input){if(result.selection_list){row=result.selection_list;count=result.selection_count;}else if(result.name_to_value_array){row={ID_0:result.name_to_value_array};count=1;}
else return;input.update_from_popup=true;if(result.passthru_data.ui_return_method){input[result.passthru_data.ui_return_method](row,count,undefined,result.module);}else{var pK=result.primary_key||'id';input.userUpdate(row.ID_0[pK],row.ID_0,undefined,result.module);}
input.update_from_popup=false;}}
ui_popup_return_owner=function(result){if(!result)return;var input=SUGAR.ui.getFormInput(result.form_name,result.passthru_data.ui_input_name),row,count;if(input){if(result.selection_list){row=result.selection_list;count=result.selection_count;}
else return;input.update_from_popup=true;if(result.passthru_data.ui_return_method){input[result.passthru_data.ui_return_method](row,count);}else{input.userUpdateMulti(row,count);}
input.update_from_popup=false;}}
remove_link=function(list_id,link_id){var msg=SUGAR.language.get('app_strings','NTC_REMOVE_CONFIRMATION');if(confirm(msg)){form_params={};form_params.link_id=link_id;form_params.record_perform='subpanel_remove';var conn_params={};conn_params.resultDiv=''+list_id+'-outer';var frm=list_id+'-ListUpdate';SUGAR.ui.sendForm(frm,form_params,conn_params);}}
ajaxStatus={shown:[],showStatus:function(text){var last=SUGAR.ui.Status.show(text);this.shown.push(last);return last;},hideStatus:function(id){if(id){SUGAR.ui.Status.remove(id);while(this.shown.length&&this.shown.pop().id!=id);}else if(this.shown.length)
SUGAR.ui.Status.remove(this.shown.pop());},positionStatus:function(){SUGAR.ui.Status.reposition();}};var SUGAR=AppBase;SUGAR.module('sugarHome');SUGAR.module('util');SUGAR.module('themes');SUGAR.module('conn');SUGAR.module('ui');SUGAR.module('modelCache');SUGAR.module('language');SUGAR.module('session');SUGAR.module('notify');SUGAR.module('Studio');function toggleDisplay(id,state,title){var elt=$(id),elt_link,elt_title;id=elt?elt.id:'';if(!elt)return;elt_link=$(id+'link');elt_title=title?$('sectionHeader-'+id):null;if(!isset(state))
state=(elt.style.display=='none');if(state){SUGAR.ui.setDisplayState(elt,true);SUGAR.ui.setDisplayState(elt_link,false);SUGAR.ui.setDisplayState(elt_title,true);}
else{SUGAR.ui.setDisplayState(elt,false);SUGAR.ui.setDisplayState(elt_link,true);SUGAR.ui.setDisplayState(elt_title,false);return'none';}
return true;}
function toggleSection(id){var shown=toggleDisplay(id)!='none',header=$('sectionHeader-'+id);if(header){SUGAR.ui.addRemoveClass(header,'sectionClosed',!shown);SUGAR.ui.addRemoveClass(header,'sectionOpen',shown);}
return false;}
function checkAll(form,field,value){for(var i=0;i<form.elements.length;i++){if(form.elements[i].name==field)
form.elements[i].checked=value;}}
function replaceAll(text,src,rep){offset=text.toLowerCase().indexOf(src.toLowerCase());while(offset!=-1){text=text.substring(0,offset)+rep+text.substring(offset+src.length,text.length);offset=text.indexOf(src,offset+rep.length+1);}
return text;}
function toDecimal(original){temp=Math.round(original*100)/100;if((original*100)%100==0)return temp+'.00';if((original*10)%10==0)return temp+'0';return temp}
function formatPhoneNumber(input){if(!SUGAR.session.telephony.format_phones)return;var phone=input.value,stripped=phone,ext=null,extPattern=/[^0-9+\-.()*#\s][^0-9+\-()*#\s]*\s*(\d+)\s*$/,match;if(extPattern.test(phone)){match=phone.match(extPattern);ext=match[1];stripped=stripped.replace(extPattern,'');}
stripped=stripped.replace(/[^0-9()+]/g,'');if(/^[0-9]+$/.test(stripped)&&stripped.length==SUGAR.session.telephony.local_digits){phone='+'+SUGAR.session.telephony.country_code+' ('+SUGAR.session.telephony.local_code+') '+formatLocalPhone(stripped,ext);}
if(/^\([0-9]+\)[0-9]+$/.test(stripped)){match=stripped.match(/^\(([0-9]+)\)([0-9]+)$/);phone='+'+SUGAR.session.telephony.country_code+' ('+match[1]+') '+formatLocalPhone(match[2],ext);}
if(/^[0-9]+$/.test(stripped)&&(stripped.length==SUGAR.session.telephony.fixed_number_length)&&(SUGAR.session.telephony.fixed_area_code_length>0)&&(SUGAR.session.telephony.fixed_number_length>0)){phone='+'+SUGAR.session.telephony.country_code+' ('+stripped.substr(0,SUGAR.session.telephony.fixed_area_code_length)+') '+formatLocalPhone(stripped.substring(SUGAR.session.telephony.fixed_area_code_length,9999),ext);}
if(/^\+([0-9]+)\([0-9]+\)[0-9]+$/.test(stripped)){match=stripped.match(/^\+([0-9]+)\(([0-9]+)\)([0-9]+)$/);phone='+'+match[1]+' ('+match[2]+') '+formatLocalPhone(match[3],ext);}
input.value=phone;}
function formatUrl(input){var url=trim(input.value),tail,sch;while((tail=url.match(/(.*:\/\/.*?)(\w+:\/\/.*)$/)))
url=tail[2];sch=url.match(/^(.*?(file|http|https|ftp|spdy))?(:\/\/.*)/i);if(sch&&sch[2])
url=sch[2]+sch[3];url=url.replace(/:\/([^\/])/,'://$1');if(!/:\/\//.test(url)&&url.length)
url='http://'+url;input.value=url;}
function formatLocalPhone(phone,ext){var patterns=[[],[1],[2],[3],[2,2],[2,3],[3,3],[3,4],[3,3,2]],pattern=patterns[phone.length],start=0,ret='',i;if(typeof(pattern)=='undefined')return phone;for(i=0;i<pattern.length;i++){if(i>0)ret+='-';ret+=phone.substring(start,start+pattern[i]);start+=pattern[i];}
if(ext){ret+=' '+SUGAR.session.telephony.ext_string+' '+ext;}
return ret;}
function setPointer(row,id,action){return sListView.row_action(row,action,id);}
function sendAndRetrieve(theForm,theDiv,loadingStr,onUpdate,noScroll){var done=function(){SUGAR.session.setLoadingRequest(null);if(onUpdate)onUpdate();}
function success(data){var body=data?data.responseText:'',div=$(theDiv);if(typeof theDiv==='function'){theDiv(SUGAR.util.disableInlineScripts(body));}else if(div){div.innerHTML=SUGAR.util.disableInlineScripts(body);}
SUGAR.util.evalScript(body,onUpdate);if(!noScroll)
SUGAR.util.scrollToElement(theDiv);}
if(typeof loadingStr=='undefined')
loadingStr=app_string('LBL_LOADING');var req=SUGAR.conn.sendForm(theForm,{status_msg:loadingStr},success);if(req)SUGAR.session.setLoadingRequest(req);return false;}
var UidList=function(field){this.allUids=false;this.uids=[];this.setUidString=function(uidStr){this.uids=[];if(uidStr==='all')
this.allUids=true;else if(uidStr){this.allUids=false;var uidList=uidStr.split(';');for(var i=0;i<uidList.length;i++)
if(uidList[i])
this.uids.push(trim(uidList[i]));}}
this.addUid=function(uid){this.addUids([uid]);}
this.addUids=function(uidsIn){if(!uidsIn||!uidsIn.length||this.allUids)return;var uidSet={};for(var i=0;i<uidsIn.length;i++){uidsIn[i]=trim(uidsIn[i]);uidSet[uidsIn[i]]=1;}
for(var i=0;i<this.uids.length;i++){if(uidSet[this.uids[i]])
uidSet[this.uids[i]]=0;}
for(var i=0;i<uidsIn.length;i++)
if(uidsIn[i]&&uidSet[uidsIn[i]])
this.uids.push(uidsIn[i]);}
this.removeUid=function(uid){this.removeUids([uid]);}
this.removeUids=function(uidsIn){if(!uidsIn||!uidsIn.length||this.allUids)return;var uidSet={};for(var i=0;i<uidsIn.length;i++){uidsIn[i]=trim(uidsIn[i]);uidSet[uidsIn[i]]=1;}
for(var i=0;i<this.uids.length;i++){if(uidSet[this.uids[i]])
this.uids.splice(i--,1);}}
this.clear=function(){this.allUids=false;this.uids=[];}
this.getCount=function(){if(this.allUids)return'all';return this.uids.length;}
this.getList=function(){if(this.allUids)return'all';return this.uids.slice(0);},this.getString=function(){if(this.allUids)return'all';else return this.uids.join(';');},this.save=function(){if(!this.field)return;this.field.value=this.getString();}
this.field=field;if(field)
this.setUidString(field.value);}
function sugarListView(){this.lists={};this.offsetPopup=null;this.primary_id=null;return this;}
sugarListView.prototype={init:function(list_id,params){if(!list_id)return false;if(!params)params={};var persisted={},dl,outer_id=list_id+'-outer';if(params.type=='dashlet')
outer_id='dashlet-'+list_id;else if(params.is_sidebar)
outer_id='sidebar-list-body';if(this.lists[list_id]){persisted=this.lists[list_id].persist_data;}
var list=this.lists[list_id]={elt:$(list_id+'-outer'),type:params.type,table:$(list_id+'-main'),outer:$(outer_id),form:$(list_id+'-ListUpdate'),filter:$(list_id+'-FilterForm'),persist_data:persisted,is_primary:params.is_primary,is_sidebar:params.is_sidebar,count_options:params.count_options,query:params.query,mass_perform:params.mass_perform,result_count:params.result_count,total_count:params.total_count,sidebar_limit:params.sidebar_limit,subpanel_name:params.subpanel_name,subpanel_tab:params.subpanel_tab,parent_module:params.parent_module,parent_record:params.parent_record,drag:false,lastY:0};if(list.is_primary){if(list.query)
SUGAR.session.loadState(list.query);this.primary_id=list_id;}
if(list.is_sidebar)
this.sidebar_id=list_id;var buttons=[list_id+'-ActionButtonHead',list_id+'-ActionButtonFoot'];var opts=list_id+'-MenuActions';if($(buttons[0]))
list.top_menu=SUGAR.ui.registerMenuSource(buttons[0],{options:opts,icon_key:'icon'},list.form);if($(buttons[1]))
list.bottom_menu=SUGAR.ui.registerMenuSource(buttons[1],{options:opts,icon_key:'icon'},list.form);var sel_limit=$(list_id+'-sel-limit');if(sel_limit){opts=this.getCountOptions(list);var onch=function(key){sListView.performSearch(list_id,{list_limit:key});}
list.limit_menu=SUGAR.ui.registerMenuSource(sel_limit,{options:opts,onchange:onch},list.form);}
list.have_hr=!!(list.table&&list.table.getElementsByClassName('listViewHRS1').length);list.row_span=list.have_hr?2:1;sListView.checkCurrentIndex(list_id);if(list.mass_perform=='delete'||list.mass_perform=='update'||list.mass_perform=='trash'){sListView.setSelected(list_id,'none');sListView.resetSelected(list_id);sListView.updateSelectedCount(list_id);}
if(list.is_sidebar)
this.setSidebarTitle();if(params.type=='subpanel'){new SUGAR.ui.Draggable('#'+list_id+'-outer',{sourceType:'reorderSubpanels',handle:'#'+list_id+'-title',values:{subpanel:list_id+'-outer',list_id:list_id},onEnd:function(evt){this.elt.closest('.subpanel-list').children('.subpanel-entry').css('opacity',1);SUGAR.dom.query('.subpanel-entry').removeClass('subpanel-reorder').removeClass('dz-drag-hover');}});}
return true;},deferredLoad:function(params){SUGAR.onDomReady(function(){sListView.restoreLayout(null,params);});},getPrimaryId:function(){if(this.primary_id){var list=this.getListView(this.primary_id);if(list&&list.outer&&SUGAR.ui.inDocument(list.outer))return this.primary_id;}},getSidebarId:function(){if(this.sidebar_id){var list=this.getListView(this.sidebar_id);if(list&&list.outer&&SUGAR.ui.inDocument(list.outer))return this.sidebar_id;}},getListView:function(list_id){return this.lists[list_id];},getForm:function(list_id){if(this.lists[list_id])return this.lists[list_id].form;},getUids:function(list_id,nocreate){var list=this.getListView(list_id);if(!list)return null;if(!isset(list.uids)&&!nocreate)
list.uids=new UidList(list.form?list.form.list_uids:null);return list.uids;},setCheckedAll:function(list_id,checked){var list=this.getListView(list_id);if(!list)return null;var check_all_elm=$(list_id+'-check-all');if(check_all_elm){if(checked=='all'){check_all_elm.disabled=true;check_all_elm.checked=true;}else{check_all_elm.disabled=false;check_all_elm.checked=checked;}}},checkItem:function(list_id,elt,nocurrent){var uidList=sListView.getUids(list_id);if(uidList){if(elt.checked)
uidList.addUid(elt.value);else
uidList.removeUid(elt.value);}
sListView.updateSelectedCount(list_id);sListView.row_action(elt,nocurrent?'mark':'click');},checkAllItems:function(list_id,uncheck){var uidList=sListView.getUids(list_id);if(uidList){if(!uncheck)
uidList.setUidString('all');else
uidList.clear();}
sListView.updateSelectedCount(list_id);},setSelected:function(list_id,mode,check_status){var field_name='mass[]'
var elms=document.getElementsByName(field_name);var all_check=true;if(mode=='none'){sListView.checkAllItems(list_id,true);check_status=false;all_check=false;}else if(mode=='page'){var list=sListView.getUids(list_id).getList();if(list==='all'){sListView.checkAllItems(list_id,true);check_status=true;}
if(!isset(check_status)&&list!='all')
check_status=!$(list_id+'-check-all').checked;all_check=check_status;}else if(mode=='all'){sListView.checkAllItems(list_id,false);check_status=true;all_check='all';}
sListView.setCheckedAll(list_id,all_check);for(var i=0;i<elms.length;i++){if(elms[i].name==field_name){elms[i].checked=check_status;if(mode=='page'){elms[i].disabled=false;}else{if(mode=='all'){elms[i].disabled=check_status;}else{elms[i].disabled=false;}}
sListView.checkItem(list_id,elms[i],true);}}},updateSelectedCount:function(list_id){var uidList=sListView.getUids(list_id),c=uidList?uidList.getCount():0,sHead=$(list_id+'-SelectCountHead'),sFoot=$(list_id+'-SelectCountFoot');if(c=='all')c=app_string('LBL_SELECTED_ALL');if(sHead)sHead.innerHTML=c;if(sFoot)sFoot.innerHTML=c;},resetSelected:function(list_id){var uidList=sListView.getUids(list_id);if(uidList)
uidList.clear();},performSearch:function(list_id,form_params,push_state){var list=this.getListView(list_id);if(!list||!list.filter){console.error("missing listview search: "+list_id);return false;}
SUGAR.util.maskDiv(list.outer);if(form_params)
SUGAR.ui.updateForm(list.filter,form_params);SUGAR.session.setLoadingState('sListView',{method:'restoreLayout',id:list_id,params:this.getLayoutState(list)},push_state);sendAndRetrieve(list.filter,list.outer);return false;},clearSearch:function(list_id){return this.performSearch(list_id,{filter_clear:1});},getLayout:function(list_id){var list=this.getListView(list_id);if(list){var form=list.filter||list.form;if(form)return form.layout.value;}},restoreLayout:function(list_id,vars){if(!vars)return;var list=this.getListView(list_id);if(list&&list.filter&&SUGAR.ui.inDocument(list.filter)){if(!vars.report_id)vars.report_id='';if(!vars.data_id)vars.data_id='';if(!vars.filter_layout)vars.filter_layout='';vars.filter_clear=1;this.performSearch(list_id,vars);}else{var s=SUGAR.session.currentState;if(s&&s.context=='sListView'&&s.id&&s.id!=list_id)
this.restoreLayout(s.id,vars);else if(vars&&vars.module){vars.initial_load=true;SUGAR.conn.asyncRequest('async.php',{postData:vars},function(data){SUGAR.util.loadContent('content-main',data.responseText);});}}},setLayout:function(list_id,layout_name,report_id,data_id){var list=this.getListView(list_id);if(!list||!list.filter)return false;var vars={layout:layout_name,filter_layout:'',report_id:report_id||'',data_id:data_id||'',filter_clear:1};if(list.form&&list.form.mass_panel_open)
vars.mass_panel_open=list.form.mass_panel_open.value;this.performSearch(list_id,vars,true);return false;},getReportId:function(list_id){var list=this.getListView(list_id);if(!list||!list.filter)return false;return list.filter.report_id.value;},getReportFilter:function(list_id){var filter={},list=this.getListView(list_id),i,elt;if(list&&list.filter){for(i=0;i<list.filter.elements.length;i++){elt=list.filter.elements[i];if(elt.name&&elt.type!='button'&&elt.type!='submit'&&elt.type!='file'){filter[elt.name]=elt.value;}}}
return filter;},runReport:function(list_id,button,add_filter){var rid=sListView.getReportId(list_id),filter=add_filter?sListView.getReportFilter(list_id):'',req=new SUGAR.conn.JSONRequest('run_report',{},{module:'Reports',report_id:rid,filter:filter}),returnReport=function(data){if(data)
sListView.setLayout(list_id,'Reports',rid,data.getResult());};req.button=button;if(button)
button.disabled=true;req.fetch(returnReport);},returnToReport:function(list_id){var rid=sListView.getReportId(list_id);return sListView.setLayout(list_id,'Reports',rid);},getFilterLayout:function(list_id){var list=this.getListView(list_id);if(!list||!list.filter)return false;return list.filter.filter_layout.value;},setFilterLayout:function(list_id,layout_name){var list=this.getListView(list_id);if(!list||!list.filter){console.log("missing listview search: "+list_id);return false;}
this.performSearch(list_id,{filter_layout:layout_name||''});},getLayoutState:function(list){var frm=list.filter||list.form;if(frm){var state={module:frm.module.value,action:frm.action.value},add_f=['layout','subpanel','link_name','parent_layout','record','record_perform','list_format'];for(var i=0;i<add_f.length;i++){if(isset(frm.elements[add_f[i]])){v=frm.elements[add_f[i]].value;state[add_f[i]]=v;}}
if(frm.report_id){state.report_id=frm.report_id.value;if(list.form.data_id)
state.data_id=frm.data_id.value;}
return state;}},getExtendedState:function(list){var state={params:this.getLayoutState(list)},add_f=['list_id','list_filter','list_offset','list_order_by','list_limit','list_context'],frm=list.form,v;if(!state.params)return null;if(frm){state.action=frm.getAttribute('action');for(var i=0;i<add_f.length;i++){if(isset(frm.elements[add_f[i]])){v=frm.elements[add_f[i]].value;if(add_f[i]=='list_offset'||add_f[i]=='list_limit')v=parseInt(v,10);state.params[add_f[i]]=v;}}}
return state;},navigate:function(list_id,offset,limit,order_by,parent_list){var list=this.getListView(list_id);if(!list||!list.form||!list.outer){console.log("missing listview objects: "+list_id);return false;}
list.push_state=false;list.state_vars={};if(isset(offset))list.state_vars.list_offset=offset;if(isset(limit))list.state_vars.list_limit=limit;if(isset(order_by))list.state_vars.list_order_by=order_by;SUGAR.ui.updateForm(list.form,list.state_vars);if(parent_list)
SUGAR.ui.updateForm(list.form,{parent_list:parent_list});else
SUGAR.ui.updateForm(list.form,{parent_list:''});var uidList=sListView.getUids(list_id,true);if(uidList){uidList.save();if(list.is_popup){this.persistRowData(list,uidList.getList());}}
SUGAR.util.maskDiv(list.outer);sendAndRetrieve(list.form,list.outer);},showDetail:function(list_id,params,evt){var list=sListView.getListView(list_id),list_state,sidebar;if(list)list_state=sListView.getExtendedState(list);q_params=encodeQueryString(params);if(!history.pushState||window.metaKeyPressed||(evt&&(evt.which==2||(!evt.which&&evt.button==4)))){SUGAR.util.loadUrl('index.php?'+q_params,null,true,evt);}else{SUGAR.session.setLoadingState(null,null,true,q_params);sidebar=list_state&&list_state.params.list_context=='sidebar';if(list_state){if(list&&list.sidebar_limit)list_state.params.list_limit=list.sidebar_limit;SUGAR.themes.saveDetailSidebar(list_state,params.module,params.record);}
SUGAR.util.fetchContentMain('async.php?'+q_params);if(!list_state||!sidebar)
this.destroy(list_id);else
sListView.setCurrentId(list_id,params.record,true);}},orderBy:function(list_id,order_by){this.navigate(list_id,0,null,order_by);return false;},getCountOptions:function(list){var cstr=(list.count_options||[]).map(function(c){return c.toString();});return{keys:cstr,values:cstr,width:'70px'};},showOffsetPopup:function(list_id,tg){var list=this.getListView(list_id),popup;if(!list)return;if(!list.offsetPopup){popup=$(list_id+'-offset-edit');if(!popup)return;list.offsetPopup=new SUGAR.ui.PopupSlidePanel(popup,{target_offset:{below:true},onshow:function(){var inp=$(list_id+'-offset-input');inp.focus();inp.select();},onhide:function(){SUGAR.ui.removeNode(popup);},destroy_on_close:false});var copts=this.getCountOptions(list),offs=$(list_id+'-offset-input'),csel=SUGAR.ui.registerInput(list.form,new SUGAR.ui.SelectInput(list_id+'-count-input',{name:'list_limit',options:copts,show_stacked:true}));csel.setup();csel.updateLabel(list.form.list_limit.value,list.form.list_limit.value);if(offs){offs.value=parseInt(list.form.list_offset.value,10)+1;offs.onkeypress=function(event){if(event.keyCode==13)return sListView.loadCustomOffset(list_id);}
offs.onkeyup=offs.oninput=function(){sListView.updateCustomOffset(list_id,this.value);}}}
document.body.appendChild(list.offsetPopup.elt);list.offsetPopup.target=tg;list.offsetPopup.show();return false;},loadCustomOffset:function(list_id){var list=this.getListView(list_id);if(!list||!list.form){console.log("missing listview objects: "+list_id);return false;}
if(list.offsetPopup)list.offsetPopup.close();var offset=list.custom_list_offset;if(!isNumeric(offset)||offset<=0){offset=list.form.list_offset.value;}else{offset--;}
this.navigate(list_id,offset);},updateCustomOffset:function(list_id,new_value){var list=this.getListView(list_id);if(!list){console.log("missing listview objects: "+list_id);return false;}
list.custom_list_offset=new_value;},persistRowData:function(list,uids){if(!list.persist_data.prev_rows)
list.persist_data.prev_rows={};if(uids.push&&list.row_data){for(var i=0;i<uids.length;i++){var data=list.row_data[uids[i]];if(data)
list.persist_data.prev_rows[uids[i]]=data;}}},checkSelected:function(list_id,action,show_msg){var uidList=sListView.getUids(list_id),c=uidList?uidList.getCount():0;if(action=='duplicate_merge'&&c<2){alert(app_string('LBL_LISTVIEW_TWO_REQUIRED'));}else if(!c){alert(app_string('LBL_LISTVIEW_NO_SELECTED'));}else
return true;return false;},addToFavorites:function(list_id,elt,module,record_id){var list=this.getListView(list_id);if(!list||!list.form||!list.outer){console.log("missing listview objects: "+list_id);return false;}
return SUGAR.ui.addToFavorites(elt,module,record_id);},massPrint:function(list_id,action){var list=this.getListView(list_id),vresult;if(!list||!list.form||!list.outer){console.log("missing listview objects: "+list_id);return false;}
var uidList=sListView.getUids(list_id);if(!uidList||!uidList.getCount()){alert(app_string('LBL_LISTVIEW_NO_SELECTED'));return false;}
var gotContent=function(html){popup.loadContent(html,null,true);}
var form_params={module:list.form.module.value,list_id:list_id,config:true,mass_action:action};form_params.list_uids=uidList.getString();var popup=new SUGAR.ui.Dialog('massprint',{modal:true});this.sendMassUpdate(list_id,'PrintTemplate',gotContent,form_params);},sendMassUpdate:function(list_id,action,target,form_params,allow_none){var list=this.getListView(list_id),vresult;if(!list||!list.form||!list.outer){console.log("missing listview objects: "+list_id);return false;}
if(!(vresult=SUGAR.ui.validateForm(list.form)).status){SUGAR.ui.alertInvalidForm(vresult);return false;}
if(!allow_none&&!sListView.checkSelected(list_id,action,true)){return false;}
var uidList=sListView.getUids(list_id);if(uidList)uidList.save();var old_perform=list.form.mass_perform.value,old_format=list.form.list_format.value;list.form.mass_perform.value=action;if(isset(form_params))
SUGAR.ui.updateForm(list.form,form_params);if(target&&typeof target!=='function'){var old_act=list.form.getAttribute('action');var old_tg=list.form.getAttribute('target');setAttr(list.form,'action','async.php');if(target==='export')target=true;if(target===true)target='_self';if(target)setAttr(list.form,'target',target);list.form.submit();setAttr(list.form,'action',old_act);setAttr(list.form,'target',old_tg);list.form.mass_perform.value=old_perform;list.form.list_format.value=old_format;}else{if(!target)SUGAR.util.maskDiv(list.outer);var old_act=list.form.getAttribute('action');var old_tg=list.form.getAttribute('target');sendAndRetrieve(list.form,target||list.outer);setAttr(list.form,'action',old_act);setAttr(list.form,'target',old_tg);list.form.mass_perform.value=old_perform;list.form.list_format.value=old_format;}
return false;},showActionConfig:function(list_id,wf_action){var list=this.getListView(list_id),mod;if(!sListView.checkSelected(list_id,'wfaction',true)){return false;}
if(!list||!list.form||!list.form.module)return;mod=list.form.module.value;SUGAR.popups.openUrl('async.php?module=Workflow&action=RenderActionConfig&context=listview&trigger_module='+mod+'&operation_type='+wf_action+'&entry_id='+list_id);return false;},emailEntries:function(list_id,module,statement){if(statement){sListView.sendMassUpdate(list_id,'SendPDFStatements');}else{SUGAR.session.setLoadingState(null,null,true);sListView.sendMassUpdate(list_id,'EmailMultiple');}},displayOnMap:function(list_id,module){var list=sListView.getListView(list_id);var vp=SUGAR.ui.getViewport(10);var form_params={module:list.form.module.value,action:'MultiMap',target_module:module,list_id:list_id,fixedSize:isIPhone?vp.height:0};if(!list||!list.form||!list.outer){return false;}
var uidList=sListView.getUids(list_id);if(!uidList||!uidList.getCount()){alert(app_string('LBL_LISTVIEW_NO_SELECTED'));return false;}
var popup=new SUGAR.ui.Dialog('multimap',{width:800,min_height:600,modal:true,title:SUGAR.language.getString('LBL_MULTI_MAP_TITLE',module)});form_params.list_uids=uidList.getString();popup.fetchContent('async.php',{postData:form_params},null,true);},MultiMapDisplay:function(list_id,module){var list=this.getListView(list_id),vresult;var vp=SUGAR.ui.getViewport(10);if(!list||!list.form||!list.outer){console.log("missing listview objects: "+list_id);return false;}
var uidList=this.getUids(list_id);if(!uidList||!uidList.getCount()){alert(app_string('LBL_LISTVIEW_NO_SELECTED'));return false;}
var gotContent=function(html){popup.loadContent(html,null,true);}
var form_params={module:module,target_module:module,list_id:list_id,fixedSize:isIPhone?vp.height:0};form_params.list_uids=uidList.getString();var popup=new SUGAR.ui.Dialog('multimap',{width:800,min_height:600,modal:true,title:SUGAR.language.getString('LBL_MULTI_MAP_TITLE',module)});this.sendMassUpdate(list_id,'GetMultiMap',gotContent,form_params);},quickCampaign:function(list_id,module){var list=sListView.getListView(list_id);var form_params={module:'Campaigns',action:'QuickCampaignDialog',target_module:module,list_id:list_id};if(!list||!list.form||!list.outer){return false;}
var uidList=sListView.getUids(list_id);if(!uidList||!uidList.getCount()){alert(app_string('LBL_LISTVIEW_NO_SELECTED'));return false;}
var popup=new SUGAR.ui.Dialog('quickcampaign',{modal:true,title:SUGAR.language.getString('QCAMPAIGN',module)});form_params.list_uids=uidList.getString();popup.fetchContent('async.php',{postData:form_params},null,true);},convertToTargetList:function(list_id,module,report_id,data_id){var list=sListView.getListView(list_id);var form_params={module:'ProspectLists',action:'PopupConvertContacts',target_module:module};if(!list||!list.form||!list.outer){return false;}
var uidList=sListView.getUids(list_id);if(!uidList||!uidList.getCount()){alert(app_string('LBL_LISTVIEW_NO_SELECTED'));return false;}
var popup=new SUGAR.ui.Dialog('convertprospectlist',{modal:true,title:SUGAR.language.getString('LBL_CONVERT_TO_TARGET_LIST',module)});form_params.list_id=list_id;if(report_id)
form_params.report_id=report_id;if(data_id)
form_params.data_id=data_id;form_params.list_uids=uidList.getString();popup.fetchContent('async.php',{postData:form_params},null,true);},mailMerge:function(list_id,module){var list=sListView.getListView(list_id);var form_params={module:'MailMerge',action:'MergeDialog',target_module:module,list_id:list_id};if(!list||!list.form||!list.outer){return false;}
var uidList=sListView.getUids(list_id);if(!uidList||!uidList.getCount()){alert(app_string('LBL_LISTVIEW_NO_SELECTED'));return false;}
var popup=new SUGAR.ui.Dialog('mailmerge',{modal:true,title:SUGAR.language.getString('MAIL_MERGE',module)});form_params.list_uids=uidList.getString();popup.fetchContent('async.php',{postData:form_params},null,true);},exportVcards:function(list_id,mod){var list=sListView.getListView(list_id);var form_params={module:mod,action:'ExportVCards'};if(!list||!list.form||!list.outer){return false;}
var uidList=sListView.getUids(list_id);if(!uidList||!uidList.getCount()){alert(app_string('LBL_LISTVIEW_NO_SELECTED'));return false;}
uidList.save();var old_perform=list.form.mass_perform.value,old_format=list.form.list_format.value;list.form.mass_perform.value='';SUGAR.ui.updateForm(list.form,form_params);var old_act=list.form.getAttribute('action');var old_tg=list.form.getAttribute('target');list.form.action='index.php';list.form.target='_self';list.form.submit();list.form.action=old_act;list.form.target=old_tg;list.form.mass_perform.value=old_perform;list.form.list_format.value=old_format;},setInviteStatus:function(list_id,model,record_id,status){var list=sListView.getListView(list_id),target=list?list.type:'dashlet';function ready(){var row=this.getResult();if(row&&row.result=='ok'){if(target=='dashlet')
SUGAR.sugarHome.retrieveDashlet(list_id,null,null,null,true);else
sListView.navigate(list_id);}}
var query_params={model:model,record_id:record_id,accept_status:status};var req=new SUGAR.conn.JSONRequest('set_activity_status',{},query_params);req.fetch(ready);},initPopup:function(list_id,params){var list=this.getListView(list_id);if(!list||!list.form)return;list.is_popup=true;if(params.first_load){list.request_data=get_popup_request_data();}else{list.request_data=params.request_data;}
var upd={request_data:JSON.stringify(list.request_data)};SUGAR.ui.updateForm(list.form,upd);if(list.filter)
SUGAR.ui.updateForm(list.filter,upd);list.row_data=get_default(params.row_data,{});var rdata=list.request_data;if(rdata){var fields=rdata.field_to_name_array;var simple=true;for(var k in fields){if(k!='id'&&k!='name'){simple=false;break;}}
list.simple_response=simple;}
params.list_id=list_id;params.content_id=''+list_id+'-outer';params.fill=true;SUGAR.popups.initContent(params);list.outer=$(params.content_id);},popupReturn:function(list_id,module,record){var list=this.getListView(list_id);if(!list.request_data){console.error("missing popup request data");return false;}
if(!record)record='';var result_data={form_name:list.request_data.form_name,module:module,passthru_data:list.request_data.passthru_data,primary_key:'id'};if(list.simple_response){var field_map=list.request_data.field_to_name_array;if(record.push){result_data.associated_row_data={};var row,key;var sel_list={};if(list.request_data.return_result_array)
result_data.result_array={order:record,data:{}};for(var i=0;i<record.length;i++){key="ID_"+i;sel_list[key]=record[i];row=this.getRowValue(list,record[i],field_map);result_data.associated_row_data[key]=row;if(result_data.result_array)
result_data.result_array[record[i]]=row;}
result_data.selection_list=sel_list;result_data.selection_count=record.length;}else{var row=this.getRowValue(list,record,field_map);result_data.name_to_value_array=row;if(list.request_data.return_result_array){result_data.result_array={order:[record],data:{}};result_data.result_array.data[record]=row;}
result_data.filter=this.getFilters(list_id);}
this.popupReturnResult(list_id,result_data);}else{var req=sListView.getJsonRequest(list_id,record,list.request_data.field_to_name_array,list.request_data.passthru_data);req.fetch(function(response){var json_data=response.getResult(),pK,rindex={},rindex_row={},sel_list={},c=0,row,unformat_row,key,keys=[],i;if(!json_data||json_data.failed){console.error('bad response to popupReturn request');return;}
pK=result_data.primary_key=json_data.primary_key;result_data.associated_row_data={};if(list.request_data.return_result_array)
result_data.result_array={order:record,data:{}};for(i=0;i<json_data.formatted_rows.length;i++)
rindex[json_data.formatted_rows[i][pK]]=json_data.formatted_rows[i];for(i=0;i<json_data.rows.length;i++){keys.push(json_data.rows[i][pK]);rindex_row[json_data.rows[i][pK]]=json_data.rows[i];}
if(!record.push)record=[record];if(record.length!=1||record[0]!=='all')
keys=record;for(i=0;i<keys.length;i++){row=rindex[keys[i]];if(!row)continue;unformat_row=rindex_row[keys[i]];key="ID_"+(c++);sel_list[key]=row;result_data.associated_row_data[key]=row;result_data.name_to_value_array=row;result_data.unformat_name_to_value_array=unformat_row;if(result_data.result_array)
result_data.result_array[keys[i]]=row;}
result_data.selection_list=sel_list;result_data.selection_count=keys.length;sListView.popupReturnResult(list_id,result_data);});}
return false;},getFilters:function(list_id){var filters={},list=this.getListView(list_id),i,elt,value;if(list&&list.filter){var form_data=['action','id','layout','filter_layout','list_context','list_id','list_limit','module','multi_select','request_data'];for(i=0;i<list.filter.elements.length;i++){elt=list.filter.elements[i];if(elt.name&&elt.type!='button'&&elt.type!='submit'&&elt.type!='file'){value=elt.value;if(value==''||form_data.indexOf(elt.name)!=-1)
continue;if(elt.type=='checkbox'&&!elt.checked)
value=0;filters[elt.name]=value;}}}
return filters;},getRowValue:function(list,record,field_map){var found_val='';var row={};if(list.persist_data.prev_rows)
found_val=get_default(list.persist_data.prev_rows[record],found_val);if(list.row_data)
found_val=get_default(list.row_data[record],found_val);var row={};for(var k in field_map){if(k=='id')
row[field_map[k]]=record;else
row[field_map[k]]=found_val;}
return row;},popupReturnSelected:function(list_id,module){var ids=this.getUids(list_id).getList();if(ids.length)this.popupReturn(list_id,module,ids);},popupReturnResult:function(list_id,result_data){var list=this.getListView(list_id);var cb=eval("window."+list.request_data.call_back_function);if(cb){this.closePopup(list_id);cb(result_data);}else
console.error("callback not defined: "+list.request_data.call_back_function);return false;},closePopup:function(list_id){var close_f=get_close_popup();if(close_f)
close_f();delete this.lists[list_id];},getJsonRequest:function(list_id,rows,fields,additional_data){var list=sListView.getListView(list_id);if(!list||!list.form){console.log("missing listview objects: "+list_id);return false;}
var module=list.form.module.value;var layout=sListView.getLayout(list_id);var req_data={list_id:list_id,module:module,layout:layout,rows:rows};if(fields)
req_data.fields=fields;if(additional_data)
req_data.additional_data=additional_data;return new SUGAR.conn.JSONRequest('popup_related_data',{},req_data);},showArrangeLayouts:function(list_id,layout_name,module,from_admin_panel){var list=sListView.getListView(list_id);if(!list||!list.form){console.log("missing listview objects: "+list_id);return false;}
list.layout_dlg=new SUGAR.ui.Dialog('layoutEditDlg');var vars={list_layout_perform:'arrange'};if(module)vars.module=module;if(from_admin_panel)vars.from_saved_search=true;list.layout_dlg.fetchFormContent(list.form,vars,{url:'async.php'},null,true);return false;},showCreateLayout:function(list_id,layout_name,module,from_admin_panel){this.showEditLayout(list_id,layout_name,'create',module,from_admin_panel);},showDuplicateLayout:function(list_id,layout_name){this.showEditLayout(list_id,layout_name,'duplicate');},showEditLayout:function(list_id,layout_name,perform,module,from_admin_panel){var list=sListView.getListView(list_id);if(!list||!list.form){console.log("missing listview objects: "+list_id);return false;}
list.layout_dlg=new SUGAR.ui.Dialog('layoutEditDlg');var vars={list_layout_perform:perform||'edit'};if(layout_name)vars.layout=layout_name;if(module)vars.module=module;if(from_admin_panel)vars.from_saved_search=true;list.layout_dlg.fetchFormContent(list.form,vars,{url:'async.php'},null,true);return false;},showCreateReport:function(module){var p=SUGAR.ui.PopupManager.currentModal();if(!p||p.id!='layoutEditDlg')
p=new SUGAR.ui.Dialog('layoutEditDlg');var vars={list_layout_perform:'create',layout:'Reports',module:module,action:'index'};var req=new SUGAR.conn.HTTPRequest('async.php',{postData:vars});p.fetchContent(req,null,null,true);return false;},adminCreateLayout:function(form){var search_module=SUGAR.ui.getFormInput(form,'search_module');if(search_module&&search_module.getValue()){var id_input=document.FilterForm.list_id;if(id_input){var list_id=id_input.value;var module=search_module.getValue();SUGAR.popups.close();this.showEditLayout(list_id,null,'create',module,true);}
return true;}else{alert(app_string('ERR_CREATE_LIST_LAYOUT_MODULE'));return false;}},adminEditLayout:function(layout_id,module){var id_input=document.FilterForm.list_id;if(id_input){var list_id=id_input.value;var list=sListView.getListView(list_id);if(!list||!list.form){console.log("missing listview objects: "+list_id);return false;}
list.layout_dlg=new SUGAR.ui.Dialog('layoutEditDlg');var vars={list_layout_perform:'edit',layout:layout_id,module:module,from_saved_search:true};list.layout_dlg.fetchFormContent(list.form,vars,{url:'async.php'},null,true);}
return false;},deleteLayout:function(list_id,layout_name){var list=sListView.getListView(list_id);if(!list||!list.form){console.log("missing listview objects: "+list_id);return false;}
if(!confirm(app_string('MSG_CONFIRM_DELETE_LAYOUT')))return false;var vars={list_layout_perform:'delete',filter_clear:1};if(layout_name)vars.layout=layout_name;return SUGAR.ui.sendForm(list.form,vars,{resultDiv:list.outer});},deleteRun:function(list_id){var list=sListView.getListView(list_id);if(!list||!list.form){console.log("missing listview objects: "+list_id);return false;}
if(!confirm(app_string('MSG_CONFIRM_DELETE_RUN')))return false;var vars={list_layout_perform:'delete_run',filter_clear:1};return SUGAR.ui.sendForm(list.form,vars,{resultDiv:list.outer});},saveLayout:function(form){var list_id=form.list_id.value,list=sListView.getListView(list_id),vars={list_layout_perform:'save',filter_clear:1},params,target;if(!list_id){vars.new_from_ext=1;target=true;params={url:'index.php'};}else if(!list||!list.form){console.log("missing listview objects: "+form.list_id.value);return false;}else{params={resultDiv:list.outer,receiveCallback:function(){list.layout_dlg.close();}};}
var ret=SUGAR.ui.sendForm(form,vars,params,target);if(!isset(ret)){var nm=SUGAR.ui.getFormInput(form,'name'),tabs=SUGAR.ui.getFormInput(form,'form-tabs');if(nm&&nm.invalid&&tabs)
tabs.setValue('general');}
return ret;},cancelEditLayout:function(list_id){var list=sListView.getListView(list_id),p;if(list&&list.layout_dlg){list.layout_dlg.close();}else{p=SUGAR.ui.PopupManager.currentModal();if(p&&p.id=='layoutEditDlg')p.close();}},showReportSql:function(list_id){var list=sListView.getListView(list_id),rid;if(list&&list.form){rid=list.form.report_id.value;if(rid){var dlg=new SUGAR.ui.Dialog('showSqlDlg');var vars={list_layout_perform:'show_sql',layout:rid,module:list.form.module.value};dlg.fetchFormContent(list.form,vars,{url:'async.php'},null,true);}}},handleKeyDown:function(list_id,evt){var list=sListView.getListView(list_id),key=evt.keyCode,elt,offs,limit;if(list&&key){if(key==78||key==80||key==187||key==189){if(list.form){offs=parseInt(list.form.list_offset.value,10);limit=parseInt(list.form.list_limit.value,10);if(key==78){if(evt.shiftKey)offs=list.total_count-limit;else offs=Math.min(offs+limit,list.total_count-limit);}
else if(key==80){if(evt.shiftKey)offs=0;else offs=Math.max(0,offs-limit);}
else if(key==187){if(limit<=5)limit=10;else limit+=10;}
else if(key==189&&limit>5){if(limit<=10)limit=5;else limit-=10;}
else return;sListView.navigate(list_id,offs,limit);return true;}}
else if(key==67){elt=$(list_id+'-create');if(elt)elt.onclick();return true;}
else if(key==191){if(list.filter&&!evt.shiftKey){elt=SUGAR.ui.getFormInput(list.filter,'filter_text');if(elt)elt.focus();else list.form.focus();return true;}}
else if(key>=49&&key<=57){sListView.setCurrentIndex(list_id,key-49);return true;}
else if(key==77){if(evt.shiftKey)
sListView.setSelected(list_id,'page');else{elt=sListView.getCurrentRow(list_id);if(elt)sListView.row_action(elt,'toggle');}
return true;}
else if(key==86){elt=sListView.getCurrentRow(list_id);if(elt)
sListView.clickRowLink(elt);return true;}
else if(key==65||key==90){if(list.form){offs=list.current_index;limit=list.result_count;if(isset(offs)){if(evt.shiftKey){elt=sListView.getCurrentRow(list_id);if(elt)sListView.row_action(elt,'toggle',null,true);}
if(key==65)offs--;else offs++;if(offs<0)offs=limit-1;if(offs>=limit)offs=0;}else if(key==65)
offs=limit-1;else
offs=0;sListView.setCurrentIndex(list_id,offs);return true;}}
else if(key==85){elt=$('formContent-'+list_id+'-ListUpdate');if(elt){sugarListView.toggleUpdate(elt.id);if(elt.style.display!='none'){elt=list.form.ListUpdate_update;if(elt)elt.focus();}}
return true;}
else if(key==88){if(list.top_menu){if(list.top_menu.hasKey('trash'))list.top_menu.performActionKey('trash');else list.top_menu.performActionKey('delete');}
return true;}
else if(key==83){if(list.is_popup){elt=$(list_id+'-accept');if(elt)elt.onclick();else{elt=sListView.getCurrentRow(list_id);if(elt)
sListView.clickRowLink(elt);}
return true;}}}},destroy:function(list_id){var list=sListView.getListView(list_id);if(list){list.form=list.outer=list.filter=list.table=list.top_menu=list.bottom_menu=null;}},row_action:function(theRow,theAction,rowId,newState,ev){var ret=true,massChk,clickLink,found,list_id,targ,list,span,tag,ev;if(newState==='')newState=null;if(theRow.tagName.toLowerCase()=='input'){massChk=theRow;theRow=theRow.parentNode;while(theRow&&theRow.tagName){if(theRow.tagName.toLowerCase()=='tr'){found=true;break;}
theRow=theRow.parentNode;}
if(!found)return false;if(theAction=='click')theAction='ext_click';newState=massChk.checked;}
if(!rowId)rowId=theRow.getAttribute('data-id');var hoverCls='hoverRow',markCls='markRow',hovered=SUGAR.ui.hasClass(theRow,hoverCls),marked=SUGAR.ui.hasClass(theRow,markCls),removeCls=[],addCls='',selRange,ridx,orow,oidx;if(!theRow.cells||!theRow.cells.length)return ret;list_id=theRow.parentNode.parentNode.id.replace(/-main$/,'');list=sListView.getListView(list_id);span=list?list.row_span:2;if(theAction=='click'){ev=SUGAR.event.getEvent(ev);if(!ev)return true;targ=ev.target;while(targ&&targ.tagName){if(targ==theRow)
break;tag=targ.tagName.toLowerCase();if(tag=='a'||tag=='input'||tag=='button'||(tag=='div'&&(SUGAR.ui.hasClass(targ,'active-icon')||SUGAR.ui.hasClass(targ,'input-check'))))return true;targ=targ.parentNode;}
if((list&&list.is_popup&&(!list.form.multi_select||!list.form.multi_select.value)&&list.form.module)
||SUGAR.ui.hasClass(document.body,'mobile')){clickLink=true;newState=true;}
if(ev.shiftKey)
selRange=true;}
if(theAction=='click'||theAction=='mark'||theAction=='toggle'){var elts=theRow.cells[0].childNodes;for(var i=0;i<elts.length;i++){if(elts[i].name=='mass[]'){massChk=elts[i];break;}else if(elts[i].tagName=='DIV'&&SUGAR.ui.hasClass(elts[i],'input-check')&&elts[i].firstChild.name=='mass[]'){massChk=elts[i].firstChild;break;}}
if(massChk&&!isset(newState)){newState=(theAction=='mark')?true:(!massChk.checked);}
if(theAction=='toggle')theAction='click';}
if(theAction=='clear'){if(hovered)
removeCls.push(hoverCls);if(marked){removeCls.push(markCls);theRow.marked=false;}}
else if(theAction=='click'||theAction=='ext_click'||theAction=='mark'){if(marked&&!newState){removeCls.push(markCls);theRow.marked=false;}
else if(!marked&&newState){addCls=markCls;theRow.marked=true;}
else
theRow.marked=marked;ridx=Math.round(theRow.sectionRowIndex/span);if(selRange){orow=sListView.getCurrentRow(list_id);if(orow){oidx=Math.round(orow.sectionRowIndex/span);if(oidx!=ridx)
oidx+=(ridx>oidx?1:-1);while(oidx!=ridx){orow=sListView.getRow(list_id,oidx);if(orow)sListView.row_action(orow,'mark');oidx+=(ridx>oidx?1:-1);}}}
if(theAction!='ext_click'&&massChk&&massChk.checked==marked){massChk.checked=newState;if(massChk.onclick)
massChk.onclick(null);}
if(theAction!='mark'){list_id=theRow.parentNode.parentNode.id.replace(/-main$/,'');sListView.setCurrentIndex(list_id,ridx);}
ret=false;}
else{if(theAction=='over')
addCls=hoverCls;else if(theAction=='out')
removeCls.push(hoverCls);}
for(var i=0;i<removeCls.length;i++)
SUGAR.ui.removeClass(theRow,removeCls[i]);if(addCls)
SUGAR.ui.addClass(theRow,addCls);if(clickLink)setTimeout(function(){sListView.clickRowLink(theRow);},0);return ret;},clickRowLink:function(theRow,evt){var elts=theRow.getElementsByTagName('a');for(var i=0;i<elts.length;i++){if(SUGAR.ui.hasClass(elts[i],'listViewNameLink')){if(elts[i].onclick&&elts[i].onclick()===false){return true;}
if(elts[i].href){SUGAR.util.loadUrl(elts[i].href,null,true,evt,true);return true;}}}},setCurrentIndex:function(list_id,index,silent){var list=sListView.getListView(list_id),prev,row;if(!list||(!list.is_primary&&!list.is_popup&&!list.is_sidebar))return;if(isset(index))
row=list.table.tBodies[0].rows[index*list.row_span];if(isset(list.current_index))
prev=list.table.tBodies[0].rows[list.current_index*list.row_span];if(prev)SUGAR.ui.removeClass(prev,'currentRow');if(row){list.current_index=index;SUGAR.ui.addClass(row,'currentRow');if(!list.is_popup&&!silent)
SUGAR.util.scrollToElement(row);if(list.is_sidebar&&!silent)
this.clickRowLink(row);}else{list.current_index=null;}},setCurrentId:function(list_id,id,silent){var list=sListView.getListView(list_id),rc=sListView.getRowCount(list_id),i,r,offs,state;if(list){for(i=0;i<rc;i++){r=sListView.getRow(list_id,i);if(r&&r.getAttribute('data-id')==id){if(list.form&&list.form.list_current_id)list.form.list_current_id.value=id;if(list.filter&&list.filter.list_current_id)list.filter.list_current_id.value=id;if(list.form.module&&list.form.list_context&&list.form.list_context.value=='sidebar'){state=sListView.getExtendedState(list);offs=parseInt(list.form.list_offset.value,10)+i;state.params.list_offset=offs;state.params.list_limit=list.sidebar_limit;SUGAR.themes.saveDetailSidebar(state,list.form.module.value,id,$('sidebar-list-head'),$('sidebar-list-body'));}
return sListView.setCurrentIndex(list_id,i,silent);}}}},checkCurrentIndex:function(list_id){var list=sListView.getListView(list_id),rows,i;if(list&&list.table&&list.table.tBodies.length){if(!isset(list.current_index)){rows=list.table.tBodies[0].rows;for(i=0;i<rows.length;i++){if(rows[i].cells.length&&SUGAR.ui.hasClass(rows[i],'currentRow')){list.current_index=Math.round(i/list.row_span);break;}}}
return list.current_index;}},getCurrentRow:function(list_id){var list=sListView.getListView(list_id),rows,row,i,found;sListView.checkCurrentIndex(list_id);if(isset(list.current_index)){row=sListView.getRow(list_id,list.current_index);}else{rows=list.table.tBodies[0].rows;for(i=0;i<rows.length;i++){if(rows[i].cells.length&&SUGAR.ui.hasClass(rows[i],'markRow')){if(row)return false;row=rows[i];found=Math.round(i/list.row_span);}
i++;}
if(row)
sListView.setCurrentIndex(list_id,found,true);}
return row;},getRow:function(list_id,idx){var list=sListView.getListView(list_id);if(list&&list.table)return list.table.tBodies[0].rows[idx*list.row_span];},getRowCount:function(list_id){var list=sListView.getListView(list_id);if(list&&list.table)return list.table.tBodies[0].rows.length/list.row_span;},setSidebarTitle:function(){var list,offs,t,lbl=$('sidebar-list-title');if(this.sidebar_id&&(list=this.getListView(this.sidebar_id))&&list.form&&lbl){offs=parseInt(list.form.list_offset.value,10)+1;t=app_string('LBL_LIST_RESULTS')+' ('+offs+'\u2014'+(offs+list.result_count-1)+' '+app_string('LBL_LIST_OF')+' '+list.total_count+')'
SUGAR.ui.setElementText(lbl,t);}}};sugarListView.setupSubpanelsList=function(container_id){new SUGAR.ui.DragTarget('#'+container_id,sugarListView.drag_config);};sugarListView.drag_config={acceptedSourceTypes:['reorderSubpanels'],onAcceptSource:function(evt,data,source){return!source?'bubble':null;},drop_effect:'move',onEnter:function(evt,data){if(!data.values||!data.values.subpanel)return;SUGAR.dom.query('.subpanel-entry').addClass('subpanel-reorder');var Wrap=SUGAR.dom.elementOrId;this.draggingElt=Wrap(data.values.subpanel);requestAnimationFrame(function(){this.elt.closest().children('.subpanel-entry').css('opacity',0.5);evt.target.style.opacity=1;}.bind(this));},onDrop:function(evt,data){this.elt.closest().children('.subpanel-entry').css('opacity',1);var order=[];var list=sListView.getListView(data.values.list_id);list.drag=false;var module=list.parent_module;var tab=list.subpanel_tab;var srcEl=this.elt;var els=srcEl.children('.subpanel-entry');for(var i=0;i<els.length;i++){var id=els[i].id.replace(/-outer$/,'');var list=sListView.getListView(id);order.push(list.subpanel_name);}
var args={module:module,tab:tab,order:order};var success=function(data){};var req=new SUGAR.conn.JSONRequest('subpanel_order',null,args);req.fetch(success);},onMove:function(evt,data){if(!data.values||!data.values.subpanel){return;}
SUGAR.dom.query('.subpanel-entry').removeClass('dz-drag-hover');var Wrap=SUGAR.dom.elementOrId;var pos=evt.position();var p=evt.currentTarget;var elt=this.draggingElt;var target=Wrap(evt.target).closest('.subpanel-entry').get(0);if(!target)return;var region=SUGAR.ui.getEltRegion(target);if(pos.y>region.top+(region.height/2))
target=target.nextSibling;if(target){p.insertBefore(elt.get(),target);}else{p.appendChild(elt.get());}},checkAccept:function(evt,data){return data.values&&data.values.subpanel;}};sugarListView.row_action=sugarListView.prototype.row_action;sugarListView.toggleShrink=function(list_id){var list=sListView.getListView(list_id);if(list){if(list.drag){list.drag=false;return false;}}
var shown=toggleDisplay(list_id+'-body')!='none',title=$(list_id+'-title');if(title){SUGAR.ui.addRemoveClass(title,'sectionClosed',!shown);SUGAR.ui.addRemoveClass(title,'sectionOpen',shown);}
return false;}
sugarListView.registerSubpanelContainer=function(id){};sugarListView.toggleUpdate=function(outer_id){var shown=toggleDisplay(outer_id)!='none',fid=outer_id.replace(/^formContent-/,''),form=$(fid),head=$('formHeader-'+fid);if(form&&form.mass_panel_open)form.mass_panel_open.value=shown?1:0;if(head){SUGAR.ui.addRemoveClass(head,'sectionClosed',!shown);SUGAR.ui.addRemoveClass(head,'sectionOpen',shown);}
return false;}
sugarListView.loadSubpanels=function(form){var copy=['module','action','record','layout','layout_tab'],vars={},e,i,outer;form=SUGAR.ui.getForm(form);if(!form){console.error('subpanels form not found');return;}
for(i=0;i<copy.length;i++){e=form.elements[copy[i]];if(e)vars[e.name]=e.value;}
outer=$(form.getAttribute('name')+'-subpanels');if(vars.record&&outer){vars.record_perform='load_subpanels';SUGAR.ui.clearChildNodes(outer);outer.appendChild(createElement2('p',{style:'margin-top: 1em; text-align: center'},SUGAR.util.waitIcon()));SUGAR.conn.asyncRequest('async.php',{postData:vars,requireForm:form.name},function(data){SUGAR.util.loadContent(outer,data.responseText);sugarListView.setupSubpanelsList(outer.id);});}}
sugarListView.reloadSubpanel=function(name){var f,i;for(i=0;i<document.forms.length;i++){f=document.forms[i];if((f.name=='ListUpdate'||f.name=='PanelUpdate-'+name)&&f.list_id&&f.link_name&&f.link_name.value==name)return SUGAR.ui.refreshTarget('subpanel',f.list_id.value);}
return false;}
sugarListView.moveSubpanelRow=function(list_id,row_id,dir){var list=sListView.getListView(list_id)||{},name=list.name,reload=function(){sugarListView.reloadSubpanel(list.subpanel_name);},params={module:list.parent_module,record:list.parent_record,link_name:list.subpanel_name,target_id:row_id,offset:dir},req=new SUGAR.conn.JSONRequest('move_subpanel_row',null,params);if(list.type=='subpanel')
req.fetch(reload);}
sListView=new sugarListView();(function(){var re_cache={},num_pat=/(\d)(?=(\d\d\d)+(?!\d))/g;unformatNumber=function(n,num_grp_sep,dec_sep){if(!isset(num_grp_sep)||!isset(dec_sep))return n;n=n.toString();if(n.length>0){nsplit=n.split(dec_sep);if(num_grp_sep.length){if(!re_cache[num_grp_sep])
re_cache[num_grp_sep]=new RegExp(RegExp.escape(num_grp_sep),'g');n=nsplit[0].replace(re_cache[num_grp_sep],'');}
else{n=nsplit[0];}
if(nsplit.length>=2){n=''+n+'.'+nsplit[1];}
return parseFloat(n);}
return'';}
formatNumber=function(n,grp_sep,dec_sep,round,precision){if(!isset(grp_sep)||!isset(dec_sep))return n;n=n.toString();if(n.split)n=n.split('.');else return n;if(n.length>2)return n.join('.');if(isset(round)){if(round>0&&n.length>1){n[1]=parseFloat('0.'+n[1]);n[1]=Math.round(n[1]*Math.pow(10,round))/Math.pow(10,round);n[1]=n[1].toString().split('.')[1];}
if(round<=0){n[0]=Math.round(parseInt(n[0],10)*Math.pow(10,round))/Math.pow(10,round);n[0]=n[0].toString();n[1]='';}}
if(isset(precision)&&precision>=0){if(n.length>1&&isset(n[1]))n[1]=n[1].substring(0,precision);else n[1]='';if(n[1].length<precision){if(!n[0].length)n[0]='0';for(var wp=n[1].length;wp<precision;wp++)n[1]+='0';}}
if(grp_sep.length)
n[0]=n[0].replace(num_pat,'$1'+grp_sep);return n[0]+(n.length>1&&n[1]!=''?dec_sep+n[1]:'');}})();SUGAR.module('notify').init(function(){var loadTime,alertTimeout,notify=this;this.onInit(function(){this.reset();window.SM2_DEFER=true;});return{alerts:[],html5:{supported:function(){return isdef(window.webkitNotifications);},allowed:function(){return(webkitNotifications.checkPermission()===0);},enable:function(callback){if(!notify.html5.allowed())webkitNotifications.requestPermission(callback);else if(callback)callback();},create:function(params){if(!params||!params.title||!notify.html5.allowed())return false;var n=webkitNotifications.createNotification(params.icon,params.title,params.body);if(n){n.onclick=params.onclick;n.ondisplay=params.ondisplay;if(params.expiry){n.ondisplay=function(evt){setTimeout(function(){if(n)n.close();},params.expiry);if(params.ondisplay)params.ondisplay(evt);}}
n.onclose=params.onclose;n.show();}
return n;}},getSecondsLoaded:function(){return((new Date()).getTime()-loadTime)/1000;},addAlert:function(alert){if(!isPlainObject(alert))return;notify.alerts.push(alert);},checkAlerts:function(){var secondsSinceLoad=notify.getSecondsLoaded(),mj=0,msg,title='',body='',clickevt;for(mj=0;mj<notify.alerts.length;mj++){msg=notify.alerts[mj];if(!msg.done){if(msg.time<secondsSinceLoad&&msg.time>-1){title=msg.type+app_string('LBL_SEPARATOR')+msg.name;body=(msg.subtitle?msg.subtitle+'\n':'')+msg.description;msg.done=1;if(SUGAR.session.html5_notify&&notify.html5.allowed()){if(msg.redirect)clickevt=function(){SUGAR.util.loadUrl(msg.redirect);}
notify.html5.create({title:title,body:body,onclick:clickevt});}
else{title=html_escape(msg.name);if(msg.icon)
title='<div class="input-icon theme-icon module-'+msg.icon+'"></div> '+title;SUGAR.popups.showMessage(body,{title_html:title,cancel_button:!!msg.redirect,cancel_button_label:app_string('LBL_IGNORE_BUTTON_LABEL'),url:msg.redirect});}}}}},createSoundPlayer:function(playerId,url){var opts={id:playerId,url:url},mgr;if(!notify.soundManager){notify.soundManager=mgr=new SoundManager();mgr.setup({url:'include/images/player/',useHTML5Audio:true,debugMode:false,onready:function(){notify.soundManager.createSound(opts);},defaultOptions:{autoLoad:true,multiShot:true,stream:false,volume:100}});if(mgr.audioFormats.mp3)
mgr.audioFormats.mp3.required=false;mgr.beginDelayedInit();}else
notify.soundManager.createSound(opts);return playerId;},playSound:function(sound){notify.soundManager.play(sound);},initStatusCheck:function(timestamp,interval,mp3_url,no_sound){notify.status_check_timestamp=timestamp;notify.status_check_interval=interval;var init_player=function(){if(!notify.mail_sound_player)
notify.mail_sound_player=notify.createSoundPlayer('new_email_player',mp3_url);},init_interval=12000;if(!no_sound)
setTimeout(init_player,init_interval-10000);notify.newEmailAlert=function(){if(!no_sound){init_player();if(notify.mail_sound_player)notify.playSound(notify.mail_sound_player);}}
notify.status_check_timer=setTimeout(SUGAR.notify.checkStatus,init_interval);},checkStatus:function(no_sound){if(!isset(notify.status_check_timestamp)){notify.status_check_timestamp=0;}
if(!isset(notify.status_check_interval)){notify.status_check_interval=300000;}
var p=SUGAR.ui.PopupManager.currentModal();if(p&&p.id=='asyncLogin'){notify.status_check_timer=setTimeout(SUGAR.notify.checkStatus,notify.status_check_interval);return;}
var params={silent:true,global:true,timeout:Math.min(notify.status_check_interval-5000,120000)},req=new SUGAR.conn.JSONRequest('status_check',params,{timestamp:notify.status_check_timestamp,user_id:SUGAR.session.user_id});req.fetch(SUGAR.notify.returnStatusCheck);},returnStatusCheck:function(data){clearTimeout(notify.status_check_timer);notify.status_check_timer=setTimeout(SUGAR.notify.checkStatus,notify.status_check_interval);if(!data)return;try{var result=data.getResult();notify.status_check_timestamp=result.timestamp;var count_new=parseInt(result.new_emails);if(count_new>0){var msg=app_string(count_new==1?'NTC_NEW_EMAIL_MESSAGE':'NTC_NEW_EMAIL_MESSAGES');msg=msg.replace('%d',count_new);SUGAR.ui.showStatus(msg,3000);notify.newEmailAlert();var pid=sListView.getPrimaryId(),list,form;if(pid){list=sListView.getListView(pid);form=list.form;if(form&&form.module&&form.module.value=='Emails'&&form.list_offset&&form.list_offset.value==0
&&form.list_order_by&&form.list_order_by.value=='date_start DESC'){sListView.navigate(pid);}}}
var span=$('new_emails_counter');if(span){span.innerHTML=parseInt(result['unread_emails']);}
if(isset(result.alerts)){notify.reset();for(var i=0;i<result.alerts.length;i++)
notify.addAlert(result.alerts[i]);}}catch(e){console.error(e);}},reset:function(){this.alerts=[];loadTime=(new Date()).getTime();if(alertTimeout)
clearTimeout(alertTimeout);alertTimeout=setInterval(this.checkAlerts,5000);}};});SUGAR.module('util').init(function(App){var UT=this,TH=App.themes,Dom=App.dom,loadedScripts={},checkedPreloaded=false,pendingScripts=[],waitingOnLoad=0,runScriptsInterval,checkWindowEval=null,isIE=(navigator.userAgent.match(/MSIE 9\b/i)),isSafari=(navigator.userAgent.match(/WebKit\/(.*?)\b/i)),isSafari3=(isSafari&&isSafari[1]>=420),isGecko=(navigator.product=='Gecko'),detailsPopup=null,scrollInfo=null,keyHandlers=[];this.onDomReady(function(){window.addEventListener('beforeunload',UT.handleBeforeUnload);UT.initKeyHandler();UT.initDragHandler();UT.initResizeHandler();UT.initScrollHandler();});return{additionalDetailsCache:{},additionalDetailsCalls:{},loadUrl:function(addr,status,target,evt,delay){if(!isset(status))status=app_string('LBL_LOADING');evt=evt||window.event;if(target===true){if(window.metaKeyPressed||(evt&&(evt.which==2||(!evt.which&&evt.button==4)))){if(!Get_Cookie('ANDROID_APP'))
target='_blank';window.metaKeyPressed=false;}
else target=null;}
if(status&&!target)SUGAR.ui.showStatus(status);if(target)window.open(addr,target);else{if(delay){if(delay===true)delay=200;setTimeout(function(){location.href=addr;},delay);}
else location.href=addr;}
SUGAR.ui.stopEvent(evt);return false;},handleLink:function(evt,opts){if(!evt||!evt.target)return;var link=Dom.elementOrId(evt.target).closest('a');if(!link.length)return;var href=link.attr('href');if(!href||(!href.startsWith('index.php')&&!href.startsWith('?')))return;if(link.attr('data-async')=='false'){if(!opts)opts={};opts.async=false;}
if(link.attr('data-ignorechanges')){if(!opts)opts={};opts.ignore_changes=true;}
UT.navigateTo(href,evt,opts);return false;},navigateTo:function(url,evt,opts){if(!opts)opts={};if(isPlainObject(url))url='index.php?'+encodeQueryString(url);var async=true;if(!url||(!url.startsWith('index.php')&&!url.startsWith('async.php')&&!url.startsWith('?')))
async=false;if(!history.pushState||window.metaKeyPressed||(evt&&(evt.which==2||(!evt.which&&evt.button==4))))
async=false;if(SUGAR.session.request_method=='POST'||!get_default(opts.async,true))
async=false;if(!async){SUGAR.util.loadUrl(url,null,true,evt,opts.delay);}else{if(!opts.ignoredirty&&(m=UT.checkDirty())&&!confirm(m))return false;var query,p;if(url.startsWith('index.php'))
url='async.php?'+(query=url.substring(10));else{p=url.indexOf('?');query=(p>=0)?url.substring(p+1):'';if(p==0)url='async.php'+url;}
SUGAR.ui.PopupManager.closeAll();SUGAR.ui.addClass(document.body,'navigating');SUGAR.session.setLoadingState(null,null,true,query);TH.toggleSlideMenu(false);SUGAR.ui.stopEvent(evt);UT.fetchContentMain(url,{callback:function(){SUGAR.ui.removeClass(document.body,'navigating');}});}
return false;},handleBeforeUnload:function(evt){if(SUGAR.conn.abortAll)SUGAR.conn.abortAll();var msg=UT.checkDirty();if(msg)evt.returnValue=msg;return msg;},checkDirty:function(){var f=SUGAR.ui.getForm('DetailForm');if(SUGAR.ui.isPrimaryForm(f)&&SUGAR.ui.checkFormDirty(f)){return app_string('LBL_CHANGES_WARNING');}},useWindowEval:function(){if(checkWindowEval===null){checkWindowEval=false;if(window.eval){var chk='___useWindowEval___';window.eval('function '+chk+'() {}');if(window[chk]){delete window[chk];checkWindowEval=true;}}}
return checkWindowEval;},finishedScriptLoad:function(src,failed){waitingOnLoad--;},getPendingScripts:function(){return pendingScripts;},appendScriptBlock:function(text,source){if(isIE){var el=document.createElement('script');el.type="text/javascript";if(null==el.canHaveChildren||el.canHaveChildren){el.appendChild(document.createTextNode(text));}else{el.text=text;}
var head=document.getElementsByTagName('head')[0];head.appendChild(el);head.removeChild(el);}else{try{(function(data){window["eval"].call(window,text);})(text);}catch(e){if(source)
console.error("Error parsing "+source);else{console.error("Error parsing script literal",text);console.trace();}
throw e;}}},runPendingScripts:function(){if(isIE){runScriptsInterval=setInterval("SUGAR.util.runPendingScriptsImmed()",50);}else
UT.runPendingScriptsImmed();},runPendingScriptsImmed:function(){var head;while(pendingScripts.length){if(waitingOnLoad||((isIE||isSafari)&&document.readyState&&!/loaded|complete/.test(document.readyState))){if(!runScriptsInterval)
runScriptsInterval=setInterval("SUGAR.util.runPendingScriptsImmed()",50);return;}
if(runScriptsInterval){clearInterval(runScriptsInterval);runScriptsInterval=null;}
if(!head)head=document.getElementsByTagName('head')[0];var added=false;while(pendingScripts.length&&pendingScripts[0].src){var script=pendingScripts.shift();var urlparts=script.src.match(/^(\w+:)\/\/(.*?)\/(.*)$/);if(!urlparts||(urlparts[1]==location.protocol&&urlparts[2]==location.host)){waitingOnLoad++;var req=SUGAR.conn.asyncRequest(script.src,{callback_scope:script},function(data){UT.appendScriptBlock(data.responseText,script.src);UT.finishedScriptLoad(this.src);},function(){UT.finishedScriptLoad(this.src,true);});}
else{var el=document.createElement('script');el.type="text/javascript";el.src=script.src;if(isSafari3||isGecko||isIE>=8){waitingOnLoad++;el.onload=el.onreadystatechange=function(){UT.finishedScriptLoad(this.src);};el.onerror=function(){UT.finishedScriptLoad(this.src,true);};}
head.appendChild(el);}
added=true;}
if(added)
continue;if(pendingScripts[0].fn){var script=pendingScripts.shift();script.fn();continue;}
var script=pendingScripts.shift();if(!script.text)
continue;UT.appendScriptBlock(script.text,script.src);}},getBaseHref:function(){var h=document.location.href;var p;if((p=h.indexOf('?'))!=-1)
h=h.substring(0,p);if((p=h.lastIndexOf('/'))!=-1)
h=h.substring(0,p+1);return h;},checkPreloaded:function(){if(checkedPreloaded)return;var pfx=this.getBaseHref();var elts=document.getElementsByTagName('script');for(var i=0;i<elts.length;i++){if(elts[i].src){var src=elts[i].src;if(src.substring(0,pfx.length)==pfx)
src=src.substring(pfx.length);loadedScripts[src]=true;}}
checkedPreloaded=true;},evalScript:function(text,runAfter,defer){var objRegex=/(<script\b[^>]*>)(\s*<!--)?([\0\S\s]*?)<\/script\s*>/gim;var result=objRegex.exec(text)
var done_parse=0;this.checkPreloaded();while(result){if(m=result[1].match(/src="([^"]+)"/i)){var src=m[1].replace(/&amp;/g,'&');this.addScriptInclude(src,null,{deferExec:true});}
else{var sc=result[3];sc=sc.replace(/-->(\s|\v|\0)*$/i,'');if(sc)
pendingScripts.push({text:sc});}
result=objRegex.exec(text);}
if(runAfter)
pendingScripts.push({fn:runAfter});if(!defer)
UT.runPendingScripts();},addScriptInclude:function(src,runAfter,params){if(!params)params={};this.checkPreloaded();var pfx=this.getBaseHref();if(src.substring(0,pfx.length)==pfx)
src=src.substring(pfx.length);if(params.reload||!loadedScripts[src]){pendingScripts.push({src:src});loadedScripts[src]=true;}
if(runAfter)
pendingScripts.push({fn:runAfter});if(!params.deferExec)
UT.runPendingScripts();},disableInlineScripts:function(text){text=text.replace(/<script\b[\s\S]*?<\/script\s*>/ig,'');return text;},retrieveAndFill:function(url,theDiv,postForm,callback,callbackParam,appendMode,loadingMsg,scrollTo){var done=function(){SUGAR.session.setLoadingRequest(null);if(callback)callback(callbackParam);if(scrollTo)UT.scrollToElement(theDiv);},success=function(data){UT.loadContent(theDiv,data.responseText,appendMode,done);},req;if(isset(postForm))
req=SUGAR.conn.sendForm(postForm,{url:url,status_msg:loadingMsg},success);else
req=SUGAR.conn.asyncRequest(url,{status_msg:loadingMsg},success);SUGAR.session.setLoadingRequest(req);},fetchContentMain:function(url,params){if(!isset(params))params={};UT.maskDiv('content-main');if(!params.skipAbortReqs)
SUGAR.conn.abortPageRequests();var loadingMsg=params.loadingMessage||app_string('LBL_LOADING'),scrollTo=get_default(params.scrollTo,true);this.retrieveAndFill(url,'content-main',params.postForm,params.callback,params.callbackParam,params.appendMode,loadingMsg,scrollTo);},loadContent:function(elt,html,append,done){elt=$(elt);if(!elt){if(done)done();return null;}
if(!isset(html))html='';if(!isString(html)){SUGAR.ui.clearChildNodes(elt);SUGAR.ui.setElementContent(elt,html);if(done)done();return;}
try{var text=UT.disableInlineScripts(html);if(append)
elt.innerHTML+=text;else
elt.innerHTML=text;UT.evalScript(html,done);}
catch(e){console.error(e);}},scrollToElement:function(elt){var info,t,p;if(scrollInfo&&scrollInfo.timer)
clearTimeout(scrollInfo.timer);if(isString(elt))elt=$(elt);if(elt&&elt.id==='content-main'&&(t=$('main-title')))
elt=t;for(p=elt;p;p=p.parentNode){if(p.tagName&&p.style.position=='absolute')return;}
info=scrollInfo={count:0,elt:elt,first:window.pageYOffset};info.timer=setInterval(function(){UT.scrollStep(info);},50);},scrollStep:function(info){var abort=false,curtop=window.pageYOffset;if(info!==scrollInfo||!isElement(info.elt)||!SUGAR.ui.inDocument(info.elt))
abort=true;else if(info.count>10000)
abort=true;else if(isset(info.last)&&Math.abs(info.last-curtop)>10)
abort=true;if(!abort){var viewp=SUGAR.ui.getViewport(10),pos=SUGAR.ui.getEltRegion(info.elt),sgn,diff,bottom,newpos;if(!viewp||!pos)return;diff=viewp.y-pos.y;bottom=pos.y+Math.min(pos.height,300);if(diff>0){sgn=-1;}else if(bottom>viewp.y+viewp.height&&diff<0){sgn=1;diff=Math.min(bottom-viewp.y-viewp.height,-diff);}else
abort=true;if(sgn){step=Math.min(Math.max(15,Math.min(Math.round(diff/3),80)),diff);newpos=curtop+step*sgn;window.scrollTo(window.pageXOffset,newpos);info.last=newpos;}}
if(abort){if(info.timer)
clearTimeout(info.timer);}},maskDiv:function(theDiv,maskId){if(!maskId)maskId='mask';var parentId=maskId+'Parent',mask=this[maskId];if(!mask)
mask=this[maskId]=createElement2('div',{className:'divMask'});theDiv=$(theDiv);if(!theDiv)return;this[parentId]=theDiv;theDiv.oldPos=theDiv.style.position;theDiv.style.position='relative';theDiv.appendChild(mask);mask.style.opacity=0.0;mask.style.display='block';mask.style.cursor='wait';mask.onselectstart=mask.onmousedown=mask.onclick=SUGAR.ui.stopEvent;setTimeout(function(){mask.style.opacity=null;},50);this.testHideMask(maskId);return maskId;},hideMask:function(maskId,parentId){if(!isset(parentId))parentId=maskId+'Parent';if(!this[parentId]||!this[maskId])return;this[parentId].style.position=this[parentId].oldPos;this[maskId].style.display='none';this[parentId]=null;},testHideMask:function(maskId){var parentId=maskId+'Parent';if(!this[maskId]||!this[parentId])return;if(!this[maskId].parentNode||this[maskId].parentNode!=this[parentId]){this.hideMask(maskId,parentId);}else
setTimeout("SUGAR.util.testHideMask('"+maskId+"')",500);},getPageTitle:function(){return document.title;},setPageTitle:function(str){document.title=str;},getAdditionalDetails:function(bean,id,spanId,extraArgs,context,delay){if(!extraArgs){extraArgs={};}
var go=function(){var oReturn;if(spanId.apply)
oReturn=spanId;else
oReturn=function(body,caption,width){var dlg=new SUGAR.ui.MiniDialog(null,{target:spanId,target_offset:{left:13},width:(width||300)+'px'});dlg.loadContent(body,function(){SUGAR.popups.initContent({title:caption,fill:true});});dlg.show();return dlg;}
var cachekey=bean+':'+id;if(context)cachekey+=':'+context;var success=function(data){delete(UT.additionalDetailsCalls[spanId]);if(data){UT.additionalDetailsCache[cachekey]=data.getResult();}
var cache=UT.additionalDetailsCache[cachekey];if(cache)return oReturn(cache['body'],cache['caption'],cache['width']);return false;}
var cache=UT.additionalDetailsCache[cachekey];if(isset(cache))return oReturn(cache['body'],cache['caption'],cache['width']);if(typeof UT.additionalDetailsCalls[spanId]!='undefined')return;extraArgs.bean_name=bean;extraArgs.record=id;extraArgs.context=context;var args=(context=='refinput'?{silent:true}:null);var req=UT.additionalDetailsCalls[spanId]=new SUGAR.conn.JSONRequest('additional_details',args,extraArgs);req.fetch(success);UT.additionalDetailsLastCall=spanId;return false;}
UT.additionalDetailsRpcCall=window.setTimeout(go,get_default(delay,250));},clearAdditionalDetailsCall:function(){if(typeof UT.additionalDetailsRpcCall=='number')
window.clearTimeout(UT.additionalDetailsRpcCall);if(UT.additionalDetailsLastCall){var call=UT.additionalDetailsCalls[UT.additionalDetailsLastCall];if(call){call.abort();delete(UT.additionalDetailsCalls[UT.additionalDetailsLastCall]);}
UT.additionalDetailsLastCall=null;}},getPos:function(elt){var pos={'left':0,'top':0,'width':0,'height':0};if(elt){pos.width=elt.offsetWidth;pos.height=elt.offsetHeight;}else
pos.failed=true;var foundCell=false;while(elt&&elt.nodeName!="BODY"){pos.left+=elt.offsetLeft;pos.top+=elt.offsetTop;if(!foundCell&&elt.nodeName=='TD'){foundCell=true;pos.cellTop=pos.top;}
elt=elt.offsetParent;}
pos.right=pos.left+pos.width;pos.bottom=pos.top+pos.height;return pos;},checkNavigationTag:function(category){var tag=document.location.hash||'';var key='#nav';if(category)key+='-'+category;if(tag.substring(0,key.length+1)==key+':')return tag.substring(key.length+1);return false;},setNavigationTag:function(tag,category){var key='#nav';if(category)key+='-'+category;document.location.hash=key+':'+tag;},fadeTimers:{},fadeOutAfter:function(elt,timeout,duration){if(this.fadeTimers[elt]){clearTimeout(this.fadeTimers[elt].timer);}
if(!isset(duration))duration=0.25;var stat={anim:new App.animation.Animation().distribute(20,function(percent){return{opacity:(100-percent)/100}}).duration(duration*1000).timing('ease-out').onEnd(function(){App.dom.extNode(elt).hide()})};this.fadeTimers[elt]=stat;stat.timer=setTimeout(function(){stat.anim.run(elt);},timeout||0);},showPrintConfig:function(button,pdf_type){if(!button.form)return;var popup=new SUGAR.ui.MiniDialog('print-config',{modal:true,target:button.elt}),vars={action:'PDF',config:true};if(pdf_type)vars.pdf_type=pdf_type;popup.fetchFormContent(button.form,vars,{url:'async.php'},null,true);},showTemplatePrintConfig:function(button,pdf_type){if(!button.form)return;var popup=new SUGAR.ui.MiniDialog('print-template-config',{modal:true,target:button.elt||button,target_active_class:'active opened',close_on_ext_click:false}),vars={action:'PrintTemplate',config:true};popup.fetchFormContent(button.form,vars,{url:'async.php'},null,true);},initKeyHandler:function(){Dom.extNode(document).on('keydown',UT.keyDownHandler).on('keyup',UT.keyUpHandler);Dom.extNode(window).on('blur',UT.winBlurHandler);},addKeyHandler:function(handler){keyHandlers.push(handler);},keyUpHandler:function(evt){window.metaKeyPressed=evt.cmdKey;},keyDownHandler:function(evt){var tgt=evt.target,tag,id;if(evt.ctrlKey||evt.metaKey){window.metaKeyPressed=true;return;}
while(tgt&&tgt.tagName){tag=tgt.tagName.toLowerCase();if(tag=='input'||tag=='textarea'||tag=='select'||SUGAR.ui.hasClass(tgt,'input-field')||SUGAR.ui.hasClass(tgt,'input-button'))return;tgt=tgt.parentNode;}
for(var i=0;i<keyHandlers.length;i++){if(keyHandlers[i](evt.originalEvent)){return;}}
var popup=SUGAR.popups.getCurrent();if(popup&&popup.modal){if(popup.list_id&&sListView.handleKeyDown(popup.list_id,evt)){SUGAR.ui.stopEvent(evt);return;}}
if((id=sListView.getPrimaryId())||(id=sListView.getSidebarId())){if(sListView.handleKeyDown(id,evt)){SUGAR.ui.stopEvent(evt);return;}}
if(evt.keyCode==191&&evt.shiftKey){tgt=SUGAR.ui.getFormInput('UnifiedSearch','query_string');if(tgt){tgt.focus();SUGAR.ui.stopEvent(evt);return;}}
tgt=null;if(evt.keyCode==69)
tgt=$('DetailForm_edit');else if(evt.keyCode==68)
tgt=$('DetailForm_duplicate');else if(evt.keyCode==76)
tgt=$('DetailForm_return_list');else if(evt.keyCode==84)
SUGAR.util.scrollToElement('content-main');else if(evt.keyCode==88)
tgt=$('DetailForm_delete')||$('DetailForm_trash');else if(evt.keyCode==112)
tgt=$('module-help');else if(evt.keyCode==192){tgt=SUGAR.ui.getMenuSource(null,evt.shiftKey?'tbar-profile':'grouptab-0');if(tgt){tgt.showPopup();SUGAR.ui.stopEvent(evt);return;}}
if(tgt&&tgt.onclick){tgt.onclick();SUGAR.ui.stopEvent(evt);return;}},drag_elt_count:0,initDragHandler:function(){Dom.extNode(document).on('dragenter, dragover, dragleave, drop',UT.handleDrag);},handleDrag:function(e){var targ=e.target,tag=targ&&targ.tagName.toLowerCase();if(tag=='input'||tag=='textarea'||tag=='button')return;if(e.dataTransfer.files||e.dataTransfer.mozItemCount){e.stopEvent();if(e.type=='drop'){if(e.dataTransfer.files.length);UT.endDrag();}
else if(e.type=='dragleave'){setTimeout(function(){UT.drag_elt_count--;if(UT.drag_elt_count<=0)
UT.endDrag();},1);}
else if(e.type=='dragenter'){if(!UT.drag_elt_count){}
UT.drag_elt_count++;}}},endDrag:function(){UT.drag_elt_count=0;if(UT.drag_dlg)UT.drag_dlg.close();},initResizeHandler:function(){SUGAR.ui.addResizeHook(UT.handleResize,UT);},handleResize:function(evt,sz,osz){var tog,pts=TH.page_breakpts,md=pts[2].width,lg=pts[3].width;if(osz){if(osz.w>=md&&sz.w<md)
tog=false;else if(osz.w<md&&sz.w>=md){tog=true;TH.toggleSlideMenu(false);}
if(isset(tog))TH.resizeToggleSidebar(tog);}
var i,pgsz,cls,remcls=[];for(i=0;i<pts.length;i++){if(pts[i].width&&sz.w<pts[i].width)break;pgsz=pts[i].name;}
for(i=0;i<document.body.classList.length;i++){cls=document.body.classList.item(i);if(cls.match(/^pgsz-/))remcls.push(cls);}
if(pgsz)
remcls.remove('pgsz-'+pgsz);for(i=0;i<remcls.length;i++)
document.body.classList.remove(remcls[i]);if(pgsz)
document.body.classList.add('pgsz-'+pgsz);if(TH.pageSizeClass!==pgsz){TH.pageSizeClass=pgsz;Dom.extNode(window).emit('page-size',pgsz);}},getPageSize:function(){return TH.pageSizeClass;},move_sidebar:null,move_timeout:null,initScrollHandler:function(){SUGAR.ui.addScrollHook(UT.handleScroll,UT);},handleScroll:function(evt,pos,oldpos){var floatm=TH.topMenuFloat(),m=$('tab-bar'),s=$('left-sidebar'),s2,main=$('content-main'),mt,diff,ssz=SUGAR.ui.getEltRegion(s),siz,top,btm,a,b,view=SUGAR.ui.getViewport(),menusz=TH.topMenuSize(1);if(floatm&&m){if(pos.y>10&&(oldpos.y<=10||oldpos.first)){SUGAR.ui.addClass(m,'compact');}
else if(pos.y<10&&(oldpos.y>=10||oldpos.first)){SUGAR.ui.removeClass(m,'compact');}}
if(floatm&&main&&s&&(s2=s.firstChild)&&!isIPhone&&TH.sidebarOpen()){siz=SUGAR.ui.getEltRegion(s2);a=Math.max(ssz.top,ssz.bottom-siz.height)-pos.y;b=Math.min(view.height+view.offset-siz.height,ssz.bottom-siz.height-pos.y);btm=Math.min(a,b);a=ssz.top-pos.y;b=menusz;if(btm>a&&b>a){s.style.minHeight=''+siz.height+'px';UT.move_sidebar=[
''+(ssz.left-pos.x)+'px',''+Math.min(btm,b)+'px'
];}else{UT.move_sidebar=false;}
UT.moveSidebar();}},moveSidebar:function(){var s=$('left-sidebar').firstChild;if(UT.move_sidebar){SUGAR.ui.addClass(s,'fixed');s.style.left=UT.move_sidebar[0];s.style.top=UT.move_sidebar[1];}else if(UT.move_sidebar===false){SUGAR.ui.removeClass(s,'fixed');s.style.top=s.style.left='';}
UT.move_sidebar=null;UT.move_timeout=null;},winBlurHandler:function(){window.metaKeyPressed=false;},showHelp:function(module){var url='docs/index.php';if(module)url+='?module='+encodeURIComponent(module);UT.loadUrl(url,null,'_blank');return false;},waitIcon:function(attrs){var lbl=app_string('LBL_LOADING'),ret,i;if(!attrs)attrs={};if(!attrs.img&&(isdef(document.body.style.animation)||isdef(document.body.style.WebkitAnimation))){ret=createElement2('div',{className:'wait-icon dynamic'+(attrs.small?' small':''),title:lbl});for(i=1;i<=3;i++)
createElement2('div',{className:'bar'+i},null,ret);return ret;}
return createElement2('img',{src:'themes/Default/images/sqsWait.gif',className:'wait-icon',width:16,height:16,title:lbl});}};});SUGAR.module('language').init(function(){var LANG=this,langs={};var LangList=function(keys,vals){this.keys=keys;this.values=vals;this.getKeys=function(){return this.keys;}
this.getValues=function(){return this.values;}
this.getObject=function(){var ret={};if(this.keys){for(var i=0;i<this.keys.length;i++)
ret[this.keys[i]]=this.values[i];}
return ret;}
this.getString=function(key){if(this.keys&&isset(key)){var p=this.keys.indexOf(key);if(p>=0)return this.values[p];}}
this.length=function(){return this.keys?this.keys.length:0;}
this.getOptions=function(){return{keys:this.keys,values:this.values};}}
return{changeTo:function(lang){var s=location.search.replace(/[&?]user_language=\w+/,'');location.href=(s?s+'&':'?')+'user_language='+lang;},populate:function(data){if(typeof(data)!='object'||!data.language||!data.name)return;if(!langs[data.language])langs[data.language]={app:{strings:{},lists:{keys:{},values:{}}}};if(!data.strings)data.strings={};if(!data.lists)data.lists={keys:{},values:{}};langs[data.language][data.name]=data;},getModule:function(module,language){if(!language)language=SUGAR.session.language;if(!module||module=='current')module=SUGAR.session.module;if(!langs[language])return null;if(!langs[language][module])module='app';return langs[language][module];},getString:function(str,module,language){if(!str)return str;while(1){var mod=LANG.getModule(module,language);if(!mod)return str;var ret=mod.strings[str];if(isset(ret))return ret;inh=mod.inherit_from||'app';if(inh==mod.name||inh==module)return str;module=inh;}},getList:function(str,module,language){if(!str)return str;while(1){var mod=LANG.getModule(module,language);if(!mod)return false;if(mod.lists.keys){var keys=mod.lists.keys[str];if(isset(keys))return new LangList(keys,mod.lists.values[str]);}
inh=mod.inherit_from||'app';if(inh==mod.name)return false;module=inh;}},getListString:function(dom,val,module,language){var list=this.getList(dom,module,language);if(list)return list.getString(val);},addList:function(str,value,language){var mod=LANG.getModule('app',language),p;if(mod&&value&&value.keys){mod.lists.keys[str]=value.keys;mod.lists.values[str]=value.values;return true;}
return false;},getLoaded:function(){var mods=[],ms=langs[SUGAR.session.language],m;if(ms)
for(m in ms)mods.push(m);return mods;},get:function(lang_list,str){if(lang_list=='mod_strings')
lang_list=null;else if(lang_list=='app_strings')
lang_list='app';else if(lang_list=='app_list_strings'){var list=LANG.getList(str,'app'),ret={};if(list)ret=list.getObject();return ret;}
return LANG.getString(str,lang_list);}};});SUGAR.module('themes').init(function(App){var TH=this,Wrap=App.dom.elementOrId,makeElt=App.dom.makeElement;this.onDomReady(function(){TH.detectFeatures();TH.addListeners();TH.initSidebar();});return{side_arrow_width:10,menu_offset:{left:8,top:-2},left_col_div:'left-sidebar',show_left_col:null,auto_hide_menu:'',font_styles:{},color_styles:{},prev_link_elt:{},sidebar_list:null,init_page_hooks:[],page_breakpts:[{name:'xs'},{name:'sm',width:768},{name:'md',width:992},{name:'lg',width:1200}],changeTo:function(theme){var s=location.search.replace(/[&?]user_theme=\w+/,'');location.href=(s?s+'&':'?')+'user_theme='+encodeURIComponent(theme);},changeCss:function(style){var s=location.search.replace(/[&?]theme_style=\w+/,'');location.href=(s?s+'&':'?')+'theme_style='+encodeURIComponent(style);},changeColor:function(colorName){for(var c in this.color_styles)
SUGAR.ui.removeClass(document.body,'color-'+c);if(isset(this.color_styles[colorName]))return this.changeStyle('color',colorName,this.color_styles[colorName]);return false;},changeFont:function(fontName){for(var c in this.font_styles)
SUGAR.ui.removeClass(document.body,'font-'+c);if(isset(this.font_styles[fontName]))return this.changeStyle('font',fontName,this.font_styles[fontName]);return false;},changeStyle:function(styleType,styleName,newStyle){if(newStyle.link_elt&&newStyle.link_elt==this.prev_link_elt[styleType])return true;if(!this.prev_link_elt[styleType])
this.prev_link_elt[styleType]=$('theme:'+styleType);var prev=this.prev_link_elt[styleType];var nstyle=null;if(newStyle.link_elt){nstyle=newStyle.link_elt;}else if(newStyle.href){nstyle=document.createElement('link');nstyle.type='text/css';nstyle.title=newStyle.title;nstyle.href=newStyle.href;nstyle.disabled=true;nstyle.setAttribute('rel','stylesheet');nstyle.id='';document.getElementsByTagName('head')[0].appendChild(nstyle);newStyle.link_elt=nstyle;}
if(nstyle)
nstyle.disabled=false;this.prev_link_elt[styleType]=nstyle;SUGAR.ui.addClass(document.body,styleType+'-'+styleName);if(prev)
prev.disabled=true;Set_Cookie(''+SUGAR.session.theme+'_'+styleType+'_style',styleName,365,'/','','');return true;},initLeftCol:function(override_show){var showLeftCol=Get_Cookie('showLeftCol');if(isset(TH.show_left_col))
showLeftCol=TH.show_left_col?'true':'false';if(showLeftCol===null){showLeftCol='true';Set_Cookie('showLeftCol',showLeftCol,30,'/','','');}
TH.toggleLeftCol(showLeftCol=='true');},toggleLeftCol:function(show){var leftCol=$(TH.left_col_div);var hideHandle=$('HideHandle');if(!leftCol)return;if(typeof(show)=='undefined')
show=(leftCol.style.display=='none'||leftCol.oldParent);var modulesMenu=$('modulesMenu');var modulesSrc=$('modulesMenuSource');var autoMenu;if(TH.auto_hide_menu)
autoMenu=$(TH.auto_hide_menu);if(show){if(leftCol.oldParent){leftCol.oldParent.appendChild(leftCol);leftCol.oldParent=null;}
if(modulesMenu){if(modulesSrc)
modulesSrc.style.display='none';if(modulesMenu.oldParent){modulesMenu.oldParent.appendChild(modulesMenu);modulesMenu.oldParent.style.display='';modulesMenu.oldParent=null;}}
leftCol.style.display='block';if(!isset(TH.show_left_col))
Set_Cookie('showLeftCol','true',30,'/','','');if(hideHandle){if(hideHandle.src)
hideHandle.src=TH.imagePath+'hide.gif';else
hideHandle.style.backgroundPosition='0 0';}
if(autoMenu)
autoMenu.style.display='none';}else{leftCol.style.display='none';if(modulesMenu){var modulesPopup=$('modulesMenuPopup');if(modulesPopup&&modulesSrc){modulesMenu.oldParent=modulesMenu.parentNode;modulesMenu.parentNode.style.display='none';modulesPopup.appendChild(modulesMenu);modulesSrc.style.display='';}}
if(!isset(TH.show_left_col))
Set_Cookie('showLeftCol','false',30,'/','','');if(hideHandle){if(hideHandle.src)
hideHandle.src=TH.imagePath+'show.gif';else
hideHandle.style.backgroundPosition='-10px 0';}
if(autoMenu)
autoMenu.style.display='';}},showHiddenMenu:function(targ,offset){if(!isset(offset))offset={left:TH.side_arrow_width};var hideMenu=$('HideMenu');var leftCol=$(TH.left_col_div);if(!leftCol||!hideMenu)return;if(leftCol.style.display=='none'){if(!leftCol.oldParent)
leftCol.oldParent=leftCol.parentNode;hideMenu.appendChild(leftCol);leftCol.style.display='block';}
SUGAR.popups.showPopup(targ,hideMenu,offset);},chooseTab:function(tab,evt){Set_Cookie('parentTab',tab,0,'/','','');SUGAR.util.handleLink(evt);},findGroupTab:function(){var pg=TH.page_info||{},target=pg.module,cookieSel=Get_Cookie('parentTab'),i,j,grp,tab,active,target;if(pg.state){if(pg.state.module)target=pg.state.module;if(pg.state.context==='dashboard')
target=pg.state.layout;}
if(!TH.menuStructure||!TH.menuStructure.grouped)return;for(i=0;i<TH.menuStructure.grouped.length;i++){grp=TH.menuStructure.grouped[i];for(j=0;j<grp.modules.length;j++){tab=grp.modules[j];if(grp.id===cookieSel&&(tab.module===target||tab.id===target)){active={key:grp.key,index:i,active_index:j};break;}
if(!active&&(tab.module===target||tab.id===target)){active={key:grp.key,index:i,active_index:j};}}}
return active;},updateCurrentTab:function(index){if(!isset(index))return;var i=0,current=[],UI=SUGAR.ui,tab,found;while(true){tab=$('grouptab-'+i);if(!tab)
break;if(UI.hasClass(tab,'current'))
current.push(tab);if(i===index)
found=tab;i++;}
if(found){for(i=0;i<current.length;i++)
UI.removeClass(current[i],'current');UI.addClass(found,'current');}},initTopMenu:function(){var i,j,e,req,o,m,ms,plus,grp;if(!$('grouptab-0'))return;if(!isset(TH.menuStructure)){req=new SUGAR.conn.JSONRequest('get_menu_structure',{silent:true,global:true});req.fetch(function(){TH.menuStructure=this.getResult();TH.initTopMenu();});return;}
if(TH.menuStructure.grouped&&!TH.disableGroupTabs){TH.groupMenus={};TH.groupOptions={};var topOpts={keys:[],values:[]};for(i=0;i<TH.menuStructure.grouped.length;i++){grp=TH.menuStructure.grouped[i];topOpts.keys.push(i);topOpts.values.push(grp.label);e=$('grouptab-'+i);if(e){e.grpIndex=i;ms=grp.modules;o={keys:[],values:[]};for(j=0;j<ms.length;j++){o.keys.push(ms[j].id||ms[j].module);ms[j].icon=(ms[j].icon||'theme-icon module-'+ms[j].module);o.values.push(ms[j]);}
TH.groupOptions[i]=o;m=TH.groupMenus[i]=SUGAR.ui.registerMenuSource(
e.firstChild,{id:e.id,options:o,hover_show:true,icon_key:'icon',delay:250,width:200,ext_class:'popup-global moduleMenu',target_offset:TH.menu_offset},null,'group-toolbar');m.setup();m.menu.oncurrent=function(idx,old){if(this.touch_opened)return;var r=this.getOptionRow(idx);var v=this.getValue(this.getKey(idx));if(r&&v&&v.create){if(!plus){plus=createElement2('span',{className:'uii uii-add active-icon'});plus=createElement2('div',{className:'option-cell input-label option-icon'},plus);}
plus.onmousedown=function(e){e.stopPropagation();}
plus.onclick=function(e){SUGAR.util.navigateTo({module:v.module,action:'EditView'});SUGAR.ui.stopEvent(e);SUGAR.popups.close();}
r.appendChild(plus);}else if(plus)
SUGAR.ui.removeNode(plus);}}}
TH.topOpts=topOpts;TH.addSlideAppMenu();TH.updateModuleMenu();}
TH.initTopSearch();},updateTopMenu:function(){var found=TH.findGroupTab();TH.updateCurrentTab(found&&found.index);},updateModuleMenu:function(){var found=TH.findGroupTab(),mods=found&&TH.menuStructure.grouped[found.index].modules,outer=$('sidebar-modules');TH.displayModuleMenu(mods,found,outer);},displayModuleMenu:function(mods,found,outer){if(TH.enable_module_sidebar){var opts;if(found){opts={keys:[],values:[]};for(var i=0;i<mods.length;i++){opts.keys.push(mods[i].id||mods[i].module);opts.values.push(mods[i]);}}
TH.renderSidebarMenu(outer,opts,'modules',null,opts&&opts.keys[found.active_index]);}},addSlideAppMenu:function(){var toggle=Wrap('tbar-mobile');if(!toggle)return;toggle.on('click',function(){TH.toggleSlideMenu('main');return false;});TH.sideMask=makeElt('div.appside-menu-mask').appendTo(document.body).on('click',function(){TH.toggleSlideMenu(false);});},renderAppSearch:function(side,target){side=!!side;var searcher=new App.ui.SearchSelect('app-search',{flat:side,search_title:app_string('LBL_SEARCH_QUICK_VIEW'),ext_class:side?'card-outer appside-menu-panel':'popup-global',disable_auto_select:true,destroy_on_close:true,dynamic_module:true,global_search:true,icon_key:'icon',show_checks:!side,search_clear:false,allow_popup:true,search_blank:true,matching_only:true,modules:SUGAR.session.search_modules});if(!side){searcher.target=target;searcher.target_offset={top:-2,outer_margin:0};searcher.target_active_class='active';}
searcher.onchange=function(k,v,mod,keepOpen,evt){if(!v)return;if(v.query_source)mod=v.query_source;var url='index.php?module='+encodeURIComponent(mod)+'&action=DetailView&record='+encodeURIComponent(k);SUGAR.util.navigateTo(url,evt,{delay:true});}
searcher.onaccept=searcher.onpopup=function(val,evt){var q=trim(this.getQuery()),m=this.getModule(),url;if(m)
url='index.php?module='+encodeURIComponent(m)+'&action=ListView&layout=Browse&query=true&filter_text='+encodeURIComponent(q);else
url='index.php?module=Home&action=UnifiedSearch&query_string='+encodeURIComponent(q);SUGAR.util.navigateTo(url,evt,{delay:true});this.close();return true;}
searcher.setup();searcher.render();searcher.showDefault();return searcher;},toggleSlideMenu:function(mode,keepOpen){var state,$body=Wrap(document.body);if(mode){if(mode!=='search')mode='main';var open=$body.hasClass('appside-open-'+mode);state=keepOpen||!open;}else{state=false;}
$body.toggleClass('appside-open',state);$body.toggleClass('appside-open-main',mode==='main'&&state);$body.toggleClass('appside-open-search',mode==='search'&&state);if(state){SUGAR.popups.hidePopup();var menu=Wrap('app-side');menu.cssSize('top',document.body.scrollTop);if(mode==='search'){var inner=menu.findFirst('.appside-search');TH.appMenuSearch=inner.ext(0)||makeElt('div.appside-search').appendTo(menu);var searcher=TH.renderAppSearch(true);TH.appMenuSearch.empty().append(searcher.elt);requestAnimationFrame(function(){searcher.focus();});}
else if(!TH.appMenuMain){var inner=menu.findFirst('.appside-main');inner=inner.ext(0)||makeElt('div.appside-main').appendTo(menu);var mainInput=new SUGAR.ui.SelectList('app-menu-main',{flat:true,expand:true,ext_class:'appside-menu',options:TH.topOpts});mainInput.onchange=function(){var idx=this.getSelectedIndex(),val=this.getSelectedValue();var opts=deep_clone(TH.groupOptions[idx]);TH.showAltSlideMenu(val,opts);this.setSelectedKey(null,true);}
inner.append(mainInput.render());mainInput.setup();TH.appMenuMain=inner;TH.appMenu=mainInput;var scOuter=makeElt('div.app-sc-outer');var scInput=new SUGAR.ui.SelectList('app-menu-sc',{flat:true,ext_class:'appside-menu',icon_key:'icon'});scInput.onchange=function(old,evt){var v=this.getSelectedValue();SUGAR.util.navigateTo(v.url,evt,{delay:true,async:get_default(v.async,true)});this.setSelectedKey(null,true);}
scOuter.append(makeElt('label.appside-menu-label',app_string('LBL_SHORTCUTS')));scOuter.append(scInput.render());inner.append(scOuter);scInput.setup();TH.appScOuter=scOuter;TH.appScInput=scInput;var alt=menu.findFirst('.appside-alt');alt=alt.ext(0)||makeElt('div.appside-alt:hidden').appendTo(menu);var altReturn=makeElt('a.appside-menu-link.tools-row',{href:'#'}).on('click',function(){TH.toggleSlideMenu('main',true);return false;}).append(makeElt('span.no-flex').append(makeElt('span.uii.uii-previous'))).append(makeElt('span',nbsp(),app_string('LBL_BACK'))).appendTo(alt);var altInput=new SUGAR.ui.SelectList('app-menu-alt',{flat:true,ext_class:'appside-menu',icon_key:'icon'});altInput.onchange=scInput.onchange;alt.append(TH.altTitle=makeElt('label.appside-menu-label'));alt.append(altInput.render());altInput.setup();TH.appMenuAlt=alt;TH.altMenu=altInput;}
if(TH.appMenuSearch)TH.appMenuSearch.toggle(mode==='search');if(TH.appMenuMain){TH.appMenuAlt.hide();if(mode==='search'){TH.appMenuMain.hide();}else{TH.appScInput.setOptions((TH.page_info||{}).shortcuts);TH.appScOuter.toggle(TH.appScInput.getOptions().getCount());TH.appMenuMain.show();}}}},showAltSlideMenu:function(label,opts){var menu=Wrap('app-side');TH.appMenuMain.hide();TH.altTitle.text(label);TH.altMenu.setOptions(opts);TH.appMenuAlt.show();},addPopupAppMenu:function(){var nextMenu=new SUGAR.ui.MenuSource(
'mobile-next-menu',{elt:$('tbar-mobile'),icon_key:'icon',width:200,ext_class:'popup-global siteMenu',target_offset:{align:'center',outer_margin:0}},null,'system-toolbar');topOpts=TH.topOpts;nextMenu.initMenu();topOpts.keys.push('shortcuts');topOpts.values.push(app_string('LBL_SHORTCUTS'));m=SUGAR.ui.registerMenuSource(
$('tbar-mobile'),{id:'mobile-menu',options:topOpts,hover_show:true,expand:true,delay:250,width:200,ext_class:'popup-global siteMenu',target_offset:{align:'center',outer_margin:0}},null,'system-toolbar');m.setup();m.onchange=function(idx,val){var opts;if(typeof(idx)=='number'){opts=deep_clone(TH.groupOptions[idx]);opts.keys.unshift('_');opts.values.unshift({_header:true,label:val});}
else if(idx==='shortcuts'){var opts=(TH.page_info||{}).shortcuts;opts.keys.unshift('_');opts.values['_']={_header:true,label:app_string('LBL_SHORTCUTS')};}
if(opts){nextMenu.menu.setOptions(opts);nextMenu.showPopup();}}},initTopSearch:function(){var srch=Wrap('tbar-search');if(srch)srch.on('click',TH.showTopSearch,{scope:TH});},showTopSearch:function(evt){evt.stopEvent();if(window.innerWidth<TH.page_breakpts[2].width&&$('app-side')){TH.toggleSlideMenu('search');return;}
if(TH.appSearcher){TH.appSearcher.close();return;}
var searcher=TH.renderAppSearch(false,evt.currentTarget);searcher.onshow=function(){TH.toggleSlideMenu(false);searcher.focus();}
searcher.onhide=function(){TH.appSearcher=null;}
TH.appSearcher=searcher;},toggleTextures:function(){var body=document.body;var cls='textured';if(SUGAR.ui.hasClass(body,cls)){SUGAR.ui.removeClass(body,cls);Set_Cookie(''+SUGAR.session.theme+'_textured','false',365,'/','','');return false;}else{SUGAR.ui.addClass(body,cls);Set_Cookie(''+SUGAR.session.theme+'_textured','true',365,'/','','');return true;}},detectFullScreenSupport:function(){var fs={hooks:[]};if(isset(document.fullScreen)){fs.prefix='';fs.property='fullScreen';}else if(isset(document.mozFullScreen)){fs.prefix='moz';fs.property='mozFullScreen';}else if(isset(document.webkitIsFullScreen)){fs.prefix='webkit';fs.property='webkitIsFullScreen';}
if(fs.property){fs.request=fs.prefix+(fs.prefix?'R':'r')+'equestFullScreen';if(document[fs.request+'WithKeys'])fs.request+='WithKeys';fs.cancel=fs.prefix+(fs.prefix?'C':'c')+'ancelFullScreen';fs.event=fs.prefix+'fullscreenchange';}
this.fullscreen=fs;},getFullScreenState:function(){if(this.fullscreen.property)return document[this.fullscreen.property];},toggleFullScreen:function(elt){var state=this.getFullScreenState(),method;if(isset(state)){if(state)return document[this.fullscreen.cancel]();else{elt=($(elt)||document.documentElement),method=this.fullscreen.request;if(Element.ALLOW_KEYBOARD_INPUT)return elt[method](Element.ALLOW_KEYBOARD_INPUT);else return elt[method]();}}},addListeners:function(){return;},addFullScreenHandler:function(evt){TH.fullscreen.hooks.push(evt);},setMainTitle:function(title,params){var t=$('main-title-text'),name=$('main-title-module'),help=$('module-help'),mod,icon;if(!isset(title))title='';if(params){if(params.module){icon=params.icon||'input-icon theme-icon module-'+params.module;icon='<div class="'+icon+'"></div>';mod=params.module_title||module_name(params.module);if(mod&&params.module_link){mod=makeElt('a',{href:params.module_link}).html(mod);mod.on('click',SUGAR.util.handleLink);}else{mod=makeElt('span').html(mod);}
mod=[makeElt('span.module-icon').html(icon).append(nbsp()),mod];if(help)help.onclick=function(){return SUGAR.util.showHelp(params.module);}}else if(help){help.onclick=function(){return SUGAR.util.showHelp();}}}
if(name){if(!name.firstChild)createElement2('span',null,null,name);Wrap(name.firstChild).content(mod);}
if(t)t.innerHTML=title;SUGAR.ui.addRemoveClass(name,'visible',!!mod);SUGAR.ui.addRemoveClass(name,'with-sep',(title&&mod&&!params.title_merge));SUGAR.ui.removeClass(document.body,'no-title');},hideMainTitle:function(){SUGAR.ui.addClass(document.body,'no-title');},setPageInfo:function(params){if(!params)params={};this.page_info=params;},setToolsMenu:function(opts,form){var b=TH.tools_btn;if(!b)
b=TH.tools_btn=SUGAR.ui.registerMenuSource('module-tools',{icon_key:'icon',label_key:'label'},form);if(opts&&b.menu)
b.menu.setOptions(opts);b.setDisabled(!opts);},initPage:function(params){var pg=this.page_info,stats;if(!pg||pg.loaded)pg={};if(params)extendObject(pg,params);this.page_info=pg;if(pg.state){if(pg.state.query)
SUGAR.session.loadState(pg.state.query);if(pg.state.context=='detail'&&pg.state.show_list)
this.initDetailSidebar(pg.state.module,pg.state.record);if(SUGAR.session.track_page_stats){stats=SUGAR.session.getPageStats(pg.state,pg.stats);if(stats){setTimeout(function(){SUGAR.conn.asyncRequest('stats.php',{postData:stats,status_msg:null});},2000);}}}
if((!pg.state||!pg.state.query)&&SUGAR.session.loadingQuery){SUGAR.session.loadState(SUGAR.session.loadingQuery);}
this.setBodyClass(pg.state);if(!pg.no_decoration){this.setMainTitle(pg.title,pg);this.setToolsMenu(pg.tools,pg.tools_form);}else
this.hideMainTitle();this.renderSidebar();this.updateTopMenu();for(var i=0;i<TH.init_page_hooks.length;i++)
TH.init_page_hooks[i](pg);TH.updateFavicon(pg.favicon_href,pg.favicon_hr_href);if(params.custom_init){var cb=resolveVar(params.custom_init);if(cb)cb.apply(cb,params);}
App.dom.extNode(window).emit('page-init',pg,params);},updateFavicon:function(icon,hires){if(!icon)return;if(!hires)hires=icon;var links=Wrap(document.head).find('link'),rel,sizes;for(var i=0;i<links.length;i++){rel=links[i].getAttribute('rel');if(rel==='shortcut icon'||rel==='icon'){sizes=links[i].getAttribute('sizes');links[i].setAttribute('href',sizes==='32x32'?hires:icon);}}},setBodyClass:function(state){var bd=document.body,c,cs=[],i;if(!bd)return;for(i=0;i<bd.classList.length;i++){c=bd.classList[i];if(!c.match(/^(mod|ctx)-/))
cs.push(c);}
if(state){if(state.module)
cs.push('mod-'+state.module);if(state.context)
cs.push('ctx-'+state.context);}
bd.className=cs.join(' ');},onInitPage:function(f){this.init_page_hooks.push(f);},initSidebar:function(c){var out=$('outer-body'),hide=Get_Cookie(''+SUGAR.session.theme+'_hide_sidebar'),elt=SUGAR.dom.elementOrId('left-sidebar');if(elt&&elt.hasClass('inited'))return;if(!elt||(!out&&!$('all-page'))){if((c||0)<100)
setTimeout(function(){TH.initSidebar(c+1);},50);return;}
if(out&&!TH.sidebarRendered){TH.toggleSidebar((window.innerWidth>=TH.page_breakpts[2].width&&!hide)?true:false);}
if(TH.page_info)
elt.addClass('inited');TH.sidebarInited=true;elt.on(SUGAR.ui.getTransitionProperty+'end',SUGAR.ui.layoutUpdated);},toggleSidebar:function(state,by_user){var outer=$('outer-body'),button=$('sidebar-toggle'),open=SUGAR.ui.hasClass(outer,'sidebar-open'),pg=TH.page_info,wide=pg&&(pg.sidebar_list_wide||pg.sidebar_wide);if(isset(state))open=!state;if(outer){SUGAR.ui.addRemoveClass(outer,'sidebar-open',!open);SUGAR.ui.addRemoveClass(outer,'sidebar-wide',!!(!open&&wide));}
if(button)
SUGAR.ui.addRemoveClass(button,'checked',!open);if(by_user)
Set_Cookie(''+SUGAR.session.theme+'_hide_sidebar',open?1:'',365,'/','','');SUGAR.ui.layoutUpdated();return open;},resizeToggleSidebar:function(state){if(state&&TH.page_info&&TH.page_info.hide_side_menu)return;TH.toggleSidebar(state);},sidebarOpen:function(){return SUGAR.ui.hasClass($('outer-body'),'sidebar-open');},saveDetailSidebar:function(list_state,module,record,head,body){if(list_state&&list_state.params)
this.sidebar_list={module:module,record:record,state:list_state,head:head,body:body};else
this.sidebar_list=null;},expandDetailSidebar:function(state,record){var body=$('sidebar-list-body'),pg=TH.page_info,srch;if(state&&body&&record&&pg){state.params.list_context='sidebar';state.params.list_current_id=record;state.params.initial_load=1;SUGAR.conn.asyncRequest('async.php',{postData:state.params},function(data){SUGAR.util.loadContent(body,data.responseText);pg.sidebar_list_wide=true;TH.toggleSidebar(true);if((srch=$('sidebar-list-search'))&&$('sidebar-list-filter')){srch.onclick=function(e){e.stopPropagation();return TH.toggleSidebarFilter();}
toggleDisplay(srch,true);}});}},initDetailSidebar:function(module,record){var list=this.sidebar_list,head,c,pg=this.page_info,state;if(list&&(!list.state||list.module!=module||list.record!=record))list=null;if(pg&&!TH.disable_detail_sidebar){if(list)
state=list.state;else
state={params:{module:module,action:'ListView'}};if(list&&list.head&&list.body){c=[list.head,list.body];pg.sidebar_list_wide=true;}else{c=[
createElement2('div',{id:'sidebar-list-head',className:'card-header panel-header sectionClosed'},createElement2('div',{className:'tools-row'},[
createElement2('h5',{id:'sidebar-list-title',className:'no-margin'},app_string('LBL_LIST_RESULTS')),createElement2('span',{id:'sidebar-list-search',className:'uii uii-search uii-lg active-icon',style:'display: none'}),createElement2('span',{className:'no-flex rbullet rbullet-inline'},'\u00a0')])),createElement2('div',{id:'sidebar-list-body',className:'card-body panel-body',style:'display:none'})];}
if(c){c[0].onclick=function(){TH.toggleSidebarList(state,module,record);return false;}
pg.sidebar_list=c;}}},toggleSidebarList:function(state,module,record){var head=$('sidebar-list-head'),body=$('sidebar-list-body'),show=(body&&body.style.display=='none'),srch;if(show){SUGAR.ui.clearChildNodes(body);body.appendChild(createElement2('div',{className:'card-body text-center'},SUGAR.util.waitIcon()));this.expandDetailSidebar(state,record);}else{this.page_info.sidebar_list_wide=false;TH.toggleSidebar(true);toggleDisplay('sidebar-list-search',false);}
SUGAR.ui.setDisplayState(body,show);SUGAR.ui.addRemoveClass(head,'sectionOpen',show);SUGAR.ui.addRemoveClass(head,'sectionClosed',!show);},toggleSidebarFilter:function(show){SUGAR.ui.setDisplayState('sidebar-list-filter',show);},setSidebarContent:function(content){if(this.page_info)this.page_info.sidebar_content=content;},renderSidebar:function(){var side=SUGAR.dom.elementOrId('left-sidebar'),panel_cls='panel-outer panel-border panel-default sidebar-panel',inner,c,c2,pg=TH.page_info||{},hide,minw,main;if(side){if(TH.sidebarInited)
side.addClass('inited');side.empty();inner=createElement2('div',{id:'sidebar-inner',className:'sidebar-inner'},null,side.get());c=createElement2('div',{id:'sidebar-content',className:panel_cls},null,inner);c2=createElement2('div',{id:'sidebar-list',className:panel_cls},null,inner);c3=createElement2('div',{id:'sidebar-modules',className:panel_cls+' hidden'},null,inner);if(pg.sidebar_content)
SUGAR.util.loadContent(c,pg.sidebar_content);else
SUGAR.ui.addClass(c,'hidden');if(pg.sidebar_list)
SUGAR.util.loadContent(c2,pg.sidebar_list);else
SUGAR.ui.addClass(c2,'hidden');TH.renderSidebarMenu(inner,pg.shortcuts,'shortcuts',app_string('LBL_SHORTCUTS'));TH.renderSidebarMenu(inner,pg.recent,'recent',app_string('LBL_LAST_VIEWED'));}
if(pg.no_decoration||Get_Cookie(''+SUGAR.session.theme+'_hide_sidebar')||pg.hide_side_menu)hide=true;main=$('content-main');if(pg.state&&pg.state.context=='dashboard')minw=TH.page_breakpts[3].width;else minw=TH.page_breakpts[2].width;if(main&&main.offsetWidth)minw=Math.max(minw,main.offsetWidth+10);if(window.innerWidth&&window.innerWidth<minw)hide=true;TH.sidebarRendered=true;TH.updateModuleMenu();TH.toggleSidebar(!hide);},renderSidebarMenu:function(outer,opts,id,title,current){var elt=null;if(SUGAR.ui.hasClass(outer,'sidebar-panel')){elt=outer;outer=null;}
if(opts&&opts.keys&&opts.keys.length){if(!elt){elt=createElement2('div',{id:'sidebar-'+id,className:'panel-outer panel-border panel-default sidebar-panel'});outer.appendChild(elt);}
if(title){createElement2('div',{className:'card-header panel-header'},createElement2('h5',{className:'no-margin'},title),elt);}
SUGAR.ui.registerSelectOptions('page-'+id,opts);var sel=new SUGAR.ui.SelectList('page-'+id,{options:'page-'+id,icon_key:'icon',no_scroll:1,require_focus:0,flat:1,className:'select-menu flat-top sidebar-menu'});if(TH.enable_module_sidebar)
sel.options_active=true;sel.onchange=function(old,evt){var v=this.getSelectedValue();SUGAR.util.navigateTo(v.url,evt,{delay:true,async:get_default(v.async,true)});this.setSelectedKey(null,true);}
if(isset(current))
sel.setSelectedKey(current,true);elt.appendChild(sel.render());sel.setup();SUGAR.ui.removeClass(elt,'hidden');return sel;}else{SUGAR.ui.addClass(elt,'hidden');}},version:function(chk){var v=SUGAR.session.layout_version;if(isset(chk))return v>=chk;return v;},detectFeatures:function(){this.detectFullScreenSupport();var e=createElement2('div');e.style.position='sticky';if(e.style.position.indexOf('sticky')>=0){SUGAR.ui.addClass(document.body,'sticky');this.sticky=true;}},topMenuSize:function(modules){return null;},topMenuFloat:function(){return document.body&&SUGAR.ui.hasClass(document.body,'float-menu');}};});SUGAR.module('modelCache').init(function(){var cache={};return{resetCache:function(){cache={};},addModelData:function(name,data){cache[name]=new SUGAR.ui.SelectOptions(data);},getModelData:function(name){return cache[name];},getModelKeys:function(){var ret=[];for(var k in cache)
ret.push(k);return ret;}}});SUGAR.module('session').init(function(App){var SESS=this;this.onInit(function(){this.update(window._session_init);this.initLocation=location.href;window.addEventListener('popstate',this.handleRestoreState.bind(this));});return{update:function(vars){if(isObject(vars)){for(var i in vars)
this[i]=vars[i];}},getState:function(){return this.currentState;},setLoadingState:function(context,vars,push,query){this.loadingState={context:context,vars:vars,push:push};this.loadingQuery=query;},loadState:function(query){var st=this.loadingState||{};this.pushState(query,st.context,st.vars,!st.push);},clearLoadingState:function(){this.loadingState=null;this.loadingQuery=null;},pushState:function(query,context,vars,replace){if(!isdef(context))context=null;if(!isdef(vars))vars=null;this.currentState={query:query,context:context,vars:vars};if(!this.initialState)
this.initialState=this.currentState;if(!history.pushState)return;history[replace?'replaceState':'pushState'](
this.currentState,null,'?'+query);this.clearLoadingState();},replaceState:function(query,context,vars){this.pushState(query,context,vars,true);},handleRestoreState:function(evt){var s=evt.state,m,initial=!('state'in history)&&this.initLocation==location.href;if(!SUGAR.session.user_id)return;if(isset(s)){if((m=SUGAR.util.checkDirty())&&!confirm(m))return false;this.restoreState(s,initial);}},restoreState:function(s,initial){if(!s)return;if(initial)
s=this.initialState;if(this.currentState&&this.compareStates(this.currentState,s))return;if(s.context=='sListView'&&s.vars)
sListView[s.vars.method](s.vars.id,s.vars.params,s.vars.ext);else
SUGAR.util.fetchContentMain('async.php?'+s.query,{scrollTo:false});},compareStates:function(s1,s2){var k;if(!isObject(s1)||!isObject(s2))return s1===s2;for(k in s1)
if(s1.hasOwnProperty(k)&&!this.compareStates(s1[k],s2[k]))return false;for(k in s2)
if(s2.hasOwnProperty(k)&&!this.compareStates(s1[k],s2[k]))return false;return true;},setLoadingRequest:function(req){this.loadingRequest=req;},getPageStats:function(state,stats){var req=this.loadingRequest,time,async,ret;if(req){time=req.openTime;async=true;}
else if(window.performance&&!this.timeSeen){time=window.performance.timing.responseEnd-window.performance.timing.connectStart;this.timeSeen=true;}
if(time){ret={duration:time,async:async};if(stats)for(k in stats)
ret[k]=stats[k];if(state){ret.context=state.context;ret.module=state.module;ret.record=state.record;ret.layout=state.layout;ret.user_id=SUGAR.session.user_id;}}
return ret;}};});function validateNumberInput(field,params){if(!isset(field))
field=this;if(!isset(params)){if(isset(field.numFormat))
params=field.numFormat;else
params=field;}
else{if(field.numFormat){for(var idx in field.numFormat)
if(!isset(params[idx]))params[idx]=field.numFormat[idx];}}
var numval=validateNumber(field.value,params);field.value=params.noFormat?numval:stdFormatNumber(numval);return parseFloat(numval);}
function validateNumber(input,params){if(!params)params={};var numval,decimals=get_default(params.decimalPlaces,2),user_seps=SUGAR.session.separators;if(typeof(input)=='number')
numval=input;else if(typeof(input)=='string'){if(params.noFormat){numval=parseFloat(input);}else{var seps=RegExp.escape(''+user_seps.thousands+user_seps.decimal);if(!isset(user_seps.match_pattern))
user_seps.match_pattern=new RegExp('([+\-]?[0-9'+seps+']*[0-9][0-9'+seps+']*)','gi');var match=input.match(user_seps.match_pattern);if(match)
numval=parseFloat(stdUnformatNumber(match[0]));}}
if(isset(numval)&&!isNaN(numval)){if(!isset(params.minimumDecimals))
numval=numval.toFixed(decimals);else if(isNumeric(params.minimumDecimals)){numval=restrictDecimals(numval,params.minimumDecimals,decimals);}
else if(params.minimumDecimals&&params.decimalPlaces)
numval=restrictDecimals(numval,0,params.decimalPlaces);if(isset(params.restrictPositive)&&numval<0)
numval=-numval;}
else if(isset(params.defaultNumValue))
numval=params.defaultNumValue;else if(!isset(params.blankAllowed)){if(!isset(params.minimumDecimals))
numval='0.00';else if(isNumeric(params.minimumDecimals))
numval='0'.toFixed(params.minimumDecimals);else
numval='0';}
else
numval='';return numval;}
function countDecimals(numval){var s=numval.toString().split('.');if(s.length==1)return 0;return s[1].length;}
function restrictDecimals(numval,minDecs,maxDecs){if(!isset(minDecs))minDecs=0;if(!isset(maxDecs))maxDecs=5;if(!maxDecs)return Math.round(numval).toString();var s=numval.toString().split('.');if(s.length==1)s.push('');if(s[1].length>maxDecs){s[1]=Math.round(parseInt(s[1],10)/Math.pow(10,s[1].length-maxDecs)).toString();while(s[1].length<maxDecs)s[1]='0'+s[1];}
if(s[1].length>maxDecs){s[0]=''+(parseInt(s[0],10)+1);s[1]=s[1].substring(1);}
s[1]=s[1].replace(/0+$/,'');if(s[1].length||minDecs){while(s[1].length<minDecs)
s[1]+='0';numval=s[0]+'.'+s[1];}else
numval=s[0];return numval;}
function stdFormatNumber(val,round,precision){var seps=SUGAR.session.separators;if(!isset(val))val='';return formatNumber(val,seps.thousands,seps.decimal,round,precision);}
function stdUnformatNumber(val){var seps=SUGAR.session.separators;if(!isset(val))val='';return unformatNumber(val,seps.thousands,seps.decimal);}
function adjustExchangeRate(old_rate,new_rate,fields,decimals){for(var i=0;i<fields.length;i++){var value=0;if(isset(fields[i].numvalue))
value=fields[i].numvalue;else
value=stdUnformatNumber(fields[i].value);value=ConvertFromDollar(ConvertToDollar(value,old_rate),new_rate).toFixed(decimals);fields[i].numvalue=value;fields[i].value=stdFormatNumber(value,decimals,decimals);}}
function stdConvertRate(id,fields){var decimals=CurrencyDecimalPlaces(id);adjustExchangeRate(lastRate,ConversionRates[id],fields,decimals);lastRate=ConversionRates[id];}
function mod_string(idx,mod){return SUGAR.language.getString(idx,mod);}
function mod_list_strings(idx,mod){return SUGAR.language.getList(idx,mod);}
function app_string(idx){return SUGAR.language.getString(idx,'app');}
function app_list_strings(idx){return SUGAR.language.get('app_list_strings',idx);}
function module_name(module,singular){var lst=app_list_strings('moduleList'+(singular?'Singular':''));return get_default(lst[module],module);}
function sepLabel(text){var lbl=app_string('LBL_SEPARATOR');lbl=lbl.replace(' ','\u00a0');if(text)return lbl;return document.createTextNode(lbl);}
var img_cache={};var ImageMeta={};function get_icon_image(id){if(id=='remove'){return createElement2('span',{className:'uii uii-remove'});}else if(id=='insert'){return createElement2('span',{className:'uii uii-add'});}
if(isset(img_cache[id]))return img_cache[id].cloneNode(false);if(isset(ImageMeta)&&isset(ImageMeta[id])){var img=document.createElement('img');setAttrs(img,ImageMeta[id]);img.border=0;img.style.verticalAlign='middle';img_cache[id]=img.cloneNode(false);return img;}
return document.createTextNode(id);}
function get_image_url(id){if(isset(ImageMeta[id]))return ImageMeta[id].src;return'themes/'+SUGAR.session.theme+'/images/'+id+'.gif';}
function getTimeFormat(params){if(!params)params={};var fmt={};fmt.print_format=''+get_default(params.format,SUGAR.session.formats.time);fmt.print=function(hr,min){var d=new Date();d.setHours(hr);d.setMinutes(min);return d.print(this.print_format);}
fmt.sep=params.time_separator||SUGAR.session.separators.hour_minute;if(fmt.print_format.indexOf('%p')>0)
fmt.meridiem=2;else if(fmt.print_format.indexOf('%P')>0)
fmt.meridiem=1;else
fmt.meridiem=0;return fmt;}
function parseTimeString(str,params){var fmt=getTimeFormat(params);var inp={val:trim(str),format:fmt};var merid=inp.val.match(/^(.*?)([ap]m?)$/i);if(merid){inp.merid=merid[2][0].toLowerCase();inp.no_merid=merid[1];}else{inp.merid='';inp.no_merid=inp.val;}
var hr=inp.no_merid.match(/^(\d+)(.*?)$/);if(hr){if(inp.no_merid=='0'){var d=new Date();inp.hour=d.getHours();inp.minute=d.getMinutes();}
else if(hr[1].length==4){inp.hour=parseInt(hr[1].substring(0,2),10);inp.minute=parseInt(hr[1].substring(2),10);}else{inp.hour=parseInt(hr[1],10);inp.minute=0;}
if(inp.merid=='p'&&inp.hour<12)
inp.hour+=12;else if(inp.merid=='a'&&inp.hour==12)
inp.hour-=12;else if(inp.merid!='a'&&fmt.meridiem){if(inp.hour<8)inp.hour+=12;}
var minsec=hr[2];if(minsec){if(minsec.substring(0,fmt.sep.length)==fmt.sep){var mm=minsec.substring(fmt.sep.length).match(/^(\d+)(.*?)$/);if(mm){inp.minute=parseInt(mm[1],10);var sec=mm[2];}}else if(minsec[0]=='.'){var mm=minsec.substring(fmt.sep.length).match(/^(\d+)(.*?)$/);if(mm){inp.minute=60*('0.'+mm[1]);var sec=mm[2];}}}
inp.display=fmt.print(inp.hour,inp.minute);inp.d=new Date();inp.d.setHours(inp.hour,inp.minute);return inp;}
return false;}
function validateTimeInput(field,params){if(!isset(field))
field=this;if(!isset(params)){if(isset(field.timeFormat))
params=field.timeFormat;else
params=field;}
else{if(field.timeFormat){for(var idx in field.timeFormat)
if(!isset(params[idx]))params[idx]=field.timeFormat[idx];}}
var ret=parseTimeString(field.value,params);if(ret)field.value=inp.display;return ret;}
function getDateFormat(params){if(!params)params={};var fmt={},i,pats,p;fmt.print_format=''+get_default(params.format,SUGAR.session.formats.date);fmt.makeDate=function(val){var d=new Date(val.year,val.month-1,val.day);return d;}
fmt.print=function(val){if(!val.d)val.d=this.makeDate(val);return val.d.print(this.print_format);}
pats=fmt.print_format.match(/%[Ymd]/gi);for(i=0;i<pats.length;i++){switch(pats[i]){case'%Y':
fmt.year_position=i+1;break;case'%m':
fmt.month_position=i+1;break;case'%d':
fmt.day_position=i+1;break;}}
return fmt;}
function parseDateString(str,params){var fmt=getDateFormat(params),inp={val:trim(str),format:fmt},split=inp.val.match(/^(.+)\s+(\d+[:\.hap].*)$/i);if(split){inp.val=split[1].trim();inp.time=split[2].trim();}
var std=inp.val.match(/^(\d+)\D+(\d+)\D+(\d+)$/),retdate=function(d){if(inp.time){inp.time=parseTimeString(inp.time);if(inp.time){d.setHours(inp.time.hour,inp.time.minute);}}
inp.d=d;inp.year=d.getFullYear();inp.month=d.getMonth()+1;inp.day=d.getDate();inp.display=fmt.print(d);return inp;};if(std){var y,m,d;if(std[1]>1000){y=parseInt(std[1],10);m=parseInt(std[2],10);d=parseInt(std[3],10);}
else{y=parseInt(std[fmt.year_position],10);m=parseInt(std[fmt.month_position],10);d=parseInt(std[fmt.day_position],10);}
if(!y)y=(new Date().getFullYear());else if(y<100)y+=2000;return retdate(new Date(y,m-1,d));}
var offset=inp.val.match(/^([+-])\s*(\.?\d+|\d+\.\d*)\s*([dmy]?)$/i);if(offset){var d=new Date(),offs=parseInt(offset[1]+offset[2],10),otype=offset[3].toLowerCase();if(otype=='y'){d.setFullYear(d.getFullYear()+offs);}
else if(otype=='m'){var y=d.getFullYear(),m=d.getMonth()+1+offs;while(m<=0){y--;m+=12;}
while(m>12){y++;m-=12;}
d=new Date(y,m-1,d.getDate());if(!d)return false;}
else{var s=d.getTime()+(offs*24*3600*1000);d.setTime(s);}
if(!d)return false;return retdate(d);}
var pair=inp.val.match(/^(\d+)(?:\D+(\d+))?$/);if(pair){var d=new Date(),p1=parseInt(pair[1],10),p2,tmp,y;if(isset(pair[2])){p2=parseInt(pair[2],10);if(fmt.month_position>fmt.day_position){tmp=p1;p1=p2;p2=tmp;}
if(p1>1000){y=p1;p1=p2;p2=0;}
else y=d.getFullYear();if(!p1)p1=d.getMonth()+1;if(!p2)p2=d.getDate();d=new Date(y,p1-1,p2);}else{if(p1>1000000)
d.setTime(p1/1000);else if(p1>1000)
d.setFullYear(p1);else if(p1)
d=new Date(d.getFullYear(),d.getMonth(),p1);}
if(!d)return false;return retdate(d);}
return false;}
function validateDateInput(field,params){if(!isset(field))
field=this;if(!isset(params)){if(isset(field.dateFormat))
params=field.dateFormat;else
params=field;}
else{if(field.dateFormat){for(var idx in field.dateFormat)
if(!isset(params[idx]))params[idx]=field.dateFormat[idx];}}
var ret=parseDateString(field.value,params);if(ret)field.value=ret.display;return ret;}
function formatDuration(minutes,hide_zero){var min=Math.round(minutes);var hr=Math.floor(min/60);min=min%60;var ts=SUGAR.session.separators.duration_hr;return''+hr+((min||!hide_zero)?ts+(min<10?'0'+min:min):'');}
SUGAR.module('kc').init(function(App){var code=[],idx=0;for(var i=0;i<11;i++)code.push('IIKKHJHJed0'.charCodeAt(i)-35);this.onDomReady(function(){SUGAR.util.addKeyHandler(SUGAR.kc.hit);});return{hit:function(e){var c=e.keyCode;if(code[idx]==c)idx++;else idx=0;if(idx==code.length){SUGAR.kc.hook();idx=0;}
if(idx)return true;},hook:function(){SUGAR.util.addScriptInclude('include/javascript/kc.js?'+(Math.random()*100));}};});addForm=addToValidate=removeFromValidate=check_form=function(){};var popup_dialog;function get_popup_request_data(){return document.popup_request_data;}
function get_close_popup(){return document.close_popup;}
function open_popup_inline(title){var args=[];for(var i=1;i<Math.max(arguments.length,11);i++)
if(i<arguments.length)
args[i-1]=arguments[i];else
args[i-1]=undefined;var custom;if(args.length>10)
custom=args[10];else
custom={};custom['inline']=true;if(title)
custom['title']=title;args[10]=custom;return open_popup.apply(this,args);}
function old_open_popup(){var args=[];for(var i=0;i<Math.max(arguments.length,10);i++)
if(i<arguments.length)
args[i]=arguments[i];else
args[i]=undefined;var custom;if(args.length>10)
custom=args[10];else
custom={};if(!isset(custom.inline))
custom.inline=false;args[10]=custom;return open_popup.apply(this,args);}
function open_popup(module_name,width,height,initial_filter,close_popup,hide_clear_button,popup_request_data,popup_mode,create,metadata,custom){var options={module:module_name,min_width:width,min_height:height,filter:initial_filter,close_popup:close_popup,hide_clear_button:hide_clear_button,request_data:popup_request_data,popup_mode:popup_mode,create:create,metadata:metadata};if(custom){options.inline=custom.inline;options.title=custom.title;}
if(!isset(options.inline))
options.inline=true;return open_popup_window(options);}
function open_popup_window(options){document.popup_request_data=options.request_data;document.close_popup=options.close_popup;var URL=options.url;if(!URL){if(!options.module)return;var URL='async.php?'
+'module='+options.module
+'&action='+get_default(options.action,'Popup');if(options.hide_clear_button)
URL+='&hide_clear_button=true';var popup_mode=options.popup_mode||(options.multiple?'MultiSelect':'single');URL+='&mode='+popup_mode;var create=options.create||'false';URL+='&create='+create;if(options.layout)
URL+='&layout='+options.layout;if(options.metadata)
URL+='&metadata='+options.metadata;if(options.add_popup_fields)
URL+='&add_popup_fields='+options.add_popup_fields;}
if(options.filter){var filter=options.filter;if(typeof(filter)=='object')
filter=encodeQueryString(filter);if(filter.length&&filter[0]!='&')
filter='&'+filter;if(filter.indexOf("reassign")!=-1&&options.request_data)
filter+='&request_data='+options.request_data;URL+='&query=true'+filter;}
if(options.query_string){URL+='&'+options.query_string;}
var width=options.width,viewp=SUGAR.ui.getViewport();if(!width){width=parseInt(get_default(options.min_width,700));if(options.inline){var scrw=viewp.width;if(scrw>1024)
width+=Math.round(Math.min(150,(scrw-1024)/2));}
if(options.max_width)
width=Math.min(width,options.max_width);}
var height=options.height;if(!height){height=parseInt(get_default(options.min_height,450));if(options.inline){var scrh=viewp.height;if(scrh>600)
height+=Math.round(Math.min(200,(scrh-600)/2));}
if(options.max_height)
height=Math.min(height,options.max_height);}
if(options.inline){URL+='&in_popup=true';var min_width='400px';if(screen&&screen.width<390)
min_width=''+(screen.width-10)+'px';var params={min_width:min_width,min_height:'300px'};if(options.min_width)params.min_width=options.min_width+'px';if(options.min_height)params.min_height=options.min_height+'px';if(options.width)params.width=options.width+'px';if(options.height)params.height=options.height+'px';popup_dialog=new SUGAR.ui.Dialog(options.popup_name,params);if(options.onclose)
popup_dialog.onclose=options.onclose;popup_dialog.ondestroy=function(){popup_dialog=null;}
popup_dialog.setTitle(options.title||'&nbsp;');if(options.title)
popup_dialog.ignore_init_title=true;document.close_popup=function(){if(!window.popup_dialog)return;popup_dialog.close();}
popup_dialog.fetchContent(URL,null,fetched_popup,true);return true;}
var windowFeatures='width='+width
+',height='+height
+',resizable=1,scrollbars=1';var win=window.open(URL,options.popup_name||'popup_window',windowFeatures);if(window.focus)
win.focus();return win;}
function fetched_popup(){}
var from_popup_return=false;function set_return(popup_reply_data){from_popup_return=true;var form_name=popup_reply_data.form_name;var name_to_value_array=popup_reply_data.name_to_value_array;for(var the_key in name_to_value_array){if(the_key=='toJSON'){}
else{var displayValue=name_to_value_array[the_key];if((typeof displayValue)=="string")
displayValue=displayValue.replace(/&amp;/gi,'&').replace(/&lt;/gi,'<').replace(/&gt;/gi,'>').replace(/&#039;/gi,'\'').replace(/&quot;/gi,'"');else
displayValue='';if(window.document.forms[form_name]&&(o=window.document.forms[form_name].elements[the_key])){if(o.options){for(var i=0,b=null;i<o.options.length;i++){if(displayValue!=o.options[i].value)continue;b=o.options[i].selected=true;o.selectAfterRedyState=displayValue;break;}
o.optionAfterReady=displayValue;if(b&&(typeof o.onchange)=="function"){o.saveSubSelectedOutset=true;o.onchange();o.saveSubSelectedOutset=false;}}else o.value=displayValue;}}}}
function set_return_and_save(popup_reply_data){var form_name=popup_reply_data.form_name;var name_to_value_array=popup_reply_data.name_to_value_array;for(var the_key in name_to_value_array){if(the_key=='toJSON'){}
else{window.document.forms[form_name].elements[the_key].value=name_to_value_array[the_key];}}
window.document.forms[form_name].return_module.value=window.document.forms[form_name].module.value;window.document.forms[form_name].return_action.value='DetailView';window.document.forms[form_name].return_id.value=window.document.forms[form_name].record.value;window.document.forms[form_name].action.value='Save';window.document.forms[form_name].submit();}
function get_initial_filter_by_account(form_name){var account_id=window.document.forms[form_name].account_id.value;var account_name=escape(window.document.forms[form_name].account_name.value);var initial_filter="&account_id="+account_id+"&account_name="+account_name;return initial_filter;}
function update_subpanel(popup_reply_data){var form_name=popup_reply_data.form_name;var form_params=deep_clone(popup_reply_data.name_to_value_array);var passthru_data=popup_reply_data.passthru_data;var query_array=[];if(!isset(form_params))
form_params={};var selection_list=popup_reply_data.selection_list;if(isset(selection_list)){var recs=[],row;for(var the_key in selection_list){row=selection_list[the_key];if(typeof row==='object')row=row.id;if(!row)continue;recs.push(row);}
form_params['selected_id[]']=recs;}
if(popup_reply_data.hasOwnProperty('filter')){for(var name in popup_reply_data.filter){form_params[name]=popup_reply_data.filter[name];}}
for(var prop in passthru_data){form_params[prop]=passthru_data[prop];}
form_params.record_perform='subpanel_insert';var conn_params={};if(passthru_data['reload_page']!='true'){conn_params.resultDiv=''+form_params['list_id']+'-outer';}
SUGAR.ui.sendForm(form_name,form_params,conn_params);}
AppBase.module('asyncLogin').init(function(App){var loginPopup;var httpRequest;var self=this;this.popupEnabled=true;return{init:function(){return this;},showLoginPopup:function(httpReq){if(httpReq)httpRequest=httpReq;var cookie=window.document.cookie||'';if(~cookie.indexOf('ANDROID_APP=true')){if(confirm('ANDROID_APP_RELOGIN_REQUEST')){var mock={getResult:function(){return{result:'ok'};},};self.loginSuccess.call(mock);}else{self.loginFailure();}
return;}
loginPopup=new App.ui.Dialog('asyncLogin',{width:'350px',height:'400px',resizable:false,draggable:true,title:app_string('NTC_JS_SESSION_ENDED_SHORT')});if(!App.session.user_name)this.popupEnabled=false;if(!this.popupEnabled){if(httpRequest)httpRequest.fail(app_string('NTC_JS_SESSION_ENDED'));return false;}
loginPopup.ondestroy=function(){self.popupEnabled=true;loginPopup=null;if(httpRequest)httpRequest.fail(app_string('NTC_JS_SESSION_ENDED'));}
var username=html_escape(App.session.user_name||Get_Cookie('ck_login_username'));var body='<form onsubmit="AsyncLogin.doLogin(); return false;" class="card-outer form-outer default-form" autocomplete="off">';body+='<div class="card-body form-body">';body+='<div class="form-section">';body+='<div class="row form-row">'
+'<div class="column form-cell">'
+'<div class="form-entry">'
+'<label class="form-label" for="login_user_name">'+app_string('LBL_USER_NAME')+'</label>'
+'<div class="form-value"><input type="hidden" name="user_name" id="login_user_name" value="'+username+'">'+username+'</div>'
+'</div>'
+'</div>'
+'</div>';body+='<div class="row form-row">'
+'<div class="column form-cell">'
+'<div class="form-entry">'
+'<label class="form-label" for="login_user_password">'+app_string('LBL_PASSWORD')+'</label>'
+'<div class="form-value"><input type="password" size="20" id="login_user_password" name="user_password" class="input-text input-block" autocomplete="off" value=""></div>'
+'</div>'
+'</div>'
+'</div>';body+='<div class="row form-row" id="login_error_row" style="display: none">'
+'<div class="column form-cell">'
+'<div class="form-entry">'
+'<div class="form-value text-error" id="login_error_message"></div>'
+'</div>'
+'</div>'
+'</div>';body+='</div></div>';body+='<div class="card-footer form-buttons">';body+='<div class="row buttons-row">';body+='<div class="column buttons-inline align-right">';body+='<div class="inline-elt">';body+='<button class="input-button" type="button" id="login_cancel_button" name="cancel" onclick="SUGAR.asyncLogin.closeLoginPopup(); return false;"><div class="input-icon icon-cancel left"></div><span class="input-label">'+app_string('LBL_CANCEL_BUTTON_LABEL')+'</span></button>';body+='</div><div class="inline-elt">';body+='<button class="input-button" type="submit" id="login_button" name="login" onclick="SUGAR.asyncLogin.doLogin(); return false;"><div class="input-icon icon-accept left"></div><span class="input-label">'+app_string('LBL_LOGIN_BUTTON_LABEL')+'</span></button>';body+='</div></div></div></div></form>';loginPopup.setContent(body);loginPopup.render();loginPopup.onshow=function(){self.onShowPopup();}
loginPopup.show();return true;},onShowPopup:function(){var user=$('login_user_name'),pass=$('login_user_password');if(user.value)pass.focus()&&pass.select();else user.focus();},closeLoginPopup:function(){if(loginPopup){loginPopup.hide();loginPopup.destroy();}},doLogin:function(){var currentLang=App.session.language||'en_us';var params={'username':$('login_user_name').value,'password':$('login_user_password').value,'language':currentLang,'theme':App.session.theme};$('login_button').disabled=true;var req=new App.conn.JSONRequest('login',{status_msg:app_string('LBL_LOGGING_IN')},params);$('login_user_password').value='********';req.fetch(self.loginSuccess,self.loginFailure);return false;},loginSuccess:function(){var row=this.getResult();if(row.result=='ok'){self.popupEnabled=true;if(loginPopup){loginPopup.ondestroy=function(){};loginPopup.hide();loginPopup.destroy();loginPopup=null;}
if(httpRequest){if(httpRequest.async)httpRequest.fetch();else httpRequest.fail(app_string('LBL_LOGGED_IN'));}}else{self.loginFailure(row.message);}},loginFailure:function(msg){if($('login_user_password'))
$('login_user_password').value='';if($('login_button'))
$('login_button').disabled=false;self.showError(msg||app_string('LBL_CONNECTION_FAILED'));},showError:function(msg){if($('login_error_message'))
$('login_error_message').innerHTML=msg;App.ui.setDisplayState('login_error_row',true);}}.init();});Calendar=function(params){if(!params)params={};for(var idx in Calendar.defaults){if(!(idx in params))
params[idx]=Calendar.defaults[idx];}
extendObject(this,params);if(!isset(Calendar._SDN)){if(!isset(Calendar._SDN_len))
Calendar._SDN_len=3;var ar=[];for(var i=8;i>0;){ar[--i]=Calendar._DN[i].substr(0,Calendar._SDN_len);}
Calendar._SDN=ar;if(!isset(Calendar._SMN_len))
Calendar._SMN_len=3;ar=[];for(var i=12;i>0;){ar[--i]=Calendar._MN[i].substr(0,Calendar._SMN_len);}
Calendar._SMN=ar;}};Calendar._TT={};Calendar.defaults={dateFormat:SUGAR.session.formats.date,ttDateFormat:SUGAR.session.formats.date,firstDayOfWeek:SUGAR.session.week_start_day,minYear:1970,maxYear:2500,singleClick:true,weekNumbers:true,showsTime:false,electric:true,yearStep:1,showsOtherMonths:false,updateOnCloseOnly:false,enableReadOnly:false,time24:true,dateToday:SUGAR.session.jscal_today};Calendar.getAbsolutePos=function(el){var SL=0,ST=0;var is_div=/^div$/i.test(el.tagName);if(is_div&&el.scrollLeft)
SL=el.scrollLeft;if(is_div&&el.scrollTop)
ST=el.scrollTop;var r={x:el.offsetLeft-SL,y:el.offsetTop-ST};if(el.offsetParent){var tmp=this.getAbsolutePos(el.offsetParent);r.x+=tmp.x;r.y+=tmp.y;}
return r;};Calendar.isRelated=function(el,evt){var related=evt.relatedTarget;if(!related){var type=evt.type;if(type=="mouseover"){related=evt.fromElement;}else if(type=="mouseout"){related=evt.toElement;}}
while(related){if(related==el){return true;}
related=related.parentNode;}
return false;};Calendar._add_evs=function(el,scope){SUGAR.ui.addEventListeners(el,{mouseover:this.dayMouseOver,mousedown:this.dayMouseDown,mouseout:this.dayMouseOut,mouseup:this.dayMouseUp},scope);};Calendar.showMonthsCombo=function(){if(!cal){return false;}
var cal=cal;var cd=cal.activeDiv;var mc=cal.monthsCombo;if(cal.hilitedMonth){SUGAR.ui.removeClass(cal.hilitedMonth,'hilite');}
if(cal.activeMonth){SUGAR.ui.removeClass(cal.activeMonth,'active');}
var mon=cal.monthsCombo.getElementsByTagName("div")[cal.date.getMonth()];SUGAR.ui.addClass(mon,'active');cal.activeMonth=mon;var s=mc.style;s.display="block";if(cd.navtype<0)
s.left=cd.offsetLeft+"px";else{var mcw=mc.offsetWidth;s.left=(cd.offsetLeft+cd.offsetWidth-mcw)+"px";}
s.top=(cd.offsetTop+cd.offsetHeight)+"px";};Calendar.showYearsCombo=function(fwd){if(!cal){return false;}
var cal=cal;var cd=cal.activeDiv;var yc=cal.yearsCombo;if(cal.hilitedYear){SUGAR.ui.removeClass(cal.hilitedYear,'hilite');}
if(cal.activeYear){SUGAR.ui.removeClass(cal.activeYear,'active');}
cal.activeYear=null;var Y=cal.date.getFullYear()+(fwd?1:-1);var yr=yc.firstChild;var show=false;for(var i=12;i>0;--i){if(Y>=cal.minYear&&Y<=cal.maxYear){yr.firstChild.data=Y;yr.year=Y;yr.style.display="block";show=true;}else{yr.style.display="none";}
yr=yr.nextSibling;Y+=fwd?cal.yearStep:-cal.yearStep;}
if(show){var s=yc.style;s.display="block";if(cd.navtype<0)
s.left=cd.offsetLeft+"px";else{var ycw=yc.offsetWidth;s.left=(cd.offsetLeft+cd.offsetWidth-ycw)+"px";}
s.top=(cd.offsetTop+cd.offsetHeight)+"px";}};Calendar.dayMouseDown=function(ev){var el=ev.currentTarget;if(ev.which!=1)return;if(!el||el.disabled){return false;}
var cal=this;cal.activeDiv=el;if(el.navtype!=300){SUGAR.ui.addClass(el,'hilite');SUGAR.ui.addClass(el,'active');}
if(el.navtype==-1||el.navtype==1){cal.nav(el.navtype,'month');}else if(el.navtype==-2||el.navtype==2){cal.nav(Math.round(el.navtype/2),'year');}else if(el.navtype==0){cal.nav(0,0,cal.today);}
return SUGAR.ui.stopEvent(ev);};Calendar.dayMouseUp=function(ev){var target=ev.target;if(ev.which!=1)return;if(isset(target.dayindex)){var date=this.month_info.days[target.dayindex].date;this.setDate(date);this.callUpdateHandler();}
return SUGAR.ui.stopEvent(ev);}
Calendar.dayMouseOver=function(ev){var el=ev.currentTarget;if(Calendar.isRelated(el,ev)||el.disabled){return false;}
if(el.ttip){if(el.ttip.substr(0,1)=="_"){var date=this.month_info.days[el.dayindex].date;el.ttip=date.print(this.ttDateFormat)+el.ttip.substr(1);}
this.showStatus(el.ttip);}
if(!isset(el.navtype)){if(!this.month_info.days[el.dayindex].disabled){SUGAR.ui.addClass(el,"hilite");SUGAR.ui.addClass(el.parentNode,"rowhilite");}}
return SUGAR.ui.stopEvent(ev);};Calendar.dayMouseOut=function(ev){var el=ev.currentTarget;if(Calendar.isRelated(el,ev)||el.disabled){return false;}
SUGAR.ui.removeClass(el,'hilite');SUGAR.ui.removeClass(el.parentNode,'rowhilite');this.showStatus(Calendar._TT["SEL_DATE"],true);return SUGAR.ui.stopEvent(ev);};Calendar.prototype.getElement=function(){return this.outer;}
Calendar.prototype.getDate=function(){return this.date;}
Calendar.prototype.render=function(){if(!this.outer)
this.outer=createElement2('div',{className:'card-outer panel-outer panel-default calendar-outer input-calendar'});var cal=this,row,cell,nav_icon={},hh=function(text,navtype,tip,target){var ret,cls;if(navtype>=-2&&navtype<=2){cls='uii '+nav_icon[navtype]+(navtype<0?' nav-left':' nav-right');ret=createElement2('span',{className:cls,navtype:navtype,ttip:tip},text,target);Calendar._add_evs(ret,cal);}else{ret=createElement2('span',{className:'nav-title',navtype:navtype,ttip:tip},text,target);Calendar._add_evs(ret,cal);}
return ret;};nav_icon[-2]='uii-fprevious';nav_icon[-1]='uii-previous';nav_icon[1]='uii-next';nav_icon[2]='uii-fnext';var head=createElement2('header',{className:'card-header panel-header no-pad'},null,this.outer),head_row=createElement2('h4',{className:'text-label nav-row'},null,head),subhead=createElement2('header',{className:'card-header panel-subheader no-pad grid-body'},null,this.outer),day_names=createElement2('div',{className:'grid-row number-row dates'},null,subhead);hh(null,-2,Calendar._TT['PREV_YEAR'],head_row);hh(null,-1,Calendar._TT['PREV_MONTH'],head_row);this.title=hh('',300,'',head_row);hh(null,1,Calendar._TT['NEXT_MONTH'],head_row);hh(null,2,Calendar._TT['NEXT_YEAR'],head_row);if(this.weekNumbers){createElement2('div',{className:'grid-cell number-cell day-head label week-number'},Calendar._TT['WK'],day_names);}
for(var i=7;i>0;--i){cell=createElement2('div',{className:'grid-cell number-cell day-head'},'',day_names);if(i==7)
this.firstdayname=cell;if(!i){cell.navtype=100;Calendar._add_evs(cell,this);}}
this._displayWeekdays();this.body=createElement2('div',{className:'card-body panel-body grid-body'},null,this.outer);this.rows=[];for(i=6;i>0;--i){row=createElement2('div',{className:'grid-row number-row'},null,this.body);if(this.weekNumbers){cell=createElement2('div',{className:'grid-cell number-cell day label week-number'},null,row);}
for(var j=7;j>0;--j){cell=createElement2('div',{className:'grid-cell number-cell text-right day'},null,row);Calendar._add_evs(cell,this);}
this.rows.push(row);}
if(!this.hide_status){var foot=createElement2('footer',{className:'card-footer panel-footer'},null,this.outer);row=createElement2('div',{className:'text-right ttip'},null,foot);cell=hh(Calendar._TT['SEL_DATE'],300,'',row);this.tooltips=cell;}
this._init();}
Calendar.prototype.keyDown=function(ev){var act=true,info=this.month_info;if(ev.shiftKey){switch(ev.keyCode){case 37:
act&&this.nav(-1,'month');break;case 38:
act&&this.nav(-1,'year');break;case 39:
act&&this.nav(1,'month');break;case 40:
act&&this.nav(1,'year');break;default:return false;}}else switch(ev.keyCode){case 13:
case 32:
act&&this.callUpdateHandler();break;case 27:
act&&this.callCloseHandler();break;case 37:
case 38:
case 39:
case 40:
if(act){switch(ev.keyCode){case 38:
this.nav(-1,'week');break;case 37:
this.nav(-1,'day');break;case 40:
this.nav(1,'week');break;case 39:
this.nav(1,'day');break;}}
break;default:return false;}
return SUGAR.ui.stopEvent(ev);}
Calendar.prototype.nav=function(offset,step,from_date){if(!offset)offset=0;var date=new Date(from_date||this.date),sgn=offset<0?-1:1;if(step=='week')return this.nav(offset*7,'day',date);else if(step=='month'){if(offset){var d=date.getDate(),m=date.getMonth(),y=date.getFullYear();m+=offset;while(m>=12){y++;m-=12;}
while(m<0){y--;m+=12;}
date.setDate(1);date.setFullYear(y);date.setMonth(m);date.setDate(Math.min(d,date.getMonthDays()));offset=0;}}
else if(step=='year'){if(offset){date.setFullYear(date.getFullYear()+offset);offset=0;}}
var info=this.calcMonthInfo(date),idx=info.currentIndex;idx+=offset;while(1){if(idx<info.startOffset){idx=idx-info.startOffset+1;date.setDate(0);info=this.calcMonthInfo(date);idx+=info.currentIndex;continue;}
if(idx>=info.endOffset){idx-=info.endOffset;date.setDate(info.no_days+1);info=this.calcMonthInfo(date);idx+=info.startOffset;continue;}
if(!info.days[idx].disabled)
break;idx+=sgn;}
if(this.setDate(info.days[idx].date))
this.callSelectHandler();}
Calendar.prototype._init=function(date,firstDayOfWeek){if(isset(Calendar.dateToday))
this.today=new Date(parseFloat(Calendar.dateToday));else
this.today=new Date();if(date)
this.date=new Date(date);else if(!this.date)
this.date=new Date(this.today);if(isset(firstDayOfWeek))this.firstDayOfWeek=firstDayOfWeek;var info=this.month_info=this.calcMonthInfo();if(!this.body)return;var row,cell,idx=0,dayinfo;SUGAR.ui.clearChildNodes(this.body);for(var i=0;i<this.rows.length;i++){row=this.rows[i];date=info.days[i*7].date;cell=row.firstChild;if(this.weekNumbers){SUGAR.ui.setElementText(cell,''+app_string('LBL_WEEK_PREFIX')+date.getWeekNumber());cell=cell.nextSibling;}
var hasdays=false;for(var j=0;j<7;++j,cell=cell.nextSibling){cell.dayindex=idx;dayinfo=info.days[idx++];SUGAR.ui.addRemoveClass(cell,'outside',dayinfo.otherMonth);SUGAR.ui.addRemoveClass(cell,'inside',!dayinfo.otherMonth);SUGAR.ui.addRemoveClass(cell,'current',dayinfo.today);SUGAR.ui.addRemoveClass(cell,'selected',dayinfo.selected);SUGAR.ui.addRemoveClass(cell,'quiet',dayinfo.weekend);if(cell.disabled){SUGAR.ui.setElementText(cell,'');cell.ttip='';SUGAR.ui.removeClass(cell,'responsive');}else{SUGAR.ui.setElementText(cell,dayinfo.date.getDate());if(!dayinfo.otherMonth)hasdays=true;cell.ttip="_";if(dayinfo.today)
cell.ttip+=Calendar._TT["PART_TODAY"];SUGAR.ui.addClass(cell,'responsive');}}
if(hasdays)this.body.appendChild(row);}
this.updateTitle();};Calendar.prototype.calcMonthInfo=function(sel_date){if(!sel_date)sel_date=this.date;var date=new Date(sel_date),year=sel_date.getFullYear(),month=sel_date.getMonth(),mday=sel_date.getDate(),no_days=sel_date.getMonthDays(),info={year:year,month:month,mday:mday,no_days:no_days},weekend=this.weekend||Calendar._TT["WEEKEND"]||"0,6",dayinfo,status_func=(typeof(this.getDateStatus)=="function")?this.getDateStatus:null;date.setDate(1);var day1=(date.getDay()-this.firstDayOfWeek)%7,start_offs;if(day1<0)
day1+=7;start_offs=(day1?-day1:0)+1;if(start_offs!=1)
date.setDate(start_offs);info.startOffset=day1;info.endOffset=day1+info.no_days;info.days=[];for(var i=0;i<42;i++){dayinfo={otherMonth:false,today:false,weekend:false,selected:false};dayinfo.date=new Date(date);var cls='day',iday=date.getDate();if(date.getMonth()!=month){dayinfo.otherMonth=true;if(!this.showsOtherMonths)
dayinfo.disabled=true;}
if(!dayinfo.disabled){if(status_func){var status=status_func(date,year,month,iday);if(status===true){dayinfo.disabled=true;}else{if(/disabled/i.test(status))
dayinfo.disabled=true;cls+=' '+trim(status);}}}
if(weekend.indexOf(date.getDay().toString())!=-1){dayinfo.weekend=true;}
if(date.equalsTo(this.today,false)){dayinfo.today=true;}
if(date.equalsTo(sel_date,false)){info.currentIndex=i;dayinfo.selected=true;}
info.days.push(dayinfo);date.setDate(date.getDate()+1);}
return info;}
Calendar.prototype.updateTitle=function(){SUGAR.ui.setElementText(this.title,Calendar._MN[this.date.getMonth()]+' '+this.date.getFullYear());}
Calendar.prototype.setDate=function(date){if(!date)date=new Date();if(!date.equalsTo(this.date,false)){this._init(date);return true;}};Calendar.prototype.refresh=function(){this._init();};Calendar.prototype.setFirstDayOfWeek=function(firstDayOfWeek){this._init(null,firstDayOfWeek);this._displayWeekdays();};Calendar.prototype.setDateStatusHandler=Calendar.prototype.setDisabledHandler=function(unaryFunction){this.getDateStatus=unaryFunction;};Calendar.prototype.setRange=function(a,z){this.minYear=a;this.maxYear=z;};Calendar.prototype.callSelectHandler=function(){if(this.onselect){this.onselect(this,this.printDate(),this.date);}};Calendar.prototype.callUpdateHandler=function(){if(this.onchange){this.onchange(this,this.printDate(),this.date);}};Calendar.prototype.callCloseHandler=function(){if(this.onclose){this.onclose(this);}};Calendar.prototype.callStatusHandler=function(msg,is_default){if(this.onstatus){this.onstatus(this,msg,is_default);}};Calendar.prototype.showStatus=function(msg,is_default){this.callStatusHandler(msg,is_default);if(this.tooltips)
SUGAR.ui.setElementText(this.tooltips,msg||'');}
Calendar.prototype.destroy=function(){var o=this.outer,el;if(o&&(el=o.parentNode))
el.removeChild(o);};Calendar.prototype.reparent=function(new_parent){if(this.outer)
new_parent.appendChild(this.outer);};Calendar.prototype.clearHighlight=function(){var rows=this.rows,row,cell,i;for(i=0;i<this.rows.length;i++){row=rows[i];SUGAR.ui.removeClass(row,'rowhilite');for(cell=row.firstChild;cell;cell=cell.nextSibling){SUGAR.ui.removeClass(cell,'hilite');SUGAR.ui.removeClass(cell,'active');}}};Calendar.prototype.printDate=function(format){return this.date.print(format||this.dateFormat);};Calendar.prototype.setDateFormat=function(str){this.dateFormat=str;};Calendar.prototype.setTtDateFormat=function(str){this.ttDateFormat=str;};Calendar.parseDate=function(str,fmt){var y=0;var m=-1;var d=0;var a=str.split(/\W+/);var b=fmt.match(/%./g);var i=0,j=0;var hr=0;var min=0;for(i=0;i<a.length;++i){if(!a[i])
continue;switch(b[i]){case"%d":
case"%e":
d=parseInt(a[i],10);break;case"%m":
m=parseInt(a[i],10)-1;break;case"%Y":
case"%y":
y=parseInt(a[i],10);(y<100)&&(y+=(y>29)?1900:2000);break;case"%b":
case"%B":
for(j=0;j<12;++j){if(Calendar._MN[j].substr(0,a[i].length).toLowerCase()==a[i].toLowerCase()){m=j;break;}}
break;case"%H":
case"%I":
case"%k":
case"%l":
hr=parseInt(a[i],10);break;case"%P":
case"%p":
if(/pm/i.test(a[i])&&hr<12)
hr+=12;break;case"%M":
min=parseInt(a[i],10);break;}}
if(y!=0&&m!=-1&&d!=0){return new Date(y,m,d,hr,min,0);}
y=0;m=-1;d=0;for(i=0;i<a.length;++i){if(a[i].search(/[a-zA-Z]+/)!=-1){var t=-1;for(j=0;j<12;++j){if(Calendar._MN[j].substr(0,a[i].length).toLowerCase()==a[i].toLowerCase()){t=j;break;}}
if(t!=-1){if(m!=-1){d=m+1;}
m=t;}}else if(parseInt(a[i],10)<=12&&m==-1){m=a[i]-1;}else if(parseInt(a[i],10)>31&&y==0){y=parseInt(a[i],10);(y<100)&&(y+=(y>29)?1900:2000);}else if(d==0){d=a[i];}}
if(y==0){var today=new Date();y=today.getFullYear();}
if(m!=-1&&d!=0){return new Date(y,m,d,hr,min,0);}
return null;}
Calendar.prototype.parseDate=function(str,fmt){var d=Calendar.parseDate(str,fmt||this.dateFormat);if(d)this.setDate(d);};Calendar.prototype._displayWeekdays=function(){var fdow=this.firstDayOfWeek;var cell=this.firstdayname;var weekend=Calendar._TT["WEEKEND"];if(!weekend)weekend="0,6";for(var i=0;i<7;++i){var realday=(i+fdow)%7;if(i){var lbl=Calendar._TT["DAY_FIRST"];if(!lbl)lbl="%s";cell.ttip=lbl.replace("%s",Calendar._DN[realday]);cell.navtype=100;cell.fdow=realday;Calendar._add_evs(cell,this);}
SUGAR.ui.addRemoveClass(cell,'weekend',(weekend.indexOf(realday.toString())!=-1));SUGAR.ui.setElementText(cell,Calendar._SDN[(i+fdow)%7]);cell=cell.nextSibling;}};Calendar.prototype._hideCombos=function(){this.monthsCombo.style.display="none";this.yearsCombo.style.display="none";};Date._MD=[31,28,31,30,31,30,31,31,30,31,30,31];Date.SECOND=1000;Date.MINUTE=60*Date.SECOND;Date.HOUR=60*Date.MINUTE;Date.DAY=24*Date.HOUR;Date.WEEK=7*Date.DAY;Date.prototype.isLeapYear=function(year){if(!isset(year)){year=this.getFullYear();}
if((0==(year%4))&&((0!=(year%100))||(0==(year%400)))){return 1;}
return 0;}
Date.prototype.getMonthDays=function(month,year){if(!isset(year)){year=this.getFullYear();}
if(!isset(month)){month=this.getMonth();}
if(this.isLeapYear(year)&&month==1){return 29;}else{return Date._MD[month];}};Date.prototype.getDayOfYear=function(){var now=new Date(this.getFullYear(),this.getMonth(),this.getDate(),0,0,0);var then=new Date(this.getFullYear(),0,0,0,0,0);var time=now-then;return Math.floor(time/Date.DAY);};Date.prototype.getWeekNumber=function(){var d=new Date(this.getFullYear(),this.getMonth(),this.getDate(),0,0,0);var DoW=d.getDay();d.setDate(d.getDate()-(DoW+6)%7+3);var ms=d.valueOf();d.setMonth(0);d.setDate(4);return Math.round((ms-d.valueOf())/(7*864e5))+1;};Date.prototype.equalsTo=function(date,check_time){if(!date)return false;var ret=((this.getFullYear()==date.getFullYear())&&
(this.getMonth()==date.getMonth())&&
(this.getDate()==date.getDate()));if(ret&&check_time)ret&=
((this.getHours()==date.getHours())&&
(this.getMinutes()==date.getMinutes()));return ret;};Date.prototype.print=function(str){SUGAR.ui.CalendarInput.initLanguage();var m=this.getMonth(),d=this.getDate(),y=this.getFullYear(),wn=this.getWeekNumber(),w=this.getDay(),hr=this.getHours(),pm=(hr>=12),ir=((pm)?(hr-12):hr)||12,dy=this.getDayOfYear(),min=this.getMinutes(),sec=this.getSeconds(),s={"%a":Calendar._SDN[w],"%A":Calendar._DN[w],'%b':Calendar._SMN[m],'%B':Calendar._MN[m],'%C':1+Math.floor(y/100),'%d':(d<10)?("0"+d):d,'%e':d,'%H':(hr<10)?("0"+hr):hr,'%I':(ir<10)?("0"+ir):ir,'%j':(dy<100)?((dy<10)?("00"+dy):("0"+dy)):dy,'%k':hr,'%l':ir,'%m':(m<9)?("0"+(1+m)):(1+m),'%M':(min<10)?("0"+min):min,'%n':"\n",'%p':pm?"PM":"AM",'%P':pm?"pm":"am",'%s':Math.floor(this.getTime()/1000),'%S':(sec<10)?("0"+sec):sec,'%t':"\t",'%u':w+1,'%U':(wn<10)?("0"+wn):wn,'%w':w,'%y':(''+y).substr(2,2),'%Y':y,'%%':"%"
};s['%W']=s['%V']=s['%U'];var re=/%./g;var isSafari=navigator.userAgent.toLowerCase().indexOf("safari")!=-1;if(!isSafari)return str.replace(re,function(par){return s[par]||par;})
var a=str.match(re);for(var i=0;i<a.length;i++){var tmp=s[a[i]];if(tmp){re=new RegExp(a[i],'g');str=str.replace(re,tmp);}}
return str;};Date.prototype.__msh_oldSetFullYear=Date.prototype.setFullYear;Date.prototype.setFullYear=function(y){var d=new Date(this);d.__msh_oldSetFullYear(y);if(d.getMonth()!=this.getMonth())
this.setDate(28);this.__msh_oldSetFullYear(y);};SUGAR.language.populate({"language":"en_us","name":"app","strings":{"ERR_INVALID_DATE":"Please enter a valid date.","ERR_INVALID_DAY":"Please enter a valid day.","ERR_INVALID_EMAIL_ADDRESS":"not a valid email address.","ERR_INVALID_FILE_REFERENCE":"Invalid File Reference","ERR_INVALID_HOUR":"Please enter a valid hour.","ERR_INVALID_MONTH":"Please enter a valid month.","ERR_INVALID_TIME":"Please enter a valid time.","ERR_INVALID_YEAR":"Please enter a valid 4 digit year.","ERR_MISSING_REQUIRED_FIELDS":"Missing required field(s)","ERR_INVALID_VALUE":"Invalid Value","ERR_NO_SINGLE_QUOTE":"Cannot use the single quotation mark for ","ERR_SELF_REPORTING":"User cannot report to him or herself.","ERR_SQS_NO_MATCH":"No Match","ERR_CREATE_LIST_LAYOUT_MODULE":"Please select module.","LBL_SESSION_UNIQUE_KEY":"Your session has expired.","LBL_SESSION_IP_MISMATCH":"Your session was terminated due to a significant change in your IP address.","LBL_ACCOUNT":"Account","LBL_ACCOUNTS":"Accounts","LBL_ADD_BUTTON":"Add","LBL_ADD_DOCUMENT":"Add Document","LBL_ADDITIONAL_DETAILS_CLOSE_TITLE":"Click to Close","LBL_ADDITIONAL_DETAILS_CLOSE":"Close","LBL_ADDITIONAL_DETAILS":"Additional Details","LBL_NO_ADDITIONAL_DETAILS":"There are no additional details for this record.","LBL_ADMIN":"Administration","LBL_ALT_HOT_KEY":"Alt+","LBL_ARCHIVE":"Archive","LBL_ASSIGNED_TO_USER":"Assigned to User","LBL_ASSIGNED_TO":"Assigned to","LBL_BACK":"Back","LBL_BROWSER_TITLE":"1CRM System","LBL_HEADER_ALT_TEXT":"1CRM System","LBL_BUGS":"Bugs","LBL_BY":"by","LBL_CALLS":"Calls","LBL_CANCEL_BUTTON_KEY":"X","LBL_CANCEL_BUTTON_LABEL":"Cancel","LBL_CANCEL_BUTTON_TITLE":"Cancel [Alt+X]","LBL_CASE":"Case","LBL_CASES":"Cases","LBL_CHANGE_BUTTON_LABEL":"Change","LBL_CHECKALL":"Check All","LBL_CLEAR_BUTTON_LABEL":"Clear","LBL_CLEARALL":"Clear All","LBL_CLOSE_WINDOW":"Close Window","LBL_CONTACT":"Contact","LBL_CONTACTS":"Contacts","LBL_CREATE_BUTTON_LABEL":"Create","LBL_CREATED_BY_USER":"Created by User","LBL_CREATED":"Created by","LBL_CURRENT_USER_FILTER":"Only my items","LBL_DATE_ENTERED":"Date Created","LBL_DATE_MODIFIED":"Last Modified","LBL_DELETE_BUTTON_KEY":"D","LBL_DELETE_BUTTON_LABEL":"Delete","LBL_DELETE_BUTTON_TITLE":"Delete [Alt+D]","LBL_DELETE":"Delete","LBL_DELETED":"Deleted","LBL_SELECT_PAGE":"Select Page","LBL_SELECT_ALL":"Select All","LBL_DESELECT_ALL":"Deselect All","LBL_SELECTED_ALL":"All results","LBL_DIRECT_REPORTS":"Direct Reports","LBL_DONE_BUTTON_LABEL":"Done","LBL_DUPLICATE_BUTTON_KEY":"U","LBL_DUPLICATE_BUTTON_LABEL":"Duplicate","LBL_DUPLICATE_BUTTON_TITLE":"Duplicate [Alt+U]","LBL_EDIT_BUTTON_KEY":"E","LBL_EDIT_BUTTON_LABEL":"Edit","LBL_EDIT_BUTTON_TITLE":"Edit [Alt+E]","LBL_VIEW_BUTTON_KEY":"V","LBL_VIEW_BUTTON_LABEL":"View","LBL_VIEW_BUTTON_TITLE":"View [Alt+V]","LBL_EMAILS":"Emails","LBL_EMPLOYEES":"Employees","LBL_EXPORT_ALL":"Export All","LBL_EXPORT":"Export","LBL_HIDE":"Hide","LBL_ID":"ID","LBL_IMPORT":"Import","LBL_LAST_VIEWED":"Last Viewed","LBL_LEADS":"Leads","LBL_LIST_ACCOUNT_NAME":"Account Name","LBL_LIST_ASSIGNED_USER":"User","LBL_LIST_CONTACT_NAME":"Contact Name","LBL_LIST_CONTACT_ROLE":"Contact Role","LBL_LIST_EMAIL":"Email","LBL_LIST_NAME":"Name","LBL_LIST_OF":"of","LBL_LIST_PHONE":"Phone","LBL_LIST_USER_NAME":"User Name","LBL_LISTVIEW_NO_SELECTED":"Please select at least 1 record to proceed.","LBL_LISTVIEW_TWO_REQUIRED":"Please select at least 2 records to proceed.","LBL_LISTVIEW_OPTION_CURRENT":"Current Page","LBL_LISTVIEW_OPTION_ENTIRE":"Entire List","LBL_LISTVIEW_OPTION_SELECTED":"Selected Records","LBL_LISTVIEW_SELECTED_OBJECTS":"Selected: ","LBL_LOCALE_NAME_EXAMPLE_FIRST":"John","LBL_LOCALE_NAME_EXAMPLE_LAST":"Doe","LBL_LOCALE_NAME_EXAMPLE_SALUTATION":"Mr.","LBL_LOGOUT":"Logout","LBL_MAILMERGE_KEY":"M","LBL_MAILMERGE":"Mail Merge","LBL_MASS_UPDATE":"Mass Update","LBL_MEETINGS":"Meetings","LBL_MEMBERS":"Members","LBL_MODIFIED_BY_USER":"Modified by User","LBL_MODIFIED":"Modified by","LBL_MY_ACCOUNT":"My Account","LBL_NAME":"Name","LBL_NEW_BUTTON_LABEL":"Create","LBL_NEXT_BUTTON_LABEL":"Next","LBL_NONE":"(none)","LBL_ANY":"(any)","LBL_NO_CHANGE":"No change","LBL_NOTES":"Notes","LBL_OPPORTUNITIES":"Opportunities","LBL_OPPORTUNITY_NAME":"Opportunity Name","LBL_OPPORTUNITY":"Opportunity","LBL_OR":"OR","LBL_PERCENTAGE_SYMBOL":"%","LBL_PRODUCTS":"Products","LBL_PRODUCT_CATEGORIES":"Product Categories","LBL_PROJECT_TASKS":"Project Tasks","LBL_PROJECTS":"Projects","LBL_QUOTES":"Quotes","LBL_RELATED_RECORDS":"Related Records","LBL_REMOVE":"Remove","LBL_REQUIRED_SYMBOL":"*","LBL_SAVE_BUTTON_KEY":"S","LBL_SAVE_BUTTON_LABEL":"Save","LBL_SAVE_BUTTON_TITLE":"Save [Alt+S]","LBL_FULL_FORM_BUTTON_KEY":"F","LBL_FULL_FORM_BUTTON_LABEL":"Full Form","LBL_FULL_FORM_BUTTON_TITLE":"Full Form [Alt+F]","LBL_SAVE_NEW_BUTTON_KEY":"V","LBL_SAVE_NEW_BUTTON_LABEL":"Save & Create New","LBL_SAVE_NEW_BUTTON_TITLE":"Save & Create New [Alt+V]","LBL_SAVE_VIEW_BUTTON_LABEL":"Save & View","LBL_CALL_BUTTON_LABEL":"Call","LBL_START_CALL_BUTTON_LABEL":"Start Call","LBL_CALL_OUT_BUTTON_LABEL":"Call using","LBL_CALL_OUT_CONFIRM":"Update Call Duration and Status?","ERR_WRONG_PHONE_NUMBER":"Unrecognized phone number format","LBL_SEARCH_BUTTON_KEY":"Q","LBL_SEARCH_BUTTON_LABEL":"Search","LBL_SEARCH_BUTTON_TITLE":"Search [Alt+Q]","LBL_SEARCH":"Search","LBL_SELECT_BUTTON_KEY":"T","LBL_SELECT_BUTTON_LABEL":"Select","LBL_SELECT_BUTTON_TITLE":"Select [Alt+T]","LBL_SELECT_CONTACT_BUTTON_KEY":"T","LBL_SELECT_USER_BUTTON_KEY":"U","LBL_SELECT_USER_BUTTON_LABEL":"Select User","LBL_SELECT_USER_BUTTON_TITLE":"Select User [Alt+U]","LBL_SERVER_RESPONSE_RESOURCES":"Resources used to construct this page (queries, files, config)","LBL_SERVER_RESPONSE_TIME_SECONDS":"seconds.","LBL_SERVER_RESPONSE_TIME":"Server response time","LBL_SERVER_RESPONSE_TIME_DB":"Total database query time","LBL_SERVER_RESPONSE_TIME_CONFIG":"Total config read time","LBL_SHORTCUTS":"Shortcuts","LBL_SHOW":"Show","LBL_ACTIONS":"Actions","LBL_STATUS_UPDATED":"Your status for this event has been updated!","LBL_STATUS":"Status","LBL_SUBJECT":"Subject","LBL_SYNC":"Sync","LBL_TABGROUP_ALL":"All","LBL_TABGROUP_ACTIVITIES":"Activities","LBL_TABGROUP_COLLABORATION":"Collaboration","LBL_TABGROUP_HOME":"Home","LBL_TABGROUP_MARKETING":"Marketing","LBL_TABGROUP_MY_PORTALS":"My Websites","LBL_TABGROUP_OTHER":"Other","LBL_TABGROUP_REPORTS":"Reports","LBL_TABGROUP_SALES":"Sales","LBL_TABGROUP_SUPPORT":"Customer Service","LBL_TABGROUP_TOOLS":"Tools","LBL_TASKS":"Tasks","LBL_TEAMS_LINK":"Team","LBL_THOUSANDS_SYMBOL":"K","LBL_UNDELETE_BUTTON_LABEL":"Undelete","LBL_UPDATE":"Update","LBL_USER_LIST":"User List","LBL_USERS":"Users","LNK_ABOUT":"About","LNK_ADVANCED_SEARCH":"Advanced","LNK_BASIC_SEARCH":"Basic","LNK_HELP":"Help","LNK_LIST_END":"End","LNK_LIST_NEXT":"Next","LNK_LIST_PREVIOUS":"Previous","LNK_LIST_RETURN":"Return to List","LNK_LIST_START":"Start","LNK_PRINT":"Print","LNK_REMOVE":"rem","LNK_RESUME":"Resume","LNK_VIEW_CHANGE_LOG":"View Change Log","LNK_OPEN_IN_NEW_WINDOW":"Open in New Window","NTC_CLICK_BACK":"Please click the browser back button and fix the error.","NTC_DELETE_CONFIRMATION_MULTIPLE":"Are you sure you want to delete selected record(s)?","NTC_DELETE_CONFIRMATION":"Are you sure you want to delete this record?","NTC_LOGIN_MESSAGE":"Please enter your username and password.","NTC_NO_ITEMS_DISPLAY":"none","NTC_REMOVE_CONFIRMATION":"Are you sure you want to remove this relationship?","NTC_REQUIRED":"Indicates required field","NTC_WELCOME":"Welcome","NTC_YEAR_FORMAT":"(yyyy)","NTC_HOURS_BOOKED":"Hours successfully booked.","LOGIN_LOGO_ERROR":"Please replace the SugarCRM logos.","ERROR_NO_RECORD":"Error retrieving record.  This record may be deleted or you may not be authorized to view it.","LBL_DUP_MERGE":"Find Duplicates","LBL_MANAGE_SUBSCRIPTIONS":"Manage Subscriptions","LBL_MANAGE_SUBSCRIPTIONS_FOR":"Manage Subscriptions for ","LBL_SUBSCRIBE":"Subscribe","LBL_UNSUBSCRIBE":"Unsubscribe","LBL_LOADING":"Loading ...","LBL_SAVING_LAYOUT":"Saving Layout ...","LBL_SAVED_LAYOUT":"Layout has been saved.","LBL_SAVED":"Saved","LBL_SAVING":"Saving","LBL_DISPLAY_COLUMNS":"Display Columns","LBL_HIDE_COLUMNS":"Hide Columns","LBL_PROCESSING_REQUEST":"Processing..","LBL_REQUEST_PROCESSED":"Done","LBL_MERGE_DUPLICATES":"Merge Duplicates","ERROR_JS_ALERT_SYSTEM_CLASS":"System","ERROR_JS_ALERT_TIMEOUT_TITLE":"Session Timeout","ERROR_JS_ALERT_TIMEOUT_MSG_1":"Your session will time out in two minutes. Please save your work.","ERROR_JS_ALERT_TIMEOUT_MSG_2":"Your session has timed out.","MSG_JS_ALERT_MTG_REMINDER_AGENDA":"\nAgenda","MSG_JS_ALERT_MTG_REMINDER_MEETING":"Meeting","MSG_JS_ALERT_MTG_REMINDER_CALL":"Call","MSG_JS_ALERT_MTG_REMINDER_TASK":"Task","MSG_JS_ALERT_MTG_REMINDER_TIME":"Time","MSG_JS_ALERT_MTG_REMINDER_LOC":"Location","MSG_JS_ALERT_MTG_REMINDER_DESC":"Description","MSG_JS_ALERT_MTG_REMINDER_MSG":"\nClick OK to view this meeting or click Cancel to dismiss this message.","LBL_GENERATE_WEB_TO_LEAD_FORM":"Generate Form","LBL_EXPORT_TO_WORDPRESS":"Export to Wordpress","LBL_COPY_TO_WORDPRESS":"Copy the code from box below, and import it into 1CRM Forms plugin for Wordpress","LBL_SAVE_WEB_TO_LEAD_FORM":"Save Web To Lead Form","LBL_PLEASE_SELECT":"Please Select","LBL_REDIRECT_URL":"Redirect URL","LBL_RELATED_CAMPAIGN":"Related campaign","LBL_ADD_ALL_LEAD_FIELDS":"Add All Fields","LBL_REMOVE_ALL_LEAD_FIELDS":"Remove All Fields","LBL_ONLY_IMAGE_ATTACHMENT":"Only image type attachment can be embedded","LBL_HOME":"Home","LBL_HOME_DASHBOARD":"Home Dashboard","LBL_ACTION_ITEMS":"Action Items","LBL_TABGROUP_TODAY_ACTIVITIES":"Today's Activities","LBL_TABGROUP_REPORTS_SETTINGS":"Reports & Settings","LBL_TABGROUP_SECURITY":"Teams","LBL_SALES_HOME":"Sales Home","LBL_SALES_CHARTS":"Sales Charts","LBL_SUPPORT_HOME":"Service Home","LBL_SUPPORT_CHARTS":"Service Charts","LBL_FINANCE_HOME":"Finance Home","LBL_FINANCE_CHARTS":"Finance Charts","LBL_PROJECT_HOME":"Project Home","LBL_PROJECT_CHARTS":"Project Charts","LBL_FREE_TRIAL":"Free Trial","LBL_DEMO_VERSION":"Demo Version","MSG_LIC_UPGRADES_DISABLED":"Upgrades are disabled. Please check the status of your support contract.","MSG_LIC_FEATURE_DISABLED":"This feature is disabled. Please check the status of your support contract.","LBL_EDIT_DASHLET":"Edit Dashlet","LBL_DELETE_DASHLET":"Delete Dashlet","LBL_REFRESH_DASHLET":"Refresh Dashlet","LBL_FILTER_DASHLET":"Filter Dashlet","LBL_DASHLET_FILTER_LABEL":"Filter results","LBL_CLEAR_FILTER":"Clear Filter","LBL_FILTER_VALUE_AND":" and ","LBL_PRINT_DASHLET":"Print Dashlet","LBL_SHORT_BROWSER_TITLE":"1CRM","LBL_HOURS_SHORT":"hrs","NTC_APPNAME":"1CRM System {VERSION}","NTC_LICENSED_TO":"Licensed to","LBL_HR":"HR","LBL_DIRECTORY":"Directory","LBL_LIST_DATE":"Date","LBL_LIST_DATE_ENTERED":"Date Created","LBL_DATE_ENTERED_SHORT":"Created","LBL_LIST_DATE_MODIFIED":"Date Modified","LBL_DATE_MODIFIED_SHORT":"Modified","LBL_LAST_ACTIVITY":"Last Activity Date","LBL_LIST_LAST_ACTIVITY":"Last Activity","LBL_LIST_STATUS":"Status","LNK_NEW_NOTE":"Create Note","LBL_SAVE_AND_NEW_BUTTON":"Save & New","LBL_SAVE_AND_CLOSE_BUTTON":"Save & Close","LBL_SELECT_RESOURCE_BUTTON_TITLE":"Select Resource [Alt+R]","LBL_SELECT_RESOURCE_BUTTON_KEY":"R","LBL_SELECT_RESOURCE_BUTTON_LABEL":"Select Resource","LBL_RESOURCE_LIST":"Resource List","LBL_RESOURCES":"Resources","LBL_LIST_SERVICE_CONTRACT":"Svc. Contract","LBL_SERVICE_CONTRACT":"Service Contract","LBL_CATEGORY":"Category","LBL_LIST_CATEGORY":"Category","LBL_DOCUMENTS":"Documents","LBL_CONVERT_BUTTON_LABEL":"Convert","LBL_CONV_TO_PROJECT":"Convert to Project","LBL_CONVERTED":"Converted","LBL_SELECT_ALL_BUTTON_LABEL":"Select All","LBL_VIEW_CLOSED_ITEMS":"View Closed Items","LBL_ALL_ACTIVE":"All Active","LBL_IS_PRIVATE":"Private","LBL_EXPORT_BUTTON_LABEL":"Export","LBL_COMMIT_BUTTON_LABEL":"Commit","LBL_START_EDIT_BUTTON_LABEL":"Start Edit","LBL_EXCHANGE_RATE":"Exchange Rate","LBL_LIST_EXCHANGE_RATE":"Exchange Rate","LBL_EDIT_EXCHANGE_RATE_TITLE":"Adjust Exchange Rate","LBL_EDIT_EXCHANGE_RATE_ALT":"[Adjust Rate]","LBL_STANDARD_RATE":"Standard Rate","LBL_CUSTOM_RATE":"Custom Rate","LBL_RESET_BUTTON_LABEL":"Reset","LBL_LINK_UPDATES":"Link Updates","LBL_CLEAR_EXCHANGE_RATE_ALT":"[Clear]","LBL_BOOKED_HOURS":"Booked Hours","LBL_BOOKING_CATEGORY":"Booking Category","LBL_BOOKED_HOURS_SUBPANEL_TITLE":"Booked Hours","LBL_BOOKING_BUTTON_TITLE":"Book Hours [Alt+B]","LBL_BOOKING_BUTTON_LABEL":"Book Hours...","LBL_BOOKING_BUTTON_KEY":"B","LBL_BOOKING_TAB_LABEL":"Book Hours","LNK_UP":"up","LNK_DOWN":"down","LNK_INS":"insert","LBL_TIME_PERIOD_YEARS_MONTHS":"%1y %2m","LBL_TIME_PERIOD_DAYS_HOURS":"%1d %2h","LBL_HOURS_ABBREV":"h","LBL_MINS_ABBREV":"m","LBL_DURATION_ALL_DAY":"All Day","LBL_CAMPAIGNS":"Campaigns","LBL_EVENTS":"Marketing Events","LBL_PARTNER":"Partner","LBL_PARTNERS":"Partners","LBL_PROSPECTS":"Targets","LBL_PROSPECT_LIST":"Target Lists","LBL_IMAGE":"Image","LBL_IMAGE_CLEAR":"Clear Image","LBL_IMAGE_FORMAT_GIF":"GIF","LBL_IMAGE_FORMAT_JPEG":"JPEG","LBL_IMAGE_FORMAT_PNG":"PNG","LBL_AUTO_CREATE_THUMBNAIL":"Automatically Create Thumbnail Image. Supported formats","LBL_RETURN":"Return","LBL_RECUR_BUTTON_TITLE":"Recurrence [Alt+R]","LBL_RECUR_BUTTON_KEY":"R","LBL_RECUR_BUTTON_LABEL":"Recurrence...","LBL_RECURRENCE_NUMBER":"Instance","LBL_RECURRENCE_OF_ID":"Recurrence of ID","LBL_RECURRENCE_INDEX":"Recurrence Index","LBL_RECURRENCE_FORWARD_TIMES":"Recurrence Forward Times","LBL_RECURRENCE_EDIT":"Edit recurrence","LBL_PARENT_NAME":"Parent Name","LBL_REASSIGN":"Re-Assign ","LBL_PDF_PHONE":"Phone","LBL_PDF_FAX":"Fax","LBL_PDF_PAGE_NUMBER_STRING":"{pg} of {nb}","MSG_DASHLET_NO_ACCESS":"You do not have access to this module","LBL_TABGROUP_SALES_MARKETING":"Sales & Marketing","LBL_TABGROUP_ORDER_MANAGEMENT":"Order Management","LBL_TABGROUP_PROJECT_MANAGEMENT":"Project Management","LBL_CREATE_PDF":"Create PDF...","LBL_USE_ADDRESS":"Use Address","LBL_USE_LAYOUT":"Use Layout","LBL_USE_LANGUAGE":"Use Language","LBL_USE_PDF_TEMPLATE":"Use PDF Form","LBL_SELECT_PDF_FORM":"Select PDF Form","LBL_PDF_PDF":"Print","LBL_PDF_PRINT_USING_TEMPLATE":"Print Using Template","LBL_PDF_DETAIL_BUTTON":"Print Details","LBL_PDF_EMAIL":"Email","LBL_OPEN_AS_PDF":"Open as PDF","LBL_EMAIL_AS_PDF":"Email as PDF","LBL_SKILL_NAME":"Skill","LBL_SKILL_RATING":"Rating","LBL_200_LEADS":"Sending emails to Leads is limited to 200 recipients","LBL_ADDRESS_STREET_FIELD":"Street Address","LBL_ADDRESS_CITY_FIELD":"City","LBL_ADDRESS_STATE_FIELD":"State","LBL_ADDRESS_STATECODE_FIELD":"State Code","LBL_ADDRESS_POSTALCODE_FIELD":"Postal Code","LBL_ADDRESS_COUNTRY_FIELD":"Country","LBL_ADDRESS_COUNTRYCODE_FIELD":"Country Code","LBL_ADDRESS_EMAIL_FIELD":"Email Address","LBL_ADDRESS_PHONE_FIELD":"Phone Number","LBL_ADDRESS_COPY_LABEL":"Copy to...","LBL_ADDRESS_COPY_CONTACTS_PRIMARY":"Primary Address of Contacts","LBL_ADDRESS_COPY_CONTACTS_OTHER":"Other Address of Contacts","LBL_ADDRESS_COPY_CONTACTS_BOTH":"Both Addresses of Contacts","LBL_ADDRESS_COPY_USER_MSG":"Save Account to Copy Address","LBL_ACCOUNT_NAME_FORMAT":"[Account Name]","LBL_CONTACT_NAME_FORMAT":"[Contact Name]","LBL_STREET_FORMAT":"[Street]","LBL_CITY_FORMAT":"[City]","LBL_STATE_FORMAT":"[State]","LBL_POSTAL_CODE_FORMAT":"[Postal Code]","LBL_COUNTRY_FORMAT":"[Country]","LBL_COMPANY_NAME_FORMAT":"[Company Name]","LBL_PHONE_NUMBER_FORMAT":"[Phone Number]","LBL_FAX_NUMBER_FORMAT":"[Fax Number]","LBL_DATE_LONG_FORMAT":"%A %B %e, %Y","LBL_DATE_SHORT_FORMAT":"%b %e, %Y","LNK_PDF":"PDF","LBL_STUDIO_DROP_HERE":"[Drop Here]","LBL_EXPORT_VCARDS":"Export vCards","LBL_RTF_NO_TEMPLATE":"Please select an RTF template","LBL_RTF_INVALID_SEL":"Only RTF templates are accepted","LBL_RUN_QUICKCAMPAIGN_BUTTON_LABEL":"Run Campaign","LBL_QUICKCAMPAIGN_BUTTON_LABEL":"Quick Campaign","LBL_QUICKCAMPAIGN_BUTTON_CANCEL":"Cancel Quick Campaign","LBL_QUICKCAMPAIGN":"Quick Campaign","LBL_TEMPLATE_QUICKCAMPAIGN":"Email Template","LBL_MAILBOX_QUICKCAMPAIGN":"Campaign Mailbox","LBL_MISING_TEMPLATE":"Please select an email template","LBL_MISING_MAILBOX":"Please select a campaign mailbox","LBL_PREVIEW":"Preview","LBL_QUICKCAMPAIGN_CONFIRM":"Click Run Campaign to Mass Update all selected Leads\/Contacts, and send them each a personalized email","ERR_TEMPLATE_EMPTY":"Error: Template is empty","ERR_MAILBOX_EMPTY":"Error: Mailbox is empty","ERR_MODULE_IDS_EMPTY":"Error: Contacts List or Leads List is empty","ERR_MODULE_IDS_NOT_ARRAY":"Module is not an array","ERR_MODULE_NAME_EMPTY":"Error: Module name is empty","LBL_CATEGORIES_BUTTON_LABEL":"Categories","LBL_CATEGORIES_BUTTON_CANCEL":"Cancel Categories","LBL_CATEGORIES":"Categories","LBL_CATEGORIES_UPDATE_OPTION":"Update Option","LBL_CATEGORIES_UPDATE_BUTTON":"Update Categories","LBL_CATEGORIES_SELECT_ADD":"Add to Existing Categories","LBL_CATEGORIES_SELECT_SET":"Set Only These Categories","ERR_CATEGORIES_EMPTY":"Error: Categories Empty","ERR_CATEGORIES_OPTION_EMPTY":"Error: Update Option Empty","ERR_CATEGORIES_NOT_SELECTED":"Please select at least 1 category.","NTC_SERVER_BAD_RESPONSE":"Error: The server returned an unexpected response.","LBL_RUN_MERGE":"Run Merge","LBL_MAIL_MERGE_NOTE":"Please select an RTF file to use as the document template","NTC_NEW_EMAIL_MESSAGE":"New Email Message","NTC_NEW_EMAIL_MESSAGES":"%d New Email Messages","LBL_GOTO_EMAIL":"Go to Email","LBL_COMPOSE_EMAIL":"Compose Email","NTC_JS_SESSION_ENDED":"Your session has ended. Please log in again to continue.","NTC_JS_SESSION_ENDED_SHORT":"Please log in to resume session","NTC_JS_FORBIDDEN":"Access to the requested data is forbidden.","LBL_DUPLICATE_LIST":"Duplicate List","LBL_DUPLICATES_FOUND":"Potential Duplicates Found","LBL_DUPE_SAVED_RECORD":"Saved record","LBL_SCHEDULE_CALL":"Schedule Call","LBL_SCHEDULE_MEETING":"Schedule Meeting","LBL_VISIBILITY":"Visibility","LBL_DAY_CAL_LINK":"Today","LBL_WEEK_CAL_LINK":"This Week","LBL_MONTH_CAL_LINK":"This Month","LBL_CURRENCY_ID":"Currency ID","LBL_SECURITYGROUPS":"Teams","LBL_SELECT_TEAM_PLACEHOLDER":"(select a team)","LBL_ADD_TEAM_PLACEHOLDER":"(add a team)","LBL_SELECT_USER_PLACEHOLDER":"(select a user)","LBL_LIST_DESCRIPTION":"Description","LBL_LIST_STATUS_ICON":"(Status Icon)","LBL_ASYNC_JS_ERROR":"There was an error handling this request.","LBL_MAP":"Map","LBL_SHOW_ON_MAP":"Show on Map","LBL_REDIRECT_COUNTDOWN":"Redirecting to Home page in {TIME}...","LBL_ADJUST_LIST_POS_TITLE":"Adjust List Position","LBL_LISTVIEW_OFFSET":"Start At","LBL_LISTVIEW_COUNT":"Per Page","LBL_GO_TO_MODULE":"Go to Module","LBL_SYSTEM_USER":"(Global)","LBL_SECURITYGROUPS_SUBPANEL_TITLE":"Teams","LBL_LIST_LOCATION":"Location","LBL_LIST_EMAIL_PHONE":"Email and Phone","LBL_CAMPAIGN":"Campaign","LBL_CONNECTION_FAILED":"Connection failed.","LBL_LOGIN_FAILED":"Login failed.","LBL_LOGIN_NO_USERNAME":"No user name provided.","LBL_LOGGED_IN":"Logged in successfully.","LBL_LOGGING_IN":"Logging in ...","LBL_LOGIN_MOBILE":"Switch to mobile interface","LBL_LOGIN_NO_MOBILE":"Switch to standard interface","LBL_REDIRECTING":"Redirecting ...","LBL_LOGIN_BUTTON_LABEL":"Login","LBL_PASSWORD":"Password","LBL_USER_NAME":"User Name","LBL_NO_RESULTS":"No results","LBL_LIST_RESULT_ONE":"1 result","LBL_LIST_RESULT_MANY":"{COUNT} results","LBL_LIST_RESULT_PAGE":"Page {COUNT}","LBL_UPDATED_RESULTS":"Updated","LBL_FILTER_OWNER_ANY":"Any Owner","LBL_FILTER_OWNER_ANY_TEAM":"Any Team","LBL_FILTER_OWNER_MINE":"Assigned to Me","LBL_FILTER_OWNER_NOT_MINE":"Assigned to Others","LBL_FILTER_OWNER_MY_TEAM":"My Team Records","LBL_FILTER_OWNER_GLOBAL":"Global Records","LBL_FILTER_OWNER_SELECT":"Select User...","LBL_FILTER_FAVORITES":"Only Favorites","LBL_FILTER_ANY_MODULE":"Any module","LBL_FILTER_ANY_VALUE":"Any value","LBL_CREATE_LAYOUT_FORM_TITLE":"Create Layout","LBL_ARRANGE_LAYOUTS_FORM_TITLE":"Arrange Layouts","LBL_ARRANGE_SUBPANELS_FORM_TITLE":"Arrange Subpanels","LBL_ARRANGE_SUBPANELS_LABEL":"Arrange Subpanels","LBL_EDIT_LAYOUT_FORM_TITLE":"Edit Layout","LBL_EDIT_REPORT_FORM_TITLE":"Edit Report","LBL_EDIT_LAYOUT_BUTTON_LABEL":"Edit Layout","LBL_DUPLICATE_LAYOUT_BUTTON_LABEL":"Duplicate Layout","LBL_DEFAULT_LAYOUT_BUTTON_LABEL":"Restore Default Layout","LBL_RESTORE_LAYOUT_BUTTON_LABEL":"Restore Back Up Layout Version","MSG_RESTORE_LAYOUT_WARNING":"Are you certain you would like to restore this layout to the application default?","LBL_CREATE_MOBILE_LAYOUT_BUTTON_LABEL":"Create Mobile Layout","LBL_EDIT_MOBILE_LAYOUT_BUTTON_LABEL":"Edit Mobile Layout","LBL_EDIT_REPORT_BUTTON_LABEL":"Edit Report","LBL_DELETE_LAYOUT_BUTTON_LABEL":"Delete Layout","LBL_DELETE_REPORT_BUTTON_LABEL":"Delete Report","MSG_CONFIRM_DELETE_LAYOUT":"Are you certain you would like to delete this custom list layout?","MSG_CONFIRM_DELETE_RUN":"Are you certain you would like to delete this report run?","LBL_FILTER_TEXT":"Search Text","LBL_FILTER_OWNER":"Owner","LBL_APPLY_FILTER_BUTTON_LABEL":"Apply Filter","LBL_ARRANGE_LAYOUTS_NAME":"Layout Name","LBL_ARRANGE_LAYOUTS_VISIBLE":"Visible?","LBL_ARCHIVED_RUNS_BUTTON_LABEL":"Archived Runs","LBL_DELETE_RUN_BUTTON_LABEL":"Delete Run","LBL_RETURN_TO_LIST_BUTTON_LABEL":"Return to List","LBL_RETURN_TO_REPORT_BUTTON_LABEL":"Return to Report","LBL_RUN_REPORT_BUTTON_LABEL":"Run Report","LBL_SHOW_SQL_BUTTON_LABEL":"Show Report SQL","LBL_RUN_AND_ARCHIVE_BUTTON_LABEL":"Run and Archive","LBL_LAYOUT_BROWSE_ALL":"Browse All","LBL_LAYOUT_QUICK_FILTER":"Quick Filter","LBL_LAYOUT_REPORTS":"Reports","LBL_CREATE_REPORT_BUTTON_LABEL":"Create Report","LBL_FILTER_CHOOSE":"More","LBL_SELECT_FIELD":"Select field...","LBL_SELECT_FILTER":"Select filter...","LBL_SELECT_SOURCE":"Select related source...","LBL_SELECT_TOTAL":"Select total...","LBL_EMPTY_COLUMN":"(empty column)","LBL_ADD_EMPTY_COLUMN":"Add empty column","LBL_ADD_FILTER_GROUP":"Add filter group","LBL_FILTER_GROUP_AND":"All Of","LBL_FILTER_GROUP_OR":"Any Of","LBL_FILTER_GROUP_NOT":"None Of","LBL_FILTER_GROUP_NOT_AND":"Not All Of","LBL_FILTER_LAYOUT":"Layout","LBL_ADD_FILTERS":"Add Filters","LBL_ADD_COLUMNS":"Add Columns","LBL_ADD_SOURCES":"Add Sources","LBL_ADD_TOTALS":"Add Totals","LBL_SORT_ORDER":"Sort Order","LBL_ORDER":"Order","LBL_WIDTH":"Width","LBL_FIELD":"Field","LBL_DISPLAY":"Display","LBL_FORMAT":"Format","LBL_SORT":"Sort","LBL_REQUIRED":"Required","LBL_DEFAULT_VALUE":"Default Value","LBL_ASCENDING":"Ascending","LBL_DESCENDING":"Descending","LBL_ADD_SORTED":"Add Sorted Field","LBL_LAYOUT_NAME":"Layout Name","LBL_REPORT_NAME":"Report Name","LBL_LAYOUT_GROUP_PREFIX":"Group","LBL_LAYOUT_GENERAL":"General","LBL_LAYOUT_FILTERS":"Filters","LBL_LAYOUT_SORTING":"Sorting","LBL_SOURCES":"Sources","LBL_COLUMN_LAYOUT":"Column Layout","LBL_TOTALS_LAYOUT":"Column Totals","LBL_CHART_LAYOUT":"Chart Layout","LBL_REPORT_FIELDS":"Display Columns - ","LBL_GROUPED_FIELDS":"Grouped Columns - ","LBL_TOTALS_FIELDS":"Column Totals - ","LBL_MAKE_GROUPED":"Make Grouped","LBL_MAKE_UNGROUPED":"Make Ungrouped","LBL_VALIDATING":"Validating ...","LBL_SAVE_LAYOUT_BUTTON_LABEL":"Save Layout","LBL_EDIT_CUSTOM_FIELDS_BUTTON_LABEL":"Edit Custom Fields","LBL_DURATION_SUFFIX_HOUR":"h","LBL_DURATION_SUFFIX_MINUTE":"m","LBL_MONTH":"Month","LBL_DAY":"Day","LBL_YEAR":"Year","LBL_WEEK":"Week","LBL_PREVIOUS_MONTH":"Previous Month","LBL_PREVIOUS_DAY":"Previous Day","LBL_PREVIOUS_YEAR":"Previous Year","LBL_PREVIOUS_WEEK":"Previous Week","LBL_NEXT_MONTH":"Next Month","LBL_NEXT_DAY":"Next Day","LBL_NEXT_YEAR":"Next Year","LBL_NEXT_WEEK":"Next Week","LNK_SELECT_DATE":"Select Date","LBL_WEEK_COL_HEADER":"Week","LBL_TODAY_SUFFIX":" (today)","LBL_CALENDAR_TODAY":"Today","LBL_CHANGE_FIRST":"Display {NAME} first","LBL_BLANK":"","LBL_SEPARATOR":": ","LBL_MISSING_VALUE":"(blank)","LBL_UNDETERMINED_VALUE":"(undetermined)","LBL_LIST_TOTAL":"TOTAL","LBL_ADD_EXISTING":"Add Existing","LBL_NEW_RECORD_TITLE":"(new record)","LBL_SELECT_TEMPLATE_PROJECT":"Select Template Project","LBL_APPLICATION":"Application","LBL_DASHLET_LAYOUT":"Layout","LBL_DASHLET_FILTERS":"Filters","LBL_LE_CUSTOM":"Custom Fields","LBL_LE_STANDARD":"Standard Fields","LBL_REF_CUSTOM_ENTRY":"Custom Entry","LBL_REF_RENAME_ENTRY":"Rename Entry","LBL_REF_QUICK_CREATE_ENTRY":"Quick Create","LBL_REF_SEARCH_RESULTS":"Search Results","LBL_REF_RECENT_ENTRIES":"Last Viewed","LBL_REF_DETAILS":"Details","LBL_REF_PRESS_TO_SEARCH":"Press enter to see results","LBL_CHART_RENDER_ERROR":"An error occurred in rendering the chart, please check the chart parameters.","LBL_TYPE":"Type","LBL_VIEW_NOT_FOUND":"The specified view was not found.","LBL_ACCEPT_THIS":"Accept?","LBL_ADD_SELECTED_BUTTON_LABEL":"Add Selected","LBL_ADD_ALL_BUTTON_LABEL":"Add All","LBL_SKIP_BUTTON_LABEL":"Skip","LBL_LIST_RELATED_PREFIX":"Select from ","LBL_RESET_TO_DEFAULT":"Reset to Default","MSG_DUPLICATE":"Creating these record(s) may potentially create a duplicate record(s). You may either check Create checkbox (checked by default) to continue creating a new record(s) with the previously entered data or you may select a entry from the list below.","LBL_OR_SELECT":"OR Select Current","LBL_SEARCH_QUICK_VIEW":"Quick View","LBL_NEW_UPDATES_AVAILABLE":"New updates available!","LBL_CHANGES_WARNING":"Navigating away from this page will discard any changes. Are you sure?","LBL_ADD_TO_FAVORITES":"Add To Favorites","LBL_REMOVE_FROM_FAVORITES":"Remove From Favorites","LBL_HAS_ATTACH":"Has Attachment(s)","LBL_SHARED_WITH":"Shared with","LBL_ADD_TEAM":"Add Team","LBL_LIST_SHOW_MORE":"(show more)","LBL_LIST_SHOW_LESS":"(show less)","LBL_SKYPE_CALL":"Call","LBL_SKYPE_CHAT":"Chat","LBL_SKYPE_VIDEO":"Video Call","LBL_SIZE_UNKNOWN":"Unknown","LBL_OWNER_MULTIPLE_USERS":"Multiple users","LBL_LAYOUT_LOAD_ERROR":"An error occurred while loading the requested form layout.","LBL_VALIDATE_ERROR_INVALID_DATE":"Invalid Date Value","LBL_VALIDATE_ERROR_INVALID_TIME":"Invalid Time Value","LBL_VALIDATE_ERROR_INVALID_DATE_TIME":"Invalid Date\/Time Value","LBL_VALIDATE_ERROR_INVALID_INT":"Invalid Integer Value","LBL_VALIDATE_ERROR_INVALID_CURRENCY":"Invalid Currency Value","LBL_VALIDATE_ERROR_INVALID_FLOAT":"Invalid Floating Point Value","LBL_VALIDATE_ERROR_STRING_TOO_LONG":"Data Too Long","LBL_VALIDATE_ERROR_INVALID_VALUE":"Invalid value for field","LBL_VALIDATE_ERROR_MISSING_PRIMARY":"Missing primary key","LBL_VALIDATE_ERROR_PRIMARY_NOT_RETRIEVED":"Primary key was not fetched","LBL_VALIDATE_ERROR_NO_UPDATE_PRIMARY":"Primary key cannot be modified","LBL_VALIDATE_ERROR_MISSING_REQUIRED":"Missing value for required field","LBL_VALIDATE_ERROR_BEFORE_SAVE":"Record Cannot Be Saved","LBL_DESCRIPTION":"Description","LBL_UPLOADING":"Uploading file(s)...","LBL_IMAGE_FILE_URL":"Image File URL","LBL_IMAGE_FILE_UPLOAD":"Upload Image File","LBL_IMAGE_FILE_OR_UPLOAD":"or Upload Image File","LBL_AUTO_THUMBNAIL":"Automatically Create Thumbnail Image","LBL_THUMBNAIL":"Thumbnail","LBL_THUMBNAIL_FILENAME":"Thumbnail Filename","LBL_THUMBNAIL_SUPPORTED_FORMATS":"Supported Formats for Thumbnail Auto-creation","LBL_THUMBNAIL_UPLOAD_DESC":"Thumbnails can only be created from uploaded files, but not from images at external URLs","LBL_EDIT_IMAGE":"Edit Image","LBL_LIST_RESULTS":"List Results","LBL_ROWS_SHORT":"rows","LBL_PHOTO":"Photo","LBL_PHOTO_FILENAME":"Photo Filename","LBL_PHOTO_URL":"Photo URL","LBL_ACCEPT_BUTTON_LABEL":"Accept","LBL_OK_BUTTON_LABEL":"OK","LBL_OPEN_BUTTON_LABEL":"Open","LBL_IGNORE_BUTTON_LABEL":"Ignore","LBL_CUSTOM_OPTION":"Custom...","LBL_WEBLEAD_DATE_FORMAT":"Format: yyyy-mm-dd","LBL_WEBSITE":"Website","LBL_RINGCENTRAL_TITLE":"RingCentral","LBL_DUPE_FILE":"Keep original file","LBL_POSITION":"Position","LBL_SELECT_OTHER":"Select...","LBL_SHOW_ACTIONS":"Show Actions","LBL_WEEK_PREFIX":"W","LBL_REF_SELECT_MODULE":"Select Module","LBL_FILTER_SELECT_OPERATOR":"Select Operator","API_ERROR_UNUVAILABLE":"1CRM API is not available. The application must be upgraded to Pro or Enterprise edition","API_ERROR_NO_CREDENTIALS":"Authorization is required, but valid credentials were not provided","API_ERROR_WRONG_CREDENTIALS":"Wrong credentials","API_ERROR_INSECURE":"Requests over insecure connections are disabled","API_ERROR_FORBIDDEN":"Forbidden","API_ERROR_INTERNAL":"Internal server error","API_ERROR_NOT_ALLOWED":"Method not allowed","API_ERROR_NOT_FOUND":"Not found","API_ERROR_UNAUTHORIZED":"Authorization required","API_ERROR_NO_OPENSSL":"OpenSSL is not installed","OAUTH_LOGGED_IN_AS_PREFIX":"You are logged in as","OAUTH_LOGGED_IN_AS_SUFFIX":"","OAUTH_REQUESTING_PREFIX":"Application <b>&quot;","OAUTH_REQUESTING_SUFFIX":"&quot;<\/b> is requesting the following permissions:","OAUTH_BUTTON_ALLOW":"Allow","OAUTH_BUTTON_DENY":"Deny","OAUTH_BUTTON_LOGIN":"Log in","OAUTH_USERNAME":"User name","OAUTH_PASSWORD":"Password","OAUTH_REMEMBER_ME":"Remember me","OAUTH_WRONG_USERNAME":"Login failed, check your user name and password","LBL_RENAME_DETAIL_TAB":"Rename","LBL_ADD_DETAIL_TAB":"New Tab","LBL_LAYOUT_STANDARD":"General","LBL_ARRANGE_TABS":"Customize Tabs","LBL_EMPTY_STRING":"[empty string]","LBL_VALUE_ERASED":"Value Erased","LBL_PERSONAL_DATA":"Personal Data","LBL_ERASE_PERSONAL_BUTTON_LABEL":"Erase Personal Data","LBL_VIEW_PERSONAL_BUTTON_LABEL":"View Personal Data","LBL_PERSONAL_INFO_SOURCE":"Personal Information Source","LBL_MULTI_ADD_ITEMS":"Add Items","LBL_MULTI_REMOVE_ITEMS":"Remove Items","LBL_REF_ARTICLE_TITLE":"Article Name","LBL_REF_CATEGORY_TITLE":"Topic Name","LBL_MAPS_SEARCHING":"Searching addresses ...","LBL_MAPS_SEARCHING_PROGRESS":"Searching addresses (%1\/%2)","LBL_MAPS_SEARCHING_FAIL":"%1 of %2 addresses were not found","LBL_AUDIT_TEAMS_FIELD_LABEL":"Teams","LBL_STORAGE_USAGE_REPORT":"Storage Usage Report","LBL_STORAGE_TOTAL":"Total Storage","LBL_STORAGE_USED":"Storage Used","LBL_STORAGE_FREE":"Available Storage","LBL_STORAGE_REPORT_HEAD":"Storage Report","LBL_STORAGE_BY_TYPE":"Storage Usage Breakdown","LBL_STORAGE_BACKUPS":"Backups","LBL_STORAGE_EMAILS":"Emails","LBL_STORAGE_IMAGES":"Images","LBL_STORAGE_REPORTS":"Reports","LBL_STORAGE_UPLOADS":"Uploads","LBL_STORAGE_DB":"Database","LBL_STORAGE_USAGE_WARN":"STORAGE USAGE WARNING","LBL_STORAGE_WARN_PERC":"WARNING: Used Storage exceeded","LBL_STORAGE_WARN_GB":"WARNING: Available Storage is below","LBL_STORAGE_WARN_CLOUD":"WARNING: Cloud Storage Entitlement Exceeded for","LBL_TODAYS_DATE":"Today's Date"},"lists":{"keys":{"moduleListSingular":["Home","Dashboard","Contacts","Accounts","Opportunities","Cases","Notes","Calls","Emails","Meetings","Tasks","Calendar","Leads","Activities","ACLRoles","Bugs","Feeds","iFrames","Project","ProjectTask","Campaigns","Documents","Sync","Users","HR","Directory","MonthlyServices","ProductCatalog","Assets","EmailFolders","EmailTemplates","Resources","Quotes","ExpenseReports","Invoice","Payments","Reports","ReportData","Administration","Timesheets","Vacations","Assemblies","SupportedAssemblies","EmailMarketing","ProspectLists","Prospects","SerialNumbers","SubContracts","ContractTypes","TaxRates","TaxCodes","Discounts","ShippingProviders","PurchaseOrders","SalesOrders","Shipping","Receiving","CampaignLog","Forums","Threads","Posts","ForumTopics","PrepaidAmounts","ProductAttributes","SecurityGroups","Roles","Booking","BookingCategories","EventSessions","EventTypes","CompanyAddress","CampaignTrackers","KBArticles","ACLActions","ActivityLog","Audit","Bills","BookableObjects","Charts","CreditNotes","Currencies","DocumentRevisions","EventReminders","Events","LicenseInfo","Models","PDFTemplates","Partners","PaymentsOut","PriceBooks","ProductCategories","ProductTypes","Releases","Skills","SocialAccounts","SoftwareProducts","SystemMessages","Versions","Workflow","vCals"],"account_type_dom":["Analyst","Competitor","Customer","Investor","Partner","Press","Prospect","Supplier","Manufacturer","Other"],"industry_dom":["Apparel","Banking","Biotechnology","Chemicals","Communications","Construction","Consulting","Education","Electronics","Energy","Engineering","Entertainment","Environmental","Finance","Government","Healthcare","Hospitality","Insurance","Machinery","Manufacturing","Media","Not For Profit","Recreation","Retail","Shipping","Technology","Telecommunications","Transportation","Utilities","Other"],"lead_source_dom":["Cold Call","Existing Customer","Self Generated","Employee","Partner","Public Relations","Direct Mail","Conference","Trade Show","Web Site","Customer Portal","Word of mouth","Email","Other","Subscription"],"opportunity_type_dom":["Existing Business","New Business"],"roi_type_dom":["Budget","Investment","Expected_Revenue","Weighted_Revenue","Revenue"],"sales_stage_dom":["Prospecting","Qualification","Needs Analysis","Value Proposition","Id. Decision Makers","Perception Analysis","Proposal\/Price Quote","Negotiation\/Review","Awaiting Paperwork","Closed Won","Closed Lost"],"sales_probability_dom":["Prospecting","Qualification","Needs Analysis","Value Proposition","Id. Decision Makers","Perception Analysis","Proposal\/Price Quote","Negotiation\/Review","Awaiting Paperwork","Closed Won","Closed Lost"],"activity_dom":["Call","Meeting","Task","Email","Note"],"salutation_dom":["Mr.","Ms.","Mrs.","Dr.","Prof."],"reminder_time_options":["-1","60","300","600","900","1800","3600","7200","14400","28800","86400"],"chat_status_dom":["In Progress","Finished"],"task_status_dom":["Not Started","In Progress","Completed","Pending Input","Deferred"],"meeting_status_dom":["Planned","Held","Not Held"],"meeting_booking_status_dom":["Pending","Approved"],"call_status_dom":["Planned","Held","Not Held"],"call_direction_dom":["Inbound","Outbound"],"invitees_filter_dom":["all","mine","accepted","not_accepted","not_invited"],"lead_status_dom":["New","Assigned","In Process","Converted","Recycled","Dead"],"case_status_dom":["Active - New","Active - Assigned","Pending","Closed - Complete","Closed - No Fault","Closed - Expired"],"case_priority_dom":["P1","P2","P3"],"user_status_dom":["Active","Inactive","Info Only"],"employee_status_dom":["Active","Terminated","Leave of Absence"],"project_task_status_options":["Not Started","In Progress","Completed","Pending Input","Deferred"],"quote_stage_dom":["Draft","Negotiation","Delivered","On Hold","Confirmed","Closed Accepted","Closed Lost","Closed Dead"],"bug_resolution_dom":["Accepted","Duplicate","Fixed","Out of Date","Invalid","Later"],"bug_status_dom":["New","Assigned","Closed","Pending","Rejected"],"bug_type_dom":["Defect","Feature"],"source_dom":["Internal","Forum","Web","Email"],"product_category_dom":["Accounts","Activities","Bug Tracker","Calendar","Calls","Campaigns","Cases","Contacts","Currencies","Dashboard","Documents","Emails","Feeds","Forecasts","Help","Home","Leads","Meetings","Notes","Opportunities","Outlook Plugin","Product Catalog","Products","Projects","Quotes","Releases","SoftwareProducts","RSS","Studio","Upgrade","Users"],"campaign_status_dom":["Planning","Active","Inactive","Complete","In Queue","Sending"],"campaign_type_dom":["Telesales","Mail","Email","Dripfeed","Print","Web","Radio","Television","NewsLetter"],"newsletter_frequency_dom":["Weekly","Monthly","Quarterly","Annually"],"notifymail_sendtype":["sendmail","SMTP"],"dom_email_types":["received","sent","out","send_error","archived","draft","inbound"],"dom_email_status":["archived","closed","draft","read","replied","sent","send_error","unread","received"],"dom_smtp_ssl_verify":["none","selfsigned",""],"dom_email_server_type":["IMAP","POP3"],"dom_mailbox_type":["bug","support","bounce"],"dom_email_distribution":["direct","roundRobin","leastBusy"],"dom_int_bool":["1","0"],"dom_email_link_type":["","sugar","mailto"],"dom_email_link_type_system":["sugar","mailto"],"dom_email_editor_option":["","html","plain"],"schedulers_times_dom":["not run","ready","in progress","failed","completed","no curl"],"forecast_type_dom":["personal","team_individual","team_rollup"],"document_category_dom":["Marketing","Knowledge Base","Sales"],"document_subcategory_dom":["Marketing Collateral","Product Brochures","FAQ"],"document_status_dom":["Draft","To Be Approved","Approved","Archived"],"document_template_type_dom":["mailmerge","eula","nda","license"],"dom_meeting_accept_status":["accept","decline","tentative","none"],"prospect_list_type_dom":["default","seed","exempt_domain","exempt_address","exempt","test"],"email_marketing_status_dom":["active","inactive"],"dripfeed_delay_unit_dom":["days","months"],"campainglog_activity_type_dom":["targeted","viewed","link","lead","contact","invalid email","send error","removed","optin"],"merge_operators_dom":["like","exact","start"],"custom_fields_merge_dup_dom":["0","1"],"navigation_paradigms":["m","gm"],"mobile_calls_type_dom":["","tel"],"reportModuleList":["EventSessions"],"resource_type_dom":["Television","DVD","VCR","Projector","Projection Screen","Notebook PC","Desktop PC","Conference Phone","Telephone Bridge","Meeting Room","Booking Appointment"],"task_priority_dom":["P2","P1","P0"],"project_task_priority_options":["P2","P1","P0"],"project_task_dependency_type":["FTS","STS","FTF"],"bug_priority_dom":["P3","P2","P1","P0"],"expense_report_status_dom":["In Preparation","Submitted","Approved","Rejected","Paid"],"personal_auto_units_dom":["km","miles"],"service_frequency_dom":["monthly","quarterly","biquarterly","annually"],"project_type_dom":["Bid Development","Internal R&D","Services Delivery","Sub-Contract"],"project_status_dom":["Active - Starting Soon","Active - In Progress","Closed - Complete","Closed - Not Pursued","Closed - Terminated"],"task_effort_unit_dom":["minutes","hours","days"],"departments_dom":["Administration","Corporate Office","Customer Service","Finance","Human Resources","Manufacturing","Marketing","MIS","R&D","Sales","Shipping\/Receiving"],"sex_dom":["m","f"],"salary_period_dom":["per hour","per day","per week","per month","per year"],"education_dom":["High School","Technical College","Bachelor","Masters","Doctorate"],"dep_relationship_dom":["Husband","Wife","Son","Daughter","Father","Mother","Sibling","Other Family","Other"],"asset_tax_class_dom":["yes","no"],"prod_price_formula_dom":["Fixed Price","Profit Margin","Markup Over Cost","Discount from List","Same As List"],"prod_support_price_formula_dom":["Fixed Price","Profit Margin","Markup Over Cost","Discount from List","Same As List","Percent of Selling Price"],"yes_no_dom":["yes","no"],"email_isread_dom":["1","0"],"contract_status_dom":["yes","no"],"contact_category_dom":["Business","Company Staff","Customers","Friends and Family","Partners","Personal Services","Press and Analysts","Professional Advisors","Restaurants","Suppliers"],"contact_business_role_dom":["CEO","MIS","CFO","Sales","Admin"],"terms_dom":["COD","Due on Receipt","Net 7 Days","Net 15 Days","Net 30 Days","Net 45 Days","Net 60 Days"],"quote_show_components_dom":["names","all"],"quote_approval_status":["Submitted","Approved","Not Approved"],"so_stage_dom":["Ordered","In Manufacturing","Partially Shipped and Invoiced","Partially Shipped and not Invoiced","Shipped and not Invoiced","Closed - Shipped and Invoiced"],"po_status_dom":["Draft","Ordered","Partially Received","Received"],"receiving_status_dom":["Pending","Partially Received","Received"],"shipping_status_dom":["In Preparation","Shipped"],"shipping_stage_dom":["None","Pending","Partially Shipped","Shipped","Delivered"],"timesheet_period_dom":["1","2","3","4"],"timesheet_offset_dom":["-1","0","1"],"timesheet_status_dom":["draft","submitted","approved","rejected"],"standard_custom_dom":["0","1"],"report_run_method_dom":["manual","interactive","scheduled"],"interval_units_dom":["seconds","minutes","hours","days","busdays","weeks","months","quarters","fiscalquarters","years","fiscalyears"],"interval_unit_dom":["seconds","minutes","hours","days","busdays","weeks","months","quarters","fiscalquarters","years","fiscalyears"],"payment_type_dom":["Cash","Check","Wire Transfer","Money Order","Bank Draft","PayPal","Western Union","Credit Card","Credit Note","ChargeBee","Stripe"],"payment_direction_dom":["incoming","outgoing","credit","refund"],"payment_fee_type_dom":["bank","conversion","processing"],"simple_status_dom":["Active","Inactive"],"paper_size_dom":["A3","A4","B4","B5","Letter","Legal"],"serial_number_item_dom":["System","OS","Firmware"],"report_notify_format_dom":["html","pdf","csv","tsv","scsv","link"],"license_type_dom":["initial","extension","renewal","trial","hosted"],"license_product_dom":["infoathand","quickbooks","portal","previews","designer","enterprise","startup","startup_plus","wordpress_portal"],"case_category_dom":["Documentation","Office Supplies","PC Hardware","Server Hardware","Networking","Client Software","Server Software","User Training","Website"],"case_type_dom":["Internal Development","Internal Maintenance","Internal Support","Internal Training","Contract Development","Contract Maintenance","Contract Support","Contract Training"],"case_search_what_dom":["any","all","exact"],"search_what_dom":["all","subject","text"],"forecast_category_dom":["Actual","Omitted","Pipeline","Best Case","Commit","Closed"],"sales_forecast_dom":["Closed Won","Closed Lost","Prospecting","Qualification","Needs Analysis","Value Proposition","Id. Decision Makers","Perception Analysis","Proposal\/Price Quote","Negotiation\/Review","Awaiting Paperwork"],"forecast_period_dom":["Monthly","Quarterly"],"tax_compounding_dom":["compounded"],"taxation_scheme_dom":["tax","nontax","list"],"discount_type_dom":["percentage","fixed"],"discount_applies_dom":["0","1"],"assembly_discount_type_dom":["std","percentage","fixed"],"quote_group_type_dom":["products","support","service","expenses"],"quote_pricing_method_dom":["fixed","margin","markup","discount","stddiscount","list",""],"quote_pricing_method_short_dom":["fixed","","margin","markup","discount","premium","list"],"price_adjustment_type_dom":["StandardTax","CompoundedTax","TaxedShipping","UntaxedShipping","StandardDiscount"],"quotation_modes":["","catalog_only","standard_prices"],"project_modes":[""],"email_reminder_time_options":["900","1800","3600","7200","10800","21600","86400"],"booked_hours_status_dom":["draft","pending","submitted","approved","rejected"],"booked_hours_related_dom":["Cases","ProjectTask"],"booked_hours_billing_status_dom":["billed","notbilled"],"booking_classes_dom":["billable-work","nonbill-work","expenses","services-monthly"],"expense_units_short_dom":["day","month","year","km","mi","L","gal","unit"],"expense_units_dom":["day","month","year","km","mi","L","gal","unit"],"address_format_names_dom":["Britain","France","Germany","Japan","Switzerland"],"business_model_dom":["B2B","B2C"],"event_format_dom":["Teleseminar","Seminar","Program","Live Event","Material"],"event_color_dom":["red","green","blue","magenta","cyan","brown","violet","chocolate","crimson","firebrick","fuchsia","indigo","orangered","yellowgreen"],"placement_dom":["all","tab","shortcut"],"iframe_type_dom":["personal","global"],"temperature_dom":["Smoking","Hot","Warm","Cold"],"quote_add_comment_options":["","products","assemblies","all"],"track_inventory_dom":["untracked","manual","semiauto"],"booking_location_dom":["onsite","offsite"],"booking_seniority_dom":["junior","intermediate","senior"],"booking_duration_dom":["hour","day"],"leave_status_dom":["planned","approved","not_approved","cancelled","days_taken"],"leave_type_dom":["vacation","sick"],"country_codes":["AF","AX","AL","DZ","AS","AD","AO","AI","AQ","AG","AR","AM","AW","AU","AT","AZ","BS","BH","BD","BB","BY","BE","BZ","BJ","BM","BT","BO","BQ","BA","BW","BV","BR","IO","BN","BG","BF","BI","KH","CM","CA","CV","KY","CF","TD","CL","CN","CX","CC","CO","KM","CG","CD","CK","CR","HR","CU","CW","CY","CZ","CI","DK","DJ","DM","DO","EC","EG","SV","GQ","ER","EE","ET","FK","FO","FJ","FI","FR","GF","PF","TF","GA","GM","GE","DE","GH","GI","GR","GL","GD","GP","GU","GT","GG","GN","GW","GY","HT","HM","HN","HK","HU","IS","IN","ID","IR","IQ","IE","IM","IL","IT","JM","JP","JE","JO","KZ","KE","KI","KW","KG","LA","LV","LB","LS","LR","LY","LI","LT","LU","MO","MK","MG","MW","MY","MV","ML","MT","MH","MQ","MR","MU","YT","MX","FM","MD","MC","MN","ME","MS","MA","MZ","MM","NA","NR","NP","NL","NC","NZ","NI","NE","NG","NU","NF","KP","MP","NO","OM","PK","PW","PS","PA","PG","PY","PE","PH","PN","PL","PT","PR","QA","RO","RU","RW","RE","BL","SH","KN","LC","MF","PM","VC","WS","SM","ST","SA","SN","RS","SC","SL","SG","SX","SK","SI","SB","SO","ZA","GS","KR","SS","ES","LK","SD","SR","SJ","SZ","SE","CH","SY","TW","TJ","TZ","TH","TL","TG","TK","TO","TT","TN","TR","TM","TC","TV","UG","UA","AE","GB","US","UM","UY","UZ","VU","VA","VE","VN","VG","VI","WF","EH","YE","ZM","ZW"],"debit_credit_dom":["debit","credit"],"envelope_window_position_dom":["left","right"],"relative_time_dom":["yesterday","yesterday_time","today","today_time","tomorrow","tomorrow_time","weekday","weekday_time","moments_ago","n_second_ago","n_seconds_ago","n_minute_ago","n_minutes_ago","n_hour_ago","n_hours_ago","n_days_ago","n_days_ago_time","date_time","now"],"google_contacts_sync_dom":["","to_iah","to_google","both"],"google_calendar_sync_dom":["","to_iah","to_google","both"],"google_docs_sync_dom":["","to_iah","to_google","both"],"email_import_since_dom":["prev_n_days","prev_n_months","prev_n_years","all"],"module_types_dom":["theme","langpack","module","patch","holidays","pers_pack"],"user_activity_tracker_dom":["off","session","modules","records"],"log_level_dom":["debug","info","warn","error","fatal","off"],"log_clear_activities_interval_dom":["30","60","90","120"],"dashboard_position_dom":["0","10"],"expense_report_type_dom":["Customer","Marketing","Sales","Support","Executive"],"date_filter_operators_dom":["","before_date","after_date","on_date","not_on_date","between_dates","empty","not_empty","yesterday","today","tomorrow","period_prev","period_current","period_next","month","year","fiscal_year"],"date_filter_period_dom":["week","month","quarter","year","fiscal_quarter","fiscal_year","days_7","days_14","days_30","days_60","days_90","days_180"],"date_range_operators_dom":["any","date","not_date","between","from","from_field","before","after","before_pfx","after_pfx","empty","not_empty","month","year","fiscalyear","to","to_field","to_offset","to_start","to_end","offset","within","start","end","previous","next","current","this","offset_custom","to_offset_custom","range","plus","minus","not","start_pfx","end_pfx","within_pfx","from_pfx"],"date_range_embed_dom":["start","end","previous","next","current","this","plus","minus","before","after","not","within","from","to","of"],"number_filter_operators_dom":["","eq","lt","gt","not_eq","gte","lte","between","empty","not_empty"],"text_filter_operators_dom":["","eq","like","prefix","suffix","not_like","not_eq","empty","not_empty"],"select_filter_operators_dom":["","eq","any_of","not_eq","not_any_of","empty","not_empty"],"field_type_dom":["id","name","person_name","user_display_name","enum","date","datetime","time","duration","multienum","ref","char","varchar","text","bool","int","number","float","double","currency","base_currency","raw_currency","percentage","rate_percent","email","phone","extension_number","fax","skype","url","module_name","address","location_city","html","widget","calculated","reminder","item_number","sequence_number","sequence_prefix","status_color","image","file_size","file_ref","star_rating","progress","status","flag","email_recips","color","blob"],"field_format_dom":["none","date_only","time_only","month","qtr","year","yearmonth","fqtr","fy","full_name","rounded","thousands","millions","days_past","days_future","hours","minutes"],"multi_update_mode_dom":["","add","remove","replace"],"total_type_dom":["count","sum","min","max","avg","stddev"],"total_type_short_dom":["count","sum","min","max","avg","stddev"],"chart_type_dom":["","hbar","vbar","pie","line","area"],"weekdays_dom":["0","1","2","3","4","5","6"],"weekdays_long_dom":["0","1","2","3","4","5","6"],"months_dom":["0","1","2","3","4","5","6","7","8","9","10","11","12"],"months_long_dom":["0","1","2","3","4","5","6","7","8","9","10","11","12"],"source_display_dom":["primary","joined","nested"],"workflow_execute_mode_dom":["newRecordOnly","existingRecordOnly","newRecordAndExisting"],"workflow_occurs_dom":["saved","time"],"workflow_trigger_dom":["saved","deleted"],"workflow_execute_dom":["trigger","admin","owner"],"workflow_status_dom":["inactive","active"],"reassign_accounts_dom":["Contacts","Activities","History","Quotes","Invoices","Opportunities","Cases"],"reassign_leads_dom":["Activities","History"],"telephony_integration_dom":["","skypeout","ringcentral","tel"],"chat_integration_dom":["livechat"],"backup_filter_options_dom":["none","minimal","maximal","complete"],"activity_log_status_dom":["assigned","invited","reminder","created","moved","closed","reopened","cancelled","won","lost","converted","expired","expire_warn","overdue","report","submitted","approved","rejected","thread_reply"],"dashlet_auto_refresh_dom":["0","5","10","15","20","30"],"shared_with_dom":["","all","teams"],"smtp_security_dom":["","ssl","tls"],"download_status_dom":["init","headers","connect","in_progress","complete","failed","timeout"],"remote_backup_type_dom":["","ftp","ssh","dropbox"],"page_orientation_dom":["portrait","landscape"],"partner_type_dom":["Referral","Sales Only","Full Service","Multi-Level"],"email_folder_types":["1","2","3","4","5","6"],"custom_checkbox_dependent":["","1","0"],"paid_status_dom":["due","overdue","paid","cancelled"],"opp_active_dom":["neutral","active","pending","won","lost"],"request_method_dom":["get","post","post_json"],"record_action_status_dom":["scheduled","pending","progress","complete","canceled","failed"],"record_action_source_dom":["manual","workflow"],"apns_notification_mode_dom":["immediate","scheduled"],"dropzone_messages":["dictDefaultMessage","dictFallbackMessage","dictFallbackText","dictFileTooBig","dictInvalidFileType","dictResponseError","dictCancelUpload","dictCancelUploadConfirmation","dictRemoveFile","dictMaxFilesExceeded"],"filter_properties_dom":["min","max","value","prefix","suffix"],"data_privacy_type_dom":["erase","consent","withdraw","view"],"data_privacy_status_dom":["open","processing","closed"],"storageutil_notifytype_dom":["GB","Percentage"],"storageutil_autoreport_dom":["Daily","Weekly","Monthly"],"option_type_dom":["varchar","enum","multienum","file_ref","bool","number","int","phone","email","url","currency","date","datetime","html"],"livechatinc_operator_status_dom":["offline","accepting chats","not accepting chats"],"livechat_match_mode_dom":["Both","Leads","Contacts"],"livechat_create_mode_dom":["Leads","Contacts"],"subscription_cycle_dom":["single","week","month","year"],"subscription_status_dom":["draft","active","in_trial","non_renewing","paused","cancelled"],"oauth_scopes_dom":["read","write","profile"],"oauth_scopes_desc_dom":["read","write","profile"],"oauth_grant_type_dom":["client_credentials","password","implicit","authorization_code"],"moduleList":["Notes","History","Contacts","Audit","Dashboard","LayoutTest","TaxCodes","SerialNumbers","Charts","Assets","EventReminders","CustomerLevels","Recurrence","WooCommerce","OptimisticLock","Feeds","Partners","Forums","Payments","Favorites","ForumTopics","PDFTemplates","LiveChatInc","HR","ProductAttributes","PriceBooks","SupportedAssemblies","Events","BookingCategories","CampaignLog","KBArticles","CampaignTrackers","Calls","Configurator","Users","EmailTemplates","Vacations","ActivityLog","ReportData","ProjectTask","Workflow","Commissions","ProductCategories","EventTypes","Subscriptions","Invoice","Bugs","RecordActions","KBCategories","Cases","Models","Shipping","EmailMan","Booking","ProductCatalog","PrepaidAmounts","vCals","SystemMessages","PDFPrint","LeadGuerrilla","PurchaseOrders","SubscriptionOptions","ACLRoles","ProspectLists","Documents","Prospects","UWizard","Calendar","SubContracts","DynFields","SecurityGroups","Assemblies","PaymentsOut","SubscriptionAddons","Accounts","Leads","ImportDB","ACL","DataPrivacy","BookableObjects","ModuleDesigner","Emails","Timesheets","SocialAccounts","EmailMarketing","SalesOrders","NewStudio","DocumentRevisions","SoftwareProducts","Receiving","Forecasts","Administration","ProductTypes","EmailTrackers","Directory","CreditNotes","APIClients","EmailPOP3","Project","ContractTypes","Reports","SubscriptionPlans","Discounts","EventsCustomers","UserPreferences","CompanyAddress","Campaigns","Home","EmailFolders","Quotes","Threads","SubscriptionCoupons","Bills","PaymentProcessors","Versions","ShippingProviders","TaxRates","Meetings","Tasks","EventSessions","LicenseInfo","Relationships","Chats","MailMerge","Notify","Posts","Webhooks","Invitees","MonthlyServices","MergeRecords","Releases","Skills","ExpenseReports","SavedSearch","Opportunities","Scheduler","Activities","EmailRecipients","Currencies","Resources","ACLActions"],"report_run_interval_unit_dom":["hours","days","weeks","months","quarters","years"],"schedule_run_interval_unit_dom":["minutes","hours","days","weeks","months","quarters","years"],"document_filetype_dom":["Acrobat PDF","Audio","Compressed","HTML","Image","Spreadsheet","Presentation","Project","Chart","Document","Text","Video"],"activity_status_dom":["Not Started","In Progress","Completed","Pending Input","Deferred","Planned","Held","Not Held","archived","closed","draft","read","replied","sent","send_error","unread","received","Notes"],"pdf_font_names_dom":["freesans","freeserif","freemono","vera","verase","veramo","courier","helvetica","times","msungstdlight","stsongstdlight","hysmyeongjostdmedium","kozminproregular","kozgopromedium","almohanad"]},"values":{"moduleListSingular":["Today","Dashboard","Contact","Account","Opportunity","Case","Note","Call","Email","Meeting","Task","Calendar","Lead","Activity","ACL Role","Software Bug","News Feed","Website","Project","Project Task","Campaign","Document","Sync","User","Human Resource","Employee","Recurring Service","Product","Supported Product","Email Folder","Email Template","Resource","Quote","Expense Report","Invoice","Payment","Report","Report","Administration","Timesheet","Leave","Assembly","Supported Assembly","Email Marketing","Target List","Target","Serial Number","Service Subcontract","Svc. Contract Type","Tax Rate","Tax Code","Discount","Shipping Provider","Purchase Order","Sales Order","Shipping","Receiving","Campaign Log","Forum","Thread","Post","Forum Category","Prepaid Amount","Product Attribute","Team","Role","Booked Hours","Booking Category","Event","Event Type","Company Address","Campaign Tracker","KB Article","ACL Action","Activity Log","Audit","Bill","Bookable Object","Chart","Credit Note","Currency","Document Revision","Event Reminder","Event","License Info","Model","PDF Form","Partner","Outgoing Payments","Price Book","Product Category","Product Type","Release","Skill","Social Account","Software Product","System Message","Version","Workflow","vCal"],"account_type_dom":["Analyst","Competitor","Customer","Investor","Partner","Press","Target","Supplier","Manufacturer","Other"],"industry_dom":["Apparel","Banking","Biotechnology","Chemicals","Communications","Construction","Consulting","Education","Electronics","Energy","Engineering","Entertainment","Environmental","Finance","Government","Healthcare","Hospitality","Insurance","Machinery","Manufacturing","Media","Not For Profit","Recreation","Retail","Shipping","Technology","Telecommunications","Transportation","Utilities","Other"],"lead_source_dom":["Cold Call","Existing Customer","Self Generated","Employee","Partner","Public Relations","Direct Mail","Conference","Trade Show","Web Site","Customer Portal","Word of mouth","Email","Other","Subscription"],"opportunity_type_dom":["Existing Business","New Business"],"roi_type_dom":["Budget","Investment","Expected Revenue","Weighted Revenue","Actual Revenue"],"sales_stage_dom":["Prospecting","Qualification","Needs Analysis","Value Proposition","Id. Decision Makers","Perception Analysis","Proposal\/Price Quote","Negotiation\/Review","Awaiting Paperwork","Closed Won","Closed Lost"],"sales_probability_dom":[10,20,25,30,40,50,65,80,90,100,0],"activity_dom":["Call","Meeting","Task","Email","Note"],"salutation_dom":["Mr.","Ms.","Mrs.","Dr.","Prof."],"reminder_time_options":["No reminder","1 minute prior","5 minutes prior","10 minutes prior","15 minutes prior","30 minutes prior","1 hour prior","2 hours prior","4 hours prior","8 hours prior","1 day prior"],"chat_status_dom":["In Progress","Finished"],"task_status_dom":["Not Started","In Progress","Completed","Pending Input","Deferred"],"meeting_status_dom":["Planned","Held","Not Held"],"meeting_booking_status_dom":["Pending","Approved"],"call_status_dom":["Planned","Held","Not Held"],"call_direction_dom":["Inbound","Outbound"],"invitees_filter_dom":["Any Invitees","Invited To","Accepted Invite","Pending","Not Invited"],"lead_status_dom":["New","Assigned","In Process","Converted","Recycled","Dead"],"case_status_dom":["New","Assigned","Pending","Complete","No Fault","Expired"],"case_priority_dom":["High","Medium","Low"],"user_status_dom":["Active","Inactive","Info Only"],"employee_status_dom":["Active","Terminated","Leave of Absence"],"project_task_status_options":["Not Started","In Progress","Completed","Pending Input","Deferred"],"quote_stage_dom":["Draft","Negotiation","Delivered","On Hold","Confirmed","Closed Accepted","Closed Lost","Closed Dead"],"bug_resolution_dom":["Accepted","Duplicate","Fixed","Out of Date","Invalid","Later"],"bug_status_dom":["New","Assigned","Closed","Pending","Rejected"],"bug_type_dom":["Defect","Feature"],"source_dom":["Internal","Forum","Web","Email"],"product_category_dom":["Accounts","Activities","Bug Tracker","Calendar","Calls","Campaigns","Cases","Contacts","Currencies","Dashboard","Documents","Emails","Feeds","Forecasts","Help","Home","Leads","Meetings","Notes","Opportunities","Outlook Plugin","Product Catalog","Products","Projects","Quotes","Releases","Software Products","RSS","Studio","Upgrade","Users"],"campaign_status_dom":["Planning","Active","Inactive","Complete","In Queue","Sending"],"campaign_type_dom":["Telesales","Mail","Email","Drip-Feed Email","Print","Web","Radio","Television","Newsletter"],"newsletter_frequency_dom":["Weekly","Monthly","Quarterly","Annually"],"notifymail_sendtype":["sendmail","SMTP"],"dom_email_types":["Received","Sent","Sent","Send Error","Archived","Draft","Inbound"],"dom_email_status":["Archived","Closed","Draft","Read","Replied","Sent","Send Error","Unread","Received"],"dom_smtp_ssl_verify":["None","Self-Signed OK","Require 3rd Party"],"dom_email_server_type":["IMAP","POP3"],"dom_mailbox_type":["Create Bug","Create Case","Bounce Handling"],"dom_email_distribution":["Direct Assign","Round-Robin","Least-Busy"],"dom_int_bool":["Yes","No"],"dom_email_link_type":["System Default Mail Client","1CRM Mail Client","External Mail Client"],"dom_email_link_type_system":["1CRM Mail Client","External Mail Client"],"dom_email_editor_option":["Default Email Format","HTML Email","Plain Text Email"],"schedulers_times_dom":["Past Run Time, Not Executed","Ready","In Progress","Failed","Completed","Not Run: No cURL available"],"forecast_type_dom":["Personal Forecast","Team Individual Forecast","Team Roll-Up Forecast"],"document_category_dom":["Marketing","Knowledge Base","Sales"],"document_subcategory_dom":["Marketing Collateral","Product Brochures","FAQ"],"document_status_dom":["Draft","To Be Approved","Approved","Archived"],"document_template_type_dom":["Mail Merge","EULA","NDA","License Agreement"],"dom_meeting_accept_status":["Accepted","Declined","Tentative","None"],"prospect_list_type_dom":["Default","Seed","Suppression List - By Domain","Suppression List - By Email Address","Suppression List - By Id","Test"],"email_marketing_status_dom":["Active","Inactive"],"dripfeed_delay_unit_dom":["Days","Months"],"campainglog_activity_type_dom":["Message Sent\/Attempted","Viewed Message","Click-thru Link","Leads Created","Contacts Created","Bounced Messages, Invalid Email","Bounced Messages, Other","Opted Out","Opted In"],"merge_operators_dom":["Contains","Exactly","Starts With"],"custom_fields_merge_dup_dom":["Disabled","Enabled"],"navigation_paradigms":["Modules","Grouped Modules"],"mobile_calls_type_dom":["Use the global preference","Use the built-in phone"],"reportModuleList":["Marketing Event Sessions"],"resource_type_dom":["Television","DVD","VCR","Projector","Projection Screen","Notebook PC","Desktop PC","Conference Phone","Telephone Bridge","Meeting Room","Booking Appointment"],"task_priority_dom":["High","Medium","Low"],"project_task_priority_options":["High","Medium","Low"],"project_task_dependency_type":["Finish To Start","Start To Start","Finish To Finish"],"bug_priority_dom":["Urgent","High","Medium","Low"],"expense_report_status_dom":["In Preparation","Submitted","Approved","Rejected","Paid"],"personal_auto_units_dom":["km","miles"],"service_frequency_dom":["Monthly","Quarterly","Semi-Annually","Annually"],"project_type_dom":["Bid Development","Internal R&D","Services Delivery","Sub-Contract"],"project_status_dom":["Starting Soon","In Progress","Complete","Not Pursued","Terminated"],"task_effort_unit_dom":["minutes","hours","days"],"departments_dom":["Administration","Corporate Office","Customer Service","Finance","Human Resources","Manufacturing","Marketing","MIS","R&D","Sales","Shipping\/Receiving"],"sex_dom":["Male","Female"],"salary_period_dom":["per hour","per day","per week","per month","per year"],"education_dom":["High School Diploma","Technical College Diploma","Bachelor's Degree","Masters Degree","Doctorate"],"dep_relationship_dom":["Husband","Wife","Son","Daughter","Father","Mother","Sibling","Other Family","Other"],"asset_tax_class_dom":["Taxable","Non-taxable"],"prod_price_formula_dom":["Editable Price","Profit Margin","Markup Over Cost","Discount from List","Same As List"],"prod_support_price_formula_dom":["Editable Price","Profit Margin","Markup Over Cost","Discount from List","Same As List","Percent of Selling Price"],"yes_no_dom":["Yes","No"],"email_isread_dom":["Read","Unread"],"contract_status_dom":["Active","Inactive"],"contact_category_dom":["Business","Company Staff","Customers","Friends & Family","Partners","Personal Services","Press & Analysts","Professional Advisors","Restaurants","Suppliers"],"contact_business_role_dom":["CEO","MIS","CFO","Sales","Admin"],"terms_dom":["COD","Due on Receipt","Net 7 Days","Net 15 Days","Net 30 Days","Net 45 Days","Net 60 Days"],"quote_show_components_dom":["Details","Details & Prices"],"quote_approval_status":["Submitted","Approved","Not Approved"],"so_stage_dom":["Ordered","In Manufacturing","Partially Shipped & Invoiced","Partially Shipped, not Invoiced","Shipped, not Invoiced","Closed - Shipped & Invoiced"],"po_status_dom":["Draft","Ordered","Partial Shipment","Received"],"receiving_status_dom":["Pending","Partial Shipment","Received"],"shipping_status_dom":["In Preparation","Shipped"],"shipping_stage_dom":["No Shipment","Pending Shipment","Partially Shipped","Shipped","Delivered"],"timesheet_period_dom":["Weekly","Bi-Weekly","Semi-Monthly","Monthly"],"timesheet_offset_dom":[-1,0,1],"timesheet_status_dom":["Draft","Submitted","Approved","Rejected"],"standard_custom_dom":["Standard","Custom"],"report_run_method_dom":["Manual","Interactive","Scheduled"],"interval_units_dom":["seconds","minutes","hours","days","business days","weeks","months","quarters","fiscal quarters","years","fiscal years"],"interval_unit_dom":["second","minute","hour","day","business day","week","month","quarter","fiscal quarter","year","fiscal year"],"payment_type_dom":["Cash","Check","Wire Transfer","Money Order","Bank Draft","PayPal","Western Union","Credit Card","Credit Note","ChargeBee","Stripe"],"payment_direction_dom":["Invoice Payment","Bill Payment","Apply Credit","Refund Credit"],"payment_fee_type_dom":["Bank Charge","Conversion Loss","Processing Fee"],"simple_status_dom":["Active","Inactive"],"paper_size_dom":["A3","A4","B4","B5","Letter","Legal"],"serial_number_item_dom":["System","O\/S Version","Firmware Revision"],"report_notify_format_dom":["HTML","PDF","CSV","TSV","SCSV","Link Only"],"license_type_dom":["Initial","Extension","Renewal","Trial","Hosted"],"license_product_dom":["1CRM Professional Edition","Finance (QB)","Portal","1CRM Previews","Module Designer","1CRM Enterprise Edition","1CRM Startup Edition","1CRM Startup+ Edition","Customer Connection for WordPress"],"case_category_dom":["Documentation","Office Supplies","PC Hardware","Server Hardware","Networking","Client Software","Server Software","User Training","Website"],"case_type_dom":["Internal Development","Internal Maintenance","Internal Support","Internal Training","Contract Development","Contract Maintenance","Contract Support","Contract Training"],"case_search_what_dom":["any word","all words","exact match"],"search_what_dom":["All","Subject","Text"],"forecast_category_dom":["Actual","Omitted","Pipeline","Best Case","Commit","Closed"],"sales_forecast_dom":["Actual","Omitted","Pipeline","Pipeline","Pipeline","Pipeline","Pipeline","Best Case","Best Case","Commit","Commit"],"forecast_period_dom":["Monthly","Quarterly"],"tax_compounding_dom":["Compounded (eg. Quebec PST)"],"taxation_scheme_dom":["Taxable","Non-Taxable","Apply Tax List"],"discount_type_dom":["Price Percentage","Fixed Amount"],"discount_applies_dom":["Any Product","Selected Products Only"],"assembly_discount_type_dom":["Standard Discount","Price Percentage","Fixed Amount"],"quote_group_type_dom":["Products","Support","Services","Expenses"],"quote_pricing_method_dom":["Catalog Prices","Profit Margin","Markup Over Cost","Discount From List","Standard Discount","Same As List","Custom Prices"],"quote_pricing_method_short_dom":["Catalog","Custom","Margin","Markup","Discount","Premium","List"],"price_adjustment_type_dom":["Standard Tax","Compounded Tax","Taxed Shipping","Untaxed Shipping","Standard Discount"],"quotation_modes":["No Limitations","Limit user to quoting only products from the catalog","Limit user to quoting only products from the catalog, and only at standard pricing"],"project_modes":["No Limitations"],"email_reminder_time_options":["15 minutes prior","30 minutes prior","1 hour prior","2 hours prior","3 hours prior","6 hours prior","1 day prior"],"booked_hours_status_dom":["Tentative","Pending","Submitted","Approved","Rejected"],"booked_hours_related_dom":["Case","Project Task"],"booked_hours_billing_status_dom":["Billed","Not Billed"],"booking_classes_dom":["Billable Work","Non-Billable Work","Expenses","Recurring Services"],"expense_units_short_dom":["days","months","years","km","mi","L","gal","units"],"expense_units_dom":["Days","Months","Years","Kilometres","Miles","Litres","Gallons","Units"],"address_format_names_dom":["Britain\/US\/Canada","Europe 1 (Contact first)","Europe 2 (Account first)","Japan","Switzerland"],"business_model_dom":["Business to Business","Business to Consumer"],"event_format_dom":["Teleseminar","Seminar","Program","Live Event","Material"],"event_color_dom":["Red","Green","Blue","Magenta","Cyan","Brown","Violet","Chocolate","Crimson","FireBrick","Fuchsia","Indigo","OrangeRed","YellowGreen"],"placement_dom":["Tab Menu and Shortcut Menu","Tab Menu","Shortcut Menu"],"iframe_type_dom":["Personal","Global"],"temperature_dom":["Smoking","Hot","Warm","Cold"],"quote_add_comment_options":["Do not add part descriptions","Only add product descriptions","Only add assembly descriptions","Add all part descriptions"],"track_inventory_dom":["Not Tracked \/ Intangible","Manually Updated","Automatically Adjusted"],"booking_location_dom":["Onsite","Offsite"],"booking_seniority_dom":["Junior","Intermediate","Senior"],"booking_duration_dom":["Hours","Days"],"leave_status_dom":["Planned","Approved","Not Approved","Cancelled","Days Taken"],"leave_type_dom":["Vacation","Sick Days"],"country_codes":["Afghanistan","\u00c5land Islands","Albania","Algeria","American Samoa","Andorra","Angola","Anguilla","Antarctica","Antigua and Barbuda","Argentina","Armenia","Aruba","Australia","Austria","Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bermuda","Bhutan","Bolivia","Bonaire, Sint Eustatius and Saba","Bosnia and Herzegovina","Botswana","Bouvet Island","Brazil","British Indian Ocean Territory","Brunei Darussalam","Bulgaria","Burkina Faso","Burundi","Cambodia","Cameroon","Canada","Cape Verde","Cayman Islands","Central African Republic","Chad","Chile","China","Christmas Island","Cocos (Keeling) Islands","Colombia","Comoros","Congo","Congo, the Democratic Republic of the","Cook Islands","Costa Rica","Croatia","Cuba","Cura\u00e7ao","Cyprus","Czech Republic","C\u00f4te d'Ivoire","Denmark","Djibouti","Dominica","Dominican Republic","Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Ethiopia","Falkland Islands","Faroe Islands","Fiji","Finland","France","French Guiana","French Polynesia","French Southern Territories","Gabon","Gambia","Georgia","Germany","Ghana","Gibraltar","Greece","Greenland","Grenada","Guadeloupe","Guam","Guatemala","Guernsey","Guinea","Guinea-Bissau","Guyana","Haiti","Heard Island and McDonald Islands","Honduras","Hong Kong","Hungary","Iceland","India","Indonesia","Iran","Iraq","Ireland","Isle of Man","Israel","Italy","Jamaica","Japan","Jersey","Jordan","Kazakhstan","Kenya","Kiribati","Kuwait","Kyrgyzstan","Laos","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg","Macao","Macedonia","Madagascar","Malawi","Malaysia","Maldives","Mali","Malta","Marshall Islands","Martinique","Mauritania","Mauritius","Mayotte","Mexico","Micronesia","Moldova","Monaco","Mongolia","Montenegro","Montserrat","Morocco","Mozambique","Myanmar","Namibia","Nauru","Nepal","Netherlands","New Caledonia","New Zealand","Nicaragua","Niger","Nigeria","Niue","Norfolk Island","North Korea","Northern Mariana Islands","Norway","Oman","Pakistan","Palau","Palestine","Panama","Papua New Guinea","Paraguay","Peru","Philippines","Pitcairn","Poland","Portugal","Puerto Rico","Qatar","Romania","Russia","Rwanda","R\u00e9union","Saint Barth\u00e9lemy","Saint Helena, Ascension and Tristan da Cunha","Saint Kitts and Nevis","Saint Lucia","Saint Martin","Saint Pierre and Miquelon","Saint Vincent and the Grenadines","Samoa","San Marino","Sao Tome and Principe","Saudi Arabia","Senegal","Serbia","Seychelles","Sierra Leone","Singapore","Sint Maarten","Slovakia","Slovenia","Solomon Islands","Somalia","South Africa","South Georgia and the South Sandwich Islands","South Korea","South Sudan","Spain","Sri Lanka","Sudan","Suriname","Svalbard and Jan Mayen","Swaziland","Sweden","Switzerland","Syria","Taiwan","Tajikistan","Tanzania","Thailand","Timor-Leste","Togo","Tokelau","Tonga","Trinidad and Tobago","Tunisia","Turkey","Turkmenistan","Turks and Caicos Islands","Tuvalu","Uganda","Ukraine","United Arab Emirates","United Kingdom","United States","United States Minor Outlying Islands","Uruguay","Uzbekistan","Vanuatu","Vatican City State","Venezuela","Vietnam","Virgin Islands, British","Virgin Islands, U.S.","Wallis and Futuna","Western Sahara","Yemen","Zambia","Zimbabwe"],"debit_credit_dom":["Debit","Credit"],"envelope_window_position_dom":["Left","Right"],"relative_time_dom":["Yesterday","Yesterday, {TIME}","Today","Today, {TIME}","Tomorrow","Tomorrow, {TIME}","{WDAY}","{WDAY}, {TIME}","Moments ago","One second ago","{N} seconds ago","One minute ago","{N} minutes ago","An hour ago","{N} hours ago","{N} days ago","{N} days ago, {TIME}","{DATE}, {TIME}","Now"],"google_contacts_sync_dom":["- Sync Disabled -","(One-Way) Bring Contacts In To 1CRM","(One-Way) Send Contacts Out To Google","Two-Way Sync"],"google_calendar_sync_dom":["- Sync Disabled -","(One-Way) Bring Events In To 1CRM","(One-Way) Send Events Out To Google","Two-Way Sync"],"google_docs_sync_dom":["- Sync Disabled -","(One-Way) Bring Documents In To 1CRM","(One-Way) Send Documents Out To Google","Two-Way Sync"],"email_import_since_dom":["Previous {N} days","Previous {N} months","Previous {N} years","All messages"],"module_types_dom":["Theme","Language","Module","Patch","Holidays Pack","Personality Pack"],"user_activity_tracker_dom":["Off","Login Duration","Modules Used","Records Used"],"log_level_dom":["Debug level (verbose)","Informational","Warnings and errors","All errors","Only fatal errors","Off (logging disabled)"],"log_clear_activities_interval_dom":["30 days","60 days","90 days","120 days"],"dashboard_position_dom":["Start","End"],"expense_report_type_dom":["Customer","Marketing","Sales","Support","Executive"],"date_filter_operators_dom":["Any date","Before:","After:","On date:","Not on date:","Between:","Empty","Not empty","Yesterday","Today","Tomorrow","Previous:","Current:","Next:","Select Month:","Select Year:","Select Fiscal Year:"],"date_filter_period_dom":["Week","Month","Quarter","Year","Fiscal Quarter","Fiscal Year","7 Days","14 Days","30 Days","60 Days","90 Days","180 Days"],"date_range_operators_dom":["Any date","On date","Not on date","Between","Select date","Select date field","Before date","After date","Before","After","Empty","Not empty","Select month","Select year","Select fiscal year","To date","To date field","To offset date","To start of","To end of","Offset date","Within range","Start of","End of","Previous","Next","Current","This","Custom offset","To custom offset","Range","Plus","Minus","Not","Start of the","End of the","Within","From"],"date_range_embed_dom":["start of","end of","previous","next","current","this","plus","minus","before","after","not","within","from","to","of"],"number_filter_operators_dom":["Any value","Equal to","Less than","Greater than","Not equal to","Not less than","Not greater than","Between","Empty","Not empty"],"text_filter_operators_dom":["Any value","Equal to","Contains","Starts with","Ends with","Doesn't contain","Not equal to","Empty","Not empty"],"select_filter_operators_dom":["Any value","Equal to","Any of","Not equal to","None of","Empty","Not empty"],"field_type_dom":["ID","Name","Person Name","User Display Name","Drop-down Selection","Date","Date & Time","Time","Duration","Multi-Select Drop-down","Related Value","Text","Text","Multi-line Text","True or False","Integer","Number","Real Number","Real Number","Currency Value","Base Currency Value","Raw Currency Value","Percent Value","Rate Percentage","Email Address","Phone Number","Extension Number","Fax Number","Skype ID","URL","Module Name","Postal Address","City & State","HTML","Widget","Calculated","Reminder Time","Item Number","Sequence Number","Sequence Prefix","Color","Image","File Size","File Name","Star Rating","Progress Meter","Status Indicator","True or False","Email Recipients","Color","Blob"],"field_format_dom":["Standard","Date Only","Time Only","Month","Quarter","Year","Year & Month","Fiscal Quarter","Fiscal Year","Full Name","Rounded","In Thousands","In Millions","Days in Past","Days in Future","Hours","Minutes"],"multi_update_mode_dom":["No change","Add","Remove","Replace"],"total_type_dom":["Count","Sum","Minimum","Maximum","Average","Standard Deviation"],"total_type_short_dom":["Count","Sum","Min","Max","Avg","StdDev"],"chart_type_dom":["(No chart)","Horizontal Bar Chart","Vertical Bar Chart","Pie Chart","Line Graph","Area Chart"],"weekdays_dom":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"weekdays_long_dom":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"months_dom":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"months_long_dom":["","January","February","March","April","May","June","July","August","September","October","November","December"],"source_display_dom":["Primary","Joined rows","Nested rows"],"workflow_execute_mode_dom":["New Record Only","Existing Records Only","New Record and Existing Records"],"workflow_occurs_dom":["Record is Saved","Time Elapses"],"workflow_trigger_dom":["Saved","Deleted"],"workflow_execute_dom":["User who triggers workflow","Administrator","Record owner"],"workflow_status_dom":["Inactive","Active"],"reassign_accounts_dom":["Contacts","Activities","History","Quotes","Invoices","Opportunities","Cases"],"reassign_leads_dom":["Activities","History"],"telephony_integration_dom":["Disabled","SkypeOut","RingCentral","Generic Telephony"],"chat_integration_dom":["LiveChat Inc."],"backup_filter_options_dom":["No application files","Application config, custom\/ and modules\/","All but cache and file attachments","Entire application directory"],"activity_log_status_dom":["Assigned","Invited","Reminder","Created","Rescheduled","Closed","Reopened","Cancelled","Won","Lost","Converted","Expired","Expiring Soon","Overdue","Scheduled Report","Submitted","Approved","Rejected","Thread Reply"],"dashlet_auto_refresh_dom":["never","5 mins","10 mins","15 mins","20 mins","30 mins"],"shared_with_dom":["None","All Users","Selected Teams"],"smtp_security_dom":["None","SSL","TLS"],"download_status_dom":["Initiating","Receiving headers","Connected","In progress","Complete","Failed","Timed out"],"remote_backup_type_dom":["Disabled","FTP","SSH","Dropbox"],"page_orientation_dom":["Portrait","Landscape"],"partner_type_dom":["Referral","Sales Only","Full Service","Multi-Level"],"email_folder_types":["Inbox","Sent","Drafts","Trash","Campaigns","Support"],"custom_checkbox_dependent":["Always","When Checked","When Unchecked"],"paid_status_dom":["Due","Overdue","Paid","Cancelled"],"opp_active_dom":["","Active","In Progress","Closed Won","Closed Lost"],"request_method_dom":["GET","POST","POST with JSON body"],"record_action_status_dom":["Scheduled","Pending","In Progress","Complete","Canceled","Failed"],"record_action_source_dom":["Manual","Workflow"],"apns_notification_mode_dom":["Immediate","Scheduled"],"dropzone_messages":["Drop attachments here, or click to select file(s)","Your browser does not support drag'n'drop file uploads.","Please use the fallback form below to upload your files like in the olden days.","File is too big ({{filesize}}MiB). Max filesize: {{maxFilesize}}MiB.","You can't upload files of this type.","Server responded with {{statusCode}} code.","Cancel upload","Are you sure you want to cancel this upload?","Remove file","You can not upload any more files."],"filter_properties_dom":["min","max","value","prefix","suffix"],"data_privacy_type_dom":["Right to Erase Information","Consent to Process","Withdraw Consent","Request to View"],"data_privacy_status_dom":["Open","In Progress","Closed"],"storageutil_notifytype_dom":["GB Free","Percentage Used"],"storageutil_autoreport_dom":["Daily","Weekly","Monthly"],"option_type_dom":["String","Select One","Select Many","File Upload","Boolean","Number","Integer","Phone No.","Email","Web Address","Currency","Date","Date and Time","HTML"],"livechatinc_operator_status_dom":["Offline","Accepting Chats","Not Accepting Chats"],"livechat_match_mode_dom":["Contacts, then Leads","Leads Only","Contacts Only"],"livechat_create_mode_dom":["Create Leads","Create Contacts"],"subscription_cycle_dom":["Single","Weekly","Monthly","Yearly"],"subscription_status_dom":["Draft","Active","In Trial","Non-Renewing","Paused","Cancelled"],"oauth_scopes_dom":["read","write","profile"],"oauth_scopes_desc_dom":["Read information from 1CRM","Write information to 1CRM","Read user account information"],"oauth_grant_type_dom":["Client Credentials","Password","Implicit","Authorization Code"],"moduleList":["Notes","History","Contacts","Audit","Dashboards","Layout Test","Tax Codes","Serial Numbers","Charts","Supported Products","Event Reminders","Customer Levels","Recurrence","WooCommerce","OptimisticLock","News Feeds","Partners","Forums","Payments","Favorites","Forum Categories","PDF Form Designer","Live Chat Inc.","Human Resources","Product Attributes","Price Books","Supported Assemblies","Marketing Events","Booking Categories","Campaign Log","Knowledge Base","Campaign Trackers","Calls","Configurator","Users","Email Templates","Vacations & Sick days","Activity Log","Reports","Project Tasks","Workflow","Commissions","Product Categories","Event Types","Subscriptions","Invoices","Software Bugs","Record Actions","Topics","Cases","Models","Shipping","Outbound Email Queue","Booked Hours","Product Catalog","Prepaid Amounts","vCals","System Bulletins","PDFPrint","Lead Guerrilla","Purchase Orders","Options","Roles","Target Lists","Documents","Targets","Upgrades & Customization","Calendar","Service Subcontracts","DynFields","Teams","Assemblies","Outgoing Payments","Addons","Accounts","Leads","ImportDB","ACL","Data Privacy","Bookable Objects","Module Designer","Email","Timesheets","Social Accounts","Email Marketing","Sales Orders","Studio","Document Revisions","Software Products","Receiving","Forecasts","Administration","Product Types","Email Tracking","Company Directory","Credit Notes","API Clients","Monitored Email Accounts","Projects","Service Contract Types","Reports","Plans","Discounts","Event Attendance","User Preferences","Company Addresses","Campaigns","Home","Email Folders","Quotes","Forum Threads","Coupons","Bills","Processors","Versions","Shipping Providers","Tax Rates","Meetings","Tasks","Marketing Events","License and Support Information","Relationships","Chats","MailMerge","Notifications","Forum Posts","Webhooks","Invitees","Recurring Services","Merge Records","Releases","Skills","Expense Reports","Smart List Tabs","Opportunities","Scheduler","Activities","Email Recipients","Currencies","Resources","ACLActions"],"report_run_interval_unit_dom":["hours","days","weeks","months","quarters","years"],"schedule_run_interval_unit_dom":["minutes","hours","days","weeks","months","quarters","years"],"document_filetype_dom":["Acrobat PDF","Audio","Compressed","HTML","Image","MS Excel","MS PowerPoint","MS Project","MS Visio","MS Word","Text","Video"],"activity_status_dom":["Not Started","In Progress","Completed","Pending Input","Deferred","Planned","Held","Not Held","Archived","Closed","Draft","Read","Replied","Sent","Send Error","Unread","Received","Note"],"pdf_font_names_dom":["FreeSans (General, Embedded)","FreeSerif (General, Embedded)","FreeMono (Latin only, Embedded)","Vera Sans (Latin only, Embedded)","Vera Serif (Latin only, Embedded)","Vera Mono (Latin only, Embedded)","Courier (Latin only, Standard)","Helvetica (Latin only, Standard)","Times (Latin only, Standard)","MSung Light (Trad. Chinese)","STSong Light (Simp. Chinese)","MyungJo Medium (Korean)","Kozuka Mincho Pro (Japanese, Serif)","Kozuka Gothic Pro (Japanese, Sans)","AlMohanad (Arabic)"]}}});(function(g,h){function G(F,G){function W(b){return c.preferFlash&&v&&!c.ignoreFlash&&c.flash[b]!==h&&c.flash[b]}function r(b){return function(c){var d=this._s;return!d||!d._a?null:b.call(this,c)}}this.setupOptions={url:F||null,flashVersion:8,debugMode:!0,debugFlash:!1,useConsole:!0,consoleOnly:!0,waitForWindowLoad:!1,bgColor:"#ffffff",useHighPerformance:!1,flashPollingInterval:null,html5PollingInterval:null,flashLoadTimeout:1E3,wmode:null,allowScriptAccess:"always",useFlashBlock:!1,useHTML5Audio:!0,html5Test:/^(probably|maybe)$/i,preferFlash:!1,noSWFCache:!1,idPrefix:"sound"};this.defaultOptions={autoLoad:!1,autoPlay:!1,from:null,loops:1,onid3:null,onload:null,whileloading:null,onplay:null,onpause:null,onresume:null,whileplaying:null,onposition:null,onstop:null,onfailure:null,onfinish:null,multiShot:!0,multiShotEvents:!1,position:null,pan:0,stream:!0,to:null,type:null,usePolicyFile:!1,volume:100};this.flash9Options={isMovieStar:null,usePeakData:!1,useWaveformData:!1,useEQData:!1,onbufferchange:null,ondataerror:null};this.movieStarOptions={bufferTime:3,serverURL:null,onconnect:null,duration:null};this.audioFormats={mp3:{type:['audio/mpeg; codecs\x3d"mp3"',"audio/mpeg","audio/mp3","audio/MPA","audio/mpa-robust"],required:!0},mp4:{related:["aac","m4a","m4b"],type:['audio/mp4; codecs\x3d"mp4a.40.2"',"audio/aac","audio/x-m4a","audio/MP4A-LATM","audio/mpeg4-generic"],required:!1},ogg:{type:["audio/ogg; codecs\x3dvorbis"],required:!1},opus:{type:["audio/ogg; codecs\x3dopus","audio/opus"],required:!1},wav:{type:['audio/wav; codecs\x3d"1"',"audio/wav","audio/wave","audio/x-wav"],required:!1}};this.movieID="sm2-container";this.id=G||"sm2movie";this.debugID="soundmanager-debug";this.debugURLParam=/([#?&])debug=1/i;this.versionNumber="V2.97a.20140901";this.altURL=this.movieURL=this.version=null;this.enabled=this.swfLoaded=!1;this.oMC=null;this.sounds={};this.soundIDs=[];this.didFlashBlock=this.muted=!1;this.filePattern=null;this.filePatterns={flash8:/\.mp3(\?.*)?$/i,flash9:/\.mp3(\?.*)?$/i};this.features=
{buffering:!1,peakData:!1,waveformData:!1,eqData:!1,movieStar:!1};this.sandbox={};this.html5={usingFlash:null};this.flash={};this.ignoreFlash=this.html5Only=!1;var Ja,c=this,Ka=null,k=null,X,t=navigator.userAgent,La=g.location.href.toString(),p=document,la,Ma,ma,n,x=[],M=!1,N=!1,m=!1,y=!1,na=!1,O,w,oa,Y,pa,D,H,I,Na,qa,ra,Z,sa,$,ta,E,ua,P,va,aa,J,Oa,wa,Pa,xa,Qa,Q=null,ya=null,R,za,K,ba,ca,q,S=!1,Aa=!1,Ra,Sa,Ta,da=0,T=null,ea,Ua=[],U,u=null,Va,fa,V,z,ga,Ba,Wa,s,fb=Array.prototype.slice,A=!1,Ca,v,Da,Xa,B,ha,Ya=0,ia=t.match(/(ipad|iphone|ipod)/i),Za=t.match(/android/i),C=t.match(/msie/i),gb=t.match(/webkit/i),ja=t.match(/safari/i)&&!t.match(/chrome/i),Ea=t.match(/opera/i),Fa=t.match(/(mobile|pre\/|xoom)/i)||ia||Za,$a=!La.match(/usehtml5audio/i)&&!La.match(/sm2\-ignorebadua/i)&&ja&&!t.match(/silk/i)&&t.match(/OS X 10_6_([3-7])/i),Ga=p.hasFocus!==h?p.hasFocus():null,ka=ja&&(p.hasFocus===h||!p.hasFocus()),ab=!ka,bb=/(mp3|mp4|mpa|m4a|m4b)/i,Ha=p.location?p.location.protocol.match(/http/i):null,cb=
!Ha?"http://":"",db=/^\s*audio\/(?:x-)?(?:mpeg4|aac|flv|mov|mp4||m4v|m4a|m4b|mp4v|3gp|3g2)\s*(?:$|;)/i,eb="mpeg4 aac flv mov mp4 m4v f4v m4a m4b mp4v 3gp 3g2".split(" "),hb=RegExp("\\.("+eb.join("|")+")(\\?.*)?$","i");this.mimePattern=/^\s*audio\/(?:x-)?(?:mp(?:eg|3))\s*(?:$|;)/i;this.useAltURL=!Ha;var Ia;try{Ia=Audio!==h&&(Ea&&opera!==h&&10>opera.version()?new Audio(null):new Audio).canPlayType!==h}catch(ib){Ia=!1}this.hasHTML5=Ia;this.setup=function(b){var e=!c.url;b!==h&&m&&u&&c.ok();oa(b);b&&
(e&&(P&&b.url!==h)&&c.beginDelayedInit(),!P&&(b.url!==h&&"complete"===p.readyState)&&setTimeout(E,1));return c};this.supported=this.ok=function(){return u?m&&!y:c.useHTML5Audio&&c.hasHTML5};this.getMovie=function(b){return X(b)||p[b]||g[b]};this.createSound=function(b,e){function d(){a=ba(a);c.sounds[a.id]=new Ja(a);c.soundIDs.push(a.id);return c.sounds[a.id]}var a,f=null;if(!m||!c.ok())return!1;e!==h&&(b={id:b,url:e});a=w(b);a.url=ea(a.url);void 0===a.id&&(a.id=c.setupOptions.idPrefix+Ya++);if(q(a.id,!0))return c.sounds[a.id];if(fa(a))f=d(),f._setup_html5(a);else{if(c.html5Only||c.html5.usingFlash&&a.url&&a.url.match(/data\:/i))return d();8<n&&null===a.isMovieStar&&(a.isMovieStar=!(!a.serverURL&&!(a.type&&a.type.match(db)||a.url&&a.url.match(hb))));a=ca(a,void 0);f=d();8===n?k._createSound(a.id,a.loops||1,a.usePolicyFile):(k._createSound(a.id,a.url,a.usePeakData,a.useWaveformData,a.useEQData,a.isMovieStar,a.isMovieStar?a.bufferTime:!1,a.loops||1,a.serverURL,a.duration||null,a.autoPlay,!0,a.autoLoad,a.usePolicyFile),a.serverURL||(f.connected=!0,a.onconnect&&a.onconnect.apply(f)));!a.serverURL&&(a.autoLoad||a.autoPlay)&&f.load(a)}!a.serverURL&&a.autoPlay&&f.play();return f};this.destroySound=function(b,e){if(!q(b))return!1;var d=c.sounds[b],a;d._iO={};d.stop();d.unload();for(a=0;a<c.soundIDs.length;a++)if(c.soundIDs[a]===b){c.soundIDs.splice(a,1);break}e||d.destruct(!0);delete c.sounds[b];return!0};this.load=function(b,e){return!q(b)?!1:c.sounds[b].load(e)};this.unload=function(b){return!q(b)?
!1:c.sounds[b].unload()};this.onposition=this.onPosition=function(b,e,d,a){return!q(b)?!1:c.sounds[b].onposition(e,d,a)};this.clearOnPosition=function(b,e,d){return!q(b)?!1:c.sounds[b].clearOnPosition(e,d)};this.start=this.play=function(b,e){var d=null,a=e&&!(e instanceof Object);if(!m||!c.ok())return!1;if(q(b,a))a&&(e={url:e});else{if(!a)return!1;a&&(e={url:e});e&&e.url&&(e.id=b,d=c.createSound(e).play())}null===d&&(d=c.sounds[b].play(e));return d};this.setPosition=function(b,e){return!q(b)?!1:c.sounds[b].setPosition(e)};this.stop=function(b){return!q(b)?!1:c.sounds[b].stop()};this.stopAll=function(){for(var b in c.sounds)c.sounds.hasOwnProperty(b)&&c.sounds[b].stop()};this.pause=function(b){return!q(b)?!1:c.sounds[b].pause()};this.pauseAll=function(){var b;for(b=c.soundIDs.length-1;0<=b;b--)c.sounds[c.soundIDs[b]].pause()};this.resume=function(b){return!q(b)?!1:c.sounds[b].resume()};this.resumeAll=function(){var b;for(b=c.soundIDs.length-1;0<=b;b--)c.sounds[c.soundIDs[b]].resume()};this.togglePause=function(b){return!q(b)?
!1:c.sounds[b].togglePause()};this.setPan=function(b,e){return!q(b)?!1:c.sounds[b].setPan(e)};this.setVolume=function(b,e){return!q(b)?!1:c.sounds[b].setVolume(e)};this.mute=function(b){var e=0;b instanceof String&&(b=null);if(b)return!q(b)?!1:c.sounds[b].mute();for(e=c.soundIDs.length-1;0<=e;e--)c.sounds[c.soundIDs[e]].mute();return c.muted=!0};this.muteAll=function(){c.mute()};this.unmute=function(b){b instanceof String&&(b=null);if(b)return!q(b)?!1:c.sounds[b].unmute();for(b=c.soundIDs.length-
1;0<=b;b--)c.sounds[c.soundIDs[b]].unmute();c.muted=!1;return!0};this.unmuteAll=function(){c.unmute()};this.toggleMute=function(b){return!q(b)?!1:c.sounds[b].toggleMute()};this.getMemoryUse=function(){var b=0;k&&8!==n&&(b=parseInt(k._getMemoryUse(),10));return b};this.disable=function(b){var e;b===h&&(b=!1);if(y)return!1;y=!0;for(e=c.soundIDs.length-1;0<=e;e--)Pa(c.sounds[c.soundIDs[e]]);O(b);s.remove(g,"load",H);return!0};this.canPlayMIME=function(b){var e;c.hasHTML5&&(e=V({type:b}));!e&&u&&(e=b&&
c.ok()?!!(8<n&&b.match(db)||b.match(c.mimePattern)):null);return e};this.canPlayURL=function(b){var e;c.hasHTML5&&(e=V({url:b}));!e&&u&&(e=b&&c.ok()?!!b.match(c.filePattern):null);return e};this.canPlayLink=function(b){return b.type!==h&&b.type&&c.canPlayMIME(b.type)?!0:c.canPlayURL(b.href)};this.getSoundById=function(b,e){return!b?null:c.sounds[b]};this.onready=function(b,c){if("function"===typeof b)c||(c=g),pa("onready",b,c),D();else throw R("needFunction","onready");return!0};this.ontimeout=function(b,c){if("function"===typeof b)c||(c=g),pa("ontimeout",b,c),D({type:"ontimeout"});else throw R("needFunction","ontimeout");return!0};this._wD=this._writeDebug=function(b,c){return!0};this._debug=function(){};this.reboot=function(b,e){var d,a,f;for(d=c.soundIDs.length-1;0<=d;d--)c.sounds[c.soundIDs[d]].destruct();if(k)try{C&&(ya=k.innerHTML),Q=k.parentNode.removeChild(k)}catch(h){}ya=Q=u=k=null;c.enabled=P=m=S=Aa=M=N=y=A=c.swfLoaded=!1;c.soundIDs=[];c.sounds={};Ya=0;if(b)x=[];else for(d in x)if(x.hasOwnProperty(d)){a=
0;for(f=x[d].length;a<f;a++)x[d][a].fired=!1}c.html5={usingFlash:null};c.flash={};c.html5Only=!1;c.ignoreFlash=!1;g.setTimeout(function(){ta();e||c.beginDelayedInit()},20);return c};this.reset=function(){return c.reboot(!0,!0)};this.getMoviePercent=function(){return k&&"PercentLoaded"in k?k.PercentLoaded():null};this.beginDelayedInit=function(){na=!0;E();setTimeout(function(){if(Aa)return!1;aa();$();return Aa=!0},20);I()};this.destruct=function(){c.disable(!0)};Ja=function(b){var e,d,a=this,f,l,L,g,p,r,t=!1,m=[],u=0,x,y,v=null,z;d=e=null;this.sID=this.id=b.id;this.url=b.url;this._iO=this.instanceOptions=this.options=w(b);this.pan=this.options.pan;this.volume=this.options.volume;this.isHTML5=!1;this._a=null;z=this.url?!1:!0;this.id3={};this._debug=function(){};this.load=function(b){var e=null,d;b!==h?a._iO=w(b,a.options):(b=a.options,a._iO=b,v&&v!==a.url&&(a._iO.url=a.url,a.url=null));a._iO.url||(a._iO.url=a.url);a._iO.url=ea(a._iO.url);d=a.instanceOptions=a._iO;if(!d.url&&!a.url)return a;if(d.url===a.url&&0!==a.readyState&&2!==a.readyState)return 3===a.readyState&&d.onload&&ha(a,function(){d.onload.apply(a,[!!a.duration])}),a;a.loaded=!1;a.readyState=1;a.playState=0;a.id3={};if(fa(d))e=a._setup_html5(d),e._called_load||(a._html5_canplay=!1,a.url!==d.url&&(a._a.src=d.url,a.setPosition(0)),a._a.autobuffer="auto",a._a.preload="auto",a._a._called_load=!0);else{if(c.html5Only||a._iO.url&&a._iO.url.match(/data\:/i))return a;try{a.isHTML5=!1;a._iO=ca(ba(d));if(a._iO.autoPlay&&(a._iO.position||
a._iO.from))a._iO.autoPlay=!1;d=a._iO;8===n?k._load(a.id,d.url,d.stream,d.autoPlay,d.usePolicyFile):k._load(a.id,d.url,!!d.stream,!!d.autoPlay,d.loops||1,!!d.autoLoad,d.usePolicyFile)}catch(f){J({type:"SMSOUND_LOAD_JS_EXCEPTION",fatal:!0})}}a.url=d.url;return a};this.unload=function(){0!==a.readyState&&(a.isHTML5?(g(),a._a&&(a._a.pause(),v=ga(a._a))):8===n?k._unload(a.id,"about:blank"):k._unload(a.id),f());return a};this.destruct=function(b){a.isHTML5?(g(),a._a&&(a._a.pause(),ga(a._a),A||L(),a._a._s=
null,a._a=null)):(a._iO.onfailure=null,k._destroySound(a.id));b||c.destroySound(a.id,!0)};this.start=this.play=function(b,e){var d,f,l,g,L;f=!0;f=null;e=e===h?!0:e;b||(b={});a.url&&(a._iO.url=a.url);a._iO=w(a._iO,a.options);a._iO=w(b,a._iO);a._iO.url=ea(a._iO.url);a.instanceOptions=a._iO;if(!a.isHTML5&&a._iO.serverURL&&!a.connected)return a.getAutoPlay()||a.setAutoPlay(!0),a;fa(a._iO)&&(a._setup_html5(a._iO),p());1===a.playState&&!a.paused&&(d=a._iO.multiShot,d||(a.isHTML5&&a.setPosition(a._iO.position),f=a));if(null!==f)return f;b.url&&b.url!==a.url&&(!a.readyState&&!a.isHTML5&&8===n&&z?z=!1:a.load(a._iO));a.loaded||(0===a.readyState?(!a.isHTML5&&!c.html5Only?(a._iO.autoPlay=!0,a.load(a._iO)):a.isHTML5?a.load(a._iO):f=a,a.instanceOptions=a._iO):2===a.readyState&&(f=a));if(null!==f)return f;!a.isHTML5&&(9===n&&0<a.position&&a.position===a.duration)&&(b.position=0);if(a.paused&&0<=a.position&&(!a._iO.serverURL||0<a.position))a.resume();else{a._iO=w(b,a._iO);if((!a.isHTML5&&null!==a._iO.position&&
0<a._iO.position||null!==a._iO.from&&0<a._iO.from||null!==a._iO.to)&&0===a.instanceCount&&0===a.playState&&!a._iO.serverURL){d=function(){a._iO=w(b,a._iO);a.play(a._iO)};if(a.isHTML5&&!a._html5_canplay)a.load({_oncanplay:d}),f=!1;else if(!a.isHTML5&&!a.loaded&&(!a.readyState||2!==a.readyState))a.load({onload:d}),f=!1;if(null!==f)return f;a._iO=y()}(!a.instanceCount||a._iO.multiShotEvents||a.isHTML5&&a._iO.multiShot&&!A||!a.isHTML5&&8<n&&!a.getAutoPlay())&&a.instanceCount++;a._iO.onposition&&0===a.playState&&
r(a);a.playState=1;a.paused=!1;a.position=a._iO.position!==h&&!isNaN(a._iO.position)?a._iO.position:0;a.isHTML5||(a._iO=ca(ba(a._iO)));a._iO.onplay&&e&&(a._iO.onplay.apply(a),t=!0);a.setVolume(a._iO.volume,!0);a.setPan(a._iO.pan,!0);a.isHTML5?2>a.instanceCount?(p(),f=a._setup_html5(),a.setPosition(a._iO.position),f.play()):(l=new Audio(a._iO.url),g=function(){s.remove(l,"ended",g);a._onfinish(a);ga(l);l=null},L=function(){s.remove(l,"canplay",L);try{l.currentTime=a._iO.position/1E3}catch(b){}l.play()},s.add(l,"ended",g),void 0!==a._iO.volume&&(l.volume=Math.max(0,Math.min(1,a._iO.volume/100))),a.muted&&(l.muted=!0),a._iO.position?s.add(l,"canplay",L):l.play()):(f=k._start(a.id,a._iO.loops||1,9===n?a.position:a.position/1E3,a._iO.multiShot||!1),9===n&&!f&&a._iO.onplayerror&&a._iO.onplayerror.apply(a))}return a};this.stop=function(b){var c=a._iO;1===a.playState&&(a._onbufferchange(0),a._resetOnPosition(0),a.paused=!1,a.isHTML5||(a.playState=0),x(),c.to&&a.clearOnPosition(c.to),a.isHTML5?a._a&&(b=
a.position,a.setPosition(0),a.position=b,a._a.pause(),a.playState=0,a._onTimer(),g()):(k._stop(a.id,b),c.serverURL&&a.unload()),a.instanceCount=0,a._iO={},c.onstop&&c.onstop.apply(a));return a};this.setAutoPlay=function(b){a._iO.autoPlay=b;a.isHTML5||(k._setAutoPlay(a.id,b),b&&!a.instanceCount&&1===a.readyState&&a.instanceCount++)};this.getAutoPlay=function(){return a._iO.autoPlay};this.setPosition=function(b){b===h&&(b=0);var c=a.isHTML5?Math.max(b,0):Math.min(a.duration||a._iO.duration,Math.max(b,0));a.position=c;b=a.position/1E3;a._resetOnPosition(a.position);a._iO.position=c;if(a.isHTML5){if(a._a){if(a._html5_canplay){if(a._a.currentTime!==b)try{a._a.currentTime=b,(0===a.playState||a.paused)&&a._a.pause()}catch(e){}}else if(b)return a;a.paused&&a._onTimer(!0)}}else b=9===n?a.position:b,a.readyState&&2!==a.readyState&&k._setPosition(a.id,b,a.paused||!a.playState,a._iO.multiShot);return a};this.pause=function(b){if(a.paused||0===a.playState&&1!==a.readyState)return a;a.paused=!0;a.isHTML5?(a._setup_html5().pause(),g()):(b||b===h)&&k._pause(a.id,a._iO.multiShot);a._iO.onpause&&a._iO.onpause.apply(a);return a};this.resume=function(){var b=a._iO;if(!a.paused)return a;a.paused=!1;a.playState=1;a.isHTML5?(a._setup_html5().play(),p()):(b.isMovieStar&&!b.serverURL&&a.setPosition(a.position),k._pause(a.id,b.multiShot));!t&&b.onplay?(b.onplay.apply(a),t=!0):b.onresume&&b.onresume.apply(a);return a};this.togglePause=function(){if(0===a.playState)return a.play({position:9===n&&!a.isHTML5?a.position:
a.position/1E3}),a;a.paused?a.resume():a.pause();return a};this.setPan=function(b,c){b===h&&(b=0);c===h&&(c=!1);a.isHTML5||k._setPan(a.id,b);a._iO.pan=b;c||(a.pan=b,a.options.pan=b);return a};this.setVolume=function(b,e){b===h&&(b=100);e===h&&(e=!1);a.isHTML5?a._a&&(c.muted&&!a.muted&&(a.muted=!0,a._a.muted=!0),a._a.volume=Math.max(0,Math.min(1,b/100))):k._setVolume(a.id,c.muted&&!a.muted||a.muted?0:b);a._iO.volume=b;e||(a.volume=b,a.options.volume=b);return a};this.mute=function(){a.muted=!0;a.isHTML5?
a._a&&(a._a.muted=!0):k._setVolume(a.id,0);return a};this.unmute=function(){a.muted=!1;var b=a._iO.volume!==h;a.isHTML5?a._a&&(a._a.muted=!1):k._setVolume(a.id,b?a._iO.volume:a.options.volume);return a};this.toggleMute=function(){return a.muted?a.unmute():a.mute()};this.onposition=this.onPosition=function(b,c,e){m.push({position:parseInt(b,10),method:c,scope:e!==h?e:a,fired:!1});return a};this.clearOnPosition=function(a,b){var c;a=parseInt(a,10);if(isNaN(a))return!1;for(c=0;c<m.length;c++)if(a===
m[c].position&&(!b||b===m[c].method))m[c].fired&&u--,m.splice(c,1)};this._processOnPosition=function(){var b,c;b=m.length;if(!b||!a.playState||u>=b)return!1;for(b-=1;0<=b;b--)c=m[b],!c.fired&&a.position>=c.position&&(c.fired=!0,u++,c.method.apply(c.scope,[c.position]));return!0};this._resetOnPosition=function(a){var b,c;b=m.length;if(!b)return!1;for(b-=1;0<=b;b--)c=m[b],c.fired&&a<=c.position&&(c.fired=!1,u--);return!0};y=function(){var b=a._iO,c=b.from,e=b.to,d,f;f=function(){a.clearOnPosition(e,f);a.stop()};d=function(){if(null!==e&&!isNaN(e))a.onPosition(e,f)};null!==c&&!isNaN(c)&&(b.position=c,b.multiShot=!1,d());return b};r=function(){var b,c=a._iO.onposition;if(c)for(b in c)if(c.hasOwnProperty(b))a.onPosition(parseInt(b,10),c[b])};x=function(){var b,c=a._iO.onposition;if(c)for(b in c)c.hasOwnProperty(b)&&a.clearOnPosition(parseInt(b,10))};p=function(){a.isHTML5&&Ra(a)};g=function(){a.isHTML5&&Sa(a)};f=function(b){b||(m=[],u=0);t=!1;a._hasTimer=null;a._a=null;a._html5_canplay=!1;a.bytesLoaded=
null;a.bytesTotal=null;a.duration=a._iO&&a._iO.duration?a._iO.duration:null;a.durationEstimate=null;a.buffered=[];a.eqData=[];a.eqData.left=[];a.eqData.right=[];a.failures=0;a.isBuffering=!1;a.instanceOptions={};a.instanceCount=0;a.loaded=!1;a.metadata={};a.readyState=0;a.muted=!1;a.paused=!1;a.peakData={left:0,right:0};a.waveformData={left:[],right:[]};a.playState=0;a.position=null;a.id3={}};f();this._onTimer=function(b){var c,f=!1,l={};if(a._hasTimer||b){if(a._a&&(b||(0<a.playState||1===a.readyState)&&
!a.paused))c=a._get_html5_duration(),c!==e&&(e=c,a.duration=c,f=!0),a.durationEstimate=a.duration,c=1E3*a._a.currentTime||0,c!==d&&(d=c,f=!0),(f||b)&&a._whileplaying(c,l,l,l,l);return f}};this._get_html5_duration=function(){var b=a._iO;return(b=a._a&&a._a.duration?1E3*a._a.duration:b&&b.duration?b.duration:null)&&!isNaN(b)&&Infinity!==b?b:null};this._apply_loop=function(a,b){a.loop=1<b?"loop":""};this._setup_html5=function(b){b=w(a._iO,b);var c=A?Ka:a._a,e=decodeURI(b.url),d;A?e===decodeURI(Ca)&&
(d=!0):e===decodeURI(v)&&(d=!0);if(c){if(c._s)if(A)c._s&&(c._s.playState&&!d)&&c._s.stop();else if(!A&&e===decodeURI(v))return a._apply_loop(c,b.loops),c;d||(v&&f(!1),c.src=b.url,Ca=v=a.url=b.url,c._called_load=!1)}else b.autoLoad||b.autoPlay?(a._a=new Audio(b.url),a._a.load()):a._a=Ea&&10>opera.version()?new Audio(null):new Audio,c=a._a,c._called_load=!1,A&&(Ka=c);a.isHTML5=!0;a._a=c;c._s=a;l();a._apply_loop(c,b.loops);b.autoLoad||b.autoPlay?a.load():(c.autobuffer=!1,c.preload="auto");return c};l=function(){if(a._a._added_events)return!1;var b;a._a._added_events=!0;for(b in B)B.hasOwnProperty(b)&&a._a&&a._a.addEventListener(b,B[b],!1);return!0};L=function(){var b;a._a._added_events=!1;for(b in B)B.hasOwnProperty(b)&&a._a&&a._a.removeEventListener(b,B[b],!1)};this._onload=function(b){var c=!!b||!a.isHTML5&&8===n&&a.duration;a.loaded=c;a.readyState=c?3:2;a._onbufferchange(0);a._iO.onload&&ha(a,function(){a._iO.onload.apply(a,[c])});return!0};this._onbufferchange=function(b){if(0===a.playState||
b&&a.isBuffering||!b&&!a.isBuffering)return!1;a.isBuffering=1===b;a._iO.onbufferchange&&a._iO.onbufferchange.apply(a,[b]);return!0};this._onsuspend=function(){a._iO.onsuspend&&a._iO.onsuspend.apply(a);return!0};this._onfailure=function(b,c,e){a.failures++;if(a._iO.onfailure&&1===a.failures)a._iO.onfailure(b,c,e)};this._onwarning=function(b,c,e){if(a._iO.onwarning)a._iO.onwarning(b,c,e)};this._onfinish=function(){var b=a._iO.onfinish;a._onbufferchange(0);a._resetOnPosition(0);a.instanceCount&&(a.instanceCount--,a.instanceCount||(x(),a.playState=0,a.paused=!1,a.instanceCount=0,a.instanceOptions={},a._iO={},g(),a.isHTML5&&(a.position=0)),(!a.instanceCount||a._iO.multiShotEvents)&&b&&ha(a,function(){b.apply(a)}))};this._whileloading=function(b,c,e,d){var f=a._iO;a.bytesLoaded=b;a.bytesTotal=c;a.duration=Math.floor(e);a.bufferLength=d;a.durationEstimate=!a.isHTML5&&!f.isMovieStar?f.duration?a.duration>f.duration?a.duration:f.duration:parseInt(a.bytesTotal/a.bytesLoaded*a.duration,10):a.duration;a.isHTML5||(a.buffered=
[{start:0,end:a.duration}]);(3!==a.readyState||a.isHTML5)&&f.whileloading&&f.whileloading.apply(a)};this._whileplaying=function(b,c,e,d,f){var l=a._iO;if(isNaN(b)||null===b)return!1;a.position=Math.max(0,b);a._processOnPosition();!a.isHTML5&&8<n&&(l.usePeakData&&(c!==h&&c)&&(a.peakData={left:c.leftPeak,right:c.rightPeak}),l.useWaveformData&&(e!==h&&e)&&(a.waveformData={left:e.split(","),right:d.split(",")}),l.useEQData&&(f!==h&&f&&f.leftEQ)&&(b=f.leftEQ.split(","),a.eqData=b,a.eqData.left=b,f.rightEQ!==
h&&f.rightEQ&&(a.eqData.right=f.rightEQ.split(","))));1===a.playState&&(!a.isHTML5&&(8===n&&!a.position&&a.isBuffering)&&a._onbufferchange(0),l.whileplaying&&l.whileplaying.apply(a));return!0};this._oncaptiondata=function(b){a.captiondata=b;a._iO.oncaptiondata&&a._iO.oncaptiondata.apply(a,[b])};this._onmetadata=function(b,c){var e={},d,f;d=0;for(f=b.length;d<f;d++)e[b[d]]=c[d];a.metadata=e;console.log("updated metadata",a.metadata);a._iO.onmetadata&&a._iO.onmetadata.call(a,a.metadata)};this._onid3=
function(b,c){var e=[],d,f;d=0;for(f=b.length;d<f;d++)e[b[d]]=c[d];a.id3=w(a.id3,e);a._iO.onid3&&a._iO.onid3.apply(a)};this._onconnect=function(b){b=1===b;if(a.connected=b)a.failures=0,q(a.id)&&(a.getAutoPlay()?a.play(h,a.getAutoPlay()):a._iO.autoLoad&&a.load()),a._iO.onconnect&&a._iO.onconnect.apply(a,[b])};this._ondataerror=function(b){0<a.playState&&a._iO.ondataerror&&a._iO.ondataerror.apply(a)}};va=function(){return p.body||p.getElementsByTagName("div")[0]};X=function(b){return p.getElementById(b)};w=function(b,e){var d=b||{},a,f;a=e===h?c.defaultOptions:e;for(f in a)a.hasOwnProperty(f)&&d[f]===h&&(d[f]="object"!==typeof a[f]||null===a[f]?a[f]:w(d[f],a[f]));return d};ha=function(b,c){!b.isHTML5&&8===n?g.setTimeout(c,0):c()};Y={onready:1,ontimeout:1,defaultOptions:1,flash9Options:1,movieStarOptions:1};oa=function(b,e){var d,a=!0,f=e!==h,l=c.setupOptions;for(d in b)if(b.hasOwnProperty(d))if("object"!==typeof b[d]||null===b[d]||b[d]instanceof Array||b[d]instanceof RegExp)f&&Y[e]!==h?c[e][d]=b[d]:
l[d]!==h?(c.setupOptions[d]=b[d],c[d]=b[d]):Y[d]===h?a=!1:c[d]instanceof Function?c[d].apply(c,b[d]instanceof Array?b[d]:[b[d]]):c[d]=b[d];else if(Y[d]===h)a=!1;else return oa(b[d],d);return a};s=function(){function b(a){a=fb.call(a);var b=a.length;d?(a[1]="on"+a[1],3<b&&a.pop()):3===b&&a.push(!1);return a}function c(b,e){var h=b.shift(),g=[a[e]];if(d)h[g](b[0],b[1]);else h[g].apply(h,b)}var d=g.attachEvent,a={add:d?"attachEvent":"addEventListener",remove:d?"detachEvent":"removeEventListener"};return{add:function(){c(b(arguments),"add")},remove:function(){c(b(arguments),"remove")}}}();B={abort:r(function(){}),canplay:r(function(){var b=this._s,c;if(b._html5_canplay)return!0;b._html5_canplay=!0;b._onbufferchange(0);c=b._iO.position!==h&&!isNaN(b._iO.position)?b._iO.position/1E3:null;if(this.currentTime!==c)try{this.currentTime=c}catch(d){}b._iO._oncanplay&&b._iO._oncanplay()}),canplaythrough:r(function(){var b=this._s;b.loaded||(b._onbufferchange(0),b._whileloading(b.bytesLoaded,b.bytesTotal,b._get_html5_duration()),b._onload(!0))}),durationchange:r(function(){var b=this._s,c;c=b._get_html5_duration();!isNaN(c)&&c!==b.duration&&(b.durationEstimate=b.duration=c)}),ended:r(function(){this._s._onfinish()}),error:r(function(){this._s._onload(!1)}),loadeddata:r(function(){var b=this._s;!b._loaded&&!ja&&(b.duration=b._get_html5_duration())}),loadedmetadata:r(function(){}),loadstart:r(function(){this._s._onbufferchange(1)}),play:r(function(){this._s._onbufferchange(0)}),playing:r(function(){this._s._onbufferchange(0)}),progress:r(function(b){var c=
this._s,d,a,f=0,f=b.target.buffered;d=b.loaded||0;var l=b.total||1;c.buffered=[];if(f&&f.length){d=0;for(a=f.length;d<a;d++)c.buffered.push({start:1E3*f.start(d),end:1E3*f.end(d)});f=1E3*(f.end(0)-f.start(0));d=Math.min(1,f/(1E3*b.target.duration))}isNaN(d)||(c._whileloading(d,l,c._get_html5_duration()),d&&(l&&d===l)&&B.canplaythrough.call(this,b))}),ratechange:r(function(){}),suspend:r(function(b){var c=this._s;B.progress.call(this,b);c._onsuspend()}),stalled:r(function(){}),timeupdate:r(function(){this._s._onTimer()}),waiting:r(function(){this._s._onbufferchange(1)})};fa=function(b){return!b||!b.type&&!b.url&&!b.serverURL?!1:b.serverURL||b.type&&W(b.type)?!1:b.type?V({type:b.type}):V({url:b.url})||c.html5Only||b.url.match(/data\:/i)};ga=function(b){var e;b&&(e=ja?"about:blank":c.html5.canPlayType("audio/wav")?"data:audio/wave;base64,/UklGRiYAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQIAAAD//w\x3d\x3d":"about:blank",b.src=e,void 0!==b._called_unload&&(b._called_load=!1));A&&(Ca=null);return e};V=function(b){if(!c.useHTML5Audio||
!c.hasHTML5)return!1;var e=b.url||null;b=b.type||null;var d=c.audioFormats,a;if(b&&c.html5[b]!==h)return c.html5[b]&&!W(b);if(!z){z=[];for(a in d)d.hasOwnProperty(a)&&(z.push(a),d[a].related&&(z=z.concat(d[a].related)));z=RegExp("\\.("+z.join("|")+")(\\?.*)?$","i")}a=e?e.toLowerCase().match(z):null;!a||!a.length?b&&(e=b.indexOf(";"),a=(-1!==e?b.substr(0,e):b).substr(6)):a=a[1];a&&c.html5[a]!==h?e=c.html5[a]&&!W(a):(b="audio/"+a,e=c.html5.canPlayType({type:b}),e=(c.html5[a]=e)&&c.html5[b]&&!W(b));return e};Wa=function(){function b(a){var b,d=b=!1;if(!e||"function"!==typeof e.canPlayType)return b;if(a instanceof Array){g=0;for(b=a.length;g<b;g++)if(c.html5[a[g]]||e.canPlayType(a[g]).match(c.html5Test))d=!0,c.html5[a[g]]=!0,c.flash[a[g]]=!!a[g].match(bb);b=d}else a=e&&"function"===typeof e.canPlayType?e.canPlayType(a):!1,b=!(!a||!a.match(c.html5Test));return b}if(!c.useHTML5Audio||!c.hasHTML5)return u=c.html5.usingFlash=!0,!1;var e=Audio!==h?Ea&&10>opera.version()?new Audio(null):new Audio:
null,d,a,f={},l,g;l=c.audioFormats;for(d in l)if(l.hasOwnProperty(d)&&(a="audio/"+d,f[d]=b(l[d].type),f[a]=f[d],d.match(bb)?(c.flash[d]=!0,c.flash[a]=!0):(c.flash[d]=!1,c.flash[a]=!1),l[d]&&l[d].related))for(g=l[d].related.length-1;0<=g;g--)f["audio/"+l[d].related[g]]=f[d],c.html5[l[d].related[g]]=f[d],c.flash[l[d].related[g]]=f[d];f.canPlayType=e?b:null;c.html5=w(c.html5,f);c.html5.usingFlash=Va();u=c.html5.usingFlash;return!0};sa={};R=function(){};ba=function(b){8===n&&(1<b.loops&&b.stream)&&(b.stream=
!1);return b};ca=function(b,c){if(b&&!b.usePolicyFile&&(b.onid3||b.usePeakData||b.useWaveformData||b.useEQData))b.usePolicyFile=!0;return b};la=function(){return!1};Pa=function(b){for(var c in b)b.hasOwnProperty(c)&&"function"===typeof b[c]&&(b[c]=la)};xa=function(b){b===h&&(b=!1);(y||b)&&c.disable(b)};Qa=function(b){var e=null;if(b)if(b.match(/\.swf(\?.*)?$/i)){if(e=b.substr(b.toLowerCase().lastIndexOf(".swf?")+4))return b}else b.lastIndexOf("/")!==b.length-1&&(b+="/");b=(b&&-1!==b.lastIndexOf("/")?
b.substr(0,b.lastIndexOf("/")+1):"./")+c.movieURL;c.noSWFCache&&(b+="?ts\x3d"+(new Date).getTime());return b};ra=function(){n=parseInt(c.flashVersion,10);8!==n&&9!==n&&(c.flashVersion=n=8);var b=c.debugMode||c.debugFlash?"_debug.swf":".swf";c.useHTML5Audio&&(!c.html5Only&&c.audioFormats.mp4.required&&9>n)&&(c.flashVersion=n=9);c.version=c.versionNumber+(c.html5Only?" (HTML5-only mode)":9===n?" (AS3/Flash 9)":" (AS2/Flash 8)");8<n?(c.defaultOptions=w(c.defaultOptions,c.flash9Options),c.features.buffering=
!0,c.defaultOptions=w(c.defaultOptions,c.movieStarOptions),c.filePatterns.flash9=RegExp("\\.(mp3|"+eb.join("|")+")(\\?.*)?$","i"),c.features.movieStar=!0):c.features.movieStar=!1;c.filePattern=c.filePatterns[8!==n?"flash9":"flash8"];c.movieURL=(8===n?"soundmanager2.swf":"soundmanager2_flash9.swf").replace(".swf",b);c.features.peakData=c.features.waveformData=c.features.eqData=8<n};Oa=function(b,c){if(!k)return!1;k._setPolling(b,c)};wa=function(){};q=this.getSoundById;K=function(){var b=[];c.debugMode&&
b.push("sm2_debug");c.debugFlash&&b.push("flash_debug");c.useHighPerformance&&b.push("high_performance");return b.join(" ")};za=function(){R("fbHandler");var b=c.getMoviePercent(),e={type:"FLASHBLOCK"};if(c.html5Only)return!1;c.ok()?c.oMC&&(c.oMC.className=[K(),"movieContainer","swf_loaded"+(c.didFlashBlock?" swf_unblocked":"")].join(" ")):(u&&(c.oMC.className=K()+" movieContainer "+(null===b?"swf_timedout":"swf_error")),c.didFlashBlock=!0,D({type:"ontimeout",ignoreInit:!0,error:e}),J(e))};pa=function(b,c,d){x[b]===h&&(x[b]=[]);x[b].push({method:c,scope:d||null,fired:!1})};D=function(b){b||(b={type:c.ok()?"onready":"ontimeout"});if(!m&&b&&!b.ignoreInit||"ontimeout"===b.type&&(c.ok()||y&&!b.ignoreInit))return!1;var e={success:b&&b.ignoreInit?c.ok():!y},d=b&&b.type?x[b.type]||[]:[],a=[],f,e=[e],g=u&&!c.ok();b.error&&(e[0].error=b.error);b=0;for(f=d.length;b<f;b++)!0!==d[b].fired&&a.push(d[b]);if(a.length){b=0;for(f=a.length;b<f;b++)a[b].scope?a[b].method.apply(a[b].scope,e):a[b].method.apply(this,e),g||(a[b].fired=!0)}return!0};H=function(){g.setTimeout(function(){c.useFlashBlock&&za();D();"function"===typeof c.onload&&c.onload.apply(g);c.waitForWindowLoad&&s.add(g,"load",H)},1)};Da=function(){if(v!==h)return v;var b=!1,c=navigator,d=c.plugins,a,f=g.ActiveXObject;if(d&&d.length)(c=c.mimeTypes)&&(c["application/x-shockwave-flash"]&&c["application/x-shockwave-flash"].enabledPlugin&&c["application/x-shockwave-flash"].enabledPlugin.description)&&(b=!0);else if(f!==h&&!t.match(/MSAppHost/i)){try{a=
new f("ShockwaveFlash.ShockwaveFlash")}catch(l){a=null}b=!!a}return v=b};Va=function(){var b,e,d=c.audioFormats;if(ia&&t.match(/os (1|2|3_0|3_1)\s/i))c.hasHTML5=!1,c.html5Only=!0,c.oMC&&(c.oMC.style.display="none");else if(c.useHTML5Audio&&(!c.html5||!c.html5.canPlayType))c.hasHTML5=!1;if(c.useHTML5Audio&&c.hasHTML5)for(e in U=!0,d)if(d.hasOwnProperty(e)&&d[e].required)if(c.html5.canPlayType(d[e].type)){if(c.preferFlash&&(c.flash[e]||c.flash[d[e].type]))b=!0}else U=!1,b=!0;c.ignoreFlash&&(b=!1,U=
!0);c.html5Only=c.hasHTML5&&c.useHTML5Audio&&!b;return!c.html5Only};ea=function(b){var e,d,a=0;if(b instanceof Array){e=0;for(d=b.length;e<d;e++)if(b[e]instanceof Object){if(c.canPlayMIME(b[e].type)){a=e;break}}else if(c.canPlayURL(b[e])){a=e;break}b[a].url&&(b[a]=b[a].url);b=b[a]}return b};Ra=function(b){b._hasTimer||(b._hasTimer=!0,!Fa&&c.html5PollingInterval&&(null===T&&0===da&&(T=setInterval(Ta,c.html5PollingInterval)),da++))};Sa=function(b){b._hasTimer&&(b._hasTimer=!1,!Fa&&c.html5PollingInterval&&
da--)};Ta=function(){var b;if(null!==T&&!da)return clearInterval(T),T=null,!1;for(b=c.soundIDs.length-1;0<=b;b--)c.sounds[c.soundIDs[b]].isHTML5&&c.sounds[c.soundIDs[b]]._hasTimer&&c.sounds[c.soundIDs[b]]._onTimer()};J=function(b){b=b!==h?b:{};"function"===typeof c.onerror&&c.onerror.apply(g,[{type:b.type!==h?b.type:null}]);b.fatal!==h&&b.fatal&&c.disable()};Xa=function(){if(!$a||!Da())return!1;var b=c.audioFormats,e,d;for(d in b)if(b.hasOwnProperty(d)&&("mp3"===d||"mp4"===d))if(c.html5[d]=!1,b[d]&&
b[d].related)for(e=b[d].related.length-1;0<=e;e--)c.html5[b[d].related[e]]=!1};this._setSandboxType=function(b){};this._externalInterfaceOK=function(b){if(c.swfLoaded)return!1;c.swfLoaded=!0;ka=!1;$a&&Xa();setTimeout(ma,C?100:1)};aa=function(b,e){function d(a,b){return'\x3cparam name\x3d"'+a+'" value\x3d"'+b+'" /\x3e'}if(M&&N)return!1;if(c.html5Only)return ra(),c.oMC=X(c.movieID),ma(),N=M=!0,!1;var a=e||c.url,f=c.altURL||a,g=va(),k=K(),n=null,n=p.getElementsByTagName("html")[0],m,r,q,n=n&&n.dir&&
n.dir.match(/rtl/i);b=b===h?c.id:b;ra();c.url=Qa(Ha?a:f);e=c.url;c.wmode=!c.wmode&&c.useHighPerformance?"transparent":c.wmode;if(null!==c.wmode&&(t.match(/msie 8/i)||!C&&!c.useHighPerformance)&&navigator.platform.match(/win32|win64/i))Ua.push(sa.spcWmode),c.wmode=null;g={name:b,id:b,src:e,quality:"high",allowScriptAccess:c.allowScriptAccess,bgcolor:c.bgColor,pluginspage:cb+"www.macromedia.com/go/getflashplayer",title:"JS/Flash audio component (SoundManager 2)",type:"application/x-shockwave-flash",wmode:c.wmode,hasPriority:"true"};c.debugFlash&&(g.FlashVars="debug\x3d1");c.wmode||delete g.wmode;if(C)a=p.createElement("div"),r=['\x3cobject id\x3d"'+b+'" data\x3d"'+e+'" type\x3d"'+g.type+'" title\x3d"'+g.title+'" classid\x3d"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase\x3d"'+cb+'download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version\x3d6,0,40,0"\x3e',d("movie",e),d("AllowScriptAccess",c.allowScriptAccess),d("quality",g.quality),c.wmode?d("wmode",c.wmode):"",d("bgcolor",c.bgColor),d("hasPriority","true"),c.debugFlash?d("FlashVars",g.FlashVars):"","\x3c/object\x3e"].join("");else for(m in a=p.createElement("embed"),g)g.hasOwnProperty(m)&&a.setAttribute(m,g[m]);wa();k=K();if(g=va())if(c.oMC=X(c.movieID)||p.createElement("div"),c.oMC.id)q=c.oMC.className,c.oMC.className=(q?q+" ":"movieContainer")+(k?" "+k:""),c.oMC.appendChild(a),C&&(m=c.oMC.appendChild(p.createElement("div")),m.className="sm2-object-box",m.innerHTML=r),N=!0;else{c.oMC.id=c.movieID;c.oMC.className=
"movieContainer "+k;m=k=null;c.useFlashBlock||(c.useHighPerformance?k={position:"fixed",width:"8px",height:"8px",bottom:"0px",left:"0px",overflow:"hidden"}:(k={position:"absolute",width:"6px",height:"6px",top:"-9999px",left:"-9999px"},n&&(k.left=Math.abs(parseInt(k.left,10))+"px")));gb&&(c.oMC.style.zIndex=1E4);if(!c.debugFlash)for(q in k)k.hasOwnProperty(q)&&(c.oMC.style[q]=k[q]);try{C||c.oMC.appendChild(a),g.appendChild(c.oMC),C&&(m=c.oMC.appendChild(p.createElement("div")),m.className="sm2-object-box",m.innerHTML=r),N=!0}catch(s){throw Error(R("domError")+" \n"+s.toString());}}return M=!0};$=function(){if(c.html5Only)return aa(),!1;if(k||!c.url)return!1;k=c.getMovie(c.id);k||(Q?(C?c.oMC.innerHTML=ya:c.oMC.appendChild(Q),Q=null,M=!0):aa(c.id,c.url),k=c.getMovie(c.id));"function"===typeof c.oninitmovie&&setTimeout(c.oninitmovie,1);return!0};I=function(){setTimeout(Na,1E3)};qa=function(){g.setTimeout(function(){c.setup({preferFlash:!1}).reboot();c.didFlashBlock=!0;c.beginDelayedInit()},1)};Na=function(){var b,e=!1;if(!c.url||S)return!1;S=!0;s.remove(g,"load",I);if(v&&ka&&!Ga)return!1;m||(b=c.getMoviePercent(),0<b&&100>b&&(e=!0));setTimeout(function(){b=c.getMoviePercent();if(e)return S=!1,g.setTimeout(I,1),!1;!m&&ab&&(null===b?c.useFlashBlock||0===c.flashLoadTimeout?c.useFlashBlock&&za():!c.useFlashBlock&&U?qa():D({type:"ontimeout",ignoreInit:!0,error:{type:"INIT_FLASHBLOCK"}}):0!==c.flashLoadTimeout&&(!c.useFlashBlock&&U?qa():xa(!0)))},c.flashLoadTimeout)};Z=function(){if(Ga||!ka)return s.remove(g,"focus",Z),!0;Ga=ab=!0;S=!1;I();s.remove(g,"focus",Z);return!0};O=function(b){if(m)return!1;if(c.html5Only)return m=!0,H(),!0;var e=!0,d;if(!c.useFlashBlock||!c.flashLoadTimeout||c.getMoviePercent())m=!0;d={type:!v&&u?"NO_FLASH":"INIT_TIMEOUT"};if(y||b)c.useFlashBlock&&c.oMC&&(c.oMC.className=K()+" "+(null===c.getMoviePercent()?"swf_timedout":"swf_error")),D({type:"ontimeout",error:d,ignoreInit:!0}),J(d),e=!1;y||(c.waitForWindowLoad&&!na?s.add(g,"load",H):H());return e};Ma=function(){var b,e=c.setupOptions;for(b in e)e.hasOwnProperty(b)&&(c[b]===h?c[b]=e[b]:c[b]!==e[b]&&(c.setupOptions[b]=c[b]))};ma=function(){if(m)return!1;if(c.html5Only)return m||(s.remove(g,"load",c.beginDelayedInit),c.enabled=!0,O()),!0;$();try{k._externalInterfaceTest(!1),Oa(!0,c.flashPollingInterval||(c.useHighPerformance?10:50)),c.debugMode||k._disableDebug(),c.enabled=!0,c.html5Only||s.add(g,"unload",la)}catch(b){return J({type:"JS_TO_FLASH_EXCEPTION",fatal:!0}),xa(!0),O(),!1}O();s.remove(g,"load",c.beginDelayedInit);return!0};E=function(){if(P)return!1;P=!0;Ma();wa();!v&&c.hasHTML5&&c.setup({useHTML5Audio:!0,preferFlash:!1});Wa();!v&&u&&(Ua.push(sa.needFlash),c.setup({flashLoadTimeout:1}));p.removeEventListener&&p.removeEventListener("DOMContentLoaded",E,!1);$();return!0};Ba=function(){"complete"===p.readyState&&(E(),p.detachEvent("onreadystatechange",Ba));return!0};ua=function(){na=!0;E();s.remove(g,"load",ua)};ta=function(){if(Fa&&(c.setupOptions.useHTML5Audio=!0,c.setupOptions.preferFlash=!1,ia||Za&&!t.match(/android\s2\.3/i)))ia&&
(c.ignoreFlash=!0),A=!0};ta();Da();s.add(g,"focus",Z);s.add(g,"load",I);s.add(g,"load",ua);p.addEventListener?p.addEventListener("DOMContentLoaded",E,!1):p.attachEvent?p.attachEvent("onreadystatechange",Ba):J({type:"NO_DOM2_EVENTS",fatal:!0})}if(!g||!g.document)throw Error("SoundManager requires a browser with window and document objects.");var F=null;if(void 0===g.SM2_DEFER||!SM2_DEFER)F=new G;"object"===typeof module&&module&&"object"===typeof module.exports?(g.soundManager=F,module.exports.SoundManager=
G,module.exports.soundManager=F):"function"===typeof define&&define.amd?define("SoundManager",[],function(){return{SoundManager:G,soundManager:F}}):(g.SoundManager=G,g.soundManager=F)})(window);